<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="PFA" code="210">
  <LibDeclare>
    <Library name="PFA" value="dll/pfa.so"/>
  </LibDeclare>
  <ConfigDeclare>
    <Config name="BatFormat" value="etc/PFA_FMT.XML"/>
  </ConfigDeclare>
  <TableDeclare>
    <Table name="pfasubcfg" value="pfasubcfg"/>
    <Table name="pfaorgsts" value="pfaorgsts"/>
    <Table name="pfacusinf" value="pfacusinf"/>
    <Table name="pfacodinf" value="pfacodinf"/>
    <Table name="pfaquobal" value="pfaquobal"/>
    <Table name="pfavchbok" value="pfavchbok"/>
    <Table name="pfatxnjnl" value="pfatxnjnl"/>
    <Table name="pfaclrrec" value="pfaclrrec"/>
    <Table name="pfaclrjnl" value="pfaclrjnl"/>
    <Table name="pfacusagr" value="pfacusagr"/>
    <Table name="lbepcusagr" value="lbepcusagr"/>
    <Table name="pfacrdinf" value="pfacrdinf"/>
    <Table name="pfacrdtxn" value="pfacrdtxn"/>
    <Table name="pfacrddtl" value="pfacrddtl"/>
    <Table name="pfacrdjnl" value="pfacrdjnl"/>
    <Table name="pfaquobok001" value="pfaquobok001"/>
    <Table name="pfavchdtl001" value="pfavchdtl001"/>
    <Table name="pfacmdsum101" value="pfacmdsum101"/>
    <Table name="pfaquobok101" value="pfaquobok101"/>
    <Table name="pfavchdtl101" value="pfavchdtl101"/>
    <Table name="pfacmdsum102" value="pfacmdsum102"/>
    <Table name="pfaquobok102" value="pfaquobok102"/>
    <Table name="pfavchdtl102" value="pfavchdtl102"/>
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="RptDir"   value="dat/term/send/"/>
    <Busdef name="TRDir"   value="dat/term/recv/"/>
    <Busdef name="IcsDir"  value="dat/pfa/recv"/>
    <Busdef name="AdeFDir" value="/app/bde/adeexc/data/D"/>
    <Busdef name="AdeBDir" value="/BRD/"/>
    <Busdef name="SplFlg"  value=","/>
  </BusDefDeclare>
  <Define>
    <Include file="etc/PFA_ACC.XML"/>
  </Define>
<!--查询管理类交易-->
<!--查询管理类交易-->
<!--查询管理类交易-->
<!--查询管理类交易-->
<!--查询管理类交易-->
  <Transaction code="461001" desc="财政支付控制表维护">
    <DynSentence name="QrySubCfg"> <!-- 查询 -->
      <Sentence>
        select PfaNam OPfaNam,OpnSts OOpnSts,BokFlg OBokFlg,AgtNod OAgtNod,ClrNod OClrNod,PmsSeq OPmsSeq,BepSeq OBepSeq,
               ClrBTp OClrBTp,ClrMod OClrMod,PfaKnd OPfaKnd,RActSq ORActSq,ClrAct OClrAct,ClrNam OClrNam,RcvAct ORcvAct,
               RcvNam ORcvNam,RbkNo ORbkNo,RbkNm ORbkNm,
               case when FldNm1='PfaSub' then '0' when FldNm1='' then '1' end OFldNm1,
               case when FldNm2='Year'   then '0' when FldNm2='' then '1' end OFldNm2,
               case when FldNm3='BCusId' then '0' when FldNm3='' then '1' end OFldNm3,
               case when FldNm4='QuoId'  then '0' when FldNm4='' then '1' end OFldNm4,
               case when FldNm5='SubCod' then '0' when FldNm5='' then '1' end OFldNm5,
               case when FldNm6='PrjCod' then '0' when FldNm6='' then '1' end OFldNm6,
               case when FldNm7='EConTp' then '0' when FldNm7='' then '1' end OFldNm7,
               case when FldNm8='DptCod' then '0' when FldNm8='' then '1' end OFldNm8
          from pfasubcfg where PfaSub='%s' and BrNo='%s'
      </Sentence>
      <Fields>PfaSub|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="QryPmsBankNo"> <!--根据分行号获取支付行号 -->
      <Sentence>
        select SetBk SOpnBk, NodNam  SOpnNm from pubnodinf where NodNo='%s'
      </Sentence>
      <Fields>ClrNod|</Fields>
    </DynSentence>
    <DynSentence name="UpdSubCfg"> <!--修改-->
      <Sentence>
        PfaSub='%s' and BrNo='%s'
      </Sentence>
      <Fields>PfaSub|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="DelSubCfg"> <!--删除-->
      <Sentence>
        delete from pfasubcfg where PfaSub='%s' and BrNo='%s'
      </Sentence>
      <Fields>PfaSub|BrNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900),IS_NOEQUAL_STRING($FUNC,2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
<!--
      <If condition="IS_NOEQUAL_STRING($FUNC,2)">
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="70"/>
          <Arg name="AthMsg" value="PFA000"/>
        </Exec>
        <Exec func="PUB:CheckLocalAuth">
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="QrySubCfg"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Set>OprTm=GETDATETIME(YYYYMMDDHHMISS)</Set>   <!--操作时间-->
      <Switch expression="$FUNC">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
<!--根据清算网点号获取支付行号-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="QryPmsBankNo"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
<!--根据当前会计日期获取上一，下一工作日期-->
          <Set>CurDat=$ActDat</Set>
          <Exec func="PUB:GetPrevWorkDate">
            <Arg name="Date" value="$ActDat"/>
          </Exec>
          <Set>PreDat=$PrevDat</Set>
          <Exec func="PUB:GetNextWorkDate">
            <Arg name="Date" value="$ActDat"/>
          </Exec>
          <Set>NxtDat=$NextDat</Set>
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="pfasubcfg"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="pfasubcfg"/>
            <Arg name="CndSts" value="UpdSubCfg"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="DelSubCfg"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461002" desc="财政支付网点信息维护">
    <DynSentence name="QryOrgInf"> <!-- 获取网点号对应分行号 -->
      <Sentence>
        select BrNo BrCd from PubOrgInf where NodNo='%s'
      </Sentence>
      <Fields>OrgNod|</Fields>
    </DynSentence>
    <DynSentence name="QryOrgSts"> <!-- 查询 -->
      <Sentence>
        select OrgNam OOrgNam, SgnFlg OSgnFlg, BokFlg OBokFlg from pfaorgsts where BrNo='%s' and PfaSub='%s' and OrgNod='%s'
      </Sentence>
      <Fields>BrNo|PfaSub|OrgNod|</Fields>
    </DynSentence>
    <DynSentence name="UpdOrgSts"> <!-- 修改 -->
      <Sentence>
        BrNo='%s' and PfaSub='%s' and OrgNod='%s'
      </Sentence>
      <Fields>BrNo|PfaSub|OrgNod|</Fields>
    </DynSentence>
    <DynSentence name="DelOrgSts"> <!-- 删除 -->
      <Sentence>
        delete from pfaorgsts where BrNo='%s' and PfaSub='%s' and OrgNod='%s'
      </Sentence>
      <Fields>BrNo|PfaSub|OrgNod|</Fields>
    </DynSentence>
    <DynSentence name="MultiQuery">
      <Sentence>
        select PfaSub OPfaSub, OrgNod OOrgNod, OrgNam OOrgNam, SgnFlg OSgnFlg, BokFlg OBokFlg
          from pfaorgsts where PfaSub='%s' and ( OrgNod='%s' or '%s'='' )
      </Sentence>
      <Fields>PfaSub|OrgNod|OrgNod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900),IS_NOEQUAL_STRING($FUNC,2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="IS_EQUAL_STRING($FUNC,4)">
        <Exec func="PUB:MultiQuery"/>
        <Return/>
      </If>
<!--检查是否本分行网点-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="QryOrgInf"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($BrNo,$BrCd)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=非本分行网点</Set>
        <Return/>
      </If>
<!--
      <If condition="IS_NOEQUAL_STRING($FUNC,2)">
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="70"/>
          <Arg name="AthMsg" value="PFA000"/>
        </Exec>
        <Exec func="PUB:CheckLocalAuth">
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="QryOrgSts"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Switch expression="$FUNC">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
          <Set>NodNo=$OrgNod</Set>
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="pfaorgsts"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="pfaorgsts"/>
            <Arg name="CndSts" value="UpdOrgSts"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="DelOrgSts"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461003" desc="财政系统分行开(关)门">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="SumOrgSts"> <!--判断是否存在未签退网点-->
      <Sentence>
        select count(*) SgnNum from pfaorgsts where PfaSub='%s' and SgnFlg!='%s' and BrNo='%s'
      </Sentence>
      <Fields>PfaSub|Sts|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdSubCfg"> <!--修改系统状态-->
      <Sentence>
        update pfasubcfg set OpnSts='%s', BokFlg='%s', PreDat='%s', CurDat='%s', NxtDat='%s', RtnSeq='1', RtnFlg='%s'
         where PfaSub='%s' and BrNo='%s' 
      </Sentence>
      <Fields>Sts|Sts|PrevDat|ActDat|NextDat|RtnFlg|PfaSub|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="GetQuoBok">
      <Sentence>
        select TSeqNo, TxnFlg, QuoAmt, QuoId from %s
         where PfaSub='%s' and QuoSts in ('1','2') and Year=substr('%s',1,4) and Mon=substr('%s',5,2) and UpdFlg='0'
      order by TxnFlg
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|ActDat|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="UpdQuoBok">
      <Sentence>
        update %s set UpdFlg='1' where PfaSub='%s' and Year=substr('%s',1,4) and TSeqNo='%s' and QuoSts in ('1','2')
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|ActDat|TSeqNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_NOEQUAL_STRING($NodNo,$ClrNod)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
<!--获取前后工作日期-->
      <Exec func="PUB:GetPrevWorkDate">
        <Arg name="Date" value="$ActDat"/>
      </Exec>
      <Exec func="PUB:GetNextWorkDate">
        <Arg name="Date" value="$ActDat"/>
      </Exec>
      <Switch expression="$Sts">
        <Case value="0"> <!-- 签到 -->
          <If condition="IS_EQUAL_STRING($Sts,$OpnSts)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(财政系统【,$PfaSub,】分行已开门)</Set>
            <Return/>
          </If>
          <Exec func="PUB:IsWorkDate">
            <Arg name="Date" value="$ActDat"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,1)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=非工作日，不能签到</Set>
            <Return/>
          </If>
<!--月头额度变更-->
          <If condition="IS_NOEQUAL_STRING(SUBSTR($PrevDat,1,6),SUBSTR($ActDat,1,6))">
<!--为避免同一分行并发-->
            <Exec func="PUB:Lock">
              <Arg name="RecKey"   value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
<!--获取额度控制内容-->
            <Exec func="PUB:OpenCursor" error="IGNORE">
              <Arg name="sql" value="GetQuoBok"/>
            </Exec>
            <If condition="~RetCod!=0">
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=打开游标出错</Set>
              <Return/>
            </If>
            <While>
              <Exec func="PUB:FetchCursor" error="IGNORE"/>
              <If condition="~RetCod=100">
                 <Break/>
              </If>
<!--获取支付控制级别-->
              <Set>StsNam=BalSts</Set>
              <Set>StsVal=0</Set>
              <Quote name="GetSqlStr"/>
              <Exec func="PUB:ReadRecord" error="IGNORE">
                <Args>
                  <Arg name="SqlCmd" value="GetQuoBal"/>
                </Args>
              </Exec>
              <If condition="~RetCod=-1">
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Exec func="PUB:CloseCursor" error="IGNORE"/>
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=数据库查询失败</Set>
                <Return/>
              </If>
              <If condition="~RetCod=-2"> <!--找不到相同控制条件记录，登记初始记录-->
                <If condition="IS_EQUAL_STRING($TxnFlg,1)">  <!--调减-->
                  <Exec func="PUB:RollbackWork" error="IGNORE"/>
                  <Exec func="PUB:CloseCursor" error="IGNORE"/>
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PFA999</Set>
                  <Set>RspMsg=STRCAT(财政【,$PfaSub,】客户【,$BCusId,】额度不能为负)</Set>
                  <Return/>
                </If>
                <Set>BalSts=0</Set>
                <Set>QuoTot=0</Set>
                <Set>QuoBal=0</Set>
                <Set>FrzAmt=0</Set>
                <Exec func="PUB:InsertRecord" error="IGNORE">
                  <Arg name="TblNam" value="pfaquobal"/>
                </Exec>
                <If condition="~RetCod!=0">
                  <Exec func="PUB:RollbackWork" error="IGNORE"/>
                  <Exec func="PUB:CloseCursor" error="IGNORE"/>
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PFA999</Set>
                  <Set>RspMsg=初始化额度余额表错</Set>
                  <Return/>
                </If>
              </If>
              <If condition="IS_EQUAL_STRING($TxnFlg,0)">  <!--调增-->
                <Set>QuoTot=ADDCHAR(ADDAMT($QuoTot,$QuoAmt),15,0,1)</Set>
                <Set>QuoBal=ADDCHAR(ADDAMT($QuoBal,$QuoAmt),15,0,1)</Set>
              </If>
              <Else>
                <If condition="INTCMP($QuoBal,1,$QuoAmt)">
                  <Exec func="PUB:RollbackWork" error="IGNORE"/>
                  <Exec func="PUB:CloseCursor" error="IGNORE"/>
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PFA999</Set>
                  <Set>RspMsg=STRCAT(财政【,$PfaSub,】客户【,$BCusId,】额度不能为负)</Set>
                  <Return/>
                </If>
                <Set>QuoTot=ADDCHAR(SUBAMT($QuoTot,$QuoAmt),15,0,1)</Set>
                <Set>QuoBal=ADDCHAR(SUBAMT($QuoBal,$QuoAmt),15,0,1)</Set>
              </Else>
<!--修改余额表-->
              <Exec func="PUB:ExecSql" error="IGNORE">
                <Args>
                  <Arg name="SqlCmd" value="UpdQuoBal"/>
                </Args>
              </Exec>
              <If condition="~RetCod=-1">
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Exec func="PUB:CloseCursor" error="IGNORE"/>
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=数据库处理失败</Set>
                <Return/>
              </If>
<!--修改额度令表-->
              <Exec func="PUB:ExecSql" error="IGNORE">
                <Args>
                  <Arg name="SqlCmd" value="UpdQuoBok"/>
                </Args>
              </Exec>
              <If condition="~RetCod=-1">
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Exec func="PUB:CloseCursor" error="IGNORE"/>
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=数据库处理失败</Set>
                <Return/>
              </If>
              <Exec func="PUB:CommitWork"/>
            </While>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
          </If>
          <Set>RtnFlg=0</Set>
          <Break/>
        </Case>
        <Case value="1"> <!-- 签退 -->
          <If condition="INTCMP($RtnFlg,3,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=当日回应未完成</Set>
            <Return/>
          </If>
          <If condition="IS_EQUAL_STRING($Sts,$OpnSts)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(财政系统【,$PfaSub,】分行已关门)</Set>
            <Return/>
          </If>
          <Exec func="PUB:ReadRecord" error="IGNORE">   <!--判断是否已存在未签退网点-->
            <Args>
              <Arg name="SqlCmd" value="SumOrgSts"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
          <If condition="INTCMP($SgnNum,4,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=系统中存在未签退的网点</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=该功能尚未开通</Set>
          <Return/>
        </Default>
      </Switch>
      <Exec func="PUB:ExecSql">   <!--置全部签退标志-->
        <Args>
          <Arg name="SqlCmd" value="UpdSubCfg"/>
        </Args>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461004" desc="财政系统网点开(关)门">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="QryOrgSts">
      <Sentence>
        select SgnFlg from pfaorgsts where PfaSub='%s' and BrNo='%s' and OrgNod='%s'
      </Sentence>
      <Fields>PfaSub|BrNo|NodNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdOrgSts">
      <Sentence>
        update pfaorgsts set SgnFlg='%s', BokFlg='%s', ActDat='%s'
         where PfaSub='%s' and BrNo='%s' and OrgNod='%s' and SgnFlg='%s'
      </Sentence>
      <Fields>SgnFlg|SgnFlg|ActDat|PfaSub|BrNo|NodNo|Sts|</Fields>
    </DynSentence>
    <DynSentence name="ChkPfaVchBok1"> <!--支付令已复核未做会计确认,网点检查-->
      <Sentence>
        select 'Y' YN  from TABLE(VALUES(1)) AS anony
         where EXISTS ( select 'Y' from PfaVchBok
                          where PfaSub='%s' and BrNo='%s' and NodNo='%s' and ActDat='%s' and VchSts='1' and ChkFlg='1' )
        </Sentence>
      <Fields>PfaSub|BrNo|NodNo|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="ChkPfaVchBok2"> <!--支付令未做内部清算,清算网点检查-->
      <Sentence>
        select 'Y' YN  from TABLE(VALUES(1)) AS anony
         where EXISTS ( select 'Y' from PfaVchBok
                          where PfaSub='%s' and ActDat='%s' and VchSts='2' and ChkFlg='1' and ClrSts not in ('2','3','4') )
        </Sentence>
      <Fields>PfaSub|BrNo|NodNo|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="ChkPfaVchBok3"> <!--上一工作日支付令未做清算确认,清算网点检查-->
      <Sentence>
        select 'Y' YN  from TABLE(VALUES(1)) AS anony
         where EXISTS ( select 'Y' from PfaVchBok
                          where PfaSub='%s' and ActDat &lt; '%s' and VchSts='2' and ChkFlg='1' and ClrSts not in ('3','4') )
        </Sentence>
      <Fields>PfaSub|ActDat|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
<!--获取财政业务基础信息用于开门检查状态,关门判断业务逻辑-->
      <Quote name="ChkSubCfg"/>
      <Switch expression="$SgnFlg">
        <Case value="0"> <!-- 签到 -->
          <If condition="IS_NOEQUAL_STRING($OpnSts,$SgnFlg)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(该【,$PfaSub,】项财政业务，代理分行未开门)</Set>
            <Return/>
          </If>
          <Set>Sts=1</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdOrgSts"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(该网点不能做【,$PfaSub,】项财政业务或网点已签到)</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Case value="1"> <!-- 签退 -->
<!--业务逻辑检查-->
<!--检查支付令-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="ChkPfaVchBok1"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=检查财政支付令登记表失败!!!</Set>
            <Return/>
          </If>
          <If condition="~RetCod=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=存在尚未复核的支付令,请检查!!!</Set>
            <Return/>
          </If>
<!--中心业务逻辑检查-->
          <If condition="IS_EQUAL_STRING($NodNo,$ClrNod)">
<!--检查当日支付令内部清算-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="ChkPfaVchBok2"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=检查财政支付令登记表失败!!!</Set>
              <Return/>
            </If>
            <If condition="~RetCod=0">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=存在尚未完成内部清算的支付令,请检查!!!</Set>
              <Return/>
            </If>
<!--检查上一工作日支付令清算状态-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="ChkPfaVchBok3"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=检查财政支付令登记表失败!!!</Set>
              <Return/>
            </If>
            <If condition="~RetCod=0">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=存在尚未完成清算确认的支付令,请确认!!!</Set>
              <Return/>
            </If>
          </If>
          <Set>Sts=0</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdOrgSts"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(该网点不能做【,$PfaSub,】项财政业务或网点已签到)</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=该功能尚未开通</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461005" desc="预算单位账户信息维护">
    <DynSentence name="QryCusInf"> <!-- 查询 -->                  
      <Sentence>               
        select CusSts OCusSts,PfaSub OPfaSub,BCusId OBCusId,BCusNm OBCusNm,TCusId OTCusId,ProId OProId,ProNam OProNam,
               FCusId OFCusId,FCusNm OFCusNm,ActNo OActNo,ActNam OActNam,CusLvl OCusLvl,OpnNod OOpnNod, OpnBNm OOpnBNm,
               Addr OAddr,RegDat ORegDat,AmtTyp OAmtTyp,ActTyp OActTyp,TlrId OTlrId,Smr OSmr 
          from pfacusinf where PfaSub='%s' and BCusId='%s'
      </Sentence>              
      <Fields>PfaSub|BCusId|</Fields>
    </DynSentence>             
    <DynSentence name="UpdCusInf"> <!-- 修改 -->
      <Sentence>               
        PfaSub='%s' and BCusId='%s'
      </Sentence>              
      <Fields>PfaSub|BCusId|</Fields>
    </DynSentence>
    <DynSentence name="DelCusInf"> <!-- 删除 -->
      <Sentence>               
        delete from pfacusinf where PfaSub='%s' and BCusId='%s'
      </Sentence>
      <Fields>PfaSub|BCusId|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
<!--对公签约校验开户行-->
      <If condition="IS_NOEQUAL_STRING($FUNC,2)">
        <Exec func="PUB:CallHostOther">
          <Arg name="HTxnCd" value="109000"/>
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
        <If condition="IS_NOEQUAL_STRING($NodNo,$OpnNod)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=非帐户开户网点</Set>
          <Return/>
        </If>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="QryCusInf"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Switch expression="$FUNC">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=记录已存在，请使用修改交易完成登记工作</Set>
            <Return/>
          </If>
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="pfacusinf"/>
          </Exec>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam"  value="pfacusinf"/>
            <Arg name="CndSts"  value="UpdCusInf"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="DelCusInf"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461006" desc="授权支付额度确认">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="MultiQuery">
      <Sentence>
        select QuoId,TSeqNo,BCusId,DptCod,RegDat,TxnFlg,SubCod,EConTp,PrjCod,ABnkNo,ActNo,QuoAmt,AmtTyp,QuoSmr,Mon,Year
          from %s
         where PfaSub='%s' and Year=substr('%s',1,4) and ( BCusId='%s' or '%s'='' ) and ( TSeqNo='%s' or '%s'='' )
           and QuoSts='0'
      order by TSeqNo
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|ActDat|BCusId|BCusId|TSeqNo|TSeqNo|</Fields>
    </DynSentence>
    <DynSentence name="SingleQuery">
      <Sentence>
        select QuoId,TSeqNo,BCusId,DptCod,RegDat,TxnFlg,SubCod,EConTp,PrjCod,ABnkNo,ActNo,QuoAmt,AmtTyp,QuoSmr,Mon,Year
          from %s
          where PfaSub='%s' and Year=substr('%s',1,4) and TSeqNo='%s' and QuoSts='0'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|ActDat|TSeqNo|</Fields>
    </DynSentence>
    <DynSentence name="GetQuoBok">
      <Sentence>
        select %s, Mon, QuoAmt, TxnFlg from %s where QuoSts='0' and TSeqNo='%s'
      </Sentence>
      <Fields>SqlCol|QuoBokTbl|TSeqNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdQuoBokInf">
      <Sentence>
        update %s set ActNo='%s', NodNo='%s' where QuoSts='0' and TSeqNo='%s'
      </Sentence>
      <Fields>QuoBokTbl|ActNo|OpnNod|TSeqNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdQuoSts">
      <Sentence>
        update %s set QuoSts='1', ActDat='%s', BrNo='%s', ChkId='%s', UpdFlg='%s', BokIdx='%s' where QuoSts='0' and TSeqNo='%s'
      </Sentence>
      <Fields>QuoBokTbl|ActDat|BrNo|TlrId|UpdFlg|SelVal|TSeqNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery"/>
          <Return/>
        </Case>
        <Case value="2">
          <Quote name="ChkSubCfg"/>
          <If condition="IS_NOEQUAL_STRING($AgtNod,$NodNo)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(非财政【,$PfaSub,】代理网点)</Set>
            <Return/>
          </If>
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="SingleQuery"/>
            </Args>
          </Exec>
<!--更新记录客户资料-->
          <If condition="ISNULL(DELSPACE($ActNo,all))">
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="GetCusInf"/>
              </Args>
            </Exec>
            <If condition="~RetCod!=0">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=STRCAT(数据库查询失败或预算单位【,$BCusId,】资料不存在)</Set>
              <Return/>
            </If>
            <If condition="ISNULL(DELSPACE($OpnNod,all))">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=STRCAT(预算单位【,$BCusId,】资料不完整)</Set>
              <Return/>
            </If>
            <Else>
              <Exec func="PUB:ExecSql" error="IGNORE">
                <Args>
                  <Arg name="SqlCmd" value="UpdQuoBokInf"/>
                </Args>
              </Exec>
              <If condition="INTCMP(~RetCod,4,0)">
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=更新额度表客户资料失败</Set>
                <Return/>
              </If>
            </Else>
          </If>
          <Return/>
        </Case>
        <Case value="3">
          <Exec func="PUB:AddAuthReason">
            <Arg name="AthCod" value="30"/>
            <Arg name="AthMsg" value="PFA000"/>
          </Exec>
          <Exec func="PUB:CheckLocalAuth">
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <Set>StsNam=QuoSts</Set>
          <Set>StsVal=0</Set>
          <Quote name="GetSqlCol"/>
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="GetQuoBok"/>
            </Args>
          </Exec>
          <Set>ValDat=STRCAT(SUBSTR($ActDat,1,4),$Mon)</Set>
          <Set>UpdFlg=0</Set>
          <If condition="INTCMP($ValDat,2,SUBSTR($ActDat,1,6))">   <!--即时生效处理流程-->
<!--获取支付控制级别-->
            <Set>StsNam=BalSts</Set>
            <Set>StsVal=0</Set>
            <Quote name="GetSqlStr"/>  <!--获取额度余额表条件串-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="GetQuoBal"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <If condition="~RetCod=-2">
<!--初始化客户额度余额表-->
              <If condition="IS_EQUAL_STRING($TxnFlg,1)">  <!--调减-->
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=STRCAT(财政【,$PfaSub,】客户【,$BCusId,】额度不能为负)</Set>
                <Return/>
              </If>
              <Set>BalSts=0</Set>
              <Set>QuoTot=0</Set>
              <Set>QuoBal=0</Set>
              <Set>FrzAmt=0</Set>
              <Exec func="PUB:InsertRecord">
                <Arg name="TblNam" value="pfaquobal"/>
              </Exec>
            </If>
            <If condition="IS_EQUAL_STRING($TxnFlg,0)">  <!--调增-->
              <Set>QuoTot=ADDCHAR(ADDAMT($QuoTot,$QuoAmt),15,0,1)</Set>
              <Set>QuoBal=ADDCHAR(ADDAMT($QuoBal,$QuoAmt),15,0,1)</Set>
            </If>
            <Else>
              <If condition="INTCMP($QuoBal,1,$QuoAmt)">
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=当前额度余额小于调减额度，不能调减</Set>
                <Return/>
              </If>
              <Set>QuoTot=ADDCHAR(SUBAMT($QuoTot,$QuoAmt),15,0,1)</Set>
              <Set>QuoBal=ADDCHAR(SUBAMT($QuoBal,$QuoAmt),15,0,1)</Set>
            </Else>
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="UpdQuoBal"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库处理失败</Set>
              <Return/>
            </If>
            <Set>UpdFlg=1</Set>
          </If> <!--即时生效处理流程结束-->
          <Exec func="PUB:nGetPubSeqNo">
            <Arg name="SeqNam" value="PfaQuoBok:BokIdx"/>
            <Arg name="Len"    value="6"/>
            <Arg name="CycCnd" value="Y"/>
          </Exec>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdQuoSts"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Set>RspMsg=交易成功</Set>
          <Return/>
        </Case>
        <Case value="4">
          <Exec func="PUB:GetNextWorkDate">
            <Arg name="Date" value="$ActDat"/>
          </Exec>
          <Set>RegDat=$ActDat</Set>
          <Set>FmtFil=STRCAT(etc/,PFA015_RPT.XML)</Set>
          <Set>RptFil=STRCAT(PFA015,$TlrId,.RPT)</Set>
          <Set>RptNam=未确认额度清单</Set>
          <Exec func="EXT:GenerateReport">
            <Arg name="RptName" value="STRCAT($RptDir,$RptFil)"/>
            <Arg name="RptFile" value="$FmtFil"/>
            <Arg name="RptNam"  value="$RptNam"/>
            <Arg name="PfaSub"  value="$PfaSub"/>
            <Arg name="RegDat"  value="$RegDat"/>
            <Arg name="TlrId"   value="$TlrId"/>
            <Arg name="PrtDat"  value="$ActDat"/>
          </Exec>
          <Exec func="PUB:SendFileMessage2">
            <Arg name="MsgTyp"  value="4"/>
            <Arg name="ObjNod"  value="$NodNo"/>
            <Arg name="BusTyp"  value="46"/>
            <Arg name="AplCod"  value="$TxnCod"/>
            <Arg name="FilNam"  value="$RptFil"/>
            <Arg name="Summary" value="$RptNam"/>
            <Arg name="ObjTlr"  value="$TlrId"/> 
          </Exec>
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Set>RspMsg=交易成功</Set>
          <Return/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461007" desc="授权支付额度注销">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="UpdQuoSts">
      <Sentence>
        update pfaquobal set BalSts='1'
         where PfaSub='%s' and Year='%s' and ( BCusId='%s' or '%s'='' ) and ( QuoId='%s' or '%s'='' )
           and ( SubCod='%s' or '%s'='' ) and ( PrjCod='%s' or '%s'='' ) and ( DptCod='%s' or '%s'='' ) and BalSts='0'
      </Sentence>
      <Fields>PfaSub|Year|BCusId|BCusId|QuoId|QuoId|SubCod|SubCod|PrjCod|PrjCod|DptCod|DptCod|</Fields>
    </DynSentence>
    <DynSentence name="QryQuoBal">
      <Sentence>
        select BCusId, QuoId, SubCod, PrjCod, EConTp, DptCod, QuoBal from pfaquobal
         where PfaSub='%s' and Year='%s' and ( BCusId='%s' or '%s'='' ) and ( QuoId='%s' or '%s'='' )
           and ( SubCod='%s' or '%s'='' ) and ( PrjCod='%s' or '%s'='' ) and ( DptCod='%s' or '%s'='' ) and BalSts='1'
      order by QuoId,BCusId, SubCod, PrjCod, EConTp, DptCod
      </Sentence>
      <Fields>PfaSub|Year|BCusId|BCusId|QuoId|QuoId|SubCod|SubCod|PrjCod|PrjCod|DptCod|DptCod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_NOEQUAL_STRING($NodNo,$ClrNod)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政【,$PfaSub,】清算机构)</Set>
        <Return/>
      </If>
      <Exec func="PUB:AddAuthReason">
        <Arg name="AthCod" value="33"/>
        <Arg name="AthMsg" value="PFA000"/>
      </Exec>
      <Exec func="PUB:CheckLocalAuth">
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
<!--为避免同一分行并发-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
<!--更新额度表状态-->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="UpdQuoSts"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(更新【,$PfaSub,】额度余额表失败)</Set>
        <Return/>
      </If>
<!--产生报表-->
      <Set>FilNam=STRCAT(PFA016,$TlrId,.RPT)</Set>
      <Set>RtnFil=STRCAT(GETENV(WORKDIR),/,$RptDir,$FilNam)</Set>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql"    value="QryQuoBal"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Return/>
      </If>
      <Set>SeqNo=0</Set>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCusInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>CodTyp=SUBCOD</Set>
        <Set>Code=$SubCod</Set>
        <Set>CodNam=SubNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>CodTyp=ECONTP</Set>
        <Set>Code=$EConTp</Set>
        <Set>CodNam=EConNm</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>CodTyp=PRJCOD</Set>
        <Set>Code=$PrjCod</Set>
        <Set>CodNam=PrjNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>CodTyp=DPTCOD</Set>
        <Set>Code=$DptCod</Set>
        <Set>CodNam=DptNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>SeqNo=ADD($SeqNo,1)</Set>
        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$RtnFil"/>
          <Arg name="OpenMode" value="a+"/>
          <Arg name="Data"     value="$SeqNo"/> 
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$QuoId"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$BCusId"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$BCusNm"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$SubCod"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$SubNam"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$EConTp"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$EConNm"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$PrjCod"/>
          <Arg name="Data"     value="|"/> 
          <Arg name="Data"     value="$PrjNam"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$DptCod"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="$DptNam"/>
          <Arg name="Data"     value="|"/>
          <Arg name="Data"     value="AMTFMT($QuoBal)"/>
          <Arg name="ESCFMT"   value="\\n"/>
        </Exec>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="3"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461008" desc="财政代理协议维护">
    <DynSentence name="GetCusAgr"> <!-- 查询 -->
      <Sentence>
        select PfaSub OPfaSub, BCusId OBCusId, ActNo OActNo, SubCod OSubCod, EConTp OEConTp, PrjCod OPrjCod, DptCod ODptCod
          from pfacusagr where AgrNo='%s'
      </Sentence>
      <Fields>AgrNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdCusAgr"> <!--修改-->
      <Sentence>
        AgrNo='%s'
      </Sentence>
      <Fields>AgrNo|</Fields>
    </DynSentence>
    <DynSentence name="DelCusAgr"> <!--删除-->
      <Sentence>
        delete from pfacusagr where AgrNo='%s'
      </Sentence>
      <Fields>AgrNo|</Fields>
    </DynSentence>
    <DynSentence name="GetBepAgr"> <!-- 查询借记协议号 -->
      <Sentence>
        select PyrAct from lbepcusagr where AgrNo='%s'
      </Sentence>
      <Fields>AgrNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
<!--检查是否开户网点-->
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,4),IS_NOEQUAL_STRING($FUNC,2))">
        <Exec func="PUB:CallHostOther">
          <Arg name="HTxnCd" value="109000"/>
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
        <If condition="IS_NOEQUAL_STRING($NodNo,$OpnNod)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=非帐户开户网点</Set>
          <Return/>
        </If>
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="30"/>
          <Arg name="AthMsg" value="PFA000"/>
        </Exec>
        <Exec func="PUB:CheckLocalAuth">
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetCusAgr"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,0),IS_NOEQUAL_STRING($FUNC,4),INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Switch expression="$FUNC">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="pfacusagr"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="pfacusagr"/>
            <Arg name="CndSts" value="UpdCusAgr"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="DelCusAgr"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Case value="4"> <!-- 检查协议号合法性 -->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetBepAgr"/>
            </Args>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库操作错或协议号不合法</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,2),IS_NOEQUAL_STRING($FUNC,4))">
        <Set>Msg1=STRCAT(借记协议维护:功能[,$Func,]财政代码[,$PfaSub,]单位代码[,$BCusId,]账号[,$ActNo,])</Set>
        <Set>Msg2=STRCAT(科目代码[,$SubCod,]经济分类[,$EConTp,]项目代码[,$PrjCod,]业务处室[,$DptCod,])</Set>
        <Set>NoteInfo=STRCAT($Msg1,$Msg2,网点[,$NodNo,]柜员[,$TlrId,])</Set>
        <Exec func="PUB:CallHostOther">
          <Arg name="HTxnCd" value="455130"/>
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>




  <Transaction code="461025" desc="财政支付明细浏览">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="MultiQuery">
      <Sentence>
        select NodNo, AVchNo, TxnAmt, VchSts, OIFlag, ClrSts, DtlNum
          from pfavchbok
         where PfaSub='%s' and Year=substr('%s',1,4) and ( AVchNo='%s' or '%s'='' )
           and ( PayAct='%s' or PyeAct='%s' or '%s'='' ) and ( TxnAmt='%s' or '%s'='000000000000000' )
           and OIFlag='%s' and ( ActDat='%s' or '%s'='' ) and ( VchSts='%s' or '%s'='' )
           and ( ClrSts='%s' or '%s'='' ) and ( NodNo='%s' or '%s'='' )
      </Sentence>
      <Fields>PfaSub|ActDat|AVchNo|AVchNo|ActNo|ActNo|ActNo|TxnAmt|TxnAmt|OIFlag|QryDat|QryDat|VchSts|VchSts|ClrSts|ClrSts|ONodNo|ONodNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Switch expression="$Func">
        <Case value="1">
          <Quote name="ChkSubCfg"/>
          <Exec func="PUB:MultiQuery"/>
          <Return/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Arg name="sql" value="GetVchBok"/>
          </Exec>
          <Set>VchTyp=$OVchTyp</Set>
          <Return/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461026" desc="财政支付凭证浏览">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="MultiQuery">
      <Sentence>
        select DtlSts, AVchCd, AVchNo, OIFlag, DtlAmt, UseAmt
          from %s
         where PfaSub='%s' and Year=substr('%s',1,4) and ( AVchCd='%s' or '%s'='' ) and ( AVchNo='%s' or '%s'='' )
           and OIFlag='%s' and ( PayAct='%s' or PyeAct='%s' or '%s'='' ) and ( RegDat between '%s' and '%s' )
           and ( TVchTp='%s' or '%s'='' )
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|ActDat|AVchCd|AVchCd|AVchNo|AVchNo|OIFlag|ActNo|ActNo|ActNo|BegDat|EndDat|TVchTp|TVchTp|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery"/>
          <Return/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Arg name="sql" value="GetDtlByAVchCd"/>
          </Exec>
          <Return/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461028" desc="授权支付额度余额浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select BalSts,BCusId,QuoId,SubCod,PrjCod,EConTp,DptCod,AmtTyp,QuoTot,QuoBal,FrzAmt               
          from pfaquobal
          where PfaSub='%s' and Year=substr('%s',1,4) and ( BCusId='%s' or '%s'='' )
      </Sentence>
      <Fields>PfaSub|ActDat|BCusId|BCusId|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:MultiQuery"/>
      <Return/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461030" desc="授权支付额度令浏览">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="MultiQuery">
      <Sentence>
        select QuoSts,QuoId,BCusId,SubCod,PrjCod,EConTp,DptCod,Mon,TxnFlg,QuoAmt,RegDat
          from %s
         where PfaSub='%s' and Year=substr('%s',1,4) and BCusId='%s' and ( RegDat between '%s' and '%s' ) and QuoSts!='0'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|ActDat|BCusId|BegDat|EndDat|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:MultiQuery"/>
      <Return/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461062" desc="财政支付到帐通知单打印">
    <DynSentence name="UpdQuoBok">
      <Sentence>
        update %s set QuoSts='2',PrtCnt=char(int(PrtCnt)+1) 
         where PfaSub='%s' and BCusid='%s' and substr(RegDat,1,6)=substr('%s',1,6) and QuoSts in ( '1','2' )
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|BCusId|RegDat|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <If condition="IS_EQUAL_STRING($PfaSub,001)">
        <Set>FilNam=STRCAT(PFA001,$TlrId,.RPT)</Set>
        <Set>FmtFil=STRCAT(etc/,PFA001_RPT.XML)</Set>
      </If>
      <Else>
        <Set>FilNam=STRCAT(PFA101,$TlrId,.RPT)</Set>
        <Set>FmtFil=STRCAT(etc/,PFA201_RPT.XML)</Set>
      </Else>
      <Set>RptHead=财政授权支付额度到账通知书</Set>
      <Set>Summary=打印财政授权支付额度到账通知书</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="RptHead" value="$RptHead"/>
        <Arg name="PfaSub"  value="$PfaSub"/>
        <Arg name="BCusId"  value="$BCusId"/>
        <Arg name="RegDt"   value="$RegDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Exec func="PUB:ExecSql">
        <Arg name="sql" value="UpdQuoBok"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461063" desc="财政支付日清单打印">
    <Quote name="PfaSqlLst"/>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_EQUAL_STRING($ClrNod,$NodNo)">  <!--若输入代理分行号可打印该财政代码下所有数据-->
        <Set>RptNod= </Set>
      </If>
      <Else>
        <Set>RptNod=$NodNo</Set>
      </Else>
      <Set>FilNam=STRCAT(PFA002,$TlrId,.RPT)</Set>
      <Set>FmtFil=STRCAT(etc/,PFA002_RPT.XML)</Set>
      <Set>RptHead=财政授权支付日报表</Set>
      <Set>Summary=打印财政授权支付日报表</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="RptHead" value="$RptHead"/>
        <Arg name="PfaSub"  value="$PfaSub"/>
        <Arg name="PrtNod"  value="$PrtNod"/>
        <Arg name="PrtDat"  value="$PrtDat"/>
        <Arg name="RptNod"  value="$RptNod"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461064" desc="财政支付月度对账单打印">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="GetRptPar">
      <Sentence>
        select distinct QuoId, SubCod, PrjCod, DptCod from %s
         where PfaSub='%s' and year='%s' and BCusId='%s' and QuoSts!='0'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|Year|BCusId|</Fields>
    </DynSentence>
    <DynSentence name="GetTotQuo">
      <Sentence>
        select value( sum( ((-2)*bigint(Txnflg)+1)*bigint(quoamt) ),0 ) TotQuo
          from %s
         where PfaSub='%s' and year='%s' and BCusId='%s' and QuoSts!='0'
           and QuoId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s'
           and ActDat between '%s' and '%s'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|Year|BCusId|QuoId|SubCod|PrjCod|DptCod|Dat1|Dat2|</Fields>
    </DynSentence>
    <DynSentence name="GetTotUse">
      <Sentence>
        select value( sum( bigint(UseAmt) ),0 ) UseAmt
          from %s
         where PfaSub='%s' and year='%s' and BCusId='%s' and OIFlag='%s'
           and QuoId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s'
           and ActDat between '%s' and '%s'
           and DtlSts='2'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|Year|BCusId|OIFlag|QuoId|SubCod|PrjCod|DptCod|Dat1|Dat2|</Fields>
    </DynSentence>
    <DynSentence name="GetNClrAmt">
      <Sentence>
        select value( sum( bigint(UseAmt) ),0 ) UseAmt
          from %s
         where PfaSub='%s' and year='%s' and BCusId='%s' and OIFlag='%s'
           and QuoId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s'
           and ActDat between '%s' and '%s'
           and DtlSts='2' and ClrSts !='3'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|Year|BCusId|OIFlag|QuoId|SubCod|PrjCod|DptCod|Dat1|Dat2|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
<!--新增报表-->
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetCusInf"/>
        </Args>
      </Exec>
      <If condition="IS_NOEQUAL_STRING($OpnNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政单位【,$BCusId,】的账户开户行</Set>
        <Return/>
      </If>
      <Set>AmtTyp=0001</Set>  <!--预算内-->
      <Set>Year=SUBSTR($BegDat,1,4)</Set>
      <Switch expression="$RptTyp">
        <Case value="1"> <!-- 月度额度对账单 -->
          <Set>FmtFil=STRCAT(etc/,PFA003_RPT.XML)</Set>
          <Set>RptFil=STRCAT(PFA003,$TlrId,.RPT)</Set>
          <Set>DatFil=STRCAT($RptDir,$RptFil,.data)</Set>
<!--报表头-->
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$DatFil"/>
            <Arg name="OpenMode" value="w"/>
            <Arg name="Data"   value="[2]:PfaSub="/>
            <Arg name="Data"   value="$PfaSub"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="BCusId="/>
            <Arg name="Data"   value="$BCusId"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="BCusNm="/>
            <Arg name="Data"   value="$BCusNm"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="ActNo="/>
            <Arg name="Data"   value="$ActNo"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="ActNam="/>
            <Arg name="Data"   value="$ActNam"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="AmtTyp="/>
            <Arg name="Data"   value="$AmtTyp"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="BegDat="/>
            <Arg name="Data"   value="$BegDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="EndDat="/>
            <Arg name="Data"   value="$EndDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtDat="/>
            <Arg name="Data"   value="$ActDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtTlr="/>
            <Arg name="Data"   value="$TlrId"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtNod="/>
            <Arg name="Data"   value="$NodNo"/>
            <Arg name="Data"   value="|"/>
            <Arg name="ESCFMT" value="\\n"/>
          </Exec>
<!--通过游标获取报表参数(QuoId,SubCod,PrjCod,DptCod),及对应年头到上月累计发放额-->
          <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="sql" value="GetRptPar"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <Set>Dat1=STRCAT($Year,0101)</Set>
            <Set>Dat2=CALCDATE($BegDat,-,d,1)</Set>
<!--计算上月结余额【LQuoBal=下发全额-使用额+退回额】-->
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotQuo"/>
              </Args>
            </Exec>
            <Set>LTotQuo=$TotQuo</Set>
            <Set>OIFlag=O</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotUse"/>
              </Args>
            </Exec>
            <Set>LO_Amt=$UseAmt</Set>
            <Set>OIFlag=R</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotUse"/>
              </Args>
            </Exec>
            <Set>LR_Amt=$UseAmt</Set>
            <Set>LUseAmt=SUB($LO_Amt,$LR_Amt)</Set>
            <Set>LQuoBal=SUB($LTotQuo,$LUseAmt)</Set>
<!--计算本月下发额度【CTotQuo】-->
            <Set>Dat1=$BegDat</Set>
            <Set>Dat2=$EndDat</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotQuo"/>
              </Args>
            </Exec>
            <Set>CTotQuo=$TotQuo</Set>
<!--计算本月实际支出【CUseAmt】-->
            <Set>OIFlag=O</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotUse"/>
              </Args>
            </Exec>
            <Set>CO_Amt=$UseAmt</Set>
            <Set>OIFlag=R</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotUse"/>
              </Args>
            </Exec>
            <Set>CR_Amt=$UseAmt</Set>
            <Set>CUseAmt=SUB($CO_Amt,$CR_Amt)</Set>
<!---计算当前累计支出【CTotAmt】-->
            <Set>CTotAmt=ADD($LUseAmt,$CUseAmt)</Set>
<!---计算当前累计结余【CQuoBal】-->
            <Set>CQuoBal=SUB(ADD($LQuoBal,$CTotQuo),$CUseAmt)</Set>
<!--垫付未清算【NUseAmt】-->
            <Set>OIFlag=O</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetNClrAmt"/>
              </Args>
            </Exec>
            <Set>NO_Amt=$UseAmt</Set>
            <Set>OIFlag=R</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetNClrAmt"/>
              </Args>
            </Exec>
            <Set>NR_Amt=$UseAmt</Set>
            <Set>NUseAmt=SUB($NO_Amt,$NR_Amt)</Set>
<!--计算小计金额-->
            <Set>Tot_LQuoBal=ADD($Tot_LQuoBal,$LQuoBal)</Set>
            <Set>Tot_CTotQuo=ADD($Tot_CTotQuo,$CTotQuo)</Set>
            <Set>Tot_CUseAmt=ADD($Tot_CUseAmt,$CUseAmt)</Set>
            <Set>Tot_CTotAmt=ADD($Tot_CTotAmt,$CTotAmt)</Set>
            <Set>Tot_CQuoBal=ADD($Tot_CQuoBal,$CQuoBal)</Set>
            <Set>Tot_NUseAmt=ADD($Tot_NUseAmt,$NUseAmt)</Set>
<!--获取科目，项目，业务处室对应中文-->
            <Delete>SubNam</Delete>
            <Delete>PrjNam</Delete>
            <Delete>DptNam</Delete>
            <Set>CodTyp=SUBCOD</Set>
            <Set>Code=$SubCod</Set>
            <Set>CodNam=SubNam</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="GetCodInf"/>
            </Exec>
            <Set>CodTyp=PRJCOD</Set>
            <Set>Code=$PrjCod</Set>
            <Set>CodNam=PrjNam</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="GetCodInf"/>
            </Exec>
<!--
            <Set>CodTyp=ECONTP</Set>
            <Set>Code=$EConTp</Set>
            <Set>CodNam=EConNm</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="GetCodInf"/>
            </Exec>
            <Set>CodTyp=DPTCOD</Set>
            <Set>Code=$DptCod</Set>
            <Set>CodNam=DptNam</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="GetCodInf"/>
            </Exec>
-->
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$DatFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="[3]:QuoId="/>
              <Arg name="Data"   value="$QuoId"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubCod="/>
              <Arg name="Data"   value="$SubCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubNam="/>
              <Arg name="Data"   value="$SubNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjCod="/>
              <Arg name="Data"   value="$PrjCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjNam="/>
              <Arg name="Data"   value="$PrjNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="DptCod="/>
              <Arg name="Data"   value="$DptCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="LQuoBal="/>
              <Arg name="Data"   value="$LQuoBal"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="CTotQuo="/>
              <Arg name="Data"   value="$CTotQuo"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="CUseAmt="/>
              <Arg name="Data"   value="$CUseAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="CTotAmt="/>
              <Arg name="Data"   value="$CTotAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="CQuoBal="/>
              <Arg name="Data"   value="$CQuoBal"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="NUseAmt="/>
              <Arg name="Data"   value="$NUseAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="ESCFMT" value="\\n"/>
            </Exec>
          </While>
<!--写入汇总记录-->
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$DatFil"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="Data"   value="[5]:Tot_LQuoBal="/>
            <Arg name="Data"   value="$Tot_LQuoBal"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="Tot_CTotQuo="/>
            <Arg name="Data"   value="$Tot_CTotQuo"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="Tot_CUseAmt="/>
            <Arg name="Data"   value="$Tot_CUseAmt"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="Tot_CTotAmt="/>
            <Arg name="Data"   value="$Tot_CTotAmt"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="Tot_CQuoBal="/>
            <Arg name="Data"   value="$Tot_CQuoBal"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="Tot_NUseAmt="/>
            <Arg name="Data"   value="$Tot_NUseAmt"/>
            <Arg name="Data"   value="|"/>
            <Arg name="ESCFMT" value="\\n"/>
          </Exec>
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$DatFil"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="Data"   value="[7]:PrtDat="/>
            <Arg name="Data"   value="$ActDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtTlr="/>
            <Arg name="Data"   value="$TlrId"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtNod="/>
            <Arg name="Data"   value="$NodNo"/>
            <Arg name="Data"   value="|"/>
            <Arg name="ESCFMT" value="\\n"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:GenerateReport">
            <Arg name="ObjFil" value="STRCAT($RptDir,$RptFil)"/>
            <Arg name="FmtFil" value="$FmtFil"/>
            <Arg name="DatFil" value="$DatFil"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 月度明细对账单 -->
          <Set>FmtFil=STRCAT(etc/,PFA012_RPT.XML)</Set>
          <Set>RptFil=STRCAT(PFA012,$TlrId,.RPT)</Set>
          <Set>RptNam=财政月度支付明细对账单</Set>
          <Exec func="EXT:GenerateReport">
            <Arg name="RptName" value="STRCAT($RptDir,$RptFil)"/>
            <Arg name="RptFile" value="$FmtFil"/>
            <Arg name="PfaSub"  value="$PfaSub"/>
            <Arg name="BCusId"  value="$BCusId"/>
            <Arg name="BCusNm"  value="$BCusNm"/>
            <Arg name="ActNo"   value="$ActNo"/>
            <Arg name="ActNam"  value="$ActNam"/>
            <Arg name="AmtTyp"  value="$AmtTyp"/>
            <Arg name="BegDat"  value="$BegDat"/>
            <Arg name="EndDat"  value="$EndDat"/>
            <Arg name="PrtDat"  value="$ActDat"/>
            <Arg name="PrtTlr"  value="$TlrId"/>
            <Arg name="PrtNod"  value="$NodNo"/>
          </Exec>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$RptFil"/>
        <Arg name="Summary" value="$RptNam"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461065" desc="财政支付凭证打印">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="UpdPrtNum">   <!-- 修改印次数 -->
      <Sentence>
        update %s set PrtNum = char( int(PrtNum) + 1 )
         where PfaSub='%s' and Year=substr('%s',1,4) and BCusId='%s' and DtlSts='2'
           and ( AVchNo='%s' or '%s'='' ) and ( AVchCd='%s' or '%s'='' ) and %s
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|ActDat|BCusId|AVchNo|AVchNo|AVchCd|AVchCd|AddCon|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="GetCusInf"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <Quote name="ChkSubCfg"/>
      <If condition="AND(IS_NOEQUAL_STRING($ClrNod,$NodNo),IS_NOEQUAL_STRING($BrNo,$ActBr))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=非本分行客户</Set>
        <Return/>
      </If>
      <If condition="IS_EQUAL_STRING($Func,1)">   <!--记帐凭证-->
        <Set>FilNam=STRCAT(PFA004,$TlrId,.RPT)</Set>
        <Set>FmtFil=STRCAT(etc/,PFA004_RPT.XML)</Set>
        <Set>Summary=财政支付记帐凭证打印</Set>
      </If>
      <Else>   <!--业务回执-->
        <Set>FilNam=STRCAT(PFA011,$TlrId,.RPT)</Set>
        <Set>FmtFil=STRCAT(etc/,PFA011_RPT.XML)</Set>
        <Set>Summary=财政支付业务回执打印</Set>
      </Else>
      <Switch expression="$PrtTyp">
        <Case value="1"/> <!-- 调整 -->
        <Case value="3"> <!-- 限额 -->
          <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">  <!--帐务中心专用-->
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=该交易只能帐务中心使用</Set>
            <Return/>
          </If>
          <If condition="IS_EQUAL_STRING($Func,1)">
            <Set>AddCon=STRCAT( TVchTp='2' )</Set>
          </If>
          <Else>
            <Set>AddCon=STRCAT( TVchTp='1' )</Set>
          </Else>
          <Break/>
        </Case>
        <Case value="2"> <!-- 退回 -->
          <Set>AddCon=STRCAT( TVchTp='0' and OIFlag='R' )</Set>
          <Break/>
        </Case>
        <Case value="0"> <!-- 支出 -->
          <Set>AddCon=STRCAT( TVchTp='0' and OIFlag='O' )</Set>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=该类凭证不能打印</Set>
          <Return/>
        </Default>
      </Switch>
      <If condition="IS_EQUAL_STRING($Func,2)">   <!--业务回执-->
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="UpdPrtNum"/>
          </Args>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=修改回执打印次数失败</Set>
          <Return/>
        </If>
        <If condition="~RetCod=-2">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=没有满足条件的记录UpdPrtNum</Set>
          <Return/>
        </If>
      </If>
      <Exec func="EXT:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="PfaSub"  value="$PfaSub"/>
        <Arg name="BCusId"  value="$BCusId"/>
        <Arg name="BCusNm"  value="$BCusNm"/>
        <Arg name="FCusNm"  value="$FCusNm"/>
        <Arg name="AVchNo"  value="$AVchNo"/>
        <Arg name="AVchCd"  value="$AVchCd"/>
        <Arg name="AddCon"  value="$AddCon"/>
        <Arg name="PrtDat"  value="$ActDat"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="NodNo"   value="$NodNo"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461072" desc="支出报表打印">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="GetVchDtlInf">
      <Sentence>
        select distinct BCusId,SubCod,PrjCod,DptCod from PfaVchBok 
        where PfaSub='%s'  and ( PfaDat between '%s' and '%s' ) and '%s' and ClrSts='3'
      </Sentence>
      <Fields>PfaSub|BegDat|EndDat|</Fields>
    </DynSentence>
    <DynSentence name="SumOutAmt">
      <Sentence>
        select value(sum(bigint(UseAmt)),0) OutAmt from %s 
         where PfaSub='%s' and BCusId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s'
           and ( PfaDat between '%s' and '%s' ) and OIFlag='O' and ClrSts='3' and DtlSts='2'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|BCusId|SubCod|PrjCod|DptCod|BegDat|EndDat|</Fields>
    </DynSentence>
    <DynSentence name="SumInAmt">
      <Sentence>
        select value(sum(bigint(UseAmt)),0) InAmt from %s 
         where PfaSub='%s' and BCusId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s'
           and ( PfaDat between '%s' and '%s' ) and OIFlag in ('I','R') and ClrSts='3' and DtlSts='2'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|BCusId|SubCod|PrjCod|DptCod|BegDat|EndDat|</Fields>
    </DynSentence>
    <DynSentence name="CntNum">
      <Sentence>
        select count(*) TotNum from %s where PfaSub='%s'  and ( PfaDat between '%s' and '%s' ) and ClrSts='3' and DtlSts='2'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|BegDat|EndDat|</Fields>
    </DynSentence>    
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_NOEQUAL_STRING($ClrNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政【,$PfaSub,】清算网点)</Set>
        <Return/>
      </If>
      <Switch expression="$RptTyp">
        <Case value="1"> <!-- 日报 -->
          <Set>FilNam=STRCAT(PFA005,$TlrId,.RPT)</Set>
          <Set>FmtFil=etc/PFA005_RPT.XML</Set>
          <Break/>
        </Case>
        <Case value="2"> <!-- 旬报 -->
          <Set>FilNam=STRCAT(PFA006,$TlrId,.RPT)</Set>
          <Set>FmtFil=etc/PFA006_RPT.XML</Set>
          <Break/>
        </Case>
        <Case value="3"> <!-- 月报 -->
          <Set>FilNam=STRCAT(PFA007,$TlrId,.RPT)</Set>
          <Set>FmtFil=etc/PFA007_RPT.XML</Set>
          <Break/>
        </Case>
      </Switch>
      <Set>DatFil=STRCAT($RptDir,$FilNam,.data)</Set>
      <Set>RptFil=STRCAT($RptDir,$FilNam)</Set>
<!--根据日期范围取值-->
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql"        value="GetVchDtlInf"/>
        <Arg name="CursorName" value="CURSOR_1"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Return/>
      </If>
      <Set>SeqNo=0</Set>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="w"/>
        <Arg name="Data"   value="[2]:BegDat="/>
        <Arg name="Data"   value="$BegDat"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="EndDat="/>
        <Arg name="Data"   value="$EndDat"/>
        <Arg name="Data"   value="|"/>
        <Arg name="ESCFMT" value="\\n"/>
      </Exec>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE">
          <Arg name="CursorName" value="CURSOR_1"/>
        </Exec>
        <If condition="~RetCod=100">
          <If condition="INTCMP($SeqNo,4,0)">
            <Break/>
          </If>
          <Else>
            <Exec func="PUB:CloseCursor" error="IGNORE">
              <Arg name="CursorName" value="CURSOR_1"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=没有满足条件的记录</Set>
            <Return/>
          </Else>
        </If>
<!--
        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$DatFil"/>
          <Arg name="OpenMode" value="w"/>
          <Arg name="Data"   value="[2]:BegDat="/> 
          <Arg name="Data"   value="$BegDat"/> 
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="EndDat="/> 
          <Arg name="Data"   value="$EndDat"/> 
          <Arg name="Data"   value="|"/>
          <Arg name="ESCFMT" value="\\n"/>
        </Exec>
-->
<!--获取对应代码名称-->
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCusInf"/>
        </Exec>
        <Set>CodTyp=SUBCOD</Set>
        <Set>Code=$SubCod</Set>
        <Set>CodNam=SubNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <Set>CodTyp=PRJCOD</Set>
        <Set>Code=$PrjCod</Set>
        <Set>CodNam=PrjNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
<!--
        <Set>CodTyp=ECONTP</Set>
        <Set>Code=$EConTp</Set>
        <Set>CodNam=EConNm</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
-->
        <Set>CodTyp=DPTCOD</Set>
        <Set>Code=$DptCod</Set>
        <Set>CodNam=DptNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumOutAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】支出金额失败)</Set>
          <Return/>
        </If>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumInAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】退回或收入金额失败)</Set>
          <Return/>
        </If>
        <Set>SumAmt=SUBAMT($OutAmt,$InAmt)</Set>
        <Set>SeqNo=ADDCHAR(ADD($SeqNo,1),2,0,1)</Set>
        <Switch expression="$RptTyp">
          <Case value="1"> <!-- 日报 -->
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$DatFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="[3]:SeqNo="/>
              <Arg name="Data"   value="$SeqNo"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="BCusId="/>
              <Arg name="Data"   value="$BCusId"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="BCusNm="/>
              <Arg name="Data"   value="$BCusNm"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubCod="/>
              <Arg name="Data"   value="$SubCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubNam="/>
              <Arg name="Data"   value="$SubNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjCod="/>
              <Arg name="Data"   value="$PrjCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjNam="/>
              <Arg name="Data"   value="$PrjNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="DptCod="/>
              <Arg name="Data"   value="$DptCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="DptNam="/>
              <Arg name="Data"   value="$DptNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="OutAmt="/>
              <Arg name="Data"   value="$OutAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="InAmt="/>
              <Arg name="Data"   value="$InAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SumAmt="/>
              <Arg name="Data"   value="$SumAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="ESCFMT"   value="\\n"/>
            </Exec>
            <Break/>
          </Case>
          <Case value="2"> <!-- 旬报 -->
            <Set>BBegDat=$BegDat</Set>
            <Set>BegDat=STRCAT(SUBSTR($BegDat,1,6),01)</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="SumOutAmt"/>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="SumInAmt"/>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <Set>MonAmt=SUBAMT($OutAmt,$InAmt)</Set>
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$DatFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="[3]:BCusId="/>
              <Arg name="Data"   value="$BCusId"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="BCusNm="/>
              <Arg name="Data"   value="$BCusNm"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubCod="/>
              <Arg name="Data"   value="$SubCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubNam="/>
              <Arg name="Data"   value="$SubNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjCod="/>
              <Arg name="Data"   value="$PrjCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjNam="/>
              <Arg name="Data"   value="$PrjNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="DptCod="/>
              <Arg name="Data"   value="$DptCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="DptNam="/>
              <Arg name="Data"   value="$DptNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SumAmt="/>
              <Arg name="Data"   value="$SumAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="MonAmt="/>
              <Arg name="Data"   value="$MonAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="ESCFMT" value="\\n"/>
            </Exec>
            <Set>BegDat=$BBegDat</Set>
            <Break/>
          </Case>
          <Case value="3"> <!-- 月报 -->
            <Set>BBegDat=$BegDat</Set>
            <Set>BegDat=STRCAT(SUBSTR($BegDat,1,4),0101)</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="SumOutAmt"/>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="SumInAmt"/>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <Set>YearAmt=SUBAMT($OutAmt,$InAmt)</Set>
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$DatFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="[3]:BCusId="/>
              <Arg name="Data"   value="$BCusId"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="BCusNm="/>
              <Arg name="Data"   value="$BCusNm"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubCod="/>
              <Arg name="Data"   value="$SubCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubNam="/>
              <Arg name="Data"   value="$SubNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjCod="/>
              <Arg name="Data"   value="$PrjCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjNam="/>
              <Arg name="Data"   value="$PrjNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="DptCod="/>
              <Arg name="Data"   value="$DptCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="DptNam="/>
              <Arg name="Data"   value="$DptNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SumAmt="/>
              <Arg name="Data"   value="$SumAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="YearAmt="/>
              <Arg name="Data"   value="$YearAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="ESCFMT" value="\\n"/>
            </Exec>
            <Set>BegDat=$BBegDat</Set>
            <Break/>
          </Case>
        </Switch>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE">
        <Arg name="CursorName" value="CURSOR_1"/>
      </Exec>
<!--计算总笔数-->
      <Switch expression="$RptTyp">
        <Case value="1"/> <!-- 日报 -->
        <Case value="2"> <!-- 旬报 -->
          <Set>BegDat=STRCAT(SUBSTR($BegDat,1,6),01)</Set>
          <Break/>
        </Case>
        <Case value="3"> <!-- 月报 -->
          <Set>BegDat=STRCAT(SUBSTR($BegDat,1,4),0101)</Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="CntNum"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=统计本月发生笔数失败</Set>
        <Return/>
      </If>
      <Set>CurNum=AMTDELZERO($SeqNo)</Set>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="a+"/>
        <Arg name="Data"     value="[7]:CurNum="/> 
        <Arg name="Data"     value="$CurNum"/> 
        <Arg name="Data"     value="|"/>
        <Arg name="Data"     value="TotNum="/> 
        <Arg name="Data"     value="$TotNum"/> 
        <Arg name="Data"     value="|"/>
        <Arg name="Data"     value="TlrId="/> 
        <Arg name="Data"     value="$TlrId"/> 
        <Arg name="Data"     value="|"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec> 
      <Exec func="PUB:GenerateReport" desc="根据转换后的文件生成报表">
        <Arg name="ObjFil" value="$RptFil"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="DatFil" value="$DatFil"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="日报表打印"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461078" desc="财政对账数据发送">
    <Quote name="PfaSqlLst"/>
<!--XX05财政授权支付凭证回单-->
<!--XX10 授权支出日报表信息-->
<!--XX34 明细支出情况表-->
    <DynSentence name="GetPfaVchDtl">
      <Sentence>
        select DtlSts, AVchCd, VchDat, VchNo, ChkFlg, OIFlag, RefCod, OpAVCd, PfaDat, StlMod, DptCod, SubCod, PrjCod,
               EConTp, DtlSmr, DtlIdx, BCusId, AmtTyp, TPayTp,
               case when OIFlag='O' then PyeAct when OIFlag in ( 'I','R' ) then PayAct end PyeAct,
               case when OIFlag='O' then PyeNam when OIFlag in ( 'I','R' ) then PayNam end PyeNam,
               case when OIFlag='O' then PyeBNm when OIFlag in ( 'I','R' ) then PayBNm end PyeBNm,
               case when OIFlag='O' then bigint(DtlAmt) when OIFlag in ( 'I','R' ) then (-1)*bigint(DtlAmt) end DtlAmt,
               case when OIFlag='O' then bigint(UseAmt) when OIFlag in ( 'I','R' ) then (-1)*bigint(UseAmt) end UseAmt
          from %s
         where PfaSub='%s' and ( PfaDat between '%s' and '%s' ) and ClrSts='3'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|BegDat|EndDat|</Fields>
    </DynSentence>
    <DynSentence name="UpdPfaVchDtl">
      <Sentence>
        update %s set RtnFlg='1'  where PfaSub='%s' and PfaDat='%s' and ClrSts='3' and RtnFlg='0'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|PfaDat|</Fields>
    </DynSentence>
<!--报表XX33用到的脚本-->
    <DynSentence name="GetRptBasInf">
      <Sentence>
        select distinct BCusId, SubCod, PrjCod, DptCod from %s where PfaSub='%s' and Year=substr('%s',1,4) and QuoSts in ('1','2')
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|PfaDat|</Fields>
    </DynSentence>
    <DynSentence name="GetOTotAmt">
      <Sentence>
        select value(sum(bigint(UseAmt)),0) OTotAmt
          from %s
         where PfaSub='%s' and ( PfaDat %s ) and ClrSts='3' and DtlSts='2'
           and BCusId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s' and OIFlag ='O'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|SqlDate|BCusId|SubCod|PrjCod|DptCod|</Fields>
    </DynSentence>
    <DynSentence name="GetITotAmt">
      <Sentence>
        select value(sum(bigint(UseAmt)),0) ITotAmt
          from %s
         where PfaSub='%s' and ( PfaDat %s ) and ClrSts='3' and DtlSts='2' 
           and BCusId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s' and OIFlag in ('I','R')
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|SqlDate|BCusId|SubCod|PrjCod|DptCod|</Fields>
    </DynSentence>
<!--XX36用款计划额度表-->
    <DynSentence name="GetMonQuoDtl">
      <Sentence>
        select Year, Mon, ActNo, BCusId, SubCod, EConTp, PrjCod, DptCod, QuoSmr, TSeqNo, RegDat, BokIdx,
          case when TxnFlg='0' then bigint(QuoAmt) when TxnFlg='1' then (-1)*bigint(QuoAmt) end QuoAmt
          from %s
         where PfaSub='%s' and QuoSts in ('1','2') and substr(RegDat,1,6)=substr('%s',1,6)
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|PfaDat|</Fields>
    </DynSentence>
<!--XX37公务卡消费明细信息-->
    <DynSentence name="GetCrdTxn">
      <Sentence>
        select CardNo, CardNm, TxnDat, TLogNo, DtlAmt, MerNam, HActDt, IdxNo
          from pfacrdtxn
         where PfaSub='%s' and SndFlg='0' and ThdCod in ( '2010','2011','2020','2030','2210','2212','4240','4242' ) and BCusId!=''
      </Sentence>
      <Fields>PfaSub|</Fields>
    </DynSentence>
    <DynSentence name="UpdPfaCrdTxn">
      <Sentence>
        update pfacrdtxn set SndFlg='1' where PfaSub='%s' and SndFlg='0' and ThdCod in ( '2010','2011','2020','2030','2210','2212','4240','4242' ) and BCusId!=''
      </Sentence>
      <Fields>PfaSub|</Fields>
    </DynSentence>
<!--XX39公务卡消费明细回单信息-->
    <DynSentence name="GetPayDtl">
      <Sentence>
        select PfaIdx, AVchCd, DtlSts  from pfacrddtl where PfaSub='%s' and DtlSts in ('S','F') and RtnFlg='0'
      </Sentence>
      <Fields>PfaSub|</Fields>
    </DynSentence>
    <DynSentence name="UpdDtlRtnFlg">
      <Sentence>
        update pfacrddtl set RtnFlg='1' where PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s' and PfaIdx='%s'
      </Sentence>
      <Fields>PfaSub|PfaDat|AVchCd|PfaIdx|</Fields>
    </DynSentence>
    <DynSentence name="UpdRtnFlg">
      <Sentence>
        update pfasubcfg set RtnFlg='%s' where PfaSub='%s'
      </Sentence>
      <Fields>RtnFlg|PfaSub|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_NOEQUAL_STRING($ClrNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政【,$PfaSub,】清算网点)</Set>
        <Return/>
      </If>
      <If condition="IS_EQUAL_STRING($RtnFlg,1)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(财政【,$PfaSub,】当日回应已完成，不能重做)</Set>
        <Return/>
      </If>
      <Set>ClrTm=GETDATETIME(YYYYMMDDHHMISS)</Set>
      <Set>SndFil=STRCAT(30,$ClrTm,.dat)</Set>
      <Set>RtnFil=STRCAT(dat/pfa/send/,$SndFil)</Set>
<!--确定数据日期归属旬-->
      <Exec func="PUB:GetPrevWorkDate">
        <Arg name="Date" value="$PfaDat"/>
      </Exec>
      <Exec func="PUB:GetNextWorkDate">
        <Arg name="Date" value="$PfaDat"/>
      </Exec>
<!--
<Exec func="PUB:Unlock">
  <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
</Exec>
-->
<!--为避免同一分行并发-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Set>EndDat=$PfaDat</Set> <!--设定日期结束范围-->
<!--XX05财政授权支付凭证回单-->
      <Set>RptMsg=STRCAT(开始生成【XX05财政授权支付凭证回单】)</Set>
      <Set>BegDat=$PfaDat</Set>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetPfaVchDtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标【XX05】出错</Set>
        <Return/>
      </If>
      <Set>Num=0</Set>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <Set>Num=ADD($Num,1)</Set>
<!-- 这个域为财政最新要求 -->
        <If condition="IS_EQUAL_STRING($DtlSts,4)">  <!--未付退回-->
          <Set>PayFlg=1</Set>
        </If>
        <Else>
          <Set>PayFlg=0</Set>
        </Else>
<!--
        <Switch expression="$OIFlag">
          <Case value="O">
            <Set>PayFlg=0</Set>
            <Break/>
          </Case>
          <Case value="R"/>
          <Case value="I">
            <Set>PayFlg=-1</Set>
            <Break/>
          </Case>
        </Switch>
-->
        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$RtnFil"/>
          <Arg name="OpenMode" value="a+"/>
          <Arg name="Data"     value="3005,AgPayVchInfo,财政授权支付凭证回单,U"/> 
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$AVchCd"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$PyeNam"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$PyeAct"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$PyeBNm"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$VchNo"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="AMTSIMPLEFMT($DtlAmt)"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="AMTSIMPLEFMT($UseAmt)"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="FMTDATE($VchDat,0,4)"/>
          <Arg name="Data"     value=","/> 
          <Arg name="Data"     value="$ChkFlg"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$PayFlg"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$RefCod"/>
          <Arg name="Data"      value="\#"/>
          <Arg name="Data"      value="$AVchCd"/>
          <Arg name="ESCFMT"   value="\\n"/>
        </Exec>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <If condition="INTCMP($Num,4,0)">
        <Exec func="PUB:ExecSql" error="IGNORE">   <!--修改支付令为已回复-->
          <Arg name="sql" value="UpdPfaVchDtl"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=修改支付令登记表返回状态错</Set>
          <Return/>
        </If>
      </If>
<!--XX10 授权支出日报表信息-->
      <Set>RptMsg=STRCAT(开始生成【XX10授权支出日报表信息】)</Set>
      <Set>BegDat=$PfaDat</Set>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetPfaVchDtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标【XX10】出错</Set>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <If condition="IS_EQUAL_STRING($DtlSts,4)">  <!--退回-->
          <Continue/>
        </If>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCusInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>CodTyp=SUBCOD</Set>
        <Set>Code=$SubCod</Set>
        <Set>CodNam=SubNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>CodTyp=PRJCOD</Set>
        <Set>Code=$PrjCod</Set>
        <Set>CodNam=PrjNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$RtnFil"/>
          <Arg name="OpenMode" value="a+"/>
          <Arg name="Data"     value="3010,TransDayReport,授权支出日报表信息,I"/> 
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="FMTDATE($PfaDat,0,4)"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="30"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$PyeNam"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$PyeAct"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$PyeBNm"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$StlMod"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$VchNo"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$BCusId"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$DptCod"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$AmtTyp"/>
          <Arg name="Data"     value=","/>
<!--
          <Arg name="Data"     value="$TPayTp"/>
-->
          <Arg name="Data"     value="0002"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$SubCod"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$PrjCod"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$EConTp"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$DtlSmr"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="AMTSIMPLEFMT($UseAmt)"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$AVchCd"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="STRCAT(3,$PfaDat,$DtlIdx)"/>
          <Arg name="ESCFMT"   value="\\n"/>
        </Exec>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
<!--XX33总帐信息表-->
<!--判断是否为总帐信息表出表日-->
      <Set>RptMsg=STRCAT(开始生成【XX33总帐信息表】)</Set>
      <Set>RptFlg=0</Set>
      <Set>CurDat=SUBSTR($PfaDat,7,2)</Set>
      <Set>NxtDat=SUBSTR($NextDat,7,2)</Set>
      <If condition="OR(AND(INTCMP($CurDat,2,10),INTCMP($NxtDat,6,10)),AND(INTCMP($CurDat,2,20),INTCMP($NxtDat,6,20)),ISMONTHEND($PfaDat))">
        <Set>RptFlg=1</Set>
      </If>
      <If condition="IS_EQUAL_STRING($RptFlg,1)">
<!--获取日期取值范围-->
        <Switch expression="SUBSTR($PrevDat,7,1)">
          <Case value="0">
            <Set>Period=01</Set>
            <Set>BegDat=STRCAT(SUBSTR($PfaDat,1,6),01)</Set>
            <Break/>
          </Case>
          <Case value="1">
            <Set>Period=02</Set>
            <Set>BegDat=STRCAT(SUBSTR($PfaDat,1,6),11)</Set>
            <Break/>
          </Case>
          <Default>
            <Set>Period=03</Set>
            <Set>BegDat=STRCAT(SUBSTR($PfaDat,1,6),21)</Set>
            <Break/>
          </Default>
        </Switch>
<!--设定日期的范围：分别为旬、月、年-->
        <Set>SqlDate1=STRCAT( between ',$BegDat,' and ',$PfaDat,' )</Set>
        <Set>SqlDate2=STRCAT( between ',SUBSTR($PfaDat,1,6),01' and ',$PfaDat,' )</Set>
        <Set>SqlDate3=STRCAT( between ',SUBSTR($PfaDat,1,4),0101' and ',$PfaDat,' )</Set>
<!--查询系统有效额度，作为报表数据基础-->
        <Exec func="PUB:OpenCursor" error="IGNORE">
          <Arg name="sql" value="GetRptBasInf"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=打开游标【XX33】出错</Set>
          <Return/>
        </If>
        <Set>SeqNo=0</Set>
        <While>
          <Exec func="PUB:FetchCursor" error="IGNORE"/>
          <If condition="~RetCod=100">
            <Break/>
          </If>
<!--计算客户当前旬累计支出发生额-->
          <Delete>$OTotAmt</Delete>
          <Delete>$ITotAmt</Delete>
          <Delete>$SqlDate</Delete>
          <Set>SqlDate=$SqlDate1</Set>
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetOTotAmt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
<!--计算客户当前旬累计退回（收入）发生额-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetITotAmt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
<!--计算当前旬累计发生额-->
          <Set>TotAmt1=AMTSIMPLEFMT(SUB($OTotAmt,$ITotAmt))</Set>
<!--计算客户当前年累计支出发生额-->
          <Delete>$OTotAmt</Delete>
          <Delete>$ITotAmt</Delete>
          <Delete>$SqlDate</Delete>
          <Set>SqlDate=$SqlDate3</Set>
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetOTotAmt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
<!--计算客户当前年累计退回（收入）发生额-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetITotAmt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
<!--计算当前年累计发生额-->
          <Set>TotAmt3=AMTSIMPLEFMT(SUB($OTotAmt,$ITotAmt))</Set>
<!--写入旬报记录-->
          <Set>SeqNo=ADD($SeqNo,1)</Set>
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$RtnFil"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="Data"     value="3033,PUB_A_BALANCEINFO_BANK,总帐信息表,I"/> 
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="SUBSTR($PfaDat,1,4)"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="SUBSTR($PfaDat,5,2)"/>
            <Arg name="Data"     value="$Period"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="30"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$SubCod"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$PrjCod"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$BCusId"/>
            <Arg name="Data"     value=","/>
<!--
            <Arg name="Data"     value="$TPayTp"/>
-->
            <Arg name="Data"     value="0002"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$DptCod"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$TotAmt1"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$TotAmt3"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="STRCAT(3,$PfaDat,ADDCHAR($SeqNo,6,0,1))"/>
            <Arg name="ESCFMT"   value="\\n"/>
          </Exec>
          <If condition="IS_NOEQUAL_STRING(SUBSTR($PfaDat,1,6),SUBSTR($NextDat,1,6))">
<!--计算当前月累计发生额-->
            <Delete>$OTotAmt</Delete>
            <Delete>$ITotAmt</Delete>
            <Delete>$SqlDate</Delete>
            <Set>SqlDate=$SqlDate2</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="GetOTotAmt"/>
            </Exec>
            <If condition="~RetCod!=0">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
<!--计算客户当前月累计退回（收入）发生额-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="GetITotAmt"/>
            </Exec>
            <If condition="~RetCod!=0">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
<!--计算当前月累计发生额-->
            <Set>TotAmt2=AMTSIMPLEFMT(SUB($OTotAmt,$ITotAmt))</Set>
<!--写入月报记录-->
            <Set>SeqNo=ADD($SeqNo,1)</Set>
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$RtnFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"     value="3033,PUB_A_BALANCEINFO_BANK,总帐信息表,I"/> 
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="SUBSTR($PfaDat,1,4)"/>
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="SUBSTR($PfaDat,5,2)"/>
              <Arg name="Data"     value="00"/>
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="30"/>
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="$SubCod"/>
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="$PrjCod"/>
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="$BCusId"/>
              <Arg name="Data"     value=","/>
<!--
              <Arg name="Data"     value="$TPayTp"/>
-->
              <Arg name="Data"     value="0002"/>
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="$DptCod"/>
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="$TotAmt2"/>
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="$TotAmt3"/>
              <Arg name="Data"     value=","/>
              <Arg name="Data"     value="STRCAT(3,$PfaDat,ADDCHAR($SeqNo,6,0,1))"/>
              <Arg name="ESCFMT"   value="\\n"/>
            </Exec>
          </If>
        </While>
        <Exec func="PUB:CloseCursor" error="IGNORE"/>
      </If>
<!--XX34 明细支出情况表-->
      <If condition="IS_NOEQUAL_STRING(SUBSTR($PfaDat,1,6),SUBSTR($NextDat,1,6))">
        <Set>BegDat=STRCAT(SUBSTR($PfaDat,1,6),01)</Set>
        <Set>RptMsg=STRCAT(开始生成【XX34明细支出情况表】)</Set>
        <Exec func="PUB:OpenCursor" error="IGNORE">
          <Arg name="sql" value="GetPfaVchDtl"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=打开游标【XX34】出错</Set>
          <Return/>
        </If>
        <While>
          <Exec func="PUB:FetchCursor" error="IGNORE"/>
          <If condition="~RetCod=100">
            <Break/>
          </If>
          <If condition="IS_EQUAL_STRING($DtlSts,4)">  <!--退回-->
            <Continue/>
          </If>
          <Set>SeqNo=ADD($SeqNo,1)</Set>
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$RtnFil"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="Data"     value="3034,PUB_A_DETAILINFO_BANK,明细支出情况表,I"/> 
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="FMTDATE($PfaDat,0,4)"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="30"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$SubCod"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$PrjCod"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$BCusId"/>
            <Arg name="Data"     value=","/>
<!--
            <Arg name="Data"     value="$TPayTp"/>
-->
            <Arg name="Data"     value="0002"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$DptCod"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="AMTSIMPLEFMT($UseAmt)"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="STRCAT(3,$PfaDat,$DtlIdx)"/>
            <Arg name="ESCFMT"   value="\\n"/>
          </Exec>    
        </While>
        <Exec func="PUB:CloseCursor" error="IGNORE"/>
      </If>
<!--XX36用款计划额度表-->
      <If condition="IS_NOEQUAL_STRING(SUBSTR($PfaDat,1,6),SUBSTR($NextDat,1,6))">
        <Set>BegDat=STRCAT(SUBSTR($PfaDat,1,6),01)</Set>
        <Set>RptMsg=开始生成【XX36用款计划额度表】)</Set>
        <Exec func="PUB:OpenCursor" error="IGNORE">
          <Arg name="sql" value="GetMonQuoDtl"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=打开游标出错</Set>
          <Return/>
        </If>
        <While>
          <Exec func="PUB:FetchCursor" error="IGNORE"/>
          <If condition="~RetCod=100">
            <Break/>
          </If>
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$RtnFil"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="Data"     value="3036,PUB_A_LIMIT_BANK,用款计划额度表,I"/> 
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="SUBSTR($PfaDat,1,4)"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$Mon"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$TSeqNo"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="30"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$SubCod"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$PrjCod"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$BCusId"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="$DptCod"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="AMTSIMPLEFMT($QuoAmt)"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="STRCAT(3,$PfaDat,$BokIdx)"/>
            <Arg name="Data"     value=","/>
            <Arg name="Data"     value="FMTDATE($RegDat,0,4)"/>
            <Arg name="ESCFMT"   value="\\n"/>
          </Exec>
        </While>
        <Exec func="PUB:CloseCursor" error="IGNORE"/>
      </If>
<!--XX37公务卡消费明细-->
      <Set>RptMsg=STRCAT(开始生成【XX37公务卡消费明细表】)</Set>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetCrdTxn"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标【XX37】出错</Set>
        <Return/>
      </If>
      <Set>Num=0</Set>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <Set>Num=ADD($Num,1)</Set>
        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$RtnFil"/>
          <Arg name="OpenMode" value="a+"/>
          <Arg name="Data"     value="3037,creditcarddetailinfo,公务卡消费明细信息,I"/> 
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="STRCAT(3,$HActDt,$IdxNo)"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$TLogNo"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$CardNm"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$CardNo"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="FMTDATE($TxnDat,0,4)"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="AMTSIMPLEFMT($DtlAmt)"/>
          <Arg name="Data"     value=",,"/>
          <Arg name="Data"     value="$MerNam"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="30"/>
          <Arg name="ESCFMT"   value="\\n"/>
        </Exec>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <If condition="INTCMP($Num,4,0)">
        <Exec func="PUB:ExecSql" error="IGNORE">   <!--修改消费明细为已回复-->
          <Arg name="sql" value="UpdPfaCrdTxn"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=修改消费明细表返回状态错</Set>
          <Return/>
        </If>
      </If>
<!--XX39公务卡消费明细回单信息-->
      <Set>RptMsg=STRCAT(开始生成【XX39公务卡消费明细回单信息】)</Set>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetPayDtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标【XX39】出错</Set>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <If condition="IS_EQUAL_STRING($DtlSts,S)">
          <Set>Flag=2</Set>
        </If>
        <Else>
          <Set>Flag=-1</Set>
        </Else>
        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$RtnFil"/>
          <Arg name="OpenMode" value="a+"/>
          <Arg name="Data"     value="3039,creditcardpayinfo,公务卡消费明细回单信息,I"/> 
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$PfaIdx"/>
          <Arg name="Data"     value=","/>
          <Arg name="Data"     value="$AVchCd"/>
          <Arg name="Data"     value=",30,"/>
          <Arg name="Data"     value="$Flag"/>
          <Arg name="ESCFMT"   value="\\n"/>
        </Exec>
        <Exec func="PUB:ExecSql">
          <Args>
            <Arg name="SqlCmd" value="UpdDtlRtnFlg"/>
          </Args>
        </Exec>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
<!--判断返回文件是否存在-->
      <Exec func="PUB:IsExistFile" error="IGNORE">
        <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/,$RtnFil)"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,0)">
        <Set>IcsFil=$SndFil</Set>
        <Set>msglen=00000020</Set>
        <Exec func="PUB:FtpPut">
          <Arg name="FtpId" value="PFA002"/>
        </Exec>
        <Set>RtnFlg=1</Set>
        <Exec func="PUB:ExecSql">
          <Args>
            <Arg name="SqlCmd" value="UpdRtnFlg"/>
          </Args>
        </Exec>
        <Exec func="PUB:CommitWork"/>
        <Exec func="PUB:CallThirdOther" error="IGNORE">
          <Arg name="TTxnCd" value="461078" desc=" "/>
          <Arg name="ObjSvr" value="STHDPFA1" desc=" "/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=发送文件到财政系统失败</Set>
          <Return/>
        </If>
      </If>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461082" desc="申请财政资金清单打印">
    <Quote name="PfaSqlLst"/>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_NOEQUAL_STRING($ClrNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政【,$PfaSub,】清算网点)</Set>
        <Return/>
      </If>
      <Switch expression="$OIFlag">
        <Case value="O">
          <Set>OIMsg=支出</Set>
          <Break/>
        </Case>
        <Case value="I">
          <Set>OIMsg=收款</Set>
          <Break/>
        </Case>
        <Case value="R">
          <Set>OIMsg=退回</Set>
          <Break/>
        </Case>
      </Switch>
      <Switch expression="$PrtDtl">
        <Case value="1"> <!-- 申请财政资金明细清单 -->
          <Set>RptNam=STRCAT(申请财政资金【,$OIMsg,】明细清单)</Set>
          <Set>FilNam=STRCAT(PFA009_,$OIFlag,_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PFA009_RPT.XML)</Set>
          <Set>Summary=申请财政资金明细清单</Set>
          <Break/>
        </Case>
        <Case value="2"> <!-- 申请财政资金汇总清单 -->
          <Set>RptNam=STRCAT(申请财政资金【,$OIMsg,】汇总清单)</Set>
          <Set>FilNam=STRCAT(PFA010_,$OIFlag,_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PFA010_RPT.XML)</Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="ObjFil" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="RptNam" value="$RptNam"/>
        <Arg name="PfaSub" value="$PfaSub"/>
        <Arg name="OIFlag" value="$OIFlag"/>
        <Arg name="ClrDat" value="$ClrDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="3"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461083" desc="人行清算文件生成">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="GetOutAmt">
      <Sentence>
        select sum(bigint(TxnAmt)) OutAmt from pfaclrrec
         where PfaSub='%s' and ClrTyp='0' and ClrBNo='%s' and OIFlag='O' and ClrSts='2' and ClrDat='%s'
      </Sentence>
      <Fields>PfaSub|ClrBNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="GetOutVchBokDtl">
      <Sentence>
        select BCusId, FCusId, SubCod, EConTp, UseAmt from %s
         where PfaSub='%s' and ClrBNo='%s' and ClrDat='%s' and OIFlag ='O' and ClrSts='2'  
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|ClrBNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="GetInAmt">
      <Sentence>
        select sum(bigint(TxnAmt)) InAmt from pfaclrrec
         where PfaSub='%s' and ClrTyp='0' and ClrBNo='%s' and OIFlag in ( 'R','I' ) and ClrSts='2' and ClrDat='%s'
      </Sentence>
      <Fields>PfaSub|ClrBNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="GetInVchBokDtl">
      <Sentence>
        select BCusId, FCusId, SubCod, EConTp, UseAmt from %s
         where PfaSub='%s' and ClrBNo='%s' and ClrDat='%s' and OIFlag in ( 'I','R' ) and ClrSts='2'  
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|ClrBNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="UpdRtnSeq">
      <Sentence>
        update PfaSubCfg set RtnSeq=char(bigint(RtnSeq)+1) where PfaSub='%s'
      </Sentence>
      <Fields>PfaSub|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_NOEQUAL_STRING($ClrNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政【,$PfaSub,】清算网点)</Set>
        <Return/>
      </If>
<!--为避免同一分行并发-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Set>RtnSeq=ADDCHAR($RtnSeq,4,0,1)</Set>
      <Switch expression="$OIFlag">
        <Case value="O"> <!-- 支出 -->
          <Set>ClrFil=STRCAT($RptDir,$ClrDat,$RtnSeq,270.txt)</Set>
          <Set>SndFil=STRCAT($ClrDat,$RtnSeq,270.txt)</Set>
<!--统计支出-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetOutAmt"/>
            </Args>
          </Exec>
          <If condition="~RetCod!=0">
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(汇总支出金额失败或批次【,$ClrBNo,】不存在)</Set>
            <Return/>
          </If>
          <If condition="INTCMP($OutAmt,4,0)">
<!--文件头-->
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$ClrFil"/>
              <Arg name="OpenMode" value="w"/>
              <Arg name="Data"   value="**1900000000"/>   <!--国库代码-->
              <Arg name="Data"   value=",,"/>             <!--付款人全称,一般为财政部门代码,可为空-->
              <Arg name="Data"   value="$RcvAct"/>        <!--付款人账号-->
              <Arg name="Data"   value=",,"/>             <!--付款人开户行,国库所在银行代码,可为空-->  
              <Arg name="Data"   value=","/>              <!--付款人开户行行号,国库所在银行行号,可为空-->  
              <Arg name="Data"   value="666666666666,"/>  <!--收款人全称,执行支付银行代码--> 
              <Arg name="Data"   value=","/>              <!--收款人账号,执行支付银行收款账号,可为空-->
              <Arg name="Data"   value=","/>              <!--收款人开户行,国库所在银行行号,可为空-->
              <Arg name="Data"   value=","/>              <!--收款人开户行行号,代理银行行号,可为空-->
              <Arg name="Data"   value="1"/>              <!--预算种类代码-->
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="AMTSIMPLEFMT($OutAmt)"/>
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="0"/>
              <Arg name="Data"   value=",27,"/>              <!--摘要代码,可为空-->
              <Arg name="Data"   value="SUBSTR($ClrBNo,3,8)"/>  <!--??汇总凭证编号,不为空,凭证编码不能大于8位-->
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="$ClrDat"/>        <!--本凭证编制日期,可为空-->
              <Arg name="ESCFMT" value="\\n"/>
            </Exec>
<!--文件体-->
            <Set>OIFlag=O</Set>
            <Exec func="PUB:OpenCursor" error="IGNORE">
              <Arg name="sql" value="GetOutVchBokDtl"/>          
            </Exec>
            <If condition="~RetCod!=0">
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=打开游标出错</Set>
              <Return/>
            </If>
            <While>
              <Exec func="PUB:FetchCursor" error="IGNORE"/>
              <If condition="~RetCod=100">
                <Break/>
              </If>
              <Exec func="PUB:WriteFile" error="IGNORE">
                <Arg name="FileName" value="$ClrFil"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="$FCusId"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="SUBSTR($SubCod,4,17)"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="$EConTp"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="1"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="AMTSIMPLEFMT($UseAmt)"/>
                <Arg name="ESCFMT" value="\\n"/>
              </Exec>
            </While>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
          </If>
          <Break/>
        </Case>
        <Case value="R"/>
        <Case value="I">
          <Set>ClrFil=STRCAT($RptDir,$ClrDat,$RtnSeq,280.txt)</Set>
          <Set>SndFil=STRCAT($ClrDat,$RtnSeq,280.txt)</Set>
<!--统计退回-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetInAmt"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(汇总退回金额失败或批次【,$ClrBNo,】不存在)</Set>
            <Return/>
          </If>
          <If condition="INTCMP($InAmt,4,0)">
<!--文件头-->
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$ClrFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="**1900000000"/>   <!--国库代码-->
              <Arg name="Data"   value=",,"/>             <!--付款人全称,一般为财政部门代码,可为空-->
              <Arg name="Data"   value="$RcvAct"/>        <!--付款人账号-->
              <Arg name="Data"   value=",,"/>             <!--付款人开户行,国库所在银行代码,可为空-->  
              <Arg name="Data"   value=","/>              <!--付款人开户行行号,国库所在银行行号,可为空-->  
              <Arg name="Data"   value="666666666666,"/>  <!--收款人全称,执行支付银行代码--> 
              <Arg name="Data"   value=","/>              <!--收款人账号,执行支付银行收款账号,可为空-->
              <Arg name="Data"   value=","/>              <!--收款人开户行,国库所在银行行号,可为空-->
              <Arg name="Data"   value=","/>              <!--收款人开户行行号,代理银行行号,可为空-->
              <Arg name="Data"   value="1"/>              <!--预算种类代码-->
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="AMTSIMPLEFMT($InAmt)"/>
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="0"/>
              <Arg name="Data"   value=",28,"/>              <!--摘要代码,可为空-->
              <Arg name="Data"   value="SUBSTR($ClrBNo,3,8)"/>  <!--??汇总凭证编号,不为空,凭证编码不能大于8位-->
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="$ClrDat"/>        <!--本凭证编制日期,可为空-->
              <Arg name="ESCFMT" value="\\n"/>
            </Exec>
<!--文件体-->
            <Exec func="PUB:OpenCursor" error="IGNORE">
              <Arg name="sql" value="GetInVchBokDtl"/>
            </Exec>
            <If condition="~RetCod!=0">
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=打开游标出错</Set>
              <Return/>
            </If>
            <While>
              <Exec func="PUB:FetchCursor" error="IGNORE"/>
              <If condition="~RetCod=100">
                <Break/>
              </If>
              <Exec func="PUB:WriteFile" error="IGNORE">
                <Arg name="FileName" value="$ClrFil"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="$FCusId"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="SUBSTR($SubCod,4,17)"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="$EConTp"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="1"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="AMTSIMPLEFMT($UseAmt)"/>
                <Arg name="ESCFMT" value="\\n"/>
              </Exec>
            </While>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
          </If>
          <Break/>
        </Case>
      </Switch>
<!--更新返回次数-->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="sql" value="UpdRtnSeq"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=更新文件当日返回序号失败</Set>
        <Return/>
      </If>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Exec func="PUB:IsExistFile" error="IGNORE">
        <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/,$ClrFil)"/>
      </Exec>
      <If condition="~RetCod=0">
        <Exec func="PUB:SendFileMessage2">
          <Arg name="MsgTyp"  value="3"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="46"/>
          <Arg name="AplCod"  value="$TxnCod"/>
          <Arg name="FilNam" value="$SndFil"/>
          <Arg name="Summary" value="清算文件生成"/>
          <Arg name="ObjTlr"  value="$TlrId"/> 
        </Exec>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461088" desc="财政清算文件生成">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="GetDtlInf">
      <Sentence>
        select distinct BCusId, SubCod, PrjCod, DptCod
          from %s
         where PfaSub='%s' and QuoSts in ('1','2') and Year=substr('%s',1,4)
      order by BCusId, SubCod, PrjCod, DptCod
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|BegDat|</Fields>
    </DynSentence>
    <DynSentence name="SumOVchBok">
      <Sentence>
        select value(sum(bigint(UseAmt)),0) OuAmt, count(*) OuNum from %s
         where PfaSub='%s' and ( PfaDat %s ) and ClrSts='3' 
           and BCusId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s' and OIFlag='O' and DtlSts='2'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|SqlDate|BCusId|SubCod|PrjCod|DptCod|</Fields>
    </DynSentence>
    <DynSentence name="SumIVchBok">
      <Sentence>
        select (-1)*value(sum(bigint(UseAmt)),0) InAmt, count(*) InNum from %s
         where PfaSub='%s' and ( PfaDat %s ) and ClrSts='3' and DtlSts='2'
           and BCusId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s' and OIFlag in ('R','I')
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|SqlDate|BCusId|SubCod|PrjCod|DptCod|</Fields>
    </DynSentence>
    <DynSentence name="SumOTotBok">
      <Sentence>
        select value(sum(bigint(UseAmt)),0) OuAmt, count(*) OuNum from %s
         where PfaSub='%s' and ( PfaDat %s ) and ClrSts='3' and OIFlag='O' and DtlSts='2'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|SqlDate|</Fields>
    </DynSentence>
    <DynSentence name="SumITotBok">
      <Sentence>
        select (-1)*value(sum(bigint(UseAmt)),0) InAmt, count(*) InNum from %s
         where PfaSub='%s' and ( PfaDat %s ) and ClrSts='3' and OIFlag in ('R','I') and DtlSts='2'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|SqlDate|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_NOEQUAL_STRING($ClrNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政【,$PfaSub,】清算网点)</Set>
        <Return/>
      </If>
<!--为避免同一分行并发-->
<!--
<Exec func="PUB:Unlock">
  <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
</Exec>
-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
<!--遍历临时表获取详细明细记录-->
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetDtlInf"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Return/>
      </If>
<!--生成报表-->
      <Set>SndFil=STRCAT(PFA,$PfaSub,$TlrId,_,$RptTyp,.txt)</Set>
      <Set>RtnFil=STRCAT($RptDir,$SndFil)</Set>
<!--生成报表头-->
      <Switch expression="$RptTyp">
        <Case value="1"> <!-- 日报 -->
          <Set>RptNam=省级财政授权支付支出日报表</Set>
          <Set>RptDat=STRCAT(SUBSTR($BegDat,1,4),年,SUBSTR($BegDat,5,2),月,SUBSTR($BegDat,7,8),日)</Set>
          <Set>Line1=序|预算|单位|预算|科目|预算|项目|业务|处室|本|日支|出</Set>
          <Set>Line2=号|编码|名称|编码|名称|编码|名称|编码|名称|支出金额|退票金额|总支出额</Set>
          <Set>Line3= </Set>
          <Break/>
        </Case>
        <Case value="2"> <!-- 旬报 -->
          <Set>RptNam=省级财政授权支付支出旬报表</Set>
          <Set>RptDat=STRCAT(SUBSTR($BegDat,1,4),年,SUBSTR($BegDat,5,2),月,SUBSTR($BegDat,7,8),日至,SUBSTR($EndDat,7,8))</Set>
          <Set>Line1=序|基层预|算单位|预算|科目|预算|项目|业务|处室|本旬累计|本月累计</Set>
          <Set>Line2=号|编码|名称|编码|名称|编码|名称|编码|名称</Set>
          <Set>Line3= </Set>
          <Break/>
        </Case>
        <Case value="3"> <!-- 月报 -->
          <Set>RptNam=省级财政授权支付支出月报表</Set>
          <Set>RptDat=STRCAT(SUBSTR($BegDat,1,4),年,SUBSTR($BegDat,5,2),月)</Set>
          <Set>Line1=序|基层预|算单位|预算|科目|预算|项目|业务|处室|本月累计|本年累计</Set>
          <Set>Line2=号|编码|名称|编码|名称|编码|名称|编码|名称</Set>
          <Set>Line3= </Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$RtnFil"/>
        <Arg name="OpenMode" value="w"/>
        <Arg name="Data"     value="|||||"/>
        <Arg name="Data"     value="$RptNam"/>
        <Arg name="Data"     value="||||||"/>
        <Arg name="ESCFMT"   value="\\n"/>
        <Arg name="Data"     value="|||||"/>
        <Arg name="Data"     value="$RptDat"/>
        <Arg name="Data"     value="||||||"/>
        <Arg name="ESCFMT"   value="\\n"/>
        <Arg name="Data"     value="$Line1"/>
        <Arg name="ESCFMT"   value="\\n"/>
        <Arg name="Data"     value="$Line2"/>
        <Arg name="ESCFMT"   value="\\n"/>
        <Arg name="Data"     value="$Line3"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec>
<!--生成报表内容-->
<!--从临时表取数据-->
      <Set>SeqNo=0</Set>
      <Set>InitFg=0</Set>
      <Set>TotOuAmt=0</Set>
      <Set>TotInAmt=0</Set>
      <Set>TotAmt=0</Set>
      <Set>DatSql=STRCAT( between ',$BegDat,' and ',$EndDat,' )</Set>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
<!--写入数据内容-->
        <Set>RptFlg=0</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCusInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>CodTyp=SUBCOD</Set>
        <Set>Code=$SubCod</Set>
        <Set>CodNam=SubNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
<!--
        <Set>CodTyp=ECONTP</Set>
        <Set>Code=$EConTp</Set>
        <Set>CodNam=EConNm</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
-->
        <Set>CodTyp=PRJCOD</Set>
        <Set>Code=$PrjCod</Set>
        <Set>CodNam=PrjNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>CodTyp=DPTCOD</Set>
        <Set>Code=$DptCod</Set>
        <Set>CodNam=DptNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
<!--统计发生期间数据-->
        <Set>SqlDate=$DatSql</Set>
<!--统计汇总记录-->
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumOVchBok"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumIVchBok"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>TotOuAmt=ADD($TotOuAmt,$OuAmt)</Set>
        <Set>TotInAmt=ADD($TotInAmt,$InAmt)</Set>
        <Set>TotOuNum=ADD($TotOuNum,$OuNum)</Set>
        <Set>TotInNum=ADD($TotInNum,$InNum)</Set>
        <Switch expression="$RptTyp">
          <Case value="1"> <!-- 日报 -->
            <Set>DayAmt=ADD($OuAmt,$InAmt)</Set>
            <Set>AmtData=STRCAT(AMTFMT($OuAmt),|,AMTFMT($InAmt),|,AMTFMT($DayAmt))</Set>
            <If condition="AND(INTCMP($OuAmt,3,0),INTCMP($InAmt,3,0))">
              <Set>RptFlg=1</Set>
            </If>
            <Break/>
          </Case>
          <Case value="2"> <!-- 旬报 -->
            <Set>XunAmt=ADD($OuAmt,$InAmt)</Set>
            <Set>XunSql=STRCAT( between ',STRCAT(SUBSTR($BegDat,1,6),01),' and ',$EndDat,' )</Set>
            <Set>SqlDate=$XunSql</Set>
<!--计算对应的月发生额-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="SumOVchBok"/>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="SumIVchBok"/>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <Set>MonAmt=ADD($OuAmt,$InAmt)</Set>
            <Set>AmtData=STRCAT(AMTFMT($XunAmt),|,AMTFMT($MonAmt))</Set>
            <If condition="AND(INTCMP($XunAmt,3,0),INTCMP($MonAmt,3,0))">
              <Set>RptFlg=1</Set>
            </If>
            <Break/>
          </Case>
          <Case value="3"> <!-- 月报 -->
            <Set>MonAmt=ADD($OuAmt,$InAmt)</Set>
            <Set>MonSql=STRCAT( between ',STRCAT(SUBSTR($BegDat,1,4),0101),' and ',$EndDat,' )</Set>
            <Set>SqlDate=$MonSql</Set>
<!--计算对应的年发生额-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="SumOVchBok"/>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="SumIVchBok"/>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <Set>YearAmt=ADD($OuAmt,$InAmt)</Set>
            <Set>AmtData=STRCAT(AMTFMT($MonAmt),|,AMTFMT($YearAmt))</Set>
            <If condition="AND(INTCMP($MonAmt,3,0),INTCMP($YearAmt,3,0))">
              <Set>RptFlg=1</Set>
            </If>
            <Break/>
          </Case>
        </Switch>
        <If condition="INTCMP($RptFlg,3,0)">
          <Set>SeqNo=ADD($SeqNo,1)</Set>
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$RtnFil"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="Data"   value="$SeqNo"/> 
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="$BCusId"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="$BCusNm"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="$SubCod"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="$SubNam"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="$PrjCod"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="$PrjNam"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="$DptCod"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="$DptNam"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="$AmtData"/>
            <Arg name="Data"   value="|"/>
            <Arg name="ESCFMT" value="\\n"/>
          </Exec>
        </If>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
<!--计算报表范围内发生总笔数一-->
      <Switch expression="$RptTyp">
        <Case value="1"> <!-- 日报 -->
          <Set>SqlDate=STRCAT( between ',STRCAT(SUBSTR($BegDat,1,6),01),' and ',$EndDat,' )</Set>
          <Break/>
        </Case>
        <Case value="2"> <!-- 旬报 -->
          <Set>TotXunAmt=ADD($TotOuAmt,$TotInAmt)</Set>
          <Set>XunSql=STRCAT( between ',STRCAT(SUBSTR($BegDat,1,6),01),' and ',$EndDat,' )</Set>
          <Set>SqlDate=$XunSql</Set>
          <Break/>
        </Case>
        <Case value="2"> <!-- 月报 -->
          <Set>TotMonAmt=ADD($TotOuAmt,$TotInAmt)</Set>
          <Set>MonSql=STRCAT( between ',STRCAT(SUBSTR($BegDat,1,4),0101),' and ',$EndDat,' )</Set>
          <Set>SqlDate=$MonSql</Set>
          <Break/>
        </Case>
      </Switch>
<!--统计汇总记录-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="SumOTotBok"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Exec func="PUB:CloseCursor" error="IGNORE"/>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="SumITotBok"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Exec func="PUB:CloseCursor" error="IGNORE"/>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <Switch expression="$RptTyp">
        <Case value="1"> <!-- 日报 -->
          <Set>CntData=STRCAT(本日累计支出笔数,$TotOuNum,|本日累计退回笔数,$TotInNum,|本月累计发生笔数,ADD($OuNum,$InNum))</Set>
          <Set>SumData=STRCAT(AMTFMT($TotOuAmt),|,AMTFMT($TotInAmt),|,AMTFMT(ADD($TotOuAmt,$TotInAmt)))</Set>
          <Break/>
        </Case>
        <Case value="2"> <!-- 旬报 -->
          <Set>CntData=STRCAT(本旬累计笔数,|,ADD($TotOuNum,$TotInNum),|,本月累计,|,ADD($OuNum,$InNum))</Set>
          <Set>SumData=STRCAT(AMTFMT(ADD($TotOuAmt,$TotInAmt)),|,AMTFMT(ADD($OuAmt,$InAmt)))</Set>
          <Break/>
        </Case>
        <Case value="3"> <!-- 月报 -->
          <Set>CntData=STRCAT(本月累计笔数,|,ADD($TotOuNum,$TotInNum),|,本年累计,|,ADD($OuNum,$InNum))</Set>
          <Set>SumData=STRCAT(AMTFMT(ADD($TotOuAmt,$TotInAmt)),|,AMTFMT(ADD($OuAmt,$InAmt)))</Set>
          <Break/>
        </Case>
      </Switch>
<!--写入表尾统计数-->
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$RtnFil"/>
        <Arg name="OpenMode" value="a+"/>
        <Arg name="Data"     value="合|计|||"/>
        <Arg name="Data"     value="$CntData"/>
        <Arg name="Data"     value="||"/>
        <Arg name="Data"     value="$SumData"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec>
<!--发送报表数据文件到前台-->
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="3"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$SndFil"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>
<!--公务卡交易-->
<!--公务卡交易-->
<!--公务卡交易-->
<!--公务卡交易-->
<!--公务卡交易-->
  <Transaction code="461171" desc="公务卡资料维护">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="MultiQuery">
      <Sentence>
        select CardNo, CardNm, CrpNam from pfacrdinf where PfaSub='%s' and ( CardNo='%s' or '%s'='' ) and CollDt='%s' order by bcusid
      </Sentence>
      <Fields>PfaSub|CardNo|CardNo|CollDt|</Fields>
    </DynSentence>
    <DynSentence name="GetCrdInf"><!--取卡资料-->
      <Sentence>
        select CollDt,LmtAmt,CrdSts,IdType,IdNo,CardNm,GendCd,BthPlc,CrpNam,DptNam,DutyCd,MobTel,Email,CrpTel,Addr,
               HisBr,EffDat,IvdDat,SellId,BCusId OBCusId,BrNo
          from pfacrdinf where PfaSub='%s' and CardNo='%s'
      </Sentence>
      <Fields>PfaSub|CardNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdCrdInf"> <!--修改-->
      <Sentence>
        PfaSub='%s' and CardNo='%s'
      </Sentence>
      <Fields>PfaSub|CardNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdCrdTxn"> <!--修改明细-->
      <Sentence>
        Update PfaCrdTxn set BCusid='%s' where PfaSub='%s' and CardNo='%s' and TxnDat>='%s'
      </Sentence>
      <Fields>BCusId|PfaSub|CardNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <Switch expression="$FUNC">
        <Case value="1"> <!-- 列表 -->
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2"> <!-- 单笔 -->
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="GetCrdInf"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Case value="3"> <!-- 修改 -->
          <Quote name="ChkSubCfg"/>
          <If condition="IS_NOEQUAL_STRING($NodNo,$ClrNod)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=部门无此权限</Set>
            <Return/>
          </If>
          <Exec func="PUB:AddAuthReason">
            <Arg name="AthCod" value="20"/>
            <Arg name="AthMsg" value="PFA000"/>
          </Exec>
          <Exec func="PUB:CheckLocalAuth">
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="pfacrdinf"/>
            <Arg name="CndSts" value="UpdCrdInf"/>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <If condition="INTCMP($Func,3,3)">
        <Set>NoteInfo=STRCAT(公务卡资料维护:财政代码[,$PfaSub,]卡号[,$CardNo,]原单位代码[,$OBCusId,]现单位代码[,$BCusId,]网点[,$NodNo,]柜员[,$TlrId,])</Set>
        <Exec func="PUB:CallHostOther">
          <Arg name="HTxnCd" value="455130"/>
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461173" desc="公务卡还款报表打印">
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Set>FmtFil=STRCAT(etc/,PFA008_RPT.XML)</Set>
      <Set>RptFil=STRCAT(PFA008,$TlrId,.RPT)</Set>
      <Set>RptNam=公务卡还款明细清单</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$RptFil)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="PfaSub"  value="$PfaSub"/>
        <Arg name="Year"    value="$Year"/>
        <Arg name="AVchCd"  value="$AVchCd"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$RptFil"/>
        <Arg name="Summary" value="公务卡还款报表打印"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461174" desc="公务卡还款查询">
    <DynSentence name="MultiQuery">
      <Sentence>
        select TxnSts, CardNo, CardNm, TotAmt, TxnAmt, ActDat, AVchCd from pfacrdjnl
         where PfaSub='%s' and Year='%s' and BCusId='%s'
           and ( AVchCd='%s' or '%s'='' ) and ( CardNo='%s' or '%s'='' )
           and ActDat between '%s' and '%s'
      </Sentence>
      <Fields>PfaSub|Year|BCusId|AVchCd|AVchCd|CardNo|CardNo|BegDat|EndDat|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:MultiQuery"/>
    </FlowCtrl>
  </Transaction>
<!--定时返回交易-->
<!--定时返回交易-->
<!--定时返回交易-->
<!--定时返回交易-->
<!--定时返回交易-->
  <Transaction code="461190" desc="财政对账数据定时发送">
    <Quote name="PfaSqlLst"/>
<!--XX06财政授权支付到账通知书-->
    <DynSentence name="GetPfaQuoBok">
      <Sentence>
        select Year, Mon, ActNo, BCusId, SubCod, EConTp, PrjCod, QuoSmr, TSeqNo,
          case when TxnFlg='0' then bigint(QuoAmt) when TxnFlg='1' then (-1)*bigint(QuoAmt) end QuoAmt
          from %s
         where PfaSub='%s' and Year=substr('%s',1,4) and QuoSts in ('1','2') and RtnFlg='0'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="UpdPfaQuoBok">
      <Sentence>
        update %s set RtnFlg='1'
         where PfaSub='%s' and Year=substr('%s',1,4) and QuoSts in ('1','2') and RtnFlg='0'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|ActDat|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Set>PfaSub=001</Set>
      <Quote name="ChkSubCfg"/>
      <Set>BrNo=$AgtBr</Set>
<!--为避免同一分行并发-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Set>QuoBokTbl=STRCAT(pfaquobok,$PfaSub)</Set>
<!--XX06财政授权支付到账通知书-->
      <Set>RptMsg=STRCAT(开始生成【XX06财政授权支付到账通知书】)</Set>
      <Set>ClrTm=GETDATETIME(YYYYMMDDHHMISS)</Set>
      <Set>SndFil=STRCAT(30,$ClrTm,.dat)</Set>
      <Set>RtnFil=STRCAT(dat/pfa/send/,$SndFil)</Set>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetPfaQuoBok"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标【XX06】出错</Set>
        <Return/>
      </If>
      <While>  
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCusInf"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Set>CodTyp=SUBCOD</Set>
        <Set>Code=$SubCod</Set>
        <Set>CodNam=SubNam</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCodInf"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$RtnFil"/>
          <Arg name="OpenMode" value="a+"/>
          <Arg name="Data"   value="3006,AgPayEntNoticeInfo,财政授权支付到账通知书,I"/> 
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$Year"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$Mon"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$ActNo"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$BCusId"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$BCusNm"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$FCusId"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$FCusNm"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$SubCod"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$SubNam"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$EConTp"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$PrjCod"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="AMTSIMPLEFMT($QuoAmt)"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$QuoSmr"/>
          <Arg name="Data"   value=","/>
          <Arg name="Data"   value="$TSeqNo"/>
          <Arg name="ESCFMT"   value="\\n"/>
        </Exec>  
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Exec func="PUB:ExecSql" error="IGNORE">   <!--修改额度令登记表为已回复-->
        <Arg name="sql" value="UpdPfaQuoBok"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库处理失败</Set>
        <Return/>
      </If>
      <Exec func="PUB:IsValidFile" error="IGNORE">
        <Arg name="FileName" value="$RtnFil"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,0)">
        <Set>IcsFil=$SndFil</Set>
        <Set>msglen=00000020</Set>
        <Exec func="PUB:FtpPut">
          <Arg name="FtpId" value="PFA002"/>
        </Exec>
        <Exec func="PUB:CallThirdOther" error="IGNORE">
          <Arg name="TTxnCd" value="461078" desc="外发财政交易码"/>
          <Arg name="ObjSvr" value="STHDPFA1" desc="财政通讯服务"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=发送文件到财政系统失败</Set>
          <Return/>
        </If>
      </If>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
    </FlowCtrl>
  </Transaction>




  <Transaction code="461194" desc="根据支付令或额度令查询相关信息">
    <Quote name="PfaSqlLst"/>
		<DynSentence name="GetInfByQuoId" desc="根据额度ID查询">
			<Sentence>
				select QuoId, SubCod, PrjCod, DptCod, EConTp, AmtTyp, TPayTp
				  from %s
				 where PfaSub='%s' and Year=substr('%s',1,4) and BCusId='%s' and QuoId='%s' fetch first 1 rows only
			</Sentence>
			<Fields>QuoBokTbl|PfaSub|ActDat|BCusId|QuoId|</Fields>
		</DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <If condition="IS_EQUAL_STRING($PfaSub,001)">
        <Exec func="PUB:ReadRecord">
          <Arg name="sql" value="GetDtlByAVchCd"/>
        </Exec>
				<Set>AmtTyp=0001</Set>
				<Set>TPayTp=0002</Set>
      </If>
			<Else>
        <Exec func="PUB:ReadRecord">
          <Arg name="sql" value="GetInfByQuoId"/>
        </Exec>
			</Else>
    </FlowCtrl>
  </Transaction>
<!--公务卡资料、明细获取交易-->
<!--公务卡资料、明细获取交易-->
<!--公务卡资料、明细获取交易-->
<!--公务卡资料、明细获取交易-->
<!--公务卡资料、明细获取交易-->
  <Transaction code="461195" desc="公务卡资料、明细获取交易">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="ChkExist">
      <Sentence>
        select 'Y' YN FROM TABLE(VALUES(1)) AS anony where EXISTS ( select 'Y' from %s where %s )
      </Sentence>
      <Fields>TblNam|SqlStr|</Fields>
    </DynSentence>
    <DynSentence name="GetBrNo"> <!-- 取财政范围内分行号 -->
      <Sentence>
        select distinct BrNo from pfaorgsts
      </Sentence>
    </DynSentence>
    <DynSentence name="UpdCrdInf"> <!-- 更新卡资料 -->
      <Sentence>
        %s
      </Sentence>
      <Fields>SqlStr|</Fields>
    </DynSentence>
    <DynSentence name="CntCrdTxn"><!--计算明细总数-->
      <Sentence>
        select count(*) RecNum from pfacrdtxn where PfaSub='%s' and HActDt='%s' and IdxNo=''
      </Sentence>
      <Fields>PfaSub|HActDt|</Fields>
    </DynSentence>
    <DynSentence name="GetCrdInf"><!--取卡资料-->
      <Sentence>
        select BCusId, CardNm from pfacrdinf where PfaSub='%s' and CardNo='%s'
      </Sentence>
      <Fields>PfaSub|CardNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdCrdTxn"><!--更新唯一标志-->
      <Sentence>
        update pfacrdtxn set IdxNo=right('000000'||rtrim(char((row_number()over()+%s))),6) where PfaSub='%s' and HActDt='%s' and IdxNo=''
      </Sentence>
      <Fields>SelVal|PfaSub|HActDt|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>PfaSub=001</Set>
      <Quote name="ChkSubCfg"/>
      <Set>BrNo=$AgtBr</Set>
<!--为避免同一分行并发-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetBrNo"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:CloseCursor" error="IGNORE"/>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Return/>
      </If>
      <Set>HActDt=$ActDat</Set>
      <Exec func="PUB:IsExistNode" error="IGNORE">
        <Arg name="FieldName" value="QryDat"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,0)">  <!--非第三方-->
        <Set>QryDat=CALCDATE($ActDat,-,d,1)</Set>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <Set>OBrNo=$BrNo</Set>
        <Set>BrNo=$AgtBr</Set>
        <Set>AdeDir=STRCAT( $AdeFDir,$OBrNo,$AdeBDir,$QryDat )</Set>
        <Set>LstFil=STRCAT(GWYCARD.,$OBrNo,.,$QryDat,.list)</Set>
        <Set>AdeFil=$LstFil</Set>
        <Exec func="PUB:FtpGet" error="IGNORE">
          <Arg name="FtpId" value="PFA003"/>
        </Exec>
<!--判断返回文件是否存在-->
        <Exec func="PUB:IsValidFile" error="IGNORE">
          <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/,$IcsDir,/,$LstFil)"/>
        </Exec>
<!--单个文件不合法时，跳过该文件的处理，继续下一文件-->
        <If condition="OR( INTCMP($FilByt,3,0), INTCMP(~RetCod,4,0) )">
          <Set>RspMsg=STRCAT(文件【,$LstFil,】字节数不合法或数据文件不完整或不存在)</Set>
          <Continue/>
        </If>
<!--列表文件处理-->
        <Exec func="PUB:OpenFile">
          <Arg name="FileName"   value="STRCAT($IcsDir,/,$LstFil)"/>
          <Arg name="Mode"       value="r"/>
          <Arg name="ObjectName" value="LstFilNam"/>
        </Exec>
        <Exec func="PUB:InitDataParser">
          <Arg name="ConfigName" value="BatFormat"/>
          <Arg name="RootName"   value="BATCH"/>
        </Exec>
        <While>
<!--拆分列表文件获取具体数据文件名称-->
          <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
            <Arg name="NodeName"   value="Process"/>
            <Arg name="AttrName"   value="name"/>
            <Arg name="AttrValue"  value="PfaCrdLst"/>
            <Arg name="MaxLen"     value="100000"/>
            <Arg name="ObjectName" value="LstFilNam"/>
          </Exec>
          <If condition="~RetCod!=0">
            <If condition="~RetCod=-1"> <!--处理失败-->
              <Set>RspMsg=STRCAT(读列表文件【,$LstFil,】错)</Set>
            </If>
            <Break/>
          </If>
          <Set>AdeFil=$DatFNm</Set>
          <Exec func="PUB:FtpGet" error="IGNORE">
            <Arg name="FtpId" value="PFA003"/>
          </Exec>
<!--判断返回文件是否存在-->
          <Exec func="PUB:IsValidFile" error="IGNORE">
            <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/,$IcsDir,/,$DatFNm)"/>
          </Exec>
<!--单个文件不合法时，跳过该文件的处理，继续下一文件-->
          <If condition="OR( INTCMP($FilByt,4,$DatFSz), INTCMP(~RetCod,4,0) )">
            <Set>RspMsg=STRCAT(文件【,$DatFNm,】字节数不合法或数据文件不完整或不存在)</Set>
            <Continue/>
          </If>
          <Exec func="PUB:OpenFile">
            <Arg name="FileName"   value="STRCAT($IcsDir,/,$DatFNm)"/>
            <Arg name="Mode"       value="r"/>
            <Arg name="ObjectName" value="DatFilNam"/>
          </Exec>
          <Exec func="PUB:InitDataParser">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
          </Exec>
          <Switch expression="SUBSTR($DatFNm,1,12)">
            <Case value="CARD_GWY_ISE"> <!-- 卡资料 -->
              <Set>TblNam=pfacrdinf</Set>
              <Break/>
            </Case>
            <Case value="CARD_GWY_TXN"> <!-- 卡明细 -->
              <Set>TblNam=pfacrdtxn</Set>
              <Break/>
            </Case>
            <Default>
              <Set>RspMsg=STRCAT(列表文件【,$LstFil,】中数据文件【,$DatFNm,】不合法)</Set>
              <Continue/>
            </Default>
          </Switch>
          <Set>EndFlg=0</Set>
          <While>
            <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
              <Arg name="ConfigName" value="BatFormat"/>
              <Arg name="RootName"   value="BATCH"/>
              <Arg name="NodeName"   value="Process"/>
              <Arg name="AttrName"   value="name"/>
              <Arg name="AttrValue"  value="$TblNam"/>
              <Arg name="MaxLen"     value="100000"/>
              <Arg name="ObjectName" value="DatFilNam"/>
            </Exec>
            <If condition="~RetCod!=0">
              <If condition="~RetCod=-1"> <!--处理失败-->
                <Set>EndFlg=1</Set>
                <Set>RspMsg=STRCAT(读数据文件【,$DatFNm,】错)</Set>
              </If>
              <Break/>
            </If>
<!--记录是否存在-->
            <Switch expression="SUBSTR($DatFNm,1,12)">
              <Case value="CARD_GWY_ISE"> <!-- 卡资料 -->
                <Set>SqlStr=STRCAT( PfaSub=',$PfaSub,' and CardNo=',$CardNo,' )</Set>
                <Break/>
              </Case>
              <Case value="CARD_GWY_TXN"> <!-- 卡明细 -->
                <Set>SqlStr=STRCAT( PfaSub=',$PfaSub,' and CardNo=',$CardNo,' and TxnDat=',$TxnDat,' and TLogNo=',$TLogNo,' )</Set>
                <Break/>
              </Case>
              <Default>
                <Set>RspMsg=STRCAT(列表文件【,$LstFil,】中数据文件【,$DatFNm,】不合法)</Set>
                <Continue/>
              </Default>
            </Switch>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="ChkExist"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="DatFilNam"/>
              </Exec>
              <Set>RspMsg=STRCAT(查询数据表【,$TblNam,】失败)</Set>
              <Break/>
            </If>
            <If condition="~RetCod=0">  <!--存在-->
              <If condition="IS_EQUAL_STRING($TblNam,pfacrdinf)"> <!--卡资料则更新、卡明细则跳过-->
                <Exec func="PUB:UpdateRecord" error="IGNORE">
                  <Arg name="TblNam" value="pfacrdinf"/>
                  <Arg name="CndSts" value="UpdCrdInf"/>
                </Exec>
                <If condition="~RetCod!=0">
                  <Exec func="PUB:RollbackWork"/>
                  <Exec func="PUB:CloseFile">
                    <Arg name="ObjectName" value="DatFilNam"/>
                  </Exec>
                  <Set>RspMsg=STRCAT(插入数据表【,$TblNam,】失败)</Set>
                  <Set>EndFlg=1</Set>
                  <Break/>
                </If>
                <Set>RspMsg=STRCAT(更新财政【,$PfaSub,】公务卡【,$CardNo,】资料)</Set>
                <Delete>BCusId</Delete> <!--更新完成后删除，避免影响下一卡号-->
              </If>
              <Else>
                <Set>RspMsg=STRCAT(财政【,$PfaSub,】公务卡【,$CardNo,】消费记录重复)</Set>
              </Else>
              <Continue/>
            </If>
            <If condition="IS_EQUAL_STRING($TblNam,pfacrdtxn)"> <!--卡明细获取卡名及单位编码-->
              <Exec func="PUB:ReadRecord" error="IGNORE">  <!--忽略错误，保证明细正常入库-->
                <Args>
                  <Arg name="SqlCmd" value="GetCrdInf"/>
                </Args>
              </Exec>
            </If>
<!--新记录则更新-->
            <Exec func="PUB:InsertRecord" error="IGNORE">
              <Arg name="TblNam" value="$TblNam"/>
            </Exec>
            <If condition="~RetCod!=0">
              <Exec func="PUB:RollbackWork"/>
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="DatFilNam"/>
              </Exec>
              <Set>RspMsg=STRCAT(插入数据表【,$TblNam,】失败)</Set>
              <Set>EndFlg=1</Set>
              <Break/>
            </If>
          </While>   <!--单个数据文件内容循环-->
          <If condition="IS_EQUAL_STRING($EndFlg,0)">
            <If condition="IS_EQUAL_STRING($TblNam,pfacrdtxn)"> <!--若当前文件为交易明细，需更新索引号-->
              <Exec func="PUB:ReadRecord" error="IGNORE">
                <Arg name="SqlCmd" value="CntCrdTxn"/>
              </Exec>
              <If condition="INTCMP(~RetCod,4,0)">
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=STRCAT(计算分行【,$OBrNo,】交易日【,$QryDat,】明细总数错误)</Set>
                <Return/>
              </If>
              <If condition="INTCMP($RecNum,6,0)">
                <Exec func="PUB:nGetPubSeqNo"> <!--每次查询批次号-->
                  <Arg name="SeqNam" value="PfaCrdTxn:IdxNo"/>
                  <Arg name="SeqCnt" value="$RecNum"/>
                  <Arg name="Len"    value="6"/>
                  <Arg name="CycCnd" value="Y"/>
                </Exec>
                <Set>SelVal=SUB($SelVal,1)</Set>
                <Exec func="PUB:ExecSql" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="UpdCrdTxn"/>
                  </Args>
                </Exec>
                <If condition="INTCMP(~RetCod,4,0)">
                  <Exec func="PUB:RollbackWork" error="IGNORE"/>
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PFA999</Set>
                  <Set>RspMsg=STRCAT(更新分行【,$OBrNo,】交易日【,$QryDat,】索引号错误)</Set>
                  <Set>RspMsg=更新索引号错</Set>
                  <Return/>
                </If>
              </If>
            </If>
            <Exec func="PUB:CommitWork"/>
          </If>
          <Exec func="PUB:CloseFile">
            <Arg name="ObjectName" value="DatFilNam"/>
          </Exec>
        </While>   <!--列表文件内容循环-->
        <Exec func="PUB:CloseFile">
          <Arg name="ObjectName" value="LstFilNam"/>
        </Exec>
      </While>   <!--分行号循环-->
      <Exec func="PUB:FetchCursor" error="IGNORE"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>
<!--公共查询交易-->
<!--公共查询交易-->
<!--公共查询交易-->
<!--公共查询交易-->
<!--公共查询交易-->
  <Transaction code="461196" desc="根据输入日期获取月底日期">
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Set>FstDat=CALCDATE(STRCAT(SUBSTR($InDate,1,6),01),+,m,1)</Set>
      <Set>OuDate=CALCDATE($FstDat,-,d,1)</Set>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461197" desc="根据帐号查询帐户资料">
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="109000"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461198" desc="根据财政代码、编码类型、编码查询相关信息">
    <DynSentence name="ChkCodInf">
      <Sentence>
        select CodNam from pfacodinf where PfaSub='%s' and CodTyp='%s' and Code='%s'
      </Sentence>
      <Fields>PfaSub|CodTyp|Code|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="ChkCodInf"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="~RetCod=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=代码不存在</Set>
        <Return/>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461199" desc="根据基层预算单位帐号查询相关信息">
    <DynSentence name="GntCusInf">
      <Sentence>
        select count(*) CntNum from pfacusinf where PfaSub='%s' and ( ActNo='%s' or BCusId='%s')
      </Sentence>
      <Fields>PfaSub|ActNo|ActNo|</Fields>
    </DynSentence>
    <DynSentence name="GetCusInf">
      <Sentence>
        select BCusId,BCusNm,TCusId,ProId,ProNam,FCusId,FCusNm,ActNo,ActNam,CusLvl,OpnNod,OpnBNm,Addr,RegDat,AmtTyp,ActTyp,TlrId,Smr
          from pfacusinf
         where PfaSub='%s' and ( ActNo='%s' or BCusId='%s')
      </Sentence>
      <Fields>PfaSub|ActNo|ActNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
<!--
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GntCusInf"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="INTCMP($CntNum,3,0)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=预算单位不存在</Set>
        <Return/>
      </If>
      <If condition="INTCMP($CntNum,6,1)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=存在账号重复的预算单位，请输入预算单位编码</Set>
        <Return/>
      </If>
-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetCusInf"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="~RetCod=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=预算单位不存在</Set>
        <Return/>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461101" error="PUB:RollbackWork" timeout="300" desc="越秀区财政指令文件读入">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="DelCmdRec" desc="清理读入错误的数据">
      <Sentence>
        delete from %s where Year='%s' and ACmdNo='%s'
      </Sentence>
      <Fields>TblNam|Year|ACmdNo|</Fields>
    </DynSentence>
    <DynSentence name="ChkSts" desc="检查明细数据是否处理完毕">
      <Sentence>
        select count(*) Num from %s where Year='%s' and ACmdNo='%s' and QuoSts='U'
      </Sentence>
      <Fields>TblNam|Year|ACmdNo|</Fields>
    </DynSentence>
    <DynSentence name="GetCmdSum" desc="获取返回文件文件第一行">
      <Sentence>
        select PfaLvl,OrnAmt,RegTim,OrnCnt,BilAth,BankNo,BankCd,BankNm,MacKey from %s where Year='%s' and ACmdNo='%s'
      </Sentence>
      <Fields>PfaCmdSum|Year|ACmdNo|</Fields>
    </DynSentence>
    <DynSentence name="Getpfaquobok" desc="获取返回额度处理结果文件明细内容">
      <Sentence>
        select QuoSts,TBusTp,TVchNo,TQuoNo,TSeqNo,ClrBNm,ClrANm,ClrAct,AgtBNm,ActNm,ActNo,BCusId,BCusNm,FCusId,FCusNm,AmtTyp,AmtNam,
               TypCod,TypNam,SubCod,SubNam,PrjCod,PrjNam,TPayTp,TPayNm,DptCod,DptNam,EConTp,EConNm,QuoSmr,BasFlg,BActNm,
               BActNo,OpnBNm,MacKey,RsFld1,RsFld2,RtnCod,RtnMsg,
               case when TxnFlg='0' then bigint(QuoAmt) when TxnFlg='1' then (-1)*bigint(QuoAmt) end QuoAmt
          from %s
         where Year='%s' and ACmdNo='%s'
      </Sentence>
      <Fields>TblNam|Year|ACmdNo|</Fields>
    </DynSentence>
    <DynSentence name="GetDtlSum" desc="获取返回支付令处理结果文件汇总内容">
      <Sentence>
        select count(*) OrnCnt, sum(bigint(UseAmt)) OrnAmt
          from %s
         where Year=substr('%s',1,4) and PfaDat='%s' and ClrSts='3'
      </Sentence>
      <Fields>TblNam|ActDat|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="Getpfavchdtl" desc="获取返回支付令处理结果文件明细内容">
      <Sentence>
        select a.TLogNo TLogNo,a.TBusTp TBusTp,a.DtlTim DtlTim,b.TQuoNo TQuoNo,b.TSeqNo TSeqNo,b.TypCod TypCod,
               b.TypNam TypNam,a.AVchCd AVchCd,a.PayNam PayNam,a.PayAct PayAct,a.PayBNm PayBNm,a.PyeNam PyeNam,
               a.PyeAct PyeAct,a.PyeBNm PyeBNm,a.DtlAmt DtlAmt,a.FCusId FCusId,b.FCusNm FCusNm,a.BCusId BCusId,
               b.BCusNm BCusNm,b.SubCod SubCod,b.SubNam SubNam,a.Usage  Usage ,a.DtlSmr DtlSmr,b.TPayTp TPayTp,
               b.TPayNm TPayNm,b.DptCod DptCod,b.DptNam DptNam,b.EConTp EConTp,b.EConNm EConNm,b.AmtTyp AmtTyp,
               b.AmtNam AmtNam,b.PrjCod PrjCod,b.PrjNam PrjNam,a.StlNam StlNam,a.VchNo  VchNo ,a.MacKey MacKey,
               a.RsFld1 RsFld1,a.RsFld2 RsFld2,a.LogNo  LogNo, b.MacKey MacKey,a.OIFlag OIFlag,a.DtlSts DtlSts
          from %s a, %s b
         where a.Year=substr('%s',1,4) and a.PfaDat='%s' and a.ClrSts='3' and a.Year=b.Year and a.TSeqNo=b.TSeqNo
      </Sentence>
      <Fields>TblNam1|TblNam2|ActDat|ActDat|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <Set>PfaCmdSum=STRCAT(pfacmdsum,$PfaSub)</Set>
<!--初始化格式文件-->
      <Delete>FmtNam</Delete>
      <Switch expression="$ACmdTp">
        <Case value="1"> <!-- 额度令 -->
          <Set>QuoSts=0</Set>
          <Set>TblNam=$QuoBokTbl</Set>
          <Break/>
        </Case>
        <Case value="2"> <!-- 支付令 -->
          <Set>DtlSts=U</Set>
          <Set>TblNam=$VchDtlTbl</Set>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=指令类型不合法</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>FmtNam=STRCAT($TblNam,_,$OIFlag)</Set>
      <Switch expression="$OIFlag">
        <Case value="I"> <!-- 读入 -->
          <Set>CmdSts=U</Set>
          <Set>DatFil=STRCAT( $TRDir,$FilNam )</Set>
          <Set>RegDat=$ActDat</Set>
<!--产生批次号用于后续业务处理步骤-->
          <Exec func="PUB:nGetPubSeqNo">
            <Arg name="SeqNam" value="STRCAT(PfaCmdSum,$PfaSub,:ACmdNo)"/>
            <Arg name="Len"    value="8"/>
            <Arg name="CycCnd" value="Y"/>
          </Exec>
          <Set>ACmdNo=$SelVal</Set>
          <Exec func="PUB:ImportToDB" error="IGNORE">
            <Args>
              <Arg name="FormatName" value="$FmtNam"/>
              <Arg name="FileName"   value="$DatFil"/>
              <Arg name="TableName"  value="$TblNam"/>
            </Args>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Exec func="PUB:ExecSql">
              <Args>
                <Arg name="SqlCmd" value="DelCmdRec"/>
              </Args>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(插入数据表【,$TblNam,】失败)</Set>
            <Return/>
          </If>
<!--插入汇总记录-->
          <Exec func="PUB:InsertRecord" error="IGNORE">
            <Arg name="TblNam" value="$PfaCmdSum"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(插入数据表【,$PfaCmdSum,】失败)</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Case value="O"> <!-- 返盘 -->
          <Set>CmdSts=S</Set>
          <Set>FilTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
          <If condition="INTCMP($ACmdTp,3,1)">
            <Set>FilNam=STRCAT(0203004JLH,$FilTim,.txt)</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="ChkSts"/>
              </Args>
            </Exec>
            <If condition="INTCMP($Num,6,0)">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=STRCAT(批次【,$ACmdNo,】审核未完成)</Set>
              <Return/>
            </If>
<!--获取文件头-->
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetCmdSum"/>
              </Args>
            </Exec>
          </If>
          <Else>
<!--
            <Set>FilNam=STRCAT(0202004JLH,$FilTim,.txt)</Set>
-->
            <Set>FilNam=STRCAT(02026,$FilTim,.txt)</Set>
            <Set>TblNam1=$VchDtlTbl</Set>
            <Set>TblNam2=$QuoBokTbl</Set>
<!--获取文件头-->
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetDtlSum"/>
              </Args>
            </Exec>
          </Else>
          <Set>DatFil=STRCAT( $RptDir,$FilNam )</Set>
          <Set>RtnTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
          <Exec func="PUB:ExportFromDB">
            <Args>
              <Arg name="FormatName" value="$FmtNam"/>
              <Arg name="FileName"   value="$DatFil"/>
              <Arg name="TableName"  value="$TblNam"/>
              <Arg name="SqlName"    value="STRCAT(Get,SUBSTR($TblNam,1,9))"/>
            </Args>
          </Exec>
          <Exec func="PUB:SendFileMessage2">
            <Arg name="MsgTyp"  value="3"/>
            <Arg name="ObjNod"  value="$NodNo"/>
            <Arg name="BusTyp"  value="46"/>
            <Arg name="AplCod"  value="$TxnCod"/>
            <Arg name="FilNam"  value="$FilNam"/>
            <Arg name="Summary" value="返回文件"/>
            <Arg name="ObjTlr"  value="$TlrId"/> 
          </Exec>
          <Break/>
        </Case>
      </Switch>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461102" desc="越秀区支付额度预处理">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="MultiQuery">
      <Sentence>
        select TBusTp,TVchNo,TQuoNo,QuoId,ActNo,BCusId,AmtTyp,AmtNam,TypCod,TypNam,SubCod,SubNam,PrjCod,PrjNam,QuoAmt,
               TPayTp,TPayNm,DptCod,DptNam,EConTp,EConNm,QuoSmr
          from %s where PfaSub='%s' and Year='%s' and ACmdNo='%s' and QuoSts='0' order by BCusId,TQuoNo
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|Year|ACmdNo|</Fields>
    </DynSentence>
    <DynSentence name="SingleQuery">
      <Sentence>
        select TBusTp,TVchNo,TQuoNo,QuoId,ActNo,BCusId,AmtTyp,AmtNam,TypCod,TypNam,SubCod,SubNam,PrjCod,PrjNam,QuoAmt,
               TPayTp,TPayNm,DptCod,DptNam,EConTp,EConNm,QuoSmr
          from %s where PfaSub='%s' and Year='%s' and ACmdNo='%s' and TVchNo='%s' and TQuoNo='%s' and QuoSts='0'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|Year|ACmdNo|TVchNo|TQuoNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdQuoSts">
      <Sentence>
        update %s set QuoSts='1', ChkDat='%s', ChkId='%s', RtnCod='%s', RtnMsg='%s', BrNo='%s'
         where PfaSub='%s' and Year='%s' and ACmdNo='%s' and TVchNo='%s' and TQuoNo='%s' and QuoSts='0'
      </Sentence>
      <Fields>QuoBokTbl|ActDat|TlrId|RtnCod|RtnMsg|BrNo|PfaSub|Year|ACmdNo|TVchNo|TQuoNo|</Fields>
    </DynSentence>
    <DynSentence name="ChkQuoSts">
      <Sentence>
        select count(*) Num from %s where PfaSub='%s' and Year='%s' and ACmdNo='%s' and ( QuoSts='0' or ( QuoSts='1' and RtnCod!='000' ) )
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|Year|ACmdNo|</Fields>
    </DynSentence>
    <DynSentence name="GetQuoBok">
      <Sentence>
        select %s, TVchNo, TBusTp, QuoAmt, ClrAct from %s where Year='%s' and ACmdNo='%s' and UpdFlg='0' and QuoSts='1' order by TBusTp
      </Sentence>
      <Fields>SqlCol|QuoBokTbl|Year|ACmdNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdQuoBok">
      <Sentence>
        update %s set UpdFlg='1' where %s and ACmdNo='%s' and TVchNo='%s'
      </Sentence>
      <Fields>QuoBokTbl|SqlStr|ACmdNo|TVchNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <Switch expression="$Func">
        <Case value="1">  <!--浏览-->
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">  <!--单笔查询-->
          <If condition="IS_NOEQUAL_STRING($AgtNod,$NodNo)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(非财政【,$PfaSub,】代理网点)</Set>
            <Return/>
          </If>
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="SingleQuery"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Case value="3">  <!--审批-->
<!--
          <Exec func="PUB:AddAuthReason">
            <Arg name="AthCod" value="30"/>
            <Arg name="AthMsg" value="PFA000"/>
          </Exec>
          <Exec func="PUB:CheckLocalAuth">
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
-->
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdQuoSts"/>
            </Args>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Case value="4">  <!--打印-->
          <Exec func="PUB:GetNextWorkDate">
            <Arg name="Date" value="$ActDat"/>
          </Exec>
          <Set>RegDat=$ActDat</Set>
          <Set>FmtFil=STRCAT(etc/,PFA015_RPT.XML)</Set>
          <Set>RptFil=STRCAT(PFA015,$TlrId,.RPT)</Set>
          <Set>RptNam=未确认额度清单</Set>
          <Exec func="EXT:GenerateReport">
            <Arg name="RptName" value="STRCAT($RptDir,$RptFil)"/>
            <Arg name="RptFile" value="$FmtFil"/>
            <Arg name="RptNam"  value="$RptNam"/>
            <Arg name="PfaSub"  value="$PfaSub"/>
            <Arg name="RegDat"  value="$RegDat"/>
            <Arg name="TlrId"   value="$TlrId"/>
            <Arg name="PrtDat"  value="$ActDat"/>
          </Exec>
          <Exec func="PUB:SendFileMessage2">
            <Arg name="MsgTyp"  value="4"/>
            <Arg name="ObjNod"  value="$NodNo"/>
            <Arg name="BusTyp"  value="46"/>
            <Arg name="AplCod"  value="$TxnCod"/>
            <Arg name="FilNam"  value="$RptFil"/>
            <Arg name="Summary" value="$RptNam"/>
            <Arg name="ObjTlr"  value="$TlrId"/> 
          </Exec>
          <Break/>
        </Case>
        <Case value="5">  <!--更新-->
          <Exec func="PUB:Lock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod,$Func)"/>
            <Arg name="AutoUnlock" value="Y"/>
          </Exec>
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="ChkQuoSts"/>
            </Args>
          </Exec>
          <If condition="INTCMP($Num,6,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(批次【,$ACmdNo,】审核未完成或存在审核失败记录)</Set>
            <Return/>
          </If>
          <Set>StsNam=QuoSts</Set>
          <Quote name="GetSqlCol"/>
          <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="sql" value="GetQuoBok"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod,$Func)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
              <Break/>
            </If>
<!--获取支付控制级别-->
            <Set>StsNam=BalSts</Set>
            <Set>StsVal=0</Set>
<!--
            <If condition="IS_EQUAL_STRING($TBusTp,0106)">
              <Set>BTSeqNo=$TSeqNo</Set>
              <Set>TSeqNo=$OTSeqNo</Set>
            </If>
-->
            <Quote name="GetSqlStr"/>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="GetQuoBal"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod,$Func)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <If condition="~RetCod=-2"> <!--找不到相同控制条件记录，登记初始记录-->
              <If condition="IS_EQUAL_STRING($TBusTp,0106)">  <!--调减-->
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Exec func="PUB:CloseCursor" error="IGNORE"/>
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod,$Func)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=STRCAT(财政【,$PfaSub,】客户【,$BCusId,】额度不能为负)</Set>
                <Return/>
              </If>
              <Set>BalSts=0</Set>
              <Set>QuoTot=0</Set>
              <Set>QuoBal=0</Set>
              <Set>FrzAmt=0</Set>
              <Exec func="PUB:InsertRecord" error="IGNORE">
                <Arg name="TblNam" value="pfaquobal"/>
              </Exec>
              <If condition="INTCMP(~RetCod,4,0)">
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Exec func="PUB:CloseCursor" error="IGNORE"/>
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod,$Func)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=初始化额度余额表错</Set>
                <Return/>
              </If>
            </If>
            <If condition="IS_EQUAL_STRING($TBusTp,0105)">  <!--调增-->
              <Set>QuoTot=ADDCHAR(ADDAMT($QuoTot,$QuoAmt),15,0,1)</Set>
              <Set>QuoBal=ADDCHAR(ADDAMT($QuoBal,$QuoAmt),15,0,1)</Set>
            </If>
            <Else>
              <If condition="INTCMP($QuoBal,1,$QuoAmt)">
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Exec func="PUB:CloseCursor" error="IGNORE"/>
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod,$Func)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFA999</Set>
                <Set>RspMsg=STRCAT(财政【,$PfaSub,】客户【,$BCusId,】额度不能为负)</Set>
                <Return/>
              </If>
              <Set>QuoTot=ADDCHAR(SUBAMT($QuoTot,$QuoAmt),15,0,1)</Set>
              <Set>QuoBal=ADDCHAR(SUBAMT($QuoBal,$QuoAmt),15,0,1)</Set>
            </Else>
<!--修改余额表-->
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="UpdQuoBal"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod,$Func)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库处理失败</Set>
              <Return/>
            </If>
<!--修改额度令表-->
            <Set>StsNam=QuoSts</Set>
            <Set>StsVal=$QuoSts</Set>
<!--
            <If condition="IS_EQUAL_STRING($TBusTp,0106)">
              <Set>TSeqNo=$BTSeqNo</Set>
            </If>
-->
            <Quote name="GetSqlStr"/>
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="UpdQuoBok"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod,$Func)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=数据库处理失败</Set>
              <Return/>
            </If>
          </While>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod,$Func)"/>
          </Exec>
          <Break/>
        </Case>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461103" desc="区财清算文件生成">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="GetOutAmt">
      <Sentence>
        select sum(bigint(a.UseAmt)) OutAmt from %s a, PfaQuoBal b
         where a.PfaSub='%s' and a.ClrBNo='%s' and a.ClrDat='%s' and a.OIFlag ='O' and a.ClrSts='2'
           and b.year=substr('%s',1,4) and b.QuoId=a.QuoId and b.ClrAct='%s'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|ClrBNo|ClrDat|ClrDat|TActNo|</Fields>
    </DynSentence>
    <DynSentence name="GetOutVchBokDtl">
      <Sentence>
        select a.BCusId BCusId, a.FCusId FCusId, a.SubCod SubCod, a.EConTp EConTp, a.UseAmt UseAmt from %s a, PfaQuoBal b
         where a.PfaSub='%s' and a.ClrBNo='%s' and a.ClrDat='%s' and a.OIFlag ='O' and a.ClrSts='2'
           and b.year=substr('%s',1,4) and b.QuoId=a.QuoId and b.ClrAct='%s'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|ClrBNo|ClrDat|ClrDat|TActNo|</Fields>
    </DynSentence>
    <DynSentence name="GetInAmt">
      <Sentence>
        select sum(bigint(a.UseAmt)) InAmt from %s a, PfaQuoBal b
         where a.PfaSub='%s' and a.ClrBNo='%s' and a.ClrDat='%s' and a.OIFlag in ( 'R','I' ) and a.ClrSts='2'
           and b.year=substr('%s',1,4) and b.QuoId=a.QuoId and b.ClrAct='%s'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|ClrBNo|ClrDat|ClrDat|TActNo|</Fields>
    </DynSentence>
    <DynSentence name="GetInVchBokDtl">
      <Sentence>
        select a.BCusId BCusId, a.FCusId FCusId, a.SubCod SubCod, a.EConTp EConTp, a.UseAmt UseAmt from %s a, PfaQuoBal b
         where a.PfaSub='%s' and a.ClrBNo='%s' and a.ClrDat='%s' and a.OIFlag in ( 'R','I' ) and a.ClrSts='2'
           and b.year=substr('%s',1,4) and b.QuoId=a.QuoId and b.ClrAct='%s'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|ClrBNo|ClrDat|ClrDat|TActNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdRtnSeq">
      <Sentence>
        update PfaSubCfg set RtnSeq=char(bigint(RtnSeq)+1), Rtnflg='1' where PfaSub='%s'
      </Sentence>
      <Fields>PfaSub|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_NOEQUAL_STRING($ClrNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政【,$PfaSub,】清算网点)</Set>
        <Return/>
      </If>
<!--为避免同一分行并发-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Set>RtnSeq=ADDCHAR($RtnSeq,2,0,1)</Set>
      <Switch expression="$OIFlag">
        <Case value="O"> <!-- 支出 -->
          <Set>ClrFil=STRCAT($RptDir,$ClrDat,$RtnSeq,270.txt)</Set>
          <Set>SndFil=STRCAT($ClrDat,$RtnSeq,270.txt)</Set>
<!--统计支出-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetOutAmt"/>
            </Args>
          </Exec>
          <If condition="~RetCod!=0">
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(汇总支出金额失败或批次【,$ClrBNo,】不存在)</Set>
            <Return/>
          </If>
          <If condition="INTCMP($OutAmt,4,0)">
<!--文件头-->
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$ClrFil"/>
              <Arg name="OpenMode" value="w"/>
              <Arg name="Data"   value="**1920030000"/>   <!--中信国库代码-->
              <Arg name="Data"   value=",,"/>             <!--付款人全称,一般为财政部门代码,可为空-->
              <Arg name="Data"   value="$TActNo"/>        <!--付款人账号-->
              <Arg name="Data"   value=",,"/>             <!--付款人开户行,国库所在银行代码,可为空-->  
              <Arg name="Data"   value=","/>              <!--付款人开户行行号,国库所在银行行号,可为空-->  
              <Arg name="Data"   value="666666666666,"/>  <!--收款人全称,执行支付银行代码--> 
              <Arg name="Data"   value=","/>              <!--收款人账号,执行支付银行收款账号,可为空-->
              <Arg name="Data"   value=","/>              <!--收款人开户行,国库所在银行行号,可为空-->
              <Arg name="Data"   value=","/>              <!--收款人开户行行号,代理银行行号,可为空-->
              <Arg name="Data"   value="1"/>              <!--预算种类代码-->
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="AMTSIMPLEFMT($OutAmt)"/>
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="0"/>
              <Arg name="Data"   value=",27,"/>              <!--摘要代码,可为空-->
              <Arg name="Data"   value="SUBSTR($ClrBNo,3,8)"/>  <!--??汇总凭证编号,不为空,凭证编码不能大于8位-->
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="$ClrDat"/>        <!--本凭证编制日期,可为空-->
              <Arg name="ESCFMT" value="\\n"/>
            </Exec>
<!--文件体-->
            <Set>OIFlag=O</Set>
            <Exec func="PUB:OpenCursor" error="IGNORE">
              <Arg name="sql" value="GetOutVchBokDtl"/>          
            </Exec>
            <If condition="~RetCod!=0">
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=打开游标出错</Set>
              <Return/>
            </If>
            <While>
              <Exec func="PUB:FetchCursor" error="IGNORE"/>
              <If condition="~RetCod=100">
                <Break/>
              </If>
              <Exec func="PUB:WriteFile" error="IGNORE">
                <Arg name="FileName" value="$ClrFil"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="$BCusId"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="$SubCod"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="$EConTp"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="1"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="AMTSIMPLEFMT($UseAmt)"/>
                <Arg name="ESCFMT" value="\\n"/>
              </Exec>
            </While>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
          </If>
          <Break/>
        </Case>
        <Case value="R"/>
        <Case value="I">
          <Set>ClrFil=STRCAT($RptDir,$ClrDat,$RtnSeq,280.txt)</Set>
          <Set>SndFil=STRCAT($ClrDat,$RtnSeq,280.txt)</Set>
<!--统计退回-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetInAmt"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=STRCAT(汇总退回金额失败或批次【,$ClrBNo,】不存在)</Set>
            <Return/>
          </If>
          <If condition="INTCMP($InAmt,4,0)">
<!--文件头-->
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$ClrFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="**1920030000"/>   <!--中信国库代码-->
              <Arg name="Data"   value=",,"/>             <!--付款人全称,一般为财政部门代码,可为空-->
              <Arg name="Data"   value="$TActNo"/>        <!--付款人账号-->
              <Arg name="Data"   value=",,"/>             <!--付款人开户行,国库所在银行代码,可为空-->  
              <Arg name="Data"   value=","/>              <!--付款人开户行行号,国库所在银行行号,可为空-->  
              <Arg name="Data"   value="666666666666,"/>  <!--收款人全称,执行支付银行代码--> 
              <Arg name="Data"   value=","/>              <!--收款人账号,执行支付银行收款账号,可为空-->
              <Arg name="Data"   value=","/>              <!--收款人开户行,国库所在银行行号,可为空-->
              <Arg name="Data"   value=","/>              <!--收款人开户行行号,代理银行行号,可为空-->
              <Arg name="Data"   value="1"/>              <!--预算种类代码-->
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="AMTSIMPLEFMT($InAmt)"/>
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="0"/>
              <Arg name="Data"   value=",28,"/>              <!--摘要代码,可为空-->
              <Arg name="Data"   value="SUBSTR($ClrBNo,3,8)"/>  <!--??汇总凭证编号,不为空,凭证编码不能大于8位-->
              <Arg name="Data"   value=","/>
              <Arg name="Data"   value="$ClrDat"/>        <!--本凭证编制日期,可为空-->
              <Arg name="ESCFMT" value="\\n"/>
            </Exec>
<!--文件体-->
            <Exec func="PUB:OpenCursor" error="IGNORE">
              <Arg name="sql" value="GetInVchBokDtl"/>
            </Exec>
            <If condition="~RetCod!=0">
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFA999</Set>
              <Set>RspMsg=打开游标出错</Set>
              <Return/>
            </If>
            <While>
              <Exec func="PUB:FetchCursor" error="IGNORE"/>
              <If condition="~RetCod=100">
                <Break/>
              </If>
              <Exec func="PUB:WriteFile" error="IGNORE">
                <Arg name="FileName" value="$ClrFil"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="$BCusId"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="$SubCod"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="$EConTp"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="1"/>
                <Arg name="Data"   value=","/>
                <Arg name="Data"   value="AMTSIMPLEFMT($UseAmt)"/>
                <Arg name="ESCFMT" value="\\n"/>
              </Exec>
            </While>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
          </If>
          <Break/>
        </Case>
      </Switch>
<!--更新返回次数-->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="sql" value="UpdRtnSeq"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=更新文件当日返回序号失败</Set>
        <Return/>
      </If>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
      </Exec>
      <Exec func="PUB:IsExistFile" error="IGNORE">
        <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/,$ClrFil)"/>
      </Exec>
      <If condition="~RetCod=0">
        <Exec func="PUB:SendFileMessage2">
          <Arg name="MsgTyp"  value="3"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="46"/>
          <Arg name="AplCod"  value="$TxnCod"/>
          <Arg name="FilNam" value="$SndFil"/>
          <Arg name="Summary" value="清算文件生成"/>
          <Arg name="ObjTlr"  value="$TlrId"/> 
        </Exec>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461104" desc="申请区财政资金清单打印">
    <Quote name="PfaSqlLst"/>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
      <If condition="IS_NOEQUAL_STRING($ClrNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政【,$PfaSub,】清算网点)</Set>
        <Return/>
      </If>
      <Switch expression="$OIFlag">
        <Case value="O">
          <Set>OIMsg=支出</Set>
          <Break/>
        </Case>
        <Case value="I">
          <Set>OIMsg=收款</Set>
          <Break/>
        </Case>
        <Case value="R">
          <Set>OIMsg=退回</Set>
          <Break/>
        </Case>
      </Switch>
      <Switch expression="$PrtDtl">
        <Case value="1"> <!-- 申请财政资金明细清单 -->
          <Set>RptNam=STRCAT(申请财政资金【,$OIMsg,】明细清单)</Set>
          <Set>FilNam=STRCAT(PFA209_,$OIFlag,_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PFA209_RPT.XML)</Set>
          <Set>Summary=申请财政资金明细清单</Set>
          <Break/>
        </Case>
        <Case value="2"> <!-- 申请财政资金汇总清单 -->
          <Set>RptNam=STRCAT(申请财政资金【,$OIMsg,】汇总清单)</Set>
          <Set>FilNam=STRCAT(PFA210_,$OIFlag,_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PFA210_RPT.XML)</Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="ObjFil" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="RptNam" value="$RptNam"/>
        <Arg name="PfaSub" value="$PfaSub"/>
        <Arg name="OIFlag" value="$OIFlag"/>
        <Arg name="ClrDat" value="$ClrDat"/>
        <Arg name="TActNo" value="$TActNo"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="3"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="461105" desc="区财政报表打印">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="GetQuoBokInf">
      <Sentence>
        select distinct BCusId, AmtTyp, DptCod, SubCod, PrjCod
          from %s
         where PfaSub='%s' and RtnCod='000' and ChkDat &lt;= '%s' and QuoSts!='0'
          order by BCusId, SubCod, PrjCod, AmtTyp, DptCod
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|EndDat|</Fields>
    </DynSentence>
    <DynSentence name="SumQuoAmt">
      <Sentence>
        select value(sum(bigint(QuoAmt)),0) QuoAmt from %s 
         where PfaSub='%s' and BCusId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s' and AmtTyp='%s'
           and ( ChkDat %s ) and TxnFlg='%s' and RtnCod='000' and QuoSts!='0'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|BCusId|SubCod|PrjCod|DptCod|AmtTyp|SqlDate|TxnFlg|</Fields>
    </DynSentence>
    <DynSentence name="SumDtlAmt">
      <Sentence>
        select value(sum(bigint(UseAmt)),0) DtlAmt from %s 
         where PfaSub='%s' and BCusId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s' and AmtTyp='%s'
           and ( PfaDat %s ) and OIFlag='%s' and ClrSts='3'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|BCusId|SubCod|PrjCod|DptCod|AmtTyp|SqlDate|OIFlag|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Quote name="ChkSubCfg"/>
<!--
      <If condition="IS_NOEQUAL_STRING($ClrNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政【,$PfaSub,】清算网点)</Set>
        <Return/>
      </If>
-->
      <Set>FilNam=STRCAT(PFA107,$TlrId,.RPT)</Set>
      <Set>FmtFil=etc/PFA107_RPT.XML</Set>
      <Set>DatFil=STRCAT($RptDir,$FilNam,.data)</Set>
      <Set>RptFil=STRCAT($RptDir,$FilNam)</Set>
      <Set>MinDat=STRCAT(SUBSTR($BegDat,1,4),0101)</Set>
      <Set>SqlDate1=STRCAT( between ',$BegDat,' and ',$EndDat,' )</Set>
      <Set>SqlDate2=STRCAT( between ',$MinDat,' and ',$EndDat,' )</Set>
<!--根据日期范围取值-->
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetQuoBokInf"/>
        <Arg name="CursorName" value="CURSOR_1"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Return/>
      </If>
      <Set>SeqNo=0</Set>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="w"/>
        <Arg name="Data"   value="[2]:BegDat="/>
        <Arg name="Data"   value="$BegDat"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="EndDat="/>
        <Arg name="Data"   value="$EndDat"/>
        <Arg name="Data"   value="|"/>
        <Arg name="ESCFMT" value="\\n"/>
      </Exec>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE">
          <Arg name="CursorName" value="CURSOR_1"/>
        </Exec>
        <If condition="~RetCod=100">
          <If condition="INTCMP($SeqNo,4,0)">
            <Break/>
          </If>
          <Else>
            <Exec func="PUB:CloseCursor" error="IGNORE">
              <Arg name="CursorName" value="CURSOR_1"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=没有满足条件的记录</Set>
            <Return/>
          </Else>
        </If>
<!--获取对应代码名称-->
        <If condition="IS_NOEQUAL_STRING($OBCusId,$BCusId)">
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCusInf"/>
          </Exec>
<!--写入基层单位汇总-->
          <If condition="INTCMP($SeqNo,4,0)">
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$DatFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="||||||||小计|"/>
              <Arg name="Data"   value="AMTFMT($BCurQuo)"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="AMTFMT($BTotQuo)"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="AMTFMT($BCurDtl)"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="AMTFMT($BTotDtl)"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="AMTFMT($BOddAmt)"/>
              <Arg name="Data"   value="|"/>
              <Arg name="ESCFMT"   value="\\n"/>
            </Exec>
<!--
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$DatFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="[3]:SeqNo=|"/>
              <Arg name="Data"   value="BCusNm=|"/>
              <Arg name="Data"   value="BCusId=|"/>
              <Arg name="Data"   value="AmtTyp=|"/>
              <Arg name="Data"   value="DptCod=|"/>
              <Arg name="Data"   value="SubCod=|"/>
              <Arg name="Data"   value="SubNam=|"/>
              <Arg name="Data"   value="PrjCod=|"/>
              <Arg name="Data"   value="PrjNam=小计|"/>
              <Arg name="Data"   value="CurQuo="/>
              <Arg name="Data"   value="$BCurQuo"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="TotQuo="/>
              <Arg name="Data"   value="$BTotQuo"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="CurDtl="/>
              <Arg name="Data"   value="$BCurDtl"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="TotDtl="/>
              <Arg name="Data"   value="$BTotDtl"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="OddAmt="/>
              <Arg name="Data"   value="$BOddAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="ESCFMT"   value="\\n"/>
            </Exec>
-->
            <Set>BCurQuo=0</Set>
            <Set>BTotQuo=0</Set>
            <Set>BCurDtl=0</Set>
            <Set>BTotDtl=0</Set>
            <Set>BOddAmt=0</Set>
<!--写入一级单位汇总-->
            <If condition="IS_NOEQUAL_STRING(SUBSTR($OBCusId,1,3),SUBSTR($BCusId,1,3))">
              <Exec func="PUB:WriteFile" error="IGNORE">
                <Arg name="FileName" value="$DatFil"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="||||||||部门合计|"/>
                <Arg name="Data"   value="AMTFMT($FCurQuo)"/>
                <Arg name="Data"   value="|"/>
                <Arg name="Data"   value="AMTFMT($FTotQuo)"/>
                <Arg name="Data"   value="|"/>
                <Arg name="Data"   value="AMTFMT($FCurDtl)"/>
                <Arg name="Data"   value="|"/>
                <Arg name="Data"   value="AMTFMT($FTotDtl)"/>
                <Arg name="Data"   value="|"/>
                <Arg name="Data"   value="AMTFMT($FOddAmt)"/>
                <Arg name="Data"   value="|"/>
                <Arg name="ESCFMT"   value="\\n"/>
              </Exec>
<!--
              <Exec func="PUB:WriteFile" error="IGNORE">
                <Arg name="FileName" value="$DatFil"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="[3]:SeqNo=|"/>
                <Arg name="Data"   value="BCusNm=|"/>
                <Arg name="Data"   value="BCusId=|"/>
                <Arg name="Data"   value="AmtTyp=|"/>
                <Arg name="Data"   value="DptCod=|"/>
                <Arg name="Data"   value="SubCod=|"/>
                <Arg name="Data"   value="SubNam=|"/>
                <Arg name="Data"   value="PrjCod=|"/>
                <Arg name="Data"   value="PrjNam=部门合计|"/>
                <Arg name="Data"   value="CurQuo="/>
                <Arg name="Data"   value="$FCurQuo"/>
                <Arg name="Data"   value="|"/>
                <Arg name="Data"   value="TotQuo="/>
                <Arg name="Data"   value="$FTotQuo"/>
                <Arg name="Data"   value="|"/>
                <Arg name="Data"   value="CurDtl="/>
                <Arg name="Data"   value="$FCurDtl"/>
                <Arg name="Data"   value="|"/>
                <Arg name="Data"   value="TotDtl="/>
                <Arg name="Data"   value="$FTotDtl"/>
                <Arg name="Data"   value="|"/>
                <Arg name="Data"   value="OddAmt="/>
                <Arg name="Data"   value="$FOddAmt"/>
                <Arg name="Data"   value="|"/>
                <Arg name="ESCFMT"   value="\\n"/>
              </Exec>
-->
              <Set>FCurQuo=0</Set>
              <Set>FTotQuo=0</Set>
              <Set>FCurDtl=0</Set>
              <Set>FTotDtl=0</Set>
              <Set>FOddAmt=0</Set>
            </If>
          </If>
          <Set>OBCusId=$BCusId</Set>
        </If>  
        <If condition="IS_NOEQUAL_STRING($OSubCod,$SubCod)">
          <Set>CodTyp=SUBCOD</Set>
          <Set>Code=$SubCod</Set>
          <Set>CodNam=SubNam</Set>
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCodInf"/>
          </Exec>
          <Set>OSubCod=$SubCod</Set>
        </If>  
        <If condition="IS_NOEQUAL_STRING($OPrjCod,$PrjCod)">
          <Set>CodTyp=PRJCOD</Set>
          <Set>Code=$PrjCod</Set>
          <Set>CodNam=PrjNam</Set>
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCodInf"/>
          </Exec>
          <Set>OPrjCod=$PrjCod</Set>
        </If>  
<!--统计本期下达-->
        <Set>SqlDate=$SqlDate1</Set>
        <Set>TxnFlg=0</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumQuoAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】本期增加金额失败)</Set>
          <Return/>
        </If>
        <Set>ICurQuo=$QuoAmt</Set>
        <Set>TxnFlg=1</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumQuoAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】本期减少金额失败)</Set>
          <Return/>
        </If>
        <Set>OCurQuo=$QuoAmt</Set>
        <Set>CurQuo=SUB($ICurQuo,$OCurQuo)</Set>
<!--统计本期支出-->
        <Set>OIFlag=O</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumDtlAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】本期支出金额失败)</Set>
          <Return/>
        </If>
        <Set>OCurDtl=$DtlAmt</Set>
        <Set>OIFlag=R</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumDtlAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】本期退回金额失败)</Set>
          <Return/>
        </If>
        <Set>ICurDtl=$DtlAmt</Set>
        <Set>CurDtl=SUB($OCurDtl,$ICurDtl)</Set>
<!--统计累计下达-->
        <Set>SqlDate=$SqlDate2</Set>
        <Set>TxnFlg=0</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumQuoAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】累计增加金额失败)</Set>
          <Return/>
        </If>
        <Set>ITotQuo=$QuoAmt</Set>
        <Set>TxnFlg=1</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumQuoAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】累计减少金额失败)</Set>
          <Return/>
        </If>
        <Set>OTotQuo=$QuoAmt</Set>
        <Set>TotQuo=SUB($ITotQuo,$OTotQuo)</Set>
<!--统计累计支出-->
        <Set>OIFlag=O</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumDtlAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】累计支持金额失败)</Set>
          <Return/>
        </If>
        <Set>OTotDtl=$DtlAmt</Set>
        <Set>OIFlag=R</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="SumDtlAmt"/>
        </Exec>  
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFA999</Set>
          <Set>RspMsg=STRCAT(统计预算单位【,$BCusId,】累计退回金额失败)</Set>
          <Return/>
        </If>
        <Set>ITotDtl=$DtlAmt</Set>
        <Set>TotDtl=SUB($OTotDtl,$ITotDtl)</Set>
<!--写入明细文件-->
        <Set>SeqNo=ADD($SeqNo,1)</Set>
        <Set>OddAmt=SUB($TotQuo,$TotDtl)</Set>
        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$DatFil"/>
          <Arg name="OpenMode" value="a+"/>
          <Arg name="Data"   value="$SeqNo"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="$BCusNm"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="$BCusId"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="$AmtTyp"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="$DptCod"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="$SubCod"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="$SubNam"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="$PrjCod"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="$PrjNam"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="AMTFMT($CurQuo)"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="AMTFMT($TotQuo)"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="AMTFMT($CurDtl)"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="AMTFMT($TotDtl)"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="AMTFMT($OddAmt)"/>
          <Arg name="Data"   value="|"/>
          <Arg name="ESCFMT"   value="\\n"/>
        </Exec>
<!--
        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$DatFil"/>
          <Arg name="OpenMode" value="a+"/>
          <Arg name="Data"   value="[3]:SeqNo="/>
          <Arg name="Data"   value="$SeqNo"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="BCusNm="/>
          <Arg name="Data"   value="$BCusNm"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="BCusId="/>
          <Arg name="Data"   value="$BCusId"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="AmtTyp="/>
          <Arg name="Data"   value="$AmtTyp"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="DptCod="/>
          <Arg name="Data"   value="$DptCod"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="SubCod="/>
          <Arg name="Data"   value="$SubCod"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="SubNam="/>
          <Arg name="Data"   value="$SubNam"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="PrjCod="/>
          <Arg name="Data"   value="$PrjCod"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="PrjNam="/>
          <Arg name="Data"   value="$PrjNam"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="CurQuo="/>
          <Arg name="Data"   value="$CurQuo"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="TotQuo="/>
          <Arg name="Data"   value="$TotQuo"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="CurDtl="/>
          <Arg name="Data"   value="$CurDtl"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="TotDtl="/>
          <Arg name="Data"   value="$TotDtl"/>
          <Arg name="Data"   value="|"/>
          <Arg name="Data"   value="OddAmt="/>
          <Arg name="Data"   value="$OddAmt"/>
          <Arg name="Data"   value="|"/>
          <Arg name="ESCFMT"   value="\\n"/>
        </Exec>
-->
        <Set>BCurQuo=ADD($BCurQuo,$CurQuo)</Set>
        <Set>BTotQuo=ADD($BTotQuo,$TotQuo)</Set>
        <Set>BCurDtl=ADD($BCurDtl,$CurDtl)</Set>
        <Set>BTotDtl=ADD($BTotDtl,$TotDtl)</Set>
        <Set>BOddAmt=ADD($BOddAmt,$OddAmt)</Set>
        <Set>FCurQuo=ADD($FCurQuo,$CurQuo)</Set>
        <Set>FTotQuo=ADD($FTotQuo,$TotQuo)</Set>
        <Set>FCurDtl=ADD($FCurDtl,$CurDtl)</Set>
        <Set>FTotDtl=ADD($FTotDtl,$TotDtl)</Set>
        <Set>FOddAmt=ADD($FOddAmt,$OddAmt)</Set>
        <Set>SumCurQuo=ADD($SumCurQuo,$CurQuo)</Set>
        <Set>SumTotQuo=ADD($SumTotQuo,$TotQuo)</Set>
        <Set>SumCurDtl=ADD($SumCurDtl,$CurDtl)</Set>
        <Set>SumTotDtl=ADD($SumTotDtl,$TotDtl)</Set>
        <Set>SumOddAmt=ADD($SumOddAmt,$OddAmt)</Set>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE">
        <Arg name="CursorName" value="CURSOR_1"/>
      </Exec>
<!--写入最后一次汇总-->
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="a+"/>
        <Arg name="Data"   value="||||||||小计|"/>
        <Arg name="Data"   value="AMTFMT($BCurQuo)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($BTotQuo)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($BCurDtl)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($BTotDtl)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($BOddAmt)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="a+"/>
        <Arg name="Data"   value="||||||||部门合计|"/>
        <Arg name="Data"   value="AMTFMT($FCurQuo)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($FTotQuo)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($FCurDtl)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($FTotDtl)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($FOddAmt)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="a+"/>
        <Arg name="Data"   value="||||||||总计|"/>
        <Arg name="Data"   value="AMTFMT($SumCurQuo)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($SumTotQuo)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($SumCurDtl)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($SumTotDtl)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="AMTFMT($SumOddAmt)"/>
        <Arg name="Data"   value="|"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec>
<!--
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="a+"/>
        <Arg name="Data"   value="[3]:SeqNo=|"/>
        <Arg name="Data"   value="BCusNm=|"/>
        <Arg name="Data"   value="BCusId=|"/>
        <Arg name="Data"   value="AmtTyp=|"/>
        <Arg name="Data"   value="DptCod=|"/>
        <Arg name="Data"   value="SubCod=|"/>
        <Arg name="Data"   value="SubNam=|"/>
        <Arg name="Data"   value="PrjCod=|"/>
        <Arg name="Data"   value="PrjNam=小计|"/>
        <Arg name="Data"   value="CurQuo="/>
        <Arg name="Data"   value="$BCurQuo"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="TotQuo="/>
        <Arg name="Data"   value="$BTotQuo"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="CurDtl="/>
        <Arg name="Data"   value="$BCurDtl"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="TotDtl="/>
        <Arg name="Data"   value="$BTotDtl"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="OddAmt="/>
        <Arg name="Data"   value="$BOddAmt"/>
        <Arg name="Data"   value="|"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="a+"/>
        <Arg name="Data"   value="[3]:SeqNo=|"/>
        <Arg name="Data"   value="BCusNm=|"/>
        <Arg name="Data"   value="BCusId=|"/>
        <Arg name="Data"   value="AmtTyp=|"/>
        <Arg name="Data"   value="DptCod=|"/>
        <Arg name="Data"   value="SubCod=|"/>
        <Arg name="Data"   value="SubNam=|"/>
        <Arg name="Data"   value="PrjCod=|"/>
        <Arg name="Data"   value="PrjNam=部门合计|"/>
        <Arg name="Data"   value="CurQuo="/>
        <Arg name="Data"   value="$FCurQuo"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="TotQuo="/>
        <Arg name="Data"   value="$FTotQuo"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="CurDtl="/>
        <Arg name="Data"   value="$FCurDtl"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="TotDtl="/>
        <Arg name="Data"   value="$FTotDtl"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="OddAmt="/>
        <Arg name="Data"   value="$FOddAmt"/>
        <Arg name="Data"   value="|"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="a+"/>
        <Arg name="Data"   value="[3]:SeqNo=|"/>
        <Arg name="Data"   value="BCusNm=|"/>
        <Arg name="Data"   value="BCusId=|"/>
        <Arg name="Data"   value="AmtTyp=|"/>
        <Arg name="Data"   value="DptCod=|"/>
        <Arg name="Data"   value="SubCod=|"/>
        <Arg name="Data"   value="SubNam=|"/>
        <Arg name="Data"   value="PrjCod=|"/>
        <Arg name="Data"   value="PrjNam=总计|"/>
        <Arg name="Data"   value="CurQuo="/>
        <Arg name="Data"   value="$SumCurQuo"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="TotQuo="/>
        <Arg name="Data"   value="$SumTotQuo"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="CurDtl="/>
        <Arg name="Data"   value="$SumCurDtl"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="TotDtl="/>
        <Arg name="Data"   value="$SumTotDtl"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="OddAmt="/>
        <Arg name="Data"   value="$SumOddAmt"/>
        <Arg name="Data"   value="|"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec>
      <Set>CurNum=AMTDELZERO($SeqNo)</Set>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="a+"/>
        <Arg name="Data"     value="[7]:CurNum="/> 
        <Arg name="Data"     value="$CurNum"/> 
        <Arg name="Data"     value="|"/>
        <Arg name="Data"     value="TlrId="/> 
        <Arg name="Data"     value="$TlrId"/> 
        <Arg name="Data"     value="|"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec> 
      <Exec func="PUB:GenerateReport" desc="根据转换后的文件生成报表">
        <Arg name="ObjFil" value="$RptFil"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="DatFil" value="$DatFil"/>
      </Exec>
-->
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="STRCAT($FilNam,.data)"/>
        <Arg name="Summary" value="区财政报表打印"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="461106" desc="区财政客户对账单打印">
    <Quote name="PfaSqlLst"/>
    <DynSentence name="GetRptPar">
      <Sentence>
        select distinct QuoId, AmtTyp, SubCod, PrjCod, DptCod from %s
         where PfaSub='%s' and year='%s' and BCusId='%s' and QuoSts!='0'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|Year|BCusId|</Fields>
    </DynSentence>
    <DynSentence name="GetTotQuo">
      <Sentence>
        select value( sum( ((-2)*bigint(Txnflg)+1)*bigint(quoamt) ),0 ) TotQuo
          from %s
         where PfaSub='%s' and year='%s' and BCusId='%s' and QuoSts!='0'
           and QuoId='%s' and AmtTyp='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s'
           and ActDat between '%s' and '%s'
      </Sentence>
      <Fields>QuoBokTbl|PfaSub|Year|BCusId|QuoId|AmtTyp|SubCod|PrjCod|DptCod|Dat1|Dat2|</Fields>
    </DynSentence>
    <DynSentence name="GetTotUse">
      <Sentence>
        select value( sum( bigint(UseAmt) ),0 ) UseAmt
          from %s
         where PfaSub='%s' and year='%s' and BCusId='%s' and OIFlag='%s'
           and QuoId='%s' and AmtTyp='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s'
           and ActDat between '%s' and '%s'
           and DtlSts='2'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|Year|BCusId|OIFlag|QuoId|AmtTyp|SubCod|PrjCod|DptCod|Dat1|Dat2|</Fields>
    </DynSentence>

    <DynSentence name="GetNClrAmt">
      <Sentence>
        select value( sum( bigint(UseAmt) ),0 ) UseAmt
          from %s
         where PfaSub='%s' and year='%s' and BCusId='%s' and OIFlag='%s'
           and QuoId='%s' and AmtTyp='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s'
           and ActDat between '%s' and '%s'
           and DtlSts='2' and ClrSts !='3'
      </Sentence>
      <Fields>VchDtlTbl|PfaSub|Year|BCusId|OIFlag|QuoId|AmtTyp|SubCod|PrjCod|DptCod|Dat1|Dat2|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetCusInf"/>
        </Args>
      </Exec>
      <If condition="IS_NOEQUAL_STRING($OpnNod,$NodNo)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFA999</Set>
        <Set>RspMsg=STRCAT(非财政单位【,$BCusId,】的账户开户行</Set>
        <Return/>
      </If>
      <Set>Year=SUBSTR($BegDat,1,4)</Set>
      <Switch expression="$RptTyp">
        <Case value="1"> <!-- 月度额度对账单 -->
          <Set>FmtFil=STRCAT(etc/,PFA203_RPT.XML)</Set>
          <Set>RptFil=STRCAT(PFA203,$TlrId,.RPT)</Set>
          <Set>DatFil=STRCAT($RptDir,$RptFil,.data)</Set>
<!--报表头-->
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$DatFil"/>
            <Arg name="OpenMode" value="w"/>
            <Arg name="Data"   value="[2]:PfaSub="/>
            <Arg name="Data"   value="$PfaSub"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="BCusId="/>
            <Arg name="Data"   value="$BCusId"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="BCusNm="/>
            <Arg name="Data"   value="$BCusNm"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="ActNo="/>
            <Arg name="Data"   value="$ActNo"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="ActNam="/>
            <Arg name="Data"   value="$ActNam"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="AmtTyp="/>
            <Arg name="Data"   value="$AmtTyp"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="BegDat="/>
            <Arg name="Data"   value="$BegDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="EndDat="/>
            <Arg name="Data"   value="$EndDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtDat="/>
            <Arg name="Data"   value="$ActDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtTlr="/>
            <Arg name="Data"   value="$TlrId"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtNod="/>
            <Arg name="Data"   value="$NodNo"/>
            <Arg name="Data"   value="|"/>
            <Arg name="ESCFMT" value="\\n"/>
          </Exec>
<!--通过游标获取报表参数(QuoId,AmtTyp,SubCod,PrjCod,DptCod),及对应年头到上月累计发放额-->
          <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="sql" value="GetRptPar"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFA999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
<!--计算本月下发额度【CTotQuo】-->
            <Set>Dat1=$BegDat</Set>
            <Set>Dat2=$EndDat</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotQuo"/>
              </Args>
            </Exec>
            <Set>CTotQuo=$TotQuo</Set>
<!--计算本月支出额度【CUseAmt】-->
            <Set>OIFlag=O</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotUse"/>
              </Args>
            </Exec>
            <Set>CO_Amt=$UseAmt</Set>
            <Set>OIFlag=R</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotUse"/>
              </Args>
            </Exec>
            <Set>CR_Amt=$UseAmt</Set>
            <Set>CUseAmt=SUB($CO_Amt,$CR_Amt)</Set>
<!--计算累计下发额度【LTotQuo】-->
            <Set>Dat1=STRCAT($Year,0101)</Set>
            <Set>Dat2=$EndDat</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotQuo"/>
              </Args>
            </Exec>
            <Set>LTotQuo=$TotQuo</Set>
<!--计算累计支出额度【CUseAmt】-->
            <Set>OIFlag=O</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotUse"/>
              </Args>
            </Exec>
            <Set>CO_Amt=$UseAmt</Set>
            <Set>OIFlag=R</Set>
            <Exec func="PUB:ReadRecord">
              <Args>
                <Arg name="SqlCmd" value="GetTotUse"/>
              </Args>
            </Exec>
            <Set>CR_Amt=$UseAmt</Set>
            <Set>LUseAmt=SUB($CO_Amt,$CR_Amt)</Set>
<!--计算结余额度【CQuoBal=下发全额-支出额】-->
            <Set>CQuoBal=SUB($LTotQuo,$LUseAmt)</Set>
<!--计算小计金额-->
            <Set>Tot_CTotQuo=ADD($Tot_CTotQuo,$CTotQuo)</Set>
            <Set>Tot_LTotQuo=ADD($Tot_LTotQuo,$LTotQuo)</Set>
            <Set>Tot_CUseAmt=ADD($Tot_CUseAmt,$CUseAmt)</Set>
            <Set>Tot_LUseAmt=ADD($Tot_LUseAmt,$LUseAmt)</Set>
            <Set>Tot_CQuoBal=ADD($Tot_CQuoBal,$CQuoBal)</Set>
<!--获取科目，项目，业务处室对应中文-->
            <Delete>SubNam</Delete>
            <Delete>PrjNam</Delete>
            <Set>CodTyp=SUBCOD</Set>
            <Set>Code=$SubCod</Set>
            <Set>CodNam=SubNam</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="GetCodInf"/>
            </Exec>
            <Set>CodTyp=PRJCOD</Set>
            <Set>Code=$PrjCod</Set>
            <Set>CodNam=PrjNam</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Arg name="SqlCmd" value="GetCodInf"/>
            </Exec>
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$DatFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="[3]:QuoId="/>
              <Arg name="Data"   value="$QuoId"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="AmtTyp="/>
              <Arg name="Data"   value="$AmtTyp"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubCod="/>
              <Arg name="Data"   value="$SubCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="SubNam="/>
              <Arg name="Data"   value="$SubNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjCod="/>
              <Arg name="Data"   value="$PrjCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="PrjNam="/>
              <Arg name="Data"   value="$PrjNam"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="DptCod="/>
              <Arg name="Data"   value="$DptCod"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="CTotQuo="/>
              <Arg name="Data"   value="$CTotQuo"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="LTotQuo="/>
              <Arg name="Data"   value="$LTotQuo"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="CUseAmt="/>
              <Arg name="Data"   value="$CUseAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="LUseAmt="/>
              <Arg name="Data"   value="$LUseAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="CQuoBal="/>
              <Arg name="Data"   value="$CQuoBal"/>
              <Arg name="Data"   value="|"/>
              <Arg name="ESCFMT" value="\\n"/>
            </Exec>
          </While>
<!--写入汇总记录-->
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$DatFil"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="Data"   value="[5]:Tot_CTotQuo="/>
            <Arg name="Data"   value="$Tot_CTotQuo"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="Tot_LTotQuo="/>
            <Arg name="Data"   value="$Tot_LTotQuo"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="Tot_CUseAmt="/>
            <Arg name="Data"   value="$Tot_CUseAmt"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="Tot_LUseAmt="/>
            <Arg name="Data"   value="$Tot_LUseAmt"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="Tot_CQuoBal="/>
            <Arg name="Data"   value="$Tot_CQuoBal"/>
            <Arg name="Data"   value="|"/>
            <Arg name="ESCFMT" value="\\n"/>
          </Exec>
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$DatFil"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="Data"   value="[7]:PrtDat="/>
            <Arg name="Data"   value="$ActDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtTlr="/>
            <Arg name="Data"   value="$TlrId"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="PrtNod="/>
            <Arg name="Data"   value="$NodNo"/>
            <Arg name="Data"   value="|"/>
            <Arg name="ESCFMT" value="\\n"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:GenerateReport">
            <Arg name="ObjFil" value="STRCAT($RptDir,$RptFil)"/>
            <Arg name="FmtFil" value="$FmtFil"/>
            <Arg name="DatFil" value="$DatFil"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 月度明细对账单 -->
          <Set>FmtFil=STRCAT(etc/,PFA212_RPT.XML)</Set>
          <Set>RptFil=STRCAT(PFA212,$TlrId,.RPT)</Set>
          <Set>RptNam=财政月度支付明细对账单</Set>
          <Exec func="EXT:GenerateReport">
            <Arg name="RptName" value="STRCAT($RptDir,$RptFil)"/>
            <Arg name="RptFile" value="$FmtFil"/>
            <Arg name="PfaSub"  value="$PfaSub"/>
            <Arg name="BCusId"  value="$BCusId"/>
            <Arg name="BCusNm"  value="$BCusNm"/>
            <Arg name="ActNo"   value="$ActNo"/>
            <Arg name="ActNam"  value="$ActNam"/>
            <Arg name="AmtTyp"  value="$AmtTyp"/>
            <Arg name="BegDat"  value="$BegDat"/>
            <Arg name="EndDat"  value="$EndDat"/>
            <Arg name="PrtDat"  value="$ActDat"/>
            <Arg name="PrtTlr"  value="$TlrId"/>
            <Arg name="PrtNod"  value="$NodNo"/>
          </Exec>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$RptFil"/>
        <Arg name="Summary" value="$RptNam"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>

</Application>
