<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="PCL" code="223">
  <LibDeclare>
    <Library name="PCL" value="dll/pcl.so"/>
  </LibDeclare>
  <ConfigDeclare>
    <Config name="PCLCSW"    value="etc/PCL_CSW.XML"/>
    <Config name="BatFormat" value="etc/PCL_FMT.XML"/>
  </ConfigDeclare>

  <TableDeclare>
    <Table name="PclCusAgt" value="PclCusAgt"/>
    <Table name="PclTxnDtl" value="PclTxnDtl"/>
    <Table name="PclAccJnl" value="PclAccJnl"/>
    <Table name="PclClrInf" value="PclClrInf"/>
    <Table name="PclTrmAgt" value="PclTrmAgt"/>
    <Table name="PclDTxnDtl" value="PclDTxnDtl"/>
    <Table name="PclITxnDtl" value="PclITxnDtl"/>
    <Table name="PclDFeeJnl" value="PclDFeeJnl"/>
    <Table name="PclFeeRat"  value="PclFeeRat"/>
  </TableDeclare>

  <BusDefDeclare>
    <Busdef name="AplCls"  value="223"/>
    <Busdef name="DPOSIP"  value="132.97.117.13"/>
    <Busdef name="DPOSUSR" value="jth"/>
    <Busdef name="DPOSPWD" value="jth"/>
    <Busdef name="DPOSPTH" value="ctb"/>

    <Busdef name="IPOSIP" value="182.53.4.227"/>
    <Busdef name="IPOSUSR" value="pos"/>
    <Busdef name="IPOSPWD" value="pos123"/>
    <Busdef name="IPOSPTH" value="data"/>
    
    <Busdef name="PclSndDir" value="dat/pcl/send/"/>
    <Busdef name="PclRcvDir" value="dat/pcl/recv/"/>
    
    <Busdef name="RptDir" value="dat/term/send/"/>
    <Busdef name="RcvDir" value="dat/term/recv/"/>
    <Busdef name="FeeSqn" value="XXXXX"/>
  </BusDefDeclare>

  <Define>
    <Include file="etc/PCL_MCR.XML"/>
  </Define>


  <Transaction code="462301" desc="商户入帐规则维护">
    <DynSentence name="QryCusAgr"> <!-- 查询 -->
      <Sentence>
        select Sts OSts, CusNam OCusNam, AccFlg OAccFlg, SysFlg OSysFlg, DeptNo ODeptNo, OpnBr OOpnBr, BankNo OBankNo,
               BankNm OBankNm, InAcNo OInAcNo, InAcNm OInAcNm, InMode OInMode, FeeRat OFeeRat, TopAmt OTopAmt,
               ValDt OValdt, Smr OSmr
          from PclCusAgt where PosTyp='%s' and BusiNo='%s' and OpnBr='%s'
      </Sentence>
      <Fields>PosTyp|BusiNo|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdCusAgr"> <!-- 修改 -->
      <Sentence>
        PosTyp='%s' and BusiNo='%s' and OpnBr='%s'
      </Sentence>
      <Fields>PosTyp|BusiNo|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="DelCusAgr"> <!-- 删除 -->
      <Sentence>
        delete from PclCusAgt where PosTyp='%s' and BusiNo='%s' and OpnBr='%s'
      </Sentence>
      <Fields>PosTyp|BusiNo|BrNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900),IS_NOEQUAL_STRING($FUNC,2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($FUNC,2)">
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="70"/>
          <Arg name="AthMsg" value="PCL000"/>
        </Exec>
        <Exec func="PUB:CheckLocalAuth" >
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="QryCusAgr"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Set>SysFlg=0</Set>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($BankNo,1,3),301)">
        <Set>SysFlg=1</Set> <!--非交行系统-->
      </If>
      <Switch expression="$FUNC">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
<!--设定东莞、揭阳、惠州的代理行为广东省-->
          <If condition="OR(IS_EQUAL_STRING($BrNo,483999),IS_EQUAL_STRING($BrNo,485999),IS_EQUAL_STRING($BrNo,491999),IS_EQUAL_STRING($BrNo,761999))">
            <Set>AgrBr=441999</Set>
          </If>
          <Else>
            <Set>AgrBr=$BrNo</Set>
          </Else>
<!--
          <Set>OpnBr=$BrNo</Set>
-->
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="PclCusAgt"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="PclCusAgt"/>
            <Arg name="CndSts" value="UpdCusAgr"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="DelCusAgr"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="462302" desc="商户入帐规则浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select * from PclCusAgt
          where PosTyp='%s' and ( BusiNo='%s' or '%s'='' ) and ( DeptNo='%s' or '%s'=' ' ) and ( OpnBr='%s' or '%s'=' ' )
          order by BusiNo, DeptNo, OpnBr
      </Sentence>
      <Fields>PosTyp|BusiNo|BusiNo|DeptNo|DeptNo|BrNo|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="GetRecDat">
      <Sentence>
        select * from PclCusAgt where PosTyp='%s' and BusiNo='%s'
      </Sentence>
      <Fields>PosTyp|BusiNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitProc"/>
      <Switch expression="$Func">
        <Case value="1">
          <If condition="INTCMP(STRLEN(DELSPACE($DeptNo,both)),4,0)">
            <If condition="OR(IS_EQUAL_STRING(SUBSTR($NodNo,4,3),900),IS_EQUAL_STRING(SUBSTR($NodNo,4,3),800))">
              <Set>DeptNo= </Set>
            </If>
            <Else>
              <Set>DeptNo=$NodNo</Set>
            </Else>
          </If>
          <If condition="OR(IS_EQUAL_STRING($NodNo,441900),IS_EQUAL_STRING($NodNo,441800))">
            <Set>BrNo= </Set> <!--广东省可查全辖-->
          </If>
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="GetRecDat"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>




  <Transaction code="462303" error="PUB:DeleteDiskNoAndRollback" desc="POS系统资金清算">
    <Quote name="PclSqlLst"/>
    <DynSentence name="UpdBatInf"> <!--修改本批次为确认状态，启动大小通道发送-->
      <Sentence>
        update PubBatInf set CCYCOD = 'CNY', OrnCnt ='%s', ORNAMT = '000000000000000', SUCCNT = '00000000', SUCAMT = '000000000000000', FALCNT = '00000000', FALAMT = '000000000000000', CHKFLG = '1' where DSKNO = '%s'
      </Sentence>
      <Fields>OrnCnt|DskNo|</Fields>
    </DynSentence>
    <DynSentence name="SumAgrCAmt"> <!-- 判断银联清算金额是否与导入清算数据一致（贷方） -->
      <Sentence>
        select value(sum(bigint(ClearAmt)),0) AgrCAmt
          from PclTxnDtl where CtrPostDate='%s' and AgrBr='%s' and CdFlag='C' and Sts='0'
      </Sentence>
      <Fields>ClrDat|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="SumAgrDAmt"> <!-- 判断银联清算金额是否与导入清算数据一致（借方） -->
      <Sentence>
        select value(sum(bigint(ClearAmt)),0) AgrDAmt
          from PclTxnDtl where CtrPostDate='%s' and AgrBr='%s' and CdFlag='D' and Sts='0'
      </Sentence>
      <Fields>ClrDat|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="SumOpnCAmt"> <!-- 判断内部帐余额（贷方） -->
      <Sentence>
        select value(sum(bigint(ClearAmt)),0) OpnCAmt
          from PclTxnDtl where CtrPostDate='%s' and OpnBr='%s' and CdFlag='C' and Sts='0'
      </Sentence>
      <Fields>ClrDat|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="SumOpnDAmt"> <!-- 判断内部帐余额（借方） -->
      <Sentence>
        select value(sum(bigint(ClearAmt)),0) OpnDAmt
          from PclTxnDtl where CtrPostDate='%s' and OpnBr='%s' and CdFlag='D' and Sts='0'
      </Sentence>
      <Fields>ClrDat|BrNo|</Fields>
    </DynSentence>

    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="AND(IS_EQUAL_STRING($Func,01),OR(IS_EQUAL_STRING($BrNo,483999),IS_EQUAL_STRING($BrNo,485999),IS_EQUAL_STRING($BrNo,491999),IS_EQUAL_STRING($BrNo,761999)))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=分行无此权限</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($BrNo,441999),OR(IS_EQUAL_STRING($Func,04),IS_EQUAL_STRING($Func,05)))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=非代理分行</Set>
        <Return/>
      </If>
      <Switch expression="$Func">
        <Case value="01"> <!--POS系统清算数据导入-->
          <Exec func="PUB:AddAuthReason">
            <Arg name="AthCod" value="30"/>
            <Arg name="AthMsg" value="PCL000"/>
          </Exec>
          <Exec func="PUB:CheckLocalAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="02"> <!--消费清算-->
          <Set>ActNo=$ClrAct</Set>
          <Exec func="PUB:CallHostAcc">
            <Arg name="HTxnCd" value="098061"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Break/>
        </Default>
      </Switch>
<!--通过加锁避免柜员重复操作-->
      <If condition="OR(IS_EQUAL_STRING($Func,01),IS_EQUAL_STRING($Func,02))">
        <Exec func="PUB:Lock" error="IGNORE">
          <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=上一操作处理尚未完成，请稍后再做</Set>
          <Return/>
        </If>
      </If>
<!--判断清算状态-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetClrInf"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,3,-1)">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=查询表【PclClrInf】失败</Set>
        <Return/>
      </If>
<!--清算记录不存在，根据交易功能决定流程-->
      <If condition="INTCMP(~RetCod,3,-2)">
        <Switch expression="$FUNC">
          <Case value="01"> <!--数据读入-->
            <Set>SysSts=0</Set>
            <Exec func="PUB:InsertRecord">
              <Arg name="TblNam" value="PclClrInf"/>
            </Exec>
            <Break/>
          </Case>
          <Case value="02"/> <!--消费清算-->
          <Case value="03"/> <!--退货清算-->
          <Case value="04"/> <!--打印成功清单-->
          <Case value="05">  <!--打印失败清单-->
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=STRCAT(无【,$ClrDat,】银联POS数据)</Set>
            <Return/>
          </Case>
        </Switch>
      </If>
<!--清算记录存在、判断状态-->
      <If condition="INTCMP(~RetCod,3,0)">
        <Switch expression="$FUNC">
          <Case value="01"> <!--数据读入-->
            <Switch expression="$SysSts">
              <Case value="0"/>   <!--读入未成功-->
              <Case value="1">    <!--读入已成功-->
                <Exec func="PUB:ExecSql" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="DelTxnDtl"/>
                  </Args>
                </Exec>
                <If condition="~RetCod=-1">
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PCL999</Set>
                  <Set>RspMsg=清除数据失败</Set>
                  <Return/>
                </If>
                <Set>SysSts=0</Set>   <!--更新状态为"清算数据读入"-->
                <Exec func="PUB:UpdateRecord">
                  <Arg name="TblNam" value="PclClrInf"/>
                  <Arg name="CndSts" value="UpdClrInf"/>
                </Exec>
                <Exec func="PUB:CommitWork"/>  <!--清算数据不需回滚-->
                <Break/>
              </Case>
              <Case value="2"/>   <!--退货清算正在进行-->
              <Case value="3"/>   <!--退货清算完成-->
              <Case value="4"/>   <!--消费清算正在进行-->
              <Case value="5">    <!--消费清算完成-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=数据已开始清算，不能重复读入</Set>
                <Return/>
              </Case>
            </Switch>
            <If condition="IS_EQUAL_STRING($FilSrc,02)">  <!--远程获取文件-->
              <Switch expression="$BrNo">
                <Case value="444999">
                  <Set>ObjPth=STRCAT(/u/,gnetgcc/)</Set>
                  <Break/>
                </Case>
                <Case value="446999">
                  <Set>ObjPth=STRCAT(steps/gnet_report/,$ClrDat)</Set>
                  <Break/>
                </Case>
              </Switch>
              <Set>ObjFil=STRCAT(OP,SUBSTR($ClrDat,3,6),.,new)</Set>
              <Set>FilNam=TOUPPER(STRCAT($ObjFil,.,$BrNo))</Set>
              <Set>LclFil=$FilNam</Set>
              <Exec func="PUB:FtpGet" error="IGNORE">
                <Arg name="FtpId" value="PCL001"/>
              </Exec>
              <If condition="~RetCod!=0">
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=获取POS清算文件失败</Set>
                <Return/>
              </If>
            </If>
            <System command="PosFileChg.sh" error="IGNORE">
              <Arg name="POSFN" value="$FilNam"></Arg>
            </System>
            <Set>DBFileNam=STRCAT(dat/term/recv/,$FilNam)</Set>
            <Exec func="PCL:PCLFileToDb" error="IGNORE" >
              <Args>
                <Arg name="ClrDat"   value="$ClrDat"/> 
                <Arg name="FileName" value="$DBFileNam"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Set>FmtFil=STRCAT(etc/,PCL001_RPT.XML)</Set>
              <Set>FilNam=STRCAT(PCL001,$TlrId,.RPT)</Set>
              <Set>Summary=STRCAT(POS数据导入出错清单,$ActDat)</Set>
              <Quote name="RptProc"/>
              <Exec func="PUB:RollbackWork"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=数据导入失败，请查看出错清单</Set>
              <Return/>
            </If>
<!--检查清算金额是否与银联一致-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="SumAgrCAmt"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=计算贷方清算总额失败</Set>
              <Return/>
            </If>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="SumAgrDAmt"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=计算借方清算总额失败</Set>
              <Return/>
            </If>
            <If condition="INTCMP(SUB($AgrCAmt,$AgrDAmt),4,$TotAmt)">
              <Exec func="PUB:RollbackWork"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=STRCAT(清算额与银联不一致,【,AMTFMT($TotAmt),】【,AMTFMT(SUB($AgrCAmt,$AgrDAmt)),】)</Set>
              <Return/>
            </If>
<!--生成按分行的清算清单-->
            <Set>FmtFil=STRCAT(etc/,PCL002_RPT.XML)</Set>
            <Set>FilNam=STRCAT(PCL002,$TlrId,.RPT)</Set>
            <Set>Summary=STRCAT(POS辖属行清算清单,$ActDat)</Set>
            <Set>SysSts=1</Set>   <!--更新状态为"读入成功"-->
            <Exec func="PUB:UpdateRecord">
              <Arg name="TblNam" value="PclClrInf"/>
              <Arg name="CndSts" value="UpdClrInf"/>
            </Exec>
            <Break/>
          </Case>
          <Case value="02"> <!-- 消费清算 -->
            <Switch expression="$SysSts">
              <Case value="0">   <!--读入未成功-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=银联POS数据读入未成功，请重新读入</Set>
                <Return/>
              </Case>
              <Case value="2"/>   <!--消费清算正在进行-->
              <Case value="3"/>   <!--消费清算完成-->
              <Case value="4"/>   <!--退货清算正在进行-->
              <Case value="5">   <!--退货清算完成-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=消费清算已执行，不能重做</Set>
                <Return/>
              </Case>
              <Case value="1">    <!--读入已成功-->
<!--判断内部帐余额与消费清算额、不足提示补充退货金额-->
                <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="SumOpnCAmt"/>
                  </Args>
                </Exec>
                <If condition="~RetCod=-1">
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PCL999</Set>
                  <Set>RspMsg=STRCAT(计算【,$BrNo,】分行贷方清算总额失败)</Set>
                  <Return/>
                </If>
                <If condition="INTCMP($OpnCAmt,6,$CBal)">
                  <Exec func="PUB:RollbackWork"/>
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PCL999</Set>
                  <Set>RspMsg=STRCAT(内部帐户余额不足，差额【,AMTFMT(SUB($OpnCAmt,$CBal)),】)</Set>
                  <Return/>
                </If>
                <If condition="INTCMP($OpnCAmt,6,0)">
                  <Set>HTxnCd=462399</Set>
                  <Set>FTxnCd=462398</Set>
                  <Set>SysSts=2</Set>
                  <Set>CdFlag=C</Set>
                  <Quote name="BokProc"/>
                </If>
                <Else>
                  <Set>SysSts=3</Set>
                  <Exec func="PUB:UpdateRecord">
                    <Arg name="TblNam" value="PclClrInf"/>
                    <Arg name="CndSts" value="UpdClrInf"/>
                  </Exec>
                </Else>
                <Break/>
              </Case>
            </Switch>
            <Break/>
          </Case>
          <Case value="03"> <!-- 退货清算 -->
            <Switch expression="$SysSts">
              <Case value="0">   <!--读入未成功-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=银联POS数据读入未成功，请重新读入</Set>
                <Return/>
              </Case>
              <Case value="1"/>    <!--读入已成功-->
              <Case value="2">   <!--退货清算正在进行-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=消费清算未完成，不能做</Set>
                <Return/>
              </Case>
              <Case value="4"/>   <!--退货清算正在进行-->
              <Case value="5">   <!--退货清算完成-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=退货清算已执行，不能重做</Set>
                <Return/>
              </Case>
              <Case value="3">   <!--消费清算完成-->
<!--判断是否需要清算退库业务：如果要，通过大小通道完成处理，否则直接更新清算表状态-->
                <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="SumOpnDAmt"/>
                  </Args>
                </Exec>
                <If condition="~RetCod=-1">
                  <Exec func="PUB:RollbackWork"/>
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PCL999</Set>
                  <Set>RspMsg=STRCAT(计算【,$BrNo,】分行借方清算总额失败)</Set>
                  <Return/>
                </If>
                <If condition="INTCMP($OpnDAmt,6,0)">
                  <Set>HTxnCd=462399</Set>
                  <Set>FTxnCd=462398</Set>
                  <Set>SysSts=4</Set>
                  <Set>CdFlag=D</Set>
                  <Quote name="BokProc"/>
                </If>
                <Else>
                  <Set>SysSts=5</Set>
                  <Exec func="PUB:UpdateRecord">
                    <Arg name="TblNam" value="PclClrInf"/>
                    <Arg name="CndSts" value="UpdClrInf"/>
                  </Exec>
                </Else>
                <Break/>
              </Case>
            </Switch>
            <Break/>
          </Case>
          <Case value="04"> <!-- 代理分行POS入帐流水清单 -->
            <If condition="IS_NOEQUAL_STRING($SysSts,5)">
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=银联POS清算未完成</Set>
              <Return/>
            </If>
            <Exec func="PCL:PCLDtlToRpt" error="IGNORE">
              <Args>
                <Arg name="ClrDat" value="$ClrDat"/> 
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Return/>
            </If>
            <Set>FmtFil=STRCAT(etc/,PCL003_RPT.XML)</Set>
            <Set>FilNam=STRCAT(PCL003,$TlrId,.RPT)</Set>
            <Set>Summary=STRCAT(POS入帐流水清单,$ActDat)</Set>
            <Break/>
          </Case>
          <Case value="05"> <!-- 代理分行POS记帐出错清单 -->
            <If condition="IS_NOEQUAL_STRING($SysSts,5)">
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=银联POS清算未完成</Set>
              <Return/>
            </If>
            <Set>FmtFil=STRCAT(etc/,PCL004_RPT.XML)</Set>
            <Set>FilNam=STRCAT(PCL004,$TlrId,.RPT)</Set>
            <Set>Summary=STRCAT(POS入帐出错清单,$ActDat)</Set>
            <Break/>
          </Case>
          <Default>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=系统错误</Set>
            <Return/>
          </Default>
        </Switch>
        <If condition="AND(IS_NOEQUAL_STRING($Func,02),IS_NOEQUAL_STRING($Func,03))">
          <Quote name="RptProc"/>
        </If>
      </If>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>




  <Transaction code="462304" desc="POS系统报表打印">
    <Quote name="PclSqlLst"/>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
<!--判断清算状态-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetClrInf"/>
        </Args>
      </Exec>
      <If condition="OR(INTCMP(~RetCod,4,0),IS_NOEQUAL_STRING($SysSts,5))">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=银联POS清算未完成</Set>
        <Return/>
      </If>
      <Set>DT=SUBSTR($ClrDat,5,4)</Set>
      <Switch expression="$Func">
        <Case value="01"> <!-- POS入帐流水清单 -->
          <Set>FmtFil=STRCAT(etc/,PCL005_RPT.XML)</Set>
          <Set>FilNam=STRCAT(PCL005,$TlrId,.RPT)</Set>
          <Set>Summary=STRCAT(POS入帐流水清单,$ActDat)</Set>
          <Break/>
        </Case>
        <Case value="02"> <!-- POS记帐出错清单 -->
          <Set>FmtFil=STRCAT(etc/,PCL006_RPT.XML)</Set>
          <Set>FilNam=STRCAT(PCL006,$TlrId,.RPT)</Set>
          <Set>Summary=STRCAT(POS入帐出错清单,$ActDat)</Set>
          <Break/>
        </Case>
        <Case value="03"> <!-- POS特种传票 -->
          <Set>FmtFil=STRCAT(etc/,PCL010_RPT_,$BrNo,.XML)</Set>
          <Set>FilNam=STRCAT(PCL010,$BrNo,$TlrId,.RPT)</Set>
          <Set>Summary=STRCAT(POS特种传票,$ActDat)</Set>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Quote name="RptProc"/>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="462305" desc="POS系统凭证打印">
    <Quote name="PclSqlLst"/>
    <DynSentence name="QryMerId">   <!-- 查询指定网点的商户号 -->
      <Sentence>
        select distinct MerId from PclAccJnl
         where CtrPostDate='%s'
           and OpnBr='%s'
           and ( MerId='%s' or '%s'='' )
           and DeptNo='%s'
           and HRspCd='SC0000'
      </Sentence>
      <Fields>ClrDat|BrNo|MerId|MerId|NodNo|</Fields>
    </DynSentence>
    <DynSentence name="GetCusAgr">   <!-- 查询 -->
      <Sentence>
        select CusNam from PclCusAgt where BusiNo = '%s'
      </Sentence>
      <Fields>MERID|</Fields>
    </DynSentence>
    <DynSentence name="UpdSNum">   <!-- 修改收款通知书打印次数 -->
      <Sentence>
        update PclTxnDtl set RPrtNum = char( int(RPrtNum) + 1 ) where CtrPostDate='%s' and ( MERID = '%s' or '%s' = '' ) and OpnBr='%s' and Sts = '1' and DeptNo = '%s'
      </Sentence>
      <Fields>ClrDat|MERID|MERID|BrNo|NodNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdRNum">   <!-- 修改付款通知书打印次数 -->
      <Sentence>
        update PclTxnDtl set SPrtNum = char( int(SPrtNum) + 1 ) where CtrPostDate='%s' and ( MERID = '%s' or '%s' = '' ) and OpnBr='%s' and Sts = '1' and DeptNo = '%s'
      </Sentence>
      <Fields>ClrDat|MERID|MERID|BrNo|NodNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
<!--添加授权原因 -->
      <Exec func="PUB:AddAuthReason">
        <Arg name="AthCod" value="20"/>
        <Arg name="AthMsg" value="PCL000"/>
      </Exec>
      <Exec func="PUB:CheckLocalAuth" >
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
<!--判断清算状态-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetClrInf"/>
        </Args>
      </Exec>
      <If condition="OR(INTCMP(~RetCod,4,0),IS_NOEQUAL_STRING($SysSts,5))">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=银联POS清算未完成</Set>
        <Return/>
      </If>
      <Switch expression="$FUNC">
        <Case value="01">                <!--POS收款通知书-->
          <Set>FmtFil=STRCAT(etc/,PCL007_RPT.XML)</Set>
          <Set>FilNam=STRCAT(PCL007,$TlrId,.RPT)</Set>
          <Set>Summary=STRCAT(POS收款通知书,$ActDat)</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdRNum"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=修改收款通知书打印次数失败</Set>
            <Return/>
          </If>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=没有满足条件的记录UpdSNum</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Case value="02">                 <!--POS付款通知书-->
          <Set>FmtFil=STRCAT(etc/,PCL008_RPT.XML)</Set>
          <Set>FilNam=STRCAT(PCL008,$TlrId,.RPT)</Set>
          <Set>Summary=STRCAT(POS付款通知书,$ActDat)</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdSNum"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=修改付款通知书打印次数失败</Set>
            <Return/>
          </If>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=没有满足条件的记录UpdSNum</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Case value="03">                 <!--POS交易明细-->
          <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="sql" value="QryMerId"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
          <Set>TotNum=0</Set>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
              <If condition="INTCMP($TotNum,3,0)">
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=没有满足条件的记录</Set>
                <Exec func="PUB:CloseCursor" error="IGNORE"/>
                <Return/>
              </If>
              <Else>
                <Break/>
              </Else>  
            </If>
            <Set>TotNum=ADD($TotNum,1)</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="GetCusAgr"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=数据库查询失败</Set>
              <Return/>
            </If>
            <If condition="~RetCod=-2">
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=没有满足条件的记录</Set>
              <Return/>
            </If>
            <Set>FmtFil=STRCAT(etc/,PCL009_RPT.XML)</Set>
            <Set>FilNam=STRCAT(PCL009_,$MerId,_,$ClrDat,_,$BrNo,.RPT)</Set>
            <Set>Summary=STRCAT(POS客户交易明细,$ActDat)</Set>
            <If condition="IS_EQUAL_STRING($PrtTyp,01)">
              <Set>PrtFlg=4</Set>
            </If>
            <Else>
              <Set>PrtFlg=3</Set>
            </Else>
            <Quote name="VchProc"/>
          </While>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=无此功能代码</Set>
          <Break/>
        </Default>
      </Switch>
      <If condition="IS_NOEQUAL_STRING($FUNC,03)">
        <Set>PrtFlg=4</Set>
        <Quote name="VchProc"/>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="462306" desc="特约商户入帐规则批量维护">
    <DynSentence name="ChkExist">
      <Sentence>
        select 'Y' YN FROM TABLE(VALUES(1)) AS anony where EXISTS ( select 'Y' from PclCusAgt where BusiNo='%s' )
      </Sentence>
      <Fields>BusiNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitProc"/>
      <Set>ErrFil=STRCAT($RptDir,PCL016,$TlrId,.RPT.data)</Set>
      <Set>RptFil=STRCAT(PCL016,$TlrId,.RPT)</Set>
      <Set>DatFil=STRCAT(GETENV(WORKDIR),/,$RcvDir,$FilNam)</Set>
      <Exec func="PUB:IsValidFile" error="IGNORE">
        <Arg name="FileName" value="STRCAT($RcvDir,$FilNam)"/>
      </Exec>
      <If condition="OR( INTCMP($FilByt,3,0), INTCMP(~RetCod,4,0) )">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=STRCAT(文件【,$FilNam,】字节数为0或不完整)</Set>
        <Return/>
      </If>
      <Exec func="PUB:OpenFile">
        <Arg name="FileName"   value="$DatFil"/>
        <Arg name="Mode"       value="r"/>
      </Exec>
      <Exec func="PUB:InitDataParser">
        <Arg name="ConfigName" value="BatFormat"/>
        <Arg name="RootName"   value="BATCH"/>
      </Exec>
<!--设置成功结束标志，用于清理数据文件的标志-->
      <Set>EndFlg=0</Set>
      <Set>FilLin=0</Set>
      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$ErrFil"/>
        <Arg name="OpenMode" value="w"/>
        <Arg name="Data"   value="[2]:FilNam="/>
        <Arg name="Data"   value="$FilNam"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="ActDat="/>
        <Arg name="Data"   value="$ActDat"/>
        <Arg name="Data"   value="|"/>
        <Arg name="Data"   value="TlrId="/>
        <Arg name="Data"   value="$TlrId"/>
        <Arg name="Data"   value="|"/>
        <Arg name="ESCFMT" value="\\n"/>
      </Exec>
      <While>
        <Set>FilLin=ADD($FilLin,1)</Set>
        <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
          <Arg name="ConfigName" value="BatFormat"/>
          <Arg name="RootName"   value="BATCH"/>
          <Arg name="NodeName"   value="Process"/>
          <Arg name="AttrName"   value="name"/>
          <Arg name="AttrValue"  value="PclCusAgt"/>
          <Arg name="MaxLen"     value="100000"/>
        </Exec>
<!--只要处理出错或完成，均继续下一处理-->
        <If condition="INTCMP(~RetCod,4,0)">
          <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,-2))"> <!--失败-->
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=STRCAT(文件【,$FilNam,】第【,$FilLin,】行处理失败)</Set>
            <Exec func="PUB:CloseFile"/>
            <Return/>
          </If>
          <Break/>
        </If>
<!--判断是否存在重复记录，并忽略重复记录-->
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="ChkExist"/>
          </Args>
        </Exec>
        <If condition="INTCMP(~RetCod,3,-1)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=STRCAT(文件【,$FilNam,】第【,$FilLin,】行查询数据失败)</Set>
          <Exec func="PUB:CloseFile"/>
          <Break/>
        </If>
        <If condition="INTCMP(~RetCod,3,0)">
          <Set>Result=商户资料已存在</Set>
          <Quote name="ErrProc"/>
        </If>
<!--系统内客户核对户名-->
        <If condition="IS_EQUAL_STRING($SysFlg,0)">
          <Set>OCusNam=$CusNam</Set>
          <Set>ActNo=$InAcNo</Set>
          <If condition="IS_EQUAL_STRING($AccFlg,0)">
            <Set>HTxnCd=109000</Set>
          </If>
          <Else>
            <Set>HTxnCd=476520</Set>
            <Set>CcyCod=CNY</Set>
            <If condition="IS_EQUAL_STRING($AccFlg,1)">
              <Set>ActTyp=2</Set>
            </If>
            <Else>
              <Set>ActTyp=4</Set>
            </Else>
          </Else>
          <Exec func="PUB:CallHostAcc">
            <Arg name="HTxnCd" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Set>Result=核对主机客户户名通讯异常或资料不存在</Set>
            <Quote name="ErrProc"/>
          </If>
          <If condition="OR(AND(IS_EQUAL_STRING($AccFlg,0),IS_NOEQUAL_STRING($InAcNm,DELSPACE($ActNam,all))),AND(OR(IS_EQUAL_STRING($AccFlg,1),IS_EQUAL_STRING($AccFlg,2)),IS_NOEQUAL_STRING($InAcNm,DELSPACE($CusNam,all))))">
            <Set>Result=核对主机客户户名不符</Set>
            <Quote name="ErrProc"/>
          </If>
          <Set>CusNam=$OCusNam</Set>
        </If>
        <Exec func="PUB:InsertRecord" error="IGNORE">
          <Arg name="TblNam" value="PclCusAgt"/>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Set>Result=商户资料不足或有非法字符</Set>
          <Quote name="ErrProc"/>
        </If>
        <Exec func="PUB:CommitWork"/>
      </While>
      <Exec func="PUB:CloseFile"/>
      <If condition="IS_EQUAL_STRING($EndFlg,1)">
        <Set>FmtFil=STRCAT(etc/,PCL016_RPT.XML)</Set>
        <Exec func="PUB:GenerateReport">
          <Arg name="ObjFil" value="STRCAT($RptDir,$RptFil)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="DatFil" value="$ErrFil"/>
        </Exec>
        <Exec func="PUB:SendFileMessage2">
          <Arg name="MsgTyp"  value="4"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="46"/>
          <Arg name="AplCod"  value="$TxnCod"/>
          <Arg name="FilNam"  value="$RptFil"/>
          <Arg name="Summary" value="商户批量维护错误清单"/>
          <Arg name="ObjTlr"  value="$TlrId"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=STRCAT(文件【,$FilNam,】入库异常，请查看错误报表)</Set>
        <Return/>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="462307" desc="单笔抹帐交易">
    <DynSentence name="GetAccJnl">
      <Sentence>
        select LogNo, HLogNo OHLogNo, TlrId, TckNo OTckNo, TTxnCd OTTxnCd, HTxnCd OHTxnCd from PclAccJnl
          where CtrPostDate='%s' and MerId='%s' and TckNo='%s' and ActDat='%s'
      </Sentence>
      <Fields>ClrDat|MerId|TckNo|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="UpdTxnDtl">
      <Sentence>
        update PclTxnDtl set Sts='H' where CtrPostDate='%s' and MerId='%s' and TckNo='%s' 
      </Sentence>
      <Fields>ClrDat|MerId|TckNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetAccJnl"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="~RetCod=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=该笔交易不存在</Set>
        <Return/>
      </If>
      <Set>TIATyp=C</Set>
      <Set>HTxnCd=STRCAT(SUBSTR($OHTxnCd,1,5),9)</Set>
      <Exec func="PUB:CallHostAcc" error="IGNORE">  <!--上主机系统抹账 -->
        <Arg name="HTxnCd" value="959999"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="OR(IS_EQUAL_STRING($HRspCd,AG8001),IS_EQUAL_STRING($HRspCd,AG8981),IS_EQUAL_STRING($HRspCd,SC6129),IS_EQUAL_STRING($HRspCd,SC6034),IS_EQUAL_STRING($HRspCd,SC0000))">
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="UpdTxnDtl"/>
          </Args>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=更新流水表失败</Set>
          <Return/>
        </If>
        <Set>MsgTyp=N</Set>
        <Set>HRspCd=000000</Set>
        <Set>RspMsg=抹帐成功</Set>
      </If>
      <Set>RspCod=$HRspCd</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>



  <Transaction code="462311" desc="POS转帐资料维护">
    <DynSentence name="GetTrmAgt"> <!-- 查询 -->
      <Sentence>
        select TrmTyp OTrmTyp, CusNam OCusNam, InAcNo OInAcNo, InAcNm OInAcNm, MobTel OMobTel, Addr OAddr,
               FeeMod OFeeMod, FeeRat OFeeRat, FeeAmt OFeeAmt,TFeeMod OTFeeMod, TFeeRat OTFeeRat, TFeeAmt OTFeeAmt,
               Sts OSts
          from PclTrmAgt where PosTyp='%s' and MerId='%s' and TermId='%s' and OpnBr='%s'
      </Sentence>
      <Fields>PosTyp|MerId|TermId|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdTrmAgt"> <!--修改-->
      <Sentence>
        PosTyp='%s' and MerId='%s' and TermId='%s' and OpnBr='%s'
      </Sentence>
      <Fields>PosTyp|MerId|TermId|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="DelTrmAgt"> <!--删除-->
      <Sentence>
        delete from PclTrmAgt where PosTyp='%s' and MerId='%s' and TermId='%s' and OpnBr='%s'
      </Sentence>
      <Fields>PosTyp|MerId|TrmTyp|TermId|BrNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING($FUNC,2)">
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="70"/>
          <Arg name="AthMsg" value="PCL000"/>
        </Exec>
        <Exec func="PUB:CheckLocalAuth" >
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
<!--根据手机号码获取手机类型-->
      <If condition="OR(IS_EQUAL_STRING($Func,0), IS_EQUAL_STRING($Func,1))">
        <Set>Mob=SUBSTR($MobTel,1,3)</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="PCLCSW"/>
          <Arg name="SourNam" value="Mob"/>
          <Arg name="DestNam" value="UniNo"/>
          <Arg name="TblNam"  value="MobToUniNo"/>
        </Exec>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetTrmAgt"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=STRCAT(查询表【PclTrmAgt】失败)</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($Func,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Switch expression="$Func">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
          <Set>DeptNo=$NodNo</Set>
          <Set>OpnBr=$BrNo</Set>
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="PclTrmAgt"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="PclTrmAgt"/>
            <Arg name="CndSts" value="UpdTrmAgt"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="DelTrmAgt"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>Msg1=STRCAT(转帐POS资料维护:功能[,$Func,]商户类型[,$PosTyp,]商户号[,$MerId,],终端号[,$TermId,]清算帐号[,$InAcNo,])</Set>
      <Set>Msg2=STRCAT(手续费模式[,$FeeMod,]费率[,$FeeRat,],额度[,$FeeAmt,]天讯模式[,$TFeeMod,]费率[,$TFeeRat,],额度[,$TFeeAmt,])</Set>
      <Set>Msg3=STRCAT(维护网点[,$NodNo,]柜员[,$TlrId,])</Set>
      <Set>NoteInfo=STRCAT($Msg1,$Msg2,$Msg3)</Set>
      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="455130"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>




  <Transaction code="462312" desc="转帐POS资料浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select PosTyp, MerId, TrmTyp, TermId, CusNam, InAcNo, InAcNm, MobTel, FeeMod, FeeRat, FeeAmt, TFeeMod, TFeeRat, TFeeAmt, OpnBr, Sts
          from PclTrmAgt
          where PosTyp='%s' and ( MerId='%s' or '%s'='' ) and TrmTyp='%s' and ( TermId='%s' or '%s'='' ) and ( OpnBr='%s' or '%s'=' ' )
          order by MerId, TermId, OpnBr
      </Sentence>
      <Fields>PosTyp|MerId|MerId|TrmTyp|TermId|TermId|BrNo|BrNo|</Fields>
    </DynSentence>

    <DynSentence name="GetRecDat">
      <Sentence>
        select * from PclTrmAgt where PosTyp='%s' and MerId='%s' and TrmTyp='%s' and TermId='%s'
      </Sentence>
      <Fields>PosTyp|MerId|TrmTyp|TermId|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitProc"/>
      <Switch expression="$Func">
        <Case value="1">
          <If condition="OR(IS_EQUAL_STRING($NodNo,441900),IS_EQUAL_STRING($NodNo,441800))">
            <Set>BrNo= </Set> <!--广东省可查全辖-->
          </If>
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="GetRecDat"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>




  <Transaction code="462313" error="PUB:DeleteDiskNoAndRollback" desc="转帐POS资金清算">
    <Quote name="PclSqlLst"/>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <FlowCtrl>
      <Quote name="InitProc"/>
<If condition="OR(IS_EQUAL_STRING($Func,03),IS_EQUAL_STRING($Func,04))">
  <Set>MsgTyp=E</Set>
  <Set>RspCod=PCL999</Set>
  <Set>RspMsg=该功能未开通</Set>
  <Return/>
</If>
      <If condition="IS_NOEQUAL_STRING($NodNo,441800)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="OR(IS_EQUAL_STRING($Func,01),IS_EQUAL_STRING($Func,02))">
        <Exec func="PUB:Lock" error="IGNORE">
          <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=上一操作处理尚未完成，请稍后再做</Set>
          <Return/>
        </If>
      </If>
<!--判断清算状态-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetClrInf"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,3,-1)">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=查询表【PclClrInf】失败</Set>
        <Return/>
      </If>
<!--清算记录不存在，根据交易功能决定流程-->
      <If condition="INTCMP(~RetCod,3,-2)">
        <Switch expression="$FUNC">
          <Case value="01"> <!--数据读入-->
            <Set>SysSts=0</Set>
            <Exec func="PUB:InsertRecord">
              <Arg name="TblNam" value="PclClrInf"/>
            </Exec>
            <Break/>
          </Case>
          <Case value="02"/> <!--数据清算-->
          <Case value="03"/> <!--天讯手续费-->
          <Case value="04">  <!--银行手续费-->
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=STRCAT(无【,$ClrDat,】交易通数据)</Set>
            <Return/>
          </Case>
        </Switch>
      </If>
<!--清算记录存在、判断状态-->
      <If condition="INTCMP(~RetCod,3,0)">
        <Switch expression="$FUNC">
          <Case value="01"> <!--数据读入-->
            <Switch expression="$SysSts">
              <Case value="0"/>   <!--读入未成功-->
              <Case value="1">    <!--读入已成功-->
                <Exec func="PUB:ExecSql" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="DelDtlTbl"/>
                  </Args>
                </Exec>
                <If condition="~RetCod=-1">
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PCL999</Set>
                  <Set>RspMsg=清除数据失败</Set>
                  <Return/>
                </If>
                <Set>SysSts=0</Set>   <!--更新状态为"清算数据读入"-->
                <Exec func="PUB:UpdateRecord">
                  <Arg name="TblNam" value="PclClrInf"/>
                  <Arg name="CndSts" value="UpdClrInf"/>
                </Exec>
                <Exec func="PUB:CommitWork"/>  <!--清算数据不需回滚-->
                <Break/>
              </Case>
              <Case value="2"/>   <!--清算正在进行-->
              <Case value="3"/>   <!--清算完成-->
              <Case value="4"/>   <!--手续费正在清算-->
              <Case value="5">    <!--手续费清算完成-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=数据已开始清算，不能重复读入</Set>
                <Return/>
              </Case>
            </Switch>
            <Quote name="GetFilProc"/>
            <Break/>
          </Case>
          <Case value="02"> <!--数据清算-->
            <Switch expression="$SysSts">
              <Case value="0">   <!--读入未成功-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=终端清算数据读入未成功，请重新读入</Set>
                <Return/>
              </Case>
              <Case value="2"/>   <!--清算正在进行-->
              <Case value="3"/>   <!--清算完成-->
              <Case value="4"/>   <!--手续费正在清算-->
              <Case value="5">    <!--手续费清算完成-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=数据已开始清算，不能重做</Set>
                <Return/>
              </Case>
              <Case value="1">    <!--读入已成功-->
<!--判断银联资金清算状态-->
                <Switch expression="$TrmTyp">
                  <Case value="0"/> <!--银联POS-->
                  <Case value="1"/> <!--间联POS-->
                  <Case value="3"/> <!--间联二级-->
                  <Case value="4"> <!--银联二级-->
                    <Break/>
                  </Case>
                  <Case value="2"> <!--转账POS-->
                    <Set>OPosTyp=$PosTyp</Set>
                    <Set>OTrmTyp=$TrmTyp</Set>
                    <Set>PosTyp=0</Set>
                    <Set>TrmTyp=0</Set>
                    <Exec func="PUB:ReadRecord" error="IGNORE">
                      <Args>
                        <Arg name="SqlCmd" value="GetClrInf"/>
                      </Args>
                    </Exec>
                    <If condition="INTCMP(~RetCod,3,-1)">
                      <Exec func="PUB:Unlock">
                        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                      </Exec>
                      <Set>MsgTyp=E</Set>
                      <Set>RspCod=PCL999</Set>
                      <Set>RspMsg=查询表【PclClrInf】失败</Set>
                      <Return/>
                    </If>
                    <If condition="AND(IS_NOEQUAL_STRING($SysSts,5),IS_EQUAL_STRING($PosTyp,0))">
                      <Exec func="PUB:Unlock">
                        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                      </Exec>
                      <Set>MsgTyp=E</Set>
                      <Set>RspCod=PCL999</Set>
                      <Set>RspMsg=银联POS清算未完成</Set>
                      <Return/>
                    </If>
                    <Set>PosTyp=$OPosTyp</Set>
                    <Set>TrmTyp=$OTrmTyp</Set>
                    <Break/>
                  </Case>
                </Switch>
<!--更新状态为"清算开始"-->
                <Switch expression="$TrmTyp">
                  <Case value="0"/> <!--银联POS-->
                  <Case value="1"/> <!--间联POS-->
                  <Case value="4"> <!--银联二级-->
                    <Break/>
                  </Case>
                  <Case value="2"> <!--转账POS-->
                    <Set>CnlSub=DPOS</Set>
                    <Break/>
                  </Case>
                  <Case value="3"> <!--间联二级-->
                    <Set>CnlSub=IPOS</Set>
                    <Break/>
                  </Case>
                </Switch>
                <Set>SysSts=2</Set>
                <Exec func="PUB:UpdateRecord">
                  <Arg name="TblNam" value="PclClrInf"/>
                  <Arg name="CndSts" value="UpdClrInf"/>
                </Exec>
<!--返回前端-->
                <Set>MsgTyp=N</Set>
                <Set>RspCod=000000</Set>
                <Exec func="PUB:PutResponse"/>
                <Exec func="PUB:Sleep"/>
                <Break/>
              </Case>
            </Switch>   <!--End Of SysSts -->
<!--记帐处理-->
            <Set>TxnCnl=PCL</Set>
<!--主机交易初始值-->
            <Set>HTxnCd=471280</Set>
            <Set>BusTyp=PCL61</Set>
            <Set>CnlTyp=L</Set>
            <Set>Mask=0805</Set>
            <Set>TxnSub=011</Set>
            <Set>ActFlg=4</Set>
            <Set>VchChk=0</Set>
            <Set>Fee=000000000000000</Set>
            <Set>FeeBr=$NodNo</Set>
<!--通过游标获取明细-->
            <Switch expression="$TrmTyp">
              <Case value="2"> <!--转账POS-->
                <Exec func="PUB:OpenCursor" error="IGNORE">
                  <Arg name="sql" value="GetDTxnDtl"/>
                </Exec>
                <Break/>
              </Case>
                <Case value="3"> <!--间联二级-->
                <Exec func="PUB:OpenCursor" error="IGNORE">
                  <Arg name="sql" value="GetITxnDtl"/>
                </Exec>
                <Break/>
              </Case>
              <Default>
                <Set>MsgTyp=N</Set>
                <Set>RspCod=000000</Set>
                <Return/>
              </Default>
            </Switch>
            <If condition="INTCMP(~RetCod,4,0)">
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=打开游标出错</Set>
              <Return/>
            </If>
            <While>
              <Exec func="PUB:FetchCursor" error="IGNORE"/>
              <If condition="~RetCod=100">
                <Break/>
              </If>
<!--明细检查-->
              <If condition="INTCMP($TrmTyp,3,2)">  <!--转账POS对账-->
                <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="ChkTxnDtl"/>
                  </Args>
                </Exec>
                <If condition="INTCMP(~RetCod,4,0)">
                  <Set>TxnSts=E</Set>
                  <Set>ErrMsg=银联对帐明细中不存在该笔交易</Set>
                  <Exec func="PUB:UpdateRecord">
                    <Arg name="TblNam" value="PclDTxnDtl"/>
                    <Arg name="CndSts" value="UpdDTxnDtl"/>
                  </Exec>
                  <Continue/>
                </If>
                <If condition="INTCMP($DPosAmt,4,$PosAmt)">
                  <Set>TxnSts=E</Set>
                  <Set>ErrMsg=该笔交易金额与银联不一致</Set>
                  <Exec func="PUB:UpdateRecord">
                    <Arg name="TblNam" value="PclDTxnDtl"/>
                    <Arg name="CndSts" value="UpdDTxnDtl"/>
                  </Exec>
                  <Continue/>
                </If>
                <If condition="IS_NOEQUAL_STRING($Sts,1)">
                  <Set>TxnSts=E</Set>
                  <Set>ErrMsg=银联未清算该笔交易</Set>
                  <Exec func="PUB:UpdateRecord">
                    <Arg name="TblNam" value="PclDTxnDtl"/>
                    <Arg name="CndSts" value="UpdDTxnDtl"/>
                  </Exec>
                  <Continue/>
                </If>
                <Delete>LogNo</Delete>
                <Exec func="PUB:GetLogNo"/>
              </If>
              <Set>FeeSeq=SUBSTR($ClrAct,14,5)</Set>
<!--对帐成功上送主机-->
              <Exec func="PUB:GetVirtualTeller"/>
              <Exec func="PUB:CallHostAcc" error="IGNORE">
                <Arg name="TxnCod" value="$HTxnCd"/>
                <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>
              <Switch expression="~RetCod">
                <Case value="-1">
                  <Set>TxnSts=T</Set>
                  <Break/>
                </Case>
                <Case value="0">
                  <Set>TxnSts=S</Set>
                  <Set>HTxnSt=S</Set>
                  <Break/>
                </Case>
                <Default>
                  <Set>TxnSts=F</Set>
                  <Set>HTxnSt=F</Set>
                  <Break/>
                </Default>
              </Switch>
<!--更新状态及银行手续费-->
              <Switch expression="$TrmTyp">
                <Case value="2"> <!--银联POS-->
                  <Exec func="PUB:UpdateRecord">
                    <Arg name="TblNam" value="PclDTxnDtl"/>
                    <Arg name="CndSts" value="UpdDTxnDtl"/>
                  </Exec>
                  <Break/>
                </Case>
                <Case value="3"> <!--间联POS-->
                  <Exec func="PUB:UpdateRecord">
                    <Arg name="TblNam" value="PclITxnDtl"/>
                    <Arg name="CndSts" value="UpdITxnDtl"/>
                  </Exec>
                  <Break/>
                </Case>
              </Switch>
              <Exec func="PUB:CommitWork"/>
            </While>
<!--更新状态为清算完成-->
            <Set>SysSts=3</Set>
            <Exec func="PUB:UpdateRecord">
              <Arg name="TblNam" value="PclClrInf"/>
              <Arg name="CndSts" value="UpdClrInf"/>
            </Exec>
            <Break/>
          </Case>
          <Case value="03"> <!--手续费-->
            <Switch expression="$SysSts">
              <Case value="0"/>   <!--读入未成功-->
              <Case value="1"/>   <!--读入已成功-->
              <Case value="2">    <!--正在清算-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=STRCAT(【,$ClrDat,】交易通数据尚未完成客户资金清算)</Set>
                <Return/>
              </Case>
              <Case value="4"/>   <!--正在处理-->
              <Case value="5">    <!--已清算-->
                <Exec func="PUB:Unlock">
                  <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PCL999</Set>
                <Set>RspMsg=STRCAT(【,$ClrDat,】行内手续费已清算)</Set>
                <Return/>
              </Case>
              <Case value="3">    <!--清算完成-->
                <Set>SysSts=4</Set>
                <Exec func="PUB:UpdateRecord">
                  <Arg name="TblNam" value="PclClrInf"/>
                  <Arg name="CndSts" value="UpdClrInf"/>
                </Exec>
<!--计算天信手续费-->
                <Set>TxnCnl=PCL</Set>
                <Set>CnlSub=DPOS</Set>
                <Exec func="PUB:GetVirtualTeller"/>
                <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="GetThdFee"/>
                  </Args>
                </Exec>
                <If condition="INTCMP(~RetCod,3,-1)">
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PCL999</Set>
                  <Set>RspMsg=查询表【PclDTxnDtl】失败</Set>
                  <Return/>
                </If>
                <If condition="INTCMP(~RetCod,3,0)">
                  <Exec func="PUB:GetLogNo"/>
                  <Set>ClrBr=$BrNo</Set>
                  <Set>ClrTyp=1</Set>
                  <Set>TxnAmt=ADDCHAR($ThdFee,15,0,1)</Set>
                  <Exec func="PUB:InsertRecord">
                    <Arg name="TblNam" value="PclDFeeJnl"/>
                  </Exec>
                  <If condition="INTCMP($TxnAmt,6,0))">
                    <Set>BusTyp=PCL76</Set>
                    <Set>CrpCod=PCL999999999</Set>
                    <Set>RgCFlg=0</Set>   <!--贷方回单，暂不登记，有需要可修改为 1 -->
                    <Set>ActBk1=$BrNo</Set>
                    <Set>ActBr1=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
                    <Set>ActSq1=SUBSTR($ClrAct,14,5)</Set>
                    <Set>CdFlg1=D</Set>
                    <Set>OuAmt1=$TxnAmt</Set>
                    <Set>Smr=STRCAT(清算交易通【,$ClrDat,】手续费)</Set>
                    <Set>PayAt5=$FeeAct</Set>
                    <Set>CdFlg5=C</Set>
                    <Set>InAmt5=$TxnAmt</Set>
                    <Exec func="PUB:CallHostAcc" error="IGNORE" >
                      <Arg name="TxnCod" value="451900"/>
                      <Arg name="ObjSvr" value="SHSTPUB1"/>
                    </Exec>
                    <Exec func="PUB:UpdateRecord">
                      <Arg name="TblNam" value="PclDFeeJnl"/>
                      <Arg name="CndSts" value="UpdDFeeJnl"/>
                    </Exec>
                  </If>
                </If>
<!--计算辖属行手续费-->
                <Exec func="PUB:OpenCursor" error="IGNORE">
                  <Arg name="sql" value="GetBnkFee"/>
                </Exec>
                <If condition="INTCMP(~RetCod,4,0)">
                  <Exec func="PUB:Unlock">
                    <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=PCL999</Set>
                  <Set>RspMsg=打开游标出错</Set>
                  <Return/>
                </If>
<!--记帐公共值-->
                <Set>ClrTyp=0</Set>
                <Set>BusTyp=PCL78</Set>
                <Set>CrpCod=PCL999999999</Set>
                <Set>DAcSqn=SUBSTR($ClrAct,14,5)</Set>
                <Set>TActBr=$BrNo</Set>
                <Set>AgtNod=$NodNo</Set>
                <Set>BvNo=00000000</Set>
                <Set>AccMod=1</Set>
                <Set>Smr=STRCAT(清算交易通【,$ClrDat,】手续费)</Set>
                <Set>ActSqn=$FeeSqn</Set>
                <While>
                  <Exec func="PUB:FetchCursor" error="IGNORE"/>
                  <If condition="~RetCod=100">
                    <Break/>
                  </If>
                  <Delete>LogNo</Delete>
                  <Delete>HTxnSt</Delete>
                  <Delete>HRspCd</Delete>
                  <Delete>TckNo</Delete>
                  <Set>TxnAmt=ADDCHAR($BnkFee,15,0,1)</Set>
                  <Set>BrNo=$OpnBr</Set>
                  <Set>ActNod=STRCAT(SUBSTR($OpnBr,1,3),800)</Set>
                  <Exec func="PUB:GetLogNo"/>
                  <Set>ClrBr=$OpnBr</Set>
                  <Exec func="PUB:InsertRecord">
                    <Arg name="TblNam" value="PclDFeeJnl"/>
                  </Exec>
                  <If condition="INTCMP($TxnAmt,6,0)">
                    <Exec func="PUB:CallHostAcc" error="IGNORE">
                      <Arg name="TxnCod" value="451900"/>
                      <Arg name="ObjSvr" value="SHSTPUB1"/>
                    </Exec>
                  </If>
                  <Exec func="PUB:UpdateRecord">
                    <Arg name="TblNam" value="PclDFeeJnl"/>
                    <Arg name="CndSts" value="UpdDFeeJnl"/>
                  </Exec>
                </While>
                <Set>SysSts=5</Set>
                <Exec func="PUB:UpdateRecord">
                  <Arg name="TblNam" value="PclClrInf"/>
                  <Arg name="CndSts" value="UpdClrInf"/>
                </Exec>
                <Break/>
              </Case>
            </Switch>
            <Break/>
          </Case>
        </Switch>
      </If>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>




  <Transaction code="462314" desc="转帐POS报表打印">
    <Quote name="PclSqlLst"/>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetClrInf"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=查询表【PclClrInf】失败</Set>
        <Return/>
      </If>
      <If condition="INTCMP($SysSts,4,3)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=清算操作未完成，请稍后再做</Set>
        <Return/>
      </If>
      <Set>DT=SUBSTR($ClrDat,5,4)</Set>
      <Switch expression="$Func">
        <Case value="01"> <!-- 转帐POS入帐成功清单 -->
          <If condition="INTCMP($TrmFlg,3,0)">
            <Set>FmtFil=STRCAT(etc/,PCL012_RPT.XML)</Set>
            <Set>FilNam=STRCAT(PCL012,$TlrId,.RPT)</Set>
            <Set>Summary=STRCAT(转帐POS【,$ClrDat,】入帐流水清单)</Set>
          </If>
          <Else>
            <Set>FmtFil=STRCAT(etc/,PCL014_RPT.XML)</Set>
            <Set>FilNam=STRCAT(PCL014,$TlrId,.RPT)</Set>
            <Set>Summary=STRCAT(间联POS【,$ClrDat,】入帐流水清单)</Set>
          </Else>
          <Break/>
        </Case>
        <Case value="02"> <!-- 转帐POS入帐失败清单 -->
          <If condition="INTCMP($TrmFlg,3,0)">
            <Set>FmtFil=STRCAT(etc/,PCL013_RPT.XML)</Set>
            <Set>FilNam=STRCAT(PCL013,$TlrId,.RPT)</Set>
            <Set>Summary=STRCAT(转帐POS【,$ClrDat,】入帐失败清单)</Set>
          </If>
          <Else>
            <Set>FmtFil=STRCAT(etc/,PCL015_RPT.XML)</Set>
            <Set>FilNam=STRCAT(PCL015,$TlrId,.RPT)</Set>
            <Set>Summary=STRCAT(间联POS【,$ClrDat,】入帐失败清单)</Set>
          </Else>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Quote name="RptProc"/>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>




  <Transaction code="462316" desc="POS费率资料维护">
<!-- 查询 -->
    <DynSentence name="GetFeeRat">
      <Sentence>
        select Sts OSts, FeeMod OFeeMod, FeeRat OFeeRat, FeeAmt OFeeAmt, ValDt OValDt
          from PclFeeRat
         where SysFlg='%s' and BrNo='%s' and MinAmt='%s' and MaxAmt='%s'
      </Sentence>
      <Fields>SysFlg|BrNo|MinAmt|MaxAmt|</Fields>
    </DynSentence>
    <DynSentence name="UpdFeeRat"> <!--修改-->
      <Sentence>
        SysFlg='%s' and BrNo='%s' and MinAmt='%s' and MaxAmt='%s'
      </Sentence>
      <Fields>SysFlg|BrNo|MinAmt|MaxAmt|</Fields>
    </DynSentence>
    <DynSentence name="DelFeeRat">
      <Sentence>
        delete from PclFeeRat where SysFlg='%s' and BrNo='%s' and MinAmt='%s' and MaxAmt='%s'
      </Sentence>
      <Fields>SysFlg|BrNo|MinAmt|MaxAmt|</Fields>
    </DynSentence>
<!-- 判断费率是否交叉 -->
    <DynSentence name="ChkFeeRat">
      <Sentence>
        select 'Y' YN from TABLE(VALUES(1)) AS anony
          where EXISTS ( select 'Y' from PclFeeRat
                           where SysFlg='%s' and BrNo='%s' and 
                                 ( ( MinAmt &gt; '%s' and MinAmt &lt; '%s' ) or ( MaxAmt &gt; '%s' and MaxAmt &lt; '%s' ) or ( MinAmt='%s' and MaxAmt &lt; '%s' ) or ( MinAmt &lt; '%s' and MaxAmt='%s' ) )
      </Sentence>
      <Fields>SysFlg|BrNo|MinAmt|MaxAmt|MinAmt|MaxAmt|MinAmt|MaxAmt|MinAmt|MaxAmt|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($FUNC,2)">
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="70"/>
          <Arg name="AthMsg" value="PCL000"/>
        </Exec>
        <Exec func="PUB:CheckLocalAuth" >
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetFeeRat"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=STRCAT(查询表【PclFeeRat】失败)</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Switch expression="$Func">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
<!--检查费率是否存在分段-->
<!--
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="ChkFeeRat"/>
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=STRCAT(查询表【PclFeeRat】失败)</Set>
            <Return/>
          </If>
          <If condition="~RetCod=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=该费率有分段</Set>
            <Return/>
          </If>
-->
          <Exec func="PUB:InsertRecord">
            <Args>
              <Arg name="tablename" value="PclFeeRat"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="PclFeeRat"/>
            <Arg name="CndSts" value="UpdFeeRat"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="DelFeeRat"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="462321" desc="直联POS查询交易">
    <FlowCtrl>
      <Exec func="PCL:PCLGetTrmInf"/> <!--根据商户号、和终端号取分行号、帐号-->
      <If condition="INTCMP(~RetCod,3,-1)">
        <Set>MsgTyp=E</Set>
        <Return/>
      </If>
      <Exec func="PUB:InitTransaction"/>
      <Exec func="PUB:GetAppInfo"/>
      <Switch expression="$Func">
        <Case value="1">   <!--校验终端合法性-->
          <Break/>
        </Case>
        <Case value="2"/>    <!--资料查询-->
        <Case value="3">    <!--查手续费-->
          <If condition="IS_EQUAL_STRING($FUNC,3)">
            <Exec func="PCL:PCLGetFee">
              <Args>
                <Arg name="BrNo"   value="$BrNo"/>
                <Arg name="SysFlg" value="$SysFlg"/>   <!--转帐-->
                <Arg name="TxnAmt" value="$TxnAmt"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,3,-1)">
              <Set>MsgTyp=E</Set>
              <Return/>
            </If>
          </If>
          <Set>TxnCnl=PCL</Set>
          <Exec func="PUB:GetVirtualTeller"/>
          <Set>TTxnCd=$TxnCod</Set>
          <Set>CcyCod=CNY</Set>
          <Set>ActTyp=4</Set>
          <Exec func="PUB:CallHostAcc">
            <Arg name="HTxnCd" value="476520"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=$HRspCd</Set>
            <Set>Bal=000000000000000</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Case value="4">    <!--短信-->
          <If condition="IS_NOEQUAL_STRING($UniNo,0000)">
            <Set>SndFlg=0</Set>  <!--即时发送-->
            <Set>FeeTyp=2</Set>  <!--不收费-->
            <Set>ActTyp=1</Set>  <!--账户类型(对私)-->
            <Set>SvrTim=GETDATETIME(MM月DD日HH时MI分)</Set>
            <Set>TxnAmt=DELBOTHSPACE(AMTSIMPLEFMT(SUB($TxnAmt,$FeeAmt)))</Set>
            <Set>CusId= </Set>
            <If condition="IS_EQUAL_STRING($TxnTyp,N)">
              <Set>MsgTxt=STRCAT(客户【,DELBOTHSPACE($SndAct),】于,$SvrTim,，通过"交易通"向您转入,$TxnAmt,元，交易已受理【交通银行】)</Set>
            </If>
            <Else>
              <Set>MsgTxt=STRCAT(客户【,DELBOTHSPACE($SndAct),】于,$SvrTim,，通过"交易通"向您转入,$TxnAmt,元，交易已撤销【交通银行】)</Set>
            </Else>
            <If condition="AND(IS_EQUAL_STRING($BrNo,444999),IS_EQUAL_STRING($UniNo,0002))">
              <Exec func="PUB:GetCommInf" error="IGNORE">
                <Arg name="CndId" value="STRCAT(sfm_,444002)"/>
              </Exec>
            </If>
            <Else>
              <Exec func="PUB:GetCommInf" error="IGNORE">
                <Arg name="CndId"  value="STRCAT(sfm_,$BrNo)"/>
              </Exec>
            </Else>
            <If condition="INTCMP(~RetCod,3,0)">
              <Set>@MSG.OIP=$HstIp</Set>
              <Set>@MSG.OPT=$HstPrt</Set>
              <Exec func="PUB:CallThirdOther" error="IGNORE">
                <Arg name="HTxnCd" value="479113"/>
                <Arg name="ObjSvr" value="STHDSFMA"/>
              </Exec>
            </If>
            <Else>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspCod=取短信通讯配置错</Set>
              <Return/>
            </Else>
          </If>
          <Break/>
        </Case>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="462322" desc="直联POS对帐文件接收">
    <Quote name="PclSqlLst"/>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Set>SysFlg=1</Set>  <!--设置POS类型-->
      <Quote name="InitProc"/>
      <Exec func="PUB:Lock" error="IGNORE">
        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=上一操作处理尚未完成，请稍后再做</Set>
        <Return/>
      </If>
<!--判断清算状态-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetClrInf"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,3,-1)">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=查询表【PclClrInf】失败</Set>
        <Return/>
      </If>
      <If condition="INTCMP(~RetCod,3,-2)">
        <Set>SysSts=0</Set>
        <Exec func="PUB:InsertRecord">
          <Arg name="TblNam" value="PclClrInf"/>
        </Exec>
      </If>
      <If condition="INTCMP(~RetCod,3,0)">
        <Switch expression="$SysSts">
          <Case value="0"/>   <!--读入未成功-->
          <Case value="1">    <!--读入已成功-->
            <Set>DtlTbl=PclDTxnDtl</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="DelDtlTbl"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=清除数据失败</Set>
              <Return/>
            </If>
            <Set>SysSts=0</Set>   <!--更新状态为"清算数据读入"-->
            <Exec func="PUB:UpdateRecord">
              <Arg name="TblNam" value="PclClrInf"/>
              <Arg name="CndSts" value="UpdClrInf"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>  <!--清算数据不需回滚-->
            <Break/>
          </Case>
          <Case value="2"/>   <!--清算正在进行-->
          <Case value="3"/>   <!--清算完成-->
          <Case value="4"/>   <!--手续费正在进行-->
          <Case value="5">    <!--手续费清算完成-->
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=数据已开始清算，不能重复读入</Set>
            <Return/>
          </Case>
        </Switch>
      </If>
      <Set>FilSrc=02</Set>
      <Set>PosTyp=0</Set>
      <Quote name="GetFilProc"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=SC0000</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="462323" desc="间联POS文件接收">
    <Quote name="PclSqlLst"/>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Set>SysFlg=2</Set>  <!--设置POS类型-->
      <Quote name="InitProc"/>
      <Exec func="PUB:IsExistNode" error="IGNORE">
        <Arg name="FieldName" value="ClrDat"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,0)">  <!--手工发起-->
        <Set>ClrDat=CALCDATE($ActDat,-,d,2)</Set>
      </If>
      <Exec func="PUB:Lock" error="IGNORE">
        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        <Arg name="AutoUnlock" value="Y"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=上一操作处理尚未完成，请稍后再做</Set>
        <Return/>
      </If>
<!--判断清算状态-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetClrInf"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,3,-1)">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=查询表【PclClrInf】失败</Set>
        <Return/>
      </If>
      <If condition="INTCMP(~RetCod,3,-2)">
        <Set>SysSts=0</Set>
        <Exec func="PUB:InsertRecord">
          <Arg name="TblNam" value="PclClrInf"/>
        </Exec>
      </If>
      <If condition="INTCMP(~RetCod,3,0)">
        <Switch expression="$SysSts">
          <Case value="0"/>   <!--读入未成功-->
          <Case value="1">    <!--读入已成功-->
            <Set>DtlTbl=PclITxnDtl</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="DelDtlTbl"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
              </Exec>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PCL999</Set>
              <Set>RspMsg=清除数据失败</Set>
              <Return/>
            </If>
            <Set>SysSts=0</Set>   <!--更新状态为"清算数据读入"-->
            <Exec func="PUB:UpdateRecord">
              <Arg name="TblNam" value="PclClrInf"/>
              <Arg name="CndSts" value="UpdClrInf"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>  <!--清算数据不需回滚-->
            <Break/>
          </Case>
          <Case value="2"/>   <!--清算正在进行-->
          <Case value="3"/>   <!--清算完成-->
          <Case value="4"/>   <!--手续费正在进行-->
          <Case value="5">    <!--手续费清算完成-->
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PCL999</Set>
            <Set>RspMsg=数据已开始清算，不能重复读入</Set>
            <Return/>
          </Case>
        </Switch>
      </If>
<!--接收记账文件-->
      <Set>FilSrc=02</Set>
      <Set>PosTyp=1</Set>
      <Quote name="GetFilProc"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
<!--
      <Set>RspCod=000000</Set>
-->
    </FlowCtrl>
  </Transaction>


  <Transaction code="462397" desc="获取网点资料" timeout="30">
    <DynSentence name="GetNodInf">
      <Sentence>
        select OrgNam,OrgBk from CimOrgTbl where OrgNo='%s'
      </Sentence>
      <Fields>OrgNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetNodInf"/>
        </Args>
      </Exec>
    </FlowCtrl>
  </Transaction>


  <Transaction code="462398" desc="更新流程控制表" timeout="30">
    <DynSentence name="ChkBrClrSts">
      <Sentence>
        select BrNo,PosTyp,TrmTyp,SysSts from PclClrInf where DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdClrSts">
      <Sentence>
        update PclClrInf set SysSts='%s' where DskNo='%s'
      </Sentence>
      <Fields>SysSts|DskNo|</Fields>
    </DynSentence>
    <DynSentence name="InsClrInf">
      <Sentence>
        insert into PclClrInf select '%s', ClrDat, '0', '0','1','' from PclClrInf where DskNo='%s'
      </Sentence>
      <Fields>BrNo|DskNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>DskNo=$LogNo</Set>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="ChkBrClrSts"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>MsgTyp=N</Set>
        <Set>RspCod=PCL999</Set>
        <Set>RspMsg=STRCAT(查询【,$DskNo,】记录失败)</Set>
        <Return/>
      </If>
      <Switch expression="$SysSts">
        <Case value="2">   <!--退货清算-->
          <Set>SysSts=3</Set>   <!--更新状态为"退货清算完成"-->
          <Break/>
        </Case>
        <Case value="4">   <!--消费清算-->
          <Set>SysSts=5</Set>   <!--更新状态为"消费清算完成"-->
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Exec func="PUB:ExecSql" error="IGNORE">
       <Args>
          <Arg name="SqlCmd" value="UpdClrSts"/>
        </Args>
      </Exec>
      <Exec func="PUB:CommitWork"/>  <!--清算数据不需回滚-->
<!--广东省分行完成消费清算后，作为代理行的数据同步更新为数据读入成功-->
      <If condition="AND(IS_EQUAL_STRING($SysSts,3),IS_EQUAL_STRING($BrNo,441999))">
        <Set>BrNo=483999</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
         <Args>
            <Arg name="SqlCmd" value="InsClrInf"/>
          </Args>
        </Exec>
        <Set>BrNo=485999</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
         <Args>
            <Arg name="SqlCmd" value="InsClrInf"/>
          </Args>
        </Exec>
        <Set>BrNo=491999</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
         <Args>
            <Arg name="SqlCmd" value="InsClrInf"/>
          </Args>
        </Exec>
        <Set>BrNo=761999</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
         <Args>
            <Arg name="SqlCmd" value="InsClrInf"/>
          </Args>
        </Exec>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>




  <Transaction code="462399" desc="PCL明细提交记帐" timeout="30">
    <DynSentence name="UpdTxnDtl1">
      <Sentence>
        update PclTxnDtl set Sts='%s', LogNo='%s', HLogNo ='%s', TlrId='%s', TckNo='%s', HRspCd='%s'
         where CtrPostDate='%s' and OpnBr='%s' and CdFlag='%s' and Sts='B' and MerId='%s'
      </Sentence>
      <Fields>Sts|LogNo|HLogNo|TlrId|TckNo|HRspCd|CtrPostDate|OpnBr|CdFlag|MerId|</Fields>
    </DynSentence>
    <DynSentence name="UpdTxnDtl2">
      <Sentence>
        update PclTxnDtl set Sts='%s', LogNo='%s', HLogNo ='%s', TlrId='%s', TckNo='%s', HRspCd='%s'
         where CtrPostDate='%s' and OpnBr='%s' and CdFlag='%s' and Sts='B' and MerId='%s' and SeqNo='%s'
      </Sentence>
      <Fields>Sts|LogNo|HLogNo|TlrId|TckNo|HRspCd|CtrPostDate|OpnBr|CdFlag|MerId|SeqNo|</Fields>
    </DynSentence>
    <DynSentence name="GetNewAct">
      <Sentence>
        select ActNo NewAct from SavOldAct where OldAct='%s'
      </Sentence>
      <Fields>BokAct|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Switch expression="$CdFlag">
        <Case value="C">   <!--消费清算-->
          <Set>Smr=STRCAT(清算【,$CtrPostDate,】银联特约商户【,$MerId,】消费资金)</Set>
          <Switch expression="$SndFlg">
            <Case value="0">   <!--对公-->
              <Set>CrpCod=PCL999999999</Set>
              <If condition="IS_EQUAL_STRING(SUBSTR($BokAct,20,2),99)">   <!--内部帐-->
                <Set>HTxnCd=451410</Set>
                <Set>BusTyp=PCL78</Set>
                <Set>DAcSqn=SUBSTR($ClrAct,14,5)</Set>
                <Set>TActBr=$OpnBr</Set>
                <Set>AgtNod=STRCAT(SUBSTR($OpnBr,1,3),800)</Set>
                <Set>BvNo=00000000</Set>
                <Set>TxnAmt=$ClearAmt</Set>
                <Set>AccMod=1</Set>
                <Set>ActSqn=SUBSTR($BokAct,14,5)</Set>
                <Set>BrNo=$OpnBr</Set>
                <Set>ActNod=SUBSTR($BokAct,1,6)</Set>
              </If>
              <Else>
                <Set>HTxnCd=451900</Set>
                <Set>BusTyp=PCL76</Set>
                <Set>RgCFlg=0</Set>   <!--贷方回单，暂不登记，有需要可修改为 1 -->
                <Set>ActBk1=$OpnBr</Set>
                <Set>ActBr1=STRCAT(SUBSTR($OpnBr,1,3),800)</Set>
                <Set>ActSq1=SUBSTR($ClrAct,14,5)</Set>
                <Set>CdFlg1=D</Set>
                <Set>OuAmt1=$ClearAmt</Set>
                <Set>PayAt5=$BokAct</Set>
                <Set>CdFlg5=C</Set>
                <Set>InAmt5=$ClearAmt</Set>
                <If condition="IS_EQUAL_STRING($InMode,0)">   <!--按交易总额-->
                  <Set>PayAt2=$BokAct</Set>
                  <Set>CdFlg2=D</Set>
                  <Set>OuAmt2=$MerFee</Set>
                  <Set>InAmt5=ADDCHAR(ADD($ClearAmt,$MerFee),15,0,1)</Set>
                </If>
              </Else>
              <Break/>
            </Case>
            <Case value="1"/>   <!--存折-->
            <Case value="2">    <!--卡-->
              <Set>HTxnCd=471280</Set>
              <Set>BusTyp=PCL61</Set>
              <Set>CnlTyp=L</Set>
              <Set>Mask=0806</Set>
              <Set>TxnSub=011</Set>
              <If condition="IS_EQUAL_STRING($SndFlg,1)">   <!--存折-->
                <Set>ActFlg=2</Set>
                <Set>VchCod=00000000</Set>
<!--根据老存折获取新存折号-->
                <If condition="IS_NOEQUAL_STRING(SUBSTR($BokAct,4,1),9)">
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                    <Args>
                      <Arg name="SqlCmd" value="GetNewAct"/>
                    </Args>
                  </Exec>
                  <If condition="~RetCod=0">
                    <Set>BokAct=$NewAct</Set>
                  </If>
                </If>
              </If>
              <Else>
                <Set>ActFlg=4</Set>
              </Else>
              <Set>ActNo=$BokAct</Set>
              <Set>TxnAmt=$ClearAmt</Set>
              <Set>VchChk=0</Set>
              <If condition="IS_EQUAL_STRING($InMode,0)">   <!--按交易总额-->
                <Set>FeeCod=9999</Set>  <!--当有手续费时费率代码必须填写非"0000"的值-->
                <Set>Fee=$MerFee</Set>
              </If>
              <Else>
                <Set>Fee=000000000000000</Set>
              </Else>
              <Set>FeeSeq=SUBSTR($ClrAct,14,5)</Set>
              <Set>FeeBr=STRCAT(SUBSTR($OpnBr,1,3),800)</Set>
              <Break/>
            </Case>
          </Switch>
          <Break/>
        </Case>
        <Case value="D">   <!--退货清算、不考虑汇总清算的情况-->
          <Set>Smr=STRCAT(清算【,$CtrPostDate,】银联特约商户【,$MerId,】退货资金)</Set>
          <Switch expression="$SndFlg">
            <Case value="0">   <!--对公-->
              <Set>CrpCod=PCL999999999</Set>
              <If condition="IS_EQUAL_STRING(SUBSTR($BokAct,20,2),99)">   <!--内部帐-->
                <Set>Sts=E</Set>
                <Set>LogNo= </Set>
                <Set>HLogNo= </Set>
                <Set>TlrId= </Set>
                <Set>TckNo= </Set>
                <Set>HRspCd=★★★</Set>
                <Set>BokFlg=1</Set>
              </If>
              <Else>
                <Set>HTxnCd=451200</Set>
                <Set>BusTyp=PCL51</Set>
                <Set>ActNo=$BokAct</Set>
                <Set>TxnAmt=$ClearAmt</Set>
                <Set>ActSqn=SUBSTR($ClrAct,14,5)</Set>
              </Else>
              <Break/>
            </Case>
            <Case value="1"/>   <!--存折-->
            <Case value="2">    <!--卡-->
               <Set>HTxnCd=471140</Set>
              <Set>BusTyp=PCL52</Set>
              <Set>CnlTyp=L</Set>
              <Set>Mask=0807</Set>
              <If condition="IS_EQUAL_STRING($SndFlg,1)">   <!--存折-->
                <Set>ActFlg=2</Set>
                <Set>VchCod=00000000</Set>
<!--根据老存折获取新存折号-->
                <If condition="IS_NOEQUAL_STRING(SUBSTR($BokAct,4,1),9)">
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                    <Args>
                      <Arg name="SqlCmd" value="GetNewAct"/>
                    </Args>
                  </Exec>
                  <If condition="~RetCod=0">
                    <Set>BokAct=$NewAct</Set>
                  </If>
                </If>
              </If>
              <Else>
                <Set>ActFlg=4</Set>
              </Else>
              <Set>ActNo=$BokAct</Set>
              <Set>PayMod=0</Set>
              <Set>TActNo=$ClrAct</Set>
              <Set>TxnAmt=$ClearAmt</Set>
              <Set>CcyTyp=1</Set>
              <Set>VchChk=0</Set>
              <Set>CAgtNo=$CrpCod</Set>
              <Break/>
            </Case>
          </Switch>
          <Break/>
        </Case>
      </Switch>
      <If condition="IS_NOEQUAL_STRING($BokFlg,1)">   <!--需要上送主机-->
        <Exec func="PUB:CallHostAcc" error="IGNORE" >
          <Arg name="TxnCod" value="$HTxnCd"/>
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
        <If condition="AND(INTCMP(~RetCod,3,0),OR(IS_EQUAL_STRING($HRspCd,SC0000),IS_EQUAL_STRING($HRspCd,SD0016)))">
          <Set>Sts=1</Set>
        </If>
        <Else>
          <Set>Sts=E</Set>
        </Else>
      </If>
      <If condition="IS_EQUAL_STRING($SeqNo,ZZZZZZ)">   <!--汇总入帐-->
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="UpdTxnDtl1"/>
          </Args>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=更新流水表失败</Set>
          <Return/>
        </If>
      </If>
      <Else>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="UpdTxnDtl2"/>
          </Args>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PCL999</Set>
          <Set>RspMsg=更新流水表失败</Set>
          <Return/>
        </If>
      </Else>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Exec func="PUB:PutResponse"/>
    </FlowCtrl>
  </Transaction>

</Application>
