<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="PNT" code="215">
	<LibDeclare>
		<Library name="PFA" value="dll/pfa.so"/>
		<Library name="PNT" value="dll/pnt.so"/>
	</LibDeclare>

	<ConfigDeclare>
		<Config name="BatFormat"  value="etc/PNT_FMT.XML"/>
	</ConfigDeclare>

	<TableDeclare>
		<Table name="PntTxnBok"    value="PntTxnBok"/>
		<Table name="PntTxnJnl"    value="PntTxnJnl"/>
		<Table name="PntSfxm"      value="PntSfxm"/>
		<Table name="Pntdwxx"      value="Pntdwxx"/>
		<Table name="PntDwxm"      value="PntDwxm"/>
		<Table name="PntPjlx"      value="PntPjlx"/>
		<Table name="PntPjff"      value="PntPjff"/>
		<Table name="PntXmpj"      value="PntXmpj"/>
		<Table name="PntQyxx"      value="PntQyxx"/>
		<Table name="PntSfxmtmp"   value="PntSfxmtmp"/>
		<Table name="Pntdwxxtmp"   value="Pntdwxxtmp"/>
		<Table name="PntDwxmtmp"   value="PntDwxmtmp"/>
		<Table name="PntPjlxtmp"   value="PntPjlxtmp"/>
		<Table name="PntPjfftmp"   value="PntPjfftmp"/>
		<Table name="PntXmpjtmp"   value="PntXmpjtmp"/>
		<Table name="PntQyxxtmp"   value="PntQyxxtmp"/>		
		<Table name="PntWtzw"      value="PntWtzw"/>
	</TableDeclare>

	<BusDefDeclare>
		<Busdef name="RptDir" value="dat/term/send/"/>
		<Busdef name="PntSndDir" value="dat/pnt/send/"/>
		<Busdef name="PntRcvDir" value="dat/pnt/recv/"/>
	</BusDefDeclare>

	<Define>
		<Include file="etc/PNT_MCR.XML"/>
	</Define>


	<Transaction code="461501" desc="请求缴费">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="TxnCod" value="311"/>
				<Arg name="ObjSvr" value="STHDPNT1"/>
			</Exec>
			<Switch expression="$RtnCod">
				<Case value="102">   <!--部分手工录入-->
					<Set>NTxnCd=461502</Set>
					<Break/>
				</Case>
				<Case value="107">   <!--完全手工录入-->
					<Set>NTxnCd=461503</Set>
					<Break/>
				</Case>
				<Case value="100">   <!--不需要手工录入-->
					<Set>NTxnCd=461504</Set>
					<Break/>
				</Case>
				<Default>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Return/>
				</Default>
			</Switch>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461502" desc="部分手工录入">
		<Quote name="PntSqlLst"/>
    <Attributes>
      <Attribute name="integrity" value="2" code="461599"/>  <!-- 条件冲正-->
			<Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
    </Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PFA:GenPrvData">
				<Arg name="PrjNum" value="PrjNum" desc="收费项目笔数"/>
				<Arg name="PrjGrp" value="PrjRec" desc="收费项目结构"/>
				<Arg name="RmkNum" value="RmkNum" desc="额外信息笔数"/>
				<Arg name="RmkGrp" value="RmkRec" desc="额外信息结构"/>
			</Exec>
			<Set>BilSts=U</Set>
			<Exec func="PUB:GetLogNo"/>
			<Set>CmtCod=312</Set>
			<Quote name="BokAccPro"/>
			<Set>BokFlg=1</Set>
			<Quote name="SndThdPro"/>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461503" desc="完全手工录入">
		<Quote name="PntSqlLst"/>
		<Attributes>
			<Attribute name="integrity" value="2" code="461599"/>  <!-- 条件冲正-->
			<Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
		</Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<!--zhongshan add-->
			<Set>BilSts=U</Set>
			<Set>CmdCod=317</Set>
			<Set>TxnTyp=N</Set>
			<Set>OIFlag=O</Set>
			<Set>TxnAmt=ADDCHAR(MUL(ADD($BilAmt,$PenAmt),100),15,0,1)</Set><!--zs0309add MUL-->
			<!--end-->
			<Exec func="PFA:GenPrvData">
				<Arg name="PrjNum" value="PrjNum" desc="收费项目笔数"/>
				<Arg name="GrpNam" value="PrjRec" desc="收费项目结构"/>
				<Arg name="RmkNum" value="RmkNum" desc="额外信息笔数"/>
				<Arg name="GrpNam" value="RmkRec" desc="额外信息结构"/>
			</Exec>
			<Set>BilSts=U</Set>
			<Exec func="PUB:GetLogNo"/>
			<Set>CmtCod=317</Set>
			<Quote name="BokAccPro"/>
			<!--zhongshan add-->
			<If condition="IS_EQUAL_STRING($BilSts,B)">   <!--记帐成功-->
			  <Exec func="PUB:InsertRecord">   <!--zhongshan add-->
			     <Args>
				       <Arg name="tablename" value="PntTxnBok"/>
			     </Args>
		    </Exec>
			  <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
             <Arg name="SqlCmd" value="UpdPJNum"/> 
        </Exec>
       <!-- end--> 			
			<Set>BokFlg=1</Set>
			<Quote name="SndThdPro"/>
		<!--zhongshan add-->
		</If>	
		<Else>
				<Set>MsgTyp=E</Set>
		</Else>
		<!--end-->
		</FlowCtrl>
	</Transaction>


	<Transaction code="461504" desc="不需要手工录入">
		<Quote name="PntSqlLst"/>
		<Attributes>
			<Attribute name="integrity" value="2" code="461599"/>  <!-- 条件冲正-->
		</Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PUB:GetLogNo"/>
			<Set>BilSts=U</Set>
			<Set>CmdCod=313</Set>
			<Set>TxnTyp=N</Set>
			<Set>OIFlag=O</Set>
			<Set>TxnAmt=ADDCHAR(MUL(ADD($BilAmt,$PenAmt),100),15,0,1)</Set><!--zs0309add MUL-->
			<Exec func="PFA:GenPrvData">
				<Arg name="PrjNum" value="PrjNum" desc="收费项目笔数"/>
				<Arg name="GrpNam" value="PrjRec" desc="收费项目结构"/>
				<Arg name="RmkNum" value="RmkNum" desc="额外信息笔数"/>
				<Arg name="GrpNam" value="RmkRec" desc="额外信息结构"/>
			</Exec>									
			<Quote name="BokAccPro"/>
			<If condition="IS_EQUAL_STRING($BilSts,B)">   <!--记帐成功-->
			  <Exec func="PUB:InsertRecord">   <!--zhongshan add-->
			     <Args>
				       <Arg name="tablename" value="PntTxnBok"/>
			     </Args>
		    </Exec>
			  <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
             <Arg name="SqlCmd" value="UpdPJNum"/> 
        </Exec>        
				<Set>BokFlg=1</Set>
				<Set>CmtCod=313</Set>
				<Quote name="SndThdPro"/>
			</If>
			<Else>
				<Set>MsgTyp=E</Set>
			</Else>
		</FlowCtrl>
	</Transaction>



	<Transaction code="461505" desc="冲正缴费">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<!--zs0311modify GetTxnJnlByTBilNo 为 GetTxnJnlByLogNo-->
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="sql" value="GetTxnJnlByTBilNo"/>
			</Exec>
			<If condition="INTCMP(~RetCod,3,-1)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=数据库查询失败</Set>
				<Return/>
			</If>
			<If condition="INTCMP(~RetCod,3,-2)">   <!--原记录不存在-->
				<Set>MsgTyp=N</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=STRCAT(缴费记录【,$TCrpCd,-,$TVchId,-,$TBilTp,-,$TBilNo,】不存在)</Set>
				<Return/>
			</If>
			<If condition="IS_NOEQUAL_STRING($ActDat,$OActDat)">   <!--记帐日与会计日不符-->
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=STRCAT(缴费日期【,$OActDat,-,$ActDat,】非同一会计日期，不能冲正)</Set>
				<Return/>
			</If>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="TxnCod" value="314"/>
				<Arg name="ObjSvr" value="STHDPNT1"/>
			</Exec>
			<Switch expression="~RetCod">
				<Case value="0"> <!--交易成功-->
					<Quote name="CanAccPro"/>
					<Set>MsgTyp=N</Set>
					<Set>RspCod=000000</Set>
					<Break/>
				</Case>
				<Case value="3">  <!--交易失败-->
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Break/>
				</Case>
				<Case value="-2"/>  <!--系统错误-->
				<Case value="-10">  <!--未发送-->
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Set>RspMsg=网络故障,稍后请重做交易</Set>
					<Break/>
				</Case>
				<Case value="-1">  <!--超时-->
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Set>RspMsg=交易超时,请联系业务管理部门</Set>
					<Break/>
				</Case>
				<Default>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Set>其他错误,请联系相关技术部门</Set>
					<Break/>
				</Default>
			</Switch>
		</FlowCtrl>
	</Transaction>



	<Transaction code="461506" desc="更换票据">
		<Quote name="PntSqlLst"/>
		<Attributes>
			<Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
		</Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Set>BokFlg=0</Set>
			<Set>CmtCod=315</Set>
		<Exec func="PUB:CallThirdOther" error="IGNORE">
			<Arg name="TxnCod" value="$CmtCod"/>
			<Arg name="ObjSvr" value="STHDPNT1"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="0"> <!--交易成功-->
        <Exec func="PUB:ReadRecord" error="IGNORE">    <!--zhongshan add-->
             <Arg name="SqlCmd" value="GetLog"/> 
        </Exec>   
			  <If condition="INTCMP(~RetCod,3,-1)">
				  <Set>MsgTyp=E</Set>
				  <Set>RspCod=PNT999</Set>
				  <Set>RspMsg=数据库查询失败</Set>
				  <Return/>
			  </If>
			  <If condition="INTCMP(~RetCod,3,-2)">   <!--原记录不存在-->
				  <Set>MsgTyp=N</Set>
				  <Set>RspCod=PNT999</Set>
				  <Set>RspMsg=STRCAT(缴费记录【,$TCrpCd,-,$TVchId,-,$TBilTp,-,$TBilNo,】不存在)</Set>
				  <Return/>
			  </If>
        <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
             <Arg name="SqlCmd" value="UpdTxnBok"/> 
        </Exec>        
        
        <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
             <Arg name="SqlCmd" value="UpdTxnJnl"/> 
        </Exec>     
        
        <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
             <Arg name="SqlCmd" value="InsPJNum"/> 
        </Exec>
        <Set>MsgTyp=N</Set>
			  <Set>RspCod=000000</Set>                        
				<Break/>
			</Case>
			<Case value="-10"/>  <!--未发送-->
			  <Set>MsgTyp=E</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=网络故障,稍后请重做交易</Set>
			<Case value="-2">  <!--系统错误-->
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=系统错误</Set>
				<Break/>
			</Case>
			<Case value="3">  <!--交易失败-->
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=交易失败</Set>
				<Break/>
			</Case>
			<Case value="-1">  <!--超时-->
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=交易超时</Set>
				<Break/>
			</Case>
			<Default>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=其他错误,请联系相关技术部门</Set>
				<Break/>
			</Default>
		</Switch>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461507" desc="作废票据">
		<Quote name="PntSqlLst"/>
		<Attributes>
			<Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
		</Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Set>BokFlg=0</Set>
			<Set>ThdCod=316</Set>
			<Quote name="SndThdPro"/>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461508" desc="银行系统产生的收款信息文件">
		<Quote name="PntSqlLst"/>
		<DynSentence name="GetChkDtl">
			<Sentence>
				select TBilTp,TBilNo,TxnAmt from PntTxnJnl where ActDat='%s' and BilSts='S'
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		<!--zhongshan add-->
		<DynSentence name="GetTot">
			<Sentence>
				select sum(cast(txnamt as bigint)) as TotAmt,coalesce(COUNT(*),0) TotNum from PntTxnJnl where ActDat='%s' and BilSts='S'
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="InitTran"/>
<!--获取批次号-->
			<Exec func="PUB:nGetPubSeqNo">
				<Arg name="SeqNam" value="Pnt:SelVal"/>
				<Arg name="SeqCnt" value="1"/>
				<Arg name="Len"    value="2"/>
				<Arg name="CycCnd" value="D"/>
			</Exec>
			<Set>FilNam=STRCAT(YHSK,$BankCd,$ActDat,$SelVal,.txt)</Set> <!--zhongshan modify WordDt for ActDat-->
			<Set>DatFil=STRCAT($PntSndDir,yhsc/,$FilNam )</Set> 
<!--为避免同一分行并发-->
			<Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="sql" value="GetTot"/>
			</Exec>
<!--文件头-->
			<Exec func="PUB:WriteFile" error="IGNORE">
				<Arg name="FileName" value="$DatFil"/>
				<Arg name="OpenMode" value="w"/>
				<Arg name="Data"	   value="$BankCd"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$ActDat"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$TotNum"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="AMTSIMPLEFMT($TotAmt)"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="ESCFMT"   value="\\n"/>
				<Arg name="ESCFMT"   value="\\n"/> <!--zhongshan add-->
			</Exec>
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql" value="GetChkDtl"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标【GetChkDtl】出错</Set>
				<Return/>
			</If>
			<Set>Num=0</Set>
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/>
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<Exec func="PUB:WriteFile" error="IGNORE">
					<Arg name="FileName" value="$DatFil"/>
					<Arg name="OpenMode" value="a+"/>
					<Arg name="Data"	   value="$TBilTp"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$TBilNo"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="AMTSIMPLEFMT($TxnAmt)"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="ESCFMT"   value="\\n"/>
				</Exec>
			</While>
			<Set>ObjFil=$FilNam</Set>   <!--zhongshan add-->
			<Set>LclFil=$FilNam</Set>   <!--zhongshan add-->
			<Exec func="PUB:FtpPut">
				<Arg name="FtpId" value="PNT003"/>
			</Exec>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461509" desc="非税系统产生的收款问题账务信息文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<!--zhongshan add-->
		<Quote name="InitTran"/>
		<!--获取批次号-->
			<Exec func="PUB:nGetPubSeqNo">
				<Arg name="SeqNam" value="Pntwt:SelVal"/>
				<Arg name="SeqCnt" value="1"/>
				<Arg name="Len"    value="2"/>
				<Arg name="CycCnd" value="D"/>
			</Exec>
			<Set>LclFil=STRCAT(WTZW442000010,$ActDat,$SelVal,.txt)</Set>
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT002"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
	    <!--end-->
			<Set>DatFil=STRCAT( $PntRcvDir,wtzw/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="WTZWHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<!--zhongshan add -->
			<Exec func="PUB:GetFileLine" error="IGNORE">
        <Arg name="FieldName" value="DatFNms"/>
      </Exec>
      <!--end-->
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="WTZWTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($TitNum,3,$DtlNum)">
						<Break/>
					</If>
					<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
						<Arg name="ConfigName" value="BatFormat"/>
						<Arg name="RootName"   value="BATCH"/>
						<Arg name="NodeName"   value="Process"/>
						<Arg name="AttrName"   value="name"/>
						<Arg name="AttrValue"  value="WTZWDATA"/>
						<Arg name="MaxLen"     value="100000"/>
					</Exec>
				  <Exec func="PUB:InsertRecord">   <!--zhongshan add-->
			     <Args>
				       <Arg name="tablename" value="PntWtzw"/>
			     </Args>
		      </Exec>
					<Set>DtlNum=ADD($DtlNum,1)</Set>
				</While>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>




	<Transaction code="461510" desc="非税系统产生的批量扣收指令信息文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
			<Set>DatFil=STRCAT( $PntSndDir,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="PLKSHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLine" error="IGNORE">
					<Arg name="FieldName" value="LinData"/>
				</Exec>
				<Exec func="PNT:GenDBCol">
					<Arg name="LinData" value="$LinData" desc="行记录"/>
				</Exec>
				<Exec func="PFA:GenPrvData">
					<Arg name="PrjNum" value="PrjNum" desc="收费项目笔数"/>
					<Arg name="PrjGrp" value="PrjRec" desc="收费项目结构"/>
					<Arg name="RmkNum" value="RmkNum" desc="额外信息笔数"/>
					<Arg name="RmkGrp" value="RmkRec" desc="额外信息结构"/>
				</Exec>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>

	<Transaction code="461516" desc="非税基础数据同步">
		<DynSentence name="Delsfxm">
			<Sentence>
        delete from pntsfxmtmp
			</Sentence>	
	  </DynSentence>
		<DynSentence name="Qrysfxm1">
			<Sentence>
        select count(*) SfxmCnt from pntsfxmtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrysfxm2">
			<Sentence>
        select count(*) SfxmCnt from pntsfxmtmp where synchtype='2'
			</Sentence>
		</DynSentence>			
		<DynSentence name="Insert_sfxm">
			<Sentence>
        insert into pntsfxm(brno,prjcod,prjnam,subcod,subnam,sfxmsts) select brno,prjcod,prjnam,subcod,subnam,sfxmsts from pntsfxmtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrysfxm3">
			<Sentence>
			  select Brno,Synchtype,prjcod,prjnam,subcod,subnam,sfxmsts from pntsfxmtmp where synchtype='2'
      </Sentence>
		</DynSentence>
		<DynSentence name="Update_sfxm">
			<Sentence>
			  update pntsfxm set Brno='%s',prjnam='%s',subnam='%s',sfxmsts='%s' where prjcod='%s' and subcod='%s'
      </Sentence>
      <Fields>Brno|prjnam|subnam|sfxmsts|prjcod|subcod</Fields>
		</DynSentence>
		<!--单位信息-->
		<DynSentence name="Delsdwxx">
			<Sentence>
        delete from pntdwxxtmp
			</Sentence>	
	  </DynSentence>
		<DynSentence name="Qrydwxx1">
			<Sentence>
        select count(*) DwxxCnt from pntdwxxtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrydwxx2">
			<Sentence>
        select count(*) DwxxCnt from pntdwxxtmp where synchtype='2'
			</Sentence>
		</DynSentence>			
		<DynSentence name="Insert_dwxx">
			<Sentence>
        insert into pntdwxx(brno,TCrpCd,TCrpNm,DwxxSts) select brno,TCrpCd,TCrpNm,DwxxSts from pntdwxxtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrydwxx3">
			<Sentence>
			  select Brno,Synchtype,TCrpCd,TCrpNm,DwxxSts from pntdwxxtmp where synchtype='2'
      </Sentence>
		</DynSentence>
		<DynSentence name="Update_dwxx">
			<Sentence>
			  update pntdwxx set Brno='%s',TCrpNm='%s',DwxxSts='%s' where TCrpCd='%s' 
      </Sentence>
      <Fields>Brno|TCrpNm|DwxxSts|TCrpCd|</Fields>
		</DynSentence>	
		<!--单位项目信息-->
		<DynSentence name="Delsdwxm">
			<Sentence>
        delete from pntdwxmtmp
			</Sentence>	
	  </DynSentence>
		<DynSentence name="Qrydwxm1">
			<Sentence>
        select count(*) DwxmCnt from pntdwxmtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrydwxm2">
			<Sentence>
        select count(*) DwxmCnt from pntdwxmtmp where synchtype='3'
			</Sentence>
		</DynSentence>			
		<DynSentence name="Insert_dwxm">
			<Sentence>
        insert into pntdwxm(brno,TCrpCd,PrjCod) select brno,TCrpCd,PrjCod from pntdwxmtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrydwxm3">
			<Sentence>
			  select Brno,Synchtype,TCrpCd,PrjCod from pntdwxmtmp where synchtype='3'
      </Sentence>
		</DynSentence>
		<DynSentence name="Delete_dwxm">
			<Sentence>
			  delete from pntdwxm where brno='%s' and TCrpCd='%s' and PrjCod='%s' 
      </Sentence>
      <Fields>Brno|TCrpCd|PrjCod|</Fields>
		</DynSentence>	
		<!--票据类型信息-->
	  <DynSentence name="Delspjlx">
			<Sentence>
        delete from pntpjlxtmp
			</Sentence>	
	  </DynSentence>
		<DynSentence name="Qrypjlx1">
			<Sentence>
        select count(*) PjlxCnt from pntpjlxtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrypjlx2">
			<Sentence>
        select count(*) PjlxCnt from pntpjlxtmp where synchtype='2'
			</Sentence>
		</DynSentence>			
		<DynSentence name="Insert_pjlx">
			<Sentence>
        insert into pntpjlx(brno,TBilTp,TBilNm,PjlxSts) select brno,TBilTp,TBilNm,PjlxSts from pntpjlxtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrypjlx3">
			<Sentence>
			  select Brno,Synchtype,TBilTp,TBilNm,PjlxSts from pntpjlxtmp where synchtype='2'
      </Sentence>
		</DynSentence>
		<DynSentence name="Update_pjlx">
			<Sentence>
        update pntpjlx set Brno='%s',TBilNm='%s',PjlxSts='%s' where TBilTp='%s' 
      </Sentence>
      <Fields>Brno|TBilNm|PjlxSts|TBilTp|</Fields>
		</DynSentence>
		<!--票据发放信息-->
	  <DynSentence name="Delspjff">
			<Sentence>
        delete from pntpjfftmp
			</Sentence>	
	  </DynSentence>
		<DynSentence name="Qrypjff1">
			<Sentence>
        select count(*) PjffCnt from pntpjfftmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrypjff2">
			<Sentence>
        select count(*) PjffCnt from pntpjfftmp where synchtype='3'
			</Sentence>
		</DynSentence>			
		<DynSentence name="Insert_pjff">
			<Sentence>
        insert into pntpjff(brno,TBilTp,TBilStar,TBilEnd,TBilTot,TBilSts) select brno,TBilTp,TBilStar,TBilEnd,TBilTot,SynchType from pntpjfftmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qrypjff3">
			<Sentence>
			  select Brno,Synchtype,TBilTp,TBilStar,TBilEnd,TBilTot,TBilSts from pntpjfftmp where synchtype='3'
      </Sentence>
		</DynSentence>
		<DynSentence name="Update_pjff">
			<Sentence>
        update pntpjff set Brno='%s',TBilStar='%s',TBilEnd='%s',TBilNum='%s',TBilTot='%s',TBilSts='%s' where TBilTp='%s' 
      </Sentence>
      <Fields>Brno|TBilStar|TBilEnd|TBilTot|SynchType|TBilTp|</Fields>
		</DynSentence>
		<!--项目票据信息表-->
		<DynSentence name="Delsxmpj">
			<Sentence>
        delete from pntxmpjtmp
			</Sentence>	
	  </DynSentence>
		<DynSentence name="Qryxmpj1">
			<Sentence>
        select count(*) XmpjCnt from pntxmpjtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qryxmpj2">
			<Sentence>
        select count(*) XmpjCnt from pntxmpjtmp where synchtype='3'
			</Sentence>
		</DynSentence>			
		<DynSentence name="Insert_xmpj">
			<Sentence>
        insert into pntxmpj(brno,PrjCod,TBilTp) select brno,PrjCod,TBilTp from pntxmpjtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qryxmpj3">
			<Sentence>
			  select Brno,PrjCod,TBilTp from pntxmpjtmp where synchtype='3'
      </Sentence>
		</DynSentence>
		<DynSentence name="Delete_xmpj">
			<Sentence>
        delete from PntXmpj where  Brno='%s' and PrjCod='%s' and TBilTp='%s' 
      </Sentence>
      <Fields>Brno|PrjCod|TBilTp|</Fields>
		</DynSentence>	
		<!--区域信息-->
		<DynSentence name="Delsqyxx">
			<Sentence>
        delete from pntqyxxtmp
			</Sentence>	
	  </DynSentence>
		<DynSentence name="Qryqyxx1">
			<Sentence>
        select count(*) QyxxCnt from pntqyxxtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qryqyxx2">
			<Sentence>
        select count(*) QyxxCnt from pntqyxxtmp where synchtype='2'
			</Sentence>
		</DynSentence>			
		<DynSentence name="Insert_qyxx">
			<Sentence>
        insert into pntqyxx(brno,areano,areanm) select brno,areano,areanm from pntqyxxtmp where synchtype='1'
			</Sentence>
		</DynSentence>	
		<DynSentence name="Qryqyxx3">
			<Sentence>
			  select Brno,areano,areanm from pntqyxxtmp where synchtype='2'
      </Sentence>
		</DynSentence>
		<DynSentence name="Update_qyxx">
			<Sentence>
        update PntQyxx set Brno='%s',areanm='%s' where areano='%s' 
      </Sentence>
      <Fields>Brno|areanm|areano|</Fields>
		</DynSentence>	
		    																																																												
		<FlowCtrl>
       <Exec func="PUB:InitTransaction"/>
       <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delsfxm"></Arg>
       </Exec>       
       <!--检查交易并发-->
       <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
       <Exec func="PUB:Lock">
            <Arg name="RecKey" value="$RecKey"/>
            <Arg name="TimOut" value="1000"/>
            <Arg name="AutoUnlock" value="yes"/>
       </Exec>
       <Set>SrcFil=STRCAT(GETENV(WORKDIR),/dat/pnt/recv/jcsj,sfxm.txt)</Set>
       <Exec func="PUB:IsValidFile">
          <Arg name="FileName" value="$SrcFil"/>
       </Exec>
       <Exec func="PUB:ImportToDB">     <!--将文件拆分入批量明细表-->
          <Arg name="FormatName" value="SFXM"/>
          <Arg name="FileName"   value="$SrcFil"/>
          <Arg name="TableName"  value="PntSfxmtmp"/>
          <Arg name="ApplyLogNoFlag" value="0"/>
       </Exec>
      
       <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="Qrysfxm1"></Arg>
       </Exec>
			 <If condition="INTCMP($SfxmCnt,6,0)">
          <Exec func="PUB:ExecSql">
             <Arg name="SqlCmd" value="Insert_sfxm"/>
          </Exec>			 
			 </If>
          <Exec func="PUB:ReadRecord" error="IGNORE">
             <Arg name="SqlCmd" value="Qrysfxm2"></Arg>
          </Exec>
			 <If condition="INTCMP($SfxmCnt,6,0)">
          <Exec func="PUB:OpenCursor" error="IGNORE">
				     <Arg name="sql" value="Qrysfxm3"/>
				     <Arg name="CursorName" value="CURSOR_1"/>
			    </Exec>
			    <If condition="~RetCod!=0">
            <Exec func="PUB:Unlock">
               <Arg name="RecKey" value="$RecKey"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
			    <Set>Num=0</Set>
			    <While>
				     <Exec func="PUB:FetchCursor" error="IGNORE"/>
				     <If condition="~RetCod=100">
					     <Break/>
				     </If>
				  <Exec func="PUB:ExecSql" error="IGNORE">   
             <Arg name="SqlCmd" value="Update_sfxm"/>
          </Exec>				     
			    </While>
          <Exec func="PUB:CloseCursor" error="IGNORE">
              <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
			 </If>
       <Set>MsgTyp=N</Set>
       <Set>RspCod=000000</Set>   
       <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
            <Arg name="RecKey" value="$RecKey"/>
       </Exec>  
       
       <!--单位信息表导入-->      
       <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delsdwxx"></Arg>
       </Exec>       
       <!--检查交易并发-->
       <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
       <Exec func="PUB:Lock">
            <Arg name="RecKey" value="$RecKey"/>
            <Arg name="TimOut" value="1000"/>
            <Arg name="AutoUnlock" value="yes"/>
       </Exec>
       <Set>SrcFil=STRCAT(GETENV(WORKDIR),/dat/pnt/recv/jcsj,dwxx.txt)</Set>
       <Exec func="PUB:IsValidFile">
          <Arg name="FileName" value="$SrcFil"/>
       </Exec>
       <Exec func="PUB:ImportToDB">     <!--将文件拆分入批量明细表-->
          <Arg name="FormatName" value="DWXX"/>
          <Arg name="FileName"   value="$SrcFil"/>
          <Arg name="TableName"  value="Pntdwxxtmp"/>
          <Arg name="ApplyLogNoFlag" value="0"/>
       </Exec>
      
       <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="Qrydwxx1"></Arg>
       </Exec>
			 <If condition="INTCMP($DwxxCnt,6,0)">
          <Exec func="PUB:ExecSql">
             <Arg name="SqlCmd" value="Insert_dwxx"/>
          </Exec>			 
			 </If>
       <Exec func="PUB:ReadRecord" error="IGNORE">
             <Arg name="SqlCmd" value="Qrydwxx2"></Arg>
       </Exec>
			 <If condition="INTCMP($DwxxCnt,6,0)">
          <Exec func="PUB:OpenCursor" error="IGNORE">
				     <Arg name="sql" value="Qrydwxx3"/>
			    </Exec>
			    <If condition="~RetCod!=0">
            <Exec func="PUB:Unlock">
               <Arg name="RecKey" value="$RecKey"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
			    <Set>Num=0</Set>
			    <While>
				     <Exec func="PUB:FetchCursor" error="IGNORE"/>
				     <If condition="~RetCod=100">
					     <Break/>
				     </If>
				  <Exec func="PUB:ExecSql" error="IGNORE">   
             <Arg name="SqlCmd" value="Update_dwxx"/>
          </Exec>				     
			    </While>
			    <Exec func="PUB:CloseCursor"/>
			 </If>
       <Set>MsgTyp=N</Set>
       <Set>RspCod=000000</Set>   
       <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
            <Arg name="RecKey" value="$RecKey"/>
       </Exec>       
      
       <!--单位项目信息表导入-->      
       <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delsdwxm"></Arg>
       </Exec>       
       <!--检查交易并发-->
       <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
       <Exec func="PUB:Lock">
            <Arg name="RecKey" value="$RecKey"/>
            <Arg name="TimOut" value="1000"/>
            <Arg name="AutoUnlock" value="yes"/>
       </Exec>
       <Set>SrcFil=STRCAT(GETENV(WORKDIR),/dat/pnt/recv/jcsj,dwxm.txt)</Set>
       <Exec func="PUB:IsValidFile">
          <Arg name="FileName" value="$SrcFil"/>
       </Exec>
       <Exec func="PUB:ImportToDB">     <!--将文件拆分入批量明细表-->
          <Arg name="FormatName" value="DWXM"/>
          <Arg name="FileName"   value="$SrcFil"/>
          <Arg name="TableName"  value="PntDwxmtmp"/>
          <Arg name="ApplyLogNoFlag" value="0"/>
       </Exec>
      
       <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="Qrydwxm1"></Arg>
       </Exec>
			 <If condition="INTCMP($DwxmCnt,6,0)">
          <Exec func="PUB:ExecSql">
             <Arg name="SqlCmd" value="Insert_dwxm"/>
          </Exec>			 
			 </If>
       <Exec func="PUB:ReadRecord" error="IGNORE">
             <Arg name="SqlCmd" value="Qrydwxm2"></Arg>
       </Exec>
			 <If condition="INTCMP($DwxmCnt,6,0)">
          <Exec func="PUB:OpenCursor" error="IGNORE">
				     <Arg name="sql" value="Qrydwxm3"/>
			    </Exec>
			    <If condition="~RetCod!=0">
            <Exec func="PUB:Unlock">
               <Arg name="RecKey" value="$RecKey"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
			    <Set>Num=0</Set>
			    <While>
				     <Exec func="PUB:FetchCursor" error="IGNORE"/>
				     <If condition="~RetCod=100">
					     <Break/>
				     </If>
				     <Exec func="PUB:ExecSql" error="IGNORE">   
               <Arg name="SqlCmd" value="Delete_dwxm"/>
             </Exec>				     
			    </While>
			    <Exec func="PUB:CloseCursor"/>
			 </If>
       <Set>MsgTyp=N</Set>
       <Set>RspCod=000000</Set>   
       <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
            <Arg name="RecKey" value="$RecKey"/>
       </Exec>  
       <!--票据类型信息-->
       <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delspjlx"></Arg>
       </Exec>       
       <!--检查交易并发-->
       <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
       <Exec func="PUB:Lock">
            <Arg name="RecKey" value="$RecKey"/>
            <Arg name="TimOut" value="1000"/>
            <Arg name="AutoUnlock" value="yes"/>
       </Exec>
       <Set>SrcFil=STRCAT(GETENV(WORKDIR),/dat/pnt/recv/jcsj,pjlx.txt)</Set>
       <Exec func="PUB:IsValidFile">
          <Arg name="FileName" value="$SrcFil"/>
       </Exec>
       <Exec func="PUB:ImportToDB">     <!--将文件拆分入批量明细表-->
          <Arg name="FormatName" value="PJLX"/>
          <Arg name="FileName"   value="$SrcFil"/>
          <Arg name="TableName"  value="PntPjlxtmp"/>
          <Arg name="ApplyLogNoFlag" value="0"/>
       </Exec>
      
       <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="Qrypjlx1"></Arg>
       </Exec>
			 <If condition="INTCMP($PjlxCnt,6,0)">
          <Exec func="PUB:ExecSql">
             <Arg name="SqlCmd" value="Insert_pjlx"/>
          </Exec>			 
			 </If>
       <Exec func="PUB:ReadRecord" error="IGNORE">
             <Arg name="SqlCmd" value="Qrypjlx2"></Arg>
       </Exec>
			 <If condition="INTCMP($PjlxCnt,6,0)">
          <Exec func="PUB:OpenCursor" error="IGNORE">
				     <Arg name="sql" value="Qrypjlx3"/>
			    </Exec>
			    <If condition="~RetCod!=0">
            <Exec func="PUB:Unlock">
               <Arg name="RecKey" value="$RecKey"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
			    <Set>Num=0</Set>
			    <While>
				     <Exec func="PUB:FetchCursor" error="IGNORE"/>
				     <If condition="~RetCod=100">
					     <Break/>
				     </If>
				     <Exec func="PUB:ExecSql" error="IGNORE">   
               <Arg name="SqlCmd" value="Update_pjlx"/>
             </Exec>				     
			    </While>
			    <Exec func="PUB:CloseCursor"/>
			 </If>
       <Set>MsgTyp=N</Set>
       <Set>RspCod=000000</Set>   
       <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
            <Arg name="RecKey" value="$RecKey"/>
       </Exec>      
       <!--票据发放-->
       <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delspjff"></Arg>
       </Exec>       
       <!--检查交易并发-->
       <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
       <Exec func="PUB:Lock">
            <Arg name="RecKey" value="$RecKey"/>
            <Arg name="TimOut" value="1000"/>
            <Arg name="AutoUnlock" value="yes"/>
       </Exec>
       <Set>SrcFil=STRCAT(GETENV(WORKDIR),/dat/pnt/recv/jcsj,pjff.txt)</Set>
       <Exec func="PUB:IsValidFile">
          <Arg name="FileName" value="$SrcFil"/>
       </Exec>

       <Exec func="PUB:ImportToDB" error="IGNORE">     <!--将文件拆分入批量明细表-->
          <Arg name="FormatName" value="PJFF"/>
          <Arg name="FileName"   value="$SrcFil"/>
          <Arg name="TableName"  value="PntPjfftmp"/>
          <Arg name="ApplyLogNoFlag" value="0"/>
       </Exec>
       
       <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="Qrypjff1"></Arg>
       </Exec>
			 <If condition="INTCMP($PjffCnt,6,0)">
          <Exec func="PUB:ExecSql">
             <Arg name="SqlCmd" value="Insert_pjff"/>
          </Exec>			 
			 </If>
       <Exec func="PUB:ReadRecord" error="IGNORE">
             <Arg name="SqlCmd" value="Qrypjff2"></Arg>
       </Exec>
			 <If condition="INTCMP($PjffCnt,6,0)">
          <Exec func="PUB:OpenCursor" error="IGNORE">
				     <Arg name="sql" value="Qrypjff3"/>
			    </Exec>
			    <If condition="~RetCod!=0">
            <Exec func="PUB:Unlock">
               <Arg name="RecKey" value="$RecKey"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
			    <Set>Num=0</Set>
			    <While>
				     <Exec func="PUB:FetchCursor" error="IGNORE"/>
				     <If condition="~RetCod=100">
					     <Break/>
				     </If>
				     <Exec func="PUB:ExecSql" error="IGNORE">   
               <Arg name="SqlCmd" value="Update_pjff"/>
             </Exec>				     
			    </While>
			    <Exec func="PUB:CloseCursor"/>
			 </If>
       <Set>MsgTyp=N</Set>
       <Set>RspCod=000000</Set>   
       <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
            <Arg name="RecKey" value="$RecKey"/>
       </Exec> 
       <!--项目票据信息表-->
       <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delsxmpj"></Arg>
       </Exec>       
       <!--检查交易并发-->
       <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
       <Exec func="PUB:Lock">
            <Arg name="RecKey" value="$RecKey"/>
            <Arg name="TimOut" value="1000"/>
            <Arg name="AutoUnlock" value="yes"/>
       </Exec>
       <Set>SrcFil=STRCAT(GETENV(WORKDIR),/dat/pnt/recv/jcsj,xmpj.txt)</Set>
       <Exec func="PUB:IsValidFile">
          <Arg name="FileName" value="$SrcFil"/>
       </Exec>

       <Exec func="PUB:ImportToDB" error="IGNORE">     <!--将文件拆分入批量明细表-->
          <Arg name="FormatName" value="XMPJ"/>
          <Arg name="FileName"   value="$SrcFil"/>
          <Arg name="TableName"  value="PntXmpjtmp"/>
          <Arg name="ApplyLogNoFlag" value="0"/>
       </Exec>
       
       <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="Qryxmpj1"></Arg>
       </Exec>
			 <If condition="INTCMP($XmpjCnt,6,0)">
          <Exec func="PUB:ExecSql">
             <Arg name="SqlCmd" value="Insert_xmpj"/>
          </Exec>			 
			 </If>
       <Exec func="PUB:ReadRecord" error="IGNORE">
             <Arg name="SqlCmd" value="Qryxmpj2"></Arg>
       </Exec>
			 <If condition="INTCMP($XmpjCnt,6,0)">
          <Exec func="PUB:OpenCursor" error="IGNORE">
				     <Arg name="sql" value="Qryxmpj3"/>
			    </Exec>
			    <If condition="~RetCod!=0">
            <Exec func="PUB:Unlock">
               <Arg name="RecKey" value="$RecKey"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
			    <Set>Num=0</Set>
			    <While>
				     <Exec func="PUB:FetchCursor" error="IGNORE"/>
				     <If condition="~RetCod=100">
					     <Break/>
				     </If>
				     <Exec func="PUB:ExecSql" error="IGNORE">   
               <Arg name="SqlCmd" value="Delete_xmpj"/>
             </Exec>				     
			    </While>
			    <Exec func="PUB:CloseCursor"/>
			 </If>
       <Set>MsgTyp=N</Set>
       <Set>RspCod=000000</Set>   
       <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
            <Arg name="RecKey" value="$RecKey"/>
       </Exec>   
       <!--区域信息-->
       <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delsqyxx"></Arg>
       </Exec>       
       <!--检查交易并发-->
       <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
       <Exec func="PUB:Lock">
            <Arg name="RecKey" value="$RecKey"/>
            <Arg name="TimOut" value="1000"/>
            <Arg name="AutoUnlock" value="yes"/>
       </Exec>
       <Set>SrcFil=STRCAT(GETENV(WORKDIR),/dat/pnt/recv/jcsj,qyxx.txt)</Set>
       <Exec func="PUB:IsValidFile">
          <Arg name="FileName" value="$SrcFil"/>
       </Exec>

       <Exec func="PUB:ImportToDB" error="IGNORE">     <!--将文件拆分入批量明细表-->
          <Arg name="FormatName" value="QYXX"/>
          <Arg name="FileName"   value="$SrcFil"/>
          <Arg name="TableName"  value="PntQyxxtmp"/>
          <Arg name="ApplyLogNoFlag" value="0"/>
       </Exec>
       
       <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="Qryqyxx1"></Arg>
       </Exec>
			 <If condition="INTCMP($QyxxCnt,6,0)">
          <Exec func="PUB:ExecSql">
             <Arg name="SqlCmd" value="Insert_qyxx"/>
          </Exec>			 
			 </If>
       <Exec func="PUB:ReadRecord" error="IGNORE">
             <Arg name="SqlCmd" value="Qryqyxx2"></Arg>
       </Exec>
			 <If condition="INTCMP($QyxxCnt,6,0)">
          <Exec func="PUB:OpenCursor" error="IGNORE">
				     <Arg name="sql" value="Qryqyxx3"/>
			    </Exec>
			    <If condition="~RetCod!=0">
            <Exec func="PUB:Unlock">
               <Arg name="RecKey" value="$RecKey"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
			    <Set>Num=0</Set>
			    <While>
				     <Exec func="PUB:FetchCursor" error="IGNORE"/>
				     <If condition="~RetCod=100">
					     <Break/>
				     </If>
				     <Exec func="PUB:ExecSql" error="IGNORE">   
               <Arg name="SqlCmd" value="Update_qyxx"/>
             </Exec>				     
			    </While>
			    <Exec func="PUB:CloseCursor"/>
			 </If>
       <Set>MsgTyp=N</Set>
       <Set>RspCod=000000</Set>   
       <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
            <Arg name="RecKey" value="$RecKey"/>
       </Exec>                                 
                                                                                                    
		</FlowCtrl>
	</Transaction>

  <Transaction code="461597" desc="查询票据">
    <DynSentence name="QryPJInf">
      <Sentence>
        select TBilStar,TBilNo,TBilNum,TBilTot from pntpjff where TBilTp='%s' and TBilSts='1'
      </Sentence>
      <Fields>TBilTp|</Fields>
    </DynSentence>
    <DynSentence name="QryPJNum">
      <Sentence>
        select TBilNo from pntpjnum where TBilTp='%s' and TBilsts='2' 
      </Sentence>
      <Fields>TBilTp|</Fields>
    </DynSentence>    
    <DynSentence name="UpdatePJInf">
      <Sentence>
        update pntpjff set TBilNo='%s',TBilTot='%s',TBilNum='%s' where TBilTp='%s' and TBilSts='1'
      </Sentence>
      <Fields>TBilNo|TBilTot|TBilNum|TBilTp|</Fields>
    </DynSentence>
    <DynSentence name="InsertPJInf">
      <Sentence>
        insert into PntPjNum (TBilTp,TBilNo,TBilSts) values ('%s','%s','%s')
      </Sentence>
      <Fields>TBilTp|TBilNo|TBilSts|</Fields>
    </DynSentence>    
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
             <!--检查交易并发-->
       <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
       <Exec func="PUB:Lock">
            <Arg name="RecKey" value="$RecKey"/>
            <Arg name="TimOut" value="1000"/>
            <Arg name="AutoUnlock" value="yes"/>
       </Exec>
       <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="QryPJNum" />
        </Args>
       </Exec> 
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
    <If condition="~RetCod=-2">  
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="QryPJInf" />
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="~RetCod=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=票据类型不存在</Set>
        <Return/>
      </If>
      <If condition="INTCMP($TBilTot,3,$TBilNum)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=票据号码已用完</Set>
        <Return/>
      </If>      
      <If condition="INTCMP($TBilNum,3,0)">
        <Set>$TBilNo=$TBilStar</Set>
        <Set>$TBilNum=0</Set>
      </If>
      <Else>
      <Set>$TBilNo=STRCAT(SUBSTR($TBilNo,1,SUB(STRLEN($TBilNo),STRLEN($TBilTot))),INTTOSTR(ADD(SUBSTR($TBilNo,ADD(SUB(STRLEN($TBilNo),STRLEN($TBilTot)),1),STRLEN($TBilTot)),1),STRLEN($TBilTot)))</Set>
      </Else>
      <!--<Set>$TBilTot=SUB($TBilTot,1)</Set>-->
      <Set>$TBilNum=ADD($TBilNum,1)</Set>
      <Exec func="PUB:ExecSql">   
        <Arg name="SqlCmd" value="UpdatePJInf"/>
      </Exec>			
      <If condition="~RetCod=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=更新票据状态失败</Set>
        <Return/>
      </If>	
      <Set>$TBilSts=2</Set>
      <Exec func="PUB:ExecSql">   
        <Arg name="SqlCmd" value="InsertPJInf"/>
      </Exec>   
      <If condition="~RetCod=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=票据记录失败</Set>
        <Return/>
      </If>  
   </If>                      
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>    
      <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
            <Arg name="RecKey" value="$RecKey"/>
      </Exec>                                 
    </FlowCtrl>
  </Transaction>

	<Transaction code="461517" desc="非税系统基础数据文件导入">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<Quote name="InitTran"/>
		<!--获取批次号-->
		  
			<Set>LclFil=STRCAT(JCSJ,$ActDat,.txt)</Set>  
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT001"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
			<Set>DatFil=STRCAT( $PntRcvDir,jcsj/,$FilNam )</Set>
			<Set>DatFil=dat/pnt/recv/jcsj/JCSJ20090324.txt</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="JCSJHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNms"/>
        </Exec>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="JCSJTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($NodeNum,3,$DtlNum)">
						<Break/>
					</If>						
					 <Switch expression="$NodeId"> 
					  <!--收费项目-->				
					  <Case value="SFXM">	
            <!--If condition="IS_EQUAL_STRING($NodeId,SFXM)"-->			
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="SFXMDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   
			            <Args>
				              <Arg name="tablename" value="PntSfxm"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_sfxm"/>
                 </Exec>
		           </If>
		           <Break/>
		        </Case>   
		        <!--/If-->
		        <!--单位信息-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,DWXX)"-->
					  <Case value="DWXX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="DWXXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="Pntdwxx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_dwxx"/>
                 </Exec>
		           </If>
		           <Break/>
		        </Case>   
		        <!--/If-->		  
		        <!--单位项目-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,DWXM)"-->
					  <Case value="DWXM">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="DWXMDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntDwxm"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,3)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Delete_dwxm"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>   
		        <!--/If-->		
		        <!--票据类型-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,PJLX)"-->
					  <Case value="PJLX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="PJLXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntPjlx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_pjlx"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>   
		        <!--/If-->		
		        <!--票据发放-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,PJFF)"-->
					  <Case value="PJFF">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="PJFFDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">		
					       <Set>TBilSts=1</Set>					     			
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntPjff"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,3)">	
		             <Set>TBilSts=3</Set>		           				
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_pjff"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>   
		        <!--/If-->
		        <!--项目票据-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,XMPJ)"-->
					  <Case value="XMPJ">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="XMPJDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntXmpj"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,3)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Delete_xmpj"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>
		        <!--/If-->	
		        <!--区域信息-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,QYXX)"-->
					  <Case value="QYXX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="QYXXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntQyxx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_qyxx"/>
                 </Exec>
		           </If>		            
		           <Break/>
		        </Case>             
		        <!--/If-->
		        <Default>
		          <Break/>
		        </Default>	
		       </Switch>
            <Set>DtlNum=ADD($DtlNum,1)</Set>
				</While>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>

	<Transaction code="461598" desc="测试主控">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461599" desc="自动抹帐">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
			<Set>TTxnCd=$TxnCod</Set>
			<Quote name="CanAccPro"/>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>
</Application>
