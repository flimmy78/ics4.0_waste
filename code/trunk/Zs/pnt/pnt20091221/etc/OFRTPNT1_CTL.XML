<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="PNT" code="215">
	<LibDeclare>
		<Library name="PFA" value="dll/pfa.so"/>
		<Library name="PNT" value="dll/pnt.so"/>
	</LibDeclare>

	<ConfigDeclare>
		<Config name="ParaFile"    value="etc/CFG_PNT_484999.XML"/>	
		<Config name="BatFormat"  value="etc/PNT_FMT.XML"/>
	</ConfigDeclare>
	
	<PackageDeclare>
		<Package name="PNT"      value="etc/PNT_PKG_484999.XML"/>
	</PackageDeclare>
	
	<TableDeclare>
		<Table name="PntTxnBok"    value="PntTxnBok"/>
		<Table name="PntTxnJnl"    value="PntTxnJnl"/>
		<Table name="PntSfxm"      value="PntSfxm"/>
		<Table name="Pntdwxx"      value="Pntdwxx"/>
		<Table name="PntDwxm"      value="PntDwxm"/>
		<Table name="PntPjlx"      value="PntPjlx"/>
		<Table name="PntPjff"      value="PntPjff"/>
		<Table name="PntXmpj"      value="PntXmpj"/>
		<Table name="PntQyxx"      value="PntQyxx"/>	
		<Table name="PntPrgx"      value="PntPrgx"/>
		<Table name="PntWtzw"      value="PntWtzw"/>
		<Table name="PntFccz"      value="PntFccz"/>
		<Table name="PntFcgk"      value="PntFcgk"/>		
		<Table name="pntfilctl"    value="pntfilctl"/>
		<Table name="pntbatrec"    value="pntbatrec"/>
		<Table name="pntextbat"    value="pntextbat"/>	
		<Table name="pntfilinf"    value="pntfilinf"/>	
		<Table name="PntHzfczh"     value="PntHzfczh"/>
	</TableDeclare>

	<GlobalFunction> 
		<Include file="etc/ActJudge_IIT.XML"/>  <!--区别对公对私帐号-->		
	</GlobalFunction>

	<BusDefDeclare>
		<Busdef name="RptDir" value="dat/term/send/"/>
		<Busdef name="PntSndDir" value="dat/pnt/send/"/>
		<Busdef name="PntRcvDir" value="dat/pnt/recv/"/>
	</BusDefDeclare>

	<Define>
		<Include file="etc/PNT_MCR.XML"/>
	</Define>
	

	<Transaction code="461501" desc="请求缴费">
		<FlowCtrl>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="TxnCod" value="311"/>
				<Arg name="ObjSvr" value="STHDPNT1"/>
			</Exec>
		</FlowCtrl>
	</Transaction>

	<Transaction code="461504" desc="不需要手工录入">
		<Quote name="PntSqlLst"/>		
		<FlowCtrl>		
      <Exec func="PUB:InitTransaction"/>
        <!--检查交易并发-->
        <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
      <Exec func="PUB:Lock">
          <Arg name="RecKey" value="$RecKey"/>
          <Arg name="TimOut" value="1000"/>
          <Arg name="AutoUnlock" value="yes"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="QryPJNum" />
        </Args>
      </Exec>  										
			<Exec func="PUB:ExecSql">    
          <Arg name="SqlCmd" value="UpdPJNum"/> 
      </Exec>        
      <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
        <Arg name="RecKey" value="$RecKey"/>
      </Exec>           
			<Set>BokFlg=1</Set>
			<Set>CmtCod=313</Set>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
			  <Arg name="TxnCod" value="$CmtCod"/>
			  <Arg name="ObjSvr" value="STHDPNT1"/>
		  </Exec>
		  <If condition="IS_EQUAL_STRING($Rtncod,100)">
		    <Set>BilSts=S</Set>
		    <Set>BilAmt=ADDCHAR(MUL($BilAmt,100),15,0,1)</Set>
		    <Set>PenAmt=ADDCHAR(MUL($PenAmt,100),15,0,1)</Set>
			  <Exec func="PUB:InsertRecord">   
			    <Args>
			      <Arg name="tablename" value="PntTxnBok"/>
			    </Args>
		    </Exec>	 
			</If>
			<Else>
          <Exec func="PUB:ExecSql">    
            <Arg name="SqlCmd" value="UpdPJNumRe"/> 
          </Exec>          
      </Else>
		</FlowCtrl>
	</Transaction>

	<Transaction code="461503" desc="确认缴费">
		<DynSentence name="UpdTxnBok"> 
			<Sentence>
         update pnttxnbok set BilSts='B',RActNo='%s',TckNo='%s',LogNo='%s',PayDat='%s' where BankCd='%s' and TVchId='%s' and TCrpCd='%s' and BilSts='S'
			</Sentence>
			<Fields>RActNo|TckNo|LogNo|PayDat|BankCd|TVchId|TCrpCd|</Fields>
		</DynSentence>	
		<FlowCtrl>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="TxnCod" value="319"/>
				<Arg name="ObjSvr" value="STHDPNT1"/>
			</Exec>
			<If condition="IS_EQUAL_STRING($Rtncod,100)">
			    <Exec func="PUB:ExecSql">
			    	<Arg name="SqlCmd" value="UpdTxnBok"/>
			    </Exec>
			</If>							
		</FlowCtrl>
	</Transaction>

	<Transaction code="461505" desc="冲正缴费">	  
		<DynSentence name="UpdTxnBokC"> 
			<Sentence>
         update pnttxnbok set BilSts='C' where BankCd='%s' and TVchId='%s' and TCrpCd='%s' and TBilTp='%s' and TBilNo='%s'
			</Sentence>
			<Fields>BankCd|TVchId|TCrpCd|TBilTp|TBilNo|</Fields>
		</DynSentence>			
		<FlowCtrl>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="TxnCod" value="314"/>
				<Arg name="ObjSvr" value="STHDPNT1"/>
			</Exec>
			<If condition="IS_EQUAL_STRING($Rtncod,100)">
			    <Exec func="PUB:ExecSql">
			    	<Arg name="SqlCmd" value="UpdTxnBokC"/>
			    </Exec>
			</If>	 
		</FlowCtrl>
	</Transaction>

	<Transaction code="461502" desc="冲正确认">
		<DynSentence name="UpdTxnBok"> 
			<Sentence>
         update pnttxnbok set BilSts='D' where BankCd='%s' and TVchId='%s' and TCrpCd='%s' and BilSts='C'
			</Sentence>
			<Fields>BankCd|TVchId|TCrpCd|</Fields>
		</DynSentence>	
		<FlowCtrl>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="TxnCod" value="320"/>
				<Arg name="ObjSvr" value="STHDPNT1"/>
			</Exec>
			<If condition="IS_EQUAL_STRING($Rtncod,100)">
			    <Exec func="PUB:ExecSql">
			    	<Arg name="SqlCmd" value="UpdTxnBok"/>
			    </Exec>
			</If>							
		</FlowCtrl>
	</Transaction>

	<Transaction code="461508" desc="银行系统产生的收款信息文件">
		<FlowCtrl>
      <Set>BrNo=484999</Set>
      <Set>BankCd=442000010</Set>	
      <Set>FilDat=SUB($ActDat,1)</Set>	
			<Set>FilNam=STRCAT(YHSK,$BankCd,$FilDat,01.txt)</Set> 
			<Set>ObjFil=$FilNam</Set>   
			<Set>LclFil=$FilNam</Set>   
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT007"/>
			</Exec>
		  <Exec func="PUB:FtpPut">
				<Arg name="FtpId" value="PNT003"/>
			</Exec>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461509" desc="非税系统产生的收款问题账务信息文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<Exec func="PUB:InitTransaction"/>
		<!--获取批次号-->
		<Set>Brno=484999</Set>
		<Set>FilDat=SUB($ActDat,1)</Set>
			<Exec func="PUB:nGetPubSeqNo">
				<Arg name="SeqNam" value="Pntwt:SelVal"/>
				<Arg name="SeqCnt" value="1"/>
				<Arg name="Len"    value="2"/>
				<Arg name="CycCnd" value="D"/>
			</Exec>
			<Set>LclFil=STRCAT(WTZW442000010,$FilDat,$SelVal,.txt)</Set>
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT002"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
	    <!--end-->
			<Set>DatFil=STRCAT( $PntRcvDir,wtzw/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="WTZWHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<Exec func="PUB:GetFileLine" error="IGNORE">
        <Arg name="FieldName" value="DatFNms"/>
      </Exec>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="WTZWTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($TitNum,3,$DtlNum)">
						<Break/>
					</If>
					<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
						<Arg name="ConfigName" value="BatFormat"/>
						<Arg name="RootName"   value="BATCH"/>
						<Arg name="NodeName"   value="Process"/>
						<Arg name="AttrName"   value="name"/>
						<Arg name="AttrValue"  value="WTZWDATA"/>
						<Arg name="MaxLen"     value="100000"/>
					</Exec>
				  <Exec func="PUB:InsertRecord">   
			     <Args>
				       <Arg name="tablename" value="PntWtzw"/>
			     </Args>
		      </Exec>
					<Set>DtlNum=ADD($DtlNum,1)</Set>
				</While>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461511" desc="非税系统产生的财政专户分成信息文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<Exec func="PUB:InitTransaction"/>
		  <Set>BrNo=484999</Set>
		  <Set>FilDat=SUB($ActDat,1)</Set>
			<Set>LclFil=STRCAT(FCCZ4420000101111,$FilDat,.txt)</Set>
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT004"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
			<Set>DatFil=STRCAT( $PntRcvDir,fcxx/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="FCCZHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<!--读空行-->
			<Exec func="PUB:GetFileLine" error="IGNORE">
        <Arg name="FieldName" value="DatFNms"/>
      </Exec>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="FCCZTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($TitNum,3,$DtlNum)">
						<Break/>
					</If>
					<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
						<Arg name="ConfigName" value="BatFormat"/>
						<Arg name="RootName"   value="BATCH"/>
						<Arg name="NodeName"   value="Process"/>
						<Arg name="AttrName"   value="name"/>
						<Arg name="AttrValue"  value="FCCZDATA"/>
						<Arg name="MaxLen"     value="100000"/>
					</Exec>
				  <Exec func="PUB:InsertRecord">   
			     <Args>
				       <Arg name="tablename" value="PntFccz"/>
			     </Args>
		      </Exec>
					<Set>DtlNum=ADD($DtlNum,1)</Set>					
				</While>
			  <!--读空行-->
			  <Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNms"/>
        </Exec>				
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="461512" desc="非税系统产生的国库分成信息文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<Exec func="PUB:InitTransaction"/>
		  <Set>BrNo=484999</Set>
		  <Set>FilDat=SUB($ActDat,1)</Set>
			<Set>LclFil=STRCAT(FCGK4420000101111,$FilDat,.txt)</Set>
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT004"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
			<Set>DatFil=STRCAT( $PntRcvDir,fcxx/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="FCGKHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Exec func="PUB:InsertRecord">   
			    <Args>
				    <Arg name="tablename" value="PntFcgk"/>
			    </Args>
		    </Exec>
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<!--读空行-->
			<Exec func="PUB:GetFileLine" error="IGNORE">
        <Arg name="FieldName" value="DatFNms"/>
      </Exec>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="FCGKTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($TitNum,3,$DtlNum)">
						<Break/>
					</If>
					<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
						<Arg name="ConfigName" value="BatFormat"/>
						<Arg name="RootName"   value="BATCH"/>
						<Arg name="NodeName"   value="Process"/>
						<Arg name="AttrName"   value="name"/>
						<Arg name="AttrValue"  value="FCGKDATA"/>
						<Arg name="MaxLen"     value="100000"/>
					</Exec>
				  <Exec func="PUB:InsertRecord">   <!--zhongshan add-->
			     <Args>
				       <Arg name="tablename" value="PntFcgk"/>
			     </Args>
		      </Exec>
					<Set>DtlNum=ADD($DtlNum,1)</Set>
				</While>
				<!--读空行-->
			  <Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNms"/>
        </Exec>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>	

	<Transaction code="461513" desc="银行系统产生的财政专户达账信息文件">
		<Quote name="PntSqlLst"/>
		<DynSentence name="GetTit">
			<Sentence>
				select CityCd,ActNo,ActNam,ActBnk,sum(cast(dtlamt as bigint)) as TitAmt,coalesce(COUNT(*),0) TitNum  from pntfccz where TxnDat='%s' and DtlSts='2' group by CityCd,ActNo,ActNam,ActBnk
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		<!--zhongshan add-->
		<DynSentence name="GetTot">
			<Sentence>
				select BankCd,RcvAct,sum(cast(dtlamt as bigint)) as TotAmt,coalesce(COUNT(*),0) TotNum from Pntfccz where TxnDat='%s' and DtlSts='2'  group by BankCd,RcvAct
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		
	  <DynSentence name="GetDat">
			<Sentence>
				select TCrpCd,TCrpNm,PrjCod,PrjNam,DtlAmt from pntfccz where actno='%s' and TxnDat='%s' and dtlsts='2'
			</Sentence>
			<Fields>ActNo|ActDat|</Fields>
		</DynSentence>
		
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>
		  <Set>BrNo=484999</Set>
		  <Set>RcvAct=484600600018170061476</Set>
		  <Set>FilDat=SUB($ActDat,1)</Set>
			<Set>FilNam=STRCAT(DZCZ442000010,$RcvAct,$FilDat,.txt)</Set> <!--zhongshan modify WordDt for ActDat-->
			<Set>DatFil=STRCAT($PntSndDir,yhsc/,$FilNam )</Set> 
<!--为避免同一分行并发-->
			<Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="sql" value="GetTot"/>
			</Exec>
<!--文件头-->
			<Exec func="PUB:WriteFile" error="IGNORE">
				<Arg name="FileName" value="$DatFil"/>
				<Arg name="OpenMode" value="w"/>				
				<Arg name="Data"	   value="$BankCd"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$RcvAct"/> 
				<Arg name="Data"	   value="|"/>				
				<Arg name="Data"	   value="$ActDat"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$TotNum"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="AMTSIMPLEFMT($TotAmt)"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="ESCFMT"   value="\\n"/>
				<Arg name="ESCFMT"   value="\\n"/> <!--zhongshan add-->
			</Exec>
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql" value="GetTit"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标【GetTit】出错</Set>
				<Return/>
			</If>
			<Set>Num=0</Set>
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/>
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<Exec func="PUB:WriteFile" error="IGNORE">
					<Arg name="FileName" value="$DatFil"/>
					<Arg name="OpenMode" value="a+"/>
				  <Arg name="Data"	   value="$CityCd"/> 
				  <Arg name="Data"	   value="|"/>
				  <Arg name="Data"	   value="$TitNum"/> 
				  <Arg name="Data"	   value="|"/>					
					<Arg name="Data"	   value="AMTSIMPLEFMT($TitAmt)"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$ActNam"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$ActBnk"/> 
					<Arg name="Data"	   value="|"/>	
					<Arg name="Data"	   value="$ActNo"/> 
					<Arg name="Data"	   value="|"/>									
					<Arg name="ESCFMT"   value="\\n"/>
				</Exec>
			  <Exec func="PUB:OpenCursor" error="IGNORE">
			  	<Arg name="sql" value="GetDat"/>
			  	<Arg name="CursorName" value="CURSOR_2"/>
			  </Exec>
			  <If condition="~RetCod!=0">
			  	<Set>MsgTyp=E</Set>
			  	<Set>RspCod=PFA999</Set>
			  	<Set>RspMsg=打开游标【GetDat】出错</Set>
			  	<Return/>
			  </If>
			  <Set>Num=0</Set>
			  <While>
			  	<Exec func="PUB:FetchCursor" error="IGNORE">
			  	  <Arg name="CursorName" value="CURSOR_2"/>
			  	</Exec>
			  	<If condition="~RetCod=100">
			  		<Break/>
			  	</If>
			  	<Exec func="PUB:WriteFile" error="IGNORE">
			  		<Arg name="FileName" value="$DatFil"/>
			  		<Arg name="OpenMode" value="a+"/>
			  	  <Arg name="Data"	   value="$TCrpCd"/> 
			  	  <Arg name="Data"	   value="|"/>
			  	  <Arg name="Data"	   value="$TCrpNm"/> 
			  	  <Arg name="Data"	   value="|"/>					
			  		<Arg name="Data"	   value="$PrjCod"/> 
			  		<Arg name="Data"	   value="|"/>
			  		<Arg name="Data"	   value="$PrjNam"/> 
			  		<Arg name="Data"	   value="|"/>
			  		<Arg name="Data"	   value="AMTSIMPLEFMT($DtlAmt)"/> 
			  		<Arg name="Data"	   value="|"/>									
			  		<Arg name="ESCFMT"   value="\\n"/>
			  	</Exec>
			  </While>
			  <Exec func="PUB:WriteFile" error="IGNORE">
			  	  <Arg name="FileName" value="$DatFil"/>
			  	  <Arg name="OpenMode" value="a+"/>
			  	  <Arg name="ESCFMT"   value="\\n"/>
			  </Exec>
			  <Exec func="PUB:CloseCursor" error="IGNORE">
			      <Arg name="CursorName" value="CURSOR_2"/>
			  </Exec>
			</While>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Set>ObjFil=$FilNam</Set>   <!--zhongshan add-->
			<Set>LclFil=$FilNam</Set>   <!--zhongshan add-->
			<Exec func="PUB:FtpPut">
				<Arg name="FtpId" value="PNT003"/>
			</Exec>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="461514" desc="银行系统产生的国库专户达账信息文件">
		<Quote name="PntSqlLst"/>
		<DynSentence name="GetTit">
			<Sentence>
				select CityCd,ActNo,ActNam,ActBnk,sum(cast(dtlamt as bigint)) as TitAmt,coalesce(COUNT(*),0) TitNum  from pntfcgk where TxnDat='%s' and DtlSts='2' group by CityCd,ActNo,ActNam,ActBnk
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		<!--zhongshan add-->
		<DynSentence name="GetTot">
			<Sentence>
				select BankCd,RcvAct,sum(cast(dtlamt as bigint)) as TotAmt,coalesce(COUNT(*),0) TotNum from Pntfcgk where TxnDat='%s' and DtlSts='2'  group by BankCd,RcvAct
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		
	  <DynSentence name="GetDat">
			<Sentence>
				select SubCod,SubNam,PrjCod,PrjNam,DtlAmt from pntfcgk where actno='%s' and TxnDat='%s' and dtlsts='2'
			</Sentence>
			<Fields>ActNo|ActDat|</Fields>
		</DynSentence>
		
		<FlowCtrl>
		<Exec func="PUB:InitTransaction"/>
		  <Set>BrNo=484999</Set>
      <Set>BankCd=442000010</Set>	
      <Set>RcvAct=484600600018170061476</Set> 		
      <Set>FilDat=SUB($ActDat,1)</Set>  
			<Set>FilNam=STRCAT(DZGK,$BankCd,$RcvAct,$FilDat,.txt)</Set> 
			<Set>DatFil=STRCAT($PntSndDir,yhsc/,$FilNam )</Set> 
<!--为避免同一分行并发-->
			<Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="sql" value="GetTot"/>
			</Exec>
<!--文件头-->
			<Exec func="PUB:WriteFile" error="IGNORE">
				<Arg name="FileName" value="$DatFil"/>
				<Arg name="OpenMode" value="w"/>				
				<Arg name="Data"	   value="$BankCd"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$RcvAct"/> 
				<Arg name="Data"	   value="|"/>				
				<Arg name="Data"	   value="$ActDat"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$TotNum"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="AMTSIMPLEFMT($TotAmt)"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="ESCFMT"   value="\\n"/>
				<Arg name="ESCFMT"   value="\\n"/> <!--zhongshan add-->
			</Exec>
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql" value="GetTit"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标【GetTit】出错</Set>
				<Return/>
			</If>
			<Set>Num=0</Set>
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/>
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<Exec func="PUB:WriteFile" error="IGNORE">
					<Arg name="FileName" value="$DatFil"/>
					<Arg name="OpenMode" value="a+"/>
				  <Arg name="Data"	   value="$CityCd"/> 
				  <Arg name="Data"	   value="|"/>
				  <Arg name="Data"	   value="$TitNum"/> 
				  <Arg name="Data"	   value="|"/>					
					<Arg name="Data"	   value="AMTSIMPLEFMT($TitAmt)"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$ActNam"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$ActBnk"/> 
					<Arg name="Data"	   value="|"/>	
					<Arg name="Data"	   value="$ActNo"/> 
					<Arg name="Data"	   value="|"/>									
					<Arg name="ESCFMT"   value="\\n"/>
				</Exec>
			  <Exec func="PUB:OpenCursor" error="IGNORE">
			  	<Arg name="sql" value="GetDat"/>
			  	<Arg name="CursorName" value="CURSOR_2"/>
			  </Exec>
			  <If condition="~RetCod!=0">
			  	<Set>MsgTyp=E</Set>
			  	<Set>RspCod=PFA999</Set>
			  	<Set>RspMsg=打开游标【GetDat】出错</Set>
			  	<Return/>
			  </If>
			  <Set>Num=0</Set>
			  <While>
			  	<Exec func="PUB:FetchCursor" error="IGNORE">
			  	  <Arg name="CursorName" value="CURSOR_2"/>
			  	</Exec>
			  	<If condition="~RetCod=100">
			  		<Break/>
			  	</If>
			  	<Exec func="PUB:WriteFile" error="IGNORE">
			  		<Arg name="FileName" value="$DatFil"/>
			  		<Arg name="OpenMode" value="a+"/>
			  	  <Arg name="Data"	   value="$SubCod"/> 
			  	  <Arg name="Data"	   value="|"/>
			  	  <Arg name="Data"	   value="$subNam"/> 
			  	  <Arg name="Data"	   value="|"/>					
			  		<Arg name="Data"	   value="$PrjCod"/> 
			  		<Arg name="Data"	   value="|"/>
			  		<Arg name="Data"	   value="$PrjNam"/> 
			  		<Arg name="Data"	   value="|"/>
			  		<Arg name="Data"	   value="AMTSIMPLEFMT($DtlAmt)"/> 
			  		<Arg name="Data"	   value="|"/>									
			  		<Arg name="ESCFMT"   value="\\n"/>
			  	</Exec>
			  </While>
			  <Exec func="PUB:WriteFile" error="IGNORE">
			  	  <Arg name="FileName" value="$DatFil"/>
			  	  <Arg name="OpenMode" value="a+"/>
			  	  <Arg name="ESCFMT"   value="\\n"/>
			  </Exec>
			  <Exec func="PUB:CloseCursor" error="IGNORE">
			      <Arg name="CursorName" value="CURSOR_2"/>
			  </Exec>
			</While>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Set>ObjFil=$FilNam</Set>   <!--zhongshan add-->
			<Set>LclFil=$FilNam</Set>   <!--zhongshan add-->
			<Exec func="PUB:FtpPut">
				<Arg name="FtpId" value="PNT003"/>
			</Exec>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>	

	<Transaction code="461517" desc="非税系统基础数据文件导入">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<!--Quote name="InitTran"/-->
		<Exec func="PUB:InitTransaction"/>
		<!--获取批次号-->	  
		  <Set>BrNo=484999</Set>
			<Set>LclFil=STRCAT(JCSJ,$ActDat,.txt)</Set>  
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT001"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
			<Set>DatFil=STRCAT( $PntRcvDir,jcsj/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="JCSJHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNms"/>
        </Exec>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="JCSJTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($NodeNum,3,$DtlNum)">
						<Break/>
					</If>						
					 <Switch expression="$NodeId"> 
					  <!--收费项目-->				
					  <Case value="SFXM">	
            <!--If condition="IS_EQUAL_STRING($NodeId,SFXM)"-->			
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="SFXMDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   
			            <Args>
				              <Arg name="tablename" value="PntSfxm"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_sfxm"/>
                 </Exec>
		           </If>
		           <Break/>
		        </Case>   
		        <!--/If-->
		        <!--单位信息-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,DWXX)"-->
					  <Case value="DWXX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="DWXXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="Pntdwxx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_dwxx"/>
                 </Exec>
		           </If>
		           <Break/>
		        </Case>   
		        <!--/If-->		  
		        <!--单位项目-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,DWXM)"-->
					  <Case value="DWXM">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="DWXMDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntDwxm"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,3)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Delete_dwxm"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>   
		        <!--/If-->		
		        <!--票据类型-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,PJLX)"-->
					  <Case value="PJLX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="PJLXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntPjlx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_pjlx"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>   
		        <!--/If-->		
		        <!--票据发放-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,PJFF)"-->
					  <Case value="PJFF">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="PJFFDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">		
					       <Set>TBilSts=1</Set>	
					       <Set>TBilReSts=1</Set>				     			
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntPjff"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,3)">	
		             <Set>TBilSts=3</Set>		           				
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_pjff"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>   
		        <!--/If-->
		        <!--项目票据-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,XMPJ)"-->
					  <Case value="XMPJ">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="XMPJDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntXmpj"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,3)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Delete_xmpj"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>
		        <!--/If-->	
		        <!--区域信息-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,QYXX)"-->
					  <Case value="QYXX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="QYXXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntQyxx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_qyxx"/>
                 </Exec>
		           </If>		            
		           <Break/>
		        </Case>        
					  <Case value="PRGX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="PRGXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntPrgx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_prgx"/>
                 </Exec>
		           </If>		            
		           <Break/>
		        </Case>             		             
		        <!--/If-->
		        <Default>
		          <Break/>
		        </Default>	
		       </Switch>
            <Set>DtlNum=ADD($DtlNum,1)</Set>
				</While>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>
	
  <Transaction code="461518" desc="非税系统信息打印">
    <DynSentence name="QryCnt">
      <Sentence>
         select totnum from pntfcgk where dtlsts='2' 
      </Sentence>
    </DynSentence> 
    <FlowCtrl>
      <Exec func="PUB:GetBranchNoByNodeNo"/>
      <Exec func="PUB:InitTransaction"/>      
      <Switch expression="$RptTyp">
        <Case value="1">
          <Set>FilNam=STRCAT(PNT001,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT001_RPT.XML)</Set>
          <Set>RptHead=非税业务问题账务</Set>
          <Set>Summary=打印非税业务问题账务</Set>
          <Break/>
        </Case>
        <Case value="2">
          <Set>FilNam=STRCAT(PNT002,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT002_RPT.XML)</Set>
          <Set>RptHead=非税业务财政专户分成信息文件</Set>
          <Set>Summary=打印非税业务财政专户分成信息</Set>
          <Break/>
        </Case>
        <Case value="3">
          <Set>FilNam=STRCAT(PNT003,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT003_RPT.XML)</Set>
          <Set>RptHead=非税业务国库分成信息文件</Set>
          <Set>Summary=打印非税业务国库分成信息</Set>
          <Break/>
        </Case>     
        <Case value="4">
          <Set>FilNam=STRCAT(PNT004,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT004_RPT.XML)</Set>
          <Set>RptHead=非税业务财政专户达账信息文件</Set>
          <Set>Summary=打印非税业务财政专户达账信息</Set>
          <Break/>
        </Case>
        <Case value="5">
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="QryCnt" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
          <If condition="$totnum=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNTNUM</Set>
            <Set>RspMsg=笔数为零</Set>
            <Return/>
          </If>       	
          <Set>FilNam=STRCAT(PNT005,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT005_RPT.XML)</Set>
          <Set>RptHead=非税业务国库达账信息文件</Set>
          <Set>Summary=打印非税业务国库达账信息</Set>
          <Break/>
        </Case>  
        <Case value="6">
          <Set>BankCd=442000010</Set>	
			    <Set>FilNam=STRCAT(YHSK,$BankCd,$TxnDat,01.txt)</Set> 
			    <Set>ObjFil=$FilNam</Set>   
			    <Set>LclFil=$FilNam</Set>   
			    <Exec func="PUB:FtpGet">
			    	<Arg name="FtpId" value="PNT007"/>
			    </Exec>
			    <If condition="~RetCod!=0">
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=没有满足条件记录,取文件错误</Set>
            <Return/>
          </If>
          <Break/>
        </Case>  
        <Case value="7">
          <Set>FilNam=STRCAT(PNT007,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT007_RPT.XML)</Set>
          <Set>RptHead=非税系统产生的汇总分成专户文件</Set>
          <Set>Summary=打印非税系统产生的汇总分成信息</Set>
          <Break/>
        </Case>
        <Case value="8">
          <Set>FilNam=STRCAT(PNT008,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT008_RPT.XML)</Set>
          <Set>RptHead=银行系统产生专户汇总达账文件</Set>
          <Set>Summary=打印非税业务专户汇总达账信息</Set>
          <Break/>
        </Case>                         
		    <Default>
		      <Break/>
		    </Default>        
      </Switch>    
      <If condition="IS_EQUAL_STRING($RptTyp,6)">
        <Exec func="PUB:SendFileMessage">
            <Arg name="MsgTyp" value="4"/>
            <Arg name="ObjNod" value="$NodNo"/>
            <Arg name="BusTyp" value="SUBSTR($TxnCod,1,2)"/>
            <Arg name="AplCod" value="SUBSTR($TxnCod,3,4)"/>
            <Arg name="FilNam" value="$FilNam"/>
            <Arg name="Summary" value="中山非税系统收款文件已发出"/>
            <Arg name="ObjTlr" value="$TlrId"/>
            <Arg name="SrcNod" value="$NodNo"/>
            <Arg name="SrcTlr" value="$TlrId"/>
        </Exec>
        <Set>RspCod=000000</Set>
        <Set>RspMsg=报表已经生成发送到系统打印机上</Set>
      </If>
      <Else>
         <Exec func="EXT:GenerateReport">
           <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
           <Arg name="RptFile" value="$FmtFil" />
           <Arg name="RptHead" value="$RptHead"/>
           <Arg name="TxnDat"  value="$TxnDat"/>
         </Exec>         
         <Exec func="PUB:SendFileMessage2">
           <Arg name="MsgTyp"  value="4"/>
           <Arg name="ObjNod"  value="$NodNo"/>
           <Arg name="BusTyp"  value="46"/>
           <Arg name="AplCod"  value="$TxnCod"/>
           <Arg name="FilNam"  value="$FilNam"/>
           <Arg name="Summary" value="$Summary"/>
           <Arg name="ObjTlr"  value="$TlrId"/>
         </Exec>
      </Else>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>	
	
  
	<Transaction code="461520" desc="分解票据">
	  <Quote name="PntSqlLst"/>
    <DynSentence name="QryPJCnt">
      <Sentence>
         select count(*) as TBilCnt from pntpjff where TBilReSts='1' 
      </Sentence>
    </DynSentence>  
    <DynSentence name="QryPJTB">
      <Sentence>
         select TBilTp,TBilStar,TBilEnd,TBilTot,TBilSts from pntpjff where TBilReSts='1' 
      </Sentence>
    </DynSentence>    		 
    <DynSentence name="InsertPJInf">
      <Sentence>
        insert into PntPjNum (TBilTp,TBilNo,TBilSts,TBilFFSts,TBilNod) values ('%s','%s','1','1','POS')
      </Sentence>
      <Fields>TBilTp|TBilNo|</Fields>
    </DynSentence>     
    <DynSentence name="UpdPJSts">
      <Sentence>
        update PntPjff set TBilReSts='2' where TBilTp='%s' and TBilStar='%s' and TBilEnd='%s' and TBilTot='%s' and TBilSts='%s'
      </Sentence>
      <Fields>TBilTp|TBilStar|TBilEnd|TBilTot|TBilSts|</Fields>
    </DynSentence>     		
		<FlowCtrl>
		<!--Quote name="InitTran"/-->
		<Exec func="PUB:InitTransaction"/>
    <Exec func="PUB:ReadRecord" error="IGNORE">
      <Args>
        <Arg name="SqlCmd" value="QryPJCnt" />
      </Args>
    </Exec>
    <If condition="~RetCod=-1">
      <Exec func="PUB:RollbackWork" error="IGNORE" />
      <Set>MsgTyp=E</Set>
      <Set>RspCod=PNT999</Set>
      <Set>RspMsg=数据库查询失败</Set>
      <Return/>
    </If>
    <If condition="~RetCod=-2">
      <Set>MsgTyp=E</Set>
      <Set>RspCod=PNT999</Set>
      <Set>RspMsg=票据类型不存在</Set>
      <Return/>
    </If>       	
		<If condition="INTCMP($TBilCnt,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
		</If>
    <Exec func="PUB:OpenCursor" error="IGNORE">
      <Arg name="sql" value="QryPJTB"/>
    </Exec>
    <If condition="~RetCod!=0">
      <Set>MsgTyp=E</Set>
      <Set>RspCod=PFA999</Set>
      <Set>RspMsg=打开游标【QryPJTB】出错</Set>
      <Return/>
    </If>		
		<!--Set>TBNum=0</Set-->
		<While>
		  <!--If condition="INTCMP($TBilCnt,3,$TBNum)">
				<Break/>
		  </If-->
			<Exec func="PUB:FetchCursor" error="IGNORE"/>
			<If condition="~RetCod=100">
				<Break/>
			</If>		  
      <Set>TBSNum=0</Set>
      <Set>TBilNo=$TBilStar</Set>
      <While>
		     <If condition="INTCMP($TBilTot,3,$TBSNum)">
				   <Break/>
		     </If>         
         <Exec func="PUB:ExecSql">   
           <Arg name="SqlCmd" value="InsertPJInf"/>
         </Exec>   
         <If condition="~RetCod=-2">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=PNT999</Set>
           <Set>RspMsg=插入票据失败</Set>
           <Return/>
         </If>  
         <Set>$TBilNo=STRCAT(SUBSTR($TBilNo,1,SUB(STRLEN($TBilNo),STRLEN($TBilTot))),INTTOSTR(ADD(SUBSTR($TBilNo,ADD(SUB(STRLEN($TBilNo),STRLEN($TBilTot)),1),STRLEN($TBilTot)),1),STRLEN($TBilTot)))</Set>                
         <Set>$TBSNum=ADD($TBSNum,1)</Set>  
      </While>
      <Exec func="PUB:ExecSql">   
        <Arg name="SqlCmd" value="UpdPJSts"/>
      </Exec>   
      <If condition="~RetCod=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=更新票据状态失败</Set>
        <Return/>
      </If>          	  
		</While>
		<Exec func="PUB:CloseCursor"/>				   
		</FlowCtrl>
	</Transaction>  

	
	<Transaction code="461534" desc="非税系统产生的汇总分成专户文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<Exec func="PUB:InitTransaction"/>
		  <Set>BrNo=484999</Set>
		  <Set>BankCd=442000010</Set>
		  <Set>FilDat=SUB($ActDat,1)</Set>
			<Set>LclFil=STRCAT(HZFCZH484600600018170061476,$BankCd,$FilDat,.txt)</Set>
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT008"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
			<Set>DatFil=STRCAT( $PntRcvDir,hzdz/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="HZFCZHHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Exec func="PUB:InsertRecord">   
			    <Args>
				    <Arg name="tablename" value="PntHzfczh"/>
			    </Args>
		    </Exec>
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<!--读空行-->
			<Exec func="PUB:GetFileLine" error="IGNORE">
        <Arg name="FieldName" value="DatFNms"/>
      </Exec>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="HZFCZHTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($TitNum,3,$DtlNum)">
						<Break/>
					</If>
					<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
						<Arg name="ConfigName" value="BatFormat"/>
						<Arg name="RootName"   value="BATCH"/>
						<Arg name="NodeName"   value="Process"/>
						<Arg name="AttrName"   value="name"/>
						<Arg name="AttrValue"  value="HZFCZHDATA"/>
						<Arg name="MaxLen"     value="100000"/>
					</Exec>
				  <Exec func="PUB:InsertRecord">
			     <Args>
				       <Arg name="tablename" value="PntHzfczh"/>
			     </Args>
		      </Exec>
					<Set>DtlNum=ADD($DtlNum,1)</Set>
				</While>
				<!--读空行-->
			  <Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNms"/>
        </Exec>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>	
	</Transaction>	
	
	<Transaction code="461536" desc="银行系统产生专户汇总达账文件">
		<Quote name="PntSqlLst"/>		
	  <DynSentence name="GetDat">
			<Sentence>
				select TCrpCd,RevDat,PrjCod,TotAmt,ZHBankCd,TxnDat,ZHActNo,TCrpCd,PrjCod,ZCKM,JJCK from PntHzfczh where  TxnDat='%s' and dtlsts='2'
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>
		  <Set>BrNo=484999</Set>
      <Set>BankCd=442000010</Set>	  
      <Set>FilDat=SUB($ActDat,1)</Set>
      <Set>TxnDat=$FilDat</Set>
			<Set>FilNam=STRCAT(HZDZ,$BankCd,$RcvAct,$FilDat,.txt)</Set> 
			<Set>DatFil=STRCAT($PntSndDir,hzdz/,$FilNam )</Set> 
      <Exec func="PUB:ExportFromDB">   
        <Arg name="SqlName" value="GetDat"/>
        <Arg name="FormatName" value="HZDZ"/>
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="TableName" value="PntHzfczh"/>
      </Exec>
			<Set>ObjFil=$FilNam</Set>   
			<Set>LclFil=$FilNam</Set>   
			<Exec func="PUB:FtpPut">
				<Arg name="FtpId" value="PNT009"/>
			</Exec>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>		
	
	<Transaction code="461535" desc="对账文件状态维护">
	  <DynSentence name="GetFcczDts">
			<Sentence>
				select DtlSts from PntFccz where TxnDat = '%s' 
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		<DynSentence name="UpdFcczDts">
			<Sentence>
				update PntFccz set DtlSts = '2' where TxnDat = '%s' 
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
	  
	  <DynSentence name="GetFcgkDts">
			<Sentence>
				select DtlSts from PntFcgk where TxnDat = '%s' 
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		<DynSentence name="UpdFcgkDts">
			<Sentence>
				update PntFcgk set DtlSts = '2' where TxnDat = '%s' 
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		
	  <DynSentence name="GetHzfczhDts">
			<Sentence>
				select DtlSts from PntHzfczh where TxnDat = '%s' 
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		<DynSentence name="UpdHzfczhDts">
			<Sentence>
				update PntHzfczh set DtlSts = '2',RevDat='%s' where TxnDat = '%s' 
			</Sentence>
			<Fields>RevDat|TxnDat|</Fields>
		</DynSentence>		
	  <FlowCtrl>
	  <Exec func="PUB:InitTransaction"/>
	  <Switch expression="$RptTyp">
        <Case value="1">
	        <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetFcczDts" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=记录不存在</Set>
            <Return/>
          </If> 
          <If condition="DtlSts=2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=状态已经是返盘状态</Set>
            <Return/>          
          </If> 
          <Exec func="PUB:ExecSql">   
            <Arg name="SqlCmd" value="UpdFcczDts"/>
          </Exec>
          <Set>MsgTyp=N</Set>
			    <Set>RspCod=000000</Set>
          <Break/>
        </Case>
        <Case value="2">
	        <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetFcgkDts" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=记录不存在</Set>
            <Return/>
          </If> 
          <If condition="DtlSts=2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=状态已经是返盘状态</Set>
            <Return/>          
          </If> 
          <Exec func="PUB:ExecSql">   
            <Arg name="SqlCmd" value="UpdFcgkDts"/>
          </Exec>
          <Set>MsgTyp=N</Set>
			    <Set>RspCod=000000</Set>
          <Break/>
        </Case>
        <Case value="3">
	        <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetHzfczhDts" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=数据库查询失败</Set>
            <Return/>
          </If>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=记录不存在</Set>
            <Return/>
          </If> 
          <If condition="DtlSts=2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PNT999</Set>
            <Set>RspMsg=状态已经是返盘状态</Set>
            <Return/>          
          </If> 
          <Exec func="PUB:ExecSql">   
            <Arg name="SqlCmd" value="UpdHzfczhDts"/>
          </Exec>
          <Set>MsgTyp=N</Set>
			    <Set>RspCod=000000</Set>
          <Break/>
        </Case>                               
		    <Default>
		      <Break/>
		    </Default>        
      </Switch>    

		</FlowCtrl>
	</Transaction>

</Application>
