<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="EFEA" code="202">
  <!--电力电费业务本地主控-->
  <ConfigDeclare>
    <Config name="BatFormat"   value="etc/EFEA_FMT_441999.XML"/>
    <Config name="ParaFile"    value="etc/CFG_EFEA_441999.XML"/>
    <Config name="OPFCSW"      value="etc/EFEA_CSW2.XML"/>
  </ConfigDeclare>
  <BusDefDeclare>
  	<Busdef name="BrNo"      value="441999"/>
    <Busdef name="AplCls"    value="202"/> <!--add by xuan_20101108-->
  </BusDefDeclare>
  <PackageDeclare>
    <Package name="AFE"        value="etc/DAFE_PKG.XML"/>
  </PackageDeclare>
  <TableDeclare>
    <Table name="afetxnjnl"    value="afetxnjnl"/>  <!--业务流水表-->
    <Table name="afebatrec"    value="afebatrec"/>  <!--批量扩展表-->
    <Table name="efeaclrtbl"   value="efeaclrtbl"/>  <!--广州电力清算日期表-->
    <Table name="efeaclrlog"   value="efeaclrlog"/>  <!--广州电力清算参数修改记录表-->
    <Table name="efeaclrdtl"   value="efeaclrdtl"/>  <!--广州电力清算明细表表-->
  </TableDeclare>
  <GlobalFunction>
    <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
    <!--add by xuan_20101108-->
    <Function name="_after">
        <Process>
           <If condition="ISNULL($MsgTyp)">
              <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                 <Set>MsgTyp=N</Set>
                 <Set>RspCod=000000</Set>
              </If>
              <Else>
                 <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                    <Set>MsgTyp=E</Set>
                 </If>
                 <Else>
                    <Set>MsgTyp=N</Set>
                 </Else>
              </Else>
           </If>
        </Process>
    </Function>
    <!--end by xuan_20101108-->
  </GlobalFunction>
  <Define>
    <Macro name="Chk_TxnSrc">  <!--检查交易来源-->
      <If condition="INTCMP(STRLEN(DELBOTHSPACE($TxnSrc)),3,0)">
        <Set>TxnCnl=TRM</Set>
        <Set>CnlTyp=0</Set>
      </If>
      <Else>
        <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TxnSrc"/>
          <Arg name="DestNam" value="CnlTyp"/>
          <Arg name="TblNam"  value="TxnSrc2CnlTyp"/>
        </Exec>
      </Else>
    </Macro>

    <Macro name="TxnSrc_TxnCnl">
      <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="TxnSrc"/>
        <Arg name="DestNam" value="TxnCnl"/>
        <Arg name="TblNam"  value="TxnSrc2TxnCnl"/>
      </Exec>
    </Macro>

    <Macro name="MakeMac"> <!--MAC产生-->
    <Set>Key=1111222233334444</Set>
    
    <!--MAC生成-->
      <If condition="IS_EQUAL_STRING($TraTyp,HZ)">
        <If condition="INTCMP($MacFlg,3,0)">
          <!--校验MAC的生成-->
    	    <Set>OldDat=STRCAT($ActNo,$TxnAmt,$RcsNo,$TLogNo,$TTrmId,$RcvOrg)</Set>
    	  </If>
    	  <Else>
    	  	<!--返回MAC的生成-->
    	  	<Set>OldDat=STRCAT($ActNo,$TxnAmt,$RcsNo,$TLogNo,$TRtnCd,$TTrmId,$RcvOrg)</Set>
    	  </Else>
    	</If>
    	<ElseIf condition="IS_EQUAL_STRING($TraTyp,JF)">
         <If condition="INTCMP($MacFlg,3,0)">
          <!--发送MAC的生成-->
    	    <Set>OldDat=STRCAT($ActNo,$TxnAmt,$RcsNo,$TTrmId,$RcvOrg)</Set>
    	    <Set>OldDat=REPCHAR($OldDat, ,1)</Set>
    	  </If>
    	  <Else>
    	  	<!--校验MAC的生成-->
    	  	<Set>OldDat=STRCAT($ActNo,$TxnAmt,$RcsNo,$TLogNo,$TRtnCd,$TTrmId,$RcvOrg)</Set>
    	  </Else>
    	</ElseIf>
    	<Else>
    		 <Return/>
    	</Else>
    	<!--test
    	<Set>OldDat=6543219876A432B654321987654321</Set>
    	-->
    	<Set>NewDat= </Set>
    	<Set>NewDat=DELSPACE($NewDat,all)</Set>
    	<Set>DatPos=1</Set>
    	<If condition="INTCMP(ISNUMBER($OldDat),4,0)">
    	  <While condition="INTCMP($DatPos,2,STRLEN($OldDat))">
    	  	<Set>tmpWord=SUBSTR($OldDat,$DatPos,1)</Set>
    	  	<If condition="INTCMP(ISNUMBER($tmpWord),3,0)">
    	  		<Set>NewDat=STRCAT($NewDat,$tmpWord)</Set>
    	  	</If>
    	  	<Else>
    	  		<Set>NewDat=STRCAT($NewDat,1)</Set>
    	  	</Else>
    	  	<Set>DatPos=ADD($DatPos,1)</Set>
    	  </While>
    	</If>
    	<Else>
    		<Set>NewDat=$OldDat</Set>
    	</Else>
    	<!--8的倍数，不够补零-->
    	<Set>tmpLen=SUB(8,MOD(STRLEN($NewDat),8))</Set>
    	<Set>DatPos=1</Set>
    	<While condition="INTCMP($DatPos,2,$tmpLen)">
    		<Set>NewDat=STRCAT($NewDat,0)</Set>
    		<Set>DatPos=ADD($DatPos,1)</Set>
    	</While>
    	
    	<Set>Num1=DIV(STRLEN($NewDat),8)</Set>
    	<Set>Num2=DIV(STRLEN($Key),8)</Set>
    	<Set>Mov1=1</Set>
    	<Set>Mov2=1</Set>
    	<Set>Stp1=1</Set>
    	<Set>Stp2=1</Set>
    	<Set>T1=0</Set>
    	<Set>T2=0</Set>
    	<Set>T3=0</Set>
    	<Set>T4=0</Set>
    	<Set>T5=0</Set>
    	<Set>T6=0</Set>
    	<Set>T7=0</Set>
    	<Set>T8=0</Set>
    	<While condition="INTCMP($Stp1,2,$Num1)">
        <Set>D1=SUBSTR($NewDat,ADD($Mov1,0),1)</Set>
        <Set>D2=SUBSTR($NewDat,ADD($Mov1,1),1)</Set>
        <Set>D3=SUBSTR($NewDat,ADD($Mov1,2),1)</Set>
        <Set>D4=SUBSTR($NewDat,ADD($Mov1,3),1)</Set>
        <Set>D5=SUBSTR($NewDat,ADD($Mov1,4),1)</Set>
        <Set>D6=SUBSTR($NewDat,ADD($Mov1,5),1)</Set>
        <Set>D7=SUBSTR($NewDat,ADD($Mov1,6),1)</Set>
        <Set>D8=SUBSTR($NewDat,ADD($Mov1,7),1)</Set>
        <Set>K1=SUBSTR($Key,ADD($Mov2,0),1)</Set>
        <Set>K2=SUBSTR($Key,ADD($Mov2,1),1)</Set>
        <Set>K3=SUBSTR($Key,ADD($Mov2,2),1)</Set>
        <Set>K4=SUBSTR($Key,ADD($Mov2,3),1)</Set>
        <Set>K5=SUBSTR($Key,ADD($Mov2,4),1)</Set>
        <Set>K6=SUBSTR($Key,ADD($Mov2,5),1)</Set>
        <Set>K7=SUBSTR($Key,ADD($Mov2,6),1)</Set>
        <Set>K8=SUBSTR($Key,ADD($Mov2,7),1)</Set>
        <Set>T1=ADD($T1,MUL($D1,$K1))</Set>
        <Set>T2=ADD($T2,MUL($D2,$K2))</Set>
        <Set>T3=ADD($T3,MUL($D3,$K3))</Set>
        <Set>T4=ADD($T4,MUL($D4,$K4))</Set>
        <Set>T5=ADD($T5,MUL($D5,$K5))</Set>
        <Set>T6=ADD($T6,MUL($D6,$K6))</Set>
        <Set>T7=ADD($T7,MUL($D7,$K7))</Set>
        <Set>T8=ADD($T8,MUL($D8,$K8))</Set>
        <Set>Mov1=ADD($Mov1,8)</Set>
        <Set>Mov2=ADD($Mov2,8)</Set>
        <Set>Stp1=ADD($Stp1,1)</Set>
        <Set>Stp2=ADD($Stp2,1)</Set>
        <If condition="INTCMP($Stp2,6,$Num2)">
          <Set>Mov2=1</Set>
          <Set>Stp2=1</Set>
        </If>
    	</While>
    	<Set>MAC=SUBSTR($T1,STRLEN($T1),1)</Set>
    	<Set>MAC=STRCAT($MAC,SUBSTR($T2,STRLEN($T2),1))</Set>
    	<Set>MAC=STRCAT($MAC,SUBSTR($T3,STRLEN($T3),1))</Set>
    	<Set>MAC=STRCAT($MAC,SUBSTR($T4,STRLEN($T4),1))</Set>
    	<Set>MAC=STRCAT($MAC,SUBSTR($T5,STRLEN($T5),1))</Set>
    	<Set>MAC=STRCAT($MAC,SUBSTR($T6,STRLEN($T6),1))</Set>
    	<Set>MAC=STRCAT($MAC,SUBSTR($T7,STRLEN($T7),1))</Set>
    	<Set>MAC=STRCAT($MAC,SUBSTR($T8,STRLEN($T8),1))</Set>
      <!--MAC结束-->

    </Macro>
  </Define> 

  <Transaction code="460230" desc="电力实时划帐">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>

    <DynSentence name="QryCrpAgr">    <!--检查单位协议 -->
      <Sentence>
         select BBusTyp,TActNo, CrpCod from savcrpagr where BrNo='%s' and CAgtNo='%s' and SvrSts='1'
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>

    <DynSentence name="QryClrSts">    <!--检查清算状态 -->
      <Sentence>
         select ClrDat,ClrTim,ClrSts from  efeaclrtbl where BrNo='%s' 
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <!--零余额语句开始,add by qm-->
    <DynSentence name="QryCrpInf"><!--查询单位信息 -->
      <Sentence>
        SELECT CrpNam, StlAct FROM savcrpinf WHERE BrNo='%s' AND CrpCod='%s'
      </Sentence>
      <Fields>BrNo|CrpCod|</Fields>
    </DynSentence>
    <DynSentence name="QryAgrNum"><!-- 检查零余额账户-->
       <Sentence>
          SELECT COUNT(*) ZeroNum FROM pfacusagr WHERE　ActNo='%s' AND BusCnl='CBS' AND SUBSTR(AgrNo,7,9)='589527752'
       </Sentence>
       <Fields>ActNo</Fields>
    </DynSentence>
    <DynSentence name="QryPfaAgr"><!-- 查询零余额对应协议号-->
       <Sentence>
          SELECT distinct BCusId,AgrNo,PfaSub,SubCod FROM pfacusagr WHERE　ActNo='%s' AND BusCnl='CBS' AND SUBSTR(AgrNo,7,9)='589527752'
       </Sentence>
       <Fields>ActNo</Fields>
    </DynSentence>
    <!--零余额语句结束,add by qm-->

    <FlowCtrl>
      <Set>MacFlg=0</Set>
      <Quote name="MakeMac"/>
      <If condition="IS_NOEQUAL_STRING($MAC,$MsgMac)">
        <Set>RspCod=460201</Set>
        <Set>RspMsg=MAC校验错</Set>
        <Goto>EXIT_RETURN</Goto>
      </If>

      <Exec func="PUB:InitTransaction"/>    <!--交易初始化,预留-->

      <Exec func="PUB:GetAppInfo"/>

      <Exec func="PUB:ReadRecord">    <!--检查清算状态 -->
        <Arg name="SqlCmd" value="QryClrSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=460299</Set>
        <Set>RspMsg=不存在清算日期参数</Set>
        <Goto>EXIT_RETURN</Goto>
      </If>
      <If condition="IS_NOEQUAL_STRING($ClrSts,0)">
        <Set>RspCod=460299</Set>
        <Set>RspMsg=非交易状态</Set>
        <Goto>EXIT_RETURN</Goto>
      </If>

      <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
        <Arg name="SqlCmd" value="QryCrpAgr"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=460299</Set>
        <Set>RspMsg=单位协议不存在</Set>
        <Goto>EXIT_RETURN</Goto>
      </If>

      <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
        <Arg name="SqlCmd" value="QryCrpAgr"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=460299</Set>
        <Set>RspMsg=单位协议不存在</Set>
        <Goto>EXIT_RETURN</Goto>
      </If>

      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      
      <!--校验各分行账号-->
      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>
      <If condition="$MsgTyp=E">
         <Set>TTxnCd=$TTxnCd_tmp</Set>
         <Set>RspCod=$HRspCd</Set>
         <Set>RspMsg=账号查询错误</Set>
         <Goto>EXIT_RETURN</Goto>
       </If>

      <Switch expression="$ActCls">
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
         <If condition="INTCMP($ActCls,3,3)">
             <Set>ActFlg=4</Set>  <!--对私卡号-->
             <Set>ActTyp=4</Set>
          </If>
          <Else>
             <Set>ActFlg=2</Set>  <!--对私帐号-->
             <Set>ActTyp=2</Set>
          </Else>
          <Break/>
        </Case>
        <Case value="0"> <!-- 对公 -->
          <Set>ActTyp=1</Set>
          <Break/>
        </Case>
        <Case value="4">  <!--对公-->
        	<Set>ActNo=STRCAT(441,$ActNo)</Set>
          <Set>ActTyp=1</Set>
          <Break/>
        </Case>
        <Default>
            <Set>RspCod=460299</Set>
            <Set>RspMsg=帐户类型不存在</Set>
            <Goto>EXIT_RETURN</Goto>
        </Default>
      </Switch>



      <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
        <Set>HTxnCd=471140</Set>
        <Set>PayMod=1</Set>
        <Set>ActFlg=$ActTyp</Set>
        <Set>VchChk=1</Set><!--监督标志由业务上确定-->
        <Set>Mask=9102</Set> <!--摘要码：9102代扣电费-->
        <!--
        <Set>BusTyp=EFEA1</Set>
        -->
      </If>
      <ElseIf condition="INTCMP($ActTyp,3,1)"><!--对公-->
        <Set>HTxnCd=451610</Set>
        <Set>ActNod=SUBSTR($TActNo,1,6)</Set>
        <Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
        <Delete>TActNo</Delete>
        <Set>BusTyp=CRP51</Set>
        <Set>BusSub=01</Set>   <!--应用子码，对应业务类型CRP51-->
        <Set>ActFlg=2</Set>
        <Set>Smr=代扣电费</Set> <!--摘要-->
      </ElseIf>
      <Else>    <!--第三方-->
        <Set>RspCod=460299</Set>
        <Set>RspMsg=账号类型输入有误</Set>
        <Goto>EXIT_RETURN</Goto>
      </Else>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GZ_DLDF"/><!--可以使用单位编号-->
        <Arg name="Transaction" value="$TxnCod"/><!--可以用交易码或者模块名-->
      </Exec>

      <Set>TCusNm=$ActNam</Set>
      <Set>TActDt=$ClrDat</Set>     <!--清算日期-->

      <Set>PayMod=0</Set>
      <Set>CnlTyp=L</Set><!--交易渠道类型：L第三方系统-->
      <Set>VchChk=1</Set><!--监督标志由业务上确定-->
      <Set>VchCod=00000000</Set>
      <Set>AplCls=202</Set>
      <Set>MstChk=1</Set>  <!--20100511-->
      <Set>FRspCd= </Set>  <!--20100511-->
      <Set>ItgTyp=0</Set>  <!--20100511-->
      <Set>TXNTYP=N</Set>  <!--20100511-->

      <!-- 零余额账号开始, add by qm -->
      <!--检查零余额账户-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QryAgrNum"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=478399</Set>
        <Set>RspMsg=查询零余额账号数据库错</Set>
        <Goto>EXIT_RETURN</Goto>
      </If>
      <If condition="INTCMP($ZeroNum,6,0)">   <!--记录条数大于零-->
        <!--零余额账户处理开始-->
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="QryCrpInf"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=478399</Set>
          <Set>RspMsg=查询入帐单位信息数据库错</Set>
          <Goto>EXIT_RETURN</Goto>
        </If>
	   <Exec func="PUB:OpenCursor"><!--打开游标-->
	  	<Arg name="SqlCurFmp" value="QryPfaAgr"></Arg>
	  	<Arg name="CursorName" value="CUR_TRFA"/>
	   </Exec>					
	   <If condition="~RetCod!=0">
	  	<Set>MsgTyp=E</Set>
	  	<Set>RspCod=EFE999</Set>
	  	<Set>RspMsg=打开游标错QryPfaAgr!</Set>
	  	<Goto>EXIT_RETURN</Goto>
	   </If>
		<While>
			<Exec func="PUB:FetchCursor" error="IGNORE">	<!--取下一笔记录-->
			  <Arg name="CursorName" value="CUR_TRFA"/>
			</Exec>
			<If condition="~RetCod=100">
				<Exec func="PUB:CloseCursor">	<!--关闭游标-->
				  <Arg name="CursorName" value="CUR_TRFA"/>
				</Exec>
            <Set>MsgBodyFlg=0</Set>
		        <Goto>EXIT_RETURN</Goto>
		</If>
		<If condition="~RetCod!=0">
			<Exec func="PUB:CloseCursor">	<!--关闭游标-->
			  <Arg name="CursorName" value="CUR_TRFA"/>
			</Exec>
      <Set>MsgBodyFlg=0</Set>
  	  <Goto>EXIT_RETURN</Goto>
		</If>
          <Switch expression="$PfaSub">
            <Case value="001" > <!--省财政支付-->
            	<Set>PfaSub=$PfaSub</Set>       <!--财政应用编码-->
            	<Set>BCusId=$BCusId</Set>       <!--基层预算单位编码-->
            	<Set>PayAct=$ActNo</Set>        <!--付款人帐号-->
            	<Set>PayNam=$TCusNm</Set>       <!--付款名称单位-->
            	<Set>PayBNm=交通银行</Set>      <!--开户银行-->
            	<Set>PyeAct=$StlAct</Set>       <!--收款人帐号-->
              <Set>PyeNam=$CrpNam</Set>       <!--收款人名称-->
              <Set>PyeBNm=交通银行</Set>      <!--收款银行-->
              <Set>VchDat=$ActDat</Set>       <!--签发日期-->
              <Set>TOIFlg=O</Set>             <!--交易方向-->
              <Set>AgrNo=$AgrNo</Set>         <!--协议编码-->
              <Set>VchSmr=电力扣费</Set>      <!--摘要-->
              <Set>ActSqn=$ActSqn</Set>       <!--入帐帐号顺序号-->
              <Set>ActNod=$ActNod</Set>       <!--入帐网点-->
              <Set>TxnAmt=$TxnAmt</Set>       <!--金额-->
              <Set>NodNo=$ActNod</Set>        <!--凭证登记部门-->
              <Set>HSubCd=001</Set>           <!--借零余额户贷26201-->
              <Set>TTXnCd=461181</Set>
              <Set>THD_TRNCOD=461181</Set>
              <Set>THD_SVROBJ=STHDPFA3</Set>
      	      <!--省零余额记账-->
      	      <Call package="AFE" function="AFE_SglPrvZeroPay"/>      
              <Break/>
            </Case>
            <Case value="999" > <!--中央财政支付-->
              <Set>BrNam=广东省分行</Set>     <!--分行名称-->
              <Set>EleBk=63407</Set>          <!--电子联行号-->
              <!--Set>APVchN=$LogNo</Set-->   <!--授权支付凭证号码,该变量在AFE_SglCntZeroPay中赋值-->
              <Set>PayCod=$SubCod</Set>
              <Set>FinAre=999</Set>
              <Set>ActNo=$ActNo</Set>         <!--付款人帐号-->                                  
              <Set>ActNam=$TCusNm</Set>       <!--付款单位名称-->
              <Set>ANodNm=交通银行</Set>      <!--付款单位开户银行-->
              <Set>PyeAct=$StlAct</Set>       <!--收款人帐号-->
              <Set>PyeNam=$CrpNam</Set>       <!--收款单位名称-->
              <Set>PyeBk =交通银行</Set>      <!--收款单位开户银行-->
              <Set>UdwDat=$ActDat</Set>       <!--签发日期-->
              <Set>ActSqn=$ActSqn</Set>       <!--入帐帐号顺序号-->
              <Set>ActNod=$ActNod</Set>       <!--入帐网点-->
              <Set>StlMod=07</Set>            <!--结算方式-->
              <Set>CcyCod=CNY</Set>           <!--币种-->                      
              <Set>AthAmt=FABSAMT($TxnAmt,15)</Set>       <!--金额-->
              <!--Set>VInTlr=$TlrId</Set-->   <!--凭证登记录入员 该变量在AFE_SglCntZeroPay中赋值-->
              <Set>VRgNod=$ActNod</Set>       <!--凭证登记部门-->
              <Set>Smr=电信扣费</Set>         <!--摘要-->
              <Set>HSubCd=001</Set>           <!--主机交易子码 001记26201分户-->
              <Set>TTXnCd=363412</Set>
              <Set>THD_TRNCOD=363412</Set>
              <Set>THD_SVROBJ=STHDFAP2</Set>
      	      <!--中央零余额记账-->
      	      <Call package="AFE" function="AFE_SglCntZeroPay"/>                
              <Break/>
            </Case>
            <Default>
              <Set>RspCod=EFE001</Set>
              <Set>RspMsg=没该财政支付类型</Set>
              <Set>MsgBodyFlg=0</Set>
              <Goto>EXIT_RETURN</Goto>
            </Default>
          </Switch>

          <Set>FulRtn=0</Set><!--返回扣款标识,1:部分扣款;0:全部扣款-->
          <If condition="OR( IS_EQUAL_STRING($RspCod,CD5200), IS_EQUAL_STRING($RspCod,SD5200) )">
            <Set>BEChk=0</Set>
          </If>
          <Else>
            <Set>BEChk=1</Set>
          </Else>
          
          <If condition="IS_EQUAL_STRING($RspCod,000000)">
          	<!--记账成功返回-->
          	<Exec func="PUB:CloseCursor">	<!--关闭游标-->
          	  <Arg name="CursorName" value="CUR_TRFA"/>
          	</Exec>
          	<Goto>EXIT_RETURN</Goto>
          </If>
          <ElseIf condition="OR( IS_EQUAL_STRING($RspCod,CD5200), IS_EQUAL_STRING($RspCod,SD5200) )">
          	<!--余额不足取下一条协议-->
          	<Continue/>
          </ElseIf>
          <Else>
          	<!--其他错误返回-->
          	<Exec func="PUB:CloseCursor">	<!--关闭游标-->
          	  <Arg name="CursorName" value="CUR_TRFA"/>
          	</Exec>
          	<Set>MsgBodyFlg=0</Set>
          	<Goto>EXIT_RETURN</Goto>
          </Else>
          
        </While>
        <!--零余额账户处理结束-->
      </If>
      <!-- 零余额账号结束, add by qm -->

      <Call package="AFE" function="AFE_SglThdPay"/>
      <If condition="$RspCod=000000">

      </If>
      
 <Label>EXIT_RETURN</Label> <!--程序退出-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="RspCod"/>
        <Arg name="DestNam" value="TRtnCd"/>
        <Arg name="TblNam"  value="RspCodToThd"/>
      </Exec>
      
      <Set>MacFlg=1</Set>
      <Quote name="MakeMac"/>
      <Set>MsgMac=$MAC</Set>      

    </FlowCtrl>

  </Transaction>


  <Transaction code="460231" desc="电力划账冲正">

    <DynSentence name="Chk_TLogNoNum"><!--检查冲正记录 -->
      <Sentence>
        select count(*) TLogNoNum
        from afetxnjnl
        where CAgtNo='%s' and TLogNo='%s' AND HTxnSt IN ('T','S','U','C')
      </Sentence>
      <Fields>CAgtNo|OTLogNo|</Fields>
    </DynSentence>
    
    <DynSentence name="Chk_TLogNo"><!--检查凭单号是否重复 -->
      <Sentence>
        select HTxnSt,LogNo,TlrId, HLogNo OHLogNo, TckNo OTckNo,TXNAMT TTxnAmt
        from afetxnjnl
        where CAgtNo='%s' and TLogNo='%s' AND HTxnSt IN ('T','S','U','C')
        order by LogNo desc
      </Sentence>
      <Fields>CAgtNo|OTLogNo|</Fields>
    </DynSentence>
    <DynSentence name="Upd_TxnSt"><!--修改交易状态-->
      <Sentence>
        UPDATE afetxnjnl set HTxnSt='%s', TxnSts='%s', TTxnSt='%s'
        WHERE CAgtNo='%s' and TLogNo='%s'
      </Sentence>
      <Fields>HTxnSt|TxnSts|TTxnSt|CAgtNo|OTLogNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Set>MacFlg=0</Set>
      <Quote name="MakeMac"/>
      <If condition="IS_NOEQUAL_STRING($MAC,$MsgMac)">
        <Set>RspCod=460201</Set>
        <Set>RspMsg=MAC校验错</Set>
        <Goto>EXIT_RETURN</Goto>
      </If>

      <Exec func="PUB:InitTransaction"/>
      
      <Exec func="PUB:ReadRecord">  <!--检查冲正记录是否存在-->
        <Arg name="SqlCmd" value="Chk_TLogNoNum"/>
      </Exec>      
 
      <If condition="IS_EQUAL_STRING($TLogNoNum,0)">
        <Set>RspCod=460201</Set>
        <Set>RspMsg=无冲正记录</Set>
        <Goto>EXIT_RETURN</Goto>
      </If>
            
      <Exec func="PUB:ReadRecord">  <!--检查凭单号是否记帐-->
        <Arg name="SqlCmd" value="Chk_TLogNo"/>
      </Exec>


      <If condition="$HTxnSt=C">
        <Set>RspCod=460202</Set>
        <Set>RspMsg=已冲正</Set>
        <Goto>EXIT_RETURN</Goto>
      </If>

      <If condition="IS_EQUAL_INT($TTxnAmt,$TxnAmt)">
      </If>
      <Else>
        <Set>RspCod=460203</Set>
        <Set>RspMsg=金额不符</Set>
        <Goto>EXIT_RETURN</Goto>
      </Else>

   
      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GZ_DLDF"/>
        <Arg name="Transaction" value="460231"/>
      </Exec>

      <!--校验各分行账号-->
      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>
      <If condition="$MsgTyp=E">
         <Set>TTxnCd=$TTxnCd_tmp</Set>
         <Set>RspCod=$HRspCd</Set>
         <Set>RspMsg=账号查询错误</Set>
         <Goto>EXIT_RETURN</Goto>
       </If>

      <Switch expression="$ActCls">
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
         <If condition="INTCMP($ActCls,3,3)">
             <Set>ActFlg=4</Set>  <!--对私卡号-->
             <Set>ActTyp=4</Set>
          </If>
          <Else>
             <Set>ActFlg=2</Set>  <!--对私帐号-->
             <Set>ActTyp=2</Set>
          </Else>
          <Break/>
        </Case>
        <Case value="0" /> <!-- 对公 -->
        <Case value="4" >
          <Set>ActTyp=1</Set>
          <Break/>
        </Case>
        <Default>
            <Set>RspCod=460299</Set>
            <Set>RspMsg=帐户类型不存在</Set>
            <Goto>EXIT_RETURN</Goto>
        </Default>
      </Switch>

     
      <Set>OLogNo=$LogNo</Set>
      <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
        <Set>HTxnCd=471149</Set>
      </If>
      <ElseIf condition="INTCMP($ActTyp,3,1)"> <!--对公-->
        <Set>HTxnCd=451619</Set>
      </ElseIf>
      <Else>                                   <!--第三方-->
        <Return/>
      </Else>
      <Set>OTTxnCd=460230</Set>
      <Set>TTxnCd=$TxnCod</Set>

      <Set>TIATyp=C</Set>
      <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
      <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
        <Arg name="HTxnCd" value="959999"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>

      <If condition="IS_EQUAL_STRING(~RetCod,0)">    <!--上主机冲正成功-->
      	<Set>tmpTLogNo=$TLogNo</Set>
      	<Set>TLogNo=$OTLogNo</Set>
        <Set>HTxnSt=C</Set>
        <Set>TxnSts=C</Set>
        <Set>TTxnSt=C</Set>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="Upd_TxnSt"/>
        </Exec>
        <Set>TLogNo=$tmpTLogNo</Set>
      </If>    	
      <Else>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=$HRspCd</Set>
        <Set>RspMsg=冲正不成功</Set>      	
      </Else>

 <Label>EXIT_RETURN</Label> <!--程序退出-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="RspCod"/>
        <Arg name="DestNam" value="TRtnCd"/>
        <Arg name="TblNam"  value="RspCodToThd_CZ"/>
      </Exec>
      
      <Set>MacFlg=1</Set>
      <Quote name="MakeMac"/>
      <Set>MsgMac=$MAC</Set>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460232" desc="电力付费网关发出网管信息">
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <Set>LogNo=$BLogNo</Set>
      <Set>RspCod=000000</Set>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460244" desc="银行查询缴费用户信息">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>

    <FlowCtrl>

      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <Set>TxnKnd=020000</Set>                  
      <Set>RcsNo=315810</Set>                   <!--受理方机构标识码 -->
      <Set>RcvOrg=333333</Set>                  <!--接收机构标识码 -->
      <Set>CnyCod=001</Set>
      <Set>TTrmId=ADDCHAR($TrmNo,8, ,0)</Set>   <!--受理方终端标识码 -->
      <Set>CrpId=ADDCHAR($TlrId ,15, ,0)</Set>  <!--受理方标识码-->
      <Set>TraTyp=JF</Set>
      <Set>TCusId=ADDCHAR(DELSPACE($TCusId,all),21,  ,1)</Set>
      <Set>OData=STRCAT($TCusId,$LChkTm,01,SPACE(12),SPACE(56))</Set>
      	
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="460244"/>
        <Arg name="ObjSvr" value="STDAEFEA"/>
      </Exec>
      <If condition="$RspCod=000000">
        <Set>MsgTyp=N</Set>
      </If>
      <Else>
        <Exec func="PUB:RollbackWork" error="IGNORE" />        
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TRspCd"/>
          <Arg name="DestNam" value="RspMsg"/>
          <Arg name="TblNam"  value="ThdToRspMsg"/>
        </Exec>
        <If condition="IS_EQUAL_STRING($TRtnCd,00)">
        	<Set>RspCod=000000</Set>
        	<Set>MsgTyp=N</Set>
        </If>
        <Else>
          <Set>RspCod=EFE999</Set>
          <Set>MsgTyp=E</Set>
        </Else>
        <Return/>
      </Else>
      
      <!--Set>UsrAdd=DELSPACE(SUBSTR($UsrDat,1,32),all)</Set-->
      <Set>UsrAdd=DELSPACE(SUBSTR($UsrDat,1,SUB(GETSTRPOS($UsrDat,^),1)),all)</Set><!-- 用户地址 -->
      <!--Set>UsrNam=DELSPACE(SUBSTR($UsrDat,34,23),all)</Set-->
      <Set>UsrNam=DELSPACE(SUBSTR($UsrDat,ADD(GETSTRPOS($UsrDat,^),1),SUB(STRLEN($UsrDat),GETSTRPOS($UsrDat,^))),all)</Set><!-- 用户名称 -->
      
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460245" desc="银行实时缴费交易">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryCrpAgr">             <!--查询单位信息 -->
      <Sentence>
        SELECT TActNo, BBusTyp FROM savcrpagr WHERE BrNo='%s' AND CAgtNo='%s' AND SvrSts='1'
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Upd_TxnSt"><!--修改交易状态-->
      <Sentence>
        UPDATE afetxnjnl set HTxnSt='%s', TxnSts='%s', TTxnSt='%s'
        WHERE BrNo='%s' and CAgtNo='%s' and TckNo='%s' AND ActDat='%s'
      </Sentence>
      <Fields>HTxnSt|TxnSts|TTxnSt|BrNo|CAgtNo|OTckNo|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="QryClrSts">    <!--检查清算状态 -->
      <Sentence>
         select ClrDat,ClrTim,ClrSts from  efeaclrtbl where BrNo='%s' 
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>

      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <Exec func="PUB:ReadRecord">    <!--检查清算状态 -->
        <Arg name="SqlCmd" value="QryClrSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=不存在清算日期参数</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($ClrSts,0)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=非交易状态</Set>
        <Return/>
      </If>


      <!--读取协议数据-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryCrpAgr"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=460199</Set>
        <Set>RspMsg=无该单位协议或数据库错</Set>
        <Return/>
      </If>


     <Switch expression="$VchTyp">
      <Case value="000"><!--现金缴费-->
        <Set>ActFlg=0</Set>  <!--现金-->
        <Set>ActTyp=0</Set>
        <Set>PayMod=0</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>PayTyp=10</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Break/>
      </Case>
      <Case value="007"><!--银行卡-->
        <Set>ActFlg=4</Set>  <!--对私卡号-->
        <Set>ActTyp=4</Set>
        <!--测试时先密码验证先用0-->
        <Set>PayMod=0</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>PayTyp=10</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Break/>
      </Case>
      <Case value="704"><!--活期存折-->
        <Set>ActFlg=2</Set>  <!--对私帐号-->
        <Set>ActTyp=2</Set>
        <Set>PayMod=1</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>PayTyp=10</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Set>VchCod=$VchNo</Set><!--凭证编号-->
        <Break/>
      </Case>
      <Case value="722"><!--本外活本-->
        <Set>ActFlg=1</Set>  <!--一本通-->
        <Set>ActTyp=1</Set>
        <Set>PayMod=1</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>PayTyp=10</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--凭证编号-->
        <Set>VchCod=$VchNo</Set><!--凭证编号-->
        <Break/>
      </Case>
      <Case value="021"><!--个人支票,需删除-->
        <Set>ActFlg=5</Set>  <!--支票-->
        <Set>ActTyp=5</Set>
        <Set>PayMod=0</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>PayTyp=12</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Set>VchCod=$VchNo</Set><!--支票编号-->
        <Break/>
      </Case>
      <Case value="117"><!--本票-->
        <Set>PayTyp=12</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="127"><!--银承汇票,需删除-->
        <Set>PayTyp=12</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="129"><!--商承汇票,需删除-->
        <Set>PayTyp=12</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="105"><!--现金支票-->
        <Set>PayTyp=12</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="113"><!--转账支票-->
        <Set>PayTyp=12</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="115"><!--划线支票-->
        <Set>PayTyp=12</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Set>ChkNum=$VchNo</Set><!--支票编号-->
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
     </Switch>

     <If condition="OR(INTCMP($VchTyp,3,000),INTCMP($VchTyp,3,007),INTCMP($VchTyp,3,704),INTCMP($VchTyp,3,722),INTCMP($VchTyp,3,021))"><!--对私-->
        <Set>HTxnCd=471140</Set>
        <Set>VchChk=0</Set>
        <!--在前边对私凭证内添加<Set>PayMod=0</Set>支取方式 1 凭密支取 0 不验密-->
        <Set>ActFlg=$ActTyp</Set>
        <Set>VchCod=00000000</Set>
        <Set>VchChk=1</Set><!--监督标志由业务上确定-->
        <Set>Mask=9102</Set> <!--摘要码：9102代扣电费-->
        <!--
        <Set>BusTyp=EFEA1</Set>
        -->
     </If>
     <ElseIf condition="OR(INTCMP($VchTyp,3,117),INTCMP($VchTyp,3,127),INTCMP($VchTyp,3,129),INTCMP($VchTyp,3,105),INTCMP($VchTyp,3,113),INTCMP($VchTyp,3,115))"><!--对公-->
        <Set>HTxnCd=451240</Set>
        <Set>ActNod=SUBSTR($TActNo,1,6)</Set>
        <Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
        <Delete>TActNo</Delete>
        <Set>BusTyp=CRP51</Set>
        <Set>BusSub=01</Set>                   <!--应用子码，对应业务类型CRP51-->
        <Set>Smr=代扣电费</Set>  <!--摘要-->
     </ElseIf>
     <Else>
        <Return/>
     </Else>

      <Set>FTxnTm=GETDATETIME()</Set>
      <Quote name="Chk_TxnSrc"/>
      <Quote name="TxnSrc_TxnCnl"/>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GZ_DLDF"/>
        <Arg name="Transaction" value="460245"/>   <!--CFG_EFE_441999.XML -->
      </Exec>

      <Set>TxnKnd=020000</Set>                  
      <Set>RcsNo=315810</Set>                   <!--受理方机构标识码 -->
      <Set>RcvOrg=333333</Set>                  <!--接收机构标识码 -->
      <Set>CnyCod=001</Set>
      <Set>TTrmId=ADDCHAR($TrmNo,8, ,0)</Set>   <!--受理方终端标识码 -->
      <Set>CrpId=ADDCHAR($TlrId ,15, ,0)</Set>  <!--受理方标识码-->
      <Set>TActDt=$ClrDat</Set>     <!--清算日期-->
      <Set>TraTyp=JF</Set>
      <Set>TxnAmt=ADDCHAR(DELSPACE($TxnAmt,all),12,0,1)</Set> <!--交易金额-->
      <Set>Fee=ADDCHAR(DELSPACE($Fee,all),12,0,1)</Set>       <!--手续费-->
      <Set>TCusId=ADDCHAR(DELSPACE($TCusId,all),21, ,1)</Set> <!--客户编号-->
      <Set>ChkNum=ADDCHAR(DELSPACE($ChkNum,all),25, ,1)</Set> <!--支票号码-->
      <Set>OData=STRCAT(ADDCHAR($TCusId,21, ,1),$LChkTm,01,SPACE(12),$PayTyp,ADDCHAR($ChkNum,25, ,1))</Set>  <!--附加数据-->
      <Set>RsFld1=$OData</Set>                                <!--数据备用-->  
      <Set>MacFlag=0</Set>          <!--发送MAC生成-->
      <Quote name="MakeMac"/>
      <Set>MsgMac=$MAC</Set>
      
      <!--发送主机记账和第三方-->
      <Call package="AFE" function="AFE_SglBkPay"/>
      <If condition="$RspCod=000000">
        <Set>MsgTyp=N</Set>
      </If>
      <!--主机记账错误-->
      <ElseIf condition="AND(IS_EQUAL_STRING($HTxnSt,X),IS_EQUAL_STRING($TxnSts,X))">
        <Set>MsgTyp=E</Set>
      </ElseIf>
      <!--主机记账超时-->
      <ElseIf condition="IS_EQUAL_STRING($HTxnSt,T)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Exec func="PUB:PutResponse"/><!--返回查询结果信息-->
        <Goto>CRCHOST</Goto>
        <Return/>
      </ElseIf>
      <!--主机记账失败-->
      <ElseIf condition="AND(IS_EQUAL_STRING($HTxnSt,F),IS_EQUAL_STRING($TxnSts,F))">
        <If condition="IS_NOEQUAL_STRING($MsgTyp,A)">
          <Set>MsgTyp=E</Set>
        </If>
        <Return/>
      </ElseIf>
      <!--第三方发送错误-->
      <ElseIf condition="AND(IS_EQUAL_STRING($TTxnSt,X),IS_EQUAL_STRING($TxnSts,X))">
        <Set>MsgTyp=E</Set>
        <Return/>
      </ElseIf>
      <!--第三方发送或返回超时-->
      <ElseIf condition="IS_EQUAL_STRING($TTxnSt,T)">
        <Set>MsgTyp=E</Set>
        <Return/>
      </ElseIf>
      <!--第三方返回失败-->
      <Else condition="AND(IS_EQUAL_STRING($TTxnSt,F),IS_EQUAL_STRING($TxnSts,F))">
        <Set>MsgTyp=E</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TRspCd"/>
          <Arg name="DestNam" value="RspMsg"/>
          <Arg name="TblNam"  value="ThdToRspMsg"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Exec func="PUB:PutResponse"/><!--返回查询结果信息-->
        <Goto>CRCHOST</Goto>
        <Return/>
      </Else>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>
      <Return/>

      <Label>CRCHOST</Label> <!--只上主机冲正-->
         <Set>OLogNo=$LogNo</Set>
         <If condition="OR(INTCMP($VchTyp,3,000),INTCMP($VchTyp,3,007),INTCMP($VchTyp,3,704),INTCMP($VchTyp,3,722),INTCMP($VchTyp,3,021))"><!--对私-->
           <Set>HTxnCd=471149</Set>
         </If>
         <ElseIf condition="OR(INTCMP($VchTyp,3,117),INTCMP($VchTyp,3,127),INTCMP($VchTyp,3,129),INTCMP($VchTyp,3,105),INTCMP($VchTyp,3,113),INTCMP($VchTyp,3,115))"> <!--对公-->
           <!--
           <Set>HTxnCd=451619</Set>
           -->
           <Set>HTxnCd=451249</Set>
         </ElseIf>
         <Else>             <!--第三方-->
           <Return/>
         </Else>


         <Set>OHLogNo=$HLogNo</Set>
         <Set>OTckNo=$TckNo</Set>
         <Set>OTTxnCd=460245</Set>
         
         <Set>TTxnCd=$TxnCod</Set>
         <Set>OTxnSts=$TxnSts</Set>
         <Set>OHTxnSt=$HTxnSt</Set>
         <Set>HLogNo= </Set>
         <Set>HLogNo=DELSPACE($HLogNo,all)</Set>
      
         <Set>TIATyp=C</Set>
         <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
         <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
           <Arg name="HTxnCd" value="959999"/>
           <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

        <If condition="IS_EQUAL_STRING(~RetCod,0)">    <!--上主机冲正成功-->
          <Set>HTxnSt=C</Set>
          <Set>TxnSts=C</Set>
          <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="Upd_TxnSt"/>
          </Exec>
          <Return/>
        </If>
        <Else>    <!--不成功登记自动冲正-->
          <Exec func="PUB:DefaultErrorProc"/>
        </Else>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460246" desc="银行柜台当日代收冲销交易">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>

    <DynSentence name="Chk_TLogNo"><!--检查凭单号是否重复 -->
      <Sentence>
        select HTxnSt,TlrId, HLogNo OHLogNo, LogNo OLogNo,ActNo,TxnAmt,Fee,LChkTm,RsFld1,TActDt,ChkFlg
        from afetxnjnl
        where BrNo='%s' and CAgtNo='%s' and TckNo='%s' AND ActDat='%s' AND HTxnSt IN ('T','S','U','C')
        order by LogNo desc
      </Sentence>
      <Fields>BrNo|CAgtNo|OTckNo|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="Upd_TxnSt"><!--修改交易状态-->
      <Sentence>
        UPDATE afetxnjnl set HTxnSt='%s', TxnSts='%s', TTxnSt='%s'
        WHERE BrNo='%s' and CAgtNo='%s' and TckNo='%s' AND ActDat='%s'
      </Sentence>
      <Fields>HTxnSt|TxnSts|TTxnSt|BrNo|CAgtNo|OTckNo|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="QryClrDat">    <!--检查清算控制表中的清算日期 -->
      <Sentence>
         select ClrDat from  efeaclrtbl where BrNo='%s' and CAgtNo='%s'
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>


      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

<!-- add by qm 2011-12-01 begin -->
     <Exec func="PUB:AddAuthReason" >
         <Arg name="AthCod" value="40" />
         <Arg name="AthMsg" value="EFE000" />
     </Exec>
     <Exec  func="PUB:CheckLocalAuth" >
         <Arg name="ObjSvr" value="SHSTPUB1" />
     </Exec>
<!-- add by qm 2011-12-01 end -->

      <Exec func="PUB:ReadRecord">  <!--检查凭单号是否记帐-->
        <Arg name="SqlCmd" value="Chk_TLogNo"/>
      </Exec>

      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无冲正记录</Set>
        <Return/>
      </If>

      <If condition="$HTxnSt=C">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=已冲正</Set>
        <Return/>
      </If>

      <Exec func="PUB:ReadRecord">  <!--检查凭单号是否记帐-->
        <Arg name="SqlCmd" value="QryClrDat"/>
      </Exec>

      <If condition="OR(IS_EQUAL_STRING($ChkFlg,1),IS_NOEQUAL_STRING($TActDt,$ClrDat))">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=已清算,不能抹帐</Set>
        <Return/>
      </If>
  
      <If condition="INTCMP(ISNUMBER($ActNo),3,0)">
        <!--校验各分行账号-->
        <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
        <Call function="$AcJudFunc">
          <Input name="ActNo|NewFlg|"/>
          <Output name="OActNo|ActCls|"/>
        </Call>
        <If condition="$MsgTyp=E">
           <Set>TTxnCd=$TTxnCd_tmp</Set>
           <Set>RspCod=$HRspCd</Set>
           <Set>RspMsg=账号查询错误</Set>
           <Return/>
         </If>
        <Switch expression="$ActCls">
          <Case value="2" /> <!-- 对私 -->
          <Case value="3" /><!-- 银行卡 -->
          <Case value="5" />
          <Case value="7" ><!-- 现金 -->
           <If condition="INTCMP($ActCls,3,3)">
               <Set>HTxnCd=471149</Set>  <!--对私卡号-->
            </If>
            <Else>
               <Set>HTxnCd=471149</Set>  <!--对私帐号-->
            </Else>
            <Break/>
          </Case>
          <Case value="0" /> <!-- 支票 --><!-- 对公 -->
          <Case value="4" >
            <Set>HTxnCd=451249</Set>
            <Break/>
          </Case>
          <Default>
              <Set>RspCod=EFE999</Set>
              <Set>RspMsg=帐户类型不存在</Set>
              <Return/>
          </Default>
        </Switch>
      </If>
      <Else>
      	 <Set>HTxnCd=471149</Set>  <!--现金缴费-->
      </Else>

      <Set>TxnKnd=020000</Set>                  
      <Set>RcsNo=315810</Set>                   <!--受理方机构标识码 -->
      <Set>RcvOrg=333333</Set>                  <!--接收机构标识码 -->
      <Set>CnyCod=001</Set>
      <Set>TTrmId=ADDCHAR($TrmNo,8, ,0)</Set>   <!--受理方终端标识码 -->
      <Set>CrpId=ADDCHAR($TlrId ,15, ,0)</Set>  <!--受理方标识码-->
      <Set>TraTyp=JF</Set>
      <Set>TxnAmt=ADDCHAR(DELSPACE($TxnAmt,all),12,0,1)</Set> <!--交易金额-->
      <Set>Fee=ADDCHAR(DELSPACE($Fee,all),12,0,1)</Set>       <!--手续费-->
      <Set>ChkTim=GETDATETIME(MMDDHHMISS)</Set>  <!--交易日期时间-->
      <If condition="IS_EQUAL_STRING(SUBSTR($RsFld1,44,2),10)">
        <Set>OData=STRCAT(SUBSTR($RsFld1,1,31),SUBSTR($OLogNo,3,12),SUBSTR($RsFld1,44,2),SPACE(25))</Set> <!--附加数据--> 
      </If>
      <Else>
      	<Set>OData=STRCAT(SUBSTR($RsFld1,1,31),SUBSTR($OLogNo,3,12),SUBSTR($RsFld1,44,2),ADDCHAR(SUBSTR($RsFld1,46,25),25, ,1))</Set> <!--附加数据--> 
      </Else>
      <Set>MacFlag=0</Set>          <!--发送MAC生成-->
      <Quote name="MakeMac"/>
      <Set>MsgMac=$MAC</Set>

      <!--发向第三方冲正-->
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="460246"/>
        <Arg name="ObjSvr" value="STDAEFEA"/>
      </Exec>
      <If condition="$TRspCd=00">
        <Set>MsgTyp=N</Set>
      </If>
      <Else>
        <Set>MsgTyp=E</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="CrcDat"/>
          <Arg name="DestNam" value="RspMsg"/>
          <Arg name="TblNam"  value="ThdToRspMsg_CZ"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Return/>
      </Else>

      <Set>LogNo=$OLogNo</Set>
      <Set>OTTxnCd=460245</Set>
      <Set>TTxnCd=$TxnCod</Set>
      <Set>HLogNo= </Set>
      <Set>HLogNo=DELSPACE($HLogNo,all)</Set>

      <Set>TIATyp=C</Set>
      <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
      <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
        <Arg name="HTxnCd" value="959999"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>

      <If condition="IS_EQUAL_STRING(~RetCod,0)">    <!--上主机冲正成功-->
        <Set>HTxnSt=C</Set>
        <Set>TxnSts=C</Set>
        <Set>TTxnSt=C</Set>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="Upd_TxnSt"/>
        </Exec>
			  <Set>MsgTyp=N</Set>
			  <Set>RspCod=000000</Set>
			  <Set>RspMsg=交易成功!</Set>
      </If>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460247" desc="银行发送网管信息">
    <FlowCtrl>

      <Set>UsrDat=          桃园东路385号10栋0605房^市美林基业投资有限公司</Set>
      <!--Set>UsrAdd=DELSPACE(SUBSTR($UsrDat,1,32),all)</Set-->
      <Set>UsrAdd=DELSPACE(SUBSTR($UsrDat,1,SUB(GETSTRPOS($UsrDat,^),1)),all)</Set>
      <!--Set>UsrNam=DELSPACE(SUBSTR($UsrDat,34,23),all)</Set-->
      <Set>UsrNam=DELSPACE(SUBSTR($UsrDat,ADD(GETSTRPOS($UsrDat,^),1),SUB(STRLEN($UsrDat),GETSTRPOS($UsrDat,^))),all)</Set>
    	<!--该部分程序是验证读XML文件的方法-->
      <!--
      <Exec func="PUB:OpenFile" error="IGNORE">
        <Arg name="FileName" value="test/test.xml"/>
        <Arg name="Mode"     value="r"/>
      </Exec>
    	
    	<Exec func="PUB:GetFileLineAndParse">  
        <Arg name="ConfigName" value="BatFormat"/> 
        <Arg name="RootName"   value="BATCH"/>
        <Arg name="NodeName"   value="Process"/>
        <Arg name="AttrName"   value="name"/>
        <Arg name="AttrValue"  value="getfile"/>
      </Exec>
      <Set>kkk=$data11</Set>
      
      <Exec func="PUB:CloseFile" error="IGNORE">
      </Exec>    	
    	<Return/> 
    	--> 	
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
   
      <Exec func="PUB:InitTransaction"/>
      <Set>RspCod=000000</Set>
      <Set>ChkTim=GETDATETIME(MMDDHHMISS)</Set>  <!--交易日期时间-->
      <Set>SndNo=315810</Set> <!--发送机构标示码-->
      <Set>WebInf=301</Set>   <!--网管信息码-->
      
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="460247"/>
        <Arg name="ObjSvr" value="STDAEFEA"/>
      </Exec>
      <If condition="IS_EQUAL_STRING($TRspCd,00)">
      	<Set>RspCod=000000</Set>
      	<Set>MsgTyp=N</Set>
      </If>
      <Else>    
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TRspCd"/>
          <Arg name="DestNam" value="RspMsg"/>
          <Arg name="TblNam"  value="ThdToRspMsg"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Set>MsgTyp=E</Set>
        <Return/>
      </Else>
      
    </FlowCtrl>
  </Transaction>



<Transaction code="460200" desc="大小通道交易处理"> <!--RecSts 0:初始化 1:成功 2:失败-->
    <DynSentence name="UpdRecSts">
      <Sentence>
        UPDATE afebatrec SET RecSts='%s',HTxnSt='%s',HRspCd='%s' WHERE DskNo='%s' AND SeqNo='%s'
      </Sentence>
      <Fields>RecSts|HTxnSt|HRspCd|DskNo|SeqNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdRecSts1">
      <Sentence>
        UPDATE afebatrec SET HRspCd='%s', RecSts='2' WHERE DskNo='%s' AND SeqNo='%s'
      </Sentence>
      <Fields>RspCod|DskNo|SeqNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdThdJnl"><!--更新流水表-->
         <Sentence>
            UPDATE afetxnjnl SET HLOGNO='%s',HRSPCD='%s',HTXNST='%s',TCKNO='%s' WHERE LogNo='%s'
         </Sentence>
         <Fields>HLogNo|HRspCd|HTxnSt|TckNo|LogNo|</Fields>
    </DynSentence>
    <DynSentence name="QryClrSts">    <!--检查清算状态 -->
      <Sentence>
         select ClrDat,ClrTim,ClrSts from  efeaclrtbl where BrNo='%s' 
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <FlowCtrl>

      <Exec func="PUB:ReadRecord">    <!--检查清算状态 -->
        <Arg name="SqlCmd" value="QryClrSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=不存在清算日期参数</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($ClrSts,0)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=非交易状态</Set>
        <Return/>
      </If>

      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>

      <Switch expression="$ActCls">
        <Case value="0" /> <!-- 对公 -->
        <Case value="4" >
          <If condition="INTCMP($TxnDir,3,0)"> <!--代收-->
            <Set>HTxnCd=451610</Set>
            <Set>HTxnCd=451610</Set>
            <Set>ActFlg=2</Set>  <!--Add by Lucky,20070614,扣款模式,2正常扣款-->
            <Set>ActSqn=SUBSTR($CActNo,14,5)</Set>
            <Set>ActNod=LEFTSTR($CActNo,6)</Set>
            <Set>BusTyp=CRP51</Set>
          </If>
          <ElseIf condition="INTCMP($TxnDir,3,1)">  <!--代付-->

          </ElseIf>
          <Break/>
        </Case>
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
          <If condition="INTCMP($TxnDir,3,0)"> <!--代收-->
            <Set>HTxnCd=471140</Set>
            <Set>VchCod=00000000</Set>
            <Set>TActNo=$CActNo</Set>
          </If>
          <ElseIf condition="INTCMP($TxnDir,3,1)"> <!--代付-->
            <Set>HTxnCd=471340</Set>
            <Set>PActNo=$CActNo</Set>
          </ElseIf>
          <Set>CcyTyp=1</Set>
          <Set>VchChk=1</Set>
          <Set>CnlTyp=0</Set>
          <Set>Mask=$BSmr</Set>
          <If condition="INTCMP($ActCls,3,3)">
            <Set>ActFlg=4</Set>
          </If>
          <Else>
            <Set>ActFlg=2</Set>
          </Else>
          <Break/>
        </Case>
        <Default>
          <Set>HRspCd=481210</Set>    <!--帐号检查错-->
          <Set>MsgTyp=N</Set>
          <Set>RecSts=2</Set>
          <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdRecSts"/>
          </Exec>
          <Exec func="PUB:PutResponse"/>
          <Return/>
        </Default>
      </Switch>
      <!-- 上主机 -->
      <Set>TActNo=$CActNo</Set>

      <!--add by chen-->
      <Set>TxnTyp=N</Set>
      <Set>ItgTyp=0</Set>
      <Set>FRspCd=000000</Set>
      <Set>MstChk=1</Set>
      
      <Set>TActDt=$ClrDat</Set> <!--清算日期-->
      
      <Exec func="PUB:InsertRecord" error="IGNORE">
            <Arg name="TblNam" value="afetxnjnl"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
            <Set>RspCod=482199</Set>
            <Set>RspMsg=插入流水表失败</Set>
            <Return/>
      </If>

      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="$HTxnCd"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="~RetCod=0">  <!--recsts 0:初始化 1:成功 2:失败 -->
        <Set>HTxnSt=S</Set>
        <Set>HRspCd=SC0000</Set>
        <Exec func="PUB:ExecSql" error="IGNORE"> <!--更新记账信息-->
           <Arg name="TblNam" value="afetxnjnl"/>
           <Arg name="CndSts" value="UpdThdJnl"/>
        </Exec>
       
        <Set>RecSts=1</Set>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="UpdRecSts"/>
        </Exec>
        <Set>MsgTyp=N</Set>
        <Exec func="PUB:PutResponse"/>
        <Return/>
      </If>
      <ElseIf condition="~RetCod=3">  <!--recsts 0:初始化 1:成功 2:失败 -->
        <Set>HTxnSt=F</Set>
        <Exec func="PUB:ExecSql" error="IGNORE"> <!--更新记账信息-->
           <Arg name="TblNam" value="afetxnjnl"/>
           <Arg name="CndSts" value="UpdThdJnl"/>
        </Exec>

        <Set>RecSts=2</Set>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="UpdRecSts"/>
        </Exec>
        <Set>MsgTyp=N</Set>
        <Exec func="PUB:PutResponse"/>
        <Return/>
      </ElseIf>
    </FlowCtrl>

</Transaction>


  <Transaction code="460222" desc="供电发起批量代扣交易">

    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>

    <DynSentence name="QryInfCtl">             <!--查询对应分行号-->
      <Sentence>
        SELECT BrNo FROM efeinfctl WHERE DLIP='%s'
      </Sentence>
      <Fields>DLIP|</Fields>
    </DynSentence>
    <DynSentence name="QueDskNam">
      <Sentence>
        SELECT DskNo FROM pubbatinf WHERE BrNo='%s' AND ActDat='%s' AND DskNam='%s' AND Status in ('P','N')
      </Sentence>
      <Fields>BrNo|ActDat|DskNam|</Fields>
    </DynSentence>
    <DynSentence name="GetCAgtNo">
      <Sentence>
        SELECT DISTINCT CAgtNo FROM efebatinf  WHERE BrNo='%s' AND DskNo='%s'
      </Sentence>
      <Fields>BrNo|DskNo|</Fields>
    </DynSentence>
    <DynSentence name="GetCrpInf">
      <Sentence>
        SELECT b.CrpNam
        FROM savcrpagr a,savcrpinf b
        WHERE a.Brno='%s' AND a.CAgtNo='%s' AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Chk_CrpAgr"><!--检查单位协议 -->
      <Sentence>
        select a.BrNo,a.BBusTyp,a.TActNo,a.CrpCod,a.TxnDir,b.StlAct
        from savcrpagr a, savcrpinf b
        where a.BrNo='%s' and a.CAgtNo='%s' and SvrSts='1' and b.CrpCod=a.CrpCod and a.brno=b.brno
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Chk_CrpSignIn"><!--检查单位签到状态 -->
      <Sentence>
        SELECT 'Y' YN
        from table(values(1)) as anony
        where Exists(select * from savthdinf where BrNo='%s' and CAgtNo='%s' and status='1')
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryBatRec"><!--检查批次明细信息 -->
      <Sentence>
        select DskNo,SeqNo,OldAct from afebatrec where DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdBatRec1"><!--非一本通 -->
      <Sentence>
        UPDATE afebatrec Set ActNo='%s',ActNam='%s',ActTyp='%s' where DskNo='%s' AND SeqNo='%s'
      </Sentence>
      <Fields>ActNo|ActNam|ActTyp|DskNo|SeqNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdBatRec2"><!--一本通 -->
      <Sentence>
        UPDATE afebatrec Set ActNo='%s',ActNam='%s',ActTyp='%s',ActSqn='%s' where DskNo='%s' AND SeqNo='%s'
      </Sentence>
      <Fields>ActNo|ActNam|ActTyp|ActSqn|DskNo|SeqNo|</Fields>
    </DynSentence>
    <DynSentence name="DeleteInf">
      <Sentence>
        Delete from pubbatinf where BrNo='%s' AND DskNo='%s'
      </Sentence>
      <Fields>BrNo|DskNo|</Fields>
    </DynSentence>
     <DynSentence name="SelCusAgtInf2">  <!--查询有效的对私客户协议 -->
      <Sentence>
        SELECT count(*) cnt2 FROM afebatrec
        WHERE CAgtNo='%s' and DskNo='%s' and 
        　　　SeqNo in (select SUBSTR(b.PNO,6,5) from efecusagt a,efebatinf b 
              where a.BrNo='%s' and  b.DskNo='%s' and a.JFH=b.JFH and a.ActNo=b.ActNo and a.ActNam=b.ActNam and a.Status='0')
      </Sentence>
      <Fields>CAgtNo|DskNo|BrNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="UpdCusAgtInf2">  <!--检查有效的对私客户协议 -->
      <Sentence>
        UPDATE afebatrec a
        SET RecSts='Y'
        WHERE CAgtNo='%s' and DskNo='%s' and 
        　　　SeqNo in (select SUBSTR(b.PNO,6,5) from efecusagt a,efebatinf b 
              where a.BrNo='%s' and  b.DskNo='%s' and a.JFH=b.JFH and a.ActNo=b.ActNo and a.ActNam=b.ActNam and a.Status='0')
      </Sentence>
      <Fields>CAgtNo|DskNo|BrNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="SelNoAgr">  <!-- 查询没通过协议检查的记录 -->
      <Sentence>
        SELECT count(*) cnt1 FROM afebatrec 
        WHERE RecSts!='Y' AND CAgtNo='%s' AND DskNo='%s'
      </Sentence>
      <Fields>CAgtNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="UpdNoAgr">  <!-- 更新没通过协议检查的记录 -->
      <Sentence>
        UPDATE afebatrec 
        SET RecSts='X',HTxnST='S',HRspCd='400004'
        WHERE RecSts!='Y' AND CAgtNo='%s' AND DskNo='%s'
      </Sentence>
      <Fields>CAgtNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="UpRsvFld">  <!-- 更新pubbatinf的rsvfld -->
      <Sentence>
        UPDATE pubbatinf SET RsvFld='%s'
        WHERE BrNo='%s' AND DskNo='%s' 
      </Sentence>
      <Fields>CAgtNo|BrNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="UpRsFld1">  <!-- 更新afebatrec的rsfld1 -->
      <Sentence>
        UPDATE afebatrec SET RsFld1='%s'
        WHERE BrNo='%s' AND DskNo='%s' 
      </Sentence>
      <Fields>ROOT.SUM.RsFld1|BrNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="QryClrSts">    <!--检查清算状态 -->
       <Sentence>
          select ClrDat,ClrTim,ClrSts from  efeaclrtbl where BrNo='%s' 
       </Sentence>
       <Fields>BrNo|</Fields>
     </DynSentence>

    <FlowCtrl>

      <Exec func="PUB:InitTransaction"/>    <!--交易初始化,预留-->

      <Exec func="PUB:GetAppInfo"/>

      <Exec func="PUB:ReadRecord">    <!--检查清算状态 -->
        <Arg name="SqlCmd" value="QryClrSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=不存在清算日期参数</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($ClrSts,0)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=非交易状态</Set>
        <Return/>
      </If>

      <Exec func="PUB:IsExistNode" error="IGNORE">
        <Arg name="FieldName" value="FilNam"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,1)">  <!--手工发起标志-->
        <Set>AutFlg=0</Set>
      </If>
      <Else>                                <!--自动发起标志-->
        <Set>AutFlg=1</Set>
      </Else>
  
      <Set>Num5=1</Set>

   <While condition="INTCMP($Num5,2,5)">
   	 
   	  <Set>FilSeq=001</Set>                <!--文件序号-->

<Label>SEQNEXT</Label> <!--文件序号-->
   	 
   	  <If condition="INTCMP($AutFlg,3,0)"> <!-- 手工 -->
   	  	<Set>DskNam=$FilNam</Set>
        <Set>RcvFil=$FilNam</Set>
        <Set>LclFil=$FilNam</Set>
   	  	<!--test
        <Exec func="PUB:FtpGet">
          <Arg name="FtpId" value="GZ_EFE01"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=460299</Set>
          <Set>RspMsg=取第三方文件失败</Set>
          <Return/>
        </If>
        -->
   	  </If>
   	  <Else>
        <If condition="INTCMP($Num5,3,1)">
        	<Set>DptCode=00</Set> <!-- 城区 -->
        </If>
        <ElseIf condition="INTCMP($Num5,3,1)">
        	<Set>DptCode=10</Set> <!-- 从化 -->
        </ElseIf>
        <ElseIf condition="INTCMP($Num5,3,1)">
        	<Set>DptCode=11</Set> <!-- 增城 -->
        </ElseIf>
        <ElseIf condition="INTCMP($Num5,3,1)">
        	<Set>DptCode=12</Set> <!-- 花都 -->
        </ElseIf>
        <ElseIf condition="INTCMP($Num5,3,1)">
        	<Set>DptCode=13</Set> <!-- 番禺 -->
        </ElseIf>
        <Set>FilNam=STRCAT(0001,_,$ActDat,_,$DptCode,_,$FilSeq,.set)</Set>
        <Set>DskNam=$FilNam</Set>  
        <Set>RcvFil=$FilNam</Set>
        <Set>LclFil=$FilNam</Set>
        <Set>LclDir=dat/efea</Set>        
        <Exec func="PUB:FtpGet">
          <Arg name="FtpId" value="EFE_RCV_441"/>
        </Exec>
        <If condition="~RetCod!=0">
        	<Set>Num5=ADD($Num5,1)</Set>
          <Continue/>
        </If>                 
   	  </Else>

      <!--取CAgtno值 放在接口文件取-->
      <Set>DptTyp=STRCAT(SUBSTR($DskNam,15,2),00)</Set>
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptTyp"/>
        <Arg name="DestNam" value="CAgtNo"/>
        <Arg name="TblNam"  value="DptTypToCAgtNo_PL"/>
      </Exec>      

      <!--取电子柜员号-->
      <Set>TxnCnl=EFE</Set>       <!--取电子柜员号用-->
      <Set>TxnObj=OFTAEFEA</Set>
      <Exec func="PUB:GetVirtualTeller">
        <Arg name="TxnCnl" value="EFE"/>
      </Exec>
      <Set>TlrId=$TlrId</Set>

      <!--判断文件是否重复录入-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QueDskNam"></Arg>
      </Exec>
      <If condition="~RetCod!=-2">
        <Set>RspCod=481299</Set>
        <Set>RspMsg=STRCAT(改批次已录入，批次号为,$DskNo)</Set>
        <Return/>
      </If>

      <!--读取配置信息-->
      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GZ_DLDFPL"/>
        <Arg name="Transaction" value="$TxnCod"/>
      </Exec>



      <!--准备大小通道需要的相关参数-->
      <Set>TxnMod=1</Set>
      <Set>CmtFlg=0</Set>
      <Set>AplCls=$AplCls</Set>
      <Set>BusTyp=$BusTyp</Set>
      <Set>BusSub=$BusSub</Set>
      <Set>ObjSvr=@PARA.ObjSvr</Set>
      <Set>FTxnCd=@PARA.FTxnCd</Set>  <!--后续交易(用于后续操作并通知前端批次完成的)-->
      <Set>BrNo=$BrNo</Set>   <!--入账分行号-->
      <Set>ActNod=$NodNo</Set>  <!--账务网点号-->
      <Set>TrdTbl=@PARA.TrdTbl</Set>
      <Set>NamChk=0</Set>   <!--需要检查户名-->
      <Set>TxnSqn=600</Set>
      <Set>TxnMod=1</Set>   <!-- 需要单笔上送 -->
      <Set>CmtFlg=0</Set>   <!-- 大小通道发送状态 -->
      <Set>UpdFlg=N</Set>   <!-- 更新标志 -->
      <Set>PayMod=0</Set>
      <Set>HPrChk=0</Set>
      <Set>HLsChk=0</Set>
      <Set>CActNo=$TActNo</Set>
      <Set>IsTxn=Y</Set>
      <Set>HTxnSt=U</Set>
      <Set>RsvFld=$CAgtNo</Set>
      <Set>HTxnCd=@PARA.HTxnCd</Set>
      <Set>Reckey=STRCAT($AplCls,:,$TxnCod,:,$FilNam)</Set>


      <Exec func="PUB:CollateRepeatRecord"> <!--判断是否是重复接收的报文-->
        <Arg name="CheckFileName" value="$DskNam"/>
      </Exec>

      <Exec func="PUB:Lock">      <!--按文件名加锁-->
        <Arg name="RecKey"   value="STRCAT($BusTyp,$CrpCod,$DskNam)"/>
        <Arg name="TimOut"   value="10"/>
      </Exec>

      <Exec func="PUB:RegisterBatchDiskNo"/>  <!--申请磁盘编号，登记批量信息到pubbatinf-->

      <Exec func="PUB:Unlock">    <!--按文件名解锁-->
        <Arg name="RecKey"   value="STRCAT($BusTyp,$CrpCod,$DskNam)"/>
      </Exec>

      <!--导入文件-->
      <Set>FileName=STRCAT(GETENV(WORKDIR),/dat/efea/,$LclFil)</Set>
      <Exec func="PUB:IsExistFile"  error="IGNORE">
        <Arg name="FileName" value="$FileName"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=STRCAT(文件,$FilNam,不存在)</Set>
        <Return/>
      </If>

      <Exec func="PUB:PasteBatchFile" >   <!--拷贝文件 -->
        <Arg name="PathIn" value="dat/efea"/>
        <Arg name="FileNameIn" value="$LclFil"/>
        <Arg name="FileNameCurr" value="01"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>RspCod=478007</Set>
        <Set>RspMsg=拷贝文件失败</Set>
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Return/>
      </If>



      <Exec func="PUB:ReadRecord">  <!--获取单位名称-->
        <Arg name="SqlCmd" value="GetCrpInf"></Arg>
      </Exec>

      <If condition="@PARA.ChkCrp=1">
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="Chk_CrpAgr"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>RspCod=478399</Set>
          <Set>RspMsg=查询单位协议时系统错误</Set>
          <Return/>
        </If>
        <If condition="~RetCod=-2">
          <Set>RspCod=478602</Set><!--返回无有效单位协议-->
          <Set>RspMsg=查询单位协议时无有效单位协议</Set>
          <Return/>
        </If>
      </If>
      <If condition="@PARA.IsSignIn=1">
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="Chk_CrpSignIn"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>RspCod=478399</Set>
          <Set>RspMsg=检查单位签到状态时系统错误</Set>
          <Return/>
        </If>
        <If condition="~RetCod=-2">
          <Set>RspCod=478605</Set><!--返回该单位未签到-->
          <Set>RspMsg=检查单位签到状态时该单位未签到</Set>
          <Return/>
        </If>
      </If>
      
      <Set>CActNo=$TActNo</Set>
      <Set>RsvFld=$CAgtNo</Set><!--补充大小通道参数-->

      <Set>BSmr=$BBusTyp</Set>

      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="UpRsvFld"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Set>RspCod=481299</Set>
        <Return/>
      </If>

      <Set>SeqNo=1</Set>
      <Set>RecSts=0</Set> <!--RecSts 0:初始化 1:成功 2:失败-->
      <Exec func="PUB:ParseBatchFile">   <!--文件拆分入库-->
        <Arg name="FormatName"     value="@PARA.RcvFmt"/>   <!--文件格式-->
        <Arg name="TableName"      value="afebatrec"/>
        <Arg name="FileNameCurr"   value="01"/>
        <Arg name="ApplyLogNoFlag" value="1"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Set>RspCod=481299</Set>
        <Return/>
      </If>

      <!--更新广州供电局的批次号-->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="UpRsFld1"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Set>RspCod=481299</Set>
        <Return/>
      </If>
  
      <If condition="INTCMP($AutFlg,3,0)"> <!-- 手工 -->
        <Set>RspCod=000000</Set>
        <Exec func="PUB:PutResponse"/>
      </If>
      
       <!--检查个人签约协议-->
      <If condition="@PARA.ChkPsn=1">
        <Exec func="PUB:ReadRecord">  
          <Arg name="SqlCmd" value="SelCusAgtInf2"></Arg>
        </Exec>
        <If condition="STRCMP($cnt2,0)!=0">
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdCusAgtInf2"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:DeleteDiskNo" />
            <Return />
          </If>
          <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
          </ElseIf>
        </If>
        <!-- 更新没通过协议检查的记录 -->
        <Exec func="PUB:ReadRecord">  
          <Arg name="SqlCmd" value="SelNoAgr"></Arg>
        </Exec>
        <If condition="STRCMP($cnt1,0)!=0">
          <Exec func="PUB:ExecSql" error="PUB:DeleteDiskNo">
            <Arg name="SqlCmd" value="UpdNoAgr"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:DeleteDiskNo" />
            <Return />
          </If>
          <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
          </ElseIf>
        </If>
      </If>


      <!--修改本批次为预备确认状态，等待启动大小通道 -->
      <Exec func="PUB:UpdateBatchStatus" error="PUB:DeleteDiskNo">
        <Arg name="ChkFlg" value="P"/>
      </Exec>
      <Exec func="PUB:DeleteDiskNo"/>

      <Exec func="PUB:ConfirmBatch"/>
      <If condition="~RetCod!=0">
        <Set>RspCod=481299</Set>
        <Return/>
      </If>

      <If condition="INTCMP($AutFlg,3,0)"> <!-- 手工启动情况 -->
      	<!--手工做一次，退出循环-->
      	<Break/>
      </If>
      <Else>
      	<Set>FilSeq=ADD($FilSeq,1)</Set>
      	<Goto>SEQNEXT</Goto>
      </Else>
      
   </While>

      <Set>RspCod=000000</Set>
      <Set>RspMsg=操作成功</Set>

    </FlowCtrl>

  </Transaction>

  <Transaction code="460225" desc="文件批量完成通知第三方">
    <DynSentence name="GetCrpInf">
      <Sentence>
        SELECT a.OrnCnt,a.OrnAmt,b.CAgtNo,b.BBusTyp,c.CrpNam
        FROM pubbatinf a,savcrpagr b,savcrpinf c
        WHERE a.DskNo='%s' AND a.RsvFld=b.CAgtNo AND b.CrpCod=c.CrpCod AND b.BrNo=c.BrNo
      </Sentence>
      <Fields>DskNo</Fields>
    </DynSentence>
    <DynSentence name="QryBatInf"><!--查询本交易所需信息-->
      <Sentence>
        SELECT BrNo,DskNo,SndTlr TlrId,NodNo,DskNam From pubbatinf WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <!--
    <DynSentence name="UpdBatInf">
      <Sentence>
        update pubbatinf
        set Status='N'
        WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    -->
    <DynSentence name="QryRsFld1">  <!--查询广州供电局批次号-->
      <Sentence>
        SELECT distinct RsFld1,SetDat,ActDat
        FROM afebatrec 
        WHERE  DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="QryTxnInf">  <!--查询交易记录-->
      <Sentence>
        SELECT *
        FROM afebatrec 
        WHERE  DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="TotSql">
      <Sentence>
        select count(*) TotCnt, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotAmt
        from afebatrec
        where DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="TotSucSql">
      <Sentence>
        select count(*) STotCnt, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) STotAmt
        from afebatrec
        where  DskNo='%s' and HTxnSt='S' and RecSts='1'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="TotFalSql">
      <Sentence>
        select count(*) FTotCnt, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) FTotAmt
        from afebatrec
        where  DskNo='%s' and HTxnSt in ('S','F') and RecSts!='1'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <FlowCtrl>

      <Set>DskNo=$LogNo</Set>


      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="GetCrpInf"/>
      </Exec>
      <Exec func="PUB:ReadRecord"><!--查询必需信息-->
        <Arg name="SqlCmd" value="QryBatInf"/>
      </Exec>

      <Exec func="PUB:ReadRecord"><!--查询广州供电局批次号-->
        <Arg name="SqlCmd" value="QryRsFld1"/>
      </Exec>

      <Exec func="PUB:CancelBatchRedo"/><!--以下两句用于更新pubbatinf中的状态值-->

      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="TotSucSql"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="TotFalSql"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="TotSql"/>
      </Exec>

      <Set>Flag=|</Set>
      <Set>DFMon= </Set>

      <Set>LclDir=dat/efea</Set>
      <Set>LclFil=STRCAT(1001,SUBSTR($DskNam,5,27),.cb)</Set>
      <Set>SndFil=STRCAT($LclFil,.cb)</Set>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GZ_DLDFPL"/>
        <Arg name="Transaction" value="460222"/>
      </Exec>

      <!--产生已扣文件给电力-->
      <Exec func="PUB:ExportFromDB">
        <Arg name="FormatName" value="@PARA.SndFmt"/>
        <Arg name="SqlName"    value="QryTxnInf"/>
        <Arg name="FileName"   value="STRCAT($LclDir,/,$LclFil)"/>
        <Arg name="TableName"  value="afebatrec"/>
      </Exec>
      <!--FTP -->
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
        <Switch  expression="$BrNo">
          <Case value="441999">
            <Set>EFESnd=EFE_SND_441</Set>
            <Break/>
          </Case>
          <Case value="444999">
            <Break/>
          </Case>
          <Case value="446999">
            <Break/>
          </Case>
          <Case value="445999">
            <Break/>
          </Case>
          <Case value="483999">
            <Break/>
          </Case>
          <Case value="484999">
            <Break/>
          </Case>
          <Case value="485999">
          	<Set>EFESnd=EFE_SND_485</Set>
            <Break/>
          </Case>
          <Case value="491999">
            <Break/>
          </Case>
          <Case value="4761999">
            <Break/>
          </Case>
          <Case value="441999">
            <Break/>
          </Case>
          <Default>
            <Set>EFESnd=EFE_SND_441</Set>
          </Default>
        </Switch>       
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="$EFESnd"/>
      </Exec>
     
      <Exec func="PUB:CancelBatchRedo"/>

    </FlowCtrl>

  </Transaction>


  <Transaction code="460250" desc="银行发起银行代扣代收电费对帐交易">
    <!--生成文件  只统计主机成功状态的-->
    <DynSentence name="GetTxnJnl_DL">
      <Sentence>
        SELECT TLogNo,TCusId,TActDt,ActDat,substr(FTxnTm,9,6) BkTim, substr(LogNo,3,12) BkLog, ActNo, TxnAmt,substr(ActDat,1,4)||substr(ChkTim,1,4) DLDat, substr(ChkTim,5,6) DLTim,LChkTm
        FROM afetxnjnl
        WHERE CAgtNo = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND TxnCod='%s'
      </Sentence>
      <Fields>CAgtNo|ClrDat|tmpTxnCod|</Fields>
    </DynSentence>
    <DynSentence name="GetTxnJnl_YH">
      <Sentence>
        SELECT TLogNo,TCusId,TActDt,ActDat,substr(FTxnTm,9,6) BkTim, substr(LogNo,3,12) BkLog, ActNo, TxnAmt,substr(ActDat,1,4)||substr(ChkTim,1,4) DLDat, substr(ChkTim,5,6) DLTim, LChkTm, substr(RsFld1,43,2) PayTyp,substr(RsFld1,45,25) ChkNum
        FROM afetxnjnl
        WHERE CAgtNo = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND TxnCod='%s'
      </Sentence>
      <Fields>CAgtNo|ClrDat|tmpTxnCod|</Fields>
    </DynSentence>
    <!--生成文件 总笔数 只统计主机成功状态的-->
    <DynSentence name="TotalDeal_DL">
      <Sentence>
        SELECT Count(*) TotalDeal, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotalFee
        FROM afetxnjnl
        WHERE CAgtNo  = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND TxnCod='%s'
      </Sentence>
      <Fields>CAgtNo|ClrDat|tmpTxnCod|</Fields>
    </DynSentence>
     <DynSentence name="TotalDeal_YH">
      <Sentence>
        SELECT Count(*) TotalDeal, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotalFee
        FROM afetxnjnl
        WHERE CAgtNo  = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND TxnCod='%s'
      </Sentence>
      <Fields>CAgtNo|ClrDat|tmpTxnCod|</Fields>
    </DynSentence>   
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <!--Set>TxnDat=CALCDATE($ActDat,-,d,1)</Set-->

      <Set>Flag=|</Set>
      <Set>TxnKnd= </Set>
      <Set>OTlogNo= </Set>
      <Set>DLDat1= </Set>
      <Set>DLTim1= </Set>
      
      
      
      
      <Set>LclDir=dat/efea</Set>
      
      <!--01 实时划帐文件-->
      <!--02 银行现金文件-->
      <!--03 银行柜台支票文件--><!-- 03支票交易经供电局确认跟02现金进行合并 -->

      <Set>FilTyp=01</Set>
      <While condition="INTCMP($FilTyp,2,2)">
    	  <Exec func="PUB:GetLogNo"/>
        <Set>LclFil=STRCAT(SUBSTR($DptTyp,1,2),$FilTyp,_,$ClrDat,_,315810,_001,.bil)</Set> 
 
        <If condition="IS_EQUAL_STRING($FilTyp,01)">
        	<Set>tmpTxnCod=460230</Set>
          <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc"  value="OPFCSW"/>
            <Arg name="SourNam" value="DptTyp"/>
            <Arg name="DestNam" value="CAgtNo"/>
            <Arg name="TblNam"  value="DptTypToCAgtNo_DL"/>
          </Exec>
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="TotalDeal_DL"/>
          </Exec>         
          <If condition="INTCMP($TotalDeal,3,0)">
          	<Set>FilTyp=ADDCHAR(ADD($FilTyp,1),2,0,1)</Set>	
          	<Continue/>
          </If>         
          <Exec func="PUB:ExportFromDB">    <!--产生上送供电方的文件-->
            <Arg name="SqlName" value="GetTxnJnl_DL"/>
            <Arg name="FormatName" value="EFEA_DZ"/>
            <Arg name="FileName" value="STRCAT($LclDir,/,$LclFil)"/>
            <Arg name="TableName" value="afetxnjnl"/>
          </Exec>
        </If>
        <Else>
        	<Set>tmpTxncod=460245</Set>
          <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc"  value="OPFCSW"/>
            <Arg name="SourNam" value="DptTyp"/>
            <Arg name="DestNam" value="CAgtNo"/>
            <Arg name="TblNam"  value="DptTypToCAgtNo_YH"/>
          </Exec>
          <!--If condition="IS_EQUAL_STRING($FilTyp,02)">
          	<Set>PayTyp=10</Set>
          </If>
          <Else>
            <Set>PayTyp=12</Set>
          </Else-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="TotalDeal_YH"/>
          </Exec>         
          <If condition="INTCMP($TotalDeal,3,0)">
          	<Set>FilTyp=ADDCHAR(ADD($FilTyp,1),2,0,1)</Set>	
          	<Continue/>
          </If>         
          <Exec func="PUB:ExportFromDB">    <!--产生上送供电方的文件-->
            <Arg name="SqlName" value="GetTxnJnl_YH"/>
            <Arg name="FormatName" value="EFEA_DZ"/>
            <Arg name="FileName" value="STRCAT($LclDir,/,$LclFil)"/>
            <Arg name="TableName" value="afetxnjnl"/>
          </Exec>
        </Else>
        

        <!--test-->
        <Exec func="PUB:FtpPut">
          <Arg name="FtpId" value="EFE_SND_441"/>
        </Exec>	
        <!---->
        <Set>FilTyp=ADDCHAR(ADD($FilTyp,1),2,0,1)</Set>			  		       
      </While>
      
      <Set>MsgInf1=STRCAT(向供电方发送对账文件成功)</Set>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>         
    </FlowCtrl>
  </Transaction>
  
  <Transaction code="460251" desc="电力对公缴费记账回执打印">

		<FlowCtrl>      
      <!--If condition="INTCMP($EndDat,5,$ActDat)"> 
        <Set>RspCod=481599</Set>
        <Set>RspMsg=结束日期大于或者等于会计日期</Set>
        <Return/>
      </If-->

      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>

      <!--转换为转入账号-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptTyp"/>
        <Arg name="DestNam" value="IActNo"/>
        <Arg name="TblNam"  value="DL_IActNo"/>
      </Exec> 
       <!--转换为转入账号名称-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptTyp"/>
        <Arg name="DestNam" value="IActNm"/>
        <Arg name="TblNam"  value="DL_IActNm"/>
      </Exec>      


      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptTyp"/>
        <Arg name="DestNam" value="CAgtNo"/>
        <Arg name="TblNam"  value="DptTypToCAgtNo_DL"/>
      </Exec>
      <Set>CAgtNo_DL=$CAgtNo</Set>

      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptTyp"/>
        <Arg name="DestNam" value="CAgtNo"/>
        <Arg name="TblNam"  value="DptTypToCAgtNo_YH"/>
      </Exec>
      <Set>CAgtNo_YH=$CAgtNo</Set>
      
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptTyp"/>
        <Arg name="DestNam" value="CAgtNo"/>
        <Arg name="TblNam"  value="DptTypToCAgtNo_PL"/>
      </Exec>      
      <Set>CAgtNo_PL=$CAgtNo</Set>

      <Set>CAgtNo= </Set>
                          
      <Set>PrtId=$TlrId</Set>
      <Set>PrtDat=$ActDat</Set>
      
      <If condition="ISNULL(DELSPACE($TckNo,all))">
			  <Set>FilNam=STRCAT(电力对公缴费记账回执,$BgnDat,-,$EndDat,.rpt)</Set>
			  <Set>FmtFil=etc/EFE02_RPT.XML</Set><!--根据单位编号取得相应的清单格式名称-->
			  <Exec func="PUB:GenerateReport">
			  	<Arg name="ObjFil" value="STRCAT(dat/term/send/,$FilNam)"/>
			  	<Arg name="FmtFil" value="$FmtFil"/>
			  	<Arg name="Para1"  value="$CAgtNo_DL"/>
			  	<Arg name="Para2"  value="$CAgtNo_YH"/>
			  	<Arg name="Para3"  value="$CAgtNo_PL"/>
			  	<Arg name="Para4"  value="$BgnDat"/>
			  	<Arg name="Para5"  value="$EndDat"/>
          <Arg name="Para6"  value="$NodNo"/>
          <Arg name="Para7"  value="$PrtId"/>
          <Arg name="Para8"  value="$PrtDat"/>
          <Arg name="Para9"  value="$IActNo"/>
          <Arg name="Para10" value="$IActNm"/>
			  </Exec>
			  <Exec func="PUB:SendFileMessage2"><!--发出文件打印指令-->
			  	<Arg name="MsgTyp" value="4"/><!-- 消息类型，1通知2广播3文件4打印，一般传文件时用3，需要在前置打印时用4-->
			  	<Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
			  	<Arg name="BusTyp" value="46"/><!-- 业务类型-->
			  	<Arg name="AplCod" value="0251"/><!-- 应用码-->
			  	<Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
			  	<Arg name="Summary" value="电力对公缴费记账回执"/><!-- 消息内容-->
			  	<Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
			  	<Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
			  	<Arg name="SrcTlr" value="Billlp2"/><!-- 消息来源柜员-->
			  </Exec>
      </If>
      <Else>
			  <Set>FilNam=STRCAT(电力对公缴费记账回执,$BgnDat,-,$EndDat,.rpt)</Set>
			  <Set>FmtFil=etc/EFE03_RPT.XML</Set><!--根据单位编号取得相应的清单格式名称-->
			  <Exec func="PUB:GenerateReport">
			  	<Arg name="ObjFil" value="STRCAT(dat/term/send/,$FilNam)"/>
			  	<Arg name="FmtFil" value="$FmtFil"/>
			  	<Arg name="Para1"  value="$CAgtNo_DL"/>
			  	<Arg name="Para2"  value="$CAgtNo_YH"/>
			  	<Arg name="Para3"  value="$CAgtNo_PL"/>
			  	<Arg name="Para4"  value="$BgnDat"/>
			  	<Arg name="Para5"  value="$EndDat"/>
          <Arg name="Para6"  value="$NodNo"/>
          <Arg name="Para7"  value="$PrtId"/>
          <Arg name="Para8"  value="$PrtDat"/>
          <Arg name="Para9"  value="$IActNo"/>
          <Arg name="Para10" value="$IActNm"/>
			  </Exec>
			  <Exec func="PUB:SendFileMessage2"><!--发出文件打印指令-->
			  	<Arg name="MsgTyp" value="4"/><!-- 消息类型，1通知2广播3文件4打印，一般传文件时用3，需要在前置打印时用4-->
			  	<Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
			  	<Arg name="BusTyp" value="46"/><!-- 业务类型-->
			  	<Arg name="AplCod" value="0251"/><!-- 应用码-->
			  	<Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
			  	<Arg name="Summary" value="电力对公缴费记账回执"/><!-- 消息内容-->
			  	<Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
			  	<Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
			  	<Arg name="SrcTlr" value="Billlp2"/><!-- 消息来源柜员-->
			  </Exec>
      </Else>

		</FlowCtrl>
	</Transaction>



  <Transaction code="460252" desc="供电局财务对帐文件生成交易">
    <!--生成文件  只统计主机成功状态的-->
    <DynSentence name="GetTxnJnl">
      <Sentence>
        SELECT ActDat,TxnCod,TxnAmt,OrgNo,TlrId
        FROM afetxnjnl
        WHERE CAgtNo in ('%s','%s','%s')
        AND ActDat='%s' AND HTxnSt='S'
      </Sentence>
      <Fields>CAgtNo_DL|CAgtNo_YH|CAgtNo_PL|ClrDat|tmpTxnCod|</Fields>
    </DynSentence>
    <!--生成文件 总笔数 只统计主机成功状态的-->
    <DynSentence name="TotalDeal">
      <Sentence>
        SELECT Count(*) TotalDeal, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotalFee
        FROM afetxnjnl
        WHERE CAgtNo  in ('%s','%s','%s')
        AND ActDat='%s' AND HTxnSt='S' 
      </Sentence>
      <Fields>CAgtNo_DL|CAgtNo_YH|CAgtNo_PL|ClrDat|tmpTxnCod|</Fields>
    </DynSentence>
    
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <!--Set>TxnDat=CALCDATE($ActDat,-,d,1)</Set-->

      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptTyp"/>
        <Arg name="DestNam" value="CAgtNo"/>
        <Arg name="TblNam"  value="DptTypToCAgtNo_DL"/>
      </Exec>
      <Set>CAgtNo_DL=$CAgtNo</Set>

      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptTyp"/>
        <Arg name="DestNam" value="CAgtNo"/>
        <Arg name="TblNam"  value="DptTypToCAgtNo_YH"/>
      </Exec>
      <Set>CAgtNo_YH=$CAgtNo</Set>
      
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptTyp"/>
        <Arg name="DestNam" value="CAgtNo"/>
        <Arg name="TblNam"  value="DptTypToCAgtNo_PL"/>
      </Exec>      
      <Set>CAgtNo_PL=$CAgtNo</Set>
      <Set>CAgtNo= </Set>

      <Set>Flag= </Set>               
      <Set>CWTxnCod= </Set>
      <Set>Summary= </Set>
      <Set>VchTyp= </Set>
      <Set>VchNo= </Set>
      <Set>CDFlag= </Set>

      <Exec func="PUB:GetLogNo"/>
      <Set>LclFil=STRCAT(gzdl,_,$ClrDat)</Set> 
                     
      <Exec func="PUB:ExportFromDB">    <!--产生上送供电方的文件-->
        <Arg name="SqlName" value="GetTxnJnl"/>
        <Arg name="FormatName" value="EFEA_CAIWU"/>
        <Arg name="FileName" value="STRCAT($LclDir,/,$LclFil)"/>
        <Arg name="TableName" value="afetxnjnl"/>
      </Exec>
      <!--test
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="EFE_SND_441"/>
      </Exec>	
      -->

      
      <Set>MsgInf1=STRCAT(向供电方发送对账文件成功)</Set>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>         
    </FlowCtrl>
  </Transaction>





  <Transaction code="460260" desc="广州电力电费清算报表打印">
    <DynSentence name="QryJnlInfo">            <!--查询天讯、彩票、保险成功流水信息 -->
      <Sentence>
        SELECT LogNo FROM afetxnjnl WHERE BrNo='%s' AND CAgtNo='%s' AND TActDt='%s' and HTxnSt IN ('S','T','U') order by LogNo asc
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="QryJnlInfo2">           <!--查询天讯、彩票、保险可疑流水信息 -->
      <Sentence>
        SELECT LogNo FROM afetxnjnl WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and HTxnSt='T' order by LogNo asc
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="QryJnlInfo1">            <!--查询车船税未对帐流水信息 -->
      <Sentence>
        SELECT Count(*) cnt FROM afetxnjnl WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and HTxnSt IN ('S','T','U') and HRspcd='SC0000' and TTxnst  IN ('S','T') and ChkFlg='0'
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="CCSupdatesucess">            <!--更新车船税第三方交易成功状态 -->
      <Sentence>
        UPDATE afetxnjnl SET TTxnst='S' WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and ThdChk='1'
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="CCSupdatefail">            <!--更新车船税第三方交易失败状态 -->
      <Sentence>
        UPDATE afetxnjnl SET TTxnst='F',ThdChk='1' WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and ThdChk='0'
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="CCSsum">            <!--车船税交易失败记录数 -->
      <Sentence>
        select count(*) as sumcnt from afetxnjnl WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and ThdChk='0'
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="YCTtk">
      <Sentence>
        select logno from afetxnjnl where CAgtNo='%s' AND ActDat='%s' and ChkFlg='0' and TTXNCD='482155'
      </Sentence>
      <Fields>CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="YCTtkquery">
      <Sentence>
        select ActNo,TxnAmt,TCusNm,NodTrc,THDKEY,RsFld3,ActDat,TCUSID from afetxnjnl where CAgtNo='%s' AND ActDat='%s' and logno='%s'
      </Sentence>
      <Fields>CAgtNo|TxnDat|logno|</Fields>
    </DynSentence>
    <DynSentence name="Updatquery">
      <Sentence>
        update afetxnjnl set ChkFlg='1' where CAgtNo='%s' AND ActDat='%s' and logno='%s'
      </Sentence>
      <Fields>CAgtNo|TxnDat|logno|</Fields>
    </DynSentence>
    <DynSentence name="YTKinsert"><!--粤通卡报表-->
      <Sentence>
      insert into ytk_yct (select FTxnTm,ActDat,CAgtNo,ActNo,TCUSID,LogNo,TckNo,RsFld1,RSFLD2,TxnAmt,RsFld3,ThdChk,
      case when ThdChk='S' then 'A' else 'B' end from afetxnjnl where ActDat ='%s' and CAgtNo='%s' and HTxnSt='S' and
      ThdChk IN ('G','F','D','E','Y','S') and HRspcd='SC0000')
      </Sentence>
      <Fields>TxnDat|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="YCTinsert"><!--羊城通月卡报表-->
      <Sentence>
      insert into ytk_yct (select FTxnTm,ActDat,CAgtNo,ActNo,TCUSID,LogNo,TckNo,' ',' ',TxnAmt,' ',ThdChk,
      case when ThdChk='Y' then 'A' else 'B' end from afetxnjnl where ActDat ='%s' and CAgtNo='%s' and HTxnSt='S' and
      ThdChk IN ('Y','B') and HRspcd='SC0000')
      </Sentence>
      <Fields>TxnDat|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="YTK_YCTdelete"><!--粤通卡羊城通月卡报表-->
      <Sentence>
       delete from ytk_yct where CAgtNo='%s'
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>


    <If condition="AND(IS_NOEQUAL_STRING($CAgtNo,4410000971),IS_NOEQUAL_STRING($CAgtNo,4410000960),IS_NOEQUAL_STRING($CAgtNo,4410000971))">            <!--彩票/车船税业务除外-->
      <Exec func="PUB:ReadRecord">  <!--查询 -->
        <Arg name="SqlCmd" value="QryJnlInfo"/>
      </Exec>
    </If>
     <Switch expression="~RetCod">
         <Case value="-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=360002</Set>
            <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
            <Return/>
         </Case>
         <Case value="0">
            <Break/>
         </Case>
       <Default>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=360002</Set>
            <Set>RspMsg=数据不存在</Set>
            <Return/>
         </Default>
    </Switch>

      <!--
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=360001</Set>
           <Set>RspMsg=本网点无权打印该报表！</Set>
           <Return/>
      </If>
      -->
    <If condition="$PrtFlg=1">

    <!--Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QryJnlInfo2"/>
    </Exec>
     <Switch expression="~RetCod">
        <Case value="0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=360002</Set>
            <Set>RspMsg=有可疑数据,请先打印可疑报表</Set>
            <Return/>
          </Case>
          <Case value="-2">
            <Break/>
          </Case>
       <Default>
            <Break/>
         </Default>
    </Switch-->
      <!--成功报表-->
      <Set>FmtFil=etc/EFE_RPT_CFG.XML</Set>
      <Set>FilNam=STRCAT(EFE,$BrNo,$TxnDat,GETDATETIME(HHMISS))</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="BrNo"   value="$BrNo"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat" value="$TxnDat"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
    </If>
    <ElseIf condition="$PrtFlg=2">
      <!--车船税和银旅通无可疑报表-->
      <If condition="OR(IS_EQUAL_STRING($CAgtNo,4410000755),IS_EQUAL_STRING($CAgtNo,4410000960))">
          <Set>MsgTyp=E</Set>
           <Set>RspCod=470728</Set>
           <Set>RspMsg=无此交易</Set>
           <Return/>
      </If>
      <!--天讯可疑报表-->
      <Set>FmtFil=etc/LSHA5_RPT_441999.XML</Set>
      <Set>FilNam=STRCAT(LSHA05,$TxnDat,GETDATETIME(HHMISS))</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat" value="$TxnDat"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
    </ElseIf>
    <!--车船税失败报表-->
    <ElseIf condition="$PrtFlg=3">
      <Set>FmtFil=etc/LSHA10_RPT_441999.XML</Set>
      <Set>FilNam=STRCAT(LSHA10_,$TxnDat,GETDATETIME(HHMISS))</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat" value="$TxnDat"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
    </ElseIf>
    <!--退款报表-->
    <ElseIf condition="$PrtFlg=4">
      <If condition="IS_EQUAL_STRING($CAgtNo,4410001101)">       <!--粤通卡退款报表-->
        <Set>FmtFil=etc/LSHJ02_RPT_441999.XML</Set>
        <Set>FilNam=STRCAT(LSHJ02_,$TxnDat,GETDATETIME(HHMISS))</Set>
        <Exec func="EXT:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="CAgtNo" value="$CAgtNo"/>
          <Arg name="TxnDat" value="$TxnDat"/>
          <Arg name="PNodNo"  value="$NodNo"/>
          <Arg name="PTlrId"  value="$TlrId"/>
        </Exec>
        <Exec func="PUB:SendFileMessage">
          <Arg name="MsgTyp"  value="4"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="48"/>
          <Arg name="AplCod"  value="482150"/>
          <Arg name="FilNam"  value="$FilNam"/>
          <Arg name="Summary" value="$Summary"/>
          <Arg name="ObjTlr"  value="$TlrId"/>
        </Exec>
      </If>
      <ElseIf condition="IS_EQUAL_STRING($CAgtNo,4410001105)">       <!--月票卡退款报表-->
        <Set>FmtFil=etc/SPC102_RPT_441999.XML</Set>
        <Set>FilNam=STRCAT(SPC102_,$TxnDat,GETDATETIME(HHMISS))</Set>
        <Exec func="EXT:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="CAgtNo" value="$CAgtNo"/>
          <Arg name="TxnDat" value="$TxnDat"/>
          <Arg name="PNodNo"  value="$NodNo"/>
          <Arg name="PTlrId"  value="$TlrId"/>
        </Exec>
        <Exec func="PUB:SendFileMessage">
          <Arg name="MsgTyp"  value="4"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="48"/>
          <Arg name="AplCod"  value="482150"/>
          <Arg name="FilNam"  value="$FilNam"/>
          <Arg name="Summary" value="$Summary"/>
          <Arg name="ObjTlr"  value="$TlrId"/>
       </Exec>
      </ElseIf>
    </ElseIf>
    <Else>
    </Else>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>

  <Transaction code="460261" desc="广州电力电费清算">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Updafetxnjnl"><!--修改信息-->
      <Sentence>
        update afetxnjnl set ChkFlg='1' WHERE CAgtNo='%s' and TActDt ='%s' and HTxnSt='S'
      </Sentence>
      <Fields>CAgtNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="QryClrSts">    <!--检查清算状态 -->
      <Sentence>
         select ClrSts,AutFlg from  efeaclrtbl where BrNo='%s' 
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdClrSts">    <!--修改清算状态 -->
      <Sentence>
         update efeaclrtbl set ClrDat='%s',ClrSts='%s' where BrNo='%s' 
      </Sentence>
      <Fields>ClrDat|ClrSts|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="QryClrCnt">    <!--查询当天有没清算 -->
      <Sentence>
         select count(*) ClrCnt from  efeaclrdtl where BrNo='%s' and CAgtNo='%s' and ClrDat='%s'
      </Sentence>
      <Fields>BrNo|CAgtNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="QryClrDtl">    <!--查询清算情况 -->
      <Sentence>
         select ClrRst from efeaclrdtl where BrNo='%s' and CAgtNo='%s' and ClrDat='%s'
      </Sentence>
      <Fields>BrNo|CAgtNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="InsClrDtl">    <!--插入清算明细 -->
      <Sentence>
         insert into efeaclrdtl values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s') 
      </Sentence>
      <Fields>BrNo|NodNo|TlrId|CAgtNo|ClrDat|ClrTim|ClrRst|ClrTyp|ClrTot|ClrAmt|</Fields>
    </DynSentence>
    <DynSentence name="UpdClrDtl">    <!--修改清算记录 -->
      <Sentence>
         update efeaclrDtl set ClrRst='%s',ClrTyp='%s',ClrTot='%s',ClrAmt='%s' where BrNo='%s' and CAgtNo='%s' 
      </Sentence>
      <Fields>ClrRst|ClrTyp|ClrTot|ClrAmt|BrNo|CAgtNo|</Fields>
    </DynSentence>    

    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>



     <Exec func="PUB:AddAuthReason" >
         <Arg name="AthCod" value="40" />
         <Arg name="AthMsg" value="EFE000" />
     </Exec>
     <Exec  func="PUB:CheckLocalAuth" >
         <Arg name="ObjSvr" value="SHSTPUB1" />
     </Exec>

      <Exec func="PUB:ReadRecord">    <!--检查清算状态 -->
        <Arg name="SqlCmd" value="QryClrSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=不存在清算日期参数</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($ClrSts,1)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=非清算状态</Set>
        <Return/>
      </If>

     <Exec func="PUB:ReadRecord">    <!--查询当天有没清算 -->
       <Arg name="SqlCmd" value="QryClrCnt"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=EFE999</Set>
       <Set>RspMsg=查询当天是否清算失败</Set>
       <Return/>
     </If>
     <If condition="IS_NOEQUAL_STRING($ClrCnt,0)">
     	<!--当天有清算记录-->
       <Exec func="PUB:ReadRecord"  error="IGNORE">
         <Arg name="SqlCmd" value="QryClrDtl"/>
       </Exec>
       <If condition="~RetCod=-1">
         <Set>RspCod=EFE999</Set>
         <Set>RspMsg=查询当天清算情况失败</Set>
         <Return/>
       </If>
       <If condition="IS_EQUAL_STRING($ClrRst,1)">
       	<!--该协议单位已清算-->
         <Set>RspCod=EFE999</Set>
         <Set>RspMsg=该协议单位已清算</Set>
         <Return/>
       </If>
     </If> 
     <Else><!--当天清算记录为空-->
       <Set>ClrTim=GETDATETIME(HHMI)</Set> <!--清算时间-->
       <Set>ClrRst=0</Set> <!--清算情况  0:未清算；1:已清算-->
       <Set>ClrTyp=1</Set> <!--清算类型  0:自动清算；1:手工清算-->
       <Set>ClrTot=0</Set> <!--清算笔数-->
       <Set>ClrAmt=0</Set> <!--清算金额-->
       <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="InsClrDtl"/>
       </Exec>
       <If condition="~RetCod!=0">
         <Set>RspCod=EFE999</Set>
         <Set>RspMsg=插入清算明细记录失败</Set>
         <Return/>
       </If>
     </Else>

     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>

      <Set>HTxnCd=451900</Set>
      <Set>CrpCod=EFEA99999999</Set>
      <Set>BusTyp=PCL76</Set>
      <Set>RgCFlg=1</Set>   <!--贷方回单，不登记0，登记 1 -->
      <Set>ActBk1=441999</Set>
      <Set>ActBr1=441800</Set>
      <Set>ActSq1=SUBSTR($TActNo,14,5)</Set>
      <Set>CdFlg1=D</Set>
      <Set>OuAmt1=$TxnAmt</Set>
      <Set>PayAt5=$STLACT</Set>
      <Set>CdFlg5=C</Set>
      <Set>InAmt5=$TxnAmt</Set>

      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="$HTxnCd"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="~RetCod!=0">
       <Set>RspCod=EFE999</Set>
       <Set>RspMsg=上主机清算失败</Set>
       <Return/>      	
      </If>

      <Exec func="PUB:ExecSql">
        <Arg name="SqlCmd" value="Updafetxnjnl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=修改交易明细为已清算失败</Set>
        <Return/>
      </If>  

      <Set>ClrRst=1</Set> <!--清算情况:1已清算-->
      <Set>ClrTyp=1</Set> <!--清算类型:1手工清算-->
      <Set>ClrTot=$TotCnt</Set> <!--清算笔数-->
      <Set>ClrAmt=$TxnAmt</Set> <!--清算金额-->
      <Exec func="PUB:ExecSql">
        <Arg name="SqlCmd" value="UpdClrDtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=修改清算明细记录失败</Set>
        <Return/>
      </If> 

      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>

  <Transaction code="460262" desc="广东电力电费对可疑交易进行状态修改">
    <DynSentence name="Updafetxnjnl"><!--修改信息-->
      <Sentence>
        update afetxnjnl set HTxnSt='%s' WHERE ActDat ='%s' and CAgtNo='%s' and HTxnSt IN ('T','U') and TckNo='%s'
      </Sentence>
      <Fields>HTxnSt|TxnDat|CAgtNo|TckNo|</Fields>
    </DynSentence>
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>
    <!--
    <Exec func="PUB:AddAuthReason" >
            <Arg name="AthCod" value="50" />
            <Arg name="AthMsg" value="482152" />
    </Exec>
    <Exec  func="PUB:CheckLocalAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1" />
    </Exec>
    -->
    <If condition="$HTxnSt=S">
        <Set>HtNam=成功</Set>
    </If>
    <Else>
       <Set>HtNam=失败</Set>
    </Else>

    <Exec func="PUB:ExecSql">
       <Arg name="SqlCmd" value="Updafetxnjnl"/>
    </Exec>


    </FlowCtrl>
  </Transaction>

  <Transaction code="460263" desc="广东电力电费对可疑交易进行状态查询">
    <DynSentence name="QryCrpAgr"><!--查询信息-->
      <Sentence>
        select ActNo,TCUSNM,TCUSID,TxnAmt from afetxnjnl WHERE ActDat ='%s' and CAgtNo='%s'  and TckNo='%s' and HTxnSt IN ('T','U') and ChkFlg='0'
      </Sentence>
      <Fields>TxnDat|CAgtNo|TckNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>
    <Exec func="PUB:InitTransaction"/>            <!--交易初始化,预留-->
    <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryCrpAgr"/>
    </Exec>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460264" desc="广东省电力电费查询清算金额">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryEfeTot">
      <Sentence>
        select sum(cast(TxnAmt as bigint)) as SumAmt,coalesce(COUNT(*),0) TotCnt from afetxnjnl
        where CAgtNo= '%s' and TActDt = '%s' and HTxnSt='S' and ChkFlg='0'
      </Sentence>
      <Fields>CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>

     <Exec func="PUB:ReadRecord">     <!--广东电力电费业务清算-->
       <Arg name="SqlCmd" value="QryEfeTot"/>
     </Exec>
     <If condition="$TotCnt=0">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=331012</Set>
         <Set>RspMsg=没有清算数据</Set>
         <Return/>
     </If>
    </FlowCtrl>
  </Transaction>

  <Transaction code="460265" desc="广州电力电费清算汇总清单">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="TotalDeal">
      <Sentence>
        SELECT Count(*) TotalDeal, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotalFee
        FROM afetxnjnl
        WHERE CAgtNo  = '%s'
        AND TActDt='%s' AND HTxnSt='S' AND ChkFlg='1'
      </Sentence>
      <Fields>CAgtNo|OActDt|</Fields>
    </DynSentence>
    <DynSentence name="QryClrSts">    <!--检查清算状态 -->
      <Sentence>
         select ClrDat,ClrTim,ClrSts,AutFlg from  efeaclrtbl where BrNo='%s' 
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
        
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <Exec func="PUB:GetAppInfo"/>    	
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <Exec func="PUB:IsExistNode" error="IGNORE">
        <Arg name="FieldName" value="ClrDat"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,1)">  <!--手工发起标志-->
        <Set>OActDt=$ClrDat</Set> 
      </If>
      <Else>                                <!--自动发起标志-->
        <Exec func="PUB:ReadRecord">        <!--查询清算日期 -->
          <Arg name="SqlCmd" value="QryClrSts"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=不存在清算日期参数</Set>
          <Return/>
        </If>        
        <Set>DptTyp=$ROOT.TBANK</Set>        
        <Set>OActDt=$ClrDat</Set> 
      </Else>
      

      <Set>RcsNo=315810</Set>
      <Set>DatFil=STRCAT(dat/efea/,jh,_,$RcsNo,_,$OActDt,.txt)</Set>
      <Set>DatFilNam=STRCAT(jh,_,$RcsNo,_,$OActDt,.txt)</Set>

      <Exec func="PUB:WriteFile" error="IGNORE">
        <Arg name="FileName" value="$DatFil"/>
        <Arg name="OpenMode" value="w"/>
        <Arg name="Data"     value="                   交通银行代收电费单位汇总入账清单 "/>
        <Arg name="ESCFMT"   value="\\n"/>
        <Arg name="Data"     value="        户名           账号             金额              摘要"/>
        <Arg name="ESCFMT"   value="\\n"/>
      </Exec>

      <Set>Num=01</Set>
      <While condition="INTCMP($Num,2,3)">
        <If condition="IS_EQUAL_STRING($Num,01)"> 
          <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc"  value="OPFCSW"/>
            <Arg name="SourNam" value="DptTyp"/>
            <Arg name="DestNam" value="CAgtNo"/>
            <Arg name="TblNam"  value="DptTypToCAgtNo_DL"/>
          </Exec>
          <Set>Smr=实扣缴费</Set>        	
        </If>
        <ElseIf condition="IS_EQUAL_STRING($Num,02)">
          <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc"  value="OPFCSW"/>
            <Arg name="SourNam" value="DptTyp"/>
            <Arg name="DestNam" value="CAgtNo"/>
            <Arg name="TblNam"  value="DptTypToCAgtNo_YH"/>
          </Exec>
          <Set>Smr=银行柜台缴费</Set> 
        </ElseIf>
        <ElseIf condition="IS_EQUAL_STRING($Num,03)">
          <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc"  value="OPFCSW"/>
            <Arg name="SourNam" value="DptTyp"/>
            <Arg name="DestNam" value="CAgtNo"/>
            <Arg name="TblNam"  value="DptTypToCAgtNo_PL"/>
          </Exec>
          <Set>Smr=批量缴费</Set> 
        </ElseIf>
        
        <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
          <Arg name="SqlCmd" value="QryCrpAgr"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=单位协议不存在</Set>
          <Return/>
        </If>
                
        <Exec func="PUB:ReadRecord">
          <Arg name="SqlCmd" value="TotalDeal"/>
        </Exec>         

        <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$DatFil"/>
          <Arg name="OpenMode" value="a+"/>
          <Arg name="Data"     value="SPACE(20)"/>
          <Arg name="Data"     value="$STLACT"/>
          <Arg name="Data"     value="ADDCHAR (AMTSIMPLEFMT($TotalFee),15, ,1)"/>
          <Arg name="Data"     value="SPACE(10)"/>
          <Arg name="Data"     value="ADDCHAR($Smr,20, ,0)"/>
          <Arg name="ESCFMT"   value="\\n"/>
        </Exec>
        
        <Set>NUM=ADDCHAR(ADD($NUM,1),2,0,1)</Set>	   	
      </While>

      <!--test
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="EFEA_Total_441"/>
      </Exec>	
      -->
          	
    </FlowCtrl>
  </Transaction>


  <Transaction code="460266" desc="广州电力电费系统定时机制自动清算">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Updafetxnjnl"><!--修改信息-->
      <Sentence>
        update afetxnjnl set ChkFlg='1' WHERE  CAgtNo='%s' and TActDt ='%s' and HTxnSt='S' and ChkFlg='0'
      </Sentence>
      <Fields>CAgtNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="TotalDeal">
      <Sentence>
        SELECT Count(*) ClrTot, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) ClrAmt
        FROM afetxnjnl
        WHERE CAgtNo  = '%s'
        AND TActDt='%s' AND HTxnSt='S' AND ChkFlg='0'
      </Sentence>
      <Fields>CAgtNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="QryClrSts">    <!--检查清算状态 -->
      <Sentence>
         select ClrDat,ClrTim,ClrSts,AutFlg from  efeaclrtbl where BrNo='%s' 
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdClrSts">    <!--修改清算状态 -->
      <Sentence>
         update efeaclrtbl set ClrDat='%s',ClrSts='%s' where BrNo='%s' 
      </Sentence>
      <Fields>ClrDat|ClrSts|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="QryClrCnt">    <!--查询当天有没清算 -->
      <Sentence>
         select count(*) ClrCnt from  efeaclrdtl where BrNo='%s' and CAgtNo='%s' and ClrDat='%s'
      </Sentence>
      <Fields>BrNo|CAgtNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="QryClrDtl">    <!--查询清算情况 -->
      <Sentence>
         select ClrRst from  efeaclrdtl where BrNo='%s' and CAgtNo='%s' and ClrDat='%s'
      </Sentence>
      <Fields>BrNo|CAgtNo|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="InsClrDtl">    <!--插入清算明细 -->
      <Sentence>
         insert into efeaclrdtl values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s') 
      </Sentence>
      <Fields>BrNo|NodNo|TlrId|CAgtNo|ClrDat|ClrTim|ClrRst|ClrTyp|ClrTot|ClrAmt|</Fields>
    </DynSentence>
    <DynSentence name="UpdClrDtl">    <!--修改清算记录 -->
      <Sentence>
         update efeaclrDtl set ClrRst='%s',ClrTyp='%s',ClrTot='%s',ClrAmt='%s' where BrNo='%s' and CAgtNo='%s' 
      </Sentence>
      <Fields>ClrRst|ClrTyp|ClrTot|ClrAmt|BrNo|CAgtNo|</Fields>
    </DynSentence>          
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <Exec func="PUB:GetAppInfo"/>    	
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>


      <Exec func="PUB:ReadRecord">    <!--检查自动清算标志 -->
        <Arg name="SqlCmd" value="QryClrSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=不存在清算日期参数</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($AutFlg,0)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=人为禁止自动清算</Set>
        <Return/>
      </If>

      <Set>ClrDT=STRCAT($ClrDat,$ClrTim)</Set>  <!--设置的清算时点YYYYMMDDHHMI-->
      <Set>SysDT=GETDATETIME(YYYYMMDDHHMI)</Set> <!--系统的时点YYYYMMDDHHMI-->
      <Set>SysDT=$ClrDT</Set>  <!--测试使用-->

      <If condition="IS_NOEQUAL_STRING($ClrDT,$SysDT)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=非清算时间</Set>
        <Return/>
      </If>      

      <Set>ClrSts=1</Set> <!--设置成清算状态-->
      <Exec func="PUB:ExecSql">
         <Arg name="SqlCmd" value="UpdClrSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=修改为清算状态失败</Set>
        <Return/>
      </If>

      <Exec func="PUB:GetVirtualTeller">
        <Arg name="TxnCnl" value="EFE"/>
      </Exec>

      <Set>DptTyp=$ROOT.TBANK</Set>

      <Set>Num=01</Set>
      <While condition="INTCMP($Num,2,3)">
        <If condition="IS_EQUAL_STRING($Num,01)"> 
          <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc"  value="OPFCSW"/>
            <Arg name="SourNam" value="DptTyp"/>
            <Arg name="DestNam" value="CAgtNo"/>
            <Arg name="TblNam"  value="DptTypToCAgtNo_DL"/>
          </Exec>
          <Set>Smr=实扣缴费</Set>        	
        </If>
        <ElseIf condition="IS_EQUAL_STRING($Num,02)">
          <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc"  value="OPFCSW"/>
            <Arg name="SourNam" value="DptTyp"/>
            <Arg name="DestNam" value="CAgtNo"/>
            <Arg name="TblNam"  value="DptTypToCAgtNo_YH"/>
          </Exec>
          <Set>Smr=银行柜台缴费</Set> 
        </ElseIf>
        <ElseIf condition="IS_EQUAL_STRING($Num,03)">
          <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc"  value="OPFCSW"/>
            <Arg name="SourNam" value="DptTyp"/>
            <Arg name="DestNam" value="CAgtNo"/>
            <Arg name="TblNam"  value="DptTypToCAgtNo_PL"/>
          </Exec>
          <Set>Smr=批量缴费</Set> 
        </ElseIf>

        <Exec func="PUB:ReadRecord">    <!--查询当天有没清算 -->
          <Arg name="SqlCmd" value="QryClrCnt"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=查询当天是否清算失败</Set>
          <Return/>
        </If>
        <If condition="IS_NOEQUAL_STRING($ClrCnt,0)">
        	<!--当天有清算记录-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="QryClrDtl"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=查询当天清算情况失败</Set>
            <Return/>
          </If>
          <If condition="IS_EQUAL_STRING($ClrRst,1)">
          	<!--该协议单位已清算-->
          	<Set>NUM=ADDCHAR(ADD($NUM,1),2,0,1)</Set>	
          	<Continue/>
          </If>
        </If>              
        <Else> 
        	<!--没有清算记录，增加一条清算记录-->
          <Set>NodNo =441800</Set>
          <Set>ClrRst=0</Set> <!--清算情况  0:未清算；1:已清算-->
          <Set>ClrTyp=0</Set> <!--清算类型  0:自动清算；1:手工清算-->
          <Set>ClrTot=0</Set> <!--清算笔数-->
          <Set>ClrAmt=0</Set> <!--清算金额-->
          <Exec func="PUB:ExecSql">
             <Arg name="SqlCmd" value="InsClrDtl"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=插入清算明细记录失败</Set>
            <Return/>
          </If>
        </Else>
               
        <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
          <Arg name="SqlCmd" value="QryCrpAgr"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=单位协议不存在</Set>
          <Return/>
        </If>
                
        <Exec func="PUB:ReadRecord">   <!--计算总笔数和总金额-->
          <Arg name="SqlCmd" value="TotalDeal"/>
        </Exec>         

        <Set>ActNo=$TACTNO</Set>
        <Set>TTxnCd=460266</Set>
        
        <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机查询内部帐-->
          <Arg name="HTxnCd" value="098061"/>
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
        <If condition="~RetCod!=0"> 
          <!--上主机查询失败,做下一个协议单位号清算-->
          <Set>NUM=ADDCHAR(ADD($NUM,1),2,0,1)</Set>	
          <Continue/>
        </If>
        <Set>ClrAm2=COBOL_TO_NORMAL($ClrAmt,15)</Set>
        <If condition="INTCMP($ClrAm2,4,$Bal)">
        	<!--明细记录汇总金额和内部帐余额不等,做下一个协议单位号清算-->
          <Set>NUM=ADDCHAR(ADD($NUM,1),2,0,1)</Set>	
          <Continue/>        	
        </If>

        <If condition="INTCMP($ClrAmt,6,0)">  <!--清算金额大于0,才上主机清算-->
          <!--取前置流水号,由于每次上主机需要不同的流水号,因此在这里取-->
          <Exec func="PUB:GetLogNo"/>
          <Set>HTxnCd=451900</Set>
          <!--Set>TrmNo=4418003</Set-->
          <!--Set>LogNo=12033100020417</Set-->
          <!--Set>AthTbl=EFE000                                                      </Set-->
          <Set>BusTyp=PCL76</Set>
          <Set>RgCFlg=1</Set>   <!--贷方回单，不登记0，登记 1 -->
          <Set>ActBk1=441999</Set>
          <Set>ActBr1=441800</Set>
          <Set>ActSq1=SUBSTR($TActNo,14,5)</Set>
          <Set>CdFlg1=D</Set>
          <Set>OuAmt1=$ClrAmt</Set>
          <Set>PayAt5=$STLACT</Set>
          <Set>CdFlg5=C</Set>
          <Set>InAmt5=$ClrAmt</Set>        
          <Exec func="PUB:CallHostOther">
            <Arg name="HTxnCd" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>       
          <If condition="~RetCod!=0">
            <!--上主机清算失败,做下一个协议单位号清算-->
            <Set>NUM=ADDCHAR(ADD($NUM,1),2,0,1)</Set>	
            <Continue/>
          </If>
        </If>
  
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="Updafetxnjnl"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=修改交易明细为已清算失败</Set>
          <Return/>
        </If>        

        <Set>ClrTim=GETDATETIME(HHMI)</Set> <!--清算时间-->
        <Set>ClrRst=1</Set> <!--清算情况:1已清算-->
        <Set>ClrTyp=0</Set> <!--清算类型:0自动清算-->
        <Set>ClrTot=$ClrTot</Set> <!--清算笔数-->
        <Set>ClrAmt=$ClrAmt</Set> <!--清算金额-->        
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="UpdClrDtl"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=修改清算明细记录失败</Set>
          <Return/>
        </If> 
        
        <Set>NUM=ADDCHAR(ADD($NUM,1),2,0,1)</Set>	   	
      </While>

      <Set>ClrSts=0</Set> <!--设置成交易状态-->
      <Set>ClrDat=CALCDATE($ClrDat,+,d,1)</Set> <!--清算日期加1-->
      <Exec func="PUB:ExecSql">
        <Arg name="SqlCmd" value="UpdClrSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=修改清算状态失败</Set>
        <Return/>
      </If>          	
    </FlowCtrl>
  </Transaction>
  
  <Transaction code="460267" desc="广州电力清算参数查询和修改">
    <DynSentence name="QryClrSts">    <!--检查清算状态 -->
      <Sentence>
         select ClrDat,ClrTim,ClrSts,AutFlg from  efeaclrtbl where BrNo='%s' 
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdClrSts">    <!--修改清算参数 -->
      <Sentence>
         update efeaclrtbl set ClrDat='%s',ClrTim='%s',ClrSts='%s',AutFlg='%s' where BrNo='%s' 
      </Sentence>
      <Fields>ClrDat|ClrTim|ClrSts|AutFlg|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="InsClrLog">    <!--清算参数修改记录 -->
      <Sentence>
         insert into efeaclrlog values('%s','%s','%s','%s','%s','%s','%s','%s','%s')
      </Sentence>
      <Fields>BrNo|NodNo|ClrDat|ClrTim|ClrSts|AutFlg|TlrId|LogDat|LogTim|</Fields>
    </DynSentence>
  	<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <Exec func="PUB:GetAppInfo"/>    	
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>
      
      <If condition="IS_EQUAL_STRING($OprFlg,0)">
      	<!--查询清算参数-->
        <Exec func="PUB:ReadRecord">    <!--检查自动清算标志 -->
          <Arg name="SqlCmd" value="QryClrSts"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=不存在清算日期参数</Set>
          <Return/>
        </If>
      </If>
      <ElseIf condition="IS_EQUAL_STRING($OprFlg,1)">
      	<!--修改清算参数-->
        <Exec func="PUB:AddAuthReason" >
           <Arg name="AthCod" value="40" />
           <Arg name="AthMsg" value="EFE000" />
        </Exec>
        <Exec  func="PUB:CheckLocalAuth" >
           <Arg name="ObjSvr" value="SHSTPUB1" />
        </Exec>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="UpdClrSts"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=修改清算参数失败</Set>
          <Return/>
        </If> 
        <Set>LogDat=GETDATETIME(YYYYMMDD)</Set>
        <Set>LogTim=GETDATETIME(HHMISS)</Set>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="InsClrLog"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=插入清算参数日志记录失败</Set>
          <Return/>
        </If>                 
      </ElseIf>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>		
    </FlowCtrl>
  </Transaction>
  
  <Transaction code="460268" desc="广州电力清算情况查询">
 		<DynSentence name="MultiQuery">
			<Sentence>
				select NodNo,TlrId,CAgtNo,ClrDat,ClrTim,ClrRst,ClrTyp,ClrTot,ClrAmt from efeaclrdtl where ClrDat='%s' 
			</Sentence>
			<Fields>ClrDat|</Fields>
		</DynSentence>
  	<FlowCtrl>
  		<Exec func="PUB:InitTransaction"/>
			<Exec func="PUB:MultiQuery" >
				<Arg name="SqlCmd" value="MultiQuery" />
			</Exec>
    </FlowCtrl>
  </Transaction>  
</Application>
