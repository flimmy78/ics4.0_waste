<?xml version='1.0' encoding='ISO-8859-1'?>
<FrontTab>
	<Macro name="PfaSqlLst" desc="宏清单">
<!--系统控制表【PfaSubCfg】操作-->
<!--系统控制表【PfaSubCfg】操作-->
<!--系统控制表【PfaSubCfg】操作-->
		<DynSentence name="SubCfgCtlPar" desc="根据财政代码取额额度控制参数">
			<Sentence>
				select FldNm1,FldNm2,FldNm3,FldNm4,FldNm5,FldNm6,FldNm7,FldNm8,FldNm9 from PfaSubCfg where PfaSub='%s'
			</Sentence>
			<Fields>PfaSub|</Fields>
		</DynSentence>
		<DynSentence name="SubCfgRunPar" desc="根据财政代码取系统运行参数">
			<Sentence>
				select PfaKnd, PreDat, ClrNod, RActSq, OpnSts, BokFlg, RtnFlg, AgtNod, BrNo AgtBr, RtnSeq, ClrAct, ClrNam,
							 RcvAct, RcvNam, PmsSeq, SOpnBk, RBkNo, RbkNm
					from PfaSubCfg where PfaSub='%s'
			</Sentence>
			<Fields>PfaSub|</Fields>
		</DynSentence>
<!--额度余额表【PfaQuoBal】操作-->
<!--额度余额表【PfaQuoBal】操作-->
<!--额度余额表【PfaQuoBal】操作-->
		<DynSentence name="GetQuoBal" desc="查询额度余额表">
			<Sentence>
				select QuoTot, Quobal from PfaQuoBal where %s
			</Sentence>
			<Fields>SqlStr|</Fields>
		</DynSentence>
		<DynSentence name="UpdQuoBal" desc="根据条件更新额度">
			<Sentence>
				update pfaquobal set QuoTot='%s', QuoBal='%s' where %s
			</Sentence>
			<Fields>QuoTot|QuoBal|SqlStr|</Fields>
		</DynSentence>
		<DynSentence name="LckQuoBal" desc="用SQL语句对额度余额表记录加锁">
			<Sentence>
				update PfaQuoBal set BalSts=BalSts where %s
			</Sentence>
			<Fields>SqlStr|</Fields>
		</DynSentence>
		<DynSentence name="ChgQuoBal" desc="更新额度余额">
			<Sentence>
				update PfaQuoBal set Quobal=substr(right( '000000000000000' || rtrim(char(bigint(Quobal)+(%s)*bigint('%s'))), 15 ),1,15)
				 where %s
			</Sentence>
			<Fields>AddFlg|UseAmt|SqlStr|</Fields>
		</DynSentence>
<!--支付令明细表【PfaVchDtl】操作-->
<!--支付令明细表【PfaVchDtl】操作-->
<!--支付令明细表【PfaVchDtl】操作-->
		<DynSentence name="GetVchDtlPar" desc="查询支付令对应额度控制域">
			<Sentence>
				select %s from %s where PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s'
			</Sentence>
			<Fields>SqlCol|VchDtlTbl|PfaSub|ActDat|AVchCd|</Fields>
		</DynSentence>
		<DynSentence name="ChkVchDtl">
			<Sentence>
				select DtlSts,QuoId,PayAct,PyeAct,DtlAmt ODtlAmt,UseAmt OUseAmt,SubCod,EConTp,PrjCod,DptCod,TVchTp,VchNo OVchNo,
							 StlMod,VchDat OVchDat
					from %s where PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s'
			</Sentence>
			<Fields>VchDtlTbl|PfaSub|ActDat|AVchCd|</Fields>
		</DynSentence>
		<DynSentence name="ChkVchDtl2">
			<Sentence>
				select DtlSts,QuoId,PayAct,PyeAct,DtlAmt ODtlAmt,UseAmt OUseAmt,SubCod,EConTp,PrjCod,DptCod,TVchTp,VchNo OVchNo,
							 StlMod,VchDat OVchDat
					from %s where PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s' and AVchNo='%s'
			</Sentence>
			<Fields>VchDtlTbl|PfaSub|ActDat|AVchCd|AVchNo|</Fields>
		</DynSentence>
		<DynSentence name="GetDtlByAVchNo">
			<Sentence>
				select %s, AVchCd, UseAmt from %s where PfaSub='%s' and Year=substr('%s',1,4) and AVchNo='%s'
			</Sentence>
			<Fields>SqlCol|VchDtlTbl|PfaSub|ActDat|AVchNo|</Fields>
		</DynSentence>
		<DynSentence name="GetDtlByAVchCd">
			<Sentence>
				select DtlSts,OIFlag,VchDat,PayAct,PayNam,PayBNm,PyeAct,PyeNam,PyeBNm,StlMod,DtlAmt,UseAmt,
							 TPayTp,RefCod,BCusId,DtlSmr,QuoId,SubCod,EConTp,PrjCod,DptCod,AVchNo,VchNo,TVchTp
					from %s
				 where PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s'
			</Sentence>
			<Fields>VchDtlTbl|PfaSub|ActDat|AVchCd|</Fields>
		</DynSentence>
		<DynSentence name="GetDtlByBCusId">
			<Sentence>
				select %s, AVchCd from %s
				 where PfaSub='%s' and Year=substr('%s',1,4)
					 and BCusId='%s' and SubCod='%s' and PrjCod='%s' and DptCod='%s' and DtlAmt>='%s'
					 and OIFlag='O' and DtlSts='U' and TVchTp='1'
			order by DtlAmt fetch first 1 rows only
			</Sentence>
			<Fields>SqlCol|VchDtlTbl|PfaSub|ActDat|BCusId|SubCod|PrjCod|DptCod|TxnAmt|</Fields>
		</DynSentence>
		<DynSentence name="UpdDtlByAVchCd" desc="根据授权凭证登记号修改支付令状态(同步VchBok和VchDtl状态)">
			<Sentence>
				update %s set DtlSts='%s',ChkFlg='%s',UseAmt='%s',AVchNo='%s', VchTyp='%s', VchNo='%s',
														 PayAct='%s',PayNam='%s',PayBNm='%s',PyeAct='%s',PyeNam='%s',PyeBNm='%s'
				 where PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s' and DtlSts='%s'
			</Sentence>
			<Fields>VchDtlTbl|VchSts|ChkFlg|OUseAmt|AVchNo|VchTyp|VchNo|PayAct|PayNam|PayBNm|PyeAct|PyeNam|PyeBNm|PfaSub|ActDat|AVchCd|DtlSts|</Fields>
		</DynSentence>
		<DynSentence name="UpdDtlByAVchNo" desc="根据授权凭证登记号修改明细内容">
			<Sentence>
				PfaSub='%s' and Year=substr('%s',1,4) and AVchNo='%s'
			</Sentence>
			<Fields>PfaSub|ActDat|AVchNo|</Fields>
		</DynSentence>
		<DynSentence name="GetVchDtlInf">
			<Sentence>
				select distinct BCusId,SubCod,PrjCod,DptCod from %s
				 where PfaSub='%s' and ( PfaDat between '%s' and '%s' ) and ClrSts='3'  
			</Sentence>
			<Fields>VchDtlTbl|PfaSub|BegDat|EndDat|</Fields>
		</DynSentence>
		<DynSentence name="DelVchDtl"> <!--删除-->
			<Sentence>
				 delete from %s where PfaSub='%s' and AVchNo='%s' and RegId='%s' and DtlSts='%s'
			</Sentence>
			<Fields>VchDtlTbl|PfaSub|AVchNo|TlrId|DtlSts|</Fields>
		</DynSentence>
<!--支付令登记表【PfaVchBok】操作-->
<!--支付令登记表【PfaVchBok】操作-->
<!--支付令登记表【PfaVchBok】操作-->
		<DynSentence name="GetVchBok" desc="根据授权凭证登记号查询支付令表">
			<Sentence>
				select VchSts,BusMod,OIFlag,VchDat,CrpVch,PayAct,PayNam,PayBNm,PyeAct,PyeNam,PyeBNm,StlMod,VchTyp OVchTyp,VchNo,TxnAmt,
							 TPayTp,RefCod,BCusId,AmtTyp,DtlNum,VchSmr,VchSmr Smr,RegId,BokId,ChkId,BokTck, UdwDat, Pin
					from PfaVchBok
				 where PfaSub='%s' and Year=substr('%s',1,4) and AVchNo='%s'
			</Sentence>
			<Fields>PfaSub|ActDat|AVchNo|</Fields>
		</DynSentence>
		<DynSentence name="UpdVchBokByAVchNo" desc="根据授权凭证登记号修改支付令状态">
			<Sentence>
				PfaSub='%s' and Year=substr('%s',1,4) and AVchNo='%s' 
			</Sentence>
			<Fields>PfaSub|ActDat|AVchNo|</Fields>
		</DynSentence>
		<DynSentence name="DelVchBok"> <!--删除-->
			<Sentence>
				 delete from pfavchbok where PfaSub='%s' and AVchNo='%s' and RegId='%s' and VchSts='%s'
			</Sentence>
			<Fields>PfaSub|AVchNo|TlrId|VchSts|</Fields>
		</DynSentence>
<!--交易流水表【PfaTxnJnl】操作-->
<!--交易流水表【PfaTxnJnl】操作-->
<!--交易流水表【PfaTxnJnl】操作-->
		<DynSentence name="ChkTxnJnl" desc="检查流水表">
			<Sentence>
				select LogNo OLogNo,TckNo OTckNo,HTxnSt,TxnSts,TTxnSt,ActSts
					from pfatxnjnl
				 where PfaSub='%s' and AVchNo='%s' and ActDat='%s' and (HTxnSt='S' or HTxnST='T' or HTxnST='U')
			</Sentence>
			<Fields>PfaSub|AVchNo|ActDat|</Fields>
		</DynSentence>
		<DynSentence name="UpdTxnJnl" desc="更新流水表">
			<Sentence>
				update pfatxnjnl set HTxnSt='%s',TxnSts='%s',TTxnSt='%s',ActSts='%s',TckNo='%s' where LogNo='%s'
			</Sentence>
			<Fields>HTxnSt|TxnSts|TTxnSt|ActSts|TckNo|OLogNo|</Fields>
		</DynSentence>
		<DynSentence name="GetTxnJnl" desc="复核抹帐查原流水">
			<Sentence>
				Select AVchNo,ActSts,HTxnSt,TTxnSt,PrvDat,TLogNo,HLogNo OHLogNo,TckNo OTckNo,TTxnCd OTTxnCd,TxnCod OTxnCod,
							 TlrId OTlrId, ClrSts,PayAct,PayNam,VchTyp,VchNo, UdwDat, Pin,  TxnAmt,PyeAct,PyeNam,Smr
					from pfatxnjnl where LogNo='%s'
			</Sentence>
			<Fields>OLogNo|</Fields>
		</DynSentence>
<!--基础信息表【PfaCusInf】【PfaCodInf】操作-->
<!--基础信息表【PfaCusInf】【PfaCodInf】操作-->
<!--基础信息表【PfaCusInf】【PfaCodInf】操作-->
		<DynSentence name="GetCusInf">
			<Sentence>
				select BCusNm,FCusId,FCusNm,ActNo,ActNam,TCusId,OpnNod,BrNo ActBr from pfacusinf where PfaSub='%s' and BCusId='%s'
			</Sentence>
			<Fields>PfaSub|BCusId|</Fields>
		</DynSentence>
		<DynSentence name="GetCodInf">
			<Sentence>
				select CodNam %s from PfaCodInf where PfaSub='%s' and CodTyp='%s' and Code='%s'
			</Sentence>
			<Fields>CodNam|PfaSub|CodTyp|Code|</Fields>
		</DynSentence>
<!--机构状态表【PfaOrgSts】操作-->
<!--机构状态表【PfaOrgSts】操作-->
<!--机构状态表【PfaOrgSts】操作-->
		<DynSentence name="ChkOrgSts">       <!--根据财政代码和和网点号检查是否可以记帐-->
			<Sentence>
				select SgnFlg,BokFlg from PfaOrgSts where PfaSub='%s' and OrgNod='%s'
			</Sentence>
			<Fields>PfaSub|NodNo|</Fields>
		</DynSentence>
<!--公务卡新增-->
<!--公务卡新增-->
<!--公务卡新增-->
<!--公务卡新增-->
<!--公务卡新增-->
		<DynSentence name="ChkCrdDtl">
			<Sentence>
				select value(sum(bigint(BokAmt)),0) Amt	from pfacrddtl
				 where PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s' and DtlSts='U'
			</Sentence>
			<Fields>PfaSub|ActDat|AVchCd|</Fields>
		</DynSentence>
		<DynSentence name="GetCrdDtl">     <!--根据还款批次号获取资料-->
			<Sentence>
				select Year, CardNo, CardNm, substr(right('0000000000000000'||rtrim(char(value(sum(bigint(BokAmt)),0))),15),1,15) TxnAmt
					from pfacrddtl
				 where PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s' and DtlSts='B'
			group by Year,CardNo,CardNm
			</Sentence>
			<Fields>PfaSub|ActDat|AVchCd|</Fields>
		</DynSentence>
		<DynSentence name="UpdCrdDtl">
			<Sentence>
				PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s'
			</Sentence>
			<Fields>PfaSub|ActDat|AVchCd|</Fields>
		</DynSentence>
		<DynSentence name="UpdCrdDtlByCardNo">
			<Sentence>
				PfaSub='%s' and Year=substr('%s',1,4) and AVchCd='%s' and CardNo='%s'
			</Sentence>
			<Fields>PfaSub|ActDat|AVchCd|CardNo|</Fields>
		</DynSentence>
		<DynSentence name="UpdCrdJnl">     <!--根据流水号更新资料-->
			<Sentence>
				LogNo='%s'
			</Sentence>
			<Fields>LogNo|</Fields>
		</DynSentence>
	</Macro>

	<Macro name="InitTran" desc="非帐务类交易初始化">
		<Exec func="PUB:GetBranchNoByNodeNo"/>
		<Exec func="PUB:InitTransaction"/>
		<Set>QuoBokTbl=STRCAT(pfaquobok,$PfaSub)</Set>
		<Set>VchDtlTbl=STRCAT(pfavchdtl,$PfaSub)</Set>
	</Macro>

	<Macro name="AccInitTran" desc="帐务类交易初始化">
		<Exec func="PUB:GetBranchNoByNodeNo"/>
		<Exec func="PUB:InitTransaction"/>
		<Exec func="PUB:GetAppInfo"/>
		<Set>QuoBokTbl=STRCAT(pfaquobok,$PfaSub)</Set>
		<Set>VchDtlTbl=STRCAT(pfavchdtl,$PfaSub)</Set>
	</Macro>

	<Macro name="ChkSubCfg" desc="检查财政配置参数">
		<Exec func="PUB:ReadRecord" error="IGNORE">
			<Arg name="SqlCmd" value="SubCfgRunPar"/>
		</Exec>
		<If condition="INTCMP(~RetCod,4,0)">
			<Set>RspMsg=E</Set>
			<Set>RspCod=PFA999</Set>
			<Set>RspMsg=STRCAT(数据库查询失败或财政代码【,$PfaSub,】不存在)</Set>
			<Return/>
		</If>
	</Macro>

	<Macro name="GetSqlStr" desc="获取额度控制条件">
		<Delete>SqlStr</Delete>
		<Exec func="PUB:ReadRecord" error="IGNORE">
			<Arg name="SqlCmd" value="SubCfgCtlPar"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="-2">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(无财政【,$PfaSub,】配置信息)</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE"/>
				<Return/>
			</Case>
			<Case value="0">
				<Set>SqlStr=STRCAT($StsNam,=',$StsVal,')</Set>
				<Set>FldNum=1</Set>
				<While condition="INTCMP($FldNum,2,9)">
					<Exec func="PUB:GetValue">
						<Arg name="SourName"  value="STRCAT(ROOT.FldNm,$FldNum)"/>
						<Arg name="DestName"  value="ROOT.FldNam"/>
					</Exec>
					<If condition="STRLEN(TRIM($FldNam,right))&gt;0">
						<Exec func="PUB:GetValue">
							<Arg name="SourName"  value="STRCAT(ROOT.,$FldNam)"/>
							<Arg name="DestName"  value="ROOT.FldDat"/>
						</Exec>
						<Set>SqlStr=STRCAT($SqlStr, and ,$FldNam,=',$FldDat,')</Set>
					</If>
					<Set>FldNum=ADD($FldNum,1)</Set>
				</While>
				<Break/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取财政【,$PfaSub,】配置条件错误)</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE"/>
				<Return/>
			</Default>
		</Switch>
	</Macro>

	<Macro name="GetSqlCol" desc="获取额度控制字段">
		<Delete>SqlCol</Delete>
		<Exec func="PUB:ReadRecord" error="IGNORE">
			<Arg name="SqlCmd" value="SubCfgCtlPar"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="-2">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(无财政【,$PfaSub,】配置信息)</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE"/>
				<Return/>
			</Case>
			<Case value="0">
				<Set>SqlCol=$StsNam</Set>
				<Set>FldNum=1</Set>
				<While condition="INTCMP($FldNum,2,9)">
					<Exec func="PUB:GetValue">
						<Arg name="SourName"  value="STRCAT(ROOT.FldNm,$FldNum)"/>
						<Arg name="DestName"  value="ROOT.FldNam"/>
					</Exec>
					<If condition="STRLEN(TRIM($FldNam,right))&gt;0">
						<Set>SqlCol=STRCAT($SqlCol,$SplFlg,$FldNam)</Set>
					</If>
					<Set>FldNum=ADD($FldNum,1)</Set>
				</While>
				<Break/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取财政【,$PfaSub,】配置参数错误)</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE"/>
				<Return/>
			</Default>
		</Switch>
	</Macro>


	<Macro name="ProChkBal" desc="检查单位额度">
<!--设置额度变更标志-->
		<Set>AddFlg=0</Set>
		<Set>TotAmt=0</Set>
		<Set>StsNam=DtlSts</Set>
		<Quote name="GetSqlCol"/>
<!--对多笔明细处理-->
		<Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
			<Arg name="SqlCmd" value="GetDtlByAVchNo"/>
		</Exec>
		<If condition="INTCMP(~RetCod,4,0)">
 			<Set>MsgTyp=E</Set>
			<Set>RspCod=PFA999</Set>
			<Set>RspMsg=STRCAT(打开游标【GetDtlByAVchNo】错)</Set>
			<Exec func="PUB:RollbackWork" error="IGNORE"/>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Return/>
		</If>
		<While>
			<Exec func="PUB:FetchCursor" error="IGNORE"/>
			<If condition="INTCMP(~RetCod,3,-1)">  <!--出错-->
				<Exec func="PUB:CloseCursor"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=数据库错误</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE"/>
				<Return/>
			</If>
			<If condition="INTCMP(~RetCod,3,100)">  <!--结束-->
				<Break/>
			</If>
			<Set>StsNam=BalSts</Set>
			<Set>StsVal=0</Set>
			<Quote name="GetSqlStr"/>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="sql" value="LckQuoBal"/>
			</Exec>
			<Switch expression="~RetCod">
				<Case value="-1">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=STRCAT(表【PfaQuoBal】加锁失败)</Set>
					<Exec func="PUB:RollbackWork" error="IGNORE"/>
					<Exec func="PUB:CloseCursor" error="IGNORE"/>
					<Return/>
				</Case>
				<Case value="-2">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=STRCAT(无支付令【,$AVchCd,】额度)</Set>
					<Exec func="PUB:RollbackWork" error="IGNORE"/>
					<Exec func="PUB:CloseCursor" error="IGNORE"/>
					<Return/>
				</Case>
				<Case value="0">
<!--
					<Exec func="PUB:ExecSql">
						<Arg name="sql" value="ChgQuoBal"/>
					</Exec>
-->
					<Break/>
				</Case>
				<Default>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=STRCAT(支付令【,AVchCd,】额度查询异常)</Set>
					<Exec func="PUB:RollbackWork" error="IGNORE"/>
					<Exec func="PUB:CloseCursor" error="IGNORE"/>
					<Return/>
				</Default>
			</Switch>
			<Set>TotAmt=ADD($TotAmt,$UseAmt)</Set>
		</While>
		<If condition="INTCMP($TxnAmt,1,$TotAmt)">
			<Set>MsgTyp=E</Set>
			<Set>RspCod=PFA999</Set>
			<Set>RspMsg=STRCAT(支付金额【,AMTFMT($TxnAmt),】与支付令汇总金额【,AMTFMT($TotAmt),】不符)</Set>
			<Exec func="PUB:RollbackWork" error="IGNORE"/>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Return/>
		</If>
		<Exec func="PUB:CloseCursor" error="IGNORE"/>
	</Macro>



	<Macro name="ProSubBal" desc="扣减单位额度">
<!--设置额度变更标志-->
		<Set>AddFlg=-1</Set>
		<Set>TotAmt=0</Set>
		<Set>StsNam=DtlSts</Set>
		<Quote name="GetSqlCol"/>
<!--对多笔明细处理-->
		<Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
			<Arg name="SqlCmd" value="GetDtlByAVchNo"/>
		</Exec>
		<If condition="INTCMP(~RetCod,4,0)">
 			<Set>MsgTyp=E</Set>
			<Set>RspCod=PFA999</Set>
			<Set>RspMsg=STRCAT(打开游标【GetDtlByAVchNo】错)</Set>
			<Exec func="PUB:RollbackWork" error="IGNORE"/>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Return/>
		</If>
		<While>
			<Exec func="PUB:FetchCursor" error="IGNORE"/>
			<If condition="INTCMP(~RetCod,3,-1)">  <!--出错-->
				<Exec func="PUB:CloseCursor" error="IGNORE"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=数据库错误</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE" />
				<Return/>
			</If>
			<If condition="INTCMP(~RetCod,3,100)">  <!--结束-->
				<Break/>
			</If>
			<Set>StsNam=BalSts</Set>
			<Set>StsVal=0</Set>
			<Quote name="GetSqlStr"/>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="sql" value="LckQuoBal"/>
			</Exec>
			<Switch expression="~RetCod">
				<Case value="-1">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=STRCAT(表【PfaQuoBal】加锁失败)</Set>
					<Exec func="PUB:RollbackWork" error="IGNORE"/>
					<Exec func="PUB:CloseCursor" error="IGNORE"/>
					<Return/>
				</Case>
				<Case value="-2">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=CD5200</Set>
					<Set>RspMsg=STRCAT(无支付令【,$AVchCd,】额度)</Set>
					<Exec func="PUB:RollbackWork" error="IGNORE"/>
					<Exec func="PUB:CloseCursor" error="IGNORE"/>
					<Return/>
				</Case>
				<Case value="0">
					<Exec func="PUB:ReadRecord">
						<Arg name="SqlCmd" value="GetQuoBal"/>
					</Exec>
					<If condition="INTCMP($Quobal,1,$UseAmt)">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=CD5200</Set>
						<Set>RspMsg=STRCAT(支付令【,$AVchCd,】额度余额不足)</Set>
						<Exec func="PUB:RollbackWork" error="IGNORE"/>
						<Exec func="PUB:CloseCursor" error="IGNORE"/>
						<Return/>
					</If>
					<Exec func="PUB:ExecSql">
						<Arg name="sql" value="ChgQuoBal"/>
					</Exec>
					<Break/>
				</Case>
				<Default>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=STRCAT(扣减支付令【,AVchCd,】额度异常)</Set>
					<Exec func="PUB:RollbackWork" error="IGNORE"/>
					<Exec func="PUB:CloseCursor" error="IGNORE"/>
					<Return/>
				</Default>
			</Switch>
			<Set>TotAmt=ADD($TotAmt,$UseAmt)</Set>
		</While>
		<If condition="INTCMP($TxnAmt,1,$TotAmt)">
			<Set>MsgTyp=E</Set>
			<Set>RspCod=PFA999</Set>
			<Set>RspMsg=STRCAT(支付金额【,AMTFMT($TxnAmt),】与支付令汇总金额【,AMTFMT($TotAmt),】不符)</Set>
			<Exec func="PUB:RollbackWork" error="IGNORE"/>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Return/>
		</If>
		<Exec func="PUB:CloseCursor" error="IGNORE"/>
	</Macro>


	<Macro name="ProAddBal" desc="增加单位额度">
<!--设置额度变更标志-->
		<Set>AddFlg=1</Set>
		<Set>TotAmt=0</Set>
		<Set>StsNam=DtlSts</Set>
		<Quote name="GetSqlCol"/>
<!--对多笔明细处理-->
		<Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
			<Arg name="SqlCmd" value="GetDtlByAVchNo"/>
		</Exec>
		<If condition="INTCMP(~RetCod,4,0)">
 			<Set>MsgTyp=E</Set>
			<Set>RspCod=PFA999</Set>
			<Set>RspMsg=STRCAT(打开游标【GetDtlByAVchNo】错)</Set>
			<Exec func="PUB:RollbackWork" error="IGNORE"/>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Return/>
		</If>
		<While>
			<Exec func="PUB:FetchCursor" error="IGNORE"/>
			<If condition="INTCMP(~RetCod,3,-1)">  <!--出错-->
				<Exec func="PUB:CloseCursor"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=数据库错误</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE"/>
				<Return/>
			</If>
			<If condition="INTCMP(~RetCod,3,100)">  <!--结束-->
				<Break/>
			</If>
			<Set>StsNam=BalSts</Set>
			<Set>StsVal=0</Set>
			<Quote name="GetSqlStr"/>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="sql" value="LckQuoBal"/>
			</Exec>
			<Switch expression="~RetCod">
				<Case value="-1">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=STRCAT(表【PfaQuoBal】加锁失败)</Set>
					<Exec func="PUB:RollbackWork" error="IGNORE"/>
					<Exec func="PUB:CloseCursor" error="IGNORE"/>
					<Return/>
				</Case>
				<Case value="-2">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=STRCAT(无支付令【,$AVchCd,】额度)</Set>
					<Exec func="PUB:RollbackWork" error="IGNORE"/>
					<Exec func="PUB:CloseCursor" error="IGNORE"/>
					<Return/>
				</Case>
				<Case value="0">
					<Exec func="PUB:ExecSql">
						<Arg name="sql" value="ChgQuoBal"/>
					</Exec>
					<Break/>
				</Case>
				<Default>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=STRCAT(扣减支付令【,AVchCd,】额度异常)</Set>
					<Exec func="PUB:RollbackWork" error="IGNORE"/>
					<Exec func="PUB:CloseCursor" error="IGNORE"/>
					<Return/>
				</Default>
			</Switch>
			<Set>TotAmt=ADD($TotAmt,$UseAmt)</Set>
		</While>
		<If condition="INTCMP($TxnAmt,1,$TotAmt)">
			<Set>MsgTyp=E</Set>
			<Set>RspCod=PFA999</Set>
			<Set>RspMsg=STRCAT(支付金额【,AMTFMT($TxnAmt),】与支付令汇总金额【,AMTFMT($TotAmt),】不符)</Set>
			<Exec func="PUB:RollbackWork" error="IGNORE"/>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Return/>
		</If>
		<Exec func="PUB:CloseCursor" error="IGNORE"/>
	</Macro>


	<Macro name="ProUpdVchBok" desc="支付令状态修改">
		<Exec func="PUB:UpdateRecord">
			<Arg name="TblNam" value="pfavchbok"/>
			<Arg name="CndSts" value="UpdVchBokByAVchNo"/>
		</Exec>
	</Macro>


	<Macro name="ProUpdVchDtl" desc="支付令明细状态修改">
		<Exec func="PUB:UpdateRecord">
			<Arg name="TblNam" value="$VchDtlTbl"/>
			<Arg name="CndSts" value="UpdDtlByAVchNo"/>
		</Exec>
	</Macro>


	<Macro name="ChkVchBok" desc="支付令状态检查">
		<Exec func="PUB:ReadRecord" error="IGNORE">
			<Arg name="SqlCmd" value="GetVchBok"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="-2">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=无此支付令</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE"/>
				<Return/>
			</Case>
			<Case value="0">
				<Switch expression="$VchSts">
					<Case value="0">
						<Set>ChkFlg=1</Set>
<!--
						<Set>VchSts=1</Set>
						<Set>DtlSts=1</Set>
						<Quote name="ProUpdVchBok"/>
						<Quote name="ProUpdVchDtl"/>
-->
						<Break/>
					</Case>
					<Case value="1">
						<Break/>
					</Case>
					<Case value="2">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=该支付令已使用</Set>
						<Exec func="PUB:RollbackWork" error="IGNORE"/>
						<Return/>
					</Case>
					<Default>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=该支付令已被撤销或退回</Set>
						<Exec func="PUB:RollbackWork" error="IGNORE"/>
						<Return/>
					</Default>
				</Switch>
				<Break/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取支付令【,$AVchNo,】信息异常)</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE"/>
				<Return/>
			</Default>
		</Switch>
	</Macro>



	<Macro name="ProBokChk" desc="记帐状态检查">
		<Exec func="PUB:ReadRecord">
			<Arg name="sql" value="ChkOrgSts"/>
		</Exec>
		<If condition="OR(INTCMP($SgnFlg,4,0),INTCMP($BokFlg,4,0))">
			<Set>MsgTyp=E</Set>
			<Set>RspCod=PFA999</Set>
			<Set>RspMsg=STRCAT(网点【,$NodNo,】未签到或系统暂时不允许帐务处理)</Set>
			<Return/>
		</If>
	</Macro>


	<Macro name="ProJnlChk" desc="流水状态检查同步">
		<Switch expression="$HTxnSt">
			<Case value="S">     <!--该情况似乎不会出现，只有前置交易正常完成而前端没收到应答-->
				<Set>RspCod=000000</Set>
				<Set>MsgTyp=N</Set>
				<Set>RspMsg=原交易已成功</Set>
				<Return/>
			</Case>
			<Case value="T"/>
			<Case value="U">
				<Exec func="PUB:CallHostOther" error="IGNORE">
					<Arg name="HTxnCd" value="458980"/>
					<Arg name="ObjSvr" value="SHSTPUB1"/>
				</Exec>
				<Switch expression="$MsgTyp">
					<Case value="E">
						<Switch expression="$HRspCd">
							<Case value="AG8001"/>   <!--该前置流水号不存在-->
							<Case value="AG8981"/>   <!--该前置流水号不存在-->
							<Case value="SC6129">    <!--原交易不存在-->
								<Set>HTxnSt=F</Set>
								<Set>TxnSts=F</Set>
								<Set>TTxnSt=F</Set>
								<Exec func="PUB:ExecSql">
									<Arg name="sql" value="UpdTxnJnl"/><!--更新流水表为失败-->
								</Exec>
								<Break/>
							</Case>
							<Default>     <!--其他错误(非原交易不存在)-->
								<Set>MsgTyp=E</Set>
								<Set>RspCod=$HRspCd</Set>
								<Return/>
							</Default>
						</Switch>
						<Break/>
					</Case>
					<Case value="N">
						<If condition="$CrcSts=Y">  <!--交易状态为抹账,该情况出现可能也不大-->
							<Set>HTxnSt=C</Set>
							<Set>TxnSts=C</Set>
							<Set>TTxnSt=C</Set>
							<Set>ActSts=3</Set>
							<Exec func="PUB:ExecSql">
								<Arg name="sql" value="UpdTxnJnl"/>
							</Exec>
							<Break/>
						</If>
						<Else>
							<Set>HTxnSt=S</Set>
							<Set>TxnSts=S</Set>
							<Set>TTxnSt=S</Set>
							<Exec func="PUB:ExecSql">
								<Arg name="sql" value="UpdTxnJnl"/>
							</Exec>
							<Set>VchSts=2</Set>
							<Set>ChkFlg=1</Set>
							<Set>DtlSts=2</Set>
							<Quote name="ProUpdVchBok"/>  <!--修改支付令状态-->
							<Quote name="ProUpdVchDtl"/>  <!--修改支付令明细状态-->
							<Exec func="PUB:CommitWork" error="IGNORE"/>
							<Return/>
						</Else>
						<Break/>
					</Case>
					<Default>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=STRCAT(查询主机流水【,$OLogNo,】失败)</Set>
						<Return/>
					</Default>
				</Switch>
				<Break/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(支付令【,$AVchNo,】流水状态【,$HTxnSt,】错)</Set>
				<Return/>
			</Default>
		</Switch>
	</Macro>


	<Macro name="ProGenHstDat" desc="生成主机其他挂帐接口数据">    <!--HpcFlg=1付款挂帐，HpcFlg=0收款挂帐-->
		<Exec func="PUB:IsExistNode">
			<Arg name="FieldName" value="HpcFlg"/>
		</Exec>
		<If condition="~RetCod=1">
			<Exec func="PFA:GenHostGroupData">
				<Arg name="HpcFlg" value="$HpcFlg"/>
			</Exec>
		</If>
	</Macro>


	<Macro name="ProOutBok" desc="付款记帐宏">
		<Set>BokId=$TlrId</Set>
		<Quote name="ProBokChk"/>  <!--检查是否可以记帐-->
		<Exec func="PUB:Lock">     <!--对支付令凭证信息加锁-->
			<Arg name="RecKey" value="STRCAT(PFA,$PfaSub,SUBSTR($ActDat,1,4),$AVchNo)"/>
			<Arg name="TimOut" value="10"/>
			<Arg name="AutoUnlock" value="yes"/>
		</Exec>
		<Quote name="ChkVchBok"/>
		<Exec func="PUB:ReadRecord" error="IGNORE"><!--查询流水表是否已存在-->
			<Arg name="SqlCmd" value="ChkTxnJnl"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="0">
				<Quote name="ProJnlChk"/>
				<Break/>
			</Case>
			<Case value="-2">
				<Quote name="ProSubBal"/>  <!--扣减支付额度-->
				<Exec func="PUB:GetLogNo"/>
				<Set>ActSts=1</Set>
				<Set>CcyCod=CNY</Set>
				<Set>TLogNo=DELBOTHSPACE($BusLog)</Set>
				<Exec func="PUB:InsertJournal"/>
				<Quote name="ProGenHstDat"/>  <!--生成主机其他挂帐接口数据-->
				<Exec func="PUB:CallHostOther" error="IGNORE">
					<Arg name="HTxnCd" value="$HTxnCd"/>
					<Arg name="ObjSvr" value="SHSTPUB1"/>
				</Exec>
				<Switch expression="~RetCod">
					<Case value="0"> <!--交易成功-->
						<Set>MsgTyp=N</Set>
						<Set>RspCod=000000</Set>
						<Break/>
					</Case>
					<Case value="-1">  <!--上送主机超时-->
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=与主机通讯超时,请查询后抹帐</Set>
						<Set>TckNo=$OTckNo</Set>
						<Exec func="PUB:UpdateJournal"/>
						<Return/>
					</Case>
					<Default>
						<Set>RspCod=$HRspCd</Set>
						<Set>RspMsg=上送主机失败</Set>
						<Set>TckNo=$OTckNo</Set>
						<Exec func="PUB:UpdateJournal"/>
						<Set>AddFlg=1</Set>
						<Quote name="ProAddBal"/>  <!--加回支付额度-->
						<Set>VchSts=0</Set>
						<Set>ChkFlg=0</Set>
						<Set>DtlSts=0</Set>
						<Quote name="ProUpdVchBok"/>  <!--修改支付令状态为"0-登记"-->
						<Quote name="ProUpdVchDtl"/>  <!--修改支付令状态为"0-登记"-->
						<Return/>
					</Default>
				</Switch>
				<Set>TTxnSt=S</Set>
				<Exec func="PUB:UpdateJournal"/>
				<Set>VchSts=1</Set>
				<Set>ChkFlg=1</Set>
				<Set>DtlSts=1</Set>
				<Set>BokTck=$TckNo</Set>
				<Quote name="ProUpdVchBok"/>  <!--修改支付令状态为"2-使用"-->
				<Quote name="ProUpdVchDtl"/>  <!--修改支付令明细状态-->
				<Exec func="PUB:CommitWork" error="IGNORE"/>
				<Break/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取流水【,$OLogNo,】资料失败)</Set>
				<Return/>
			</Default>
		</Switch>
	</Macro>


	<Macro name="ProOutChk" desc="付款复核宏">
		<Exec func="PUB:ReadRecord" error="IGNORE">
			<Arg name="sql" value="GetTxnJnl"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="0">
				<If condition="$ActSts=2">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=凭证状态已复核</Set>
					<Return/>
				</If>
				<Break/>
			</Case>
			<Case value="-2">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=无此流水</Set>
				<Return/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取流水【,$OLogNo,】数据库操作失败)</Set>
				<Return/>
			</Default>
		</Switch>
		<If condition="STRLEN(TRIM($PrvDat,right))&gt;0">
			<Exec func="PFA:ParsePrvData" >
				<Arg name="Args" value="PrvDat"/>
			</Exec>
		</If>
		<Set>ONodNo=$NodNo</Set>
		<Quote name="ProGenHstDat"/>  <!--生成主机其他挂帐接口数据-->
		<Exec func="PUB:CallHostOther">
			<Arg name="HTxnCd" value="$HTxnCd"/>
			<Arg name="ObjSvr" value="SHSTPUB1"/>
		</Exec>
		<If condition="$RspCod=SC6084">   <!--交易已确认6084-->
			<Set>MsgTyp=N</Set>
			<Set>NodNo=$ONodNo</Set>
		</If>
		<If condition="$MsgTyp!=N">
			<Return/>
		</If>
		<Set>ActSts=2</Set>
		<Set>TckNo=$OTckNo</Set>
		<Exec func="PUB:ExecSql">
			<Arg name="sql" value="UpdTxnJnl"/>
		</Exec>
		<Set>VchSts=2</Set>
		<Set>DtlSts=2</Set>
		<Set>ChkId=$TlrId</Set>
		<Quote name="ProUpdVchBok"/>  <!--修改支付令状态为"2-使用"-->
		<Quote name="ProUpdVchDtl"/>  <!--修改支付令状态为"2-使用"-->
	</Macro>


	<Macro name="ProOutCan" desc="付款抹帐宏">
		<Exec func="PUB:ReadRecord" error="IGNORE">
			<Arg name="sql" value="GetTxnJnl"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="0">
				<If condition="IS_NOEQUAL_STRING($ClrSts,0)">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=该笔业务已清算，不能抹帐</Set>
					<Return/>
				</If>
				<If condition="$ActSts=3">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=凭证状态不需抹帐</Set>
					<Return/>
				</If>
				<Else>
					<Switch expression="$HTxnSt">
						<Case value="T"/>
						<Case value="S">
							<Break/>
						</Case>
						<Default>
							<Set>MsgTyp=E</Set>
							<Set>RspCod=PFA999</Set>
							<Set>RspMsg=凭证状态不需抹帐</Set>
							<Return/>
						</Default>
					</Switch>
				</Else>
				<Break/>
			</Case>
			<Case value="-2">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=无此流水</Set>
				<Return/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取流水【,$OLogNo,】数据库操作失败)</Set>
				<Return/>
			</Default>
		</Switch>
		<If condition="STRLEN(TRIM($PrvDat,right))&gt;0">
			<Exec func="PFA:ParsePrvData" >
				<Arg name="Args" value="PrvDat"/>
			</Exec>
		</If>
		<Set>LogNo=$OLogNo</Set>
		<Quote name="ProGenHstDat"/>  <!--生成主机其他挂帐接口数据-->
		<If condition="IS_EQUAL_STRING($HTxnCd,045129)">
			<Exec func="PFA:GenHostGroupFilData">
				<Arg name="RecNum" value="$RecNum" desc="记录数"/>
				<Arg name="MaxRec" value="10"  desc="最大笔数"/>
			</Exec>
		</If>
		<Exec func="PUB:CallHostAcc">
			<Arg name="HTxnCd" value="$HTxnCd"/>
			<Arg name="ObjSvr" value="SHSTPUB1"/>
		</Exec>
		<If condition="$RspCod=SC6034">     <!--交易已抹帐6034-->
			<Set>MsgTyp=N</Set>
		</If>
		<If condition="$MsgTyp!=N">
			<Return/>
		</If>
		<Set>HTxnSt=C</Set>
		<Set>TxnSts=C</Set>
		<Set>TTxnSt=C</Set>
		<Set>ActSts=3</Set>
		<Set>NTckNo=$TckNo</Set>   <!--保留非会计流水号-->
		<Set>TckNo=$OTckNo</Set>
		<Exec func="PUB:ExecSql">
			<Arg name="SqlCmd" value="UpdTxnJnl"/>
		</Exec>
		<Quote name="ProAddBal"/>  <!--加回支付额度-->
		<Set>VchSts=0</Set>
		<Set>ChkFlg=0</Set>
		<Set>DtlSts=0</Set>
		<Quote name="ProUpdVchBok"/>  <!--修改支付令状态-->
		<Quote name="ProUpdVchDtl"/>  <!--修改支付令明细状态-->
		<Set>TckNo=$NTckNo</Set>   <!--恢复非会计流水号-->
	</Macro>


	<Macro name="ProInBok" desc="收款记帐宏">
	  <Quote name="ProBokChk"/>  <!--检查是否可以记帐-->
		<Exec func="PUB:Lock">     <!--对支付令凭证信息加锁-->
			<Arg name="RecKey" value="STRCAT(PFA,$PfaSub,SUBSTR($ActDat,1,4),$AVchNo)"/>
			<Arg name="TimOut" value="10"/>
			<Arg name="AutoUnlock" value="yes"/>
		</Exec>
		<Quote name="ChkVchBok"/>  <!--检查支付令凭证可用-->
		<Quote name="ProChkBal"/>  <!--检查支付额度是否存在-->
		<Exec func="PUB:ReadRecord" error="IGNORE"><!--查询流水表是否已存在-->
			<Arg name="SqlCmd" value="ChkTxnJnl"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="0">
				<Quote name="ProJnlChk"/>
				<Break/>
			</Case>
			<Case value="-2">
				<Exec func="PUB:GetLogNo"/>
				<Set>Fee=0</Set>
				<Set>CcyCod=CNY</Set>
				<Set>ActSts=1</Set>
				<Set>TLogNo=DELBOTHSPACE($BusLog)</Set>
				<Exec func="PUB:InsertJournal"/>
				<Quote name="ProGenHstDat"/>  <!--生成主机其他挂帐接口数据-->
				<Exec func="PUB:CallHostOther" error="IGNORE">
				<Arg name="HTxnCd" value="$HTxnCd"/>
				<Arg name="ObjSvr" value="SHSTPUB1"/>
				</Exec>
				<Switch expression="~RetCod">
					<Case value="0"> <!--交易成功-->
						<Set>MsgTyp=N</Set>
						<Set>RspCod=000000</Set>
						<Break/>
					</Case>
					<Case value="-1">  <!--上送主机超时-->
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=与主机通讯超时,请查询后抹帐</Set>
						<Set>TckNo=$OTckNo</Set>
						<Exec func="PUB:UpdateJournal"/>
						<Return/>
					</Case>
					<Default>
						<Set>RspCod=$HRspCd</Set>
						<Set>RspMsg=上送主机失败</Set>
						<Set>TckNo=$OTckNo</Set>
						<Exec func="PUB:UpdateJournal"/>
						<Return/>
					</Default>
				</Switch>
				<Exec func="PUB:UpdateJournal"/>
				<Set>VchSts=1</Set>
				<Set>ChkFlg=1</Set>
				<Set>DtlSts=1</Set>
				<Set>BokTck=$TckNo</Set>
				<Quote name="ProUpdVchBok"/>  <!--修改支付令状态-->
				<Quote name="ProUpdVchDtl"/>  <!--修改支付令明细状态-->
				<Exec func="PUB:CommitWork" error="IGNORE"/>
				<Break/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取流水【,$OLogNo,】资料失败)</Set>
				<Return/>
			</Default>
		</Switch>
	</Macro>


	<Macro name="ProInChk" desc="收款复核宏">
		<Exec func="PUB:ReadRecord" error="IGNORE">
			<Arg name="sql" value="GetTxnJnl"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="0">
				<If condition="$ActSts=2">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=凭证状态已复核</Set>
					<Return/>
				</If>
				<Break/>
			</Case>
			<Case value="-2">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=无此流水</Set>
				<Return/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取流水【,$OLogNo,】数据库操作失败)</Set>
				<Return/>
			</Default>
		</Switch>
		<If condition="STRLEN(TRIM($PrvDat,right))&gt;0">
			<Exec func="PFA:ParsePrvData" >
				<Arg name="Args" value="PrvDat"/>
			</Exec>
		</If>
		<Set>ONodNo=$NodNo</Set>
		<Quote name="ProGenHstDat"/>  <!--生成主机其他挂帐接口数据-->
		<Exec func="PUB:CallHostOther">
			<Arg name="HTxnCd" value="$HTxnCd"/>
			<Arg name="ObjSvr" value="SHSTPUB1"/>
		</Exec>
		<If condition="$RspCod=SC6084">   <!--交易已确认6084-->
			<Set>MsgTyp=N</Set>
			<Set>NodNo=$ONodNo</Set>
		</If>
		<If condition="$MsgTyp!=N">
			<Return/>
		</If>
		<Quote name="ProAddBal"/>  <!--加回支付额度-->
		<Set>ActSts=2</Set>
		<Set>TckNo=$OTckNo</Set>
		<Exec func="PUB:ExecSql">
			<Arg name="sql" value="UpdTxnJnl"/>
		</Exec>
		<Set>VchSts=2</Set>
		<Set>DtlSts=2</Set>
		<Set>ChkId=$TlrId</Set>
		<Quote name="ProUpdVchBok"/>  <!--修改支付令状态为"2-使用"-->
		<Quote name="ProUpdVchDtl"/>  <!--修改支付令状态为"2-使用"-->
	</Macro>


	<Macro name="ProInCan" desc="收款抹帐宏">
		<Exec func="PUB:ReadRecord" error="IGNORE">
			<Arg name="sql" value="GetTxnJnl"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="0">
				<If condition="IS_NOEQUAL_STRING($ClrSts,0)">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=该笔业务已清算，不能抹帐</Set>
					<Return/>
				</If>
				<If condition="$ActSts=3">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=凭证状态不需抹帐</Set>
					<Return/>
				</If>
				<Else>
					<Switch expression="$HTxnSt">
						<Case value="T"/>
						<Case value="S">
							<Break/>
						</Case>
						<Default>
							<Set>MsgTyp=E</Set>
							<Set>RspCod=PFA999</Set>
							<Set>RspMsg=凭证状态不需抹帐</Set>
							<Return/>
						</Default>
					</Switch>
				</Else>
				<Break/>
			</Case>
			<Case value="-2">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=无此流水</Set>
				<Return/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取流水【,$OLogNo,】数据库操作失败)</Set>
				<Return/>
			</Default>
		</Switch>
		<Quote name="ProSubBal"/>  <!--扣减支付额度-->
		<If condition="STRLEN(TRIM($PrvDat,right))&gt;0">
			<Exec func="PFA:ParsePrvData" >
				<Arg name="Args" value="PrvDat"/>
			</Exec>
		</If>
		<Set>LogNo=$OLogNo</Set>
		<Quote name="ProGenHstDat"/>  <!--生成主机其他挂帐接口数据-->
		<Exec func="PUB:CallHostAcc" error="IGNORE">
			<Arg name="HTxnCd" value="$HTxnCd"/>
			<Arg name="ObjSvr" value="SHSTPUB1"/>
		</Exec>
		<If condition="$RspCod=SC6034">     <!--交易已抹帐6034-->
			<Set>MsgTyp=N</Set>
		</If>
		<If condition="$MsgTyp!=N">
			<Quote name="ProAddBal"/>  <!--加回支付额度-->
			<Return/>
		</If>
		<Set>HTxnSt=C</Set>
		<Set>TxnSts=C</Set>
		<Set>TTxnSt=C</Set>
		<Set>ActSts=3</Set>
		<Set>NTckNo=$TckNo</Set>   <!--保留非会计流水号-->
		<Set>TckNo=$OTckNo</Set>
		<Exec func="PUB:ExecSql">
			<Arg name="SqlCmd" value="UpdTxnJnl"/>
		</Exec>
		<Set>VchSts=0</Set>
		<Set>ChkFlg=0</Set>
		<Set>DtlSts=0</Set>
		<Quote name="ProUpdVchBok"/>  <!--修改支付令状态-->
		<Quote name="ProUpdVchDtl"/>  <!--修改支付令明细状态-->
		<Set>TckNo=$NTckNo</Set>   <!--恢复非会计流水号-->
	</Macro>



	<Macro name="451720"> <!--电子渠道记账预处理-->
		<Set>HTxnCd=451720</Set>
		<Set>CrpCod=9999999999</Set>
		<Set>ActNo=$PayAct</Set>
		<Set>CDFlg1=D</Set>
		<Set>Smr=$VchSmr</Set>
		<Set>BilDat=$VchDat</Set>
		<Set>PayPsw=$Pin</Set>
		<Set>ActBk2=$BrNo</Set>
		<Set>ActBr2=$ActNod</Set>
		<Set>ActSq2=$ActSqn</Set>
		<Set>CDFlg2=C</Set>
		<Set>InAmt=$TxnAmt</Set>
		<Set>ActBk3=$BrNo</Set>
		<Set>ActBr3=$ActNod</Set>
		<Set>ActSq3=$ActSqn</Set>
		<Set>AccMod=1</Set>
		<Set>ActSts2=2</Set>
		<Set>ActFlg=2</Set>
		<Set>Fee=0</Set>
		<Set>CcyCod=CNY</Set>
		<Exec func="PFA:GenPrvData"> 
			<Arg name="Args" value="BusTyp"  desc=" "/>
			<Arg name="Args" value="CrpCod"  desc=" "/>
			<Arg name="Args" value="ActNo"   desc=" "/>
			<Arg name="Args" value="CDFlg1"  desc=" "/>
			<Arg name="Args" value="VchTyp"  desc=" "/>
			<Arg name="Args" value="VchNo"   desc=" "/>
			<Arg name="Args" value="TxnAmt"  desc=" "/>
			<Arg name="Args" value="BilDat"  desc=" "/>
			<Arg name="Args" value="PayPsw"  desc=" "/>
			<Arg name="Args" value="ActBk2"  desc=" "/>
			<Arg name="Args" value="ActBr2"  desc=" "/>
			<Arg name="Args" value="ActSq2"  desc=" "/>
			<Arg name="Args" value="CDFlg2"  desc=" "/>
			<Arg name="Args" value="InAmt"   desc=" "/>
			<Arg name="Args" value="ActBk3"  desc=" "/>
			<Arg name="Args" value="ActBr3"  desc=" "/>
			<Arg name="Args" value="ActSq3"  desc=" "/>
			<Arg name="Args" value="Smr"     desc=" "/>
			<Arg name="Args" value="AccMod"  desc=" "/>
			<Arg name="Args" value="ActSts2" desc=" "/>
			<Arg name="Args" value="ActFlg"  desc=" "/>
			<Arg name="Args" value="HSubCd"  desc=" "/>
		</Exec>
	</Macro>



	<Macro name="ProThdBok" desc="特色业务记帐宏">
		<Quote name="ProSubBal"/>  <!--扣减支付额度-->
		<Set>ActSts=1</Set>
		<Set>CcyCod=CNY</Set>
		<Switch expression="$HSubCd">
			<Case value="001">
				<Set>BusTyp=PFA53</Set>
				<Quote name="451720"/>  <!--CD到26201-->
			<Break/>
			</Case>
			<Case value="002">
				<Set>BusTyp=PFA60</Set>
				<Quote name="451720"/>  <!--CD到22301-->
			<Break/>
			</Case>
			<Case value="003">
				<Set>BusTyp=PFA51</Set>
				<Quote name="451720"/>  <!--CD到52101-->
			<Break/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=输入的主机交易子码不正确</Set>
				<Return/>
			</Default>
		</Switch>
		<Exec func="PUB:InsertJournal"/>
		<Exec func="PUB:CallHostOther" error="IGNORE">
			<Arg name="HTxnCd" value="$HTxnCd"/>
			<Arg name="ObjSvr" value="SHSTPUB1"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="0"> <!--交易成功-->
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Break/>
			</Case>
			<Case value="-1">  <!--上送主机超时-->
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=与主机通讯超时,请查询后抹帐</Set>
				<Exec func="PUB:UpdateJournal"/>
				<Return/>
			</Case>
			<Default>
				<Set>RspCod=$HRspCd</Set>
				<Set>RspMsg=上送主机失败</Set>
				<Exec func="PUB:UpdateJournal"/>
				<Set>AddFlg=1</Set>
				<Quote name="ProAddBal"/>  <!--加回支付额度-->
				<Set>ChkFlg=U</Set>
				<Set>DtlSts=U</Set>
				<Quote name="ProUpdVchDtl"/>  <!--修改支付令状态为"U-初始"-->
				<Exec func="PUB:ExecSql">   <!--清除支付登记表-->
					<Args>
						<Arg name="SqlCmd" value="DelVchBok" />
					</Args>
				</Exec>
				<Return/>
			</Default>
		</Switch>
		<Set>TTxnSt=S</Set>
		<Set>ActSts=2</Set>
		<Exec func="PUB:UpdateJournal"/>
		<Set>VchSts=2</Set>
		<Set>ChkFlg=1</Set>
		<Set>DtlSts=2</Set>
		<Set>BokTck=$TckNo</Set>
		<Quote name="ProUpdVchBok"/>  <!--修改支付令状态为"2-使用"-->
		<Quote name="ProUpdVchDtl"/>  <!--修改支付令明细状态-->
	</Macro>


	<Macro name="ProThdCan" desc="特色业务抹帐宏">
<!--检查原流水状态-->
		<Exec func="PUB:ReadRecord" error="IGNORE">
			<Arg name="sql" value="GetTxnJnl"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="-2">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Set>RspMsg=无此流水</Set>
				<Return/>
			</Case>
			<Case value="0">
				<If condition="IS_EQUAL_STRING($ActSts,3)">
					<Set>MsgTyp=N</Set>
					<Set>RspCod=000000</Set>
					<Set>RspMsg=凭证状态已抹帐</Set>
					<Return/>
				</If>
				<If condition="IS_NOEQUAL_STRING($ClrSts,0)">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=该笔业务已清算，不能抹帐</Set>
					<Return/>
				</If>
				<If condition="AND(IS_NOEQUAL_STRING($HTxnSt,S),IS_NOEQUAL_STRING($HTxnSt,T))">
					<Set>MsgTyp=N</Set>
					<Set>RspCod=000000</Set>
					<Set>RspMsg=凭证状态非【成功】【超时】不需抹帐</Set>
					<Return/>
				</If>
				<If condition="STRLEN(TRIM($PrvDat,right))&gt;0">
					<Exec func="PFA:ParsePrvData" >
						<Arg name="Args" value="PrvDat"/>
					</Exec>
				</If>
				<Set>LogNo=$OLogNo</Set>
				<Exec func="PUB:CallHostAcc">
					<Arg name="HTxnCd" value="959999"/>
					<Arg name="ObjSvr" value="SHSTPUB1"/>
				</Exec>
				<If condition="$RspCod=SC6034">     <!--交易已抹帐6034-->
					<Set>MsgTyp=N</Set>
					<Set>RspCod=000000</Set>
				</If>
				<If condition="$MsgTyp!=N">
					<Set>RspCod=$HRspCd</Set>
					<Return/>
				</If>
				<Set>HTxnSt=C</Set>
				<Set>TxnSts=C</Set>
				<Set>TTxnSt=C</Set>
				<Set>ActSts=3</Set>
				<Set>NTckNo=$TckNo</Set>   <!--保留非会计流水号-->
				<Set>TckNo=$OTckNo</Set>
				<Exec func="PUB:ExecSql">
					<Arg name="SqlCmd" value="UpdTxnJnl"/>
				</Exec>
				<Quote name="ProAddBal"/>  <!--加回支付额度-->
				<Set>VchSts=2</Set>
				<Exec func="PUB:ExecSql">
					<Args>
						<Arg name="SqlCmd" value="DelVchBok" />
					</Args>
				</Exec>
				<Set>ChkFlg=0</Set>
				<Set>DtlSts=U</Set>
				<Set>UseAmt=000000000000000</Set>
				<Quote name="ProUpdVchDtl"/>  <!--修改支付令明细状态-->
				<Set>TckNo=$NTckNo</Set>   <!--恢复非会计流水号-->
				<Break/>
			</Case>
			<Default>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=STRCAT(获取流水【,$OLogNo,】数据库操作失败)</Set>
				<Return/>
			</Default>
		</Switch>
	</Macro>
</FrontTab>
