<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="CBS" code="257" trace="yes" >
  <LibDeclare>
    <Library name="CBS" value="app/cbs/dll/cbs.so"/>
  </LibDeclare>
  <TableDeclare>
    <Table name="CbsTxnJnl" value="CbsTxnJnl"/>
    <Table name="CbsQryJnl" value="CbsQryJnl"/>
    <Table name="CbsBchSum" value="CbsBchSum"/>
    <Table name="CbsBchJnl" value="CbsBchJnl"/>
    <Table name="CbsNetDtl" value="CbsNetDtl"/>
    <Table name="CbsBankCd" value="CbsBankCd"/>
    <Table name="CbsBTxnCd" value="CbsBTxnCd"/>
    <Table name="CbsCodeCd" value="CbsCodeCd"/>
    <Table name="CbsSyIdCd" value="CbsSyIdCd"/>
    <Table name="CbsAreaCd" value="CbsAreaCd"/>
    <Table name="CbsFeeRpt" value="CbsFeeRpt"/>
    <Table name="CbsCenOrg" value="CbsCenOrg"/>
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="AplCls"    value="257"/>
    <Busdef name="TSDir"     value="dat/term/send/"/>
    <Busdef name="CbsIp"     value="182.53.5.188"/>
    <Busdef name="CbsUsr"    value="bfes"/>
    <Busdef name="CbsPwd"    value="bfes"/>
    <Busdef name="CbsSndDir" value="/home/bfes/frecv"/>
    <Busdef name="CbsRcvDir" value="/home/bfes/fsend"/>
    <Busdef name="IcsSndDir" value="dat/cbs/send"/>
    <Busdef name="IcsRcvDir" value="dat/cbs/recv"/>
    <Busdef name="IcsMsgDir" value="dat/cbs/msg"/>
    <Busdef name="IcsFilPth" value="dat/cbs/backup"/>
    <Busdef name="TrmFilPth" value="dat/term/recv"/>
  </BusDefDeclare>
  <ConfigDeclare>
    <Config name="BatFormat" value="app/cbs/etc/CBS_FMT.XML"/>
    <Config name="CBSCSW" value="app/cbs/etc/CBS_CSW.XML"/>
  </ConfigDeclare>

  <Define>
<!--通用数据库操作-->
    <Macro name="DbSele"> <!-- 通用数据库查询 -->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="$QrySen"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=数据库处理失败</Set>
        <Return/>
      </If>
    </Macro>
    <Macro name="DbExec"> <!-- 通用数据库处理 -->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="$QrySen"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=数据库处理失败</Set>
        <Return/>
      </If>
    </Macro>
<!--检查当前系统状态-->
    <Macro name="CbsSysSts"> <!-- 检查当前应用系统的状态 -->
      <DynSentence name="SysSts">
        <Sentence>
          select SysSts, LogFlg, CtlFlg, WorkDt from CbsRunCtl where TxnKnd='%s'
        </Sentence>
      <Fields>TxnKnd|</Fields>
      </DynSentence>
    </Macro>
    <Include file="etc/CBS_MCR2.XML"/>
  </Define>
<!--
*******************************往帐业务定时发起*********************************
-->
  <Transaction code="465899" desc="往帐汇兑业务定时发起" timeout="300">
    <Quote name="CbsSqlLst"/>
    <DynSentence name="Sql01">
      <Sentence>
        select TraKnd, SndBNo, SndDat, VchId, TxnKnd, ClrDat, LogNo, AccFlg, CcyCod, TxnAmt, TraTm, SvrCod, CshFlg, SmrCod, UsgCod, RSdFlg,
              TBusTp,  CardFg, AccKnd,  FeeTyp, PayFuc, AuthCd, PayLvl, SOpnBk, SndNod, RcvBNo, ROpnBk, RcvNod, Smr, OrgId, BilSts,
              case when substr(TxnKnd,1,4)='1001' then SndAct
                   when substr(TxnKnd,1,4)='3001' then RcvAct
               end SndAct,
              case when substr(TxnKnd,1,4)='1001' then SndNm
                   when substr(TxnKnd,1,4)='3001' then RcvNm
               end SndNm,
              case when substr(TxnKnd,1,4)='1001' then SndAdr
                   when substr(TxnKnd,1,4)='3001' then RcvAdr
               end SndAdr,
              case when substr(TxnKnd,1,4)='1001' then RcvAct
                   when substr(TxnKnd,1,4)='3001' then SndAct
               end RcvAct, 
              case when substr(TxnKnd,1,4)='1001' then RcvNm
                   when substr(TxnKnd,1,4)='3001' then SndNm
               end RcvNm,
              case when substr(TxnKnd,1,4)='1001' then RcvAdr
                   when substr(TxnKnd,1,4)='3001' then SndAdr
               end RcvAdr
          from CbsTxnJnl
         where TraKnd in ('1001','3001' ) and OIFlag='0' and BilSts in ( 'C', 'D' ) order by LogNo
          fetch first 100 rows only
      </Sentence>
    </DynSentence>
    <DynSentence name="Sql02">
      <Sentence>
        update CbsTxnJnl set BilSts='E'
          where TxnKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='0' and BilSts in ( 'C', 'D' ) 
      </Sentence>
      <Fields>TxnKnd|SndBNo|SndDat|VchId|</Fields>
    </DynSentence>
    <DynSentence name="Sql03">
      <Sentence>
        update CbsTxnJnl set BilSts='D', RSdFlg='%s'
          where TxnKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='0' and BilSts in ( 'C', 'D' ) 
      </Sentence>
      <Fields>RSdFlg|TxnKnd|SndBNo|SndDat|VchId|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Quote name="InitProc"/>
<!--遍历流水明细表-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="Sql01"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
<!--
        <Quote name="ChkSysSts"/>
        <If condition="IS_EQUAL_STRING($RunFlg,1)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=该状态不能发送汇兑业务</Set>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Return/>
        </If>
-->
<!--判断是否重发-->
        <If condition="IS_EQUAL_STRING($BilSts,D)">
          <Set>RSdFlg=1</Set>
        </If>
<!--应付接口需要-->
        <Set>TAccFlg=$AccFlg</Set>
        <Set>RspCod=000000</Set>
        <If condition="IS_EQUAL_STRING(SUBSTR($TxnKnd,1,4),1001)">
          <Set>MsgId=2202</Set>   <!--报文请求标志-->
        </If>
        <Else>
          <Set>MsgId=2402</Set>   <!--报文请求标志-->
        </Else>
<!--报文头-->
        <Set>SndTm=GETDATETIME(YYYYMMDDHHMISS)</Set>   <!--发送时间-->
        <Set>TrsTyp=1</Set>   <!--传输类型-->
        <Set>MsgStu=001245</Set>
        <Quote name="GetBusLog"/>   <!--获取信息流水号-->
        <Set>TraKnd=SUBSTR($TxnKnd,1,4)</Set>
        <Set>SndDpt=$SndBNo</Set>
        <Set>RcvDpt=$RcvBNo</Set>
        <Set>RefSeq=STRCAT(00,$LogNo)</Set>
        <Set>@MSG.FLG=1</Set>
        <Set>ClrDat=00000000</Set>
<!--接口中TxnKnd, TxnAmt, SndDat, CcyCod, SvrCod, CshFlg, SmrCod, UsgCod, AccFlg, TBusTp, CardFg, FeeTyp, PayFuc, AuthCd, PayLvl, 
          SndBNo, SOpnBk, SndNod, SndAct, SndNm, VchId, RcvBNo, ROpnBk, RcvNod, RcvAct, RcvNm, Smr
    接口中TraTm, ClrDat由接口自动生成
    接口中RsdFlg, BillFg由程序赋值-->
        <Set>QrySen=Sql03</Set>
        <Quote name="DbExec"/>
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=数据库操作失败Sql03</Set>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Return/>
        </If>
        <Exec func="PUB:CommitWork" />
        <Exec func="PUB:CallThirdAcc" error="IGNORE">
          <Arg name="HTxnCd" value="S01245" />
          <Arg name="ObjSvr" value="LTHDCBS1" />
        </Exec>
        <If condition="~RetCod!=0" >
          <Set>QrySen=Sql02</Set>
          <Quote name="DbExec"/>
          <Exec func="PUB:CommitWork" />
          <Continue/>
        </If>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>
<!--
*******************************往帐查询业务定时发起*********************************
-->
  <Transaction code="465898" desc="往帐查询业务定时发起" timeout="300">
    <Quote name="CbsSqlLst"/>
    <DynSentence name="Sql01">
      <Sentence>
        select TxnKnd, SndDat, QryTyp, OIFLag, SvrCod, SndBNo, MsgSeq, SOpnBk, RcvBNo, ROpnBk, PTraKnd, PriCls, ReqSeq,
               RspSeq,  PSndBNo, PRcvBNo, PSndDat, PClrDat, PTxnAmt, PCcyCod, PVchId, PPayAct, PPayNam, PGatAct,
               PGatNam, ReqSmr, RspSmr, CenLog
          from CbsQryJnl
         where OIFLag in ('0','1') and MatFlg='C'
      </Sentence>
    </DynSentence>
    <DynSentence name="Sql02">
      <Sentence>
        update CbsQryJnl set MatFlg='%s'
          where TxnKnd='%s' and SndDat='%s' and SndBNo='%s' and MsgSeq='%s' and OIFLag in ('0','1') and MatFlg='C'
      </Sentence>
      <Fields>MatFlg|TxnKnd|SndDat|SndBNo|MsgSeq|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Quote name="InitProc"/>
<!--检查系统状态-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="Sql01"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
<!--
        <Quote name="ChkSysSts"/>
        <If condition="IS_EQUAL_STRING($RunFlg,1)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=该状态不能发送查询查复业务</Set>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Return/>
        </If>
-->
<!--应付接口需要-->
        <Set>RspCod=000000</Set>
        <Set>SndTm=GETDATETIME(YYYYMMDDHHMISS)</Set> <!--发送时间-->
        <Quote name="GetBusLog"/>   <!--获取信息流水号-->
        <Set>TraKnd=SUBSTR($TxnKnd,1,4)</Set> <!--交易类型-->
        <Set>TrsTyp=1</Set> <!--传输类型-->
        <Set>@MSG.FLG=1</Set>
<!--拼接115数据元-->
        <Set>SevTyp=1</Set>  <!--固定格式报文-->
        <If condition="IS_EQUAL_STRING($OIFlag,0)">
          <Set>RefSeq=0000000000000000</Set> <!--查询-->
          <Set>Smr=$ReqSmr</Set>
          <Set>MsgId=2222</Set>  <!--报文请求标志-->
        </If>
        <Else>
          <Set>RefSeq=$MsgSeq</Set>
          <Set>Smr=$RspSmr</Set>
          <Set>MsgId=2232</Set>  <!--报文请求标志-->
        </Else>
        <Set>NSndDat=STRCAT($PSndDat,000000)</Set>
        <Set>NCcyCod=ADDCHAR($PCcyCod,32, ,0)</Set>
        <Switch expression="$QryTyp">
          <Case value="000">
            <Break/>
          </Case>
          <Case value="001">
            <Break/>
          </Case>
          <Case value="002">
            <Break/>
          </Case>
          <Case value="003"/>
          <Case value="006">
            <Set>SevInf=STRCAT($RefSeq,$TraKnd,$PriCls,$ReqSeq,$RspSeq,$PSndBNo,$PRcvBNo,$NSndDat,$PClrDat,$PTxnAmt,$NCcyCod,$PVchId,$Smr)</Set>
            <Break/>
          </Case>
          <Case value="004"/>
          <Case value="005">
            <Set>SevInf=STRCAT($RefSeq,$TraKnd,$PriCls,$ReqSeq,$RspSeq,$PSndBNo,$PRcvBNo,$NSndDat,$PClrDat,$PTxnAmt,$NCcyCod,$PVchId,$PPayAct,$PPayNam,$PGatAct,$PGatNam,$Smr)</Set>
            <Break/>
          </Case>
          <Case value="999">
            <Set>SevInf=$Smr</Set>
            <Break/>
          </Case>
        </Switch>
        <Exec func="PUB:CallThirdOther" error="IGNORE" >
          <Arg name="TxnCod" value="S00145" />
          <Arg name="ObjSvr" value="LTHDCBS1"/>
        </Exec>
        <If condition="~RetCod!=0" >
          <Set>MatFlg=E</Set>
          <Set>QrySen=Sql02</Set>
          <Quote name="DbExec"/>
          <Exec func="PUB:CommitWork" />
          <Continue/>
        </If>
        <If condition="IS_EQUAL_STRING($OIFlag,0)">
          <Set>MatFlg=0</Set> <!--查询未查复-->
        </If>
        <Else>
          <Set>MatFlg=1</Set>  <!--收到查询已查复-->
        </Else>
        <Set>QrySen=Sql02</Set>
        <Quote name="DbExec"/>
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=数据库操作失败Sql04</Set>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Return/>
        </If>
        <Exec func="PUB:CommitWork" />
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>
<!--
*******************************定期借(贷)文件接收及ACK回应*********************************
-->
  <Transaction code="465897" desc="定期借(贷)文件接收及ACK回应" timeout="300">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Quote name="InitProc"/>
      <Exec func="PUB:IsWorkDate">
        <Arg name="Date" value="$ActDat"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,1)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=非工作日，不能做批量业务</Set>
        <Return/>
      </If>
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <System command="CbsFilGet.sh" error="IGNORE">
        <Arg name="IPADDR"   value="$CbsIp"/>
        <Arg name="ActDat"   value="$ActDat"/>
        <Arg name="CBSUSR"   value="$CbsUsr"/>
        <Arg name="CBSPWD"   value="$CbsPwd"/>
        <Arg name="CBSSNDDIR" value="$CbsSndDir"/>
        <Arg name="ICSRCVDIR" value="$IcsRcvDir"/>
        <Arg name="RCVFILLST" value="TXNTYP*"/>
      </System>
      <If condition="~RetCod!=0">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=获取CBS批量数据文件出错或批量数据文件不存在</Set>
        <Return/>
      </If>
      <Set>RcvLstFil=STRCAT( $IcsRcvDir,/RcvFilLst_,$ActDat )</Set>
      <Set>SndLstFil=STRCAT( $IcsSndDir,/SndFilLst_,$ActDat )</Set>
      <Set>DelLstFil=STRCAT( $IcsSndDir,/DelFilLst_,$ActDat )</Set>
      <Exec func="CBS:CbsFLstToDb" error="IGNORE">
        <Args>
          <Arg name="RcvLstFil" value="$RcvLstFil"/>
          <Arg name="RcvDir"    value="$IcsRcvDir"/>
          <Arg name="SndLstFil" value="$SndLstFil"/>
          <Arg name="SndDir"    value="$IcsSndDir"/>
          <Arg name="DelLstFil" value="$DelLstFil"/>
        </Args>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=处理CBS批量数据文件列表出错</Set>
        <Return/>
      </If>
      <System command="CbsFilAckPut.sh" error="IGNORE">
        <Arg name="IPADDR"    value="$CbsIp"/>
        <Arg name="ActDat"    value="$ActDat"/>
        <Arg name="CBSUSR"    value="$CbsUsr"/>
        <Arg name="CBSPWD"    value="$CbsPwd"/>
        <Arg name="CBSSNDDIR" value="$CbsSndDir"/>
        <Arg name="ICSSNDDIR" value="$IcsSndDir"/>
        <Arg name="CBSRCVDIR" value="$CbsRcvDir"/>
        <Arg name="ICSRCVDIR" value="$IcsRcvDir"/>
      </System>
      <If condition="~RetCod!=0">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=处理CBS批量数据回应文件出错</Set>
        <Return/>
      </If>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>
<!--
*******************************接收定期借(贷)记明细文件*********************************
-->
  <Transaction code="465896" desc="接收定期借(贷)记明细文件" timeout="600">
    <DynSentence name="GetBchSumInf">
      <Sentence>
        select TraKnd, OIFlag, FilNam, ClrFil  from CbsBchSum where ( OIFlag='1' and BchSts='U' ) or ( OIFlag='0' and BchSts='R' )
      </Sentence>
    </DynSentence>
    <DynSentence name="UpdPubBatInf"> <!--修改本批次为确认状态，启动大小通道发送-->
      <Sentence>
        update PubBatInf set CCYCOD = 'CNY', OrnCnt ='%s', ORNAMT = '000000000000000', SUCCNT = '00000000', SUCAMT = '000000000000000', FALCNT = '00000000', FALAMT = '000000000000000', CHKFLG = '1' where DSKNO = '%s'
      </Sentence>
      <Fields>OrnCnt|DskNo|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Quote name="InitProc"/>
<!--
<Exec func="PUB:Unlock">
  <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
</Exec>
-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetBchSumInf"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
<!--大小通道参数-->
        <Set>ObjSvr=OFRTCBS5</Set>
        <Set>SumFlg=N</Set>          <!--是否进行金额或数量汇总-->
        <Set>NamChk=1</Set>          <!--不需要检查户名-->
        <Set>TxnMod=1</Set>          <!--需要单笔上送-->
        <Set>CmtFlg=0</Set>          <!--大小通道发送状态-->
        <Set>TrdTbl=CbsBchJnl</Set>
        <Set>HTxnCd=465895</Set>
        <Set>HTxnSt=U</Set>
        <Delete>FTxnCd</Delete>
        <Delete>DskNo</Delete>
        <Exec func="PUB:RegisterBatchDiskNo"/>
        <Set>TxnCnl=CBS</Set>
        <Set>TTxnCd=465896</Set>
        <Set>TxnObj=OFRTCBS5</Set>
        <If condition="IS_EQUAL_STRING($OIFlag,1)">
          <Set>DtlFil=STRCAT(GETENV(WORKDIR),/,$IcsRcvDir,/,$FilNam,.dat)</Set> 
        </If>
        <Else>
          <Set>DtlFil=STRCAT(GETENV(WORKDIR),/,$IcsRcvDir,/,$ClrFil,.dat)</Set> 
        </Else>
        <Exec func="CBS:CbsFDtlToDb" error="IGNORE"/>
        <If condition="~RetCod!=0">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=处理CBS批量数据文件出错</Set>
          <Return/>
        </If>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="UpdPubBatInf"/>
          </Args>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Exec func="PUB:Unlock">
            <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=STRCAT(更新大小通道【PubBatInf】表状态错)</Set>
          <Return/>
        </If>
        <Exec func="PUB:CommitWork" />
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>
<!--
*******************************批量业务提交记帐*********************************
-->
  <Transaction code="465895" desc="批量业务提交记帐" timeout="30">
    <Quote name="CbsSqlLst"/>
    <DynSentence name="ChkPfaCusAgr">
      <Sentence>
        select PfaSub, BCusId, SubCod, EConTp, PrjCod, DptCod, BrNo from PfaCusAgr where AgrNo='%s'
      </Sentence>
      <Fields>AgrNo|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
<!--根据接收人帐号获取帐户性质、记帐帐号-->
      <Delete>LActFg</Delete>
      <Delete>BokAct</Delete>
      <Set>OBilsts=$BilSts</Set>
      <Exec func="CBS:CbsGetAccFlg" error="IGNORE">
        <Args>
          <Arg name="RcvAct" value="$RcvAct"/>
        </Args>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>BilSts=E</Set>
        <Set>TckNo= </Set>
        <Set>ActFlg= </Set>
        <Set>BokAct= </Set>
        <Goto>UpdTag</Goto>
      </If>
      <Set>ActTyp=$LActFg</Set>
      <Set>ActNo=$BokAct</Set>
<!--根据帐号查找户名并检查户名是否相符-->
      <If condition="IS_EQUAL_STRING($TraKnd,1051)">
        <Switch expression="$ActTyp">
          <Case value="0">   <!--对公-->
            <Set>HTxnCd=109000</Set>
            <Break/>
          </Case>
          <Case value="1"/>  <!--存折-->
          <Case value="2"/>  <!--存折-->
          <Case value="4">   <!--卡-->
            <Set>HTxnCd=476520</Set>
            <Break/>
          </Case>
        </Switch>
        <Exec func="PUB:CallHostOther" error="IGNORE">
          <Arg name="HTxCd"  value="$HTxnCd" />
          <Arg name="ObjSvr" value="SHSTPUB1" />
        </Exec>
        <If condition="IS_NOEQUAL_STRING(DELSPACE($ActNam,both),$RcvNm)">
          <Set>BilSts=E</Set>
          <Set>HRspCd=CBS999</Set>
          <Goto>UpdTag</Goto>
        </If>
      </If>
      <Quote name="ChkBnkInf"/> <!--获取记帐中会计分录的分户序号-->
      <If condition="AND(IS_EQUAL_STRING($OIFlag,1),IS_EQUAL_STRING($TraKnd,1052))">   <!--零余额借记-->
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="ChkPfaCusAgr" />
          </Args>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE" />
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=数据库处理失败</Set>
          <Return/>
        </If>
        <If condition="~RetCod=0">
<!--保留原信息-->
          <Set>OTxnCd=$TxnCod</Set>
          <Set>OTTxnCd=$TTxnCd</Set>
          <Set>OOIFlag=$OIFlag</Set>
          <Switch expression="$PfaSub">
            <Case value="001">   <!--广东省财政-->
              <Set>PayAct=$BokAct</Set>
              <Set>PayNam=$RcvNm</Set>
              <Set>BankNo=$RcvBNo</Set>
              <Quote name="ChkBankCd"/>
              <Set>PayBNm=$BankNm</Set>
              <Set>PyeAct=$SndAct</Set>
              <Set>PyeNam=$SndNm</Set>
              <Set>BankNo=$SndBNo</Set>
              <Quote name="ChkBankCd"/>
              <Set>PyeBNm=$BankNm</Set>
              <Set>VchDat=$ActDat</Set>
              <Set>TOIFlg=O</Set>
              <Set>VchSmr=$Smr</Set>
              <Set>ActSqn=$AccSq08</Set>
              <Set>ActNod=$CtlNod</Set>
              <Set>NodNo=$CtlNod</Set>
              <Set>HSubCd=003</Set>
              <Exec func="PUB:CallThirdOther" error="IGNORE">
                <Arg name="TxnCod" value="461181"/>
                <Arg name="ObjSvr" value="STHDCBS1"/>
              </Exec>
              <Break/>
            </Case>
            <Case value="999">   <!--中央财政-->
              <Set>BrNam=@BCFG.BrNam</Set>
              <Set>EleBk=@BCFG.EleBk</Set>
              <Set>APVchN=$LogNo</Set>
              <Set>PayCod=$SubCod</Set>
              <Set>FinAre=999</Set>
              <Set>ActNo=$BokAct</Set>
              <Set>ActNam=$RcvNm</Set>
              <Set>BankNo=$RcvBNo</Set>
              <Quote name="ChkBankCd"/>
              <Set>ANodNm=$BankNm</Set>
              <Set>PyeAct=$SndAct</Set>
              <Set>PyeNam=$SndNm</Set>
              <Set>BankNo=$SndBNo</Set>
              <Quote name="ChkBankCd"/>
              <Set>PyeBk=$BankNm</Set>
              <Set>UdwDat=$ActDat</Set>
              <Set>ActSqn=$AccSq08</Set>
              <Set>ActNod=$CtlNod</Set>
              <Set>StlMod=07</Set>
              <Set>AthAmt=$TxnAmt</Set>
              <Set>VInTlr=$TlrId</Set>
              <Set>VRgNod=$CtlNod</Set>
              <Set>HSubCd=003</Set>
              <Exec func="PUB:CallThirdOther" error="IGNORE">
                <Arg name="TxnCod" value="363412"/>
                <Arg name="ObjSvr" value="STHDFAP2"/>
              </Exec>
              <Break/>
            </Case>
          </Switch>
          <If condition="IS_EQUAL_STRING($TRspCd,000000)">
            <Set>BilSts=Z</Set>
            <Set>HTxnSt=S</Set>
            <Set>HRspCd=SC0000</Set>
          </If>
          <Else>
            <Set>BilSts=E</Set>
            <Set>HTxnSt=F</Set>
            <Set>HRspCd=$TRspCd</Set>
          </Else>
<!--恢复原数据-->
          <Set>TxnCod=$OTxnCd</Set>
          <Set>TTxnCd=$OTTxnCd</Set>
          <Set>OIFlag=$OOIFlag</Set>
          <Delete>BankNm</Delete>
          <Delete>BrNo</Delete>
          <Goto>UpdTag</Goto>
        </If>
      </If>
      <Switch expression="$OIFlag">
        <Case value="0">   <!--往帐-->
          <Switch expression="$TraKnd">
            <Case value="1051">   <!--定期(批量)贷记、行内客户暂不考虑-->
              <If condition="IS_EQUAL_STRING($ActTyp,0)">   <!--对公-->
                <Set>HTxnCd=451900</Set>
                <Set>HTxnSb=025</Set>
                <Set>BusTyp=LBE75</Set>
                <Set>CrpCod=CBS999999999</Set>
                <If condition="IS_NOEQUAL_STRING(SUBSTR($SOpnBk,4,3),SUBSTR($ROpnBk,4,3))">
                  <Set>RemFlg=1</Set>
                  <Set>MSBr=$NodNo</Set>
                  <Set>MRBr=$OpnNod</Set>
                  <Set>MRBk=$OpnBr</Set>
                </If>
                <Set>RgCFlg=1</Set>
                <Set>ActBk1=$BrNo</Set>
                <Set>ActBr1=$NodNo</Set>
                <Set>ActSq1=$AccSq10</Set>
                <Set>CdFlg1=D</Set>
                <Set>CcyCd1=$CcyCod</Set>
                <Set>OuAmt1=$TxnAmt</Set>
                <Set>PayAt5=$BokAct</Set>
                <Set>ActBk5=$OpnBr</Set>
                <Set>ActBr5=$OpnNod</Set>
                <Set>RGFlg5=0</Set>
                <Set>OvrSe5=0</Set>
                <Set>CdFlg5=C</Set>
                <Set>CcyCd5=$CcyCod</Set>
                <Set>InAmt5=$TxnAmt</Set>
              </If>
              <Else>   <!--对私-->
                <Set>HTxnCd=471280</Set>
                <Set>BusTyp=CBS61</Set>
                <Set>CnlTyp=L</Set>
                <Set>Mask=0806</Set>
                <Set>TxnSub=011</Set>
                <Set>ActNo=$BokAct</Set>
                <Set>VchChk=0</Set>
                <Set>FeeSeq=$AccSq10</Set>
                <Set>FeeBr=$CtlNod</Set>
                <If condition="(IS_EQUAL_STRING($ActTyp,1),IS_EQUAL_STRING($ActTyp,2))">   <!--存折-->
                  <Set>VchCod=00000000</Set>
                </If>
                <Set>ActFlg=$ActTyp</Set>
              </Else>
              <Break/>
            </Case>
            <Case value="1052"/>   <!--定期借记（从客户到2621）-->
            <Case value="1053">    <!--批量代收（从客户到2621）-->
              <If condition="IS_EQUAL_STRING($ActTyp,0)">   <!--对公-->
                <Set>HTxnCd=451720</Set>
                <Set>BusTyp=CBS53</Set>
                <Set>CrpCod=CBS999999999</Set>
                <If condition="IS_NOEQUAL_STRING(SUBSTR($SOpnBk,4,3),SUBSTR($ROpnBk,4,3))">
                  <Set>RemFlg=1</Set>
                </If>
                <Set>RgDFlg=1</Set>
                <Set>ActNo=$BokAct</Set>
                <Set>OvrSe1=0</Set>
                <Set>CDFlg1=D</Set>
                <Set>ActBk2=$BrNo</Set>
                <Set>ActBr2=$CtlNod</Set>
                <Set>ActSq2=$AccSq08</Set>
                <Set>CDFlg2=C</Set>
                <Set>InAmt=$TxnAmt</Set>
              </If>
              <Else>
                <Set>HTxnCd=471180</Set>
                <Set>BusTyp=CBS51</Set>
                <Set>CnlTyp=L</Set>
                <Set>ActFlg=$ActTyp</Set>
                <Set>Mask=0805</Set>
                <Set>SubCod=001</Set>
                <Set>ActNo=$BokAct</Set>
                <Set>PayMod=0</Set>
                <Set>ActSeq=$AccSq05</Set>
                <Set>VchChk=0</Set>
                <Set>CAgtNo=CBS999999999</Set>
              </Else>
              <Break/>
            </Case>
          </Switch>
          <Break/>
        </Case>
        <Case value="1">   <!--来帐-->
          <Switch expression="$TraKnd">
            <Case value="1051">   <!--批量或定期贷记（从5210到客户）-->
              <If condition="IS_EQUAL_STRING($ActTyp,0)">   <!--对公-->
                <Set>HTxnCd=451820</Set>
                <Set>HTxnSb=002</Set>
                <Set>BusTyp=CBS52</Set>
                <Set>CrpCod=CBS999999999</Set>
                <Set>RgCFlg=0</Set>
                <Set>OActBk=$BrNo</Set>
                <Set>OActBr=$CtlNod</Set>
                <Set>OActSq=$AccSq07</Set>
                <Set>CDFlg1=D</Set>
                <Set>ActNo=$BokAct</Set>
                <Set>OvrSe2=1</Set>
                <Set>CDFlg2=C</Set>
                <Set>PyeAmt=$TxnAmt</Set>
              </If>
              <Else>   <!--对私-->
                <Set>HTxnCd=471400</Set>
                <Set>BusTyp=CBS52</Set>
                <Set>CnlTyp=L</Set>
                <Set>Mask=0806</Set>
                <Set>TxnSub=002</Set>
                <Set>IActNo1=$BokAct</Set>
                <Set>TxnAmt1=$TxnAmt</Set>
                <Set>CcyCod1=$CcyCod</Set>
                <Set>VchCod=00000000</Set>
                <Set>PrtFlg=1</Set>
                <Set>IActNo2=$AccIn03</Set> 
                <Set>TxnAmt2=$TxnAmt</Set>
                <Set>CcyCod2=$CcyCod</Set>
                <Set>CcyTyp=1</Set>
                <Set>VchChk=0</Set>
                <Set>PayMod=0</Set>
                <If condition="OR(IS_EQUAL_STRING($ActTyp,1),IS_EQUAL_STRING($ActTyp,2))">   <!--存折-->
                  <Set>VchTyp= </Set>
                  <Set>VchCod=00000000</Set>
                </If>
                <Else>
                  <Set>VchTyp=007</Set>
                </Else>
                <Set>ActFlg=$ActTyp</Set>
              </Else>
              <Break/>
            </Case>
            <Case value="1052"/>   <!--定期借记（从客户到5210）-->
            <Case value="1053">    <!--批量代收（从客户到5210）-->
              <If condition="IS_EQUAL_STRING($ActTyp,0)">   <!--对公-->
                <Set>HTxnCd=451720</Set>
                <Set>BusTyp=CBS51</Set>
                <Set>CrpCod=CBS999999999</Set>
                <Set>RgDFlg=0</Set>
                <Set>ActNo=$BokAct</Set>
                <Set>OvrSe1=0</Set>
                <Set>CDFlg1=D</Set>
                <Set>ActBk2=$BrNo</Set>
                <Set>ActBr2=$CtlNod</Set>
                <Set>ActSq2=$AccSq08</Set>
                <Set>CDFlg2=C</Set>
                <Set>InAmt=$TxnAmt</Set>
              </If>
              <Else>
                <Set>HTxnCd=472280</Set>
                <Set>TxnSub=001</Set>
                <Set>BusTyp=CBS51</Set>
                <Set>CnlTyp=L</Set>
                <Set>ActNo=$BokAct</Set>
                <If condition="OR(IS_EQUAL_STRING($ActTyp,1),IS_EQUAL_STRING($ActTyp,2))">   <!--存折-->
                  <Set>VchTyp= </Set>
                  <Set>VchCod=00000000</Set>
                </If>
                <Else>
                  <Set>VchTyp=007</Set>
                </Else>
                <Set>ActFlg=$ActTyp</Set>
                <Set>PayMod=0</Set>
                <Set>TrkMod=0</Set>
                <Set>Mask=0805</Set>
                <Set>VchChk=0</Set>
                <Set>CAgtNo=PFT999999999</Set>
                <Set>IBrNo=$BrNo</Set>
                <Set>IActNo=$CtlNod</Set>
                <Set>ActSeq=$AccSq08</Set>
                <Set>FeeCod=0000</Set>
<!--
                <Set>Smr=代扣</Set>
-->
              </Else>
              <Break/>
            </Case>
          </Switch>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:CallHostAcc" error="IGNORE" >
        <Arg name="TxnCod" value="$HTxnCd" />
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="AND(INTCMP(~RetCod,3,0),OR(IS_EQUAL_STRING($HRspCd,SC0000),IS_EQUAL_STRING($HRspCd,SD0016)))">
        <If condition="IS_EQUAL_STRING($OIFlag,0)">
          <Set>BilSts=G</Set>
        </If>
        <Else>
          <Set>BilSts=Z</Set>
        </Else>
      </If>
      <Else>
        <Set>BilSts=E</Set>
      </Else>
      <Label>UpdTag</Label>
      <Exec func="PUB:CodeSwitching" error="IGNORE">
        <Arg name="DatSrc"  value="CBSCSW"/>
        <Arg name="SourNam" value="HRspCd"/>
        <Arg name="DestNam" value="RtnCod"/>
        <Arg name="TblNam"  value="HRspCdToRtnCod"/>
      </Exec>
      <Exec func="PUB:UpdateRecord">
        <Arg name="TblNam" value="CbsBchJnl"/>
        <Arg name="CndSts" value="UpdJnlDat"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Exec func="PUB:PutResponse"/>
    </FlowCtrl>
  </Transaction>
<!--
*******************************文件类定期借记(2212)来帐返回业务回应*********************************
-->
  <Transaction code="465894" desc="文件类定期借记(2212)来帐返回业务回应" timeout="300">
    <DynSentence name="Sql01">
      <Sentence>
        select ClrDat, ClrSce, SSysId, SndBNo, RSysId, RcvBNo, TraKnd, FilNam RefFil, BchSqn RefSqn, TotNum, TotAmt
          from CbsBchSum where TraKnd='1052' and OIFlag='1' and BchSts in ('B','R')
      </Sentence>
    </DynSentence>
    <DynSentence name="Sql02">
      <Sentence>
          select 'Y' YN from TABLE(VALUES(1)) AS anony
         where EXISTS ( select 'Y' from CbsBchJnl where FilNam='%s' and OIFlag='1' and BilSts in ( 'P','B' ) )
      </Sentence>
      <Fields>RefFil|</Fields>
    </DynSentence>
    <DynSentence name="Sql03">
      <Sentence>
        select count(*) RefNum, COALESCE(sum(bigint(TxnAmt)),0) RefAmt
          from CbsBchJnl where FilNam='%s' and OIFlag='1' and ( BilSts='E' or HRspCd not in ('SC0000','SD0016'))
      </Sentence>
      <Fields>RefFil|</Fields>
    </DynSentence>
    <DynSentence name="Sql06">
      <Sentence>
        select count(*) SucNum
          from CbsBchJnl where FilNam='%s' and OIFlag='1' and BilSts='Z' and HRspCd in ('SC0000', 'SD0016')
      </Sentence>
      <Fields>RefFil|</Fields>
    </DynSentence>
<!--
    <DynSentence name="Sql03">
      <Sentence>
        select substr(right( ('0000000000'||rtrim(char(count(*)))),10),1,10) RefNum, substr(right('0000000000000000'||rtrim(char(value(sum(bigint(TxnAmt)),0))),16),1,16) RefAmt
          from CbsBchJnl where FilNam='%s' and (BilSts='E' or HRspCd !='SC0000')
      </Sentence>
      <Fields>RefFil|</Fields>
    </DynSentence>
    <DynSentence name="Sql04">
      <Sentence>
        select MsgSqn RefMsg,TraKnd,TxnKnd,TxnAmt,TraTm,SndDat,CcyCod,SvrCod,CenTm,CenLog,ThdTm,ThdLog,RtnCod,
                CshFlg,SmrCod,UsgCod,RSdFlg,AccFlg,TBusTp,CardFg,FeeTyp,PayFuc,AuthCd,PayLvl,SndBNo,SOpnBk,SndNod,
                SndAct,SndNm,VchId,RcvBNo,ROpnBk,RcvNod,RcvAct,RcvNm,AgrNo, Smr
          from CbsBchJnl where FilNam='%s' and (BilSts='E' or HRspCd !='SC0000')
      </Sentence>
      <Fields>RefFil|</Fields>
    </DynSentence>
-->
    <DynSentence name="Sql04">
      <Sentence>
        select MsgSqn,TraKnd,TxnKnd,TxnAmt,TraTm,SndDat,ClrDat,CcyCod,SvrCod,CenTm,CenLog,ThdTm,ThdLog,RtnCod,
                CshFlg,SmrCod,UsgCod,RSdFlg,TBusTp,AccFlg,CardFg,AccKnd,FeeTyp,PayFuc,AuthCd,PayLvl,SndBNo,SOpnBk,
                SndNod,SndAct,SndNm,VchId,RcvBNo,ROpnBk,RcvNod,RcvAct,RcvNm,AgrNo,Smr, SecKey, SndAdr, RcvAdr
          from CbsBchJnl where FilNam='%s' and OIFlag='1' and ( BilSts='E' or HRspCd not in ('SC0000','SD0016') )
      </Sentence>
      <Fields>RefFil|</Fields>
    </DynSentence>
    <DynSentence name="Sql05">
      <Sentence>
        update CbsBchSum set BchSts='R', RefNum='%s', RefAmt='%s', ClrFil='%s'
         where FilNam='%s' and OIFlag='1' and BchSts in ('B','R')
      </Sentence>
      <Fields>RefNum|RefAmt|SndFil|RefFil|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Quote name="InitProc"/>
<!--
<Exec func="PUB:Unlock">
  <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
</Exec>
-->
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql"        value="Sql01"/>
        <Arg name="CursorName" value="CURSOR_1"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE">
          <Arg name="CursorName" value="CURSOR_1"/>
        </Exec>
        <If condition="~RetCod=100">
          <Break/>
        </If>
<!--
    判断文件记录是否已经处理完毕( Bilsts不为P或B )
-->
        <Set>QrySen=Sql02</Set>
        <Quote name="DbSele"/>
        <If condition="~RetCod=-2">
<!--生成报文头-->
          <Exec func="PUB:GetLogNo"/>
          <Set>BchSqn=SUBSTR($LogNo,7,8)</Set>
          <Set>NewFil=STRCAT(TXNTYP,2212,105201,1006,$ActDat,$BchSqn,XXXXXXXX)</Set>
          <Set>RspFil=STRCAT(GETENV(WORKDIR),/,$IcsSndDir,/,$NewFil)</Set>
<!--删除上次使用的数据-->
          <Delete>RefNum</Delete>
          <Delete>RefAmt</Delete>
          <Delete>SucNum</Delete>
<!--通过加总扣款成功和扣款失败记录是否等于总数，判断是否完成帐务处理-->
          <Set>QrySen=Sql03</Set>
          <Quote name="DbSele"/>
          <Set>QrySen=Sql06</Set>
          <Quote name="DbSele"/>
          <Set>TotNum1=ADDCHAR(ADD($RefNum,$SucNum),10,0,1)</Set>
          <If condition="IS_NOEQUAL_STRING($TotNum,$TotNum1)">
            <Set>RspMsg=明细记录处理总数不匹配</Set>
            <Continue/>
          </If>
<!--满足人行要求数据变形-->
          <Set>RefNum=ADDCHAR($RefNum,10,0,1)</Set>
          <Set>RefAmt=ADDCHAR($RefAmt,16,0,1)</Set>
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$RspFil"/>
            <Arg name="OpenMode" value="w"/>
            <Arg name="Data"     value="00000000"/> <!--清算日期-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="0"/> <!--清算场次-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$SSysId"/> <!--发起方系统号-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$SndBNo"/> <!--发起方代码-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$RSysId"/> <!--接收方系统号-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$RcvBNo"/> <!--接收方代码-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$TraKnd"/> <!--交易种类-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$NewFil"/> <!--文件名-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$RefFil"/> <!--参照文件名-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$BchSqn"/> <!--批量包序号-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$RefSqn"/> <!--参考批量包序号-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="00000000"/> <!--客户批量包序号-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$TotNum"/> <!--交易总笔数-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$TotAmt"/> <!--交易总金额-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$RefNum"/> <!--拒绝支付总笔数-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="$RefAmt"/> <!--拒绝支付总金额-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="        "/> <!--返回码-->
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="                "/> <!--预留位-->
            <Arg name="Data"     value="|"/>
            <Arg name="ESCFMT"   value="\\n"/>
          </Exec>
<!--获取文件体-->
          <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="sql" value="Sql04"/>
            <Arg name="CursorName" value="CURSOR_2"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Exec func="PUB:CloseCursor" error="IGNORE">
              <Arg name="CursorName" value="CURSOR_1"/>
            </Exec>
            <Exec func="PUB:CloseCursor" error="IGNORE">
              <Arg name="CursorName" value="CURSOR_2"/>
            </Exec>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
            </Exec>
            <Return/>
          </If>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE">
              <Arg name="CursorName" value="CURSOR_2"/>
            </Exec>
            <If condition="~RetCod=100">
              <Break/>
            </If>
            <Set>RefMsg=STRCAT(1006,SUBSTR($LogNo,3,12))</Set>
<!--部分字段赋值-->
            <Set>CenTm=00000000000000</Set>
            <Set>CenLog=0000000000000000</Set>
            <Set>ThdTm=GETDATETIME(YYYYMMDDHHMISS)</Set>
            <If condition="IS_EQUAL_STRING($SecKey,ABCDEFGHIJKLMNOPQRSTUVWXYZ)">
              <Set>SecKey=                                        </Set>
            </If>
            <If condition="IS_EQUAL_STRING($AgrNo,ABCDEFGHIJKLMNOPQRSTUVWXYZ)">
              <Set>AgrNo=                                                            </Set>
            </If>
<!--若非空则用空格补满-->
            <Set>Seckey=ADDCHAR($Seckey,40, ,0)</Set>
            <Set>AgrNo=ADDCHAR($AgrNo,60, ,0)</Set>
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$RspFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"     value="$MsgSqn"/> <!--信息序号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$RefMsg"/> <!--参照信息序号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="2212"/> <!--报文类型标识-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$TxnKnd"/> <!--交易类型细分-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$TxnAmt"/> <!--交易金额-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$TraTm" /> <!--交易发起日期和时间-->
              <Arg name="Data"     value="||"/>      <!--直接清算行-->
              <Arg name="Data"     value="$SndDat"/> <!--委托日期-->
              <Arg name="Data"     value="000000" /> <!--委托日期低位补零-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$ClrDat"/> <!--清算日期-->
              <Arg name="Data"     value="|||"/>     <!--查询通知种类标识、地区号-->
              <Arg name="Data"     value="$CcyCod"/> <!--交易货币代码-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$SvrCod"/> <!--服务点输入方式码-->
              <Arg name="Data"     value="|||"/>     <!--中心客户号、企业客户号-->
              <Arg name="Data"     value="$CenTm" /> <!--中心交易受理日期时间-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$CenLog"/> <!--中心交易受理号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$ThdTm" /> <!--业务处理方处理日期时间-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$ThdLog"/> <!--业务处理方流水号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$RtnCod"/> <!--返回码-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$CshFlg"/> <!--现金转账标识-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$SmrCod"/> <!--摘要代码-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$UsgCod"/> <!--资金用途代码-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$RSdFlg"/> <!--重发标识-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$AccFlg"/> <!--对公对私标识-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$TBusTp"/> <!--业务种类-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$CardFg"/> <!--卡折标识-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$AccKnd"/> <!--钞户汇户标识-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$FeeTyp"/> <!--手续费方式-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$PayFuc"/> <!--支付工具-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$AuthCd"/> <!--授权码-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$PayLvl"/> <!--支付优先级-->
              <Arg name="Data"     value="||"/>      <!--原交易业务唯一标识-->
              <Arg name="Data"     value="$SndBNo"/> <!--发起行行号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$SOpnBk"/> <!--发起人开户行行号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$SndNod"/> <!--发起行网点号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$SndAct"/> <!--发起人账号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$SndNm" /> <!--发起人名称-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$VchId" /> <!--凭证提交号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$RcvBNo"/> <!--接收行行号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$ROpnBk"/> <!--接收人开户行行号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$RcvNod"/> <!--接收行网点号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$RcvAct"/> <!--接收人账号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$RcvNm" /> <!--接收人名称-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$AgrNo" /> <!--多方协议号-->
              <Arg name="Data"     value="|||||||||"/> <!--运行状态、贷方金额、笔数、借方金额、笔数、交易种类、旧登陆标识、新登陆标识-->
              <Arg name="Data"     value="$Smr"/>    <!--交易摘要-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$SecKey"/> <!--密押-->
              <Arg name="Data"     value="|||||||||||"/>   <!--企业机构代码、服务信息类型、服务信息内容、附加发起人名称-->
              <Arg name="Data"     value="$SndAdr"/> <!--发起人地址-->
              <Arg name="Data"     value="||"/>      <!--附加接收人名称-->
              <Arg name="Data"     value="$RcvAdr"/> <!--接收人地址-->
              <Arg name="Data"     value="|"/>
              <Arg name="ESCFMT"   value="\\n"/>
            </Exec>
          </While>
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_2"/>
          </Exec>
<!--文件转换-->
          <Exec func="CBS:CbsFilConv" error="IGNORE">
            <Args>
              <Arg name="SrcFil" value="$NewFil"/>
              <Arg name="SndDir" value="$IcsSndDir" />
            </Args>
          </Exec>
<!--发送回应文件-->
          <Set>LclFil=SUBSTR($NewFil,1,36)</Set>
          <Set>ObjFil=STRCAT($LclFil,$FSize)</Set>
          <Exec func="PUB:FtpPut" error="IGNORE">
            <Arg name="FtpId" value="CBS001"/>
          </Exec>
          <Set>QrySen=Sql05</Set>
          <Quote name="DbExec"/>
          <Exec func="PUB:CommitWork" />
        </If>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE">
        <Arg name="CursorName" value="CURSOR_1"/>
      </Exec>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Return/>
    </FlowCtrl>
  </Transaction>
<!--
*******************************文件类往帐业务*********************************
-->
  <Transaction code="465893" desc="文件类往帐业务" timeout="300">
    <Quote name="CbsSqlLst"/>
    <DynSentence name="GetJnlTraKnd">
      <Sentence>
        select distinct TxnKnd from CbsBchJnl where FilNam='%s' and OIFlag='0' and Bilsts='%s'
      </Sentence>
      <Fields>OldFil|OldBil|</Fields>
    </DynSentence>
    <DynSentence name="UpdBchJnlSts">
      <Sentence>
        update CbsBchJnl set BilSts='%s' where FilNam='%s' and OIFlag='%s' and BilSts='%s' and TxnKnd='%s'
      </Sentence>
      <Fields>NewBil|OldFil|OIFlag|OldBil|TxnKnd|</Fields>
    </DynSentence>
    <DynSentence name="UpdBchJnlFil">
      <Sentence>
        update CbsBchJnl set FilNam='%s' where FilNam='%s' and OIFlag='%s' and BilSts='%s' and TxnKnd='%s'
      </Sentence>
      <Fields>NewFil|OldFil|OIFlag|NewBil|TxnKnd|</Fields>
    </DynSentence>
    <DynSentence name="GetSndDat">
      <Sentence>
        select MsgSqn,TraKnd,SndBNo,SndDat,VchId ,MsgId ,TxnAmt,TraTm ,ClrDat,CcyCod,SvrCod,CenTm ,CenLog,ThdTm ,ThdLog,
               RtnCod,CshFlg,SmrCod,UsgCod,RSdFlg,AccFlg,TBusTp,CardFg,AccKnd,FeeTyp,PayFuc,AuthCd,PayLvl,SOpnBk,SndNod,
               SndAct,SndNm ,SndAdr,RcvBNo,ROpnBk,RcvNod,RcvAct,RcvNm ,RcvAdr,AgrNo ,Smr   ,LogNo,
               SvrKnd,TBilNo,TaxNo ,Taxer ,TaxLvl,TSubCd,TOrgCd,TActDt,SecKey
          from CbsBchJnl where FilNam='%s' and OIFlag='%s' and Bilsts='%s' and TxnKnd='%s'
      </Sentence>
      <Fields>OldFil|OIFlag|NewBil|TxnKnd|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Quote name="InitProc"/>
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Set>OldBil=C</Set>
      <Set>OldFil=ABCDEFGHIJKLMNOPQRSTUVWXYZ</Set>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql"        value="GetJnlTraKnd"/>
        <Arg name="CursorName" value="CURSOR_1"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=打开游标【CURSOR_1】出错</Set>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE">
          <Arg name="CursorName" value="CURSOR_1"/>
        </Exec>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <Quote name="ChkSysSts"/>
        <If condition="IS_EQUAL_STRING($RunFlg,1)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=STRCAT(该状态不能发送【,$TxnKnd,】业务)</Set>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="CURSOR_1"/>
          </Exec>
          <Return/>
        </If>
        <Set>TraKnd=SUBSTR($TxnKnd,1,4)</Set>
        <Switch expression="$TxnKnd">
          <Case value="105101"/>  <!--批量贷记-->
          <Case value="105102">   <!--定期贷记-->
            <Set>SSysId=1006</Set>
            <Set>RSysId=0000</Set>
            <Set>OIFlag=0</Set>
            <Exec func="PUB:nGetPubSeqNo">
              <Arg name="SeqNam" value="CbsBchSum:BchSqn"/>
              <Arg name="SeqCnt" value="1"/>
              <Arg name="Len"    value="8"/>
              <Arg name="CycCnd" value="Y"/>
            </Exec>
            <Set>BchSqn=$SelVal</Set>
            <Set>DatFil=STRCAT(TXNTYP,2202,$TxnKnd,$SSysId,$WorkDt,$BchSqn,XXXXXXXX)</Set>
            <Set>SndFil=STRCAT(GETENV(WORKDIR),/,$IcsSndDir,/,$DatFil)</Set>
            <Set>FilBody=STRCAT($SndFil,.Body)</Set>
<!--更新流水表中发送文件名，并实现加锁控制-->
            <Set>NewBil=D</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="UpdBchJnlSts"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=CBS999</Set>
              <Set>RspMsg=STRCAT(更新业务类型【,$TxnKnd,】明细表错)</Set>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
              </Exec>
              <Exec func="PUB:CloseCursor" error="IGNORE">
                <Arg name="CursorName" value="CURSOR_1"/>
              </Exec>
              <Return/>
            </If>
<!--通过游标获取明细记录，完成文件体的写入-->
            <Exec func="PUB:OpenCursor" error="IGNORE">
              <Arg name="sql"        value="GetSndDat"/>
              <Arg name="CursorName" value="CURSOR_2"/>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=CBS999</Set>
              <Set>RspMsg=打开游标【CURSOR_2】出错</Set>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
              </Exec>
              <Exec func="PUB:CloseCursor" error="IGNORE">
                <Arg name="CursorName" value="CURSOR_1"/>
              </Exec>
              <Return/>
            </If>
            <Set>TotNum=0</Set>
            <Set>TotAmt=0</Set>
            <While>
              <Exec func="PUB:FetchCursor" error="IGNORE">
                <Arg name="CursorName" value="CURSOR_2"/>
              </Exec>
              <If condition="~RetCod=100">
                <Break/>
              </If>
              <Set>SecKey=ADDCHAR($Seckey,40, ,0)</Set>
              <Set>RefMsg=STRCAT(1006,SUBSTR($LogNo,3,12))</Set>
              <Exec func="PUB:WriteFile" error="IGNORE">
                <Arg name="FileName" value="$FilBody"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"     value="$MsgSqn"/> <!--信息序号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$RefMsg"/> <!--参照信息序号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="2202"/>    <!--报文类型标识-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TxnKnd"/> <!--交易类型细分-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TxnAmt"/> <!--交易金额-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TraTm" /> <!--交易发起日期和时间-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$SndBNo"/> <!--直接清算行-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$SndDat"/> <!--委托日期-->
                <Arg name="Data"     value="000000" /> <!--委托日期低位补零-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$ClrDat"/> <!--清算日期-->
                <Arg name="Data"     value="|||"/>     <!--查询通知种类标识、地区号-->
                <Arg name="Data"     value="$CcyCod"/> <!--交易货币代码-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$SvrCod"/> <!--服务点输入方式码-->
                <Arg name="Data"     value="|||"/>     <!--中心客户号、企业客户号-->
                <Arg name="Data"     value="$CenTm" /> <!--中心交易受理日期时间-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$CenLog"/> <!--中心交易受理号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$ThdTm" /> <!--业务处理方处理日期时间-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$ThdLog"/> <!--业务处理方流水号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$RtnCod"/> <!--返回码-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$CshFlg"/> <!--现金转账标识-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$SmrCod"/> <!--摘要代码-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$UsgCod"/> <!--资金用途代码-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$RSdFlg"/> <!--重发标识-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$AccFlg"/> <!--对公对私标识-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TBusTp"/> <!--业务种类-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$CardFg"/> <!--卡折标识-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$AccKnd"/> <!--钞户汇户标识-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$FeeTyp"/> <!--手续费方式-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$PayFuc"/> <!--支付工具-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$AuthCd"/> <!--授权码-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$PayLvl"/> <!--支付优先级-->
                <Arg name="Data"     value="||"/>      <!--原交易业务唯一标识-->
                <Arg name="Data"     value="$SndBNo"/> <!--发起行行号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$SOpnBk"/> <!--发起人开户行行号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$SndNod"/> <!--发起行网点号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$SndAct"/> <!--发起人账号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$SndNm" /> <!--发起人名称-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$VchId" /> <!--凭证提交号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$RcvBNo"/> <!--接收行行号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$ROpnBk"/> <!--接收人开户行行号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$RcvNod"/> <!--接收行网点号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$RcvAct"/> <!--接收人账号-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$RcvNm" /> <!--接收人名称-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$AgrNo" /> <!--多方协议号-->
                <Arg name="Data"     value="|||||||||"/> <!--运行状态、贷方金额、笔数、借方金额、笔数、交易种类、旧登陆标识、新登陆标识-->
                <Arg name="Data"     value="$Smr"/>    <!--交易摘要-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$SecKey"/> <!--密押-->
                <Arg name="Data"     value="||"/>      <!--企业机构代码-->
                <Arg name="Data"     value="$SvrKnd"/> <!--服务信息类型-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TBilNo"/> <!--税票号码-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TaxNo"/> <!--纳税人编码-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$Taxer"/> <!--纳税人名称-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TaxLvl"/> <!--预算级次-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TSubCd"/> <!--预算科目-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TOrgCd"/> <!--征收机关代码-->
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="$TActDt"/> <!--税票限缴日期-->
                <Arg name="Data"     value="||"/>   <!--附加发起人名称-->
                <Arg name="Data"     value="$SndAdr"/> <!--发起人地址-->
                <Arg name="Data"     value="||"/>      <!--附加接收人名称-->
                <Arg name="Data"     value="$RcvAdr"/> <!--接收人地址-->
                <Arg name="Data"     value="|"/>
                <Arg name="ESCFMT"   value="\\n"/>
              </Exec>
              <Set>TotNum=ADD($TotNum,1)</Set>
              <Set>TotAmt=ADD($TotAmt,$TxnAmt)</Set>
            </While>
            <Exec func="PUB:CloseCursor" error="IGNORE">
              <Arg name="CursorName" value="CURSOR_2"/>
            </Exec>
<!--完成文件头的写入-->
            <Set>TotNum=ADDCHAR($TotNum,10,0,1)</Set>
            <Set>TotAmt=ADDCHAR($TotAmt,16,0,1)</Set>
            <Set>ClrDat=00000000</Set>
            <Set>ClrSce=0</Set>
            <Set>SndBNo=301581000019</Set>
            <Set>RcvBNo= </Set>
            <Set>RefNum=0000000000</Set>
            <Set>RefAmt=0000000000000000</Set>
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="STRCAT($SndFil,.dat)"/>
              <Arg name="OpenMode" value="w"/>
              <Arg name="Data"     value="$ClrDat"/> <!--清算日期-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$ClrSce"/> <!--清算场次-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$SSysId"/> <!--发起方系统号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$SndBNo"/> <!--发起方代码-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$RSysId"/> <!--接收方系统号-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$RcvBNo"/>
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$TraKnd"/> <!--交易种类-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$DatFil"/> <!--文件名-->
              <Arg name="Data"     value="||"/>      <!--参照文件名-->
              <Arg name="Data"     value="$BchSqn"/> <!--批量包序号-->
              <Arg name="Data"     value="|00000000|00000000|"/> <!--参考批量包序号、客户批量包序号-->
              <Arg name="Data"     value="$TotNum"/> <!--交易总笔数-->
              <Arg name="Data"     value="|"/>
              <Arg name="Data"     value="$TotAmt"/> <!--交易总金额-->
              <Arg name="Data"     value="|0000000000|0000000000000000|||"/> <!--拒绝支付总笔数、拒绝支付总金额、返回码、预留位-->
              <Arg name="ESCFMT"   value="\\n"/>
            </Exec>
<!--合并文件-->
            <Exec func="PUB:CatFile">
              <Arg name="ObjFil"  value="STRCAT($SndFil,.dat)"/>
              <Arg name="SrcFile" value="$FilBody"/>
            </Exec>
<!--文件转换、转换后文件名，文件大小存放在SndFil,Fsize节点中-->
            <Exec func="CBS:CbsFilConv" error="IGNORE">
              <Args>
                <Arg name="SrcFil" value="STRCAT($DatFil,.dat)"/>
                <Arg name="SndDir" value="$IcsSndDir" />
              </Args>
            </Exec>
            <Set>LclFil=SUBSTR($DatFil,1,36)</Set>
            <Set>ObjFil=STRCAT(SUBSTR($LclFil,1,36),$FSize)</Set>
            <Set>BchSts=C</Set>
            <Set>FilNam=$ObjFil</Set>
<!--登记汇总往帐表-->
            <Exec func="PUB:InsertRecord" error="IGNORE">
              <Args>
                <Arg name="tablename" value="CbsBchSum"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=CBS999</Set>
              <Set>RspMsg=STRCAT(更新业务类型【,$TxnKnd,】汇总表错)</Set>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
              </Exec>
              <Exec func="PUB:CloseCursor" error="IGNORE">
                <Arg name="CursorName" value="CURSOR_1"/>
              </Exec>
              <Return/>
            </If>
<!--更新明细往帐表-->
            <Set>NewFil=$ObjFil</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="UpdBchJnlFil"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=CBS999</Set>
              <Set>RspMsg=STRCAT(更新业务类型【,$TxnKnd,】明细表错)</Set>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
              </Exec>
              <Exec func="PUB:CloseCursor" error="IGNORE">
                <Arg name="CursorName" value="CURSOR_1"/>
              </Exec>
              <Return/>
            </If>
            <Exec func="PUB:FtpPut" error="IGNORE">
              <Arg name="FtpId" value="CBS001"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>
            <Break/>
          </Case>
          <Case value="105201">   <!--定期借记、待完善-->
            <Break/>
          </Case>
        </Switch>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE">
        <Arg name="CursorName" value="CURSOR_1"/>
      </Exec>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>
<!--
*******************************信息类文件接收*********************************
-->
  <Transaction code="465892" desc="信息类文件接收" timeout="300">
     <DynSentence name="DelOData">
      <Sentence>
        delete from %s
      </Sentence>
      <Fields>TblNam|</Fields>
    </DynSentence>

    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Quote name="InitProc"/>
      <Exec func="PUB:Lock">
        <Arg name="RecKey" value="STRCAT($AplCls,$TxnCod)"/>
        <Arg name="AutoUnlock" value="yes"/>
      </Exec>
<!--获取文件-->
      <System command="CbsMsgFilDo.sh" error="IGNORE">
        <Arg name="IPADDR"    value="$CbsIp"/>
        <Arg name="ActDat"    value="$ActDat"/>
        <Arg name="CBSUSR"    value="$CbsUsr"/>
        <Arg name="CBSPWD"    value="$CbsPwd"/>
        <Arg name="CBSSNDDIR" value="$CbsSndDir"/>
        <Arg name="ICSMSGDIR" value="$IcsMsgDir"/>
        <Arg name="MODE"      value="0"/>
        <Arg name="FilNam"    value="DNLTYP*"/>
      </System>
      <If condition="~RetCod!=0">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=获取CBS信息数据文件出错或信息数据文件不存在</Set>
        <Return/>
      </If>
      <Set>MsgFilLst=STRCAT( $IcsMsgDir,/FilLst_,$ActDat )</Set>
      <Exec func="PUB:OpenFile">
        <Arg name="FileName" value="$MsgFilLst"/>
        <Arg name="Mode" value="r"/>
      </Exec>
      <While>
        <Delete>DatFNm</Delete>
        <Delete>FilNam</Delete>
        <Delete>DatFil</Delete>
        <Exec func="PUB:CommitWork"/>
        <Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNm"/>
        </Exec>
        <If condition="~RetCod=1">  <!--读到文件尾-->
          <Exec func="PUB:CloseFile"/>
          <Break/>
        </If>
        <Set>DatFNm=TRIM($DatFNm,all)</Set>
        <Set>TblCod=SUBSTR($DatFNm,11,6)</Set>
        <Exec func="PUB:CodeSwitching" error="IGNORE">
          <Arg name="DatSrc"  value="CBSCSW"/>
          <Arg name="SourNam" value="TblCod"/>
          <Arg name="DestNam" value="TblNam"/>
          <Arg name="TblNam"  value="TblCodToTblNam"/>
        </Exec>
<!--清除旧数据-->
        <If condition="IS_NOEQUAL_STRING($TblNam,CbsFeeRpt)">
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="DelOData"/>
            </Args>
          </Exec>
          <If condition="INTCMP(~RetCod,3,-1)">
            <Set>RspMsg=STRCAT(文件【,$DatFil,】数据清理失败)</Set>
            <Continue/>
          </If>
        </If>
        <Else>
          <Set>Mon=SUBSTR($DatFNm,21,6)</Set>
        </Else>
        <Set>DatFil=STRCAT( $IcsMsgDir,/,$DatFNm )</Set>
        <Exec func="PUB:ImportToDB" error="IGNORE">
          <Args>
            <Arg name="FormatName" value="$TblNam"/>
            <Arg name="FileName"   value="$DatFil"/>
            <Arg name="TableName"  value="$TblNam"/>
          </Args>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Set>RspMsg=STRCAT(文件【,$DatFil,】解析失败)</Set>
          <Continue/>
        </If>
        <Exec func="PUB:DeleteFile">
          <Arg name="FilNam" value="$DatFil"/>
        </Exec>
      </While>
<!--删除文件-->
      <System command="CbsMsgFilDo.sh" error="IGNORE">
        <Arg name="IPADDR"    value="$CbsIp"/>
        <Arg name="ActDat"    value="$ActDat"/>
        <Arg name="CBSUSR"    value="$CbsUsr"/>
        <Arg name="CBSPWD"    value="$CbsPwd"/>
        <Arg name="CBSSNDDIR" value="$CbsSndDir"/>
        <Arg name="ICSMSGDIR" value="$IcsMsgDir"/>
        <Arg name="MODE"      value="1"/>
        <Arg name="FilNam"    value="DNLTYP*"/>
      </System>
      <If condition="INTCMP(~RetCod,4,0)">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=处理CBS批量数据回应文件出错</Set>
        <Return/>
      </If>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>
<!--
*******************************信息类文件接收*********************************
-->
<!--处理原则，记帐错误不再处理(更改status='1')、记帐超时查询成功后由下一次激发重新转发处理-->
  <Transaction code="465891" desc="网银业务联动" timeout="3600">
    <Quote name="CbsSqlLst"/>
    <DynSentence name="GetGzhJnl">
      <Sentence>
        select WebChv,RecNo,DrAct,DrNam,CrAct,CrNam,TxnAmt,Rmk,RvsNo,DonDat,DonJnl,Msg,OppExc,BrNo
          from NtbGzhJnl where Status='' order by RecNo 
      </Sentence>
    </DynSentence>
    <DynSentence name="UpdGzhJnl">
      <Sentence>
        update NtbGzhJnl set Status='1' where RecNo='%s'
      </Sentence>
      <Fields>RecNo|</Fields>
    </DynSentence>
    <DynSentence name="GetExchNo">
      <Sentence>
        select BankNo RcvBNo from CbsExchNo where ExchNo='%s'
      </Sentence>
      <Fields>OppExc|</Fields>
    </DynSentence>
    <DynSentence name="GetNetDtl">
      <Sentence>
        select DtlSts, LogNo OLogNo, TlrId, TTxnCd, TckNo, HTxnSt, HRspCd, DrAct, DrNam, CrAct, CrNam, Rmk from CbsNetDtl where RecNo='%s'
      </Sentence>
      <Fields>RecNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdNetDtl">
      <Sentence>
        RecNo='%s'
      </Sentence>
      <Fields>RecNo|</Fields>
    </DynSentence>

    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
      <Exec func="PUB:IsWorkDate">
        <Arg name="Date" value="$ActDat"/>
        <Arg name="AreCod" value="441"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,1)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=非工作日，不能做转发业务</Set>
        <Return/>
      </If>
      <Exec func="PUB:Lock">
        <Arg name="RecKey" value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
<!--初始化渠道-->
      <Set>TxnCnl=CBS</Set>
      <Set>DtlSts=U</Set>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetGzhJnl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=STRCAT(打开游标【GetGzhJnl】出错)</Set>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
<!--判断是否已经处理-->
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="GetNetDtl"/>
          </Args>
        </Exec>
        <Switch expression="~RetCod">
          <Case value="-1"> <!--查询失败-->
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=STRCAT(查询转发明细表【CbsNetDtl】出错)</Set>
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
            </Exec>
            <Return/>
          </Case>
          <Case value="0"> <!--查询成功-->
            <Switch expression="$DtlSts">
              <Case value="U"/> <!--初始-->
              <Case value="T"> <!--超时-->
                <Exec func="PUB:CallHostOther" error="IGNORE">
                  <Arg name="HTxnCd" value="458980"/>
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
                </Exec>
                <If condition="AND(IS_EQUAL_STRING($MsgTyp,N),IS_NOEQUAL_STRING($CrcSts,Y))">
                  <Set>DtlSts=S</Set>
                  <Set>TckNo=DELSPACE($OTckNo,both)</Set>
                  <Set>HTxnSt=S</Set>
                  <Set>HRspCd=SC0000</Set>
                </If>
                <Else>
                  <Set>DtlSts=E</Set>
                  <Set>TckNo= </Set>
                  <Set>HTxnSt=F</Set>
                </Else>
                <Exec func="PUB:UpdateRecord" error="IGNORE">
                  <Arg name="TblNam" value="CbsNetDtl"/>
                  <Arg name="CndSts" value="UpdNetDtl"/>
                </Exec>
                <If condition="IS_EQUAL_STRING($DtlSts,E)">
                  <Exec func="PUB:ExecSql" error="IGNORE">
                    <Args>
                      <Arg name="SqlCmd" value="UpdGzhJnl"/>
                    </Args>
                  </Exec>
                </If>
                <Exec func="PUB:CommitWork" />
                <Break/>
              </Case>
              <Case value="S"> <!--记帐成功-->
                <Set>LogNo=$OLogNo</Set>
                <Quote name="NetToCbs"/>
                <Break/>
              </Case>
              <Case value="G"> <!--转发成功-->
                <Exec func="PUB:ExecSql" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="UpdGzhJnl"/>
                  </Args>
                </Exec>
                <Break/>
              </Case>
              <Case value="E"/> <!--记帐失败-->
              <Case value="F"> <!--转发失败-->
                <Exec func="PUB:ExecSql" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="UpdGzhJnl"/>
                  </Args>
                </Exec>
                <Break/>
              </Case>
            </Switch>
            <Break/>
          </Case>
          <Case value="-2"> <!--无记录-->
            <Set>NodNo=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
            <Set>CnlSub=NET</Set>
            <Exec func="PUB:GetVirtualTeller"/>
            <Exec func="PUB:GetLogNo"/>
            <Set>DrAct=DELSPACE($DrAct,all)</Set>
            <Set>DrNam=SUBSTR(DELSPACE(CHAOSCODE(TOSBC($DrNam)),all),1,60)</Set>
            <Set>CrAct=DELSPACE($CrAct,all)</Set>
            <Set>CrNam=SUBSTR(DELSPACE(CHAOSCODE(TOSBC($CrNam)),all),1,60)</Set>
            <Set>Rmk=SUBSTR(DELSPACE(CHAOSCODE(TOSBC($Rmk)),all),1,60)</Set>
            <Exec func="PUB:InsertRecord" error="IGNORE">
              <Args>
                <Arg name="tablename" value="CbsNetDtl"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=CBS999</Set>
              <Set>RspMsg=STRCAT(登记网银转发流水表【CbsNetDtl】错)</Set>
              <Exec func="PUB:CloseCursor" error="IGNORE"/>
              <Exec func="PUB:Unlock">
                <Arg name="RecKey" value="STRCAT($AplCls,$TxnCod)"/>
              </Exec>
              <Return/>
            </If>
<!--帐务处理-->    
            <Set>TTxnCd=465891</Set>
            <Set>HTxnCd=451800</Set>
            <Set>BusTyp=GZW94</Set>
            <Set>CrpCod=CBS999999999</Set>
            <Quote name="ChkBnkInf"/>
            <Set>OActBk=$BrNo</Set>
            <Set>OActBr=$CtlNod</Set>
            <Set>OActSq=$AccSq12</Set>
            <Set>CclNo=$RvsNo</Set>
            <Set>CDFlg1=D</Set>
            <Set>CcyCd1=CNY</Set>
            <Set>ActBk2=$BrNo</Set>
            <Set>ActBr2=$CtlNod</Set>
            <Set>ActSq2=$AccSq01</Set>
            <Set>CDFlg2=C</Set>
            <Set>CcyCd2=CNY</Set>
            <Set>PyeAmt=$TxnAmt</Set>
<!--上送主机帐务处理-->
            <Exec func="PUB:CallHostAcc" error="IGNORE">
              <Arg name="HTxnCd" value="$HTxnCd"/>
              <Arg name="ObjSvr" value="SHSTPUB1"/>
            </Exec>
            <Switch expression="~RetCod">
              <Case value="0"> <!--交易成功-->
                <Set>DtlSts=S</Set>
                <Set>HTXNST=S</Set>
                <Break/>
              </Case>
              <Case value="-1">  <!--上送主机超时-->
                <Set>DtlSts=T</Set>
                <Set>HTXNST=T</Set>
                <Set>TckNo= </Set>
                <Break/>
              </Case>
              <Default>
                <Set>DtlSts=E</Set>
                <Set>HTXNST=F</Set>
                <Set>TckNo= </Set>
                <Break/>
              </Default>
            </Switch>
            <Exec func="PUB:UpdateRecord" error="IGNORE">
              <Arg name="TblNam" value="CbsNetDtl"/>
              <Arg name="CndSts" value="UpdNetDtl"/>
            </Exec>
            <If condition="IS_EQUAL_STRING($DtlSts,E)">
              <Exec func="PUB:ExecSql" error="IGNORE">
                <Args>
                  <Arg name="SqlCmd" value="UpdGzhJnl"/>
                </Args>
              </Exec>
            </If>
            <Exec func="PUB:CommitWork" />
            <If condition="IS_EQUAL_STRING($DtlSts,S)">
              <Quote name="NetToCbs"/>
            </If>
            <Break/>
          </Case>
        </Switch>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465860" desc="更新汇总记录" timeout="60">
    <Quote name="CbsSqlLst"/>
     <DynSentence name="Sql01">
      <Sentence>
        select FilNam, NodNo, BrNo from CbsBchSum where DskNo='%s' and OIFlag='0' and BchSts='M'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
     <DynSentence name="Sql02">
      <Sentence>
        select COALESCE(sum(bigint(TxnAmt)),0) TxnAmt from CbsBchJnl where FilNam='%s' and OIFlag='0' and BilSts='G' and SndFlg='A'
      </Sentence>
      <Fields>FilNam|</Fields>
    </DynSentence>
    <DynSentence name="Sql03">
      <Sentence>
        select SndAct, count(*) RefNum, COALESCE(sum(bigint(TxnAmt)),0) RefAmt from CbsBchJnl where FilNam='%s' and OIFlag='0' and BilSts='E' group by SndAct
      </Sentence>
      <Fields>FilNam|</Fields>
    </DynSentence>
    <DynSentence name="Sql04">
      <Sentence>
        update CbsBchSum set BchSts='D', RtnCod='000I1000', RefNum='%s', RefAmt='%s' where FilNam='%s' and OIFlag='0' and BchSts='M'
      </Sentence>
      <Fields>RefNum|RefAmt|FilNam|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>DskNo=$LOGNO</Set>
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$DskNo)"/>
      </Exec>
<!--判断是否重复处理，同时获取往帐相关资料(部门、分行、文件名)-->
      <Set>QrySen=Sql01</Set>
      <Quote name="DbSele"/>
      <If condition="~RetCod=-2">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$DskNo)"/>
        </Exec>
        <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Set>RspMsg=STRCAT(批次,$LOGNO,已完成处理或不存在)</Set>
        <Return/>
      </If>
<!--记帐基本要素-->
      <Set>TTxnCd=465860</Set>
      <Set>TxnCnl=CBS</Set>
      <Set>CnlSub=$BrNo</Set>
      <Quote name="ChkBnkInf"/> <!--获取记帐中会计分录的分户序号-->
      <Exec func="PUB:GetVirtualTeller"/>
<!--获取成功发送人行的金额，完成2621到5210的清算-->
      <Set>QrySen=Sql02</Set>
      <Quote name="DbSele"/>
      <If condition="IS_NOEQUAL_STRING(AMTDELZERO($TxnAmt),0)">
        <Delete>LogNo</Delete>
        <Exec func="PUB:GetLogNo"/>
        <Set>TxnAmt=ADDCHAR($TxnAmt,15,0,1)</Set>
        <Set>HTxnCd=451900</Set>
        <Set>HTxnSb=025</Set>
        <Set>BusTyp=LBE75</Set>
        <Set>CrpCod=CBS999999999</Set>
        <Set>ActBk1=$BrNo</Set>
        <Set>ActBr1=$NodNo</Set>
        <Set>ActSq1=$AccSq10</Set>
        <Set>CdFlg1=D</Set>
        <Set>CcyCd1=$CcyCod</Set>
        <Set>OuAmt1=$TxnAmt</Set>
        <Set>Smr=STRCAT(清算批次号为,$LOGNO,批量贷记业务)</Set>
        <Set>ActBk6=$BrNo</Set>
        <Set>ActBr6=$CtlNod</Set>
        <Set>ActSq6=$AccSq07</Set>
        <Set>OvrSe6=0</Set>
        <Set>CdFlg6=C</Set>
        <Set>CcyCd6=$CcyCod</Set>
        <Set>InAmt6=$TxnAmt</Set>
        <Exec func="PUB:CallHostAcc" error="IGNORE" >
          <Arg name="TxnCod" value="$HTxnCd" />
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
        <If condition="AND(INTCMP(~RetCod,3,0),IS_EQUAL_STRING($HRspCd,SC0000))">
          <Set>RspCod=000000</Set>
        </If>
        <Else>
<!--如果清算失败，将不在进行客户资金返回操作，避免帐务风险-->
          <Exec func="PUB:Unlock">
            <Arg name="RecKey"   value="STRCAT($AplCls,$DskNo)"/>
          </Exec>
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Set>RspMsg=STRCAT(批次,$LOGNO,处理5210失败)</Set>
          <Return/>
        </Else>
      </If>
      <Set>QrySen=Sql03</Set>
      <Quote name="DbSele"/>
      <If condition="IS_NOEQUAL_STRING(AMTDELZERO($RefAmt),0)">
<!--清理交易成功的记帐数据-->
        <Delete>LogNo</Delete>
        <Delete>ActBk6</Delete>
        <Delete>ActBr6</Delete>
        <Delete>ActSq6</Delete>
        <Delete>OvrSe6</Delete>
        <Delete>CdFlg6</Delete>
        <Delete>CcyCd6</Delete>
        <Delete>InAmt6</Delete>
<!--获取本次记帐数据-->
        <Exec func="PUB:GetLogNo"/>
        <Set>RefAmt=ADDCHAR($RefAmt,15,0,1)</Set>
        <Set>HTxnCd=451900</Set>
        <Set>HTxnSb=025</Set>
        <Set>BusTyp=LBE75</Set>
        <Set>CrpCod=CBS999999999</Set>
        <Set>RgCFlg=1</Set>
        <Set>ActBk1=$BrNo</Set>
        <Set>ActBr1=$CtlNod</Set>
        <Set>ActSq1=$AccSq10</Set>
        <Set>CdFlg1=D</Set>
        <Set>CcyCd1=$CcyCod</Set>
        <Set>OuAmt1=$RefAmt</Set>
        <Set>Smr=批量贷记业务处理失败款</Set>
        <Set>PayAt5=DELSPACE($SndAct,all)</Set>
        <Set>CdFlg5=C</Set>
        <Set>CcyCd5=$CcyCod</Set>
        <Set>InAmt5=$RefAmt</Set>
        <Exec func="PUB:CallHostAcc" error="IGNORE" >
          <Arg name="TxnCod" value="$HTxnCd" />
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
        <If condition="AND(INTCMP(~RetCod,3,0),IS_EQUAL_STRING($HRspCd,SC0000))">
          <Set>RspCod=000000</Set>
        </If>
        <Else>
<!--如果清算失败，将不在进行汇总表记录修改操作，避免帐务风险-->
          <Exec func="PUB:Unlock">
            <Arg name="RecKey"   value="STRCAT($AplCls,$DskNo)"/>
          </Exec>
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Set>RspMsg=STRCAT(批次,$DskNo,处理返还客户款失败,返回码,$HRspCd)</Set>
          <Return/>
        </Else>
      </If>
      <Set>RefNum=ADDCHAR($RefNum,10,0,1)</Set>
      <Set>RefAmt=ADDCHAR(AMTDELZERO($RefAmt),16,0,1)</Set>
      <Set>QrySen=Sql04</Set>
      <Quote name="DbExec"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$DskNo)"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>

</Application>
