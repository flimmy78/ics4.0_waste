<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="CBS" code="257" trace="yes">
  <LibDeclare>
    <Library name="CBS" value="app/cbs/dll/cbs.so"/>
  </LibDeclare>
  <ConfigDeclare>
    <Config name="BatFormat" value="etc/CBS_FMT.XML"/>
  </ConfigDeclare>
  <TableDeclare>
    <Table name="CbsFeeRat" value="CbsFeeRat"/>
    <Table name="CbsCodeCd" value="CbsCodeCd"/>
    <Table name="CbsPubInf" value="CbsPubInf"/>
    <Table name="CbsCusAgr" value="CbsCusAgr"/>
    <Table name="CbsBnkInf" value="CbsBnkInf"/>
    <Table name="CbsBankCd" value="CbsBankCd"/>
    <Table name="CbsBTxnCd" value="CbsBTxnCd"/>
    <Table name="CbsBusAct" value="CbsBusAct"/>
    <Table name="CbsExchNo" value="CbsExchNo"/>
    <Table name="CbsFeeRpt" value="CbsFeeRpt"/>
    <Table name="NtbGzhJnl" value="NtbGzhJnl"/>
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="AplCls"    value="257"/>
    <Busdef name="RptDir"    value="dat/term/send/"/>
    <Busdef name="TrmFilPth" value="dat/term/recv"/>
    <Busdef name="CbsIp"     value="182.53.5.188"/>
    <Busdef name="CbsUsr"    value="bfes"/>
    <Busdef name="CbsPwd"    value="bfes"/>
    <Busdef name="CbsSndDir" value="/home/bfes/frecv"/>
    <Busdef name="CbsFeeDir" value="/home/bfes/data/mrecv"/>
    <Busdef name="IcsDtlDir" value="dat/cbs/dtl"/>
    <Busdef name="IcsMsgDir" value="dat/cbs/msg"/>
  </BusDefDeclare>
  <Define>
    <Include file="etc/CBS_MCR2.XML"/>
  </Define>


  <Transaction code="465701" desc="汇兑费率资料维护">
<!-- 修改 -->
    <DynSentence name="UpdFeeRat">
      <Sentence>
        update CbsFeeRat set Sts='%s', FeeMod='%s', FeeRat='%s', FeeAmt='%s', PstMod='%s', PstRat='%s', PstAmt='%s', ValDt='%s'
          where TxnKnd='%s' and UsgCod='%s' and LclFlg='%s' and BrNo='%s' and CcyCod='%s' and MinAmt='%s' and MaxAmt='%s'
      </Sentence>
      <Fields>Sts|FeeMod|FeeRat|FeeAmt|PstMod|PstRat|PstAmt|ValDt|TxnKnd|UsgCod|LclFlg|BrNo|CcyCod|MinAmt|MaxAmt|</Fields>
    </DynSentence>
<!-- 查询 -->
    <DynSentence name="GetFeeRat">
      <Sentence>
        select Sts OSts, TxnNam OTxnNam, UsgNam OUsgNam, FeeMod OFeeMod, FeeRat OFeeRat, FeeAmt OFeeAmt,
               PstMod OPstMod, PstRat OPstRat, PstAmt OPstAmt, ValDt OValDt from CbsFeeRat
         where TxnKnd='%s' and UsgCod='%s' and LclFlg='%s' and BrNo='%s' and CcyCod='%s' and MinAmt='%s' and MaxAmt='%s'
      </Sentence>
      <Fields>TxnKnd|UsgCod|LclFlg|BrNo|CcyCod|MinAmt|MaxAmt|</Fields>
    </DynSentence>
<!-- 删除 -->
    <DynSentence name="DelFeeRat">
      <Sentence>
        delete from CbsFeeRat where TxnKnd='%s' and UsgCod='%s' and LclFlg='%s' and BrNo='%s' and CcyCod='%s' and MinAmt='%s' and MaxAmt='%s'
      </Sentence>
      <Fields>TxnKnd|UsgCod|LclFlg|BrNo|CcyCod|MinAmt|MaxAmt|</Fields>
    </DynSentence>
<!-- 判断费率是否交叉 -->
    <DynSentence name="ChkFeeRat">
      <Sentence>
        select 'Y' YN from TABLE(VALUES(1)) AS anony
          where EXISTS
              ( select 'Y' from CbsFeeRat
                 where TxnKnd='%s' and UsgCod='%s' and LclFlg='%s' and BrNo='%s' and CcyCod='%s'
                   and ( ( MinAmt &gt; '%s' and MinAmt &lt; '%s' ) or ( MaxAmt &gt; '%s' and MaxAmt &lt; '%s' ) ) )
      </Sentence>
      <Fields>TxnKnd|UsgCod|LclFlg|BrNo|CcyCod|MinAmt|MaxAmt|MinAmt|MaxAmt|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($FUNC,2)">
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="70" />
          <Arg name="AthMsg" value="PFA000" />
        </Exec>
        <Exec func="PUB:CheckLocalAuth" >
          <Arg name="ObjSvr" value="SHSTPUB1" />
        </Exec>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetFeeRat" />
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=STRCAT(查询表【CbsFeeRat】失败)</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Switch expression="$FUNC">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
<!--检查费率是否存在分段-->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="ChkFeeRat" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=STRCAT(查询表【CbsFeeRat】失败)</Set>
            <Return/>
          </If>
          <If condition="~RetCod=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=该费率有分段</Set>
            <Return/>
          </If>
          <Exec func="PUB:InsertRecord">
            <Args>
              <Arg name="tablename" value="CbsFeeRat"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="UpdFeeRat" />
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="DelFeeRat" />
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465702" desc="系统运行参数维护">
<!-- 修改 -->
    <DynSentence name="UpdBnkInf">
      <Sentence>
        BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
<!-- 查询 -->
    <DynSentence name="GetBnkInf">
      <Sentence>
        select BusNod OBusNod, AccSq01 OAccSq01, AccSq02 OAccSq02, AccSq03 OAccSq03, AccSq04 OAccSq04, AccSq05 OAccSq05,
               AccSq06 OAccSq06, AccSq07 OAccSq07, AccSq08 OAccSq08, AccSq09 OAccSq09, AccSq10 OAccSq10, AccSq11 OAccSq11,
               AccIn01 OAccIn01, AccIn02 OAccIn02, AccIn03 OAccIn03, CityCd OCityCd
          from CbsBnkInf
          where BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
<!-- 删除 -->
    <DynSentence name="DelBnkInf">
      <Sentence>
        delete from CbsBnkInf where BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900),IS_NOEQUAL_STRING($FUNC,2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($FUNC,2)">
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="70" />
          <Arg name="AthMsg" value="PFA000" />
        </Exec>
        <Exec func="PUB:CheckLocalAuth" >
          <Arg name="ObjSvr" value="SHSTPUB1" />
        </Exec>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetBnkInf" />
        </Args>
      </Exec>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Switch expression="$FUNC">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
          <Set>CtlNod=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
          <Set>CnlSub=$BrNo</Set>
          <Exec func="PUB:InsertRecord">
            <Args>
              <Arg name="tablename" value="CbsBnkInf"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="CbsBnkInf"/>
            <Arg name="CndSts" value="UpdBnkInf"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="DelBnkInf" />
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465703" desc="交换号对照表维护">
    <DynSentence name="QryExchNo"> <!-- 查询 -->
      <Sentence>
        select BankNo OBankNo from CbsExchNo where BrNo='%s' and ExchNo='%s'
      </Sentence>
      <Fields>BrNo|ExchNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdExchNo"> <!-- 修改 -->
      <Sentence>
        BrNo='%s' and ExchNo='%s'
      </Sentence>
      <Fields>BrNo|ExchNo|</Fields>
    </DynSentence>
    <DynSentence name="DelExchNo"> <!-- 删除 -->
      <Sentence>
        delete from CbsExchNo where BrNo='%s' and ExchNo='%s'
      </Sentence>
      <Fields>BrNo|ExchNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_NOEQUAL_STRING($FUNC,2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($FUNC,2)">
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="30" />
          <Arg name="AthMsg" value="CBS000" />
        </Exec>
        <Exec func="PUB:CheckLocalAuth" >
          <Arg name="ObjSvr" value="SHSTPUB1" />
        </Exec>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="QryExchNo" />
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($FUNC,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Switch expression="$FUNC">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="CbsExchNo"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="CbsExchNo"/>
            <Arg name="CndSts" value="UpdExchNo"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="DelExchNo" />
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465704" desc="系统登陆签退">
    <Quote name="CbsSqlLst"/>
    <FlowCtrl>
      <Quote name="InitProc"/>
<!--功能选择-->
      <If condition="IS_EQUAL_STRING($Func,1)">
        <Set>TxnKnd=900101</Set>   <!--签到-->
      </If>
      <Else>
        <Set>TxnKnd=900102</Set>   <!--签退-->
      </Else>
<!--范围选择-->
      <If condition="IS_EQUAL_STRING($LogFlg,1)">
        <Set>CTraKnd=0000</Set>    <!--全部-->
      </If>
      <Else>
        <Set>CTraKnd=$TraKnd</Set> <!--部分-->
      </Else>
      <Set>RspCod=000000</Set>
      <Set>MsgId=2622</Set>  <!--报文请求标志-->
      <Set>SndTm=GETDATETIME(YYYYMMDDHHMISS)</Set> <!--发送时间-->
      <Set>TraTm=SUBSTR($SndTm,5,10)</Set> <!--发送时间-->
      <Quote name="GetBusLog"/>   <!--获取信息流水号-->
      <Set>TraKnd=SUBSTR($TxnKnd,1,4)</Set> <!--交易类型-->
      <Set>TrsTyp=0</Set> <!--传输类型-->
      <Set>@MSG.FLG=1</Set>
      <If condition="INTCMP(STRLEN($NSgnId),3,0)">
        <Set>NSgnId=$OSgnId</Set>
      </If>
      <Exec func="PUB:CallThirdOther">
        <Arg name="TxnCod" value="S00145"/>
        <Arg name="ObjSvr" value="LTHDCBS1"/>
      </Exec>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465705" desc="人行手续费清单打印">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Set>SrcFil=STRCAT(DNLTYP2630FEERPT1006,$Mon,*)</Set>
      <Set>DesFil=STRCAT(FEERPT,$MON,.PDF)</Set>
      <System command="CbsRptFilDo.sh" error="IGNORE">
        <Arg name="SrcDir" value="$IcsMsgDir"/>
        <Arg name="DesDir" value="$RptDir"/>
        <Arg name="SrcFil" value="$SrcFil"/>
        <Arg name="DesFil" value="$DesFil"/>
      </System>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=获取CBS手续费文件出错或不存在</Set>
        <Return/>
      </If>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="3"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$DesFil"/>
        <Arg name="Summary" value="手续费清单"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>


	<Transaction code="465707" desc="日终人行清算明细数据下载">
		<FlowCtrl>
			<Quote name="InitProc"/>
			<Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>
 	  	<If condition="AND(IS_NOEQUAL_STRING($NodNo,441800),IS_NOEQUAL_STRING($NodNo,441900))">
				<Set>MsgTyp=E</Set> 
				<Set>RspCod=CBS999</Set> 
				<Set>RspMsg=非指定部门不可操作</Set> 
				<Return/>
			</If>
			<Switch expression="$Func">
				<Case value="0"> <!-- 申请对账文件 -->
					<Set>DeaTyp=C</Set> <!--处理类型：非文件类-->
					<Set>TrsTyp=1</Set> <!--存储转发类-->
					<Set>MsgStu=145</Set> <!--报文结构-->
					<Set>TraKnd=8001</Set> <!--交易种类-->
					<Set>MsgId=2502</Set> <!--报文类型-->
					<Set>TxnKnd=800101</Set> 
					<Set>SndTm=GETDATETIME(YYYYMMDDHHMISS)</Set> 
					<Set>TraTm=SUBSTR($SndTm,5,10)</Set> <!--交易时间-->
					<!--生成信息流水号-->
					<Quote name="GetBusLog"/>
					<Set>@MSG.FLG=1</Set>
					<Exec func="PUB:CallThirdOther" >
						<Arg name="TxnCod" value="S00145" />
						<Arg name="ObjSvr" value="LTHDCBS1"/>
					</Exec>
					<Break/>
				</Case>
				<Case value="1"> <!-- 核对交易明细 -->
<!--获取文件-->
					<System command="CbsMsgFilDo.sh" error="IGNORE">
						<Arg name="IPADDR"    value="$CbsIp"></Arg>
						<Arg name="ActDat"    value="$ActDat"></Arg>
						<Arg name="CBSUSR"    value="$CbsUsr"></Arg>
						<Arg name="CBSPWD"    value="$CbsPwd"></Arg>
						<Arg name="CBSSNDDIR" value="$CbsSndDir"></Arg>
						<Arg name="ICSDTLDIR" value="$IcsDtlDir"></Arg>
						<Arg name="MODE"      value="0"></Arg>
						<Arg name="FilNam"    value="STRCAT(DTLTYP*,$TxnKnd,1006,$ClrDat,*)"></Arg>
					</System>
					<If condition="~RetCod!=0">
						<Exec func="PUB:Unlock">
							<Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
						</Exec>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=CBS999</Set>
						<Set>RspMsg=获取CBS对帐文件出错或对帐文件不存在</Set>
						<Return/>
					</If>
					<Set>DtlFilLst=STRCAT( $IcsDtlDir,/FilLst_,$ActDat )</Set>
<!--对帐准备：报表格式、报表名、数据文件名-->
					<Set>FmtFil=STRCAT(etc/,CBS010_RPT,.XML)</Set>
					<Set>RptFil=STRCAT(CBS010,$ClrDat,.RPT)</Set>
					<Set>DatFil=STRCAT($RptDir,$RptFil,.data)</Set>
					<Exec func="CBS:CbsDtlFilChk" error="IGNORE">
						<Args>
							<Arg name="DtlFilLst" value="$DtlFilLst" />
							<Arg name="IcsDtlDir" value="$IcsDtlDir" />
							<Arg name="TxnKnd"    value="$TxnKnd" />
							<Arg name="ClrDat"    value="$ClrDat" />
							<Arg name="DatFil"    value="$DatFil" />
						</Args>
					</Exec>
					<If condition="~RetCod!=0">
						<Exec func="PUB:Unlock">
							<Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
						</Exec>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=CBS999</Set>
						<Return/>
					</If>
					<If condition="IS_EQUAL_STRING($SucFlg,N)">
						<Exec func="PUB:CommitWork"/>
						<Exec func="PUB:GenerateReport" desc="根据数据文件生成报表">
							<Arg name="ObjFil" value="STRCAT($RptDir,$RptFil)"/>
							<Arg name="FmtFil" value="$FmtFil"/>
							<Arg name="DatFil" value="$DatFil"/>
						</Exec>
						<Exec func="PUB:SendFileMessage2">
							<Arg name="MsgTyp"  value="4"/>
							<Arg name="ObjNod"  value="$NodNo"/>
							<Arg name="BusTyp"  value="46"/>
							<Arg name="AplCod"  value="$TxnCod"/>
							<Arg name="FilNam"  value="$RptFil"/>
							<Arg name="Summary" value="差错清单"/>
							<Arg name="ObjTlr"  value="$TlrId"/>
						</Exec>
						<Exec func="PUB:Unlock">
							<Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
						</Exec>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=CBS999</Set>
						<Set>RspMsg=对帐不符，请查看错误清单</Set>
						<Return/>
					</If>
<!--删除文件-->
					<System command="CbsMsgFilDo.sh" error="IGNORE">
						<Arg name="IPADDR"    value="$CbsIp"/>
						<Arg name="ActDat"    value="$ActDat"/>
						<Arg name="CBSUSR"    value="$CbsUsr"/>
						<Arg name="CBSPWD"    value="$CbsPwd"/>
						<Arg name="CBSSNDDIR" value="$CbsSndDir"/>
						<Arg name="ICSDTLDIR" value="$IcsDtlDir"/>
						<Arg name="MODE"      value="1"/>
						<Arg name="FilNam"    value="STRCAT(DTLTYP*,$TxnKnd,1006,$ClrDat,*)"/>
					</System>
					<Set>MsgTye=N</Set>
					<Set>RspCod=000000</Set>
					<Break/>
				</Case>
			</Switch>
			<Exec func="PUB:Unlock">
				<Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
			</Exec>
		</FlowCtrl>
	</Transaction>


  <Transaction code="465709" desc="交易明细对帐">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Exec func="PUB:Lock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
<!--获取文件-->
      <System command="CbsMsgFilDo.sh" error="IGNORE">
        <Arg name="IPADDR"    value="$CbsIp"></Arg>
        <Arg name="ActDat"    value="$ActDat"></Arg>
        <Arg name="CBSUSR"    value="$CbsUsr"></Arg>
        <Arg name="CBSPWD"    value="$CbsPwd"></Arg>
        <Arg name="CBSSNDDIR" value="$CbsSndDir"></Arg>
        <Arg name="ICSDTLDIR" value="$IcsDtlDir"></Arg>
        <Arg name="MODE"      value="0"></Arg>
        <Arg name="FilNam"    value="STRCAT(DTLTYP*,$TxnKnd,1006,$ClrDat,*)"></Arg>
      </System>
      <If condition="~RetCod!=0">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=获取CBS对帐文件出错或对帐文件不存在</Set>
        <Return/>
      </If>
      <Set>DtlFilLst=STRCAT( $IcsDtlDir,/FilLst_,$ActDat )</Set>
<!--对帐准备：报表格式、报表名、数据文件名-->
      <Set>FmtFil=STRCAT(etc/,CBS010_RPT,.XML)</Set>
      <Set>RptFil=STRCAT(CBS010,$ClrDat,.RPT)</Set>
      <Set>DatFil=STRCAT($RptDir,$RptFil,.data)</Set>
      <Exec func="CBS:CbsDtlFilChk" error="IGNORE">
        <Args>
          <Arg name="DtlFilLst" value="$DtlFilLst" />
          <Arg name="IcsDtlDir" value="$IcsDtlDir" />
          <Arg name="TxnKnd"    value="$TxnKnd" />
          <Arg name="ClrDat"    value="$ClrDat" />
          <Arg name="DatFil"    value="$DatFil" />
        </Args>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Return/>
      </If>
      <If condition="IS_EQUAL_STRING($SucFlg,N)">
        <Exec func="PUB:CommitWork"/>
        <Exec func="PUB:GenerateReport" desc="根据数据文件生成报表">
          <Arg name="ObjFil" value="STRCAT($RptDir,$RptFil)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="DatFil" value="$DatFil"/>
        </Exec>
        <Exec func="PUB:SendFileMessage2">
          <Arg name="MsgTyp"  value="4"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="46"/>
          <Arg name="AplCod"  value="$TxnCod"/>
          <Arg name="FilNam"  value="$RptFil"/>
          <Arg name="Summary" value="差错清单"/>
          <Arg name="ObjTlr"  value="$TlrId"/>
        </Exec>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=对帐不符，请查看错误清单</Set>
        <Return/>
      </If>
<!--删除文件-->
      <System command="CbsMsgFilDo.sh" error="IGNORE">
        <Arg name="IPADDR"    value="$CbsIp"/>
        <Arg name="ActDat"    value="$ActDat"/>
        <Arg name="CBSUSR"    value="$CbsUsr"/>
        <Arg name="CBSPWD"    value="$CbsPwd"/>
        <Arg name="CBSSNDDIR" value="$CbsSndDir"/>
        <Arg name="ICSDTLDIR" value="$IcsDtlDir"/>
        <Arg name="MODE"      value="1"/>
        <Arg name="FilNam"    value="STRCAT(DTLTYP*,$TxnKnd,1006,$ClrDat,*)"/>
      </System>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="STRCAT($AplCls,$TxnCod)"/>
      </Exec>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465710" desc="辖内清算报表">
    <DynSentence name="DelClrRpt">
      <Sentence>
        delete from CbsClrRpt
      </Sentence>
    </DynSentence>
    <DynSentence name="InitClrRpt">
      <Sentence>
        insert into CbsClrRpt
          select '0', BrNo, TxnKnd, '0', '0', '0', '0'
            from %s
           where ClrDat='%s' and BilSts in ( 'G','M','S','X','Z','V' ) group by BrNo,TxnKnd
      </Sentence>
      <Fields>TblNam|ClrDat|</Fields>
    </DynSentence>
    <DynSentence name="GetClrRpt">
      <Sentence>
        select BchFlg, BrNo, TxnKnd, InNum, InAmt, OutNum, OutAmt  from CbsClrRpt
      </Sentence>
    </DynSentence>
    <DynSentence name="SumJnl">
      <Sentence>
        select count(*) SumNum, COALESCE(sum(bigint(TxnAmt)),0) SumAmt
          from %s
         where ClrDat='%s' and BilSts in ( 'G','M','S','X','Z','V' ) and BrNo='%s' and TxnKnd='%s' and OIFlag='%s'
      </Sentence>
      <Fields>TblNam|ClrDat|BrNo|TxnKnd|OIFlag|</Fields>
    </DynSentence>
    <DynSentence name="UpdClrRpt"> <!--修改-->
      <Sentence>
        BrNo='%s' and TxnKnd='%s' and BchFlg='%s'
      </Sentence>
      <Fields>BrNo|TxnKnd|BchFlg|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
      </If>
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="DelClrRpt" />
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=STRCAT(清理表【CbsClrRpt】失败)</Set>
        <Return/>
      </If>
      <Set>TblNam=CbsTxnJnl</Set>
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="InitClrRpt" />
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=STRCAT(初始化表【CbsClrRpt】实时记录失败)</Set>
        <Return/>
      </If>
      <Set>TblNam=CbsBchJnl</Set>
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="InitClrRpt" />
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=STRCAT(初始化表【CbsClrRpt】批量记录失败)</Set>
        <Return/>
      </If>
      <Exec func="PUB:CommitWork" />
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetClrRpt"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=游标FETCH出错</Set>
        </If>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <If condition="IS_EQUAL_STRING($BchFlg,0)">
          <Set>TblNam=CbsTxnJnl</Set>
        </If>
        <Else>
          <Set>TblNam=CbsBchJnl</Set>
        </Else>
        <Set>OIFlag=0</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="SumJnl" />
          </Args>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Switch expression="$TxnKnd">
          <Case value="100101"/>   <!--同城人民币-->
          <Case value="100102"/>   <!--同城MT103-->
          <Case value="100103"/>   <!--同城MT202-->
          <Case value="100104"/>   <!--粤港MT103-->
          <Case value="100105"/>   <!--粤港MT202-->
          <Case value="100106"/>   <!--内部转账-->
          <Case value="100201"/>   <!--在线支付-->
          <Case value="300101"/>   <!--同城人民币退回-->
          <Case value="300102"/>   <!--粤港MT103退回-->
          <Case value="105101"/>   <!--批量贷记-->
          <Case value="105102">   <!--定期贷记-->
            <Set>OutNum=ADD($OutNum,$SumNum)</Set>
            <Set>OutAmt=ADD($OutAmt,$SumAmt)</Set>
            <Break/>
          </Case>
          <Case value="100301"/>   <!--实时扣款-->
          <Case value="105201">   <!--定期借记-->
            <Set>InNum=ADD($InNum,$SumNum)</Set>
            <Set>InAmt=ADD($InAmt,$SumAmt)</Set>
            <Break/>
          </Case>
        </Switch>
        <Set>OIFlag=1</Set>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="SumJnl" />
          </Args>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=数据库查询失败</Set>
          <Return/>
        </If>
        <Switch expression="$TxnKnd">
          <Case value="100101"/>   <!--同城人民币-->
          <Case value="100102"/>   <!--同城MT103-->
          <Case value="100103"/>   <!--同城MT202-->
          <Case value="100104"/>   <!--粤港MT103-->
          <Case value="100105"/>   <!--粤港MT202-->
          <Case value="100106"/>   <!--内部转账-->
          <Case value="100201"/>   <!--在线支付-->
          <Case value="300101"/>   <!--同城人民币退回-->
          <Case value="300102"/>   <!--粤港MT103退回-->
          <Case value="105101"/>   <!--批量贷记-->
          <Case value="105102">   <!--定期贷记-->
            <Set>InNum=ADD($InNum,$SumNum)</Set>
            <Set>InAmt=ADD($InAmt,$SumAmt)</Set>
            <Break/>
          </Case>
          <Case value="100301"/>   <!--实时扣款-->
          <Case value="105201">   <!--定期借记-->
            <Set>OutNum=ADD($OutNum,$SumNum)</Set>
            <Set>OutAmt=ADD($OutAmt,$SumAmt)</Set>
            <Break/>
          </Case>
        </Switch>
        <Exec func="PUB:UpdateRecord" error="IGNORE">
          <Arg name="TblNam" value="CbsClrRpt"/>
          <Arg name="CndSts" value="UpdClrRpt"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=数据库更新失败</Set>
          <Return/>
        </If>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Set>RptFil=STRCAT(CBS011,$ClrDat,.RPT)</Set>
      <Set>FmtFil=STRCAT(etc/,CBS011_RPT.XML)</Set>
      <Exec func="PUB:GenerateReport" desc="根据数据文件生成报表">
        <Arg name="ObjFil" value="STRCAT($RptDir,$RptFil)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="ClrDat" value="$ClrDat"/>
        <Arg name="TlrId"  value="$TlrId"/>
        <Arg name="ActDat" value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$RptFil"/>
        <Arg name="Summary" value="清算清单"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465721" desc="人行信息代码浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select CodTyp, Code, CodSmr from CbsCodeCd where CodTyp='%s' and ( Code='%s' or '%s'='' ) and CodSmr like '%%%s%%'
      </Sentence>
      <Fields>CodTyp|Code|Code|CodSmr|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Exec func="PUB:MultiQuery" />
    </FlowCtrl>
  </Transaction>



  <Transaction code="465722" desc="汇兑费率资料浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select Sts, TxnKnd, TxnNam, UsgCod, UsgNam, LclFlg, BrNo, CcyCod, MinAmt, MaxAmt, FeeMod, FeeRat, FeeAmt,
               PstMod, PstRat, PstAmt, ValDt
          from CbsFeeRat 
         where ( TxnKnd='%s' or '%s'='' ) and ( UsgCod='%s' or '%s'='' )and LclFlg='%s' and BrNo='%s' and CcyCod='%s'
      </Sentence>
      <Fields>TxnKnd|TxnKnd|UsgCod|UsgCod|LclFlg|BrNo|CcyCod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Exec func="PUB:MultiQuery" />
    </FlowCtrl>
  </Transaction>



  <Transaction code="465723" desc="行号资料浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select distinct a.BankNo BankNo, a.BankNm BankNm, a.TelNo TelNo, b.EffDat EffDat, b.IvdDat IvdDat
          from CbsBankCd a, CbsBTxnCd b
         where a.BankNo=b.BankNo and b.TxnKnd='%s' and ( a.BankNo='%s' or '%s'='' ) and a.BankNm like '%%%s%%'
      </Sentence>
      <Fields>TxnKnd|BankNo|BankNo|BankNm|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Exec func="PUB:MultiQuery" />
    </FlowCtrl>
  </Transaction>


  <Transaction code="465724" desc="人行手续费浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select SndBNo, TxnKnd, int(PkgNum) PkgNum, int(TxnNum) TxnNum, TxnCcy, TxnAmt, FeeAmt
          from CbsFeeRpt
         where Mon='%s' and ( SndBNo='%s' or '%s'='' ) and ( TxnKnd='%s' or '%s'='' )
      </Sentence>
      <Fields>Mon|SndBNo|SndBNo|TxnKnd|TxnKnd|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Exec func="PUB:MultiQuery" />
    </FlowCtrl>
  </Transaction>


  <Transaction code="465725" desc="往来明细浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select TraKnd, SndBNo, SndDat, VchId, OIFlag, Bilsts, SndAct, CcyCod, TxnAmt, RcvAct
          from %s
         where TraKnd='%s' and TxnKnd='%s' and ( SndDat between '%s' and '%s' ) and ( VchId='%s' or '%s'='' )
           and OIFlag='%s' and ( TlrId='%s' or '%s'='' ) and ( TxnAmt='%s' or '%s'='000000000000000' ) and ( BilSts='%s' or '%s'='' )
           and ( SndAct='%s' or '%s'='' ) and ( RcvAct='%s' or '%s'='' ) and ( NodNo='%s' or '%s'='' ) and ( PstNod='%s' or '%s'='' )
      </Sentence>
      <Fields>TblNam|TraKnd|TxnKnd|BegDat|EndDat|VchId|VchId|OIFlag|TlrNo|TlrNo|TxnAmt|TxnAmt|BilSts|BilSts|SndAct|SndAct|RcvAct|RcvAct|TxnNod|TxnNod|PstNod|PstNod|</Fields>
    </DynSentence>
    <DynSentence name="GetRecDat">
      <Sentence>
        select * from %s where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='%s' and Bilsts='%s'
      </Sentence>
      <Fields>TblNam|TraKnd|SndBNo|SndDat|VchId|OIFlag|BilSts|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="GetRecDat"/>
            </Args>
          </Exec>
          <If condition="IS_EQUAL_STRING($TblNam,CbsTxnJnl)">
            <Set>RtnCod=STRCAT(00,$TRspCd)</Set>
          </If>
          <Set>RspCod=000000</Set>
          <Break/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465726" desc="批量业务汇总浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select BchSts, ClrDat, SndBNo, OIFlag, BchSqn, char(int(TotNum)) TotNum, TotAmt, char(int(RefNum)) RefNum, RefAmt, ActDat
          from CbsBchSum
         where ActDat='%s' and ( BchSqn='%s' or '%s'='' ) and OIFlag='%s' and TraKnd='%s' and BrNo='%s'
      </Sentence>
      <Fields>TxnDat|BchSqn|BchSqn|OIFlag|TraKnd|BrNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
<!--暂未考虑多分行情况-->
      <Exec func="PUB:MultiQuery" />
    </FlowCtrl>
  </Transaction>



  <Transaction code="465727" desc="网银转发流水浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select DtlSts, LogNo, ActDat, WebChv, DrAct, TxnAmt from CbsNetDtl
         where BrNo='%s' and ( ActDat between '%s' and '%s' ) and ( DrAct='%s' or '%s'='' ) and ( DtlSts='%s' or '%s'='' )
           and ( FeeFlg='%s' or '%s'='' )
      </Sentence>
      <Fields>BrNo|BActDat|EActDat|ActNo|ActNo|DtlSts|DtlSts|FeeFlg|FeeFlg|</Fields>
    </DynSentence>
    <DynSentence name="GetNetDtl">
      <Sentence>
        select DtlSts, LogNo, ActDat, TlrId, TckNo, HRspCd, WebChv, RecNo, DrAct, DrNam, CrAct, CrNam, TxnAmt, Rmk, RvsNo,
               Msg, DonDat, DonJnl, OppExc, RcvBNo, FeeAmt, PstAmt, FeeFlg
          from CbsNetDtl
         where LogNo='%s'
      </Sentence>
      <Fields>LogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="GetNetDtl"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465741" desc="联机往来清单打印">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_EQUAL_STRING($OIFLag,1))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="IS_EQUAL_STRING($OIFlag,0)">
        <Set>RptSmr=（往帐）</Set>
      </If>
      <Else>
        <Set>RptSmr=（来帐）</Set>
      </Else>
      <Switch expression="$TraKnd">
        <Case value="1001">
          <Switch expression="$TxnKnd">
            <Case value="100101">
              <Set>RptHead=STRCAT(同城贷记业务,$RptSmr,清单)</Set>
              <Break/>
            </Case>
            <Case value="100102">
              <Set>RptHead=STRCAT(同城MT103,$RptSmr,清单)</Set>
              <Break/>
            </Case>
            <Case value="100103">
              <Set>RptHead=STRCAT(同城MT202,$RptSmr,清单)</Set>
              <Break/>
            </Case>
            <Case value="100201">
              <Set>RptHead=STRCAT(在线支付业务,$RptSmr,清单)</Set>
              <Break/>
            </Case>
            <Case value="100103"/>
            <Case value="100104"/>
            <Case value="100105"/>
            <Case value="100106">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=CBS999</Set>
              <Set>RspMsg=暂未开通此类业务</Set>
              <Break/>
            </Case>
          </Switch>
          <Set>FilNam=STRCAT(CBS001,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS001_RPT.XML)</Set>
          <Break/>
        </Case>
        <Case value="1003">
          <Set>RptHead=STRCAT(机构代收业务,$RptSmr,清单)</Set>
          <Set>FilNam=STRCAT(CBS001,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS001_RPT.XML)</Set>
          <Break/>
          <Break/>
        </Case>
        <Case value="2002">   <!--查询查复清单-->
          <Set>FilNam=STRCAT(CBS002,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS002_RPT.XML)</Set>
          <Set>RptHead=STRCAT(查询查复,$RptSmr,清单)</Set>
          <Break/>
        </Case>
        <Case value="1052">   <!--定期借记来帐清单-->
          <Set>FilNam=STRCAT(CBS003,$TlrId,$BchSqn,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS003_RPT.XML)</Set>
          <Set>RptHead=STRCAT(定期借记,$RptSmr,清单)</Set>
          <Break/>
        </Case>
        <Case value="3001">
          <Set>FilNam=STRCAT(CBS001,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS001_RPT.XML)</Set>
          <Set>RptHead=STRCAT(退汇业务,$RptSmr,清单)</Set>
          <Break/>
        </Case>
        <Case value="1051">   <!--批量贷记清单-->
          <If condition="AND(IS_EQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_EQUAL_STRING($OIFlag,0))">
            <Set>NodNo= </Set>
            <Set>NodNo=DELSPACE($NodNo,both)</Set>
          </If>
          <Set>FilNam=STRCAT(CBS009,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS009_RPT.XML)</Set>
          <Set>RptHead=STRCAT(批量贷记,$RptSmr,清单)</Set>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil" />
        <Arg name="RptHead" value="$RptHead"/>
        <Arg name="TraKnd"  value="$TraKnd" />
        <Arg name="TxnKnd"  value="$TxnKnd" />
        <Arg name="CcyCod"  value="$CcyCod" />
        <Arg name="OIFlag"  value="$OIFlag" />
        <Arg name="TxnDat"  value="$TxnDat" />
        <Arg name="BchSqn"  value="$BchSqn" />
        <Arg name="BrNo"    value="$BrNo"   />
        <Arg name="NodNo"   value="$NodNo" />
        <Arg name="TlrId"   value="$TlrId"  />
        <Arg name="PrtDat"  value="$ActDat" />
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="reptprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=确认成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465742" desc="联机往来凭证打印">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_EQUAL_STRING($OIFLag,1))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Switch expression="$TraKnd">
        <Case value="1001"/>  <!--同城贷记-->
        <Case value="1002"/>  <!--在线支付-->
        <Case value="1003"/>  <!--机构代收业务-->
        <Case value="3001"/>  <!--退汇业务-->
        <Case value="1051">   <!--退汇业务-->
          <Set>FilNam=STRCAT(CBS004_,$TraKnd,_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS004_RPT.XML)</Set>
          <Break/>
        </Case>
        <Case value="1052">   <!--定期借记-->
          <Set>FilNam=STRCAT(CBS005_,$TraKnd,_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS005_RPT.XML)</Set>
          <Break/>
        </Case>
        <Case value="2002">   <!--查询查复-->
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=该凭证打印已停用</Set>
          <Return/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="TblNam"  value="$TblNam"/>
        <Arg name="TraKnd"  value="$TraKnd"/>
        <Arg name="TxnKnd"  value="$TxnKnd"/>
        <Arg name="CcyCod"  value="$CcyCod"/>
        <Arg name="OIFlag"  value="$OIFlag"/>
        <Arg name="TxnDat"  value="$TxnDat"/>
        <Arg name="BTckNo"  value="$BTckNo"/>
        <Arg name="ETckNo"  value="$ETckNo"/>
        <Arg name="BilSts"  value="$BilSts"/>
        <Arg name="BrNo"    value="$BrNo"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="billprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465743" desc="网银转发报表打印">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Set>FilNam=STRCAT(CBS013_,$DtlSts,_,$TlrId,.RPT)</Set>
      <Set>FmtFil=STRCAT(etc/,CBS013_RPT.XML)</Set>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="DtlSts"  value="$DtlSts"/>
        <Arg name="TxnDat"  value="$TxnDat"/>
        <Arg name="BrNo"    value="$BrNo"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="billprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465744" desc="网银转发手续费流水打印">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Set>FilNam=STRCAT(CBS014_,$TlrId,.RPT)</Set>
      <Set>FmtFil=STRCAT(etc/,CBS014_RPT.XML)</Set>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="FeeSts"  value="$FeeSts"/>
        <Arg name="TxnMon"  value="$TxnMon"/>
        <Arg name="BrNo"    value="$BrNo"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="BokDat"  value="$BokDat"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="billprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465745" desc="网银转发手续费回单打印">
    <DynSentence name="UpdPrtNum">   <!-- 修改印次数 -->
      <Sentence>
        update CbsNetFee set PrtNum = char( int(PrtNum) + 1 ) where FeeSts='S' and TxnMon='%s' and BrNo='%s' and ( DrAct='%s' or '%s'='' )
      </Sentence>
      <Fields>TxnMon|BrNo|DrAct|DrAct|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Switch expression="$PrtTyp">
        <Case value="1">  <!--回单-->
          <Set>FilNam=STRCAT(CBS015_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS015_RPT.XML)</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdPrtNum" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=修改手续费回单打印次数失败</Set>
            <Return/>
          </If>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=没有满足条件的记录UpdPrtNum</Set>
            <Return/>
          </If>
          <Set>Summary=STRCAT(网银手续费回单,打印日期【,$ActDat,】)</Set>
          <Set>RptSmr=网银同城转帐手续费付款通知书</Set>
          <Break/>
        </Case>
        <Case value="2"/>  <!--缴费流水单-->
        <Case value="3">  <!--欠费流水单-->
          <If condition="IS_EQUAL_STRING($PrtTyp,2)">
            <Set>FeeFlg=1</Set>
            <Set>RptSmr=已付</Set>
          </If>
          <Else>
            <Set>FeeFlg=0</Set>
            <Set>RptSmr=欠费</Set>
          </Else>
          <Set>FilNam=STRCAT(CBS016_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS016_RPT.XML)</Set>
          <Set>Summary=STRCAT(网银手续费流水单,打印日期【,$ActDat,】)</Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="RptSmr"  value="$RptSmr"/>
        <Arg name="TxnMon"  value="$TxnMon"/>
        <Arg name="DrAct"   value="$DrAct"/>
        <Arg name="FeeFlg"  value="$FeeFlg"/>
        <Arg name="BrNo"    value="$BrNo"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="billprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465795" desc="汇兑业务费用试算">
    <Quote name="CbsSqlLst"/>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Quote name="ChkNodInf"/> <!--检查发起行行号-->
      <Set>LclFlg=0</Set>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($RcvBNo,4,4),SUBSTR($SBkNo,4,4))">
        <Set>LclFlg=1</Set>
      </If>
      <Exec func="CBS:CbsGetFee" >
        <Args>
          <Arg name="TxnKnd" value="$TxnKnd" />
          <Arg name="UsgCod" value="$UsgCod" />
          <Arg name="LclFlg" value="$LclFlg" />
          <Arg name="BrNo"   value="$BrNo"   />
          <Arg name="CcyCod" value="$CcyCod" />
          <Arg name="TxnAmt" value="$TxnAmt" />
        </Args>
      </Exec>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465796" desc="前台函数单笔查询">
    <Quote name="CbsSqlLst"/>
    <DynSentence name="GetCodeCd">
      <Sentence>
        select CodSmr from CbsCodeCd where CodTyp='%s' and Code='%s'
      </Sentence>
      <Fields>CodTyp|Code|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="OR(IS_EQUAL_STRING($CodTyp,ITEMCD),IS_EQUAL_STRING($CodTyp,BLEVEL))">
        <Quote name="ChkBnkInf"/>
        <Set>Code=STRCAT($CityCd,$Code)</Set>
      </If>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetCodeCd" />
        </Args>
      </Exec>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465797" desc="根据交换号获取行名">
    <DynSentence name="GetExchNm">
      <Sentence>
        select BnkNam ExchNm from CimBesCod where substr(AreNo,1,3)=substr('%s',1,3) and CcyCod='CNY' and ExcNo='%s'
      </Sentence>
      <Fields>BrNo|ExchNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetExchNm" />
        </Args>
      </Exec>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465798" desc="根据行号获取相关信息">
    <Quote name="CbsSqlLst"/>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_EQUAL_STRING($Func,0)">
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="GetBankCd" />
          </Args>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=STRCAT(查询表【CbsBankCd】失败)</Set>
          <Return/>
        </If>
        <If condition="INTCMP(~RetCod,3,-2)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=STRCAT(该行号【,$BankNo,】不存在)</Set>
          <Return/>
        </If>
      </If>
      <Else>
        <Quote name="ChkBankCd"/>   <!--检查接收行行号-->
        <Quote name="ChkBTxnCd"/>   <!--检查接收行行业务许可范围-->
      </Else>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465725" desc="往来明细浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select TraKnd, SndBNo, SndDat, VchId, OIFlag, Bilsts, SndAct, CcyCod, TxnAmt, RcvAct
          from %s
         where TraKnd='%s' and TxnKnd='%s' and ( SndDat between '%s' and '%s' ) and ( VchId='%s' or '%s'='' )
           and OIFlag='%s' and ( TlrId='%s' or '%s'='' ) and ( TxnAmt='%s' or '%s'='000000000000000' ) and ( BilSts='%s' or '%s'='' )
           and ( SndAct='%s' or '%s'='' ) and ( RcvAct='%s' or '%s'='' ) and ( NodNo='%s' or '%s'='' ) and ( PstNod='%s' or '%s'='' )
      </Sentence>
      <Fields>TblNam|TraKnd|TxnKnd|BegDat|EndDat|VchId|VchId|OIFlag|TlrNo|TlrNo|TxnAmt|TxnAmt|BilSts|BilSts|SndAct|SndAct|RcvAct|RcvAct|TxnNod|TxnNod|PstNod|PstNod|</Fields>
    </DynSentence>
    <DynSentence name="GetRecDat">
      <Sentence>
        select * from %s where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='%s' and Bilsts='%s'
      </Sentence>
      <Fields>TblNam|TraKnd|SndBNo|SndDat|VchId|OIFlag|BilSts|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="GetRecDat"/>
            </Args>
          </Exec>
          <If condition="IS_EQUAL_STRING($TblNam,CbsTxnJnl)">
            <Set>RtnCod=STRCAT(00,$TRspCd)</Set>
          </If>
          <Set>RspCod=000000</Set>
          <Break/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465726" desc="批量业务汇总浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select BchSts, ClrDat, SndBNo, OIFlag, BchSqn, char(int(TotNum)) TotNum, TotAmt, char(int(RefNum)) RefNum, RefAmt, ActDat
          from CbsBchSum
         where ActDat='%s' and ( BchSqn='%s' or '%s'='' ) and OIFlag='%s' and TraKnd='%s' and BrNo='%s'
      </Sentence>
      <Fields>TxnDat|BchSqn|BchSqn|OIFlag|TraKnd|BrNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
<!--暂未考虑多分行情况-->
      <Exec func="PUB:MultiQuery" />
    </FlowCtrl>
  </Transaction>



  <Transaction code="465727" desc="网银转发流水浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select DtlSts, LogNo, ActDat, WebChv, DrAct, TxnAmt from CbsNetDtl
         where BrNo='%s' and ( ActDat between '%s' and '%s' ) and ( DrAct='%s' or '%s'='' ) and ( DtlSts='%s' or '%s'='' )
           and ( FeeFlg='%s' or '%s'='' )
      </Sentence>
      <Fields>BrNo|BActDat|EActDat|ActNo|ActNo|DtlSts|DtlSts|FeeFlg|FeeFlg|</Fields>
    </DynSentence>
    <DynSentence name="GetNetDtl">
      <Sentence>
        select DtlSts, LogNo, ActDat, TlrId, TckNo, HRspCd, WebChv, RecNo, DrAct, DrNam, CrAct, CrNam, TxnAmt, Rmk, RvsNo,
               Msg, DonDat, DonJnl, OppExc, RcvBNo, FeeAmt, PstAmt, FeeFlg
          from CbsNetDtl
         where LogNo='%s'
      </Sentence>
      <Fields>LogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="GetNetDtl"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465741" desc="联机往来清单打印">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_EQUAL_STRING($OIFLag,1))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <If condition="IS_EQUAL_STRING($OIFlag,0)">
        <Set>RptSmr=（往帐）</Set>
      </If>
      <Else>
        <Set>RptSmr=（来帐）</Set>
      </Else>
      <Switch expression="$TraKnd">
        <Case value="1001">
          <Switch expression="$TxnKnd">
            <Case value="100101">
              <Set>RptHead=STRCAT(同城贷记业务,$RptSmr,清单)</Set>
              <Break/>
            </Case>
            <Case value="100102">
              <Set>RptHead=STRCAT(同城MT103,$RptSmr,清单)</Set>
              <Break/>
            </Case>
            <Case value="100103">
              <Set>RptHead=STRCAT(同城MT202,$RptSmr,清单)</Set>
              <Break/>
            </Case>
            <Case value="100201">
              <Set>RptHead=STRCAT(在线支付业务,$RptSmr,清单)</Set>
              <Break/>
            </Case>
            <Case value="100103"/>
            <Case value="100104"/>
            <Case value="100105"/>
            <Case value="100106">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=CBS999</Set>
              <Set>RspMsg=暂未开通此类业务</Set>
              <Break/>
            </Case>
          </Switch>
          <Set>FilNam=STRCAT(CBS001,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS001_RPT.XML)</Set>
          <Break/>
        </Case>
        <Case value="1003">
          <Set>RptHead=STRCAT(机构代收业务,$RptSmr,清单)</Set>
          <Set>FilNam=STRCAT(CBS001,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS001_RPT.XML)</Set>
          <Break/>
          <Break/>
        </Case>
        <Case value="2002">   <!--查询查复清单-->
          <Set>FilNam=STRCAT(CBS002,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS002_RPT.XML)</Set>
          <Set>RptHead=STRCAT(查询查复,$RptSmr,清单)</Set>
          <Break/>
        </Case>
        <Case value="1052">   <!--定期借记来帐清单-->
          <Set>FilNam=STRCAT(CBS003,$TlrId,$BchSqn,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS003_RPT.XML)</Set>
          <Set>RptHead=STRCAT(定期借记,$RptSmr,清单)</Set>
          <Break/>
        </Case>
        <Case value="3001">
          <Set>FilNam=STRCAT(CBS001,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS001_RPT.XML)</Set>
          <Set>RptHead=STRCAT(退汇业务,$RptSmr,清单)</Set>
          <Break/>
        </Case>
        <Case value="1051">   <!--批量贷记清单-->
          <If condition="AND(IS_EQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_EQUAL_STRING($OIFlag,0))">
            <Set>NodNo= </Set>
            <Set>NodNo=DELSPACE($NodNo,both)</Set>
          </If>
          <Set>FilNam=STRCAT(CBS009,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS009_RPT.XML)</Set>
          <Set>RptHead=STRCAT(批量贷记,$RptSmr,清单)</Set>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil" />
        <Arg name="RptHead" value="$RptHead"/>
        <Arg name="TraKnd"  value="$TraKnd" />
        <Arg name="TxnKnd"  value="$TxnKnd" />
        <Arg name="CcyCod"  value="$CcyCod" />
        <Arg name="OIFlag"  value="$OIFlag" />
        <Arg name="TxnDat"  value="$TxnDat" />
        <Arg name="BchSqn"  value="$BchSqn" />
        <Arg name="BrNo"    value="$BrNo"   />
        <Arg name="NodNo"   value="$NodNo" />
        <Arg name="TlrId"   value="$TlrId"  />
        <Arg name="PrtDat"  value="$ActDat" />
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="reptprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=确认成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465742" desc="联机往来凭证打印">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_EQUAL_STRING($OIFLag,1))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Switch expression="$TraKnd">
        <Case value="1001"/>  <!--同城贷记-->
        <Case value="1003"/>  <!--机构代收业务-->
        <Case value="3001"/>  <!--退汇业务-->
        <Case value="1051">   <!--退汇业务-->
          <Set>FilNam=STRCAT(CBS004_,$TraKnd,_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS004_RPT.XML)</Set>
          <Break/>
        </Case>
        <Case value="1052">   <!--定期借记-->
          <Set>FilNam=STRCAT(CBS005_,$TraKnd,_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS005_RPT.XML)</Set>
          <Break/>
        </Case>
        <Case value="2002">   <!--查询查复-->
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=该凭证打印已停用</Set>
          <Return/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="TblNam"  value="$TblNam"/>
        <Arg name="TraKnd"  value="$TraKnd"/>
        <Arg name="TxnKnd"  value="$TxnKnd"/>
        <Arg name="CcyCod"  value="$CcyCod"/>
        <Arg name="OIFlag"  value="$OIFlag"/>
        <Arg name="TxnDat"  value="$TxnDat"/>
        <Arg name="BTckNo"  value="$BTckNo"/>
        <Arg name="ETckNo"  value="$ETckNo"/>
        <Arg name="BilSts"  value="$BilSts"/>
        <Arg name="BrNo"    value="$BrNo"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="billprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465743" desc="网银转发报表打印">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Set>FilNam=STRCAT(CBS013_,$DtlSts,_,$TlrId,.RPT)</Set>
      <Set>FmtFil=STRCAT(etc/,CBS013_RPT.XML)</Set>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="DtlSts"  value="$DtlSts"/>
        <Arg name="TxnDat"  value="$TxnDat"/>
        <Arg name="BrNo"    value="$BrNo"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="billprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465744" desc="网银转发手续费流水打印">
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Set>FilNam=STRCAT(CBS014_,$TlrId,.RPT)</Set>
      <Set>FmtFil=STRCAT(etc/,CBS014_RPT.XML)</Set>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="FeeSts"  value="$FeeSts"/>
        <Arg name="TxnMon"  value="$TxnMon"/>
        <Arg name="BrNo"    value="$BrNo"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="BokDat"  value="$BokDat"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="billprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465745" desc="网银转发手续费回单打印">
    <DynSentence name="UpdPrtNum">   <!-- 修改印次数 -->
      <Sentence>
        update CbsNetFee set PrtNum = char( int(PrtNum) + 1 ) where FeeSts='S' and TxnMon='%s' and BrNo='%s' and ( DrAct='%s' or '%s'='' )
      </Sentence>
      <Fields>TxnMon|BrNo|DrAct|DrAct|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Switch expression="$PrtTyp">
        <Case value="1">  <!--回单-->
          <Set>FilNam=STRCAT(CBS015_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS015_RPT.XML)</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdPrtNum" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=修改手续费回单打印次数失败</Set>
            <Return/>
          </If>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=没有满足条件的记录UpdPrtNum</Set>
            <Return/>
          </If>
          <Set>Summary=STRCAT(网银手续费回单,打印日期【,$ActDat,】)</Set>
          <Set>RptSmr=网银同城转帐手续费付款通知书</Set>
          <Break/>
        </Case>
        <Case value="2"/>  <!--缴费流水单-->
        <Case value="3">  <!--欠费流水单-->
          <If condition="IS_EQUAL_STRING($PrtTyp,2)">
            <Set>FeeFlg=1</Set>
            <Set>RptSmr=已付</Set>
          </If>
          <Else>
            <Set>FeeFlg=0</Set>
            <Set>RptSmr=欠费</Set>
          </Else>
          <Set>FilNam=STRCAT(CBS016_,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,CBS016_RPT.XML)</Set>
          <Set>Summary=STRCAT(网银手续费流水单,打印日期【,$ActDat,】)</Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="RptSmr"  value="$RptSmr"/>
        <Arg name="TxnMon"  value="$TxnMon"/>
        <Arg name="DrAct"   value="$DrAct"/>
        <Arg name="FeeFlg"  value="$FeeFlg"/>
        <Arg name="BrNo"    value="$BrNo"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="billprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465795" desc="汇兑业务费用试算">
    <Quote name="CbsSqlLst"/>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Quote name="ChkNodInf"/> <!--检查发起行行号-->
      <Set>LclFlg=0</Set>
      <If condition="IS_NOEQUAL_STRING(SUBSTR($RcvBNo,4,4),SUBSTR($SBkNo,4,4))">
        <Set>LclFlg=1</Set>
      </If>
      <Exec func="CBS:CbsGetFee" >
        <Args>
          <Arg name="TxnKnd" value="$TxnKnd" />
          <Arg name="UsgCod" value="$UsgCod" />
          <Arg name="LclFlg" value="$LclFlg" />
          <Arg name="BrNo"   value="$BrNo"   />
          <Arg name="CcyCod" value="$CcyCod" />
          <Arg name="TxnAmt" value="$TxnAmt" />
        </Args>
      </Exec>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465796" desc="前台函数单笔查询">
    <Quote name="CbsSqlLst"/>
    <DynSentence name="GetCodeCd">
      <Sentence>
        select CodSmr from CbsCodeCd where CodTyp='%s' and Code='%s'
      </Sentence>
      <Fields>CodTyp|Code|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_EQUAL_STRING($CodTyp,ITEMCD)">
        <Quote name="ChkBnkInf"/>
        <Set>Code=STRCAT($CityCd,$Code)</Set>
      </If>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetCodeCd" />
        </Args>
      </Exec>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465797" desc="根据交换号获取行名">
    <DynSentence name="GetExchNm">
      <Sentence>
        select BnkNam ExchNm from CimBesCod where substr(AreNo,1,3)=substr('%s',1,3) and CcyCod='CNY' and ExcNo='%s'
      </Sentence>
      <Fields>BrNo|ExchNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetExchNm" />
        </Args>
      </Exec>
    </FlowCtrl>
  </Transaction>



  <Transaction code="465798" desc="根据行号获取相关信息">
    <Quote name="CbsSqlLst"/>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="IS_EQUAL_STRING($Func,0)">
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="GetBankCd" />
          </Args>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=STRCAT(查询表【CbsBankCd】失败)</Set>
          <Return/>
        </If>
        <If condition="INTCMP(~RetCod,3,-2)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=CBS999</Set>
          <Set>RspMsg=STRCAT(该行号【,$BankNo,】不存在)</Set>
          <Return/>
        </If>
      </If>
      <Else>
        <Quote name="ChkBankCd"/>   <!--检查接收行行号-->
        <Quote name="ChkBTxnCd"/>   <!--检查接收行行业务许可范围-->
      </Else>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Return/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465799" desc="前台函数单笔查询">
    <Quote name="CbsSqlLst"/>
    <DynSentence name="GetCodeCd">
      <Sentence>
        select CodSmr from CbsCodeCd where CodTyp='%s' and Code='%s'
      </Sentence>
      <Fields>CodTyp|Code|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitProc"/>
      <If condition="OR(IS_EQUAL_STRING($CodTyp,ITEMCD),IS_EQUAL_STRING($CodTyp,BLEVEL))">
        <Quote name="ChkBnkInf"/>
        <Set>Code=STRCAT($CityCd,$Code)</Set>
      </If>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetCodeCd" />
        </Args>
      </Exec>
    </FlowCtrl>
  </Transaction>
 </Application>
