<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="CBS" code="257" trace="yes" >
<!--created by wishman -->
  <LibDeclare>
    <Library name="CBS" value="app/cbs/dll/cbs.so"/>
  </LibDeclare>

  <TableDeclare>
    <Table name="CbsTxnJnl" value="CbsTxnJnl" />
    <Table name="CbsQryJnl" value="CbsQryJnl" />
    <Table name="CbsCenTot" value="CbsCenTot" />
    <Table name="CbsCenAgr" value="CbsCenAgr" />
    <Table name="CbsCenOrg" value="CbsCenOrg" />
  </TableDeclare>

  <ConfigDeclare>
    <Config name="BatFormat" value="etc/CBS_FMT2.XML"/>
  </ConfigDeclare>

  <BusDefDeclare>
    <Busdef name="AplCls"    value="257"/>
      <Busdef name="TSDir" value="dat/term/send/" />
      <Busdef name="TRDir" value="dat/term/recv/" />
      <Busdef name="BrNo"  value="441999"/>
      <Busdef name="AAA_ZDJF"  value="94904"/> <!--3A主动缴费业务类型-->
      <Busdef name="AAA_QYZZ"  value="94905"/> <!--3A签约转帐业务类型-->
      <Busdef name="PayCBnk"  value="301581000019"/> <!--清算行支付号-->
  </BusDefDeclare>

 <Define>
  <Macro name="CursorErr"> <!-- 数据库游标操作出错处理 -->
      <If condition="~RetCod!=0">
       <Set>RspCod=CBS999</Set>
       <Set>RspMsg=打开游标失败，数据库错误，请联系技术人员 </Set>
       <Exec func="PUB:CloseCursor" error="IGNORE"/>
       <Return/>
      </If>
  </Macro>

  <Macro name="GetBusLog"> <!--取信息流水号-->
   <Exec  func="PUB:GetSeqNoCircle" error="IGNORE">
    <Args>
     <Arg name ='TblNam' value='CbsBasInf' />
     <Arg name ='SeqCol' value='BusLog' />
     <Arg name ='Len'    value='12'/>
     <Arg name ='ColNam'  value='BusLog' />
    </Args>
   </Exec>
   <If condition="~RetCod != 0">
    <Set>RspCod=CBS999</Set>
    <Set>RspMsg=取信息流水号BusLog失败,交易故障</Set>
    <Return />
   </If>
  </Macro>

 </Define>


  <Transaction code="465833" desc="查询查复浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select * from CbsQryJnl where OIFlag='%s' and (MatFlg='%s' or '%s'= '')and ( QryTyp='%s' or '%s'= '' )
        and ( SndDat='%s'  or '%s'='' ) and ( SOpnBk='%s' or '%s'='' )  and  ( ROpnBk='%s' or '%s'='' )
        and ( ReqSeq='%s'  or  '%s'='' ) and ( DeaNod='%s'  or '%s'='' ) and ( BrNo='%s'  or '%s'='' )
      </Sentence>
      <Fields>OIFlag|MatFlg|MatFlg|QryTyp|QryTyp|SndDat|SndDat|SOpnBk|SOpnBk|ROpnBk|ROpnBk|ReqSeq|ReqSeq|DeaNod|DeaNod|BrCd|BrCd|</Fields>
    </DynSentence>
    <FlowCtrl>
     <Exec func="PUB:InitTransaction"/>
     <If condition="IS_EQUAL_STRING($TIATyp,P)">
       <Exec func="PUB:MultiQuery" />
      <Return/>
     </If>
      <Exec func="PUB:GetAppInfo" />
     <If condition="AND(IS_NOEQUAL_STRING($NodNo,441800),IS_NOEQUAL_STRING($NodNo,441900))">
       <If condition="STRLEN(DELBOTHSPACE($BrCd))!=6">
          <Set>MsgTyp=E</Set> 
          <Set>RspCod=329999</Set> 
          <Set>RspMsg=分行号错 </Set> 
          <Return/>
       </If>
     </If>
     <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900))">
       <If condition="STRLEN(DELBOTHSPACE($DeaNod))!=6">
          <Set>MsgTyp=E</Set> 
          <Set>RspCod=329999</Set> 
          <Set>RspMsg=网点号错 </Set> 
          <Return/>
       </If>        
     </If>

      <Exec func="PUB:MultiQuery" />                               
    </FlowCtrl>                           
  </Transaction>                          

  <Transaction code="465834" desc="查询查复多笔浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select * from CbsQryJnl where OIFlag='%s' and (MatFlg='%s' or '%s'= '')and ( QryTyp='%s' or '%s'= '' )
        and ( SndDat='%s'  or '%s'='' ) and ( SOpnBk='%s' or '%s'='' )  and  ( ROpnBk='%s' or '%s'='' )
        and ( ReqSeq='%s'  or  '%s'='' ) and ( DeaNod='%s'  or '%s'='' ) and ( BrNo='%s'  or '%s'='' )
      </Sentence>
      <Fields>OIFlag|MatFlg|MatFlg|QryTyp|QryTyp|SndDat|SndDat|SOpnBk|SOpnBk|ROpnBk|ROpnBk|ReqSeq|ReqSeq|DeaNod|DeaNod|BrCd|BrCd|</Fields>
    </DynSentence>
    <DynSentence name="QryRec">
      <Sentence>
        select *
          from CbsQryJnl
        where SndDat='%s' and SndBNo='%s' and MsgSeq='%s' and OIFlag='%s'
      </Sentence>
      <Fields>SndDat|SndBNo|MsgSeq|OIFlag|</Fields>
    </DynSentence>

    <FlowCtrl>
      <If condition="IS_EQUAL_STRING($TIATyp,P)">
        <Set>Func=1</Set>
        <Exec func="PUB:MultiQuery" />
        <Return/>
       </If>
      <Switch expression="$Func">
        <Case value="1">
     <If condition="AND(IS_NOEQUAL_STRING($NodNo,441800),IS_NOEQUAL_STRING($NodNo,441900))">
       <If condition="STRLEN(DELBOTHSPACE($BrCd))!=6">
          <Set>MsgTyp=E</Set> 
          <Set>RspCod=329999</Set> 
          <Set>RspMsg=分行号错 </Set> 
          <Return/>
       </If>
     </If>
     <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900))">
       <If condition="STRLEN(DELBOTHSPACE($DeaNod))!=6">
          <Set>MsgTyp=E</Set> 
          <Set>RspCod=329999</Set> 
          <Set>RspMsg=网点号错 </Set> 
          <Return/>
       </If>        
     </If>
          <Exec func="PUB:MultiQuery" />
          <Return/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord" >
           <Args>
            <Arg name="SqlCmd" value="QryRec" />
           </Args>
          </Exec>        
          <Return/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>      

  <Transaction code="465835" desc="对帐合计信息浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select * from CbsCenTot where (CTraKnd='%s' or '%s'= '')and ( DBrCd='%s' or '%s'= '' )
        and ( ClrDat='%s'  or '%s'='' ) and ( AreaNo='%s' or '%s'='' )  and  ( CcyCod='%s' or '%s'='' )
      </Sentence>
      <Fields>CTraKnd|CTraKnd|DBrCd|DBrCd|ClrDat|ClrDat|AreaNo|AreaNo|CcyCod|CcyCod|</Fields>
    </DynSentence>
    <FlowCtrl>
     <Exec func="PUB:InitTransaction"/>
     <If condition="IS_EQUAL_STRING($TIATyp,P)">
       <Exec func="PUB:MultiQuery" />
      <Return/>
     </If>
      <Exec func="PUB:GetAppInfo" />
      <Exec func="PUB:MultiQuery" />                               
    </FlowCtrl>                           
  </Transaction>                          

  <Transaction code="465836" desc="汇兑统计监控信息浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select ActDat,OIFlag,BilSts,count(*) TotCnt,sum(cast(TxnAmt as BIGINT)) TotAmt from CbsTxnJnl where ActDat='%s'  and ( CcyCod='%s' or '%s'='' ) and ( BrNo='%s' or '%s'='' )
        group by  ActDat,OIFlag,BilSts
      </Sentence>
      <Fields>TxnDat|CcyCod|CcyCod|BrCd|BrCd|</Fields>
    </DynSentence>
    <FlowCtrl>
     <Exec func="PUB:InitTransaction"/>
     <If condition="IS_EQUAL_STRING($TIATyp,P)">
       <Exec func="PUB:MultiQuery" />
      <Return/>
     </If>
     <If condition="AND(IS_NOEQUAL_STRING($NodNo,441800),IS_NOEQUAL_STRING($NodNo,441900))">
       <If condition="STRLEN(DELBOTHSPACE($BrCd))!=6">
          <Set>MsgTyp=E</Set> 
          <Set>RspCod=329999</Set> 
          <Set>RspMsg=非指定部门不可操作</Set> 
          <Return/>
       </If>
     </If>
      <Exec func="PUB:GetAppInfo" />
      <Exec func="PUB:MultiQuery" />                               
    </FlowCtrl>                           
  </Transaction>                          


  <Transaction code="465706" desc="系统日终对帐">
   <DynSentence name="QryRec">
    <Sentence>
        select * from CbsCenTot where ClrDat='%s' and DBrCd='%s' and AreaNo='%s'
    </Sentence>
    <Fields>ClrDat|DBrCd|AreaNo|</Fields>
    </DynSentence>

   <!--人行借方汇兑来帐入客户钱(借）-->
   <DynSentence name="Qry1001D">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) DebAmt2,count(*) DebCnt2 from CbsTxnJnl where TraKnd='%s' and OIFlag='1' and CcyCod='%s' 
        and ClrDat='%s' and Bilsts in('Z','X','S','W','Q','V','M')
    </Sentence>
    <Fields>CTRaKnd|CcyCod|ClrDat|</Fields>
   </DynSentence>
   <!--人行贷方汇兑往帐扣客户钱（贷)-->
   <DynSentence name="Qry1001C">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) CreAmt2,count(*) CreCnt2 from CbsTxnJnl where TraKnd='%s' and OIFlag='0' and CcyCod='%s' 
        and ClrDat='%s' and Bilsts in('G')
    </Sentence>
    <Fields>CTRaKnd|CcyCod|ClrDat|</Fields>
   </DynSentence>

   <!--人行贷方机构来帐扣客户钱（贷) -->
   <DynSentence name="Qry1003C">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) CreAmt2,count(*) CreCnt2 from CbsTxnJnl where TraKnd='%s' and OIFlag='1' and CcyCod='%s' 
        and ClrDat='%s' and Bilsts in('Z','X','S','W','Q','V','M')
    </Sentence>
    <Fields>CTRaKnd|CcyCod|ClrDat|</Fields>
   </DynSentence>
   <!--人行借方银行往帐代收(借）-->
   <DynSentence name="Qry1003D">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) DebAmt2,count(*) DebCnt2 from CbsTxnJnl where TraKnd='%s' and OIFlag='0' and CcyCod='%s' 
        and ClrDat='%s' and Bilsts in('G')
    </Sentence>
    <Fields>CTRaKnd|CcyCod|ClrDat|</Fields>
   </DynSentence>

   <!--人行借方定期借记往帐(借）>
   <DynSentence name="Qry1052D">
    <Sentence>
        select sum(cast(TotAmt as BIGINT))-sum(cast(RefAmt as BIGINT)) DebAmt2,sum(cast(TotNum as BIGINT))-sum(cast(RefNum as BIGINT)) DebCnt2 from CbsBchSum where TraKnd='%s' and ClrDat='%s' and OIFlag='0'    and BchSts in('D')
    </Sentence>
    <Fields>CTRaKnd|ClrDat|</Fields>
   </DynSentence-->
   <!--人行贷方定期借记来帐（贷)>
   <DynSentence name="Qry1052C">
    <Sentence>
        select sum(cast(TotAmt as BIGINT))-sum(cast(RefAmt as BIGINT)) CreAmt2,sum(cast(TotNum as BIGINT))-sum(cast(RefNum as BIGINT)) CreCnt2 from CbsBchSum where TraKnd='%s' and ClrDat='%s' and OIFlag='1'    and BchSts in('D')
    </Sentence>
    <Fields>CTRaKnd|ClrDat|</Fields>
   </DynSentence-->

   <!--人行借方定期借记往帐(借）-->
   <DynSentence name="Qry1052D">
    <Sentence>
        
        select sum(cast(TxnAmt as BIGINT)) DebAmt2, count(*) DebCnt2 from CbsBchJnl where TraKnd='%s' and ClrDat='%s' and OIFlag='0'    and BilSts in ('Z','X','S','W','Q','V','M','G')
    </Sentence>
    <Fields>CTRaKnd|ClrDat|</Fields>
   </DynSentence>
   <!--人行贷方定期借记来帐（贷)-->
   <DynSentence name="Qry1052C">
    <Sentence>        
        select sum(cast(TxnAmt as BIGINT)) CreAmt2, count(*) CreCnt2 from CbsBchJnl where TraKnd='%s' and ClrDat='%s' and OIFlag='1'    and BilSts in ('Z','X','S','W','Q','V','M','G')
    </Sentence>
    <Fields>CTRaKnd|ClrDat|</Fields>
   </DynSentence>

   <!--人行借方定期贷记往帐(借）-->
   <DynSentence name="Qry1051D">
    <Sentence>
        
        select sum(cast(TxnAmt as BIGINT)) DebAmt2, count(*) DebCnt2 from CbsBchJnl where TraKnd='%s' and ClrDat='%s' and OIFlag='1'    and BilSts in ('Z','X','S','W','Q','V','M','G')
    </Sentence>
    <Fields>CTRaKnd|ClrDat|</Fields>
   </DynSentence>
   <!--人行贷方定期贷记来帐（贷)-->
   <DynSentence name="Qry1051C">
    <Sentence>        
        select sum(cast(TxnAmt as BIGINT)) CreAmt2, count(*) CreCnt2 from CbsBchJnl where TraKnd='%s' and ClrDat='%s' and OIFlag='0'    and BilSts in ('Z','X','S','W','Q','V','M','G')
    </Sentence>
    <Fields>CTRaKnd|ClrDat|</Fields>
   </DynSentence>




   <DynSentence name="UpdRec">
    <Sentence>
     update CbsCenTot Set ChkFlg='%s',DebAmt2='%s',DebCnt2='%s',CreAmt2='%s',CreCnt2='%s' 
     where CTraKnd='%s' and CcyCod='%s' and ClrDat='%s' and DBrCd='%s' and AreaNo='%s'
    </Sentence>
    <Fields>ChkFlg|DebAmt2|DebCnt2|CreAmt2|CreCnt2|CTRaKnd|CcyCod|ClrDat|DBrCd|AreaNo|</Fields>
   </DynSentence>

   <FlowCtrl>
    <Exec func="PUB:InitTransaction"/>
     <If condition="AND(IS_NOEQUAL_STRING($NodNo,441800),IS_NOEQUAL_STRING($NodNo,441900))">
          <Set>MsgTyp=E</Set> 
          <Set>RspCod=329999</Set> 
          <Set>RspMsg=非指定部门不可操作</Set> 
          <Return/>
    </If>
    <Exec func="PUB:OpenCursor">
     <Arg name="sql" value="QryRec"/>
    </Exec>
    <Set>AllChk=1</Set>
    <While>
     <Exec func="PUB:FetchCursor" error="IGNORE"/>
     <If condition="~RetCod=100">
       <Break/>
     </If>
     <Quote name="CursorErr" />     
     <If condition="OR(IS_EQUAL_STRING($CTRaKnd,1001),IS_EQUAL_STRING($CTRaKnd,1002),IS_EQUAL_STRING($CTRaKnd,3001))">
     <Set>DebStr=Qry1001D</Set>
     <Set>CreStr=Qry1001C</Set>
     </If>
     <ElseIf condition="IS_EQUAL_STRING($CTRaKnd,1003)">
     <Set>DebStr=Qry1003D</Set>
     <Set>CreStr=Qry1003C</Set>
     </ElseIf>     
     <ElseIf condition="OR(IS_EQUAL_STRING($CTRaKnd,1052),IS_EQUAL_STRING($CTRaKnd,XXXX))">
      <Set>DebStr=Qry1052D</Set>
      <Set>CreStr=Qry1052C</Set>
     </ElseIf>
     <ElseIf condition="OR(IS_EQUAL_STRING($CTRaKnd,XXXX),IS_EQUAL_STRING($CTRaKnd,1051))">
      <Set>DebStr=Qry1051D</Set>
      <Set>CreStr=Qry1051C</Set>
     </ElseIf>     
     <Else>
       <Continue/>
     </Else>
     <Exec func="PUB:ReadRecord"  error="IGNORE">
       <Args>
        <Arg name="SqlCmd" value="$DebStr" />
       </Args>
     </Exec>
     <Quote name="CursorErr" />     
     <Exec func="PUB:ReadRecord"  error="IGNORE">
       <Args>
        <Arg name="SqlCmd" value="$CreStr" />
       </Args>
     </Exec>
     <Quote name="CursorErr" />
     <Set>ChkFlg=0</Set>
     <If condition="AND(INTCMP($DebAmt,3,$DebAmt2),INTCMP($DebCnt,3,$DebCnt2),INTCMP($CreAmt,3,$CreAmt2),INTCMP($CreCnt,3,$CreCnt2))">
        <Set>ChkFlg=1</Set>
     </If>
     <Else>
       <Set>AllChk=0</Set>
     </Else>
     <Set>DebAmt2=ADDCHAR(DELSPACE($DebAmt2,all),15,0,1)</Set>
     <Set>DebCnt2=ADDCHAR(DELSPACE($DebCnt2,all),10,0,1)</Set>
     <Set>CreAmt2=ADDCHAR(DELSPACE($CreAmt2,all),15,0,1)</Set>
     <Set>CreCnt2=ADDCHAR(DELSPACE($CreCnt2,all),10,0,1)</Set>
     <Exec func="PUB:ExecSql" error="IGNORE">
      <Arg name="sql" value="UpdRec"/>
     </Exec>
     <Quote name="CursorErr" />
    </While>
    <Exec func="PUB:CloseCursor" error="IGNORE"/>
    <Exec  func="PUB:CommitWork"  /> <!--提交数据库事务-->
    <Exec func="PUB:GenerateReport">
     <Args>
      <Arg name="ObjFil" value="STRCAT(dat/term/send/,CBS006,$TlrId,.RPT)"/>
      <Arg name="FmtFil" value="etc/CBS006_RPT.XML"/>
      <Arg name="ClrDat" value="$ClrDat"/>
      <Arg name="DBrCd" value="$DBrCd"/>
      <Arg name="AreaNo" value="$AreaNo"/>
     </Args>
    </Exec>
    <Exec func="PUB:SendFileMessage">
     <Args>
      <Arg name="MsgTyp" value="4"/>
      <Arg name="ObjNod" value="$NodNo"/>
      <Arg name="BusTyp" value="CBS"/>
      <Arg name="AplCod" value="000001"/>
      <Arg name="FilNam" value="STRCAT(CBS006,$TlrId,.RPT)"/>
      <Arg name="Summary" value="CBS日终汇总对帐报表"/>
      <Arg name="ObjTlr" value="$TlrId"/>
     </Args>
     </Exec>
    <If condition="$AllChk=0">
     <Set>RspMsg=当前对帐不平，请核查打印的对帐报表 </Set>
    </If>
    <Else>
     <Set>RspMsg=当前对帐完成，请核查打印的对帐报表 </Set>
    </Else>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465708" desc="日终人行清算明细数据下载">
   <FlowCtrl>
    <Exec func="PUB:InitTransaction"/>
    <Set>DeaTyp=C</Set> <!--处理类型：非文件类-->
    <Set>TrsTyp=1</Set> <!--存储转发类-->
    <Set>MsgStu=145</Set> <!--报文结构-->
    <Set>TraKnd=8001</Set> <!--交易种类-->
    <Set>MsgId=2502</Set> <!--报文类型-->
    <Set>TxnKnd=800101</Set> 
    <Set>SndTm=GETDATETIME(YYYYMMDDHHMISS)</Set> 
    <Set>TraTm=SUBSTR($SndTm,5,10)</Set> <!--交易时间-->

     <If condition="AND(IS_NOEQUAL_STRING($NodNo,441800),IS_NOEQUAL_STRING($NodNo,441900))">
          <Set>MsgTyp=E</Set> 
          <Set>RspCod=329999</Set> 
          <Set>RspMsg=非指定部门不可操作</Set> 
          <Return/>
    </If>
    <!--生成信息流水号-->
    <Quote name="GetBusLog"/>
    <Set>@MSG.FLG=1</Set>
    <Exec func="PUB:CallThirdOther" >
     <Arg name="TxnCod" value="S00145" />
     <Arg name="ObjSvr" value="LTHDCBS1"/>
    </Exec>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465711" desc="分行日终清算汇总打印">
   <DynSentence name="QryRec">
    <Sentence>
        select * from CbsCenTot where ClrDat='%s' and DBrCd='%s' and AreaNo='%s'
    </Sentence>
    <Fields>ClrDat|DBrCd|AreaNo|</Fields>
    </DynSentence>
   <DynSentence name="DelBrNoRec">
    <Sentence>
        delete from CbsCenTot where ClrDat='%s' and DBrCd='%s'
    </Sentence>
    <Fields>ClrDat|BrNo|</Fields>
    </DynSentence>
    
   <!--人行借方汇兑来帐入客户钱(借）-->
   <DynSentence name="Qry1001D">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) DebAmt2,count(*) DebCnt2 from CbsTxnJnl where TraKnd='%s' and OIFlag='1' and CcyCod='%s' 
        and ClrDat='%s' and Bilsts in('Z','X','S','W','Q','V','M')  and BrNo='%s'
    </Sentence>
    <Fields>CTRaKnd|CcyCod|ClrDat|BrNo|</Fields>
   </DynSentence>
   <!--人行贷方汇兑往帐扣客户钱（贷)-->
   <DynSentence name="Qry1001C">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) CreAmt2,count(*) CreCnt2 from CbsTxnJnl where TraKnd='%s' and OIFlag='0' and CcyCod='%s' 
        and ClrDat='%s' and Bilsts in('G') and BrNo='%s'
    </Sentence>
    <Fields>CTRaKnd|CcyCod|ClrDat|BrNo|</Fields>
   </DynSentence>

   <!--人行贷方机构来帐扣客户钱（贷) -->
   <DynSentence name="Qry1003C">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) CreAmt2,count(*) CreCnt2 from CbsTxnJnl where TraKnd='%s' and OIFlag='1' and CcyCod='%s' 
        and ClrDat='%s' and Bilsts in('Z','X','S','W','Q','V','M') and BrNo='%s'
    </Sentence>
    <Fields>CTRaKnd|CcyCod|ClrDat|BrNo|</Fields>
   </DynSentence>
   <!--人行借方银行往帐代收(借）-->
   <DynSentence name="Qry1003D">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) DebAmt2,count(*) DebCnt2 from CbsTxnJnl where TraKnd='%s' and OIFlag='0' and CcyCod='%s' 
        and ClrDat='%s' and Bilsts in('G') and BrNo='%s'
    </Sentence>
    <Fields>CTRaKnd|CcyCod|ClrDat|BrNo|</Fields>
   </DynSentence>

   <!--人行借方定期借记往帐(借）>   
   <DynSentence name="Qry1052D">
    <Sentence>
        select sum(cast(TotAmt as BIGINT))-sum(cast(RefAmt as BIGINT)) DebAmt2,sum(cast(TotNum as BIGINT))-sum(cast(RefNum as BIGINT)) DebCnt2 from CbsBchSum where TraKnd='%s' and ClrDat='%s' and OIFlag='0'    and BchSts in('D') and BrNo='%s'
         txnamt, count(*)  Bilsts in ('G'
    </Sentence>
    <Fields>CTRaKnd|ClrDat|BrNo|</Fields>
   </DynSentence-->
   <DynSentence name="Qry1052D">
    <Sentence>        
        select sum(cast(TxnAmt as BIGINT)) DebAmt2, count(*)  DebCnt2 from CbsBchJnl where TraKnd='%s' and ClrDat='%s' and OIFlag='0'    and BilSts in('Z','X','S','W','Q','V','M','G') and BrNo='%s'
    </Sentence>
    <Fields>CTRaKnd|ClrDat|BrNo|</Fields>
   </DynSentence>
   <DynSentence name="Qry1051D">
    <Sentence>        
        select sum(cast(TxnAmt as BIGINT)) DebAmt2, count(*)  DebCnt2 from CbsBchJnl where TraKnd='%s' and ClrDat='%s' and OIFlag='1'    and BilSts in('Z','X','S','W','Q','V','M','G') and BrNo='%s'
    </Sentence>
    <Fields>CTRaKnd|ClrDat|BrNo|</Fields>
   </DynSentence>
   
   <!--人行贷方定期借记来帐（贷)>
   <DynSentence name="Qry1052C">
    <Sentence>
        select sum(cast(TotAmt as BIGINT))-sum(cast(RefAmt as BIGINT)) CreAmt2,sum(cast(TotNum as BIGINT))-sum(cast(RefNum as BIGINT)) CreCnt2 from CbsBchSum where TraKnd='%s' and ClrDat='%s' and OIFlag='1'    and BchSts in('D') and BrNo='%s'
    </Sentence>
    <Fields>CTRaKnd|ClrDat|BrNo|</Fields>
   </DynSentence-->
   <DynSentence name="Qry1052C">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) CreAmt2, count(*) CreCnt2 from CbsBchJnl where TraKnd='%s' and ClrDat='%s' and OIFlag='1'    and BilSts in ('Z','X','S','W','Q','V','M','G') and BrNo='%s'
    </Sentence>
    <Fields>CTRaKnd|ClrDat|BrNo|</Fields>
   </DynSentence>
   <DynSentence name="Qry1051C">
    <Sentence>
        select sum(cast(TxnAmt as BIGINT)) CreAmt2, count(*) CreCnt2 from CbsBchJnl where TraKnd='%s' and ClrDat='%s' and OIFlag='0'    and BilSts in ('Z','X','S','W','Q','V','M','G') and BrNo='%s'
    </Sentence>
    <Fields>CTRaKnd|ClrDat|BrNo|</Fields>
   </DynSentence>

   <FlowCtrl>
    <Exec func="PUB:GetBranchNoByNodeNo"/>
    <Exec func="PUB:InitTransaction"/>
     <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900))">
          <Set>MsgTyp=E</Set> 
          <Set>RspCod=329999</Set> 
          <Set>RspMsg=非交易使用网点</Set> 
          <Return/>
    </If>
     <Exec func="PUB:ExecSql" error="IGNORE">
      <Arg name="sql" value="DelBrNoRec"/>
     </Exec>
    <Exec func="PUB:OpenCursor">
     <Arg name="sql" value="QryRec"/>
    </Exec>    
    <Set>AllChk=1</Set>
    <While>
     <Exec func="PUB:FetchCursor" error="IGNORE"/>
     <If condition="~RetCod=100">
       <Break/>
     </If>
     <Quote name="CursorErr" />
     <Set>DBrCd=$BrNo</Set>
     <Set>ChkFlg=0</Set>
     <Set>CreAmt=000000000000000</Set>
     <Set>CreCnt=0</Set>
     <Set>DebAmt=000000000000000</Set>
     <Set>DebCnt=0</Set>
     
     <If condition="OR(IS_EQUAL_STRING($CTRaKnd,1001),IS_EQUAL_STRING($CTRaKnd,1002),IS_EQUAL_STRING($CTRaKnd,3001))">
     <Set>DebStr=Qry1001D</Set>
     <Set>CreStr=Qry1001C</Set>
     </If>
     <ElseIf condition="IS_EQUAL_STRING($CTRaKnd,1003)">
     <Set>DebStr=Qry1003D</Set>
     <Set>CreStr=Qry1003C</Set>
     </ElseIf>     
     <ElseIf condition="OR(IS_EQUAL_STRING($CTRaKnd,1052),IS_EQUAL_STRING($CTRaKnd,XXXX))">
      <Set>DebStr=Qry1052D</Set>
      <Set>CreStr=Qry1052C</Set>
     </ElseIf>
     <ElseIf condition="OR(IS_EQUAL_STRING($CTRaKnd,XXXX),IS_EQUAL_STRING($CTRaKnd,1051))">
      <Set>DebStr=Qry1051D</Set>
      <Set>CreStr=Qry1051C</Set>
     </ElseIf>     
     <Else>
       <Continue/>
     </Else>
     <Exec func="PUB:ReadRecord"  error="IGNORE">
       <Args>
        <Arg name="SqlCmd" value="$DebStr" />
       </Args>
     </Exec>
     <Quote name="CursorErr" />     
     <Exec func="PUB:ReadRecord"  error="IGNORE">
       <Args>
        <Arg name="SqlCmd" value="$CreStr" />
       </Args>
     </Exec>
     <Quote name="CursorErr" />
     
     <Set>DebAmt2=ADDCHAR(DELSPACE($DebAmt2,all),15,0,1)</Set>
     <Set>DebCnt2=ADDCHAR(DELSPACE($DebCnt2,all),10,0,1)</Set>
     <Set>CreAmt2=ADDCHAR(DELSPACE($CreAmt2,all),15,0,1)</Set>
     <Set>CreCnt2=ADDCHAR(DELSPACE($CreCnt2,all),10,0,1)</Set>

     <Exec func="PUB:InsertRecord" error="IGNORE">
       <Arg name="TblNam" value="CbsCenTot"/>
     </Exec>
     <Quote name="CursorErr" />
    </While>
    <Exec func="PUB:CloseCursor" error="IGNORE"/>
    <Exec  func="PUB:CommitWork"  /> <!--提交数据库事务-->
    <Set>RspCod=000000</Set> 
    <Exec func="PUB:GenerateReport">
     <Args>
      <Arg name="ObjFil" value="STRCAT(dat/term/send/,CBS012,$TlrId,.RPT)"/>
      <Arg name="FmtFil" value="etc/CBS012_RPT.XML"/>
      <Arg name="ClrDat" value="$ClrDat"/>
      <Arg name="BrNo"   value="$BrNo"/>
      <Arg name="AreaNo" value="$AreaNo"/>
     </Args>
    </Exec>
    <Exec func="PUB:SendFileMessage">
     <Args>
      <Arg name="MsgTyp" value="4"/>
      <Arg name="ObjNod" value="$NodNo"/>
      <Arg name="BusTyp" value="CBS"/>
      <Arg name="AplCod" value="000001"/>
      <Arg name="FilNam" value="STRCAT(CBS012,$TlrId,.RPT)"/>
      <Arg name="Summary" value="分行日终清算汇总报表"/>
      <Arg name="ObjTlr" value="$TlrId"/>
     </Args>
     </Exec>
     <Set>RspMsg=请查看打印报表 </Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="465825" desc="广东省集中式代收付协议维护">
    <DynSentence name="QryRec1">
      <Sentence>
        select *
          from CbsCenAgr
         where AgrNo='%s ' and UsrCod='%s' and Status='1'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>
    <DynSentence name="QryStatus">
      <Sentence>
        select Status,AgrWay 
          from CbsCenAgr 
         where AgrNo='%s ' and UsrCod='%s'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>
     <DynSentence name="DelAgr"> <!--删除集中式代收付协议信息-->
       <Sentence>
         delete from CbsCenAgr where AgrNo='%s' and UsrCod='%s' and Status='0'
       </Sentence>
       <Fields>AgrNo|UsrCod|</Fields>
     </DynSentence>     
      <DynSentence name="UpdIvd"> <!--更新集中式代收付协议信息为删除-->
        <Sentence>
          update CbsCenAgr Set Status='0', ChgMod='0', ChkFlg='0', TxnDat='%s', IvdDat='%s' ,FilTyp='00',FilMrk='',CasCod='',TlrId='%s'
          where AgrNo='%s' and UsrCod='%s'
        </Sentence>
        <Fields>ActDat|ActDat|TlrId|AgrNo|UsrCod|</Fields>
      </DynSentence>
      <DynSentence name="UpdLnk"> <!--修改信息-->
        <Sentence>
          update CbsCenAgr Set ChgMod='2',ChkFlg='0',FilTyp='00',FilMrk='',CasCod='',TxnDat='%s',TlrId='%s',LnkTel='%s',LnkAdr='%s',LnkPst='%s',LnkNam='%s'
          where AgrNo='%s' and UsrCod='%s'
        </Sentence>
        <Fields>ActDat|TlrId|LnkTel|LnkAdr|LnkPst|LnkNam|AgrNo|UsrCod|</Fields>
      </DynSentence>
      <DynSentence name="UpdAgr"> <!--修改协议-->
        <Sentence>
          update CbsCenAgr Set TlrId='%s',ChgMod='2',ChkFlg='0',FilTyp='00',FilMrk='',CasCod='',TxnDat='%s',LnkTel='%s',LnkAdr='%s',LnkPst='%s',LnkNam='%s',PayMob='%s',PayIdTy='%s',PayIdNo='%s',LmtAmt='%s'
          where AgrNo='%s' and UsrCod='%s'
        </Sentence>
        <Fields>TlrId|ActDat|LnkTel|LnkAdr|LnkPst|LnkNam|PayMob|PayIdTy|PayIdNo|LmtAmt|AgrNo|UsrCod|</Fields>
      </DynSentence>
    <DynSentence name="Exist_Add">
      <Sentence>
        SELECT 'Y' YN from table(values(1)) as anony where exists(
        select * from CbsCenAgr  where  FilTyp='00'  and AgrWay in ('0','2') and ChkFlg='0'  and ChgMod !='2' and AgrNo='%s' and UsrCod='%s'
        )
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>      
    </DynSentence>
    <DynSentence name="IsCenOrg">
      <Sentence>
        SELECT 'Y' YN from table(values(1)) as anony where exists(
        select * from CbsCenOrg  where  OrgCod='%s'
        )
      </Sentence>
      <Fields>OrgCod|</Fields>      
    </DynSentence>
    <DynSentence name="Exist_3AAgr">
      <Sentence>
        SELECT 'Y' YN from table(values(1)) as anony where exists(
        select * from CbsCenAgr where  AgrNo='%s' and Status='1'
        )
      </Sentence>
      <Fields>AgrNo|</Fields>
    </DynSentence>
    
      
    <FlowCtrl>
      <Set>TipMsg= </Set>
      <Switch expression="$Func">
        <Case value="4">
          <Set>FuncStr=查询 </Set>
          <Exec func="PUB:ReadRecord" error="IGNORE">
           <Args>
            <Arg name="SqlCmd" value="QryRec1" />
           </Args>
          </Exec>
          <If condition="~RetCod=-1">          
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>          
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=协议不存在</Set>
            <Return/>
          </If>  
          <If condition="IS_EQUAL_STRING($AgrWay,1)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=在机构签约的记录银行不做维护</Set>
            <Return/>            
          </If>  
          <Return/>
        </Case>        
        <Case value="1">  
          <Set>CenOrgFlg=0</Set>
          <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="IsCenOrg" />
          </Exec>
          <If condition="~RetCod =-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999 </Set>
            <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
            <Return/>
          </If>
          <ElseIf condition="~RetCod =0">
            <Set>CenOrgFlg=1</Set>
          </ElseIf>          
          <Set>FuncStr=新增 </Set>
          <Set>TxnDat=$ActDat</Set>
          <If condition="IS_EQUAL_STRING($AutFlg,1)">
             <Set>AgrNo=STRCAT(0,$AgrTyp,$CtyCod,$OrgCod,$SBusTy,301,DELBOTHSPACE($PayAct))</Set>
          </If>   

          <If condition="IS_EQUAL_STRING($CenOrgFlg,1)">                   
            <Exec func="PUB:ReadRecord" error="IGNORE" >
              <Arg name="SqlCmd" value="Exist_Add" />
            </Exec>
            <If condition="~RetCod =-1">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=329999 </Set>
              <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
              <Return/>
            </If>
            <ElseIf condition="~RetCod =0">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=329999</Set>
              <Set>RspMsg=未验证的记录不可做新增 </Set>
              <Return/>
            </ElseIf>
          </If>                         
          <If condition="IS_NOEQUAL_STRING(DELBOTHSPACE($PayAct),SUBSTR($AgrNo,24,STRLEN(DELBOTHSPACE($PayAct))))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=协议号和付款账号不符 </Set>
            <Return/>           
          </If>
           <If condition="IS_NOEQUAL_STRING(DELBOTHSPACE($OrgCod),SUBSTR($AgrNo,7,STRLEN(DELBOTHSPACE($OrgCod))))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=协议号和机构编号不符 </Set>
            <Return/>           
           </If>
           <If condition="IS_NOEQUAL_STRING(DELBOTHSPACE($CtyCod),SUBSTR($AgrNo,3,STRLEN(DELBOTHSPACE($CtyCod))))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=协议号和城市代号不符 </Set>
            <Return/>           
           </If>
           <If condition="IS_NOEQUAL_STRING(DELBOTHSPACE($AgrTyp),SUBSTR($AgrNo,2,STRLEN(DELBOTHSPACE($AgrTyp))))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=协议号和协议类型不符 </Set>
            <Return/>           
           </If>           
           
          <Exec func="PUB:ReadRecord" error="IGNORE">
           <Args>
            <Arg name="SqlCmd" value="QryStatus" />
           </Args>
          </Exec>
          <If condition="~RetCod=-1">          
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>
          <ElseIf condition="~RetCod=0">
            <If condition="IS_EQUAL_STRING($Status,0)"> 
              <Exec func="PUB:ExecSql" error="IGNORE"> <!--删掉协议号码相同的协议-->
                 <Arg name="SqlCmd"   value="DelAgr"/>
              </Exec>                       
            </If>
            <Else>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=329999</Set>
              <Set>RspMsg=该合同协议已经存在，交易取消</Set>            
              <Return/>
            </Else>            
          </ElseIf>
          <If condition="OR(IS_EQUAL_STRING($SBusTy,$AAA_ZDJF),IS_EQUAL_STRING($SBusTy,$AAA_QYZZ))">          
           <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="Exist_3AAgr" />
           </Exec>
           <If condition="~RetCod =-1">
               <Set>RspMsg=数据库操作错，交易中断 </Set>                         
               <Set>RspCod=329999</Set>
               <Return/>                                                
           </If>
           <ElseIf condition="~RetCod =0">
               <Set>RspMsg=STRCAT(数据已存在,$AgrNo) </Set>
               <Set>RspCod=329999</Set>
               <Return/>                                                
           </ElseIf>          
          </If>          
          <Set>Status=1</Set>
          <Set>ChgMod=1</Set>
          <Exec func="PUB:InsertRecord">
             <Arg name="TblNam" value="CbsCenAgr"/>
          </Exec>
          <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="IsCenOrg" />
          </Exec>
          <If condition="~RetCod =-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999 </Set>
            <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
            <Return/>
          </If>
          <ElseIf condition="~RetCod =0">
            <Set>TipMsg=STRCAT($TipMsg,需中心确认*集中代收付业务机构*)</Set>
          </ElseIf>
          <If condition="OR(IS_EQUAL_STRING($SBusTy,$AAA_ZDJF),IS_EQUAL_STRING($SBusTy,$AAA_QYZZ))">
            <Set>TipMsg=STRCAT($TipMsg,3A支付网业务*)</Set>
          </If>
          <Set>RspCod=000000</Set>
          <Break/>
        </Case>
        <Case value="2">
          <Set>FuncStr=撤消 </Set>
          <Exec func="PUB:ReadRecord" error="IGNORE">
           <Args>
            <Arg name="SqlCmd" value="QryStatus" />
           </Args>
          </Exec>
          <If condition="~RetCod !=0 ">          
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>
          <Else>
            <If condition="IS_EQUAL_STRING($AgrWay,1)">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=329999</Set>
              <Set>RspMsg=撤消只能由原签约机构发起</Set>
              <Return/>
            </If>            
          </Else>
           <Exec func="PUB:ExecSql">
              <Arg name="sql" value="UpdIvd"/>
          </Exec>
          <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="IsCenOrg" />
          </Exec>
          <If condition="~RetCod =-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999 </Set>
            <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
            <Return/>
          </If>
          <ElseIf condition="~RetCod =0">
            <Set>TipMsg=STRCAT($TipMsg,需中心确认*集中代收付业务机构*)</Set>
          </ElseIf>
          <If condition="OR(IS_EQUAL_STRING($SBusTy,$AAA_ZDJF),IS_EQUAL_STRING($SBusTy,$AAA_QYZZ))">
            <Set>TipMsg=STRCAT($TipMsg,3A支付网业务*)</Set>
          </If>
          <Set>RspCod=000000</Set>          
          <Break/>
        </Case>
        <Case value="3">
          <Set>CenOrgFlg=0</Set>
          <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="IsCenOrg" />
          </Exec>
          <If condition="~RetCod =-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999 </Set>
            <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
            <Return/>
          </If>
          <ElseIf condition="~RetCod =0">
            <Set>CenOrgFlg=1</Set>
          </ElseIf>          
          <Set>FuncStr=修改 </Set>

          <If condition="IS_EQUAL_STRING($CenOrgFlg,1)">                             
            <Exec func="PUB:ReadRecord" error="IGNORE" >
              <Arg name="SqlCmd" value="Exist_Add" />
            </Exec>
            <If condition="~RetCod =-1">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=329999 </Set>
              <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
              <Return/>
            </If>
            <ElseIf condition="~RetCod =0">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=329999</Set>
              <Set>RspMsg=未验证的记录不可做修改 </Set>
              <Return/>
            </ElseIf>          
          </If>          
          <If condition="OR(IS_EQUAL_STRING($SBusTy,$AAA_ZDJF),IS_EQUAL_STRING($SBusTy,$AAA_QYZZ))">
             <Exec func="PUB:ExecSql">
              <Arg name="sql" value="UpdAgr"/>
            </Exec>                        
          </If>
          <Else>
             <Exec func="PUB:ExecSql">
              <Arg name="sql" value="UpdLnk"/>
            </Exec>            
          </Else>
          <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="IsCenOrg" />
          </Exec>
          <If condition="~RetCod =-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999 </Set>
            <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
            <Return/>
          </If>
          <ElseIf condition="~RetCod =0">
            <Set>TipMsg=STRCAT($TipMsg,需中心确认*集中代收付业务机构*)</Set>
          </ElseIf>
          <If condition="OR(IS_EQUAL_STRING($SBusTy,$AAA_ZDJF),IS_EQUAL_STRING($SBusTy,$AAA_QYZZ))">
            <Set>TipMsg=STRCAT($TipMsg,3A支付网业务*)</Set>
          </If>
          <Set>RspCod=000000</Set>                    
          <Break/>
        </Case>        
      </Switch>
       <!--申请非会计流水-->
       <Set>Msg=STRCAT(省集中代收付协议维护*功能:,$Func,协议编号:,$AgrNo,用户编码:,$UsrCod)</Set>       
       <Exec  func="PUB:GetLogNo"/>
       <Set>TTxnCd=355910</Set>
       <Exec func="PUB:CallHostOther">
         <Arg name="TxnCod" value="355910"/>
         <Arg name="ObjSvr" value="SHSTPUB2"/>
       </Exec>
       <If condition="~RetCod!=0">
         <Exec func="PUB:CallHostOther">
           <Arg name="TxnCod" value="355910"/>
           <Arg name="ObjSvr" value="SHSTPUB2"/>
         </Exec>         
       </If>      
       <Set>BillText= </Set>
       <Set>RspCod=000000</Set>
       <Set>MsgTyp=N</Set>       
    </FlowCtrl>
  </Transaction>

  <Transaction code="465826" desc="广东省集中式代收付文件发送">
   <DynSentence name="Qry_New">
    <Sentence>
        select * from CbsCenAgr  where FilTyp='00'  and ChkFlg = '0' and (AgrWay ='0' or (AgrWay ='2' and ChgMod !='1' ))  and OrgCod in (select OrgCod from CbsCenOrg )
    </Sentence>
    </DynSentence>
   <DynSentence name="Qry_Mov">
    <Sentence>
        select * from CbsCenAgr  where FilTyp='00' and AgrWay='2' and ChkFlg = '0' and ChgMod='1'  and OrgCod in (select OrgCod from CbsCenOrg)
    </Sentence>
    </DynSentence>
   <DynSentence name="Qry_Chk">
    <Sentence>
        select * from CbsCenAgr where  FilTyp='ZF'  and ChkFlg != '0' 
    </Sentence>
    </DynSentence>
    <DynSentence name="Exist_New">
      <Sentence>
        SELECT 'Y' YN from table(values(1)) as anony where exists(
        select a.* from CbsCenAgr a,CbsCenOrg b               where  a.FilTyp='00'  and a.ChkFlg='0' and (a.AgrWay ='0' or (a.AgrWay ='2' and a.ChgMod !='1' ))  and a.OrgCod=b.OrgCod 
        )
      </Sentence>
    </DynSentence>
    <DynSentence name="Exist_Mov">
      <Sentence>
        SELECT 'Y' YN from table(values(1)) as anony where exists(
        select a.* from CbsCenAgr a, CbsCenOrg b where a.FilTyp='00' and a.AgrWay ='2' and a.ChkFlg='0' and a.ChgMod='1' and a.OrgCod=b.OrgCod 
        )
      </Sentence>
    </DynSentence>
    <DynSentence name="Exist_Chk">
      <Sentence>
        SELECT 'Y' YN from table(values(1)) as anony where exists(
        select * from CbsCenAgr where  FilTyp='ZF'  and ChkFlg != '0' 
        )
      </Sentence>
    </DynSentence>
   <DynSentence name="UpdAgr">
    <Sentence>
        update CbsCenAgr Set FilTyp='%s',FilMrk='%s',ChkFlg='%s'  where AgrNo='%s' and UsrCod='%s'
    </Sentence>
    <Fields>SFilTyp|FilNm1|ChkFlg|AgrNo|UsrCod|</Fields>
    </DynSentence>
   <DynSentence name="Qry_OldData">
    <Sentence>
        select AgrNo,PyrAct PayAct,PyrNam PayNam,PyrOpn PayOBnk,TlrId,NodNo,OpnDat from lbepcusagr where substr(AgrNo,2,1)='%s'  and substr(AgrNo,7,9)='%s' and Status='0'
    </Sentence>
    <Fields>QAgrTyp|QOrgCod|</Fields>
    </DynSentence>
    <DynSentence name="Exist_YiZhi">
      <Sentence>
        SELECT 'Y' YN from table(values(1)) as anony where exists(
        select * from CbsCenAgr where  AgrNo='%s' 
        )
      </Sentence>
      <Fields>AgrNo|</Fields>
    </DynSentence>
        
    <FlowCtrl>
     <If condition="AND(IS_NOEQUAL_STRING($NodNo,441800),IS_NOEQUAL_STRING($NodNo,441900))">
          <Set>MsgTyp=E</Set> 
          <Set>RspCod=329999</Set> 
          <Set>RspMsg=本交易只有省行管理才有权限 </Set> 
          <Return/>
     </If>
      <Set>OTlrId=$TlrId</Set>
      <Set>ONodNo=$NodNo</Set>
      <Switch expression="$SFilTyp">
        <Case value="LR"> <!--发送合同签约文件-->
          <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="Exist_New" />
          </Exec>
          <If condition="~RetCod =-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999 </Set>
            <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
            <Return/>
          </If>
          <ElseIf condition="~RetCod !=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=本日无需要发送的签约数据 </Set>
            <Return/>
          </ElseIf>
          <Exec func="PUB:nGetPubSeqNo">            <!--文件编号-->
            <Arg name="SeqNam" value="CBS:AgrFil"/>  <!--返回文件记录标识-->
            <Arg name="Len"    value="6"/>
            <Arg name="CycCnd" value="D"/>
          </Exec>
          
          <Set>FilNm1=STRCAT(XY,1,301581000019,$ActDat,$SelVal)</Set>
          <Set>SFilNm1=STRCAT($TSDir,CBSD_,$FilNm1) </Set>
          <Exec func="PUB:OpenCursor">
            <Arg name="sql" value="Qry_New"/>
          </Exec>
          <Set>Count=0</Set>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
              <Exec func="PUB:CloseCursor"/>
              <Set>RspCod=000000</Set>
              <Break/>
            </If>
            <Else>
              <Set>LmtAct=DELSPACE($LmtAct,all)</Set>
              <Exec func="PUB:WriteFile" >
                <Arg name="FileName" value="$SFilNm1"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="$AgrNo"/> 
                <Arg name="Data"   value=":"/>                
                <Arg name="Data"   value="$ChgMod"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$UsrCod"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$UsrNam"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkNam"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkAdr"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkPst"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkTel"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$OrgCod"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$SBusTy"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayOBnk"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayAct"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayNam"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayIdTy"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayIdNo"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayMob"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayEml"/> 
                <Arg name="Data"   value=":"/>                 
                <Arg name="Data"   value="$TxnDat"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$Smr"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="CP1I1000"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LmtAmt"/>
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LmtAct"/>
                <Arg name="ESCFMT" value="\\n"/>
              </Exec>
              <Set>Count=ADD($Count,1)</Set>
              <Set>ChkFlg=1</Set>
               <Exec func="PUB:ExecSql" error="IGNORE">
                <Arg name="sql" value="UpdAgr"/>
              </Exec>
            </Else>
          </While>
          <Set>Count=ADDCHAR($Count,8,0,1)</Set>
          <Set>FilNm1Siz=GETFILESIZE($SFilNm1)</Set>
          <Set>FilNamSiz=ADDCHAR(ADD($FilNm1Siz,48),8,0,1)</Set>
          <Set>FilNam=STRCAT($FilNm1,$FilNamSiz)</Set>
          <Set>SFilNam=STRCAT($TSDir,$FilNam)</Set>
          <Exec func="PUB:WriteFile" >
                <Arg name="FileName" value="$SFilNam"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="LR"/> 
                <Arg name="Data"   value="ADDCHAR($FilNam,37, ,0)"/>                
                <Arg name="Data"   value="$Count"/> 
                <Arg name="ESCFMT" value="\\n"/>
          </Exec>
          <Exec func="PUB:CatFile" >
                <Arg name="ObjFil" value="$SFilNam"/>
                <Arg name="SrcFile" value="$SFilNm1"/>
          </Exec>          
          <Set>Summary=发送集中代收付签约文件 </Set>
          <Exec func="PUB:SendFileMessage2">
            <Arg name="MsgTyp"  value="3"/>
            <Arg name="ObjNod"  value="$ONodNo"/>
            <Arg name="BusTyp"  value="46"/>
            <Arg name="AplCod"  value="$TxnCod"/>
            <Arg name="FilNam"  value="$FilNam"/>
            <Arg name="Summary" value="$Summary"/>
            <Arg name="ObjTlr"  value="$OTlrId"/> 
          </Exec>                            
          <Break/>          
        </Case>
        
        <Case value="HF"> <!--发送核验结果文件-->
          <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="Exist_Chk" />
          </Exec>
          <If condition="~RetCod =-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999 </Set>
            <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
            <Return/>
          </If>
          <ElseIf condition="~RetCod !=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=本日无需要发送的核验数据 </Set>
            <Return/>
          </ElseIf>
          <Exec func="PUB:nGetPubSeqNo">            <!--文件编号-->
            <Arg name="SeqNam" value="CBS:AgrFil"/>  <!--返回文件记录标识-->
            <Arg name="Len"    value="6"/>
            <Arg name="CycCnd" value="D"/>
          </Exec>
          
          <Set>FilNm1=STRCAT(XY,1,301581000019,$ActDat,$SelVal)</Set>
          <Set>SFilNm1=STRCAT($TSDir,CBSD_,$FilNm1) </Set>
          <Exec func="PUB:OpenCursor">
            <Arg name="sql" value="Qry_Chk"/>
          </Exec>
          <Set>Count=0</Set>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
              <Exec func="PUB:CloseCursor"/>
              <Set>RspCod=000000</Set>
              <Break/>
            </If>
            <Else>
              <Set>LmtAct=DELSPACE($LmtAct,all)</Set>
              <Exec func="PUB:WriteFile" >
                <Arg name="FileName" value="$SFilNm1"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="$AgrNo"/> 
                <Arg name="Data"   value=":"/>                
                <Arg name="Data"   value="$ChgMod"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$UsrCod"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$UsrNam"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkNam"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkAdr"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkPst"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkTel"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$OrgCod"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$SBusTy"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayOBnk"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayAct"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayNam"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayIdTy"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayIdNo"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayMob"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayEml"/> 
                <Arg name="Data"   value=":"/>                                 
                <Arg name="Data"   value="$TxnDat"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$Smr"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$CasCod"/>   
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LmtAmt"/>
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LmtAct"/>                                
                <Arg name="ESCFMT" value="\\n"/>
              </Exec>
              <Set>Count=ADD($Count,1)</Set>                            
               <Exec func="PUB:ExecSql" error="IGNORE">
                <Arg name="sql" value="UpdAgr"/>
              </Exec>
            </Else>
          </While>
          <Set>Count=ADDCHAR($Count,8,0,1)</Set>
          <Set>FilNm1Siz=GETFILESIZE($SFilNm1)</Set>
          <Set>FilNamSiz=ADDCHAR(ADD($FilNm1Siz,48),8,0,1)</Set>
          <Set>FilNam=STRCAT($FilNm1,$FilNamSiz)</Set>
          <Set>SFilNam=STRCAT($TSDir,$FilNam)</Set>
          <Exec func="PUB:WriteFile" >
                <Arg name="FileName" value="$SFilNam"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="HF"/> 
                <Arg name="Data"   value="ADDCHAR($FilNam,37, ,0)"/>                
                <Arg name="Data"   value="$Count"/> 
                <Arg name="ESCFMT" value="\\n"/>
          </Exec>
          <Exec func="PUB:CatFile" >
                <Arg name="ObjFil" value="$SFilNam"/>
                <Arg name="SrcFile" value="$SFilNm1"/>
          </Exec>          
          <Set>Summary=发送集中代收付协议核验文件 </Set>
          <Exec func="PUB:SendFileMessage2">
            <Arg name="MsgTyp"  value="3"/>
            <Arg name="ObjNod"  value="$ONodNo"/>
            <Arg name="BusTyp"  value="46"/>
            <Arg name="AplCod"  value="$TxnCod"/>
            <Arg name="FilNam"  value="$FilNam"/>
            <Arg name="Summary" value="$Summary"/>
            <Arg name="ObjTlr"  value="$OTlrId"/> 
          </Exec>                                    
          <Break/>
        </Case>
        
        <Case value="QY"> <!--发送数据移植文件-->
          <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="Exist_Mov" />
          </Exec>
          <If condition="~RetCod =-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999 </Set>
            <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
            <Return/>
          </If>
          <ElseIf condition="~RetCod !=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=本日无需要发送的协议移植数据 </Set>
            <Return/>
          </ElseIf>
          <Exec func="PUB:nGetPubSeqNo">            <!--文件编号-->
            <Arg name="SeqNam" value="CBS:AgrFil"/>  <!--返回文件记录标识-->
            <Arg name="Len"    value="6"/>
            <Arg name="CycCnd" value="D"/>
          </Exec>          
          <Set>FilNm1=STRCAT(XY,1,301581000019,$ActDat,$SelVal)</Set>
          <Set>SFilNm1=STRCAT($TSDir,CBSD_,$FilNm1) </Set>
          <Exec func="PUB:OpenCursor">
            <Arg name="sql" value="Qry_Mov"/>
          </Exec>
          <Set>Count=0</Set>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
              <Exec func="PUB:CloseCursor"/>
              <Set>RspCod=000000</Set>
              <Break/>
            </If>
            <Else>
              <Exec func="PUB:WriteFile" >
                <Arg name="FileName" value="$SFilNm1"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="$AgrNo"/> 
                <Arg name="Data"   value=":"/>                
                <Arg name="Data"   value="$ChgMod"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$UsrCod"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$UsrNam"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkNam"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkAdr"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkPst"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LnkTel"/> 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$OrgCod"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$SBusTy"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayOBnk"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayAct"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayNam"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayIdTy"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayIdNo"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayMob"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayEml"/> 
                <Arg name="Data"   value=":"/>                                 
                <Arg name="Data"   value="$TxnDat"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$Smr"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="CP1I1000"/>                 
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LmtAmt"/>
                <Arg name="Data"   value=":"/>
                <Arg name="Data"   value="$LmtAct"/>                  
                <Arg name="ESCFMT" value="\\n"/>
              </Exec>
              <Set>Count=ADD($Count,1)</Set>
              <Set>ChkFlg=0</Set>
               <Exec func="PUB:ExecSql" error="IGNORE">
                <Arg name="sql" value="UpdAgr"/>
              </Exec>
            </Else>
          </While>
          <Set>Count=ADDCHAR($Count,8,0,1)</Set>
          <Set>FilNm1Siz=GETFILESIZE($SFilNm1)</Set>
          <Set>FilNamSiz=ADDCHAR(ADD($FilNm1Siz,48),8,0,1)</Set>
          <Set>FilNam=STRCAT($FilNm1,$FilNamSiz)</Set>
          <Set>SFilNam=STRCAT($TSDir,$FilNam)</Set>
          <Exec func="PUB:WriteFile" >
                <Arg name="FileName" value="$SFilNam"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="QY"/> 
                <Arg name="Data"   value="ADDCHAR($FilNam,37, ,0)"/>                
                <Arg name="Data"   value="$Count"/> 
                <Arg name="ESCFMT" value="\\n"/>
          </Exec>
          <Exec func="PUB:CatFile" >
                <Arg name="ObjFil" value="$SFilNam"/>
                <Arg name="SrcFile" value="$SFilNm1"/>
          </Exec>          
          <Set>Summary=发送集中代收付协议移植文件 </Set>
          <Exec func="PUB:SendFileMessage2">
            <Arg name="MsgTyp"  value="3"/>
            <Arg name="ObjNod"  value="$ONodNo"/>
            <Arg name="BusTyp"  value="46"/>
            <Arg name="AplCod"  value="$TxnCod"/>
            <Arg name="FilNam"  value="$FilNam"/>
            <Arg name="Summary" value="$Summary"/>
            <Arg name="ObjTlr"  value="$OTlrId"/> 
          </Exec>                                    
          <Break/>
        </Case>  
        <Case value="99"> <!--数据移植-->
          <Set>ErrFil=STRCAT(CBS_XYERR,$QAgrTyp,$QOrgCod)</Set>        
          <Set>SErrFil=STRCAT($TSDir,$ErrFil) </Set>
          <Exec func="PUB:WriteFile" >
                <Arg name="FileName" value="$SErrFil"/>
                <Arg name="OpenMode" value="w"/>
                <Arg name="Data"   value="集中代收付合同协议移植出错清单"/> 
                <Arg name="Data"   value=":协议类型="/> 
                <Arg name="Data"   value="$QAgrTyp"/>
                <Arg name="Data"   value=":机构代码="/> 
                <Arg name="Data"   value="$QOrgCod"/>                
                <Arg name="ESCFMT" value="\\n"/>
          </Exec>          
          <Exec func="PUB:OpenCursor">
            <Arg name="sql" value="Qry_OldData"/>
          </Exec>
          <Set>MyCnt=0</Set>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
              <Exec func="PUB:CloseCursor"/>
              <Set>RspCod=000000</Set>
              <Break/>
            </If>
            <If condition="IS_NOEQUAL_STRING(DELBOTHSPACE(SUBSTR($AgrNo,24,21)),DELBOTHSPACE($PayAct))">
              <Exec func="PUB:WriteFile" >
                <Arg name="FileName" value="$SErrFil"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="协议账号不符:"/>
                <Arg name="Data"   value="$AgrNo"/> 
                <Arg name="Data"   value=":"/> 
                <Arg name="Data"   value="$PayAct"/>
                <Arg name="ESCFMT" value="\\n"/>
              </Exec>          
              <Continue/>
            </If>          
          <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="Exist_YiZhi" />
          </Exec>
          <If condition="~RetCod =-1">
               <Exec func="PUB:CloseCursor"/>
               <Exec func="PUB:RollbackWork" />
               <Set>RspMsg=数据库操作错，交易中断 </Set>                         
               <Set>RspCod=329999</Set>
               <Return/>                                                
          </If>
          <ElseIf condition="~RetCod =0">
               <Set>RspMsg=STRCAT(数据已存在,$AgrNo,***,$PayAct) </Set>
               <Continue/>
          </ElseIf>
              
            <Set>Status=1</Set>
            <Set>AgrWay=2</Set>            
            <Set>AgrTyp=SUBSTR($AgrNo,2,1)</Set>
            <Set>OrgCod=SUBSTR($AgrNo,7,9)</Set>
            <Set>SBusTy=SUBSTR($AgrNo,16,5)</Set>
            <Set>TxnDat=$ActDat</Set>
            <Set>ChgMod=1</Set>            
            <Set>CtyCod=SUBSTR($AgrNo,3,4)</Set>
            <Set>LAccFlg=0</Set>
            
            <Exec  func="CBS:CbsGetAccFlg"  error="IGNORE">
                <Args>
                  <Arg name ='ActNo' value='$PayAct'/>
                </Args>
            </Exec>
            <Set>ActCls=$LAccFlg</Set>            
            <Exec func="PUB:InsertRecord" error="IGNORE">
                  <Arg name="TblNam" value="CbsCenAgr"/>
            </Exec>
            <If condition="~RetCod =-803">
               <Set>RspMsg=STRCAT(数据存在重复,$AgrNo,***,$PayAct) </Set>
               <Continue/>
            </If>
            <ElseIf condition="~RetCod!=0">
               <Exec func="PUB:CloseCursor"/>
               <Exec func="PUB:RollbackWork" />
               <Set>RspMsg=数据库操作错，交易中断 </Set>                         
               <Set>RspCod=329999</Set>
               <Return/>                                                
            </ElseIf>
            <Set>MyCnt=ADD($MyCnt,1)</Set>
          </While>
          <Exec func="PUB:WriteFile" >
                <Arg name="FileName" value="$SErrFil"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"   value="成功移植协议数据个数:"/> 
                <Arg name="Data"   value="$MyCnt"/>
                <Arg name="ESCFMT" value="\\n"/>
          </Exec>                    
          <Exec func="PUB:SendFileMessage2">
            <Arg name="MsgTyp"  value="4"/>
            <Arg name="ObjNod"  value="$ONodNo"/>
            <Arg name="BusTyp"  value="46"/>
            <Arg name="AplCod"  value="$TxnCod"/>
            <Arg name="FilNam"  value="$ErrFil"/>
            <Arg name="Summary" value="协议移植出错清单"/>
            <Arg name="ObjTlr"  value="$OTlrId"/>
          </Exec>          
          <Break/>
        </Case>                
        <Default>
          <Set>RspCod=329999</Set>
          <Set>RspMsg=无此功能 </Set>        
          <Return/>
        </Default>
     </Switch>  
    </FlowCtrl>
  </Transaction>
  

  <Transaction code="465827" desc="广东省集中式代收付文件接收" error="PUB:RollbackWork">
    <DynSentence name="ChkRec">
      <Sentence>
               SELECT 'Y' YN from table(values(1)) as anony
               where exists(select * from CbsCenAgr
               where  AgrNo='%s' and UsrCod='%s' )
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>
    <DynSentence name="QryRec">
      <Sentence>
        select Status OStatus,PayAct OPayAct,PayNam OPayNam,OrgCod OOrgCod,SBusTy OSBusTy from CbsCenAgr where AgrNo='%s' and UsrCod='%s'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>
    <DynSentence name="UpdToIvd">
      <Sentence>
         update CbsCenAgr Set Status='0',Smr='用户编码有变更'
         where AgrNo='%s ' and UsrCod=''
      </Sentence>
      <Fields>AgrNo|</Fields>
    </DynSentence>        
    <DynSentence name="DelRec">
      <Sentence>
        delete from CbsCenAgr where AgrNo='%s' and UsrCod='%s'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>
   <DynSentence name="UpdRec">
    <Sentence>
        update CbsCenAgr Set TxnDat='%s',FilTyp='%s',FilMrk='%s',ChgMod='%s',CasCod='%s',ChkFlg='%s',Status='%s',Smr='%s'  where AgrNo='%s' and UsrCod='%s'
    </Sentence>
    <Fields>TxnDat|RFilTyp|FilMrk|ChgMod|CasCod|ChkFlg|Status|Smr|AgrNo|UsrCod|</Fields>
    </DynSentence>
   <DynSentence name="UpdIvdRec">
    <Sentence>
        update CbsCenAgr Set IvdDat='%s',TxnDat='%s',FilTyp='%s',FilMrk='%s',ChgMod='%s',CasCod='%s',ChkFlg='%s',Status='%s',Smr='%s'  where AgrNo='%s' and UsrCod='%s'
    </Sentence>
    <Fields>TxnDat|TxnDat|RFilTyp|FilMrk|ChgMod|CasCod|ChkFlg|Status|Smr|AgrNo|UsrCod|</Fields>
    </DynSentence>
    
   <DynSentence name="UpdChk">
    <Sentence>
        update CbsCenAgr Set TxnDat='%s',FilTyp='%s',FilMrk='%s',CasCod='%s',ChkFlg='%s',Smr='%s'  where AgrNo='%s' and UsrCod='%s' and FilTyp not in ('00','99')
    </Sentence>
    <Fields>TxnDat|RFilTyp|FilMrk|CasCod|ChkFlg|Smr|AgrNo|UsrCod|</Fields>
    </DynSentence>


    <FlowCtrl>
      <Set>FilMrk=SUBSTR($FilNam,1,29)</Set>
      <Exec func="PUB:IsValidFile" error="IGNORE">
         <Arg name="FileName"  value="STRCAT($TRDir,$FilMrk)"/>
      </Exec>
      <If condition="~RetCod &lt; 0">
         <Set>RspCod=329999</Set>
         <Set>RspMsg=文件不存在, 交易中断</Set>
         <Return/>
      </If>
      <If condition="$FilByt=0">
         <Set>RspCod=329999</Set>
         <Set>RspMsg=文件字节数为0, 交易中断</Set>
         <Return/>
      </If>      
      <Exec func="PUB:OpenFile">
            <Arg name="FileName" value="STRCAT($TRDir,$FilMrk)"/>
            <Arg name="Mode"     value="r"/>
          </Exec>
      <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
            <Arg name="NodeName"   value="Process"/>
            <Arg name="AttrName"   value="name"/>
            <Arg name="AttrValue"  value="CBS_AGR_HEAD"/>
            <Arg name="MaxLen"     value="100000"/>
      </Exec>
      <If condition="~RetCod !=0">
            <Exec func="PUB:CloseFile" error="IGNORE" />
            <Set>RspCod=329999</Set>
            <Set>RspMsg=文件头读取错 </Set>
            <Return/>
      </If>                
      <If condition="IS_NOEQUAL_STRING($FilTyp,$RFilTyp)">
        <Exec func="PUB:CloseFile" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=329999</Set>
        <Set>RspMsg=文件类型不对，交易中断 </Set>
        <Return/>      
      </If>

      <Switch expression="$RFilTyp">
        <Case value="ZF"> <!--接收中心核验文件-->          
          <While>
            <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
              <Arg name="ConfigName" value="BatFormat"/>
              <Arg name="RootName"   value="BATCH"/>
              <Arg name="NodeName"   value="Process"/>
              <Arg name="AttrName"   value="name"/>
              <Arg name="AttrValue"  value="CBS_AGR_BODY"/>
            </Exec>
            <If condition="~RetCod=1">  <!--读到文件尾-->
              <Exec func="PUB:CloseFile"/>
              <Set>RspCod=000000</Set>
              <Set>MsgTyp=N</Set>
              <Return />
            </If>
            <ElseIf condition="~RetCod!=0">        
              <Exec func="PUB:CloseFile"/>
              <Exec func="PUB:RollbackWork" />              
              <Set>RspMsg=文件体解析错，交易中断 </Set>                         
              <Set>RspCod=329999</Set>
              <Return/>
            </ElseIf>
            <Set>OTxnDat=$TxnDat</Set>

            <If condition="IS_EQUAL_STRING($ChgMod,1)"> <!--增加动作-->
            
              <Exec func="PUB:ReadRecord" error="IGNORE" >
                <Arg name="SqlCmd" value="QryRec" />
              </Exec>
              <If condition="~RetCod = 0 ">
                <If condition="IS_EQUAL_STRING($OStatus,0)">
                   <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="sql" value="DelRec"/>
                  </Exec>                 
                </If>
                <Else><!--协议已存在并生效-->
                  <Set>ChkFlg=2</Set>  <!--验证失败-->
                  <Set>CasCod=CP1O9001</Set> <!--同一用户在协议库已存在协议信息-->
                  <Set>Status=$OStatus</Set>
                  <Set>Smr=协议已存在，不能重签 </Set>
                   <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="sql" value="UpdRec"/>
                  </Exec>
                  <If condition="~RetCod != 0 ">
                    <Exec func="PUB:CloseFile"/>
                    <Exec func="PUB:RollbackWork" />              
                    <Set>RspMsg=文件操作错，交易中断 </Set>                         
                    <Set>RspCod=329999</Set>
                    <Return/>                  
                  </If>                                                     
                  <Continue/>
                </Else>
              </If>              
              <ElseIf condition="~RetCod!=-2"> 
                    <Exec func="PUB:CloseFile"/>
                    <Exec func="PUB:RollbackWork" />              
                    <Set>RspMsg=文件操作错，交易中断 </Set>                         
                    <Set>RspCod=329999</Set>
                    <Return/>
              </ElseIf>
              <!--下面是新协议的处理--> 
              <Set>LAccFlg=0</Set>
              <Exec  func="CBS:CbsGetAccFlg"  error="IGNORE">
                <Args>
                  <Arg name ='ActNo' value='$PayAct'/>
                </Args>
              </Exec>
              <Set>ActCls=$LAccFlg</Set>
              <Set>Accflg=$LAccFlg</Set>
              <Set>HTxnSt=F</Set>
              <Set>ActNo=$PayAct</Set>
              <Set>CcyCod=CNY</Set>              
              <Exec func="PUB:CallLocal"  error="IGNORE">
               <Arg name="TxnCod"  value="488001"/>
               <Arg name="ObjSvr"  value="OFRTGZH1"/>
              </Exec>
              <If condition="IS_EQUAL_STRING($HTxnSt,S)">
                 <If condition="IS_EQUAL_STRING(DELBOTHSPACE($ActNam),DELBOTHSPACE($PayNam))">
                  <!--账户名相同，核验成功-->
                  <Set>ChkFlg=1</Set>
                  <Set>Status=1</Set>
                  <Set>CasCod=CP1I1000</Set>
                 </If>
                 <Else>
                  <!--账户名不同，核验失败-->
                  <Set>ChkFlg=2</Set>
                  <Set>Status=0</Set>
                  <Set>CasCod=CP1O2007</Set>
                  <Set>Smr=户名不符 </Set>
                 </Else>
              </If>
              <Else>
                <!--查不到户名，核验失败-->
                <Set>ChkFlg=2</Set> 
                <Set>Status=0</Set>
                <Set>CasCod=CP1O2008</Set>
                <Set>Smr=无此户名 </Set>
              </Else>
              <Set>AgrTyp=SUBSTR($AgrNo,2,1)</Set>
              <Set>CtyCod=SUBSTR($AgrNo,3,4)</Set>
              <Set>OrgCod=SUBSTR($AgrNo,7,9)</Set> 
              <Set>AgrWay=1 </Set>
              <Set>TxnDat=$OTxnDat</Set>
              <Set>OpnDat=$OTxnDat</Set>              
              <Exec func="PUB:InsertRecord" error="IGNORE">
                  <Arg name="TblNam" value="CbsCenAgr"/>
              </Exec>
              <If condition="~RetCod!=0">
                    <Exec func="PUB:CloseFile"/>
                    <Exec func="PUB:RollbackWork" />
                    <Set>RspMsg=数据库操作错，交易中断 </Set>                         
                    <Set>RspCod=329999</Set>
                    <Return/>                                                
              </If> 
            </If> <!--增加动作over-->
            <ElseIf condition="IS_EQUAL_STRING($ChgMod,0)"> <!--撤消动作-->
              <Exec func="PUB:ReadRecord" error="IGNORE" >
                <Arg name="SqlCmd" value="QryRec" />
              </Exec>
              <If condition="~RetCod = 0 ">
                <If condition="IS_EQUAL_STRING($OStatus,0)">
                   <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="sql" value="DelRec"/>
                  </Exec>                 
                </If>
                <Else><!--协议已存在并生效,置成撤消-->                
                  <Set>ChkFlg=1</Set>  <!--验证成功-->
                  <Set>CasCod=CP1I1000</Set>                   
                  <Set>Status=0</Set>
                  <Set>Smr=机构发起撤消成功 </Set>
                   <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="sql" value="UpdIvdRec"/>
                  </Exec>
                  <If condition="~RetCod != 0 ">
                    <Exec func="PUB:CloseFile"/>
                    <Exec func="PUB:RollbackWork" />              
                    <Set>RspMsg=文件操作错，交易中断 </Set>                         
                    <Set>RspCod=329999</Set>
                    <Return/>                  
                  </If>                                                     
                  <Continue/>
                </Else>
              </If>              
              <ElseIf condition="~RetCod!=-2"> 
                    <Exec func="PUB:CloseFile"/>
                    <Exec func="PUB:RollbackWork" />              
                    <Set>RspMsg=文件操作错，交易中断 </Set>                         
                    <Set>RspCod=329999</Set>
                    <Return/>
              </ElseIf>
              <Set>ActCls=0</Set>
              <Set>ChkFlg=2</Set>
              <Set>Status=0</Set>
              <Set>CasCod=CP1O9001</Set> <!--原协议不存在-->
              <Set>Smr=原协议不存在 </Set>
              <Set>AgrTyp=SUBSTR($AgrNo,2,1)</Set>
              <Set>CtyCod=SUBSTR($AgrNo,3,4)</Set>
              <Set>OrgCod=SUBSTR($AgrNo,7,9)</Set>
              <Set>TxnDat=$OTxnDat</Set>
              <Exec func="PUB:InsertRecord" error="IGNORE">
                  <Arg name="TblNam" value="CbsCenAgr"/>
              </Exec>              
            </ElseIf><!--撤消动作over-->
            <Else>
                <Continue/>            
            </Else>            
          </While>            
          <Break/>
        </Case><!--核验文件处理over-->

        <Case value="XF"> <!--接收中心返回结果-->
          <While>
            <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
              <Arg name="ConfigName" value="BatFormat"/>
              <Arg name="RootName"   value="BATCH"/>
              <Arg name="NodeName"   value="Process"/>
              <Arg name="AttrName"   value="name"/>
              <Arg name="AttrValue"  value="CBS_AGR_BODY"/>
            </Exec>
            <If condition="~RetCod=1">  <!--读到文件尾-->
              <Exec func="PUB:CloseFile"/>
              <Set>RspCod=000000</Set>
              <Set>MsgTyp=N</Set>
              <Return />
            </If>
            <ElseIf condition="~RetCod!=0">        
              <Exec func="PUB:CloseFile"/>
              <Exec func="PUB:RollbackWork" />              
              <Set>RspMsg=文件体解析错，交易中断 </Set>                         
              <Set>RspCod=329999</Set>
              <Return/>
            </ElseIf>
            <If condition="IS_NOEQUAL_STRING($CasCod,CP0I1000)"> <!--返回失败纪录-->
              <Set>ChkFlg=2</Set>
               <Exec func="PUB:ExecSql" error="IGNORE">
                <Arg name="sql" value="UpdChk"/>
              </Exec>
              <If condition="~RetCod =-2">
                <Continue/>
              </If>              
              <ElseIf condition="~RetCod != 0 ">
                 <Exec func="PUB:CloseFile"/>
                 <Exec func="PUB:RollbackWork" />              
                 <Set>RspMsg=文件操作错，交易中断 </Set>                         
                 <Set>RspCod=329999</Set>
                 <Return/>                  
              </ElseIf>                                                     
              <Continue/>
            </If>
            <Else> <!--返回验证成功纪录-->            
              <Exec func="PUB:ReadRecord" error="IGNORE" >
                <Arg name="SqlCmd" value="QryRec" />
              </Exec>
              <If condition="~RetCod = 0 "> 
                <If condition="IS_NOEQUAL_STRING($OStatus,$ChgMod)">
                  <Set>ChkFlg=2</Set>  <!--验证不成功-->
                 <Set>Smr=STRCAT(回应成功*但状态不符*联系中心查证,$ChgMod) </Set>
                </If>
                <ElseIf condition="IS_NOEQUAL_STRING($OPayAct,$PayAct)">
                  <Set>ChkFlg=2</Set>  <!--验证不成功-->
                  <Set>Smr=STRCAT(回应成功*但账户不符*联系中心查证,$PayAct) </Set>
                </ElseIf>
                <Else>
                  <Set>ChkFlg=1</Set>  <!--验证成功-->                
                </Else>                
                 <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="sql" value="UpdChk"/>
                </Exec>                                   
              </If>
              <ElseIf condition="~RetCod = -2 ">
                <Set>AgrTyp=SUBSTR($AgrNo,2,1)</Set>
                <Set>CtyCod=SUBSTR($AgrNo,3,4)</Set>
                <Set>OrgCod=SUBSTR($AgrNo,7,9)</Set>                
                <Set>AgrWay=0 </Set>
                <Set>ChkFlg=1 </Set>
                <Set>Status=$ChgMod </Set>
                <Set>LAccFlg=0</Set>
                <Set>OpnDat=$TxnDat </Set>
                <Exec  func="CBS:CbsGetAccFlg"  error="IGNORE">
                  <Args>
                    <Arg name ='ActNo' value='$PayAct'/>
                  </Args>
                </Exec>
                <Set>ActCls=$LAccFlg</Set>
                <Exec func="PUB:InsertRecord" error="IGNORE">
                  <Arg name="TblNam" value="CbsCenAgr"/>
                </Exec>              
                <If condition="~RetCod!=0">
                   <Exec func="PUB:CloseFile"/>
                   <Exec func="PUB:RollbackWork" />
                   <Set>RspMsg=数据库操作错，交易中断 </Set>                         
                   <Set>RspCod=329999</Set>
                   <Return/>                                                
                </If>
                 <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="sql" value="UpdToIvd"/>
                </Exec>                                                    
              </ElseIf>                                                     
              <Else>
                    <Exec func="PUB:CloseFile"/>
                    <Exec func="PUB:RollbackWork" />              
                    <Set>RspMsg=文件操作错，交易中断 </Set>                         
                    <Set>RspCod=329999</Set>
                    <Return/>                                
              </Else>                
              <Continue/>              
            </Else><!--返回验证成功纪录over-->
          </While>            
          <Break/>        
        </Case>

        <Default>
          <Set>RspCod=329999</Set>
          <Set>RspMsg=无此功能 </Set>        
          <Return/>
        </Default>
     </Switch>  
      
    </FlowCtrl>
  </Transaction>

  <Transaction code="465828" desc="广东省集中式代收付协议数据浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select *
          from CbsCenAgr
         where ( FilTyp='%s' or '%s'= '' ) and ( AgrTyp='%s' or '%s'= '' ) and ( ChkFlg='%s' or '%s'= '' ) and ( Status='%s' or '%s'= '' )
          and ( OrgCod='%s' or '%s'= '' )  and ( PayAct='%s' or '%s'= '' )  and (AgrNo='%s' or '%s'= '' ) and  (FilMrk like '%%%s%%' or '%s'= '' )
      </Sentence>
      <Fields>FilTyp|FilTyp|AgrTyp|AgrTyp|ChkFlg|ChkFlg|Status|Status|OrgCod|OrgCod|PayAct|PayAct|AgrNo|AgrNo|FilMrk|FilMrk|</Fields>
    </DynSentence>
    <DynSentence name="QryRec">
      <Sentence>
        select *
          from CbsCenAgr
        where AgrNo='%s' and UsrCod='%s'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>

    <FlowCtrl>
      <If condition="IS_EQUAL_STRING($TIATyp,P)">
        <Set>Func=1</Set>
        <Exec func="PUB:MultiQuery" />
        <Return/>
       </If>

      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery" />
          <Return/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord" >
           <Args>
            <Arg name="SqlCmd" value="QryRec" />
           </Args>
          </Exec>        
          <Return/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>      

  <Transaction code="465830" desc="广东省集中代收付转帐收款账号绑定">
    <DynSentence name="QryRec1">
      <Sentence>
        select LmtAct 
          from CbsCenAgr
         where AgrNo='%s ' and UsrCod='%s' and Status='1'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>
    <DynSentence name="OldRec">
      <Sentence>
        select LmtAct  OldLmtAct
          from CbsCenAgr
         where AgrNo='%s ' and UsrCod='%s' and Status='1'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>    
     <DynSentence name="DelLmt"> <!--删除-->
       <Sentence>
         update CbsCenAgr Set LmtAct='' where AgrNo='%s' and UsrCod='%s'
       </Sentence>
       <Fields>AgrNo|UsrCod|</Fields>
     </DynSentence>     
      <DynSentence name="UpdLmt"> <!--修改-->
        <Sentence>
          update CbsCenAgr Set LmtAct='%s'
          where AgrNo='%s' and UsrCod='%s'
        </Sentence>
        <Fields>LmtAct|AgrNo|UsrCod|</Fields>
      </DynSentence>
      
    <FlowCtrl>
      <Switch expression="$Func">
        <Case value="4">
          <Exec func="PUB:ReadRecord" error="IGNORE">
           <Args>
            <Arg name="SqlCmd" value="QryRec1" />
           </Args>
          </Exec>
          <If condition="~RetCod=-1">          
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>          
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=协议不存在</Set>
            <Return/>
          </If>
          <Set>RcvBnk1=GETWORDDELIMITER($LmtAct,:,1)</Set>
          <Set>RcvAct1=GETWORDDELIMITER($LmtAct,:,2)</Set>
          <Set>RcvNam1=GETWORDDELIMITER($LmtAct,:,3)</Set>
          <Set>RcvBnk2=GETWORDDELIMITER($LmtAct,:,4)</Set>
          <Set>RcvAct2=GETWORDDELIMITER($LmtAct,:,5)</Set>
          <Set>RcvNam2=GETWORDDELIMITER($LmtAct,:,6)</Set>
          <Set>RcvBnk3=GETWORDDELIMITER($LmtAct,:,7)</Set>
          <Set>RcvAct3=GETWORDDELIMITER($LmtAct,:,8)</Set>
          <Set>RcvNam3=GETWORDDELIMITER($LmtAct,:,9)</Set>                              
          <Return/>
        </Case>        
        <Case value="1">          
          <Set>LmtAct= </Set>
          <If condition="INTCMP(STRLEN($RcvBnk1),3,12)">
            <Set>RcvAct1=ADDCHAR($RcvAct1,32, ,0)</Set>
            <Set>RcvNam1=ADDCHAR($RcvNam1,60, ,0)</Set>
            <Set>LmtAct=STRCAT($RcvBnk1,:,$RcvAct1,:,$RcvNam1,:)</Set>
          </If>
          <If condition="INTCMP(STRLEN($RcvBnk2),3,12)">
            <Set>RcvAct2=ADDCHAR($RcvAct2,32, ,0)</Set>
            <Set>RcvNam2=ADDCHAR($RcvNam2,60, ,0)</Set>            
            <Set>LmtAct=STRCAT($LmtAct,$RcvBnk2,:,$RcvAct2,:,$RcvNam2,:)</Set>
          </If>
          <If condition="INTCMP(STRLEN($RcvBnk3),3,12)">
             <Set>RcvAct3=ADDCHAR($RcvAct3,32, ,0)</Set>
            <Set>RcvNam3=ADDCHAR($RcvNam3,60, ,0)</Set>
            <Set>LmtAct=STRCAT($LmtAct,$RcvBnk3,:,$RcvAct3,:,$RcvNam3,:)</Set>
          </If>
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdLmt"/>
          </Exec>            
          <Set>RspCod=000000</Set>
          <Break/>
        </Case>
        <Case value="2">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=329999</Set>
          <Set>RspMsg=收款帐号绑定不可以清除</Set>
          <Return/>
           <Exec func="PUB:ExecSql">
              <Arg name="sql" value="DelLmt"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="3">
          <Exec func="PUB:ReadRecord" error="IGNORE">
           <Args>
            <Arg name="SqlCmd" value="OldRec" />
           </Args>
          </Exec>
          <If condition="~RetCod=-1">          
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>          
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=协议不存在</Set>
            <Return/>
          </If>    
          <!--If condition="ISNULL(DELBOTHSPACE($OldLmtAct))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=原未绑定收款帐号不可以修改</Set>
            <Return/>            
          </If-->
          <Set>LmtAct= </Set>
          <If condition="INTCMP(STRLEN($RcvBnk1),3,12)">
            <Set>RcvAct1=ADDCHAR($RcvAct1,32, ,0)</Set>
            <Set>RcvNam1=ADDCHAR($RcvNam1,60, ,0)</Set>            
            <Set>LmtAct=STRCAT($RcvBnk1,:,$RcvAct1,:,$RcvNam1,:)</Set>
          </If>
          <If condition="INTCMP(STRLEN($RcvBnk2),3,12)">
            <Set>RcvAct2=ADDCHAR($RcvAct2,32, ,0)</Set>
            <Set>RcvNam2=ADDCHAR($RcvNam2,60, ,0)</Set>            
            <Set>LmtAct=STRCAT($LmtAct,$RcvBnk2,:,$RcvAct2,:,$RcvNam2,:)</Set>
          </If>
          <If condition="INTCMP(STRLEN($RcvBnk3),3,12)">
            <Set>RcvAct3=ADDCHAR($RcvAct3,32, ,0)</Set>
            <Set>RcvNam3=ADDCHAR($RcvNam3,60, ,0)</Set>            
            <Set>LmtAct=STRCAT($LmtAct,$RcvBnk3,:,$RcvAct3,:,$RcvNam3,:)</Set>
          </If>
          <!--If condition="ISNULL(DELBOTHSPACE($LmtAct))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=绑定收款帐号不可以全清空</Set>
            <Return/>            
          </If-->          
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdLmt"/>
          </Exec>            
          <Break/>
        </Case>        
      </Switch>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465712" desc="影像交换提回清分">
      <DynSentence name="QryMBnk">
      <Sentence>
        select CtlNod,TxnSts BilSts, TxnAmt,TlrId2 from CisInBok where ActDat='%s' and BusLog='%s' and TxnSts='Y'   
      </Sentence>
      <Fields>TxnDat|BusLog|</Fields>
    </DynSentence>
      <DynSentence name="QryOBnk">
      <Sentence>
        select CtlNod,BilSts, TxnAmt,TlrId2 from BepInBok where ActDat='%s' and BusLog='%s' and BilSts='Y' and pkgtyp='008' 
      </Sentence>
      <Fields>TxnDat|BusLog|</Fields>
    </DynSentence>
        
    <DynSentence name="UpdMBnk">
      <Sentence>
        update  CisInBok set TlrId2=CtlNod where ActDat='%s' and BusLog='%s' and TxnSts='Y' and TlrId2!=CtlNod
      </Sentence>
      <Fields>TxnDat|BusLog|</Fields>
    </DynSentence>
    <DynSentence name="UpdOBnk">
      <Sentence>
        update  BepInBok set TlrId2=CtlNod where ActDat='%s' and BusLog='%s' and BilSts='Y' and TlrId2!=CtlNod and pkgtyp='008' 
      </Sentence>
      <Fields>TxnDat|BusLog|</Fields>
    </DynSentence>

    <FlowCtrl>
      <If condition="IS_EQUAL_STRING($RecTyp,0)">
        <Set>Str_Qry=QryMBnk</Set>
        <Set>Str_Upd=UpdMBnk</Set>
      </If>
       <Else>
        <Set>Str_Qry=QryOBnk</Set>
        <Set>Str_Upd=UpdOBnk</Set>
       </Else>      
      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:ReadRecord" error="IGNORE">
           <Args>
            <Arg name="SqlCmd" value="$Str_Qry" />
           </Args>
          </Exec>
          <If condition="~RetCod=-1">          
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Return/>
          </If>          
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=该笔交易不存在</Set>
            <Return/>
          </If>        
          <Return/>
        </Case>
        <Case value="2">
           <Exec func="PUB:ExecSql">
              <Arg name="sql" value="$Str_Upd"/>
           </Exec>
          <Return/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465831" desc="代码查名称">
    <DynSentence name="QryCtyCod">
      <Sentence>
        select NodNam  QryNam from PmsNode where NodCod='%s'
      </Sentence>
      <Fields>QryCod|</Fields>
    </DynSentence>
    <DynSentence name="QryCenOrg">
      <Sentence>
        select OrgNam  QryNam from CbsCenOrg where OrgCod='%s' fetch first rows only
      </Sentence>
      <Fields>QryCod|</Fields>
    </DynSentence>
        
    <FlowCtrl>
      <Switch expression="$QryTyp">
        <Case value="01"> <!--城市代码查询-->
          <Set>QryStr=QryCtyCod</Set>
          <Set>ErrMSg=城市代码不存在 </Set>
          <Break/>
        </Case>
        <Case value="02"> <!--集中代收付入网机构查询-->
          <Set>QryStr=QryCenOrg</Set>
          <Set>ErrMSg=该机构未入集中代收付网 </Set>
          <Break/>
        </Case>        
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=329999</Set>
          <Set>RspMsg=无此功能 </Set>        
          <Return/>
        </Default>
      </Switch>      
          <Exec func="PUB:ReadRecord" error="IGNORE">
           <Args>
            <Arg name="SqlCmd" value="$QryStr" />
           </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=数据库处理失败,联系技术解决</Set>
            <Return/>
          </If>          
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=$ErrMsg</Set>
            <Return/>
          </If>        
          <Return/>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465832" desc="集中代收付入网业务协议确认发送">
    <DynSentence name="MultiQuery">
      <Sentence>
        select *
          from CbsCenAgr
         where ( FilTyp='%s' or '%s'= '' ) and ( AgrTyp='%s' or '%s'= '' ) and ( ChkFlg='%s' or '%s'= '' ) and ( Status='%s' or '%s'= '' )
          and ( OrgCod='%s' or '%s'= '' )  and ( PayAct='%s' or '%s'= '' )  and (AgrNo='%s' or '%s'= '' ) and  (NodNo like '%%%s%%' or '%s'= '' )
           and (TlrId='%s' or '%s'= '' ) and OrgCod in (select OrgCod from CbsCenOrg )
      </Sentence>
      <Fields>FilTyp|FilTyp|AgrTyp|AgrTyp|ChkFlg|ChkFlg|Status|Status|OrgCod|OrgCod|PayAct|PayAct|AgrNo|AgrNo|QNodNo|QNodNo|QTlrId|QTlrId|</Fields>
    </DynSentence>
    <DynSentence name="QryRec">
      <Sentence>
        select *
          from CbsCenAgr
        where AgrNo='%s' and UsrCod='%s'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>
   <DynSentence name="UpdChk">
    <Sentence>
        update CbsCenAgr Set UsrCod='%s',TlrId='%s',TxnDat='%s',FilTyp='99',CasCod='%s',ChkFlg='%s',Smr='%s'  where AgrNo='%s' and UsrCod='%s' 
    </Sentence>
    <Fields>UsrCod|TlrId|ActDat|TDeaCd|ChkFlg|Smr|AgrNo|OUsrCod|</Fields>
    </DynSentence>
   <DynSentence name="DelFai">
    <Sentence>
        delete from  CbsCenAgr   where AgrNo='%s' and UsrCod='%s'  and Status='0' and ChkFlg='1'
    </Sentence>
    <Fields>AgrNo|UsrCod|</Fields>
    </DynSentence>
    
    
    <FlowCtrl>
      <If condition="IS_EQUAL_STRING($TIATyp,P)">
        <Set>Func=1</Set>
        <Exec func="PUB:MultiQuery" />
        <Return/>
       </If>

      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery" />
          <Return/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord" >
           <Args>
            <Arg name="SqlCmd" value="QryRec" />
           </Args>
          </Exec>        
          <Return/>
        </Case>
        <Case value="3">
          <Exec func="PUB:ReadRecord" >
           <Args>
            <Arg name="SqlCmd" value="QryRec" />
           </Args>
          </Exec>  
          <If condition="IS_EQUAL_STRING($ChkFlg,1)"> 
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=记录已是核验通过状态!</Set>
            <Return/>                    
          </If>
          <If condition="AND (IS_EQUAL_STRING($ChgMod,0),IS_NOEQUAL_STRING($Status,0) )">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=记录撤消操作与记录状态不匹配!</Set>
            <Return/>          
          </If>
          <If condition="AND (IS_EQUAL_STRING($ChgMod,1),IS_NOEQUAL_STRING($Status,1) )">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=记录新增操作与记录状态不匹配!</Set>
            <Return/>          
          </If>
          <If condition="AND (IS_EQUAL_STRING($ChgMod,2),IS_NOEQUAL_STRING($Status,1) )">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=记录更新操作与记录状态不匹配!</Set>
            <Return/>          
          </If>          
         <If condition="IS_EQUAL_STRING($ChgMod,0)"> <!--发送撤消操作-->
            <Set>QryTyp=102</Set>
          </If>
         <ElseIf condition="IS_EQUAL_STRING($ChgMod,1)"> <!--发送新增操作-->
            <Set>QryTyp=100</Set>
          </ElseIf>
         <ElseIf condition="IS_EQUAL_STRING($ChgMod,2)"> <!--发送更新操作-->
            <Set>QryTyp=101</Set>
          </ElseIf>
          <Else>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=操作类型出错, 请联系技术</Set>
            <Return/>
          </Else>  
          <Set>OChkFlg=$ChkFlg</Set>
          <Set>OUsrCod=$UsrCod</Set>
         <Set>TrsTyp=0</Set>   <!--传输类型（即时回应）-->
         <Set>MsgStu=001245</Set>         
         <Set>TraKnd=2002</Set> <!--交易种类-->
         <Set>MsgId=2222</Set> <!--报文类型-->
         <Set>TxnKnd=200201</Set> 
         <Set>SndTm=GETDATETIME(YYYYMMDDHHMISS)</Set> 
         <Set>TraTm=SUBSTR($SndTm,5,10)</Set> <!--交易时间-->
         <Set>SndDat=$Actdat</Set> 
         <Set>SvrCod=012</Set>
         <Set>SndBNo=$PayCBnk</Set>
         <Set>CrpOrgCd=$OrgCod</Set>
         <Set>SevTyp=1</Set> <!--固定格式报文-->
         <Set>LmtAct=DELBOTHSPACE($LmtAct)</Set> 
         <Set>LmtAmt=DELBOTHSPACE($LmtAmt)</Set>
         <Set>SevInf=STRCAT(ADDCHAR(0,16,0,0),ADDCHAR($AgrNo,60, ,0),ADDCHAR($UsrCod,18, ,0),ADDCHAR($UsrNam,60, ,0))</Set>
         <Set>SevInf=STRCAT($SevInf,ADDCHAR($LnkNam,60, ,0),ADDCHAR($LnkAdr,60, ,0),ADDCHAR($LnkPst,6,0,0),ADDCHAR($LnkTel,25, ,0))</Set>
         <Set>SevInf=STRCAT($SevInf,ADDCHAR($SBusTy,5, ,0),ADDCHAR($PayOBnk,12, ,0),ADDCHAR($PayAct,32, ,0),ADDCHAR($PayNam,60, ,0))</Set>
         <Set>SevInf=STRCAT($SevInf,ADDCHAR($PayIdTy,1, ,0),ADDCHAR($PayIdNo,18, ,0),ADDCHAR($PayMob,16, ,0),ADDCHAR($PayEml,30, ,0))</Set>
         <Set>SevInf=STRCAT($SevInf,ADDCHAR($Smr,60, ,0),ADDCHAR($LmtAmt,15,0,0))</Set>
         <If condition="IS_EQUAL_STRING($SBusTy,$AAA_QYZZ)"> <!--3A转帐签约-->
            <If condition="AND(IS_EQUAL_STRING($ChgMod,2),ISNULL($LmtAct))"> 
             <Set>SevInf=STRCAT($SevInf,N)</Set>
           </If>
           <ElseIf condition="NOT(ISNULL($LmtAct))">  
             <Set>SevInf=STRCAT($SevInf,DELCHAR($LmtAct,58))</Set>
           </ElseIf>                    
         </If> 
         <Quote name="GetBusLog"/>         
         <Set>RspCod=000000</Set>      
         <Exec func="PUB:CallThirdAcc" error="IGNORE">
              <Arg name="HTxnCd" value="T00145"/>
              <Arg name="ObjSvr" value="LTHDCBS1"/>
         </Exec>
         <If condition="AND(INTCMP(~RetCod,3,0),IS_EQUAL_STRING($TRntCd,I1000))">
           <!--人行处理结果成功-->
           <If condition="IS_EQUAL_STRING($ChgMod,1)"> <!--新增操作-->
              <If condition="OR(IS_EQUAL_STRING($SBusTy,$AAA_ZDJF),IS_EQUAL_STRING($SBusTy,$AAA_QYZZ))">
              <!--如果是3A协议-->
                 <Set>UsrCod=DELBOTHSPACE(SUBSTR($SevDat,78,18))</Set>  
                 <Exec func="PUB:ExecSql" error="IGNORE">
                   <Args>
                     <Arg name="SqlCmd" value="DelFai"/>
                   </Args>        
                 </Exec>
                 <Set>RspCod=000000</Set>      
              </If>
           </If>
           <Set>ChkFlg=1</Set>
           <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="UpdChk"/>
            </Args>
           </Exec>
         </If>
         <ElseIf condition="OR(IS_EQUAL_STRING(~RetCod,-1),IS_EQUAL_STRING(~RetCod,-2))">
           <Set>ChkFlg=0</Set>           
           <Set>MsgTyp=E</Set>
           <Set>RspCod=329999</Set>
           <Set>RspMsg=通讯出错不能进行验证,请咨询技术人员 </Set>
           <Return/>           
         </ElseIf>                   
         <Else>
           <Set>ChkFlg=2</Set>
           <If condition="IS_NOEQUAL_STRING($OChkFlg,1)">
             <Exec func="PUB:ExecSql">
              <Args>
                <Arg name="SqlCmd" value="UpdChk"/>
              </Args>
             </Exec>
           </If>           
           <Set>MsgTyp=E</Set>
           <Set>RspCod=329999</Set>
           <Set>RspMsg=STRCAT(中心验证失败返回错误请核查,$TDeaCd)</Set>
           <Return/>
         </Else>         
         <Return/>
        </Case>        
      </Switch>
    </FlowCtrl>
  </Transaction>        

  <Transaction code="465824" desc="代收付入网机构名单浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select *
          from CbsCenOrg
         where ( OrgCod='%s' or '%s'= '' ) and ( SBusTy='%s' or '%s'= '' ) and ( CtyCod='%s' or '%s'= '' )          
      </Sentence>
      <Fields>OrgCod|OrgCod|SBusTy|SBusTy|CtyCod|CtyCod|</Fields>
    </DynSentence>
    <DynSentence name="QryRec">
      <Sentence>
        select *
          from CbsCenOrg
        where OrgCod='%s' and SBusTy='%s'  and TxnKnd='%s'  and CcyCod='%s' and OrgOBnk='%s'
      </Sentence>
      <Fields>OrgCod|SBusTy|TxnKnd|CcyCod|OrgOBnk|</Fields>
    </DynSentence>

    <FlowCtrl>
      <If condition="IS_EQUAL_STRING($TIATyp,P)">
        <Set>Func=1</Set>
        <Exec func="PUB:MultiQuery" />
        <Return/>
       </If>

      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery" />
          <Return/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord" >
           <Args>
            <Arg name="SqlCmd" value="QryRec" />
           </Args>
          </Exec>        
          <Return/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>      

  <Transaction code="465837" desc="集中代收付入网机构表更新(不用)" error="PUB:RollbackWork">
    <DynSentence name="ChkRec">
      <Sentence>
               SELECT 'Y' YN from table(values(1)) as anony
               where exists(select * from CbsCenOrg
               where  OrgCod='%s' and  SBusTy='%s' and  TxnKnd='%s' and CcyCod='%s' and OrgOBnk='%s'  )
      </Sentence>
      <Fields>OrgCod|SBusTy|TxnKnd|CcyCod|OrgOBnk|</Fields>
    </DynSentence>
    <DynSentence name="DelRec">
      <Sentence>
        delete from CbsCenOrg where OrgCod='%s' and  SBusTy='%s' and  TxnKnd='%s' and CcyCod='%s' and OrgOBnk='%s' 
      </Sentence>
      <Fields>OrgCod|SBusTy|TxnKnd|CcyCod|OrgOBnk|</Fields>      
    </DynSentence>

    <FlowCtrl>
      <Set>OrgFilNm=cbscenorg.dat</Set>
      <Exec func="PUB:IsValidFile" error="IGNORE">
         <Arg name="FileName"  value="STRCAT(dat/cbs/msg/,$OrgFilNm)"/>
      </Exec>
      <If condition="~RetCod &lt; 0">
         <Set>RspCod=329999</Set>
         <Set>RspMsg=文件不存在, 交易中断</Set>
         <Return/>
      </If>
      <If condition="$FilByt=0">
         <Set>RspCod=329999</Set>
         <Set>RspMsg=文件字节数为0, 交易中断</Set>
         <Return/>
      </If>      
      <Exec func="PUB:OpenFile">
            <Arg name="FileName" value="STRCAT(dat/cbs/msg/,$OrgFilNm)"/>
            <Arg name="Mode"     value="r"/>
          </Exec>
      <While>
        <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
              <Arg name="ConfigName" value="BatFormat"/>
              <Arg name="RootName"   value="BATCH"/>
              <Arg name="NodeName"   value="Process"/>
              <Arg name="AttrName"   value="name"/>
              <Arg name="AttrValue"  value="CBS_ORG_BODY"/>
        </Exec>
        <If condition="~RetCod=1">  <!--读到文件尾-->
              <Exec func="PUB:CloseFile"/>
              <Set>RspCod=000000</Set>
              <Set>MsgTyp=N</Set>
              <Return />
        </If>
        <ElseIf condition="~RetCod!=0">        
              <Exec func="PUB:CloseFile"/>
              <Exec func="PUB:RollbackWork" />              
              <Set>RspMsg=文件体解析错，交易中断 </Set>                         
              <Set>RspCod=329999</Set>
              <Return/>
        </ElseIf>
        <Exec func="PUB:ReadRecord" error="IGNORE" >
            <Arg name="SqlCmd" value="ChkRec" />
        </Exec>
        <If condition="~RetCod =-1">
            <Exec func="PUB:CloseFile"/>
            <Exec func="PUB:RollbackWork" />              
            <Set>MsgTyp=E</Set>
            <Set>RspCod=329999 </Set>
            <Set>RspMsg=数据库处理错误，请联系技术解决！ </Set>
            <Return/>
        </If>
        <ElseIf condition="~RetCod =0"> <!--存在-->
           <Exec func="PUB:ExecSql" error="IGNORE">
             <Arg name="sql" value="DelRec"/>
          </Exec>
          <If condition="~RetCod != 0 ">
             <Exec func="PUB:CloseFile"/>
             <Exec func="PUB:RollbackWork" />              
             <Set>RspMsg=文件操作错，交易中断 </Set>                         
             <Set>RspCod=329999</Set>
             <Return/>                  
          </If>                                                     
        </ElseIf>          
        <Exec func="PUB:InsertRecord" error="IGNORE">
          <Arg name="TblNam" value="CbsCenOrg"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Exec func="PUB:CloseFile"/>
          <Exec func="PUB:RollbackWork" />
          <Set>RspMsg=数据库操作错，交易中断 </Set>                         
          <Set>RspCod=329999</Set>
          <Return/>                                                
        </If> 
      </While>                  
    </FlowCtrl>
  </Transaction>

</Application>
