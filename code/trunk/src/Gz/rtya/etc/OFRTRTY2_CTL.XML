<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="RTY" code="247" trace="yes" >
<!--动态库定义-->
	<LibDeclare>
		<Library name="RTY"  value="app/rtya/dll/rty.so" />
	</LibDeclare>


<!--数据库表名定义-->
	<TableDeclare>
		<Table name="rtytvchf"      value="rtytvchf" />			<!--金融传票临时表-->
		<Table name="rtycdtmst"     value="rtycdtmst" />		<!--活期账户临时表-->
		<Table name="rtypayout"     value="rtypayout" />		<!--监控帐号支出信息表-->
		<Table name="rtypaymnt"     value="rtypaymnt" />		<!--商品房缴款信息表-->
		<Table name="rtyactiot"     value="rtyactiot" />		<!--监控帐户收支表-->
		<Table name="rtyactdtl"     value="rtyactdtl" />		<!--监控帐户跨行转帐收款明细表-->
		<Table name="rtyactinf"     value="rtyactinf" />		<!--监控帐户信息表-->
		<Table name="rtyfmpmng"     value="rtyfmpmng" />		<!--接入帐户管理表-->
	</TableDeclare>

<!--声明批量格式文件-->
	<ConfigDeclare>
		<Config name="FtpGCfg"    value="etc/RTY_GFTP.XML"/>   <!--前置获取原始文件FTP配置-->
		<Config name="FtpPCfg"    value="etc/RTY_PFTP.XML"/>   <!--前置返回结果文件FTP配置-->
	</ConfigDeclare>

<!-- 全局变量 -->
	<BusDefDeclare>
		<Busdef name="BrNo"   value="441999"/>
		<Busdef name="HomDir"   value="/app/ics/"/>					<!--用户主目录-->
		<Busdef name="ObjPth"   value="BRANCH/" />				  <!--接收IFSS系统文件目录-->
		<Busdef name="RcvPth"   value="dat/rty/recv/" />		<!--接收目录-->
		<Busdef name="SndPth"   value="dat/rty/send/" />		<!--发送目录-->
		<Busdef name="FilHed"   value="AIQSCFVH"/>					<!--文件头信息-->
		<Busdef name="AplCls"   value="247"/>               <!--Added by xuan_20100202-->
	</BusDefDeclare>

	<GlobalFunction>
		<!--Added by xuan_20100202-->
    <Function name="_after">
        <Process>
           <If condition="ISNULL($MsgTyp)">
              <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                 <Set>MsgTyp=N</Set>
                 <Set>RspCod=000000</Set>
              </If>
              <Else>
                 <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                    <Set>MsgTyp=E</Set>
                 </If>
                 <Else>
                    <Set>MsgTyp=N</Set>
                 </Else>
              </Else>
           </If>
        </Process>
    </Function>
	</GlobalFunction>

<!--宏定义-->
	<Define>
		<Macro name="DbSele"> <!-- 通用数据库查询 -->
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Args>
					<Arg name="SqlCmd" value="$QrySen" />
				</Args>
			</Exec>
			<If condition="~RetCod=-1">
				<Exec func="PUB:RollbackWork" error="IGNORE" />			
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=数据库处理失败!</Set>
				<Return/>
			</If> 
		</Macro>
		<Macro name="DbExec"> <!-- 通用数据库处理 -->
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Args>
					<Arg name="SqlCmd" value="$QrySen" />
				</Args>
			</Exec>
			<If condition="~RetCod=-1">
				<Exec func="PUB:RollbackWork" error="IGNORE" />			
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=数据库处理失败!</Set>
				<Return/>
			</If> 
		</Macro>
		<Macro name="FMPMsg"> <!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
			<!--获取接入帐户和密码-->
			<Set>QrySen=GetFMP</Set>
			<Quote name="DbSele"/>
			<If condition="~RetCod=-2">	
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=没接入帐户记录!</Set>
				<Return/>
			</If>
			<!--获取时间戳-->
			<Set>TimStp=GETDATETIME(YYMMDDHHMISS)</Set>			
			<If condition="~RetCod=-1">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=取时间戳失败!</Set>
				<Return/>
			</If> 
			<Set>tmpFMPVal=STRCAT($FMPPwd,$TimStp)</Set>
			<!--MD5加密-->
			<Exec func="RTY:RtyGetMD5" error="IGNORE">
				<Args>
					<Arg name="para1" value="$tmpFMPVal" />
				</Args>			
			</Exec>
			<If condition="~RetCod=-1">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=MD5加密失败!</Set>
				<Return/>
			</If>
			<!--取消息流水号-->
			<Exec  func="PUB:GetSeqNoCircle" error="IGNORE">	
				<Args>
					<Arg name ='TblNam' value='rtyfmpmng' />
					<Arg name ='SeqCol' value='seqnoid' />
					<Arg name ='Len'    value='4'/>
					<Arg name ='ColNam'  value='SeqnoId' />
				</Args>
			</Exec>
			<If condition="~RetCod != 0">
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=取信息流水号seqnoid失败,不作回应!</Set>
				<Return />
			</If>
			<Exec func="RTY:RtyToHex" error="IGNORE">
				<Arg name="HexPar" value="$SeqnoId" />
			</Exec>
			<If condition="~RetCod != 0">
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=流水号转十六进制出错!</Set>
				<Return />
			</If>
			<Set>SeqnoId=ADDCHAR(DELRIGHTSPACE($HexDat),8,0,1) </Set>
			<Exec func="RTY:RtyRevOrd" error="IGNORE">
				<Arg name="RevPar" value="$SeqnoId" />
			</Exec>
			<If condition="~RetCod != 0">
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=总笔数倒序排列出错!</Set>
				<Return />
			</If>
			<Set>SeqnoId=$RevDat</Set>
		</Macro>
	</Define>
	<!--*********************************************************************************-->
	<Transaction code="464708" desc="监控帐号跨行转帐收款明细信息提交" >
		<DynSentence name="GetFMP">
			<Sentence>
				select FMPAcc FMPAcc,FMPPwd FMPPwd from rtyfmpmng 
			</Sentence>
		</DynSentence>
		<DynSentence name="UpdVchfAmt">
			<Sentence>
				update rtytvchf set 
					vchf_vch_amt=substr(right('00000000000000000'||rtrim(char(cast(decimal(vchf_vch_amt,15,2)*100 as bigint))),17),1,17)
			</Sentence>
		</DynSentence>
	
		<DynSentence name="Sql00">
			<Sentence>
				select count(*) cnt1 from RtyActDtl where InDat='%s' and Status='S'
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		<DynSentence name="Sql01">
			<Sentence>
				select count(*) cnt2 from RtyActDtl where InDat='%s' and Status='U'
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		<DynSentence name="Sq102">
			<!--缺少where条件找跨行转入的明细-->
			<Sentence>
				select count(*) cnt3 from rtytvchf
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq103">
			<Sentence>
				select a.InDat InDat, b.PSLCod PSLCod, a.BkAct BkAct,a.PayNo PayNo, b.BkCod BkCod, a.InAmt InAmt, a.IfOsd IfOsd,a.VchNo VchNo 
					from RtyActDtl a,rtyactinf b 
					where a.InDat='%s' and a.Status='U' and a.BkAct=b.BkAct
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		<DynSentence name="Sq104">
			<Sentence>
				select count(*) cnt4 from rtyactdtl where Status!='S'
			</Sentence>
		</DynSentence>
		
		<DynSentence name="Sq200">
			<Sentence>
				delete from rtytvchf
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq201">
			<Sentence>
				delete from rtytvchf where vchf_vch_ac not in (select rtrim(BkAct) from rtyactinf)
			</Sentence>
		</DynSentence>

		<DynSentence name="Sq300">
			<!--缺少where条件找跨行转入的明细-->
			<Sentence>
				insert into rtyactdtl
					select vchf_vch_ac, substr(vchf_vch_part_b,3,20) ,vchf_tr_date, vchf_vch_amt, '1', vchf_vch_no, '', 'U' from rtytvchf 
						where vchf_ap_code='35' and vchf_tr_code in ('4110','4710','4200') order by vchf_vch_ac
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq400">
			<Sentence>
				update rtyactdtl set BusLog='%s',Status='%s' where InDat='%s' and BkAct='%s' and InAmt='%s' and VchNo='%s' and Status='U'	
			</Sentence>
			<Fields>BusLog|Status|InDat|BkAct|InAmt|VchNo|</Fields>
		</DynSentence>	

		<Attributes>
			<Attribute name="nodatabase" value="2"/>
		</Attributes>

		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<!--添加授权-->
			<Exec func="PUB:AddAuthReason">
				<Arg name="AthCod" value="40" />
				<Arg name="AthMsg" value="RTY000" />
			</Exec>
			<Exec func="PUB:CheckLocalAuth" >
				<Arg name="ObjSvr" value="SHSTPUB1" />
			</Exec>		
	
		<!--
			<Exec func="PUB:GetAppInfo"/>
		-->
			<Set>TxnDat=$BkDat</Set>				<!--交易日期-->
			<!--	<Set>TxnDat=20060305</Set>	-->

			<!-- 检查是否已上传给房管局 -->
			<Set>QrySen=Sql00</Set>
			<Quote name="DbSele"/>
			<If condition="STRCMP($cnt1,0)!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=该日期的帐户明细已提交给房管局 </Set>
				<Return/>
			</If>
			<!-- 检查该监控帐户跨行转帐收款明细表rtyactdtl是否有交易日数据,没就从IFSS取文件导入并插入 -->
			<Set>QrySen=Sql01</Set>
			<Quote name="DbSele"/>
			<If condition="STRCMP($cnt2,0)=0">							
				<Set>ObjFNam=STRCAT($FilHed,_,$TxnDat,_,@BCFG.BrNo,.dat.Z)</Set>
				<Set>RcvFNam=$ObjFNam</Set>
				<Set>DskNam=STRCAT($RcvPth,$FilHed,_,$TxnDat,_,@BCFG.BrNo,.dat)</Set>
				<!--判断文件是不是存在-->	
		    	<Exec func="PUB:IsExistFile" error="IGNORE">
	        		<Arg name="FileName"  value="$DskNam"/>
				</Exec>
     			<If condition="~RetCod=-1">
					<!--  文件不存在,就从IFSS取 -->
	 				<Set>ObjPth=STRCAT($ObjPth,SUBSTR($TxnDat,7,2))</Set>
					<Set>ObjIp=@BCFG.IFSIp</Set>
					<Set>ObjUsr=@BCFG.IFSUser</Set>
					<Set>ObjPs=@BCFG.IFSPassword</Set>
					<Exec func="PUB:FtpGet" error="IGNORE">
						<Arg name="FtpCfg" value="FtpGCfg"/>
					</Exec>
					<If condition="~RetCod=-1">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=RTY999</Set>
						<Set>RspMsg=STRCAT(IFSS不存在,$RcvFNam,文件)</Set>
						<Return/>					
					</If>
					<!-- 将文件解压缩 -->
					<System command="rtyzip.sh" error="IGNORE">
						<Arg name="para1"     value="d"/>
						<Arg name="para2"     value="STRCAT($HomDir,$RcvPth,$RcvFNam)"/>
					</System>
					<If condition="~RetCod!=0">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=RTY999</Set>
						<Set>RspMsg=STRCAT($RcvFNam,"文件解压缩失败!")</Set>
						<Return/>				
					</If>					
				</If>
	    		<!--清理临时金融传票表rtytvchf-->
				<Set>QrySen=Sq200</Set>
				<Quote name="DbExec"/>
				<Exec  func="PUB:CommitWork"  />
				<!--取文件数据导入临时金融传票表rtytvchf-->
				<!--改用程序insert入库,不用DB2的IMPORT命令，为提高效率 xuan 20090402
				<System command="db2bcp.sh" error="IGNORE">
					<Arg name="para1"     value="in"/>
					<Arg name="para2"     value="STRCAT($HomDir,$DskNam)"/>
					<Arg name="para3"     value="rtytvchf"/>
				</System>
				<If condition="~RetCod!=0">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=导入文件出错</Set>
					<Return/>				
				</If>
				-->
				<Exec func="RTY:RtyVchfToDb" error="IGNORE">
					<Args>
						<Arg name="para1" value="STRCAT($HomDir,$DskNam)" />
					</Args>			
				</Exec>
				<If condition="~RetCod=-1">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=处理金融传票文件失败!</Set>
					<Return/>
				</If>	
				<!--删除文件-->	
				<Exec func="PUB:DeleteFile" error="IGNORE">
					<Arg name="FilNam"   value="STRCAT($HomDir,$DskNam)"/>
				</Exec>

				<!--删除与监控帐号无关的传票-->
				<Set>QrySen=Sq201</Set>
				<Quote name="DbExec"/>
				<!--判断监控帐号在交易日期有无帐务发生-->
				<Set>QrySen=Sq102</Set>
				<Quote name="DbSele"/>
				<If condition="STRCMP($cnt3,0)=0">
					<Set>MsgTyp=N</Set>
					<Set>RspCod=000000</Set>
					<Set>RspMsg=监控帐户无帐务发生 </Set>
					<Return/>
				</If>
				<!--转换金融传票表金额格式-->
				<Set>QrySen=UpdVchfAmt</Set>
				<Quote name="DbExec"/>				
				<!--根据传票统计监控帐号跨行转帐收款明细,-->
				<!--插入监控帐户跨行转帐收款明细表rtyactdtl-->
				<Set>QrySen=Sq300</Set>
				<Quote name="DbExec"/>
				<If condition="~RetCod=-2">
					<Exec func="PUB:RollbackWork" error="IGNORE" />			
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=没符合条件记录插入监控帐户跨行转帐收款明细表!</Set>
					<Return/>
				</If>
				<!--取交易日内转帐收款明细总笔数-->
				<Set>QrySen=Sql01</Set>
				<Quote name="DbSele"/>
				<If condition="STRCMP($cnt2,0)=0">
					<Exec func="PUB:RollbackWork" error="IGNORE" />			
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=没符合条件记录在监控帐户跨行转帐收款明细表!</Set>
					<Return/>					
				</If>
			</If>
			<!--从监控帐户跨行转帐收款明细表rtyactdtl取记录送第三方接口-->			
			<Exec func="PUB:OpenCursor"><!--打开游标-->
				<Arg name="SqlCur" value="Sq103"></Arg>
			</Exec>	
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=打开游标错 </Set>
				<Return/>					
			</If>	
			<Set>tmpCurRec=0</Set>	
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录-->
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<!--填房管接口-->
				<Quote name="FMPMsg"/>	<!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
				<Set>InDat=$InDat</Set>				<!--收款日期-->
				
				<Set>TtlCnt=$cnt2</Set>				<!--总笔数-->
				<Exec func="RTY:RtyToHex" error="IGNORE">
					<Arg name="HexPar1" value="$TtlCnt" />
				</Exec>
				<If condition="~RetCod != 0">
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=总笔数转十六进制出错!</Set>
					<Return />
				</If>
				<Set>TtlCnt=ADDCHAR(DELRIGHTSPACE($HexDat),8,0,1) </Set>
				<Exec func="RTY:RtyRevOrd" error="IGNORE">
					<Arg name="RevPar1" value="$TtlCnt" />
				</Exec>
				<If condition="~RetCod != 0">
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=总笔数倒序排列出错!</Set>
					<Return />
				</If>
				<Set>TtlCnt=$RevDat</Set>
				
				<Set>tmpCurRec=ADD($tmpCurRec,1)</Set>	<!--当前笔数-->
				<Exec func="RTY:RtyToHex" error="IGNORE">
					<Arg name="HexPar2" value="$tmpCurRec" />
				</Exec>
				<If condition="~RetCod != 0">
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=当前笔数转十六进制出错!</Set>
					<Return />
				</If>
				<Set>CurRec=ADDCHAR(DELRIGHTSPACE($HexDat),8,0,1) </Set>
				<Exec func="RTY:RtyRevOrd" error="IGNORE">
					<Arg name="RevPar2" value="$CurRec" />
				</Exec>
				<If condition="~RetCod != 0">
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=当前笔数倒序排列出错!</Set>
					<Return />
				</If>
				<Set>CurRec=$RevDat</Set>
								
				<Set>PSlCod= </Set>					<!--预售证号-->
				<Set>BkCod=$BkCod</Set>				<!--监控银行代码-->
				<Set>InAmt=$InAmt</Set>				<!--转入金额-->
				<Set>InNam= </Set>					<!--缴款人姓名-->
				<Set>CntCod= </Set>					<!--合同号-->
				<Set>PayNo=$PayNo</Set>				<!--缴款通知书编号-->
				<Set>IfOsd=ADDCHAR(DELRIGHTSPACE($IfOsd),2,0,1)</Set>	<!--是否跨行-->
				<!--发送第三方-->
				<Exec func="PUB:CallThirdOther" error="IGNORE">
					<Arg name="HTxnCd" value="464708" />
					<Arg name="ObjSvr" value="STHDRTY1" />
				</Exec>
				<If condition="~RetCod!=0">
					<Exec func="PUB:CloseCursor"></Exec>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=发送到第三方出错!</Set>
					<Return/>					
				</If>
				
				<!--判断第三方返回信息是否正确-->
				<Set>Status=SUBSTR($Status,2,1)</Set>
				<!--无论房管是否返回成功，让程序继续运行；如果是有错保存房管返回出错码
				<If condition="IS_NOEQUAL_STRING($Status,0)">
					<Exec func="PUB:CloseCursor"></Exec>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Switch expression="$Status">
						<Case value="1">
							<Set>RspMsg=房管局认证错!</Set>
							<Break/>
						</Case>
						<Case value="9">
							<Set>RspMsg=房管局返回错!</Set>
							<Break/>
						</Case>
						<Default>
							<Set>RspMsg=房管局返回错!</Set>
							<Break/>
						</Default>
					</Switch>
					<Return/>
				</If>
				-->
				<If condition="IS_EQUAL_STRING($Status,0)">
					<Set>Status=S</Set>
				</If>
				<!--修改该条已提交给房管局记录的状态,并COMMIT-->			
				<Set>QrySen=Sq400</Set>
				<Quote name="DbExec"/>
				<If condition="~RetCod=-2">
					<Exec func="PUB:RollbackWork" error="IGNORE" />
					<Exec func="PUB:CloseCursor"></Exec>			
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=没找到更新监控帐户跨行转帐收款明细表记录 </Set>
					<Return/>
				</If>
				<Exec  func="PUB:CommitWork"  />										
			</While>
			<Exec func="PUB:CloseCursor"/>

			<Set> PrnSts="0" </Set>  <!--设置打印标志-->
			<!--判断是否有不成功记录；如果有，出不成功清单-->
			<Set>QrySen=Sq104</Set>
			<Quote name="DbSele"/>
			<If condition="IS_NOEQUAL_STRING($cnt4,0)">
				<Set> FalFil=STRCAT($HomDir,dat/term/send/RTY_FalRec.RPT)</Set>
				<Exec func="PUB:GenerateReport">
					<Args>
						<Arg name="ObjFil" value="$FalFil"/>
						<Arg name="FmtFil" value="etc/RTY001_RPT.XML"/>
 						<Arg name="PrtTlr" value="$TlrId"/>      <!--制表柜员-->
						<Arg name="PrtDat" value="$ActDat"/>     <!--打印日期-->
					</Args>
				</Exec>
				<Set>MsgSmr=监控帐户跨行转帐收款明细提交房管局失败清单打印</Set>
				<Exec  func="PUB:SendFileMessage">
					<Args>
						<Arg name="MsgTyp" value="4"/>
						<Arg name="ObjNod" value="$NodNo"/>
						<Arg name="BusTyp" value="PM"/>
						<Arg name="AplCod" value="0001"/>
						<Arg name="FilNam" value="RTY_FalRec.RPT"/>
						<Arg name="Summary" value="$MsgSmr"/>
						<Arg name="ObjTlr" value="$TlrId"/>
					</Args>
				</Exec>  
				<Set>PrnSts=1</Set>  <!--设置打印标志-->
			</If>
			<!--正确返回-->
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>	
		</FlowCtrl>
	</Transaction>
	<!--*********************************************************************************-->
	<Transaction code="464707" desc="监控帐户每日收支信息提交" >
		<DynSentence name="GetFMP">
			<Sentence>
				select FMPAcc FMPAcc,FMPPwd FMPPwd from rtyfmpmng 
			</Sentence>
		</DynSentence>
		<DynSentence name="UpdVchfAmt">
			<Sentence>
				update rtytvchf set 
					vchf_vch_amt=substr(right('00000000000000000'||rtrim(char(cast(decimal(vchf_vch_amt,15,2)*100 as bigint))),17),1,17)
			</Sentence>
		</DynSentence>
		<DynSentence name="UpdCdtmAmt">
			<Sentence>
				update rtycdtmst set 
					bal=substr(right('00000000000000000'||rtrim(char(cast(decimal(bal,15,2)*100 as bigint))),17),1,17)					
			</Sentence>
		</DynSentence>
		<!-- patch 20090305  监控账户没帐务发生也提交账户余额
		<DynSentence name="GetBkAct">
			<Sentence>

				select distinct vchf_vch_ac tmpBkAct from rtytvchf
				
			</Sentence>
		</DynSentence>
		-->
		<DynSentence name="GetBkAct">
			<Sentence>		
				select distinct BkAct tmpBkAct from rtyactinf where Status='0'
			</Sentence>
		</DynSentence>
		<DynSentence name="GetSCAmt">
			<Sentence>
				select value(sum(cast(vchf_vch_amt AS BIGINT)),0) tmpSCAmt from rtytvchf
					where vchf_tr_date='%s' and vchf_vch_ac='%s' and vchf_vch_sign='C'
			</Sentence>
			<Fields>TxnDat|tmpBkAct</Fields>
		</DynSentence>
		<DynSentence name="GetSDAmt">
			<Sentence>
				select value(sum(cast(vchf_vch_amt AS BIGINT)),0) tmpSDAmt from rtytvchf
					where vchf_tr_date='%s' and vchf_vch_ac='%s' and vchf_vch_sign='D'
			</Sentence>
			<Fields>TxnDat|tmpBkAct</Fields>
		</DynSentence>
		<DynSentence name="GetActBal">
			<Sentence>
				select bal tmpActBal from rtycdtmst where ac_no='%s' and ac_sts!='C'
			</Sentence>
			<Fields>tmpBkAct</Fields>
		</DynSentence>
											
		<DynSentence name="Sql00">
			<Sentence>
				select count(*) cnt1 from rtyactiot where BkDat='%s' and Status='S'
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		<DynSentence name="Sql01">
			<Sentence>
				select count(*) cnt2 from rtyactiot where BkDat='%s' and Status='U'
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		<DynSentence name="Sq102">
			<!--缺少where条件找跨行转入的明细-->
			<Sentence>
				select count(*) cnt3 from rtytvchf
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq112">
			<Sentence>
				select count(*) cnt4 from rtycdtmst
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq103">
			<Sentence>
				select a.BkDat BkDat, b.PSLCod PSLCod, a.BkAct BkAct, b.BkCod BkCod, b.PrjNam PrjNam, a.BalOut BalOut, a.BalIn BalIn, a.BalAmt BalAmt
					from rtyactiot a,rtyactinf b 
					where a.BkDat='%s' and a.Status='U' and a.BkAct=b.BkAct
			</Sentence>
			<Fields>TxnDat|</Fields>
		</DynSentence>
		
		<DynSentence name="Sq200">
			<Sentence>
				delete from rtytvchf
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq210">
			<Sentence>
				delete from rtycdtmst
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq201">
			<Sentence>
				delete from rtytvchf where vchf_vch_ac not in (select rtrim(BkAct) from rtyactinf)
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq211">
			<Sentence>
				delete from rtycdtmst where ac_no not in (select rtrim(BkAct) from rtyactinf)
			</Sentence>
		</DynSentence>
		
		<DynSentence name="Sq300">
			<!--缺少where条件找收支信息-->
			<Sentence>
				insert into rtyactiot values('%s','%s','%s','%s','%s','U')
			</Sentence>
			<Fields>tmpBkAct|TxnDat|SDAmt|SCAmt|tmpActBal</Fields>
		</DynSentence>
		<DynSentence name="Sq400">
			<Sentence>
				update rtyactiot set Status='S' where BkAct='%s' and BkDat='%s' and Status='U'	
			</Sentence>
			<Fields>BkAct|BkDat</Fields>
		</DynSentence>
		<DynSentence name="Cur100">
			<Sentence>
				select vchf_jrn_no rty_jrn_no, vchf_vch_seq rty_vch_seq, vchf_vch_ac rty_vch_ac, 
				       vchf_vch_amt rty_vch_amt, vchf_vch_sign rty_vch_sign from rtytvchf
				    where vchf_ap_code='09' and vchf_tr_code='1030'
			</Sentence>
		</DynSentence>
		<DynSentence name="Cur100Upd">
			<Sentence>
				UPDATE rtytvchf SET vchf_vch_amt='%s',vchf_vch_sign='%s'
				    WHERE vchf_jrn_no='%s' AND vchf_vch_seq='%s' AND vchf_vch_ac='%s' AND vchf_ap_code='09' AND vchf_tr_code='1030'
			</Sentence>
			<Fields>CurAmt|CurDC|rty_jrn_no|rty_vch_seq|rty_vch_ac</Fields>
		</DynSentence>	
		
		<Attributes>
			<Attribute name="nodatabase" value="2"/>
		</Attributes>
	
		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<!--添加授权-->
			<Exec func="PUB:AddAuthReason">
				<Arg name="AthCod" value="40" />
				<Arg name="AthMsg" value="RTY000" />
			</Exec>
			<Exec func="PUB:CheckLocalAuth" >
				<Arg name="ObjSvr" value="SHSTPUB1" />
			</Exec>		
	
		<!--
			<Exec func="PUB:GetAppInfo"/>
		-->
			  <Set>TxnDat=$BkDat</Set>							<!--交易日期-->	
			<!-- <Set>TxnDat=20060305</Set>	-->
			<!-- 检查是否已上传给房管局 -->
			<Set>QrySen=Sql00</Set>
			<Quote name="DbSele"/>
			<If condition="STRCMP($cnt1,0)!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=该日期的监控帐户收支信息已提交给房管局!</Set>
				<Return/>
			</If>
			<!-- 检查该监控帐户收支表rtyactiot是否有交易日数据,没就从IFSS取文件导入并插入 -->
			<Set>QrySen=Sql01</Set>
			<Quote name="DbSele"/>
			<If condition="STRCMP($cnt2,0)=0">
	 			<Set>ObjPth=STRCAT($ObjPth,SUBSTR($TxnDat,7,2))</Set>
				<!--金融传票文件AIQSCFVH_日期_行号.dat-->
				<Set>ObjFNam=STRCAT($FilHed,_,$TxnDat,_,@BCFG.BrNo,.dat.Z)</Set>
				<Set>RcvFNam=$ObjFNam</Set>
				<Set>DskNam=STRCAT($RcvPth,$FilHed,_,$TxnDat,_,@BCFG.BrNo,.dat)</Set>
				<!--判断文件是不是存在-->	
		    	<Exec func="PUB:IsExistFile" error="IGNORE">
	        		<Arg name="FileName"  value="$DskNam"/>
				</Exec>
     			<If condition="~RetCod=-1">
					<!--  文件不存在,就从IFSS取 -->
					<Set>ObjIp=@BCFG.IFSIp</Set>
					<Set>ObjUsr=@BCFG.IFSUser</Set>
					<Set>ObjPs=@BCFG.IFSPassword</Set>
					<Exec func="PUB:FtpGet" error="IGNORE">
						<Arg name="FtpCfg" value="FtpGCfg"/>
					</Exec>
					<If condition="~RetCod=-1">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=RTY999</Set>
						<Set>RspMsg=STRCAT(IFSS不存在,$RcvFNam,文件)</Set>
						<Return/>
					</If>
					<!-- 将文件解压缩 -->
					<System command="rtyzip.sh" error="IGNORE">
						<Arg name="para1"     value="d"/>
						<Arg name="para2"     value="STRCAT($HomDir,$RcvPth,$RcvFNam)"/>
					</System>
					<If condition="~RetCod!=0">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=RTY999</Set>
						<Set>RspMsg=STRCAT($RcvFNam,"文件解压缩失败!")</Set>
						<Return/>
					</If>					
				</If>
	    		<!--清理临时金融传票表rtytvchf-->
				<Set>QrySen=Sq200</Set>
				<Quote name="DbExec"/>
				<Exec  func="PUB:CommitWork"  />
				<!--取文件数据导入临时金融传票表rtytvchf-->
				<!--改用程序insert入库,不用DB2的IMPORT命令，为提高效率 xuan 20090402
				<System command="db2bcp.sh" error="IGNORE">
					<Arg name="para1"     value="in"/>
					<Arg name="para2"     value="STRCAT($HomDir,$DskNam)"/>
					<Arg name="para3"     value="rtytvchf"/>
				</System>
				<If condition="~RetCod!=0">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=导入文件出错</Set>
					<Return/>				
				</If>
				-->
				<Exec func="RTY:RtyVchfToDb" error="IGNORE">
					<Args>
						<Arg name="para1" value="STRCAT($HomDir,$DskNam)" />
					</Args>			
				</Exec>
				<If condition="~RetCod=-1">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=处理金融传票文件失败!</Set>
					<Return/>
				</If>		
				<!--删除文件-->
				<Exec func="PUB:DeleteFile" error="IGNORE">
					<Arg name="FilNam"   value="STRCAT($HomDir,$DskNam)"/>
				</Exec>

				<!--删除与监控帐号无关的传票-->
				<Set>QrySen=Sq201</Set>
				<Quote name="DbExec"/>
				<!--判断监控帐号在交易日期有无帐务发生-->
				<Set>QrySen=Sq102</Set>
				<Quote name="DbSele"/>
				<If condition="STRCMP($cnt3,0)=0">
				  <!-- patch 20090305  监控账户没帐务发生也提交账户余额
					<Set>MsgTyp=N</Set>
					<Set>RspCod=000000</Set>
					<Set>RspMsg=监控帐户无帐务发生 </Set>
					<Return/>
					-->
				</If>
				<Else>
				  <!-- pathch 20080526
				       091030纯账务冲账交易能够红字记账，使金额为负，造成转换传票金额时报sql-420错误
				       在这里处理这种特殊情况，将金额变正，借贷方转相反（即借改贷，贷改借）
				  -->
				  <Exec func="PUB:OpenCursor"><!--打开游标-->
				  	<Arg name="SqlCurFmp" value="Cur100"></Arg>
				  </Exec>					
				  <If condition="~RetCod!=0">
				  	<Set>MsgTyp=E</Set>
				  	<Set>RspCod=RTY999</Set>
				  	<Set>RspMsg=打开游标错cur100!</Set>
				  	<Return/>
				  </If>
				  <While>
				  	<Exec func="PUB:FetchCursor" error="IGNORE"/>	<!--取下一笔记录-->
				  	<If condition="~RetCod=100">
				  		<Exec func="PUB:CloseCursor"/>	<!--关闭游标-->
				  		<Break/>
				  	</If>
				  	<Set>CurAmt=DELCHAR($rty_vch_amt,46)</Set>	<!--去掉小数点-->
				  	<If condition="INTCMP($CurAmt,1,0)">		<!--将金额为负做处理-->
				  		<Set>CurAmt=FDIV(DELCHAR($CurAmt,45),100,2)</Set>	<!--去掉负号后除100-->
				  		<If condition="STRCMP($rty_vch_sign,C)=0">	<!--将借贷标志反转-->
				  			<Set>CurDC=D</Set>
				  		</If>
				  		<Else>
				  			<Set>CurDC=C</Set>
				  		</Else>
				  		<!--更新金额为正、借贷标志-->
				  		<Set>QrySen=Cur100Upd</Set>
				  		<Quote name="DbExec"/>
				  		<If condition="~RetCod=-2">
				  			<Exec func="PUB:RollbackWork" error="IGNORE" />			
				  			<Set>MsgTyp=E</Set>
				  			<Set>RspCod=RTY999</Set>
				  			<Set>RspMsg=没找到该条传票记录 </Set>
				  			<Return/>
				  		</If>
				  		<Exec  func="PUB:CommitWork"  />  
				  	</If>
				  </While>
				  <!--转换金融传票表金额格式-->
				  <Set>QrySen=UpdVchfAmt</Set>
				  <Quote name="DbExec"/>
				</Else>
								
				<!--活期文件CDTMSTXX_日期_行号.dat-->
				<Set>ObjFNam=STRCAT(CDTMSTXX,_,$TxnDat,_,@BCFG.BrNo,.dat.Z)</Set>
				<Set>RcvFNam=$ObjFNam</Set>
				<Set>DskNam=STRCAT($RcvPth,CDTMSTXX,_,$TxnDat,_,@BCFG.BrNo,.dat)</Set>
				<!--判断文件是不是存在-->	
				<Exec func="PUB:IsExistFile" error="IGNORE">
				<Arg name="FileName"  value="$DskNam"/>
				</Exec>
				<If condition="~RetCod=-1">
					<!--  文件不存在,就从IFSS取 -->
					<Set>ObjIp=@BCFG.IFSIp</Set>
					<Set>ObjUsr=@BCFG.IFSUser</Set>
					<Set>ObjPs=@BCFG.IFSPassword</Set>
					<Exec func="PUB:FtpGet" error="IGNORE">
						<Arg name="FtpCfg" value="FtpGCfg"/>
					</Exec>
					<If condition="~RetCod=-1">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=RTY999</Set>
						<Set>RspMsg=STRCAT(IFSS不存在,$RcvFNam,文件)</Set>
						<Return/>
					</If>
					<!-- 将文件解压缩 -->
					<System command="rtyzip.sh" error="IGNORE">
						<Arg name="para1"     value="d"/>
						<Arg name="para2"     value="STRCAT($HomDir,$RcvPth,$RcvFNam)"/>
					</System>
					<If condition="~RetCod!=0">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=RTY999</Set>
						<Set>RspMsg=STRCAT($RcvFNam,"文件解压缩失败!")</Set>
						<Return/>
					</If>
				</If>
				<!--清理临时活期账户表rtycdtmst-->
				<Set>QrySen=Sq210</Set>
				<Quote name="DbExec"/>
				<Exec  func="PUB:CommitWork"  />
				<!--取文件数据导入临时活期账户表rtycdtmst-->
				<!--改用程序insert入库,不用DB2的IMPORT命令，为提高效率 xuan 20090402
				<System command="db2bcp.sh" error="IGNORE">
					<Arg name="para1"     value="in"/>
					<Arg name="para2"     value="STRCAT($HomDir,$DskNam)"/>
					<Arg name="para3"     value="rtycdtmst"/>
				</System>
				<If condition="~RetCod!=0">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=导入文件出错!</Set>
					<Return/>
				</If>
				-->
				<Exec func="RTY:RtyCdtmstToDb" error="IGNORE">
					<Args>
						<Arg name="para1" value="STRCAT($HomDir,$DskNam)" />
					</Args>			
				</Exec>
				<If condition="~RetCod=-1">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=处理活期文件失败!</Set>
					<Return/>
				</If>
				<!--删除文件-->
				<Exec func="PUB:DeleteFile" error="IGNORE">
					<Arg name="FilNam"   value="STRCAT($HomDir,$DskNam)"/>
				</Exec>

				<!--删除与监控帐号无关的活期账户-->
				<Set>QrySen=Sq211</Set>
				<Quote name="DbExec"/>
				<!--判断监控帐号是否存在临时活期账户表rtycdtmst-->
				<Set>QrySen=Sq112</Set>
				<Quote name="DbSele"/>
				<If condition="STRCMP($cnt4,0)=0">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=临时活期账户表rtycdtmst没监控帐户!</Set>
					<Return/>
				</If>
				<!--转换临时活期账户表的当前余额格式-->
				<Set>QrySen=UpdCdtmAmt</Set>
				<Quote name="DbExec"/>
								
				<!--根据传票统计监控帐号当日收支金额-->
				<!--用游标方法，计算每个监控帐户的收支情况-->
				<Exec func="PUB:OpenCursor"><!--打开游标-->
					<Arg name="SqlCurFmp" value="GetBkAct"></Arg>
				</Exec>					
				<If condition="~RetCod!=0">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=打开游标错!</Set>
					<Return/>
				</If>
				<While>
					<Exec func="PUB:FetchCursor" error="IGNORE"/>	<!--取下一笔记录-->
					<If condition="~RetCod=100">
						<Exec func="PUB:CloseCursor"/>	<!--关闭游标-->
						<Break/>
					</If>
					<!--根据传票找tmpBkAct的收入金额总和-->
					<Set>QrySen=GetSCAmt</Set>
					<Quote name="DbSele"/>
					<Set>SCAmt=ADDCHAR(DELBOTHSPACE($tmpSCAmt),17,0,1)</Set>
					<!--tmpBkAct没发生收入，置收入金额为零-->
					<If condition="~RetCod=-2">
						<Set>SCAmt=00000000000000000</Set>
					</If>
					<!--根据传票找tmpBkAct的支出金额总和-->
					<Set>QrySen=GetSDAmt</Set>
					<Quote name="DbSele"/>
					<Set>SDAmt=ADDCHAR(DELBOTHSPACE($tmpSDAmt),17,0,1)</Set>					
					<!--tmpBkAct没发生支出，置支出金额为零-->
					<If condition="~RetCod=-2">
						<Set>SDAmt=00000000000000000</Set>
					</If>					
					<!--判断tmpBkAct当日有无收支,如果有发生收支就插rtyactiot
					<If condition="OR(IS_NOEQUAL_STRING($SCAmt,00000000000000000),IS_NOEQUAL_STRING($SDAmt,00000000000000000))">
					-->
						<!--从临时活期帐户表，取tmpBkAct的余额-->
						<Set>QrySen=GetActBal</Set>
						<Quote name="DbSele"/>
						<If condition="~RetCod=-2">
						  <!--该账户不存在活期账户表，或者已经销户。没需将余额发送给房管局-->
						</If>
						<Else>			
						  <!--插入监控帐户收支表rtyactiot-->
						  <Set>QrySen=Sq300</Set>
						  <Quote name="DbExec"/>
						  <If condition="~RetCod=-2">
						  	<Exec func="PUB:RollbackWork" error="IGNORE" />
						  	<Set>MsgTyp=E</Set>
						  	<Set>RspCod=RTY999</Set>
						  	<Set>RspMsg=没符合条件记录插入监控帐户收支表!</Set>
						  	<Return/>
						  </If>
						</Else>
					<!--
					</If>
					-->
				</While>
				
				<!--取交易日内监控帐户是否有收支-->
				<Set>QrySen=Sql01</Set>
				<Quote name="DbSele"/>
				<If condition="STRCMP($cnt2,0)=0">	
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=没符合条件记录在监控帐户跨行转帐收款明细表!</Set>
					<Return/>
				</If>
			</If>
			<!--从监控帐户跨行转帐收款明细表rtyactdtl取记录送第三方接口-->		
			<Exec func="PUB:OpenCursor"><!--打开游标-->
				<Arg name="SqlCur" value="Sq103"></Arg>
			</Exec>	
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=打开游标错 </Set>
				<Return/>
			</If>	

			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录-->
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<!--填房管接口-->
				<Quote name="FMPMsg"/>	<!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
				<!--发送第三方-->
				<Exec func="PUB:CallThirdOther" error="IGNORE">
					<Arg name="HTxnCd" value="464707" />
					<Arg name="ObjSvr" value="STHDRTY1" />
				</Exec>
				<If condition="~RetCod!=0">
					<Exec func="PUB:CloseCursor"></Exec>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=发送到第三方出错!</Set>
					<Return/>					
				</If>

				<!--判断第三方返回信息是否正确-->
				<Set>Status=SUBSTR($Status,2,1)</Set>
				<If condition="IS_NOEQUAL_STRING($Status,0)">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Switch expression="$Status">
						<Case value="1">
							<Set>RspMsg=房管局认证错!</Set>
							<Break/>
						</Case>
						<Case value="9">
							<Set>RspMsg=房管局返回错!</Set>
							<Break/>
						</Case>
						<Default>
							<Set>RspMsg=房管局返回错!</Set>
							<Break/>
						</Default>
					</Switch>
					<Return/>
				</If>
				
				<!--修改该条已提交给房管局记录为成功状态为'S',并COMMIT-->	
				<Set>QrySen=Sq400</Set>
				<Quote name="DbExec"/>
				<If condition="~RetCod=-2">
					<Exec func="PUB:RollbackWork" error="IGNORE" />			
					<Set>MsgTyp=E</Set>
					<Set>RspCod=RTY999</Set>
					<Set>RspMsg=没找到更新监控帐户跨行转帐收款明细表记录 </Set>
					<Return/>
				</If>
				<Exec  func="PUB:CommitWork"  />
											
			</While>
			<Exec func="PUB:CloseCursor"/>
			<!--正确返回-->
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>	
		</FlowCtrl>
	</Transaction>
	<!--*********************************************************************************-->
	<Transaction code="464704" desc="获取支出批准书信息" >
		<DynSentence name="GetFMP">
			<Sentence>
				select FMPAcc FMPAcc,FMPPwd FMPPwd from rtyfmpmng
			</Sentence>
		</DynSentence>
		
		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
			<Quote name="FMPMsg"/>
					
			<!--发送第三方-->
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="HTxnCd" value="464704" />
				<Arg name="ObjSvr" value="STHDRTY1" />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=发送到第三方出错 </Set>
				<Return/>					
			</If>
			<!--判断第三方返回信息是否正确-->	
			<If condition="IS_NOEQUAL_STRING($Status,00)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Switch expression="$Status">
					<Case value="01">
						<Set>RspMsg=房管局认证错!</Set>
						<Break/>
					</Case>
					<Case value="02">
						<Set>RspMsg=房管局支出批准书编号不存在!</Set>
						<Break/>
					</Case>
					<Case value="04">
						<Set>RspMsg=该笔支出已付或在途!</Set>
						<Break/>
					</Case>
					<Case value="09">
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Case>
					<Case value="11">
						<Set>RspMsg=数据库异常：该编号的划拨批准数量大于1!</Set>
						<Break/>
					</Case>
					<Case value="41">
						<Set>RspMsg=校验不通过：与监控银行代码不匹配或申请划拨金额不正确!</Set>
						<Break/>
					</Case>
					<Default>
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Default>
				</Switch>
				<Return/>
			</If>
			<Set>Status=SUBSTR($Status,2,1)</Set>
			<Set>BkSts=SUBSTR($BkSts,2,1)</Set>	
			<!--正确返回-->	
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>
		</FlowCtrl>
	</Transaction>
	<!--*********************************************************************************-->
	<Transaction code="464705" desc="监控帐户支出信息提交" >
		<DynSentence name="GetFMP">
			<Sentence>
				select FMPAcc FMPAcc,FMPPwd FMPPwd from rtyfmpmng
			</Sentence>
		</DynSentence>
		
		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<!--添加授权-->		
			<Exec func="PUB:AddAuthReason">
				<Arg name="AthCod" value="40" />
				<Arg name="AthMsg" value="RTY000" />
			</Exec>
			<Exec func="PUB:CheckLocalAuth" >
				<Arg name="ObjSvr" value="SHSTPUB1" />
			</Exec>		

			<!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
			<Quote name="FMPMsg"/>	
			<!--取前置流水号-->
			<Exec  func="PUB:GetLogNo" error="IGNORE"/>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=取前置流水号失败,不作回应!</Set>
				<Return/>
			</If>
			<!--发送第三方-->
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="HTxnCd" value="464705" />
				<Arg name="ObjSvr" value="STHDRTY1" />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=发送到第三方出错!</Set>
				<Return/>					
			</If>
			<!--判断第三方返回信息是否正确-->
			<If condition="IS_NOEQUAL_STRING($Status,00)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Switch expression="$Status">
					<Case value="01">
						<Set>RspMsg=房管局认证错!</Set>
						<Break/>
					</Case>
					<Case value="02">
						<Set>RspMsg=房管局支出批准书编号不存在!</Set>
						<Break/>
					</Case>
					<Case value="04">
						<Set>RspMsg=该笔支出已存在（已付或在途）</Set>
						<Break/>
					</Case>					
					<Case value="09">
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Case>
					<Case value="11">
						<Set>RspMsg=数据库异常：该编号的划拨批准书数量大于1!</Set>
						<Break/>
					</Case>
					<Case value="41">
						<Set>RspMsg=校验不通过</Set>
						<Break/>
					</Case>
					<Default>
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Default>
				</Switch>
				<Return/>
			</If>

			<!-- 房管局返回成功,插入监控帐号支出信息表rtypayout -->
			<!--测试时用的程序段
			<Set>LogNo=$LogNo</Set>
			<Set>TxnCod=$TxnCod</Set>
			<Set>ActDat=$ActDat</Set>
			<Set>CcyCod=CNY</Set>
			<Set>OrgNo= </Set>
			<Set>NodNo=$NodNo</Set>
			<Set>TlrId=$TlrId</Set>
			<Set>NodTrc=$NodTrc</Set>
			<Set>CntrId= </Set>
			<Set>FTxnTm=$FTxnTm</Set>
			<Set>ThdChk=0</Set>
			<Set>TxnSts=S</Set>
			<Set>AuthNo=$AuthNo</Set>
			<Set>BkAct=$BkAct</Set>
			<Set>BkCod= </Set>
			<Set>PotAmt=$PotAmt</Set>
			<Set>GtrAct=$GtrAct</Set>
			<Set>GtrNam=$GtrNam</Set>
			<Set>PotTim=$PotTim</Set>
			<Set>BkBal=$BkBal</Set>
			<Set>BusLog=$BusLog</Set>
			<Set>BkSts=$BkSts</Set>
			<Set>Inform= </Set>
			-->
			<Set>Status=SUBSTR($Status,2,1)</Set>
			<Set>BkSts=SUBSTR($BkSts,2,1)</Set>
			<Set>TxnSts=S</Set>
			<Set>CcyCod=CNY</Set>
			<Exec  func="PUB:InsertRecord" >
				<Arg name ='TblNam' value='rtypayout' />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=插入监控帐号支出信息表rtypayout错!</Set>
				<Return/>					
			</If>			
			<!--正确返回-->
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>
		</FlowCtrl>
	</Transaction>
	<!--*********************************************************************************-->
	<Transaction code="464706" desc="取消监控帐户支出信息" >
		<DynSentence name="GetFMP">
			<Sentence>
				select FMPAcc FMPAcc,FMPPwd FMPPwd from rtyfmpmng
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq100">
			<Sentence>
				select count(*) cnt1 from rtypayout where  AuthNo='%s' and TxnCod='464705' and TxnSts='S' 
			</Sentence>
			<Fields>AuthNo|</Fields>
		</DynSentence>
		<DynSentence name="Sq101">
			<Sentence>
				select AuthNo,BkAct,BkCod,PotAmt,GtrAct,GtrNam,PotTim,BkBal from rtypayout where  AuthNo='%s' and TxnCod='464705' and TxnSts='S' 
			</Sentence>
			<Fields>AuthNo|</Fields>
		</DynSentence>
		<DynSentence name="Sq400">
			<Sentence>
				update rtypayout set TxnSts='%s' where  AuthNo='%s' and TxnCod='464705' and TxnSts='S'
			</Sentence>
			<Fields>TxnSts|AuthNo|</Fields>
		</DynSentence>				
		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<!--添加授权-->		
			<Exec func="PUB:AddAuthReason">
				<Arg name="AthCod" value="40" />
				<Arg name="AthMsg" value="RTY000" />
			</Exec>
			<Exec func="PUB:CheckLocalAuth" >
				<Arg name="ObjSvr" value="SHSTPUB1" />
			</Exec>		

			<!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
			<Quote name="FMPMsg"/>
			<!--检查原监控帐户支出信息是否存在-->
			<Set>QrySen=Sq100</Set>
			<Quote name="DbSele"/>
			<If condition="STRCMP($cnt1,0)=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=找不到原监控帐户支出信息!</Set>
				<Return/>
			</If>
			<!--取原监控帐户支出信息-->
			<Set>QrySen=Sq101</Set>
			<Quote name="DbSele"/>
			<!--取前置流水号-->
			<Exec  func="PUB:GetLogNo" error="IGNORE"/> 
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=取前置流水号失败,不作回应!</Set>
				<Return/>
			</If>
			<!--发送第三方-->
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="HTxnCd" value="464706" />
				<Arg name="ObjSvr" value="STHDRTY1" />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=发送到第三方出错!</Set>
				<Return/>					
			</If>
			<!--判断第三方返回信息是否正确-->
			<If condition="IS_NOEQUAL_STRING($Status,00)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Switch expression="$Status">
					<Case value="01">
						<Set>RspMsg=房管局认证错!</Set>
						<Break/>
					</Case>
					<Case value="02">
						<Set>RspMsg=房管局支出批准书编号不存在!</Set>
						<Break/>
					</Case>
					<Case value="04">
						<Set>RspMsg=该笔支出已取消!</Set>
						<Break/>
					</Case>					
					<Case value="09">
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Case>
					<Default>
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Default>
				</Switch>
				<Return/>
			</If>
			
			<Set>Status=SUBSTR($Status,2,1)</Set>
			<!--房管局返回成功-->
			<!--修改监控帐号支出信息表rtypayout,原支出信息TxnSts状态改为'R'-->
			<Set>TxnSts=R</Set>
			<Set>QrySen=Sq400</Set>
			<Quote name="DbExec"/>			
			<!--插入监控帐号支出信息表rtypayout,为取消支出记录-->
			<Set>BkSts=SUBSTR($BkSts,2,1)</Set>
			<Set>TxnSts=S</Set>
			<Set>Inform=$CclRsn</Set>
			<Set>CcyCod=CNY</Set>
			
			<!--测试时用的程序段
			<Set>LogNo=$LogNo</Set>
			<Set>TxnCod=$TxnCod</Set>
			<Set>ActDat=$ActDat</Set>
			<Set>CcyCod=CNY</Set>
			<Set>OrgNo= </Set>
			<Set>NodNo=$NodNo</Set>
			<Set>TlrId=$TlrId</Set>
			<Set>NodTrc=$NodTrc</Set>
			<Set>CntrId= </Set>
			<Set>FTxnTm=$FTxnTm</Set>
			<Set>ThdChk=0</Set>
			<Set>TxnSts=S</Set>
			<Set>AuthNo=$AuthNo</Set>
			<Set>BkAct=$BkAct</Set>
			<Set>BkCod= </Set>
			<Set>PotAmt=$PotAmt</Set>
			<Set>GtrAct=$GtrAct</Set>
			<Set>GtrNam=$GtrNam</Set>
			<Set>PotTim=$PotTim</Set>
			<Set>BkBal=$BkBal</Set>
			<Set>BusLog=$BusLog</Set>
			<Set>BkSts=$BkSts</Set>
			-->
			
			<Exec  func="PUB:InsertRecord" >
				<Arg name ='TblNam' value='rtypayout' />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=插入监控帐号支出信息表rtypayout错!</Set>
				<Return/>					
			</If>			
			<!--正确返回-->
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>
		</FlowCtrl>
	</Transaction>
	<!--*********************************************************************************-->
	<Transaction code="464703" desc="取消商品房缴款信息" >
		<DynSentence name="GetFMP">
			<Sentence>
				select FMPAcc FMPAcc,FMPPwd FMPPwd from rtyfmpmng
			</Sentence>
		</DynSentence>
		<DynSentence name="Sq100">
			<Sentence>
				select count(*) cnt1 from rtypaymnt where  PayNo='%s' and TxnCod='464702' and TxnSts='S' 
			</Sentence>
			<Fields>PayNo|</Fields>
		</DynSentence>
		<DynSentence name="Sq101">
			<Sentence>
				select PayNo,BkAct,BkCod,PblDat,PblAmt,PblBk,PblAct,IfOsd,CntCod,TrmCod,Inform HusInf from rtypaymnt where PayNo='%s' and TxnCod='464702' and TxnSts='S' 
			</Sentence>
			<Fields>PayNo|</Fields>
		</DynSentence>
		<DynSentence name="Sq400">
			<Sentence>
				update rtypaymnt set TxnSts='%s' where  PayNo='%s' and TxnCod='464702' and TxnSts='S' 
			</Sentence>
			<Fields>TxnSts|PayNo|</Fields>
		</DynSentence>				
		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<!--添加授权-->		
			<Exec func="PUB:AddAuthReason">
				<Arg name="AthCod" value="40" />
				<Arg name="AthMsg" value="RTY000" />
			</Exec>
			<Exec func="PUB:CheckLocalAuth" >
				<Arg name="ObjSvr" value="SHSTPUB1" />
			</Exec>		

			<!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
			<Quote name="FMPMsg"/>
			<!--检查原监控帐户支出信息是否存在-->
			<Set>QrySen=Sq100</Set>
			<Quote name="DbSele"/>
			<If condition="STRCMP($cnt1,0)=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=找不到原商品房缴款信息!</Set>
				<Return/>
			</If>
			<!--取原商品房缴款信息-->
			<Set>QrySen=Sq101</Set>
			<Quote name="DbSele"/>
			<!--取前置流水号-->
			<Exec  func="PUB:GetLogNo" error="IGNORE"/> 
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=取前置流水号失败,不作回应!</Set>
				<Return/>
			</If>
			<!--发送第三方-->
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="HTxnCd" value="464703" />
				<Arg name="ObjSvr" value="STHDRTY1" />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=发送到第三方出错!</Set>
				<Return/>
			</If>
			<!--判断第三方返回信息是否正确-->			
			<If condition="IS_NOEQUAL_STRING($Status,00)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Switch expression="$Status">
					<Case value="01">
						<Set>RspMsg=房管局认证错!</Set>
						<Break/>
					</Case>
					<Case value="02">
						<Set>RspMsg=房管局缴款通知书编号不存在!</Set>
						<Break/>
					</Case>			
					<Case value="09">
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Case>
					<Case value="11">
						<Set>RspMsg=数据库异常：该编号的缴款通知书数量大于1!</Set>
						<Break/>
					</Case>
					<Case value="31">
						<Set>RspMsg=该笔款项状态非在途或收款银行代码不匹配!</Set>
						<Break/>
					</Case>
					<Default>
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Default>
				</Switch>
				<Return/>
			</If>
			<Set>Status=SUBSTR($Status,2,1)</Set>
			<!--房管局返回成功-->
			<!--修改商品房缴款信息表rtypaymnt,原支出信息TxnSts状态改为'R'-->
			<Set>TxnSts=R</Set>
			<Set>QrySen=Sq400</Set>
			<Quote name="DbExec"/>			
			<!--插入商品房缴款信息表rtypaymnt,为取消缴费记录-->
			<Set>BkSts=SUBSTR($BkSts,2,1)</Set>
			<Set>TxnSts=S</Set>
			<Set>Inform=$CclRsn</Set>
			<Set>CcyCod=CNY</Set>

			<Exec  func="PUB:InsertRecord" >
				<Arg name ='TblNam' value='rtypaymnt' />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=插入商品房缴款信息表rtypaymnt错!</Set>
				<Return/>
			</If>			
			<!--正确返回-->
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>
		</FlowCtrl>
	</Transaction>

	<!--*********************************************************************************-->
	<Transaction code="464788" desc="增加监控帐户信息" >
		<DynSentence name="Sq100">
			<Sentence>
				select count(*) cnt1 from rtyactinf where  BkAct='%s' and Status='0' 
			</Sentence>
			<Fields>BkAct|</Fields>
		</DynSentence>
		<DynSentence name="InsAct">
			<Sentence>
				insert into rtyactinf values('%s','%s','%s','0301','%s','%s','0')
			</Sentence>
			<Fields>NodNo1|CrpNam|BkAct|PSlCod|PrjNam|</Fields>
		</DynSentence>
		<DynSentence name="DelAct">
			<Sentence>
				delete from rtyactinf where BkAct='%s' and Status='0'
			</Sentence>
			<Fields>BkAct|</Fields>
		</DynSentence>
		<DynSentence name="MultiQuery">
			<Sentence>
				select * from rtyactinf where  Status='0' 
			</Sentence>
		</DynSentence>
		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<Switch expression="$TxnFlg">
				<Case value="0">		<!--insert-->
					<!--检测监控帐户是否存在-->
					<Set>QrySen=Sq100</Set>
					<Quote name="DbSele"/>
					<If condition="IS_NOEQUAL_STRING($cnt1,0)">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=RTY999</Set>
						<Set>RspMsg=该监控帐户已经存在!</Set>
						<Return/>
					</If>
					<!--插入监控帐户信息-->
					<Set>QrySen=InsAct</Set>
					<Quote name="DbExec"/>
					<Break/>
				</Case>
				<Case value="1">		<!--multiquery-->
					<Exec func="PUB:MultiQuery" >
						<Arg name="SqlCmd" value="MultiQuery" />
					</Exec>
					<Break/>
				</Case>
				<Case value="2">		<!--delete-->
					<!--检测监控帐户是否存在-->
					<Set>QrySen=Sq100</Set>
					<Quote name="DbSele"/>
					<If condition="IS_EQUAL_STRING($cnt1,0)">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=RTY999</Set>
						<Set>RspMsg=该监控帐户不存在!</Set>
						<Return/>
					</If>
					<!--删除监控帐户信息-->
					<Set>QrySen=DelAct</Set>
					<Quote name="DbExec"/>
					<Break/>
				</Case>
			</Switch>
			<!--正确返回-->
			<Set>Status=0</Set>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>			
		</FlowCtrl>
	</Transaction>

	
	<!--*********************************************************************************-->
	<Transaction code="464709" desc="修改接入用户密码" >
		<DynSentence name="GetFMP">
			<Sentence>
				select FMPAcc FMPAcc,FMPPwd FMPPwd from rtyfmpmng
			</Sentence>
		</DynSentence>
		<DynSentence name="UpdPwd">
			<Sentence>
				update rtyfmpmng set FmpPwd='%s'
			</Sentence>
			<Fields>NewPwd|</Fields>
		</DynSentence>
		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
			<Quote name="FMPMsg"/>	
			<!--发送第三方-->
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="HTxnCd" value="464709" />
				<Arg name="ObjSvr" value="STHDRTY1" />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=发送到第三方出错!</Set>
				<Return/>
			</If>
			<!--判断第三方返回信息是否正确-->
			<Set>Status=SUBSTR($Status,2,1)</Set>
			<If condition="IS_NOEQUAL_STRING($Status,0)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Switch expression="$Status">
					<Case value="1">
						<Set>RspMsg=房管局认证错!</Set>
						<Break/>
					</Case>	
					<Case value="9">
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Case>
					<Default>
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Default>
				</Switch>
				<Return/>
			</If>
			<!--更新监控帐户密码-->
			<Set>QrySen=UpdPwd</Set>
			<Quote name="DbExec"/>
			<!--正确返回-->
			<Set>Status=0</Set>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>			
		</FlowCtrl>
	</Transaction>
	<!--*********************************************************************************-->
	<Transaction code="464710" desc="取消监控批准书信息查询" >
		<DynSentence name="GetFMP">
			<Sentence>
				select FMPAcc FMPAcc,FMPPwd FMPPwd from rtyfmpmng
			</Sentence>
		</DynSentence>
		
		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
			<Quote name="FMPMsg"/>	
			<!--发送第三方-->
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="HTxnCd" value="464710" />
				<Arg name="ObjSvr" value="STHDRTY1" />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=发送到第三方出错!</Set>
				<Return/>
			</If>
			<!--判断第三方返回信息是否正确-->
			<If condition="IS_NOEQUAL_STRING($Status,00)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Switch expression="$Status">
					<Case value="01">
						<Set>RspMsg=房管局认证错!</Set>
						<Break/>
					</Case>	
					<Case value="02">
						<Set>RspMsg=取消监控批准书不存在!</Set>
						<Break/>
					</Case>
					<Case value="09">
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Case>
					<Default>
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Default>
				</Switch>
				<Return/>
			</If>
			<Set>Status=SUBSTR($Status,2,1)</Set>

			<!--正确返回-->
			<Set>Status=0</Set>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>			
		</FlowCtrl>
	</Transaction>
	<!--*********************************************************************************-->
	<Transaction code="464711" desc="查询款项是否在监控范围" >
		<DynSentence name="GetFMP">
			<Sentence>
				select FMPAcc FMPAcc,FMPPwd FMPPwd from rtyfmpmng
			</Sentence>
		</DynSentence>
		
		<FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<!--获取接入帐户,MD5接入验证码,消息流水号和时间戳-->
			<Quote name="FMPMsg"/>	
			<!--发送第三方-->
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="HTxnCd" value="464711" />
				<Arg name="ObjSvr" value="STHDRTY1" />
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Set>RspMsg=发送到第三方出错!</Set>
				<Return/>
			</If>
			<!--判断第三方返回信息是否正确-->
			<If condition="IS_NOEQUAL_STRING($Status,00)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=RTY999</Set>
				<Switch expression="$Status">
					<Case value="01">
						<Set>RspMsg=房管局认证错!</Set>
						<Break/>
					</Case>	
					<Case value="02">
						<Set>RspMsg=款项在监控范围内，客户必须提供缴款通知书!</Set>
						<Break/>
					</Case>
					<Case value="09">
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Case>
					<Default>
						<Set>RspMsg=房管局返回错!</Set>
						<Break/>
					</Default>
				</Switch>
				<Return/>
			</If>
			<Set>Status=SUBSTR($Status,2,1)</Set>

			<!--正确返回-->
			<Set>Status=0</Set>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>			
		</FlowCtrl>
	</Transaction>
</Application>
