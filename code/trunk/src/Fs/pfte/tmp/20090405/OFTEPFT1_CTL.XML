<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="PFT" code="259">
  <LibDeclare>
    <Library name="PFT" value="dll/pft_446.so"/>
    <Library name="CBS" value="dll/cbs441.so"/>
  </LibDeclare>
  <ConfigDeclare>
    <Config name="PFTCSW"    value="etc/PFT_CSW_446999.XML"/>
    <Config name="BatFormat" value="etc/PFT_FMT_446999.XML"/>
  </ConfigDeclare>
  <TableDeclare>
    <Table name="PftBnkInf446" value="PftBnkInf446"/>
    <Table name="PftNodInf446" value="PftNodInf446"/>
    <Table name="PftChkTot446" value="PftChkTot446"/>
    <Table name="PftCusAgt446" value="PftCusAgt446"/>
    <Table name="PftTxnJnl446" value="PftTxnJnl446"/>
    <Table name="PftSec202Sum446" value="PftSec202Sum446"/>
    <Table name="PftSec202Dtl446" value="PftSec202Dtl446"/>
    <Table name="PftCrpInf446" value="PftCrpInf446"/>
    <Table name="PftFilInf446" value="PftFilInf446"/>
    <Table name="PftSec203Sum446" value="PftSec203Sum446"/>
    <Table name="PftSec203Dtl" value="PftSec203Dtl"/>
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="RptDir" value="dat/term/send/"/>
    <Busdef name="IcsRcvDir" value="dat/pft/recv/"/>
    <Busdef name="IcsSndDir" value="dat/pft/send/"/>
    <Busdef name="PftDZRcvDir" value="/usr/rtsb/data/dz"/>
    <Busdef name="PftDZSndDir" value="/usr/rtsb/data/frecv/cent"/>
    <Busdef name="PftTKSndDir" value="/usr/rtsb/data/fsend/bank/"/>
    <Busdef name="PftTKRcvDir" value="/usr/rtsb/data/frecv"/>
    <Busdef name="BrNo"  value="446999"/>
  </BusDefDeclare>
  <Define>
    <Include file="etc/PFT_MCR_446999.XML"/>
    <Macro name="IfCursorErr"> <!-- 数据库游标操作出错处理 -->
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=打开游标失败或数据库错误，请联系技术人员</Set>
        <Exec func="PUB:CloseCursor" error="IGNORE"/>
        <Return/>
      </If>
    </Macro>
  </Define>
  
  <Transaction code="465901" desc="缴税代理协议维护">
    <Quote name="PftSqlLst"/>
    <DynSentence name="GetCusAgt"> <!-- 查询 -->
      <Sentence>
        select Sts OSts, TCrpTp OTCrpTp, AgtInf OAgtInf, ActTyp OActTyp, ActNo OActNo, ActNam OActNam, VchTyp OVchTyp,
               ActSqn OActSqn, PfaSub OPfaSub, BCusId OBCusId, SubCod OSubCod, EConTp OEConTp, PrjCod OPrjCod,
               DptCod ODptCod, CusTel OCusTel, OpnNod OOpnNod, OpnBr OOpnBr
          from PftCusAgt446 where TCrpTp='%s' and AgtInf='%s' and ActNo='%s'
      </Sentence>
      <Fields>TCrpTp|AgtInf|ActNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdCusAgt"> <!--修改-->
      <Sentence>
        TCrpTp='%s' and AgtInf='%s' and ActNo='%s'
      </Sentence>
      <Fields>TCrpTp|AgtInf|ActNo|</Fields>
    </DynSentence>
    <DynSentence name="DelCusAgt"> <!--删除-->
      <Sentence>
        delete from PftCusAgt446 where TCrpTp='%s' and AgtInf='%s' and ActNo='%s'
      </Sentence>
      <Fields>TCrpTp|AgtInf|ActNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitNoAccTran"/>
      <If condition="IS_NOEQUAL_STRING($Func,2)">
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="30"/>
          <Arg name="AthMsg" value="PFT000"/>
        </Exec>
        <Exec func="PUB:CheckLocalAuth">
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetCusAgt"/>
        </Args>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=STRCAT(查询表【PftCusAgt】失败)</Set>
        <Return/>
      </If>
      <If condition="AND(IS_NOEQUAL_STRING($Func,0), INTCMP(~RetCod,3,-2))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=指定记录不存在</Set>
        <Return/>
      </If>
      <Switch expression="$Func">
        <Case value="0"> <!-- 增加 -->
          <If condition="~RetCod!=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=记录已存在</Set>
            <Return/>
          </If>
<!--根据账户类型决定主机查询交易，获取相关资料-->
<!--对公校验开户行，对私校验密码-->
          <If condition="OR(IS_EQUAL_STRING($ActTyp,0),IS_EQUAL_STRING($ActTyp,A),IS_EQUAL_STRING($ActTyp,B))">
            <Set>AccFlg=0</Set>   <!--对公-->
            <Set>HTxnCd=109000</Set>
          </If>
          <Else>
            <Set>AccFlg=1</Set>   <!--对私-->
            <Set>TxnCnl=1</Set>
            <Set>PayTyp=1</Set>
            <Set>Pin=$Pswd</Set>
            <Set>PinTyp=2</Set>
            <Set>HTxnCd=476510</Set>
          </Else>
          <Exec func="PUB:CallHostAcc">
            <Arg name="HTxnCd" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=$HRspCd</Set>
            <Return/>
          </If>
          <If condition="AND(IS_NOEQUAL_STRING($NodNo,$OpnNod),IS_EQUAL_STRING($AccFlg,0))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=非帐户开户网点</Set>
            <Return/>
          </If>
          <Set>Sts=0</Set>
          <If condition="OR(IS_EQUAL_STRING($ActTyp,1),IS_EQUAL_STRING($ActTyp,2),IS_EQUAL_STRING($ActTyp,4))">
            <Set>OpnNod=$NodNo</Set>
            <Set>OpnBr=$BrNo</Set>
          </If>
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="PftCusAgt446"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 修改 -->
          <If condition="AND(IS_NOEQUAL_STRING($NodNo,$OOpnNod),IS_EQUAL_STRING($AccFlg,0))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=非帐户开户网点</Set>
            <Return/>
          </If>
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="PftCusAgt446"/>
            <Arg name="CndSts" value="UpdCusAgt"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2"> <!-- 查询 -->
          <Break/>
        </Case>
        <Case value="3"> <!-- 删除 -->
          <If condition="AND(IS_NOEQUAL_STRING($NodNo,$OOpnNod),IS_EQUAL_STRING($AccFlg,0))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=非帐户开户网点</Set>
            <Return/>
          </If>
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="DelCusAgt"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFT999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>Msg=STRCAT(银税协议维护:功能[,$Func,]机关类别[,$TCrpTp,]纳税人编码[,$AgtInf,]账户类型[,$ActTyp,])</Set>
      <Set>NoteInfo=STRCAT($Msg,凭证类型[,$VchTyp,]号码[,$VchCod,],帐号[,$ActNo,]网点[,$NodNo,]柜员[,$TlrId,])</Set>
      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="455130"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465902" desc="缴税代理协议浏览">
    <Quote name="PftSqlLst"/>
    <DynSentence name="MultiQuery">
      <Sentence>
        select TCrpTp, AgtInf, ActNo from PftCusAgt446 where ( TCrpTp='%s' or '%s'='' ) and ActNo='%s'
      </Sentence>
      <Fields>TCrpTp|TCrpTp|ActNo|</Fields>
    </DynSentence>
    <DynSentence name="QrySingleCusAgt">
      <Sentence>
        select * from PftCusAgt446 where TCrpTp='%s' and AgtInf='%s' and ActNo='%s'
      </Sentence>
      <Fields>TCrpTp|AgtInf|ActNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitNoAccTran"/>
      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Arg name="sql" value="QrySingleCusAgt"/>
          </Exec>
          <Break/>
        </Case>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>
        
  <Transaction code="465903" desc="缴税流水明细浏览">
    <Quote name="PftSqlLst"/>
    <DynSentence name="MultiQuery">
      <Sentence>
        select LogNo, ActDat OActDat, TxnAmt
          from PftTxnJnl446
         where ActNo='%s' and ( ActDat between '%s' and '%s' ) and ( BrNo='%s' or '%s'= ' ' )
      </Sentence>
      <Fields>ActNo|BegDat|EndDat|TBrNo|TBrNo|</Fields>
    </DynSentence>
    <DynSentence name="QrySingleTxnJnl">
      <Sentence>
        select LogNo,BilSts,OIFlag,ActDat OActDat,CcyCod,TxnAmt,ActNo,ActNam,ActTyp,VchTyp,VchCod,ActSqn,
               PfaSub,BCusId,SubCod,EConTp,PrjCod,DptCod,BrNo OBrNO,TlrId TlrNo,FTxnTm,TckNo,RtnCod,ClrDat,ClrSce,
               MsgFmt,TCrpCd,TActDt,TLogNo,RcvBNo,FskCod,TTxnTp,OTActDt,OTLogNo,AgtInf
          from PftTxnJnl446 where LogNo='%s'
      </Sentence>
      <Fields>LogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitNoAccTran"/>
      <Switch expression="$Func">
        <Case value="1">
          <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
            <Set>BnkCls=0</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="QryBnkInf"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=STRCAT(查询信息表【PftBnkInf】错误)</Set>
              <Return/>
            </If>
            <If condition="IS_EQUAL_STRING($NodNo,$CtlNod)">
              <Set>TBrNo= </Set>
            </If>
            <Else>
              <Set>TBrNo=$BrNo</Set>
            </Else>
          </If>
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Arg name="sql" value="QrySingleTxnJnl"/>
          </Exec>
          <Break/>
        </Case>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>
  
  <Transaction code="465904" desc="缴税凭证明细浏览">
    <Quote name="PftSqlLst"/>
    <DynSentence name="QrySec202Sum">
      <Sentence>
        select ActDat OActDat, TxnAmt, MsgFmt, ClrDat, SndCod, RcvCod, ClrSce, FilSeq
          from PftSec202Sum446
         where ActNo='%s' and ( ActDat between '%s' and '%s' ) and ( OpnBr='%s' or '%s'= ' ' )
      </Sentence>
      <Fields>ActNo|BegDat|EndDat|TBrNo|TBrNo|</Fields>
    </DynSentence>
    <DynSentence name="QrySec202Dtl">
      <Sentence>
        select DtlSeq,TaxTyp,PrjNam,LvlNam,TaxDt,DtlAmt,TSubCd,TVchNo
          from PftSec202Dtl446
         where MsgFmt='%s' and ClrDat='%s' and SndCod='%s' and RcvCod='%s' and ClrSce='%s' and FilSeq='%s'
        order by DtlSeq
      </Sentence>
      <Fields>MsgFmt|ClrDat|SndCod|RcvCod|ClrSce|FilSeq|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitNoAccTran"/>
      <Switch expression="$Func">
        <Case value="1">
          <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
            <Set>BnkCls=0</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="QryBnkInf"/>
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=STRCAT(查询信息表【PftBnkInf】错误)</Set>
              <Return/>
            </If>
            <If condition="IS_EQUAL_STRING($NodNo,$CtlNod)">
              <Set>TBrNo= </Set>
            </If>
            <Else>
              <Set>TBrNo=$BrNo</Set>
            </Else>
          </If>
          <Exec  func="PUB:MultiQuery">
            <Args>
              <Arg name="SqlCmd" value="QrySec202Sum"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Case value="2">
          <Exec  func="PUB:MultiQuery">
            <Args>
              <Arg name="SqlCmd" value="QrySec202Dtl"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465905" desc="缴税清单报表打印">
    <FlowCtrl>
      <Quote name="InitNoAccTran"/>
      <If condition="AND(IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800),IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),900))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Switch expression="$Func">
        <Case value="01">   <!--银行扣款流水打印-->
          <Set>FmtFil=STRCAT(etc/,PFT006_RPT,.XML)</Set>
          <Set>RptFil=STRCAT(PFT006_,$ClrDat,_,$ClrSce,$BrNo,.RPT)</Set>
          <Set>RptNam=STRCAT(分行【,$BrNo,】扣款流水清单)</Set>
          <Break/>
        </Case>
        <Case value="02">   <!--中心清算流水打印-->
          <Set>FmtFil=STRCAT(etc/,PFT007_RPT,.XML)</Set>
          <Set>RptFil=STRCAT(PFT007_,$ClrDat,_,$ClrSce,$BrNo,.RPT)</Set>
          <Set>RptNam=STRCAT(分行【,$BrNo,】中心清算流水清单)</Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="EXT:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$RptFil)"/>
        <Arg name="RptFile" value="$FmtFil"/>
        <Arg name="RptNam"  value="$RptNam"/>
        <Arg name="ClrDat"  value="$ClrDat"/>
        <Arg name="ClrSce"  value="$ClrSce"/>
        <Arg name="BrNo"    value="$BrNo"/>
        <Arg name="NodNo"   value="$NodNo"/>
        <Arg name="TlrId"   value="$TlrId"/>
        <Arg name="PrtDat"  value="$ActDat"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$RptFil"/>
        <Arg name="Summary" value="$RptNam"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465906" desc="缴税凭证回单打印">
    <Quote name="PftSqlLst"/>
    <FlowCtrl>
      <Quote name="InitNoAccTran"/>
      <Set>BnkCls=1</Set>
      <Quote name="GetBnkInf"/>
      <If condition="OR(INTCMP($ActTyp,3,1),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=个人业务暂不提供缴税回单,请联系财会部门</Set>
        <Return/>
      </If>
      <Switch expression="$Func">
        <Case value="01">   <!--缴税回单-->
          <Set>BakNod=$NodNo</Set>
          <If condition="OR(IS_EQUAL_STRING($NodNo,$CtlNod),INTCMP($ActTyp,3,1),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))">
            <Set>NodNo= </Set>
          </If>
          <Set>SndCod=000000000000</Set>
          <Set>FilNam=STRCAT(PFT999,$ActDat,$TlrId,.RPT)</Set>
          <If condition="IS_EQUAL_STRING($BrNo,446999)">
	          <Set>RcvCod=001600000000</Set>
            <Exec func="PFT:PftGzVchFromDb" error="IGNORE">
              <Args>
                <Arg name="MsgFmt" value="$MsgFmt"/>
                <Arg name="ClrDat" value="$ClrDat"/>
                <Arg name="SndCod" value="$SndCod"/>
                <Arg name="RcvCod" value="$RcvCod"/>
                <Arg name="ClrSce" value="$ClrSce"/>
                <Arg name="ActTyp" value="$ActTyp"/>
                <Arg name="ActNo"  value="$ActNo"/>
                <Arg name="FilNam" value="$FilNam"/>
                <Arg name="PrtDat" value="$ActDat"/>
              </Args>
            </Exec>
          </If>
          <Else>
	          <Set>RcvCod=001658100000</Set>
            <Exec func="PFT:PftVchFromDb" error="IGNORE">
              <Args>
                <Arg name="MsgFmt" value="$MsgFmt"/>
                <Arg name="ClrDat" value="$ClrDat"/>
                <Arg name="SndCod" value="$SndCod"/>
                <Arg name="RcvCod" value="$RcvCod"/>
                <Arg name="ClrSce" value="$ClrSce"/>
                <Arg name="ActTyp" value="$ActTyp"/>
                <Arg name="ActNo"  value="$ActNo"/>
                <Arg name="FilNam" value="$FilNam"/>
                <Arg name="PrtDat" value="$ActDat"/>
              </Args>
            </Exec>
          </Else>
          <If condition="INTCMP(~RetCod,4,0)">
            <Set>MsgTyp=E</Set>
            <Return/>
          </If>
          <Set>NodNo=$BakNod</Set>
          <Break/>
        </Case>
        <Case value="02">   <!--调帐凭证-->
          <Break/>
        </Case>
        <Case value="03"/>   <!--缴税资金划拨凭证-->
        <Case value="04"/>   <!--退库资金划拨凭证-->
        <Case value="05">   <!--退库凭证-->
          <If condition="IS_NOEQUAL_STRING($NodNo,$CtlNod)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=部门无此权限</Set>
            <Return/>
          </If>
          <Switch expression="$Func">
            <Case value="03">
	            <Set>MsgFmt=SEC202</Set>
	            <Set>FmtFil=STRCAT(etc/,PFT009_RPT,.XML)</Set>
	            <Set>FilNam=STRCAT(PFT009_,$ClrDat,_,$ClrSce,$BrNo,.RPT)</Set>
	            <Set>RptNam=STRCAT(【,$BrNo,】分行缴税资金划拨凭证)</Set>
		          <Break/>
		        </Case>
            <Case value="04">
	            <Set>MsgFmt=SEC203</Set>
	            <Set>FmtFil=STRCAT(etc/,PFT010_RPT,.XML)</Set>
	            <Set>FilNam=STRCAT(PFT010_,$ClrDat,_,$ClrSce,$BrNo,.RPT)</Set>
	            <Set>RptNam=STRCAT(【,$BrNo,】分行退库资金划拨凭证)</Set>
	            <Set>ClrSce=AMTDELZERO($ClrSce)</Set>
		          <Break/>
		        </Case>
            <Case value="05">
	            <Set>MsgFmt=SEC203</Set>
	            <Set>FmtFil=STRCAT(etc/,PFT103_RPT,.XML)</Set>
	            <Set>FilNam=STRCAT(PFT103_,$ClrDat,_,$ClrSce,$BrNo,.RPT)</Set>
	            <Set>RptNam=STRCAT(【,$BrNo,】分行退库凭证)</Set>
		          <Break/>
		        </Case>
					</Switch>
<!--
          <If condition="IS_EQUAL_STRING($Func,03)">
            <Set>FmtFil=STRCAT(etc/,PFT009_RPT,.XML)</Set>
            <Set>FilNam=STRCAT(PFT009_,$ClrDat,_,$ClrSce,$BrNo,.RPT)</Set>
            <Set>RptNam=STRCAT(【,$BrNo,】分行缴税资金划拨凭证)</Set>
          </If>
          <Else>
            <Set>MsgFmt=SEC203</Set>
            <Set>FmtFil=STRCAT(etc/,PFT010_RPT,.XML)</Set>
            <Set>FilNam=STRCAT(PFT010_,$ClrDat,_,$ClrSce,$BrNo,.RPT)</Set>
            <Set>RptNam=STRCAT(【,$BrNo,】分行退库资金划拨凭证)</Set>
            <Set>ClrSce=AMTDELZERO($ClrSce)</Set>
          </Else>
-->
          <Exec func="EXT:GenerateReport">
            <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
            <Arg name="RptFile" value="$FmtFil"/>
            <Arg name="RptNam"  value="$RptNam"/>
            <Arg name="MsgFmt"  value="$MsgFmt"/>
            <Arg name="ClrDat"  value="$ClrDat"/>
            <Arg name="ClrSce"  value="$ClrSce"/>
            <Arg name="BrNo"    value="$BrNo"/>
            <Arg name="NodNo"   value="$NodNo"/>
            <Arg name="TlrId"   value="$TlrId"/>
            <Arg name="PrtDat"  value="$ActDat"/>
          </Exec>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>
  
  <Transaction code="465907" desc="退库凭证明细浏览">
    <Quote name="PftSqlLst"/>
    <DynSentence name="QrySec203Sum">
      <Sentence>
        select BilSts, ActDat OActDat, TxnAmt, RcvAct, ActNo, TckNo, HRspCd, PftFil, TCrpCd, TActDt, TLogNo
          from PftSec203Sum446
         where ( ActNo='%s' or '%s'='' ) and ( ActDat between '%s' and '%s' ) and OpnBr='%s'
      </Sentence>
      <Fields>ActNo|ActNo|BegDat|EndDat|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="QrySec203Dtl">
      <Sentence>
        select DtlSeq, DtlAmt, LvlNam, TSubCd, TaxTyp
          from PftSec203Dtl446
         where PftFil='%s' and TCrpCd='%s' and TActDt='%s' and TLogNo='%s' order by DtlSeq
      </Sentence>
      <Fields>PftFil|TCrpCd|TActDt|TLogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitNoAccTran"/>
      <Switch expression="$Func">
        <Case value="1">
          <Exec  func="PUB:MultiQuery">
            <Args>
              <Arg name="SqlCmd" value="QrySec203Sum"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
        <Case value="2">
          <Exec  func="PUB:MultiQuery">
            <Args>
              <Arg name="SqlCmd" value="QrySec203Dtl"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>
  
  <Transaction code="465911" desc="佛山扣款通知交易">
    <Quote name="PftSqlLst"/>
    <DynSentence name="GetNewAct" desc="根据老账号获取新账号">
      <Sentence>
        select ActNo from SavOldAct where OldAct='%s'
      </Sentence>
      <Fields>RcvAct|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    
    <FlowCtrl>
<!--设置默认值-->
      <Set>RtnCod=3802</Set>
      <Set>NodNo=446800</Set>
<!--初始化-->
      <Quote name="GetBrInf"/>
      <Quote name="InitAccTran"/>
      <Quote name="GetBTxnID"/>
<!--协议检查-->
      <Quote name="JugCusAgt"/>
<!--判断根据接收行行号获取的分行号与协议中的归属分行号是否一致-->
      <If condition="IS_NOEQUAL_STRING($BrNo,$OpnBr)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=STRCAT(信息【,$TCrpCd,】【,$TActDt,】【,$TLogNo,】接收行号与协议不一致)</Set>
        <Set>RtnCod=3802</Set>
        <Quote name="SndRtnMsg"/>
        <Return/>
      </If>
      <Set>RecKey=STRCAT($BrNo,$AplCls,$TCrpCd,$TActDt,$TLogNo)</Set>
      <Exec func="PUB:Lock" error="IGNROE">
        <Arg name="RecKey" value="$RecKey"/>
        <Arg name="AutoUnlock" value="yes"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=STRCAT(信息【,$TCrpCd,】【,$TActDt,】【,$TLogNo,】处理尚未完成)</Set>
        <Set>RtnCod=3802</Set>
        <Quote name="SndRtnMsg"/>
        <Return/>
      </If>
<!--流水检查-->
      <Quote name="ChkTxnJnl"/>
<!--记帐控制-->
      <Exec func="PUB:GetLogNo"/>
      <Set>TxnCnl=PFT</Set>
      <Exec func="PUB:GetVirtualTeller"/>
      <Switch expression="$ActTyp">
        <Case value="0"> <!-- 普通对公 -->
          <Set>HTxnCd=451610</Set>
          <Set>BusTyp=FTT55</Set>
          <Set>CrpCod=PFT999999999</Set>
          <Set>ActFlg=2</Set>
          <Set>ActSqn=$Act01Sq</Set>
          <Set>ActNod=$CtlNod</Set>
          <Set>Smr=税款缴纳</Set>
          <Break/>
        </Case>
        <Case value="1"/> <!-- 一本通 -->
        <Case value="2"/> <!-- 普通存折 -->
        <Case value="4"> <!-- 太平洋卡 -->
          <Set>HTxnCd=471280</Set>
          <Set>BusTyp=FTT60</Set>
          <Set>CnlTyp=L</Set>
          <Set>ActFlg=$ActTyp</Set>
          <Set>Mask=9116</Set>
          <Set>TxnSub=010</Set>
          <Set>FeeSeq=$Act01Sq</Set>
          <Set>VchChk=0</Set>
          <Set>FeeCod=0011</Set>
          <Set>FeeBr=$CtlNod</Set>
          <Set>PrtFlg=0</Set>
          <Break/>
        </Case>
        <Case value="A"> <!-- 中央财政对公 -->
          <Set>HTxnCd=363412</Set>
          <Set>ObjSvr=STHDFAP2</Set>
          <Set>BrNam=@BCFG.BrNam</Set>
          <Set>EleBk=@BCFG.EleBk</Set>
          <Set>APVchN=$LogNo</Set>
          <Set>BLogNo=$LogNo</Set>  <!--保留原流水号-->
          <Set>PayCod=$SubCod</Set>
          <Set>FinAre=999</Set>
          <Set>ActNam=$ActNam</Set>
          <Set>ANodNm=@BCFG.BrNam</Set>
          <Set>PyeAct=$Act01</Set>
          <Set>PyeNam=税务征收机关</Set>
          <Set>PyeBk=国库所在银行</Set>
          <Set>UdwDat=$ActDat</Set>
          <Set>ActSqn=$Act01Sq</Set>
          <Set>ActNod=$CtlNod</Set>
          <Set>StlMod=07</Set>
          <Set>AthAmt=$TxnAmt</Set>
          <Set>VInTlr=$TlrId</Set>
          <Set>VRgNod=$CtlNod</Set>
          <Set>HSubCd=002</Set>
          <Break/>
        </Case>
        <Case value="B"> <!-- 广东省财政对公 -->
          <Set>HTxnCd=461181</Set>
          <Set>ObjSvr=STDEPFT1</Set>
          <Set>PayAct=$ActNo</Set>
          <Set>PayNam=$ActNam</Set>
          <Set>PayBNm=@BCFG.BrNam</Set>
          <Set>PyeAct=$Act01</Set>
          <Set>PyeNam=待结转财政款项</Set>
          <Set>PyeBNm=@BCFG.BrNam</Set>
          <Set>VchDat=$ActDat</Set>
          <Set>VchSmr=税款缴纳</Set>
          <Set>ActSqn=$Act01Sq</Set>
          <Set>ActNod=$CtlNod</Set>
          <Set>HSubCd=002</Set>
          <Break/>
        </Case>
        <Default>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="$RecKey"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFT999</Set>
          <Set>RspMsg=系统错误</Set>
          <Set>RtnCod=3802</Set>
          <Quote name="SndRtnMsg"/>
          <Return/>
        </Default>
      </Switch>
      <Set>BilSts=U</Set>
      <Set>OIFlag=1</Set>
      <Set>TxnTyp=N</Set>
      <Exec func="PUB:InsertRecord">
        <Arg name="TblNam" value="PftTxnJnl446"/>
      </Exec>
      <If condition="OR(IS_EQUAL_STRING($ActTyp,A),IS_EQUAL_STRING($ActTyp,B))">  <!--财政账户转发相关财政系统-->
        <Set>TOIFlg=O</Set>  <!--财政往来支出标志-->
        <Exec func="PUB:CallThirdOther" error="IGNORE">
          <Arg name="TxnCod" value="$HTxnCd"/>
          <Arg name="ObjSvr" value="$ObjSvr"/>
        </Exec>
      </If>
      <Else>
        <Exec func="PUB:CallHostAcc" error="IGNORE">
          <Arg name="TxnCod" value="$HTxnCd"/>
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </Else>
      <Switch expression="~RetCod">
        <Case value="-1">  <!--上送主机超时-->
          <Set>BilSts=T</Set>
          <Set>RtnCod=3802</Set>
          <Break/>
        </Case>
        <Case value="0"> <!--交易成功-->
          <Set>BilSts=S</Set>
          <Set>RtnCod=0000</Set>
          <Break/>
        </Case>
        <Default>
          <Set>BilSts=F</Set>
          <Set>RspCod=$HRspCd</Set>
          <Delete>TckNo</Delete>
          <Exec func="PUB:CodeSwitching" error="IGNORE">
            <Arg name="DatSrc"  value="PFTCSW"/>
            <Arg name="SourNam" value="RspCod"/>
            <Arg name="DestNam" value="RtnCod"/>
            <Arg name="TblNam"  value="RspCodToRtnCod"/>
          </Exec>
          <Break/>
        </Default>
      </Switch>
<!--避免由于主机异常造成Update失败,而导致主机成功、返回失败的情况发生，?
    若发生Update失败的情况，通过日终对帐发现-->
      <If condition="IS_EQUAL_STRING($ActTyp,A)">  <!--中央财政账户需要将BLogNo替换回LOGNO、并将总行LogNo存放HLogNo-->
        <Set>PLogNo=$LogNo</Set>
        <Set>LogNo=$BLogNo</Set>
      </If>
      <Exec func="PUB:UpdateRecord" error="IGNORE">
        <Arg name="TblNam" value="PftTxnJnl446"/>
        <Arg name="CndSts" value="UpdTxnJnl"/>
      </Exec>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="$RecKey"/>
      </Exec>
      <Quote name="SndRtnMsg"/>
    </FlowCtrl>
  </Transaction> 
  
  <Transaction code="465912" desc="佛山扣款冲正交易">
    <Quote name="PftSqlLst"/>
    <Attributes>
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
<!--冲正原则，对于所有记帐超时且无法明确状态的交易均不做冲正处理-->
<!--设置默认值-->
      <Set>@MSG.FLG=1</Set>
      <Set>RtnCod=3802</Set>
      <Quote name="GetBrInf"/>
      <Quote name="GetBTxnID"/>
<!--初始化-->
      <Quote name="InitAccTran"/>
<!--通过加锁避免并发-->
      <Set>RecKey=STRCAT($BrNo,$AplCls,$TCrpCd,$OTActDt,$OTLogNo)</Set>
      <Exec func="PUB:Lock" error="IGNROE">
        <Arg name="RecKey" value="$RecKey"/>
        <Arg name="AutoUnlock" value="yes"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=STRCAT(信息【,$TCrpCd,】【,$OTActDt,】【,$OTLogNo,】冲正处理尚未完成)</Set>
        <Set>RtnCod=3802</Set>
        <Quote name="SndRtnMsg"/>
        <Return/>
      </If>
<!--查询原扣款交易流水、判断原扣款交易流水的状态-->
      <Quote name="ChkBokJnl"/>
<!--若为非同一会计日期或个人业务(ActTyp为1,2,4)，则需要判断冲正流水的状态-->
      <If condition="OR(IS_NOEQUAL_STRING($OActDat,$ActDat),IS_EQUAL_STRING($ActTyp,1),IS_EQUAL_STRING($ActTyp,2),IS_EQUAL_STRING($ActTyp,4))">
        <Quote name="ChkCanJnl"/>
      </If>
<!--根据不同情况选择冲正方式-->
      <If condition="IS_EQUAL_STRING($ActDat,$OActDat)">   <!--当日交易-->
        <Quote name="CanCurTxn"/>
      </If>
      <Else>   <!--隔日交易-->
        <Quote name="CanPreTxn"/>
      </Else>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="$RecKey"/>
      </Exec>
      <Quote name="SndRtnMsg"/>
    </FlowCtrl>
  </Transaction> 
  
  <Transaction code="465913" desc="纳税人帐户是否足额和有效查询信息">
  	<Quote name="PftSqlLst"/>
	  <Attributes>
      <Attribute name="noresponse" value="1"/>
    </Attributes> 
    <FlowCtrl>
    	<Set>RtnCod=3802</Set>
    	<Quote name="GetBrInf"/>
    	<Quote name="InitNoAccTran"/>	<!--非帐务类交易初始化-->
    	<Quote name="GetBTxnID"/>     <!--取银行交易识别号-->
      <Quote name="JugActInf"/>			<!--检查账号信息-->
      <Set>TxnCnl=PFT</Set>
      <Exec func="PUB:GetVirtualTeller" error="IGNORE"/>
    	<Switch expression="$ActCls">
    		<Case	value="0">						<!--对公帐户-->
    			 <Exec func="PUB:CallHostOther" error="IGNORE">
        	 	<Args>
          		<Arg name="HTxCd"   value="109000" />
            	<Arg name="ObjSvr" value="SHSTPUB1" />
        	 	</Args>
        	 </Exec>
        	 <If condition="$MsgTyp!=N">
        	 	<Exec func="PUB:CodeSwitching" error="IGNORE">
        	 		<Set>RspCod=$HRspCd</Set>
            	<Arg name="DatSrc"  value="PFTCSW"/>
            	<Arg name="SourNam" value="RspCod"/>
            	<Arg name="DestNam" value="RtnCod"/>
            	<Arg name="TblNam"  value="RspCodToRtnCod"/>
          	</Exec>
        	 </If>
        	 <ElseIf condition="INTCMP($AvaBal,1,$TxnAmt)">		<!--可用余额小于交易金额-->
        	  <Set>MsgTyp=E</Set>
        		<Set>RspCod=PFT999</Set>
        		<Set>RspMsg=可用余额不足</Set>
        		<Set>RtnCod=3001</Set>
        	 </ElseIf>
        	 <Else>
        	 	<Set>RtnCod=0000</Set>    	 	
        	 </Else>
        	 <Break/>
    		</Case>
    		<Case value="2"/>			<!--普通帐户-->
    		<Case value="3">			<!--卡-->
    			<If condition="INTCMP($ActCls,3,2)">
    				<Set>ActTyp=2</Set>
    			</If>
    			<Else>
    				<Set>ActTyp=4</Set>
    			</Else>
       		<Set>CcyCod=CNY</Set>
       		<Exec func="PUB:CallHostOther" error="IGNORE">
         		<Arg name="HTxnCd" value="476520"/>
         		<Arg name="ObjSvr" value="SHSTPUB1"/>
       		</Exec>
       	  <If condition="$MsgTyp!=N">
        	 	<Exec func="PUB:CodeSwitching" error="IGNORE">
        	 		<Set>RspCod=$HRspCd</Set>
            	<Arg name="DatSrc"  value="PFTCSW"/>
            	<Arg name="SourNam" value="RspCod"/>
            	<Arg name="DestNam" value="RtnCod"/>
            	<Arg name="TblNam"  value="RspCodToRtnCod"/>
          	</Exec>
        	 </If>
        	 <ElseIf condition="INTCMP($Bal,1,$TxnAmt)">		<!--可用余额小于交易金额-->
         	  <Set>MsgTyp=E</Set>
        		<Set>RspCod=PFT999</Set>
        		<Set>RspMsg=余额不足</Set>
        		<Set>RtnCod=3001</Set>
        	 </ElseIf>
        	 <Else>
        	 	<Set>RtnCod=0000</Set>    	 	
        	 </Else>
        	 <Break/>	
    		</Case>
    		<Default>
        	<Set>MsgTyp=E</Set>
        	<Set>RspCod=PFT999</Set>
        	<Set>RspMsg=帐户标志错</Set>
    			<Set>RtnCod=3802</Set>
    		</Default>
    	</Switch>
    	<Quote name="SndRtnMsg"/>        	 	
    	<Return/>
    </FlowCtrl>
	</Transaction>
	
  <Transaction code="465921" desc="日终清算申请">
    <Quote name="PftSqlLst"/>
    <DynSentence name="TimOutJnl">   <!--获取异常扣款流水-->
      <Sentence>
        select LogNo OLogNo  from PftTxnJnl446 where ClrDat='%s' and ClrSce='%s' and ActDat='%s' and BilSts in ( 'U', 'T' ) and MsgFmt='SEC202'
      </Sentence>
      <Fields>ClrDat|ClrSce|ActDat|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitNoAccTran"/>
      <Set>BnkCls=0</Set>
      <Quote name="GetBnkInf"/>
      <If condition="IS_NOEQUAL_STRING($NodNo,$CtlNod)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Switch expression="$Func">
        <Case value="1">  <!--对数查询申请-->
<!--遍历流水表，将所有状态未明的交易，通过查询交易确定状态-->
          <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="sql" value="TimOutJnl"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
              <Break/>
            </If>
            <Exec func="PUB:CallHostOther" error="IGNORE">
              <Arg name="HTxnCd" value="458980"/>
              <Arg name="ObjSvr" value="SHSTPUB1"/>
            </Exec>
            <If condition="AND(IS_EQUAL_STRING($MsgTyp,N),IS_NOEQUAL_STRING($CrcSts,Y))">
              <Set>BilSts=S</Set>
              <Set>TckNo=DELSPACE($OTckNo,both)</Set>
              <Set>HTxnSt=S</Set>
              <Set>HRspCd=SC0000</Set>
              <Set>RtnCod=0000</Set>
            </If>
            <Else>
              <Set>BilSts=F</Set>
              <Set>TckNo= </Set>
              <Set>HTxnSt=F</Set>
              <Set>HRspCd=PFT999</Set>
              <Set>RtnCod=3802</Set>
            </Else>
            <Exec func="PUB:UpdateRecord">
              <Arg name="TblNam" value="PftTxnJnl446"/>
              <Arg name="CndSts" value="UpdTxnJnl"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>
          </While>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
<!--发中心申请明细-->
          <Set>MsgFmt=SEQ201</Set>
          <Set>TxnDat=$ActDat</Set>
          <Set>QryTyp=1</Set>
          <Set>TTxnTp=1</Set>
          <Set>@MSG.FLG=1</Set>
          <Quote name="GetBTxnID"/>
          <Exec func="PUB:CallThirdOther">
            <Arg name="TxnCod" value="SEQ201"/>
            <Arg name="ObjSvr" value="CTDEPFT1"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="2">  <!--成功扣款明细申请-->
          <Set>ApyFil=STRCAT(SEC202,_,$BnkCod,.,$ClrDat)</Set>	<!--申请文件名-->
          <Quote name="ApplyFile"/>						<!--发出文件申请-->
          <Break/>
        </Case>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction> 
  
  <Transaction code="465922" desc="日终对帐申请返回">
    <DynSentence name="DelChkTot">   <!--清理成功扣款明细汇总信息-->
      <Sentence>
        delete from PftChkTot446 where BnkCod='%s' and ClrDat='%s' and ClrSce='%s' and TTxnTp='%s'
      </Sentence>
      <Fields>BnkCod|ClrDat|ClrSce|TTxnTp|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="noresponse" value="1"/>
    </Attributes>
    <FlowCtrl>
<!--清理已读入明细，提供重复查询-->
      <Exec func="PUB:ExecSql" error="IGNROE">
        <Args>
          <Arg name="SqlCmd" value="DelChkTot"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,3,-1)">
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=数据库处理失败</Set>
        <Return/>
      </If>
      <Set>ThdChk=0</Set>
      <Exec func="PUB:InsertRecord" error="IGNORE">
        <Arg name="TblNam" value="PftChkTot446"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,0)">
        <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Return/>
      </If>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465923" desc="交易明细文件接收交易">  <!--对账、退库-->
    <Quote name="PftSqlLst"/>
    <DynSentence name="DelSec202Sum">   <!--清理成功扣款明细汇总信息-->
      <Sentence>
        delete from PftSec202Sum446 where MsgFmt='%s' and ClrDat='%s' and SndCod='%s' and RcvCod='%s' and ClrSce='%s'
      </Sentence>
      <Fields>MsgFmt|ClrDat|SndCod|RcvCod|ClrSce|</Fields>
    </DynSentence>
    <DynSentence name="DelSec202Dtl">   <!--清理成功扣款明细凭证信息-->
      <Sentence>
        delete from PftSec202Dtl446 where MsgFmt='%s' and ClrDat='%s' and SndCod='%s' and RcvCod='%s' and ClrSce='%s'
      </Sentence>
      <Fields>MsgFmt|ClrDat|SndCod|RcvCod|ClrSce|</Fields>
    </DynSentence>
    <DynSentence name="GetCrpInf">   <!--根据征收机关号获取其他信息-->                            
      <Sentence>                                                                                  
        select TCrpNm, FskNam, AgtBNm from PftCrpInf446 where TCrpTp=substr('%s',1,1) and TCrpCd='%s'
      </Sentence>                                                                                   
      <Fields>TCrpCd|TCrpCd|</Fields>                                                                
    </DynSentence>
    <DynSentence name="GetJnlInf">   <!--根据银行识别号获取其他信息-->                        
    	<Sentence>                                                                          
     		select TCrpCd, TLogNo, ActTyp, ActNo, ActNam, AgtInf from PftTxnJnl446 where BTxnId='%s'
   		</Sentence>                                                                            
   		<Fields>BTxnId|</Fields>  
   </DynSentence>
   <DynSentence name="GetActInf">      <!--根据银行账户获取账户资料-->
   	<Sentence>
   		select ActNam, ActTyp, OpnNod, OpnBr from PftCusAgt446 where AgtInf='%s' and ActNo='%s'
   	</Sentence>                                                                  
   		<Fields>AgtInf|ActNo|</Fields>                                                                                                                                                                                                               
    </DynSentence>
    <DynSentence name="GetNodNam">       <!--根据银行行号获取行名-->
      <Sentence>
        select smr RcvBNm from PubOrgInf where NodNo='%s'
      </Sentence>
      <Fields>OpnNod|</Fields>
    </DynSentence>
    <FlowCtrl>
    	<Set>SndCod=000000000000</Set>
    	<Set>ClrSce=0001</Set>
      <If condition="IS_NOEQUAL_STRING($ImCod,login)">
        <Set>FilNam=@MSG.FHN</Set>
        <Set>FilSiz=@MSG.FHL</Set>
        <Set>SrcFil=STRCAT(GETENV(WORKDIR),/,$IcsRcvDir,$FilNam)</Set>
        <Set>MsgFmt=SUBSTR($FilNam,1,6)</Set>      <!--信息格式码-->
        <Set>RcvCod=SUBSTR($FilNam,8,8)</Set>      <!--直接参与行行号-->
        <Set>FHEAD=STRCAT(FS,$MsgFmt,HEAD)</Set>
        <Set>FBODY=STRCAT(FS,$MsgFmt,BODY)</Set>
        <Switch expression="$MsgFmt"> 
        	<Case value="SEC202"> 	<!--对账-->
        		<Set>ClrDat=SUBSTR($FilNam,17,8)</Set>   <!--清算日期-->
        		<Break/>
        	</Case>
        	<Case value="SEC203"/>	<!--退库-->
        	<Case value="SEC204">		<!--退库退回-->
          	<Set>ClrSce=SUBSTR($FilNam,17,4)</Set>	 <!--场次，现固定值0001-->
          	<Set>ClrDat=SUBSTR($FilNam,22,8)</Set>   <!--清算日期-->
          	<Break/>
        	</Case>
        </Switch>
      </If>
      <Switch expression="$ImCod">
        <Case value="login">  <!--登陆请求接收-->
          <Set>@MSG.SNC=1</Set>
          <Break/>
        </Case>
        <Case value="shead">  <!--文件名、文件长度接收-->
<!--清理历史文件和数据库历史资料，提供重复读入功能-->
          <Exec func="PUB:DeleteFile" error="IGNORE">
            <Arg name="FilNam" value="$SrcFil"/>
          </Exec>
          <Exec func="PUB:DeleteFile" error="IGNORE">
            <Arg name="FilNam" value="$DesFil"/>
          </Exec>
          <Switch expression="$MsgFmt">
            <Case value="SEC202">		<!--清理数据库:成功扣款明细对数-->
              <Exec func="PUB:ExecSql" error="IGNROE">
                <Args>
                  <Arg name="SqlCmd" value="DelSec202Sum"/>
                </Args>
              </Exec>
              <If condition="INTCMP(~RetCod,3,-1)">
                <Set>@MSG.SNC=0</Set>
                <Set>ImCod=sndak</Set>
                <Set>ImBod=4008</Set>
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=清理数据表【PftSec202Sum】失败</Set>
                <Return/>
              </If>
              <Exec func="PUB:ExecSql" error="IGNROE">
                <Args>
                  <Arg name="SqlCmd" value="DelSec202Dtl"/>
                </Args>
              </Exec>
              <If condition="INTCMP(~RetCod,3,-1)">
                <Set>@MSG.SNC=0</Set>
                <Set>ImCod=sndak</Set>
                <Set>ImBod=4008</Set>
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=清理数据表【PftSec202Dtl446】失败</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Case value="SEC203">		<!--清理数据库:退库处理结果明细-->
              <Exec func="PUB:ExecSql" error="IGNROE">
                <Args>
                  <Arg name="SqlCmd" value="DelSec203Sum"/>
                </Args>
              </Exec>
              <If condition="INTCMP(~RetCod,3,-1)">
                <Set>@MSG.SNC=0</Set>
                <Set>ImCod=sndak</Set>
                <Set>ImBod=4008</Set>
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=清理数据表【PftSec203Sum446】失败</Set>
                <Return/>
              </If>
              <Exec func="PUB:ExecSql" error="IGNROE">
                <Args>
                  <Arg name="SqlCmd" value="DelSec203Dtl"/>
                </Args>
              </Exec>
              <If condition="INTCMP(~RetCod,3,-1)">
                <Set>@MSG.SNC=0</Set>
                <Set>ImCod=sndak</Set>
                <Set>ImBod=4008</Set>
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=清理数据表【PftSec203Dtl446】失败</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Case value="SEC204">		<!--清理数据库:退库退回处理结果明细-->
              <Exec func="PUB:ExecSql" error="IGNROE">
                <Args>
                  <Arg name="SqlCmd" value="DelSec204Sum"/>
                </Args>
              </Exec>
              <If condition="INTCMP(~RetCod,3,-1)">
                <Set>@MSG.SNC=0</Set>
                <Set>ImCod=sndak</Set>
                <Set>ImBod=4008</Set>
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=清理数据表【PftSec203Sum】失败</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
          </Switch>
<!--@MSG.SNC!=0 表示有后续交易(ICS标准)-->
          <Set>@MSG.SNC=1</Set>
          <Break/>
        </Case>
        <Case value="sfile">  <!--文件数据接收-->
          <Set>@MSG.SNC=1</Set>
          <Break/>
        </Case>
        <Case value="sover">  <!--文件数据接收完毕-->
<!--文件解压处理、同时判断文件大小是否合法-->
          <Set>DesFil=STRCAT($SrcFil,.dat)</Set>		 <!--解压后的文件-->
          <Exec func="PUB:CallThirdOther" error="IGNORE"> 
            <Arg name="HTxnCd"  value="465923"/>
            <Arg name="ObjSvr"   value="STDEPFT3"/>
          </Exec>
          <If condition="INTCMP(~RetCod,3,-1)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=明细文件解压超时，请稍后重做交易</Set>
            <Return/>
          </If>
          <If condition="IS_NOEQUAL_STRING($TRspCd,000000)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=数据文件解压失败</Set>
            <Return/>
          </If>
<!--文件入库处理-->
<!--设置计数变量，用于判断是否是文件首行-->
          <Set>cnt=0</Set>
          <Exec func="PUB:OpenFile">
            <Arg name="FileName"   value="$DesFil"/>
            <Arg name="Mode"       value="r"/>
            <Arg name="ObjectName" value="FilPnt"/>
          </Exec>
          <Exec func="PUB:InitDataParser">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
          </Exec>
          <While>
            <If condition="INTCMP($cnt,3,0)">   <!--第一行-->
              <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
                <Arg name="ConfigName" value="BatFormat"/>
                <Arg name="RootName"   value="BATCH"/>
                <Arg name="NodeName"   value="Process"/>
                <Arg name="AttrName"   value="name"/>
                <Arg name="AttrValue"  value="$FHEAD"/>
                <Arg name="MaxLen"     value="512"/>
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <If condition="INTCMP(~RetCod,3,-1)">   <!--解析失败返回-->
                <Exec func="PUB:CloseFile">
                  <Arg name="ObjectName" value="FilPnt"/>
                </Exec>
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Set>@MSG.SNC=0</Set>
                <Set>ImCod=sndak</Set>
                <Set>ImBod=4008</Set>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=STRCAT(解析批量包明细文件【,$FilNam,】文件头失败)</Set>
                <Return/>
              </If>
              <If condition="OR(INTCMP(~RetCod,3,1),INTCMP($TotNum,3,0))">   <!--文件结束或笔数为零-->
                <Exec func="PUB:CloseFile">
                  <Arg name="ObjectName" value="FilPnt"/>
                </Exec>
                <Break/>
              </If>
            </If>
            <Else>   <!--明细数据行-->
	            <Delete>FilSeq</Delete>
              <Delete>RcvBNo</Delete>
              <Delete>ActDat</Delete>
              <Delete>BTxnID</Delete>
              <Delete>TTxnTp</Delete>
              <Delete>SndAct</Delete>
              <Delete>RcvAct</Delete>
              <Delete>ActNo</Delete>
              <Delete>TxnAmt</Delete>
              <Delete>PrtFlg</Delete>
              <Delete>ActInf</Delete>
              <Delete>TaxNam</Delete>
              <Delete>CrpKnd</Delete>
              <Delete>TCrpNm</Delete>
              <Delete>TLogNo</Delete>
              <Delete>FskNam</Delete>
              <Delete>Smr</Delete>
              <Delete>DtlNum</Delete>
              <Delete>DtlMac</Delete>
              <Delete>OpnNod</Delete>
              <Delete>OpnBr</Delete>
              <Exec func="PUB:DeleteGroup">
                <Arg name="GroupName" value="VchDtl"/>
              </Exec>

              <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
                <Arg name="ConfigName" value="BatFormat"/>
                <Arg name="RootName"   value="BATCH"/>
                <Arg name="NodeName"   value="Process"/>
                <Arg name="AttrName"   value="name"/>
                <Arg name="AttrValue"  value="$FBODY"/>
                <Arg name="MaxLen"     value="10240"/>
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <If condition="INTCMP(~RetCod,3,-1)">   <!--解析失败返回-->
                <Exec func="PUB:CloseFile">
                  <Arg name="ObjectName" value="FilPnt"/>
                </Exec>
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Set>@MSG.SNC=0</Set>
                <Set>ImCod=sndak</Set>
                <Set>ImBod=4008</Set>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=STRCAT(解析批量包明细文件【,$FilNam,】文件体失败)</Set>
                <Return/>
              </If>
              <If condition="~RetCod=1">
                <Exec func="PUB:CloseFile">
                  <Arg name="ObjectName" value="FilPnt"/>
                </Exec>
                <Break/>
              </If>
              <Switch expression="$MsgFmt">
                <Case value="SEC202">  <!--成功扣款明细对数-->
                <!--根据"银行交易识别号(BTxnId)取流水( TCrpCd,TLogNo,ActNo,ActNam, AgtInf )-->
        				<Exec func="PUB:ReadRecord" error="IGNORE">
          				<Args>
            				<Arg name="SqlCmd" value="GetJnlInf"/>
          				</Args>
        				</Exec>
<!--根据协议号和付款账户获取对应的ActTyp, NodNo,BrNo供查询、打印使用，默认为帐务中心-->
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                    <Args>
                      <Arg name="SqlCmd" value="GetActInf"/>
                    </Args>
                  </Exec>
                  <If condition="~RetCod!=0">
                    <Set>ActTyp= </Set>
                    <Set>OpnNod=@BCFG.ANodNo</Set>
                    <Set>OpnBr=@BCFG.BrNo</Set>
                  </If>
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                    <Args>
                      <Arg name="SqlCmd" value="GetNodNam"/>
                    </Args>
                  </Exec>
                  <Exec func="PUB:ReadRecord" error="IGNORE">
          					<Args>
            					<Arg name="SqlCmd" value="GetCrpInf"/>
          					</Args>
        					</Exec>
        
                  <Exec func="PUB:InsertRecord" error="IGNORE">  <!--缴税凭证对帐汇总表-->
                    <Arg name="TblNam" value="PftSec202Sum446"/>
                  </Exec>
                  <If condition="INTCMP(~RetCod,4,0)">
                    <Exec func="PUB:CloseFile">
                      <Arg name="ObjectName" value="FilPnt"/>
                    </Exec>
                    <Exec func="PUB:RollbackWork" error="IGNORE"/>
                    <Set>@MSG.SNC=0</Set>
                    <Set>ImCod=sndak</Set>
                    <Set>ImBod=4008</Set>
                    <Set>MsgTyp=E</Set>
                    <Set>RspCod=PFT999</Set>
                    <Set>RspMsg=登记缴税凭证明汇总表【PftSec202Sum】失败</Set>
                    <Return/>
                  </If>

                  <Exec func="PUB:InsertRecord" error="IGNORE">     <!--缴税凭证对帐明细表-->
                    <Arg name="TblNam" value="PftSec202Dtl446"/>
                    <Arg name="GrpNam" value="VchDtl"/>
                    <Arg name="FldLst" value="MsgFmt|ClrDat|SndCod|RcvCod|ClrSce|FilSeq|"/>
                  </Exec>
                  <If condition="INTCMP(~RetCod,4,0)">
                    <Exec func="PUB:CloseFile">
                      <Arg name="ObjectName" value="FilPnt"/>
                    </Exec>
                    <Exec func="PUB:RollbackWork" error="IGNORE"/>
                    <Set>@MSG.SNC=0</Set>
                    <Set>ImCod=sndak</Set>
                    <Set>ImBod=4008</Set>
                    <Set>MsgTyp=E</Set>
                    <Set>RspCod=PFT999</Set>
                    <Set>RspMsg=登记缴税凭证明细表表【PftSec202Dtl】失败</Set>
                    <Return/>
                  </If>
                  <Break/>
                </Case>
              </Switch>
            </Else>
            <Set>cnt=ADD($cnt,1)</Set>
          </While>
<!--处理结束-->
          <Set>@MSG.SNC=0</Set>
          <Break/>
        </Case>
      </Switch>
      <Set>ImCod=sdack</Set>
      <Set>KpCol=XXXX</Set>
      <Set>ImBod=0000</Set>
      <Set>ImLen=ADDCHAR(STRLEN($ImBod),8,0,1)</Set>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465924" desc="日终对帐处理">
    <Quote name="PftSqlLst"/>
    <DynSentence name="GetVchSum">   <!--获取成功扣款流水-->
      <Sentence>
        select OIFLag, ActDat TxnDat, BTxnID, RcvAct, TxnAmt, TaxNam, TLogNo, OpnBr TxnBr
          from PftSec202Sum
         where MsgFmt='%s' and ClrDat='%s' and ClrSce='%s'
      </Sentence>
      <Fields>MsgFmt|ClrDat|ClrSce|</Fields>
    </DynSentence>
    <DynSentence name="GetChkJnl">   <!--获取对帐扣款流水-->
      <Sentence>
        select BilSts, OIFlag, ActDat TxnDat, TxnAmt, ActNo, ActNam TaxNam, TckNo, BrNo TxnBr, TLogNo
          from PftTxnJnl446
         where MsgFmt='SET202' and ClrDat='%s' and ClrSce='%s' and ( BTxnID='%s' or '%s'=' ' ) and ThdChk='0'
      </Sentence>
      <Fields>ClrDat|IntSce|BTxnId|BTxnId|</Fields>
    </DynSentence>
    <DynSentence name="UpdJnlThdChk">   <!--更新流水的对帐状态-->
      <Sentence>
        update PftTxnJnl446 Set ThdChk='%s' where MsgFmt='SET202' and ClrDat='%s' and ClrSce='%s' and ( BTxnID='%s' or '%s'=' ' )
      </Sentence>
      <Fields>ThdChk|ClrDat|IntSce|BTxnID|BTxnID|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Quote name="InitNoAccTran"/>
      <Set>BnkCls=0</Set>
      <Quote name="GetBnkInf"/>
      <If condition="IS_NOEQUAL_STRING($NodNo,$CtlNod)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=部门无此权限</Set>
        <Return/>
      </If>
      <Set>IntSce=AMTDELZERO($ClrSce)</Set>
      <Switch expression="$Func">
        <Case value="01">   <!--明细对帐-->
<!--1、更新对帐标志为未对帐-->
          <Set>ThdChk=0</Set>
          <Set>BTxnId= </Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="sql" value="UpdJnlThdChk"/>
          </Exec>
          <If condition="INTCMP(~RetCod,3,-1)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=更新日间交易流水表失败</Set>
            <Return/>
          </If>
<!--对帐准备：报表格式、报表名、数据文件名-->
          <Set>FmtFil=STRCAT(etc/,PFT001_RPT,.XML)</Set>
          <Set>RptFil=STRCAT(PFT001_,$ClrDat,_,$ClrSce,.RPT)</Set>
          <Set>DatFil=STRCAT($RptDir,$RptFil,.data)</Set>
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$DatFil"/>
            <Arg name="OpenMode" value="w"/>
            <Arg name="Data"     value="[1]:RptHead=对帐差错报表"/> 
            <Arg name="Data"     value="|"/>
            <Arg name="ESCFMT"   value="\\n"/>
            <Arg name="Data"     value="[2]:ClrDat="/> 
            <Arg name="Data"     value="$ClrDat"/> 
            <Arg name="Data"     value="|"/>
            <Arg name="Data"     value="ClrSce="/> 
            <Arg name="Data"     value="$ClrSce"/> 
            <Arg name="Data"     value="|"/>
            <Arg name="ESCFMT"   value="\\n"/>
          </Exec>
          <Set>Flag=0</Set>
          <Set>ThdChk=1</Set>
<!--2、根据中心明细确认是否存在中心有而行内系统无的交易-->
          <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="sql" value="GetVchSum"/>
            <Arg name="CursorName" value="Cursor1"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
          <While>
            <Delete>TxnDat</Delete>
            <Delete>BTxnID</Delete>
            <Delete>RcvAct</Delete>
            <Delete>TxnAmt</Delete>
            <Delete>TaxNam</Delete>
            <Delete>TLogNo</Delete>
            <Delete>TxnBr</Delete>
            <Delete>BilSts</Delete>
            <Delete>OIFlag</Delete>
            <Delete>TckNo</Delete>
            <Exec func="PUB:FetchCursor" error="IGNORE">
              <Arg name="CursorName" value="Cursor1"/>
            </Exec>
            <If condition="~RetCod=100">
              <Break/>
            </If>
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="GetChkJnl"/>
              </Args>
            </Exec>
            <Switch expression="~RetCod">
              <Case value="-1"> <!-- 系统错误 -->
                <Exec func="PUB:RollbackWork" error="IGNORE"/>
                <Exec func="PUB:CloseCursor" error="IGNORE">
                  <Arg name="CursorName" value="Cursor1"/>
                </Exec>
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=查询日间交易流水表失败</Set>
                <Return/>
              </Case>
              <Case value="-2"> <!-- 中心有行内无 -->
                <Exec func="PUB:WriteFile" error="IGNORE">
                  <Arg name="FileName" value="$DatFil"/>
                  <Arg name="OpenMode" value="a+"/>
                  <Arg name="Data"     value="[3]:TxnBr="/>
                  <Arg name="Data"     value="$TxnBr"/>
                  <Arg name="Data"     value="|"/>
                  <Arg name="Data"     value="TxnDat="/>
                  <Arg name="Data"     value="$TxnDat"/>
                  <Arg name="Data"     value="|"/>
                  <Arg name="Data"     value="OIFlag="/>
                  <Arg name="Data"     value="$OIFlag"/>
                  <Arg name="Data"     value="|"/>
                  <Arg name="Data"     value="TLogNo="/>
                  <Arg name="Data"     value="$TLogNo"/>
                  <Arg name="Data"     value="|"/>
                  <Arg name="Data"     value="RcvAct="/>
                  <Arg name="Data"     value="$RcvAct"/>
                  <Arg name="Data"     value="|"/>
                  <Arg name="Data"     value="TxnAmt="/>
                  <Arg name="Data"     value="$TxnAmt"/>
                  <Arg name="Data"     value="|"/>
                  <Arg name="Data"     value="TckNo="/>
                  <Arg name="Data"     value="$TckNo"/>
                  <Arg name="Data"     value="|"/>
                  <Arg name="Data"     value="BilSts="/>
                  <Arg name="Data"     value="$BilSts"/>
                  <Arg name="Data"     value="|"/>
                  <Arg name="Data"     value="TBilSt="/>
                  <Arg name="Data"     value="中心成功"/>
                  <Arg name="Data"     value="|"/>
                  <Arg name="ESCFMT"   value="\\n"/>
                </Exec>
                <Set>Flag=1</Set>
                <Break/>
              </Case>
              <Case value="0"> <!-- 中心成功行内状态异常 -->
                <If condition="IS_NOEQUAL_STRING($BilSts,S)">
                  <Exec func="PUB:WriteFile" error="IGNORE">
                    <Arg name="FileName" value="$DatFil"/>
                    <Arg name="OpenMode" value="a+"/>
                    <Arg name="Data"     value="[3]:TxnBr="/>
                    <Arg name="Data"     value="$TxnBr"/>
                    <Arg name="Data"     value="|"/>
                    <Arg name="Data"     value="TxnDat="/>
                    <Arg name="Data"     value="$TxnDat"/>
                    <Arg name="Data"     value="|"/>
                    <Arg name="Data"     value="OIFlag="/>
                    <Arg name="Data"     value="$OIFlag"/>
                    <Arg name="Data"     value="|"/>
                    <Arg name="Data"     value="RcvAct="/>
                    <Arg name="Data"     value="$RcvAct"/>
                    <Arg name="Data"     value="|"/>
                    <Arg name="Data"     value="TxnAmt="/>
                    <Arg name="Data"     value="$TxnAmt"/>
                    <Arg name="Data"     value="|"/>
                    <Arg name="Data"     value="TLogNo="/>
                    <Arg name="Data"     value="$TLogNo"/>
                    <Arg name="Data"     value="|"/>
                    <Arg name="Data"     value="TckNo="/>
                    <Arg name="Data"     value="$TckNo"/>
                    <Arg name="Data"     value="|"/>
                    <Arg name="Data"     value="BilSts="/>
                    <Arg name="Data"     value="$BilSts"/>
                    <Arg name="Data"     value="|"/>
                    <Arg name="Data"     value="TBilSt="/>
                    <Arg name="Data"     value="中心成功"/>
                    <Arg name="Data"     value="|"/>
                    <Arg name="ESCFMT"   value="\\n"/>
                  </Exec>
                  <Set>Flag=1</Set>
                </If>
                <Else>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="sql" value="UpdJnlThdChk"/>
                  </Exec>
                  <If condition="INTCMP(~RetCod,4,0)">
                    <Exec func="PUB:RollbackWork" error="IGNORE"/>
                    <Exec func="PUB:ExecSql" error="IGNORE">
                      <Arg name="sql" value="UpdJnlThdChk"/>
                    </Exec>
                    <Set>MsgTyp=E</Set>
                    <Set>RspCod=PFT999</Set>
                    <Set>RspMsg=更新日间交易流水表失败</Set>
                    <Return/>
                  </If>
                </Else>
                <Break/>
              </Case>
            </Switch>
            <Exec func="PUB:CommitWork"/>
          </While>
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="Cursor1"/>
          </Exec>
<!--3、判断是否存在行内系统有而中心无的交易-->
          <Set>BTxnId= </Set>
          <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="sql" value="GetChkJnl"/>
            <Arg name="CursorName" value="Cursor2"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=打开游标出错</Set>
            <Return/>
          </If>
          <While>
            <Exec func="PUB:FetchCursor" error="IGNORE">
              <Arg name="CursorName" value="Cursor2"/>
            </Exec>
            <If condition="~RetCod=100">
              <Break/>
            </If>
            <If condition="IS_NOEQUAL_STRING($BilSts,F)">
              <Exec func="PUB:WriteFile" error="IGNORE">
                <Arg name="FileName" value="$DatFil"/>
                <Arg name="OpenMode" value="a+"/>
                <Arg name="Data"     value="[3]:TxnBr="/>
                <Arg name="Data"     value="$TxnBr"/>
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="TxnDat="/>
                <Arg name="Data"     value="$TxnDat"/>
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="OIFlag="/>
                <Arg name="Data"     value="$OIFlag"/>
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="RcvAct="/>
                <Arg name="Data"     value="$RcvAct"/>
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="TxnAmt="/>
                <Arg name="Data"     value="$TxnAmt"/>
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="TLogNo="/>
                <Arg name="Data"     value="$TLogNo"/>
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="TckNo="/>
                <Arg name="Data"     value="$TckNo"/>
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="BilSts="/>
                <Arg name="Data"     value="$BilSts"/>
                <Arg name="Data"     value="|"/>
                <Arg name="Data"     value="TBilSt="/>
                <Arg name="Data"     value="中心无记录"/>
                <Arg name="Data"     value="|"/>
                <Arg name="ESCFMT"   value="\\n"/>
              </Exec>
              <Set>Flag=1</Set>
            </If>
          </While>
          <Exec func="PUB:CloseCursor" error="IGNORE">
            <Arg name="CursorName" value="Cursor2"/>
          </Exec>
          <If condition="IS_EQUAL_STRING($Flag,1)">  <!--存在差异-->
            <Exec func="PUB:GenerateReport" desc="根据数据文件生成报表">
              <Arg name="ObjFil" value="STRCAT($RptDir,$RptFil)"/>
              <Arg name="FmtFil" value="$FmtFil"/>
              <Arg name="DatFil" value="$DatFil"/>
            </Exec>
            <Exec func="PUB:SendFileMessage2">
              <Arg name="MsgTyp"  value="4"/>
              <Arg name="ObjNod"  value="$NodNo"/>
              <Arg name="BusTyp"  value="46"/>
              <Arg name="AplCod"  value="$TxnCod"/>
              <Arg name="FilNam"  value="$RptFil"/>
              <Arg name="Summary" value="差错清单"/>
              <Arg name="ObjTlr"  value="$TlrId"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=对帐不平，请查看对帐差错清单</Set>
            <Return/>
          </If>
<!--查询我行成功但中心不成功的交易-->
          <Break/>
        </Case>
        <Case value="02">   <!--银行扣款流水打印-->
          <Set>FmtFil=STRCAT(etc/,PFT002_RPT,.XML)</Set>
          <Set>RptFil=STRCAT(PFT002_,$ClrDat,_,$ClrSce,.RPT)</Set>
          <Set>RptNam=银行扣款流水清单</Set>
          <Break/>
        </Case>
        <Case value="03">   <!--中心清算流水打印-->
          <Set>FmtFil=STRCAT(etc/,PFT003_RPT,.XML)</Set>
          <Set>RptFil=STRCAT(PFT003_,$ClrDat,_,$ClrSce,.RPT)</Set>
          <Set>RptNam=中心清算流水清单</Set>
          <Break/>
        </Case>
      </Switch>
      <If condition="IS_NOEQUAL_STRING($Func,01)">  <!--非对帐操作-->
        <Exec func="EXT:GenerateReport">
          <Arg name="RptName" value="STRCAT($RptDir,$RptFil)"/>
          <Arg name="RptFile" value="$FmtFil"/>
          <Arg name="RptNam"  value="$RptNam"/>
          <Arg name="ClrDat"  value="$ClrDat"/>
          <Arg name="ClrSce"  value="$ClrSce"/>
          <Arg name="BrNo"    value="$BrNo"/>
          <Arg name="NodNo"   value="$NodNo"/>
          <Arg name="TlrId"   value="$TlrId"/>
          <Arg name="PrtDat"  value="$ActDat"/>
        </Exec>
        <Exec func="PUB:SendFileMessage2">
          <Arg name="MsgTyp"  value="4"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="46"/>
          <Arg name="AplCod"  value="$TxnCod"/>
          <Arg name="FilNam"  value="$RptFil"/>
          <Arg name="Summary" value="$RptNam"/>
          <Arg name="ObjTlr"  value="$TlrId"/> 
        </Exec>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465925" desc="日终人行汇总对数">
    <DynSentence name="QryRec">
      <Sentence>
        select * from PftChkTot446 where ClrDat='%s' and ClrSce='%s' and BnkCod='%s'
      </Sentence>
      <Fields>ClrDat|ClrSce|BnkCod|</Fields>
    </DynSentence>
    
    <DynSentence name="UpdRec">
      <Sentence>
        update PftChkTot446 set ChkFlg='%s',BnkNum='%s',BnkAmt='%s'
         where TTxnTp='%s' and ClrDat='%s' and ClrSce='%s' and BnkCod='%s'
      </Sentence>
      <Fields>ChkFlg|BnkNum|BnkAmt|TTxnTp|ClrDat|ClrSce|BnkCod|</Fields>
    </DynSentence>
<!--税/费款缴纳+退税-->
    <DynSentence name="QryBus1">
      <Sentence>
        select sum(cast(TxnAmt as BIGINT)) BnkAmt,count(*) BnkNum from PftTxnJnl446 
         where ClrDat='%s' and ClrSce='%s' and TTxnTp='%s' and (RcvBNo='%s' or '%s'='' )
           and TxnTyp='N' and Bilsts in ('S')
      </Sentence>
    <Fields>ClrDat|ClrSce|TTxnTp|TBnkCod|TBnkCod|</Fields>
    </DynSentence>
    <DynSentence name="QryBnkCls">
      <Sentence>
        select BnkCls from PftBnkInf446 where BnkCod='%s'  
      </Sentence>
      <Fields>BnkCod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <If condition="AND(IS_NOEQUAL_STRING($NodNo,446800),IS_NOEQUAL_STRING($NodNo,446900))">
        <Set>MsgTyp=E</Set> 
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg1=机构不允许做本交易</Set>
        <Return/>
      </If>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="QryBnkCls"/>
        </Args>
      </Exec>
      <If condition="IS_EQUAL_STRING($BnkCls,0)">
        <Set>TBnkCod= </Set> 
      </If>
      <Else>
        <Set>TBnkCod=$BnkCod</Set>
      </Else>
      <Exec func="PUB:OpenCursor">
        <Arg name="sql" value="QryRec"/>
      </Exec>
      <Set>AllChk=1</Set>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <Quote name="IfCursorErr"/>     
        <If condition="OR(IS_EQUAL_STRING($TTxnTp,1),IS_EQUAL_STRING($TTxnTp,3))">
          <Set>DeaStr=QryBus1</Set>
        </If>
        <Else>
          <Goto>LabNotDeal</Goto>
        </Else>
        <Exec func="PUB:ReadRecord"  error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="$DeaStr"/>
          </Args>
        </Exec>
        <Quote name="IfCursorErr"/>     
        <Set>ChkFlg=0</Set>
        <If condition="AND(INTCMP($TotAmt,3,$BnkAmt),INTCMP($TotNum,3,$BnkNum))">
          <Set>ChkFlg=1</Set>
        </If>
        <Else>
          <Set>AllChk=0</Set>
        </Else>
        <Set>BnkAmt=ADDCHAR(DELSPACE($BnkAmt,all),15,0,1)</Set>
        <Set>BnkNum=ADDCHAR(DELSPACE($BnkNum,all),6,0,1)</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="sql" value="UpdRec"/>
        </Exec>
        <Quote name="IfCursorErr"/>
<Label>LabNotDeal</Label>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Exec  func="PUB:CommitWork"  /> <!--提交数据库事务-->
      <Exec func="EXT:GenerateReport">
        <Args>
          <Arg name="ObjFil" value="STRCAT($RptDir,PFT008,$TlrId,.RPT)"/>
          <Arg name="FmtFil" value="etc/PFT008_RPT.XML"/>
          <Arg name="ClrDat" value="$ClrDat"/>
          <Arg name="ClrSce" value="$ClrSce"/>      
          <Arg name="BnkCod" value="$BnkCod"/>
        </Args>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Args>
          <Arg name="MsgTyp" value="4"/>
          <Arg name="ObjNod" value="$NodNo"/>
          <Arg name="BusTyp" value="PFT"/>
          <Arg name="AplCod" value="000001"/>
          <Arg name="FilNam" value="STRCAT(PFT008,$TlrId,.RPT)"/>
          <Arg name="Summary" value="PFT日终人行汇总对帐报表"/>
          <Arg name="ObjTlr" value="$TlrId"/>
        </Args>
      </Exec>
      <If condition="$AllChk=0">
        <Set>RspMsg=当前对帐不平，请核查打印的对帐报表</Set>
      </If>
      <Else>
        <Set>RspMsg=当前对帐完成，请核查打印的对帐报表</Set>
      </Else>
    </FlowCtrl>
  </Transaction>

  <Transaction code="465926" desc="日终人行汇总信息浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select * from PftChkTot446
         where ClrDat='%s' and ( ClrSce='%s' or '%s'='' )
           and (TTxnTp='%s' or '%s'= '') and ( BnkCod='%s' or '%s'= '' )
      </Sentence>
      <Fields>ClrDat|ClrSce|ClrSce|TTxnTp|TTxnTp|BnkCod|BnkCod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <Exec func="PUB:MultiQuery"/>                               
    </FlowCtrl>                           
  </Transaction>  

  <Transaction code="465928" desc="接收登陆通知">
    <Attributes>
      <Attribute name="noresponse" value="1"/>
    </Attributes>  
    <DynSentence name="UpdRec">
      <Sentence>
        update PftBnkInf446 set SysSts='%s' 
      </Sentence>
      <Fields>SysSts|</Fields>
    </DynSentence>
    <FlowCtrl>    
      <Exec func="PUB:InitTransaction"/>
      <Set>SysSts=1 </Set>     
      <Exec func="PUB:ExecSql">
        <Arg name="sql" value="UpdRec"/>
      </Exec>    
    </FlowCtrl>                           
  </Transaction>                          

  <Transaction code="465929" desc="接收人行系统关闭通知">
    <Attributes>
      <Attribute name="noresponse" value="1"/>
    </Attributes>  
    <DynSentence name="UpdRec">
      <Sentence>
        update PftBnkInf446 set SysSts='%s' 
      </Sentence>
      <Fields>SysSts|</Fields>
    </DynSentence>
    <FlowCtrl>    
      <Exec func="PUB:InitTransaction"/>
      <Set>SysSts=0 </Set>     
      <Exec func="PUB:ExecSql">
        <Arg name="sql" value="UpdRec"/>
      </Exec>
    </FlowCtrl>                           
  </Transaction> 
   
  <Transaction code="465964" desc="佛山缴税退库">
    <Quote name="PftSqlLst"/>
    <DynSentence name="GetFilInf" desc="获取退库文件处理状态">
      <Sentence>
        select FilSts from PftFilInf446 where PftFil='%s'
      </Sentence>
      <Fields>PftFil|</Fields>
    </DynSentence>
    <DynSentence name="DelSec203Sum" desc="清理退库汇总信息">
      <Sentence>
        delete from PftSec203Sum446 where PftFil='%s'
      </Sentence>
      <Fields>PftFil|</Fields>
    </DynSentence>
    <DynSentence name="DelSec203Dtl" desc="清理退库明细信息">
      <Sentence>
        delete from PftSec203Dtl where PftFil='%s'
      </Sentence>
      <Fields>PftFil|</Fields>
    </DynSentence>
    <DynSentence name="DelSec203Sum" desc="清理退库退回处理结果信息">
      <Sentence>
        delete from PftSec204Sum where PftFil='%s'
      </Sentence>
      <Fields>PftFil|</Fields>
    </DynSentence>   
    <DynSentence name="UpdFilInf" desc="更新处理状态">
      <Sentence>
        PftFil='%s'
      </Sentence>
      <Fields>PftFil|</Fields>
    </DynSentence>
    <DynSentence name="GetSec203Sum" desc="获取退库记录">
      <Sentence>
        select MsgFmt,ClrDat,int(ClrSce) ClrSce,OIFlag,TCrpCd,TActDt,TLogNo,RcvBNo,FskCod,TTxnTp,RcvAct,SndAct,TxnAmt,TPayTp,BilSts
          from PftSec203Sum446 where PftFil='%s' and BilSts='U'
      </Sentence>
      <Fields>PftFil|</Fields>
    </DynSentence>
    <DynSentence name="UpdSec203Sum" desc="更新处理状态">
      <Sentence>
        PftFil='%s' and TCrpCd='%s' and TActDt='%s' and TLogNo='%s'
      </Sentence>
      <Fields>PftFil|TCrpCd|TActDt|TLogNo|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
    </Attributes>

    <FlowCtrl>
      <Quote name="InitAccTran"/>
      <If condition="IS_NOEQUAL_STRING($BrNo,446999)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PFT999</Set>
        <Set>RspMsg=分行无此权限</Set>
        <Return/>
      </If>
      <If condition="INTCMP($Func,3,2)">  <!--生成退库退回文件-->
        <Exec func="PUB:AddAuthReason">
          <Arg name="AthCod" value="40"/>
          <Arg name="AthMsg" value="PFT000"/>
        </Exec>
        <Exec func="PUB:CheckLocalAuth">
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
      </If>
      <Exec func="PUB:Lock">
        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        <Arg name="AutoUnlock" value="yes"/>
      </Exec>
      <If condition="INTCMP($Func,4,3)">  
        <Set>PftFil=STRCAT(SEC203_,$BnkCod,_0001.,$ClrDat,.dat)</Set>   <!--退库处理结果文件-->
      </If>
      <Else>                              
        <Set>PftFil=STRCAT(SEC204_,$BnkCod,_0001.,$ClrDat,.dat)</Set>   <!--退库退回处理结果文件-->
      </Else>
      <Set>IcsFil=STRCAT(GETENV(WORKDIR),/,$IcsRcvDir,$PftFil)</Set>
      <If condition="OR(INTCMP($Func,3,0),INTCMP($Func,3,3))">
        <Exec func="PUB:IsValidFile">																		<!--判断文件是否存在-->
          <Arg name="FilNam" value="$IcsFil"/>
        </Exec>
      </If>
      <If condition="INTCMP(~RetCod,3,-1)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFT999</Set>
          <Set>RspMsg=处理结果文件不存在!</Set>
          <Return/>      		
      </If>
      
      <If condition="OR(INTCMP($Func,3,0),INTCMP($Func,3,1),INTCMP($Func,3,2))">
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="GetFilInf"/>
          </Args>
        </Exec>
        <If condition="INTCMP(~RetCod,3,-1)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFT999</Set>
          <Set>RspMsg=STRCAT(查询表【GetFilInf】失败)</Set>
          <Return/>
        </If>
        <If condition="INTCMP(~RetCod,3,-2)">   <!--文件登记表记录不存在，根据交易功能决定流程-->
          <Switch expression="$Func">
            <Case value="0"> <!-- 退库文件接收入库 -->
              <Set>FilSts=0</Set>
              <Exec func="PUB:InsertRecord">
                <Arg name="TblNam" value="PftFilInf446"/>
              </Exec>
              <Break/>
            </Case>
            <Case value="1"/> <!--退库入帐处理-->
            <Case value="2">  <!--生成退库退回文件-->
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=STRCAT(无【,$ClrDat,】退库数据)</Set>
              <Return/>
            </Case>
          </Switch>
        </If>
      </If>
<!--文件登记表记录不存在，根据文件状态决定流程-->
      <Switch expression="$Func">
      	<Case value="A">  <!--退库文件申请-->
          <Set>ApyFil=STRCAT(SEC203,_,$BnkCod,_0001.,$ClrDat)</Set> <!--申请文件名-->
          <Quote name="ApplyFile"/>		<!--发起文件申请-->
      		<Break/>
      	</Case>      	
      	<Case value="B">  <!--退库退回回应文件申请-->
          <Set>ApyFil=STRCAT(SEC204,_,$BnkCod,_0001.,$ClrDat)</Set> <!--申请文件名-->
          <Quote name="ApplyFile"/>		<!--发起文件申请-->
      		<Break/>
      	</Case>      	
        <Case value="0"> <!--退库文件读入-->
          <Switch expression="$FilSts">
            <Case value="0"/>   <!--读入未成功-->
            <Case value="1">    <!--读入已成功-->
              <Exec func="PUB:ExecSql" error="IGNORE">
                <Args>
                  <Arg name="SqlCmd" value="DelSec203Sum"/>
                </Args>
              </Exec>
              <If condition="~RetCod=-1">
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=清除汇总表失败</Set>
                <Return/>
              </If>
              <Exec func="PUB:ExecSql" error="IGNORE">
                <Args>
                  <Arg name="SqlCmd" value="DelSec203Dtl"/>
                </Args>
              </Exec>
              <If condition="~RetCod=-1">
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=清除明细失败</Set>
                <Return/>
              </If>
              <Set>FilSts=0</Set>   <!--更新状态为"数据读入"-->
              <Exec func="PUB:UpdateRecord">
                <Arg name="TblNam" value="PftFilInf446"/>
                <Arg name="CndSts" value="UpdFilInf"/>
              </Exec>
              <Exec func="PUB:CommitWork"/>  <!--清算数据不需回滚-->
              <Break/>
            </Case>
            <Case value="2"/>   <!--清算正在进行-->
            <Case value="3">   <!--清算完成-->
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=数据文件已处理，不能重复读入</Set>
              <Return/>
            </Case>
          </Switch>
<!--数据文件入库-->
<!--解析文件首行-->
          <Set>cnt=0</Set>
          <Exec func="PUB:OpenFile">
            <Arg name="FileName"   value="$IcsFil"/>
            <Arg name="Mode"       value="r"/>
            <Arg name="ObjectName" value="FilPnt"/>
          </Exec>
          <Exec func="PUB:InitDataParser">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
          </Exec>
          <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
            <Arg name="NodeName"   value="Process"/>
            <Arg name="AttrName"   value="name"/>
            <Arg name="AttrValue"  value="FSSEC203HEAD"/>
            <Arg name="MaxLen"     value="512"/>
            <Arg name="ObjectName" value="FilPnt"/>
          </Exec>
          <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,1),INTCMP(~RetCod,3,-2))">   <!--解析失败或结束-->
            <Exec func="PUB:CloseFile">
              <Arg name="ObjectName" value="FilPnt"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=STRCAT(解析退库文件【,$FilNam,】文件头失败)</Set>
            <Return/>
          </If>
<!--明细数据入库-->
          <Set>BilSts=U</Set>
          <Set>OpnBr=446999</Set>
          <While>
            <If condition="INTCMP($cnt,6,$TotNum)">
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Break/>
            </If>
            <Delete>TCrpCd</Delete>
            <Delete>TActDt</Delete>
            <Delete>TLogNo</Delete>
            <Delete>RcvBNo</Delete>
            <Delete>FskCod</Delete>
            <Delete>TTxnTp</Delete>
            <Delete>Smr</Delete>   
            <Delete>TVchNo</Delete>
            <Delete>RcvAct</Delete>
            <Delete>SndAct</Delete>
            <Delete>TxnAmt</Delete>
            <Delete>TPayTp</Delete>
            <Delete>PrtFlg</Delete>
            <Delete>TaxNam</Delete>
            <Delete>TaxNo</Delete> 
            <Delete>CrpKnd</Delete>
            <Delete>DtlNum</Delete>
            <Exec func="PUB:DeleteGroup">
              <Arg name="GroupName" value="VchDtl"/>
            </Exec>                
            <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
              <Arg name="ConfigName" value="BatFormat"/>
              <Arg name="RootName"   value="BATCH"/>
              <Arg name="NodeName"   value="Process"/>
              <Arg name="AttrName"   value="name"/>
              <Arg name="AttrValue"  value="FSSEC203BODY"/>
              <Arg name="MaxLen"     value="10240"/>
              <Arg name="ObjectName" value="FilPnt"/>
            </Exec>
            <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,-2))">   <!--解析失败返回-->
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=STRCAT(解析批量包明细文件【,$FilNam,】文件体失败)</Set>
              <Return/>
            </If>
            <If condition="INTCMP(~RetCod,3,1)">
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Break/>
            </If>
<!--退库业务汇总表-->
            <Exec func="PUB:InsertRecord" error="IGNORE">
              <Arg name="TblNam" value="PftSec203Sum446"/>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=登记退库业务汇总表【PftSec203Sum】失败</Set>
              <Return/>
            </If>
<!--退库业务明细表-->
            <Exec func="PUB:InsertRecord" error="IGNORE">
              <Arg name="TblNam" value="PftSec203Dtl446"/>
              <Arg name="GrpNam" value="VchDtl"/>
              <Arg name="FldLst" value="PftFil|TCrpCd|TActDt|TLogNo|"/>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=登记退库业务明细表表【PftSec203Dtl】失败</Set>
              <Return/>
            </If>
            <Set>cnt=ADD($cnt,1)</Set>
          </While>
          <Set>FilSts=1</Set>   <!--更新状态为"数据读入成功"-->
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="PftFilInf446"/>
            <Arg name="CndSts" value="UpdFilInf"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="1"> <!-- 退库入帐处理 -->
          <Switch expression="$FilSts">
            <Case value="0">    <!--读入未成功-->
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=数据文件未读入</Set>
              <Return/>
            </Case>
            <Case value="2"/>    <!--清算正在进行-->
            <Case value="3">    <!--清算完成-->
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=数据处理已开始，不能重复处理</Set>
              <Return/>
            </Case>
            <Case value="1">    <!--读入已成功-->
              <Set>FilSts=2</Set>   <!--更新状态为"清算正在进行"-->
              <Exec func="PUB:UpdateRecord">
                <Arg name="TblNam" value="PftFilInf446"/>
                <Arg name="CndSts" value="UpdFilInf"/>
              </Exec>
              <Exec func="PUB:OpenCursor" error="IGNORE">
                <Arg name="sql" value="GetSec203Sum"/>
              </Exec>
              <If condition="INTCMP(~RetCod,4,0)">
                <Set>MsgTyp=E</Set>
                <Set>RspCod=PFT999</Set>
                <Set>RspMsg=打开游标出错</Set>
                <Return/>
              </If>
              <Set>TxnCnl=PFT</Set>
              <Exec func="PUB:GetVirtualTeller"/>
              <While>
                <Exec func="PUB:FetchCursor" error="IGNORE"/>
                <If condition="~RetCod=100">
                  <Break/>
                </If>
                <Delete>LogNo</Delete>
                <Delete>LActFg</Delete>
                <Delete>BokAct</Delete>
                <Exec func="CBS:CbsGetAccFlg" error="IGNORE">
                  <Args>
                    <Arg name="RcvAct" value="$RcvAct"/>
                  </Args>
                </Exec>
                <If condition="INTCMP(~RetCod,4,0)">
                  <Set>BokSts=E</Set>
                  <Exec func="PUB:UpdateRecord">
                    <Arg name="TblNam" value="PftSec203Sum446"/>
                    <Arg name="CndSts" value="UpdSec203Sum"/>
                  </Exec>
                  <Exec func="PUB:CommitWork"/>
                  <Continue/>
                </If>
<!--记帐要素-->
                <Set>TxnTyp=N</Set>
                <Set>ActTyp=$LActFg</Set>
                <Set>ActNo=$BokAct</Set>
                <Set>OIFlag=1</Set>
                <Set>CrpCod=PFT999999999</Set>
                <Set>CcyCod=CNY</Set>
                <Set>TxnCnl=PFT</Set>
                <Exec func="PUB:GetVirtualTeller"/>
                <Exec func="PUB:GetLogNo"/>
                <Switch expression="$ActTyp">
                  <Case value="0"> <!-- 普通对公 -->
                    <If condition="IS_EQUAL_STRING(SUBSTR($BokAct,1,2),16)">
                      <Set>ActNo=STRCAT(446,$BokAct)</Set>
                    </If>
                    <Set>HTxnCd=451820</Set>
                    <Set>BusTyp=FTT51</Set>
                    <Set>CrpCod=PFT999999999</Set>
                    <Set>RgCFlg=1</Set>
                    <Set>OActBk=$BrNo</Set>
                    <Set>OActBr=$NodNo</Set>
                    <Set>OActSq=$Act02Sq</Set>
                    <Set>CDFlg1=D</Set>
                    <Set>OvrSe2=1</Set>
                    <Set>CDFlg2=C</Set>
                    <Set>PyeAmt=$TxnAmt</Set>
                    <Set>Smr=退库</Set>
                    <Break/>
                  </Case>
                  <Case value="1"/> <!-- 一本通 -->
                  <Case value="2"/> <!-- 普通存折 -->
                  <Case value="4"> <!-- 太平洋卡 -->
                    <Set>HTxnCd=471370</Set>
                    <Set>BusTyp=FTT51</Set>
                    <Set>CnlTyp=L</Set>
                    <Set>ActSeq=$Act02Sq</Set>
                    <Set>ActFlg=$ActTyp</Set>
                    <Set>Mask=0806</Set>
                    <Set>SubCod=001</Set>
                    <Set>CcyTyp=1</Set>
                    <Set>VchChk=0</Set>
                    <Set>CAgtNo=PFT9999999</Set>
                    <Break/>
                  </Case>
                  <Case value="A"> <!-- 中央财政对公 -->
                    <Break/>
                  </Case>
                  <Case value="B"> <!-- 广东省财政对公 -->
                    <Break/>
                  </Case>
                </Switch>
                <Exec func="PUB:InsertRecord">
                  <Arg name="TblNam" value="PftTxnJnl446"/>
                </Exec>
                <If condition="OR(IS_EQUAL_STRING($ActTyp,A),IS_EQUAL_STRING($ActTyp,B))">  <!--财政账户转发相关财政系统-->
                  <Set>TOIFlg=R</Set>  <!--财政往来支出标志-->
                  <Exec func="PUB:CallThirdOther" error="IGNORE">
                    <Arg name="TxnCod" value="$HTxnCd"/>
                    <Arg name="ObjSvr" value="$ObjSvr"/>
                  </Exec>
                </If>
                <Else>
                  <Exec func="PUB:CallHostAcc" error="IGNORE">
                    <Arg name="TxnCod" value="$HTxnCd"/>
                    <Arg name="ObjSvr" value="SHSTPUB1"/>
                  </Exec>
                </Else>
                <Switch expression="~RetCod">
                  <Case value="-1">  <!--上送主机超时-->
                    <Set>BilSts=T</Set>
                    <Set>RspCod=PFT999</Set>
                    <Break/>
                  </Case>
                  <Case value="0"> <!--交易成功-->
                    <Set>BilSts=S</Set>
                    <Set>RspCod=000000</Set>
                    <Break/>
                  </Case>
                  <Default>
                    <Set>BilSts=F</Set>
                    <Set>RspCod=PFT999</Set>
                    <Delete>TckNo</Delete>
                    <Break/>
                  </Default>
                </Switch>
                <Exec func="PUB:CodeSwitching" error="IGNORE">
                  <Arg name="DatSrc"  value="PFTCSW"/>
                  <Arg name="SourNam" value="RspCod"/>
                  <Arg name="DestNam" value="RtnCod"/>
                  <Arg name="TblNam"  value="RspCodToRtnCod"/>
                </Exec>
<!--避免由于主机异常造成Update失败,而导致主机成功、返回失败的情况发生，若发生Update失败的情况，通过日终对帐发现-->
                <If condition="IS_EQUAL_STRING($ActTyp,A)">  <!--中央财政账户需要将BLogNo替换回LOGNO、并将总行LogNo存放HLogNo-->
                  <Set>PLogNo=$LogNo</Set>
                  <Set>LogNo=$BLogNo</Set>
                </If>
                <Exec func="PUB:UpdateRecord" error="IGNORE">
                  <Arg name="TblNam" value="PftTxnJnl446"/>
                  <Arg name="CndSts" value="UpdTxnJnl"/>
                </Exec>
                <Exec func="PUB:UpdateRecord" error="IGNORE">
                  <Arg name="TblNam" value="PftSec203Sum446"/>
                  <Arg name="CndSts" value="UpdSec203Sum"/>
                </Exec>
                <Exec func="PUB:CommitWork"/>
              </While>
<!--更新状态为清算完成-->
              <Set>FilSts=3</Set>   <!--更新状态为"清算成功"-->
              <Exec func="PUB:UpdateRecord">
                <Arg name="TblNam" value="PftFilInf446"/>
                <Arg name="CndSts" value="UpdFilInf"/>
              </Exec>
              <Break/>
            </Case>
          </Switch>
          <Break/>
        </Case>
        <Case value="2"> <!-- 生成退库退回文件 -->
          <Switch expression="$FilSts">
            <Case value="0"/>    <!--读入未成功-->
            <Case value="1"/>    <!--读入未成功-->
            <Case value="2">    <!--清算正在进行-->
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=退库数据未清算</Set>
              <Return/>
            </Case>
            <Case value="4"/>    <!--退库退回正在处理-->
            <Case value="5">     <!--退库退回处理完成-->
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=退库退回文件已处理，不能重复处理</Set>
              <Return/>
            </Case>
            <Case value="3">     <!--清算完成-->
              <Set>FilSts=4</Set>   <!--更新状态为"退库退回正在处理"-->
              <Exec func="PUB:UpdateRecord">
                <Arg name="TblNam" value="PftFilInf446"/>
                <Arg name="CndSts" value="UpdFilInf"/>
              </Exec>
              
              <Quote name="MakeAndSendFile"/>  <!--生成、加押、压缩并且传送文件给人行-->
              <Break/>
            </Case>
          </Switch>
          <Break/>
        </Case>
        <Case value="3"> <!-- 处理退库退回回应文件 -->
          <Set>RptFil=STRCAT(PFT101,$TlrId,.RPT)</Set>
          <Set>DatFil=STRCAT($RptDir,$RptFil,.dat)</Set>
          <Set>FmtFil=STRCAT(etc/,PFT101_RPT,.XML)</Set>
          <Set>RptNam=退库退回错误清单</Set>
<!--数据文件入库-->
<!--解析文件首行-->
          <Set>cnt=0</Set>
          <Exec func="PUB:OpenFile">
            <Arg name="FileName"   value="$IcsFil"/>
            <Arg name="Mode"       value="r"/>
            <Arg name="ObjectName" value="FilPnt"/>
          </Exec>
          <Exec func="PUB:InitDataParser">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
          </Exec>
          <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
            <Arg name="NodeName"   value="Process"/>
            <Arg name="AttrName"   value="name"/>
            <Arg name="AttrValue"  value="FSSEC204HEAD"/>
            <Arg name="MaxLen"     value="512"/>
            <Arg name="ObjectName" value="FilPnt"/>
          </Exec>
          <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,1),INTCMP(~RetCod,3,-2))">   <!--解析失败或结束-->
            <Exec func="PUB:CloseFile">
              <Arg name="ObjectName" value="FilPnt"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=PFT999</Set>
            <Set>RspMsg=STRCAT(解析退库退回结果文件【,$PftFil,】文件头失败)</Set>
            <Return/>
          </If>
          <Exec func="PUB:WriteFile" error="IGNORE">
          <Arg name="FileName" value="$DatFil"/>
            <Arg name="OpenMode" value="w"/>
            <Arg name="Data"   value="[2]:BnkDat="/>
            <Arg name="Data"   value="$BnkDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="ClrDat="/>
            <Arg name="Data"   value="$ClrDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="TotNum="/>
            <Arg name="Data"   value="$TotNum"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="ErrNum="/>
            <Arg name="Data"   value="$ErrNum"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="BRtnCd="/>
            <Arg name="Data"   value="$BRtnCd"/>
            <Arg name="Data"   value="|"/>
            <Arg name="ESCFMT" value="\\n"/>
          </Exec>  
<!--明细数据入库-->
          <While>
            <If condition="INTCMP($cnt,6,$TotNum)">
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Break/>
            </If>
            <Delete>RcvBNo</Delete>
            <Delete>BokDat</Delete>
            <Delete>BTxnId</Delete>
            <Delete>TTxnTp</Delete>
            <Delete>RcvAct</Delete>
            <Delete>SndAct</Delete>
            <Delete>TxnAmt</Delete>
            <Delete>TRtnCd</Delete>
            <Delete>DtlMac</Delete>
            <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
              <Arg name="ConfigName" value="BatFormat"/>
              <Arg name="RootName"   value="BATCH"/>
              <Arg name="NodeName"   value="Process"/>
              <Arg name="AttrName"   value="name"/>
              <Arg name="AttrValue"  value="FSSEC204BODY"/>
              <Arg name="MaxLen"     value="10240"/>
              <Arg name="ObjectName" value="FilPnt"/>
            </Exec>
            <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,-2))">   <!--解析失败返回-->
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>MsgTyp=E</Set>
              <Set>RspCod=PFT999</Set>
              <Set>RspMsg=STRCAT(解析批量包明细文件【,$FilNam,】文件体失败)</Set>
              <Return/>
            </If>
            <If condition="INTCMP(~RetCod,3,1)">
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Break/>
            </If>
            <Exec func="PUB:WriteFile" error="IGNORE">
              <Arg name="FileName" value="$DatFil"/>
              <Arg name="OpenMode" value="a+"/>
              <Arg name="Data"   value="[3]:RcvBNo="/>
              <Arg name="Data"   value="$RcvBNo"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="BokDat="/>
              <Arg name="Data"   value="$BokDat"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="BTxnId="/>
              <Arg name="Data"   value="$BTxnId"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="RcvAct="/>
              <Arg name="Data"   value="$RcvAct"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="TxnAmt="/>
              <Arg name="Data"   value="$TxnAmt"/>
              <Arg name="Data"   value="|"/>
              <Arg name="Data"   value="TRtnCd="/>
              <Arg name="Data"   value="$TRtnCd"/>
              <Arg name="Data"   value="|"/>
              <Arg name="ESCFMT" value="\\n"/>
            </Exec>
            <Set>cnt=ADD($cnt,1)</Set>
          </While>
          <Exec func="PUB:WriteFile" error="IGNORE">
            <Arg name="FileName" value="$DatFil"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="Data"   value="[6]:TlrId="/>
            <Arg name="Data"   value="$TlrId"/>
            <Arg name="Data"   value="|"/>
            <Arg name="Data"   value="ActDat="/>
            <Arg name="Data"   value="$ActDat"/>
            <Arg name="Data"   value="|"/>
            <Arg name="ESCFMT" value="\\n"/>
          </Exec> 
          <Exec func="PUB:GenerateReport">
            <Arg name="ObjFil" value="STRCAT($RptDir,$RptFil)"/>
            <Arg name="FmtFil" value="$FmtFil"/>
            <Arg name="DatFil" value="$DatFil"/>
          </Exec>
          <Exec func="PUB:SendFileMessage2">
            <Arg name="MsgTyp"  value="4"/>
            <Arg name="ObjNod"  value="$NodNo"/>
            <Arg name="BusTyp"  value="46"/>
            <Arg name="AplCod"  value="$TxnCod"/>
            <Arg name="FilNam"  value="$RptFil"/>
            <Arg name="Summary" value="差错清单"/>
            <Arg name="ObjTlr"  value="$TlrId"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="4"> <!-- 打印 -->
          <Set>RptFil=STRCAT(PFT102,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PFT102_RPT,.XML)</Set>
          <If condition="IS_EQUAL_STRING($BilSts,S)">
            <Set>RptNam=成功</Set>
            <Set>PrtNam=会计流水号</Set>
          </If>
          <Else>
            <Set>RptNam=失败</Set>
            <Set>PrtNam=主机返回码</Set>
          </Else>
          <Exec func="PUB:GenerateReport">
            <Arg name="ObjFil" value="STRCAT($RptDir,$RptFil)"/>
            <Arg name="FmtFil" value="$FmtFil"/>
            <Arg name="RptNam" value="$RptNam"/>
            <Arg name="PrtNam" value="$PrtNam"/>
            <Arg name="ClrDat" value="$ClrDat"/>
            <Arg name="Bilsts" value="$Bilsts"/>
            <Arg name="PrtDat" value="$ActDat"/>
            <Arg name="PrtTlr" value="$TlrId"/>
          </Exec>
          <Exec func="PUB:SendFileMessage2">
            <Arg name="MsgTyp"  value="4"/>
            <Arg name="ObjNod"  value="$NodNo"/>
            <Arg name="BusTyp"  value="46"/>
            <Arg name="AplCod"  value="$TxnCod"/>
            <Arg name="FilNam"  value="$RptFil"/> 
            <Arg name="Summary" value="退库清单"/>
            <Arg name="ObjTlr"  value="$TlrId"/>
          </Exec>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=PFT999</Set>
          <Set>RspMsg=系统错误或尚未做明细入库处理</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>
  
</Application>
