<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="PNT" code="215">
	<LibDeclare>
		<Library name="PFA" value="dll/pfa.so"/>
		<Library name="PNT" value="dll/pnt.so"/>
	</LibDeclare>

	<ConfigDeclare>
		<Config name="ParaFile"    value="etc/CFG_PNT_484999.XML"/>	
		<Config name="BatFormat"  value="etc/PNT_FMT.XML"/>
	</ConfigDeclare>
	
	<PackageDeclare>
		<Package name="PNT"      value="etc/PNT_PKG_484999.XML"/>
	</PackageDeclare>
	
	<TableDeclare>
		<Table name="PntTxnBok"    value="PntTxnBok"/>
		<Table name="PntTxnJnl"    value="PntTxnJnl"/>
		<Table name="PntSfxm"      value="PntSfxm"/>
		<Table name="Pntdwxx"      value="Pntdwxx"/>
		<Table name="PntDwxm"      value="PntDwxm"/>
		<Table name="PntPjlx"      value="PntPjlx"/>
		<Table name="PntPjff"      value="PntPjff"/>
		<Table name="PntXmpj"      value="PntXmpj"/>
		<Table name="PntQyxx"      value="PntQyxx"/>	
		<Table name="PntPrgx"      value="PntPrgx"/>
		<Table name="PntWtzw"      value="PntWtzw"/>
		<Table name="PntWtzw"      value="PntFccz"/>
		<Table name="PntWtzw"      value="PntFcgk"/>		
		<Table name="pntfilctl"    value="pntfilctl"/>
		<Table name="pntbatrec"    value="pntbatrec"/>
		<Table name="pntextbat"    value="pntextbat"/>	
		<Table name="pntfilinf"    value="pntfilinf"/>	
	</TableDeclare>

	<GlobalFunction> 
		<Include file="etc/ActJudge_IIT.XML"/>  <!--区别对公对私帐号-->		
	</GlobalFunction>

	<BusDefDeclare>
		<Busdef name="RptDir" value="dat/term/send/"/>
		<Busdef name="PntSndDir" value="dat/pnt/send/"/>
		<Busdef name="PntRcvDir" value="dat/pnt/recv/"/>
	</BusDefDeclare>

	<Define>
		<Include file="etc/PNT_MCR.XML"/>
	</Define>
	
	
	<Transaction code="461500" desc="大小通道交易处理"> <!--RecSts 0:初始化 1:成功 2:失败-->
		<DynSentence name="UpdRecSts">
			<Sentence>
				UPDATE pntbatrec SET RecSts='%s' WHERE DskNo='%s' AND SeqNo='%s'
			</Sentence>
			<Fields>RecSts|DskNo|SeqNo|</Fields>
		</DynSentence>
		<DynSentence name="UpdRecSts1">
			<Sentence>
				UPDATE pntbatrec SET HRspCd='%s', RecSts='2' WHERE DskNo='%s' AND SeqNo='%s'
			</Sentence>
			<Fields>RspCod|DskNo|SeqNo|</Fields>
		</DynSentence>
		<DynSentence name="UpdCtlSts">
			<Sentence>
				UPDATE pntfilctl SET DskSts='2' WHERE DskNo='%s'
			</Sentence>
			<Fields>DskNo|</Fields>
		</DynSentence>		
		<!--DynSentence name="UpdThdJnl"><更新流水表>
         <Sentence>
            LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
    </DynSentence-->
		<FlowCtrl>
			
      <Set>NewFlg=1</Set>
			<Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
			<Call function="$AcJudFunc">
				<Input name="ActNo|NewFlg|"/>
				<Output name="OActNo|ActCls|"/>
			</Call>
			
			<Switch expression="$ActCls">
				<Case value="0" /> <!-- 对公 -->
				<Case value="4" >
					<If condition="INTCMP($TxnDir,3,0)"> <!--代收-->
					  <Set>HTxnCd=451610</Set> 
					  <Set>ActFlg=2</Set>  <!--Add by Lucky,20070614,扣款模式,2正常扣款-->
					  <Set>ActSqn=SUBSTR($CActNo,14,5)</Set>
					  <Set>ActNod=LEFTSTR($CActNo,6)</Set>
					  <!--<Set>BusTyp=CRP51</Set>-->
					  <Set>BusTyp=PNT01</Set>
					 	<Delete>TActNo</Delete>
					 	<Delete>NodNo</Delete>
					  <Set>BusSub=01</Set>
					  <Set>TxnAmt=NORMAL_TO_COBOL($TxnAmt,15)</Set>
					</If>
					<!--ElseIf condition="INTCMP($TxnDir,3,1)">  <代付>
						
					</ElseIf-->
					<Break/>
				</Case>
				<Case value="2" /> <!-- 对私 -->
				<Case value="3" />
				<Case value="5" >
					<If condition="INTCMP($TxnDir,3,0)"> <!--代收-->
					  <Set>HTxnCd=471140</Set> 
					  <Set>VchCod=00000000</Set>
					  <Set>TActNo=$CActNo</Set>
					</If>
					<!--ElseIf condition="INTCMP($TxnDir,3,1)"> <代付>
					  <Set>HTxnCd=471340</Set> 
					  <Set>PActNo=$CActNo</Set>
					</ElseIf-->
					<Set>CcyTyp=1</Set>
					<Set>VchChk=1</Set>
					<Set>CnlTyp=0</Set>  
					<Set>Mask=$BSmr</Set>   
					<If condition="INTCMP($ActCls,3,3)">
					  <Set>ActFlg=4</Set>
					</If>
					<Else>
						<Set>ActFlg=2</Set>
					</Else>
					<Break/>
				</Case>
				<Default>
					<Set>HRspCd=461209</Set>    <!--帐号检查错-->
					<Set>MsgTyp=N</Set>
					<Set>RecSts=2</Set>
					<Exec func="PUB:ExecSql">
						<Arg name="SqlCmd" value="UpdRecSts"/>
					</Exec>
					<Exec func="PUB:PutResponse"/>
					<Return/>
				</Default>
			</Switch>
			<!-- 上主机 
			<Set>TActNo=$CActNo</Set-->
			
			<Set>TxnTyp=N</Set>
			<Set>ItgTyp=0</Set>
			<Set>FRspCd=000000</Set>
			<Set>MstChk=1</Set>
			<!--
			<Exec func="PUB:InsertRecord" error="IGNORE">
            <Arg name="TblNam" value="pnttxnjnl"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
            <Set>RspCod=461599</Set>
            <Set>RspMsg=插入流水表失败</Set>
            <Return/>
      </If>-->
			
			<Exec func="PUB:CallHostOther">
				<Arg name="HTxnCd" value="$HTxnCd"/>
				<Arg name="ObjSvr" value="SHSTPUB1"/>
			</Exec>
			<If condition="~RetCod=0">  <!--recsts 0:初始化 1:成功 2:失败 -->
			  
			  <!--Exec func="PUB:UpdateRecord" error="IGNORE"> <更新记账信息>
           <Arg name="TblNam" value="pntbatrec"/>
           <Arg name="CndSts" value="UpdThdJnl"/>
        </Exec-->
			  
				<Set>RecSts=1</Set>
				<Set>HRspCd=SC0000</Set> 
				<Exec func="PUB:ExecSql">
					<Arg name="SqlCmd" value="UpdRecSts"/>
				</Exec>
				<Exec func="PUB:ExecSql">
					<Arg name="SqlCmd" value="UpdCtlSts"/>
				</Exec>				
				<Set>MsgTyp=N</Set>
				<Exec func="PUB:PutResponse"/>
				<Return/>
			</If>
			<ElseIf condition="~RetCod=3">  <!--recsts 0:初始化 1:成功 2:失败 -->
			  
			  <!--Exec func="PUB:UpdateRecord" error="IGNORE"> <更新记账信息>
           <Arg name="TblNam" value="pntbatrec"/>
           <Arg name="CndSts" value="UpdThdJnl"/>
        </Exec-->
			
				<Set>RecSts=2</Set>
				<Exec func="PUB:ExecSql">
					<Arg name="SqlCmd" value="UpdRecSts"/>
				</Exec>
				<Set>MsgTyp=N</Set>
				<Exec func="PUB:PutResponse"/>
				<Return/>
			</ElseIf>
		</FlowCtrl>
	</Transaction>	

	<Transaction code="461501" desc="请求缴费">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="TxnCod" value="311"/>
				<Arg name="ObjSvr" value="STHDPNT1"/>
			</Exec>
			<Switch expression="$RtnCod">
				<Case value="102">   <!--部分手工录入-->
					<Set>NTxnCd=461502</Set>
					<Break/>
				</Case>
				<Case value="107">   <!--完全手工录入-->
					<Set>NTxnCd=461503</Set>
					<Break/>
				</Case>
				<Case value="100">   <!--不需要手工录入-->
					<Set>NTxnCd=461504</Set>
					<Break/>
				</Case>
				<Default>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Return/>
				</Default>
			</Switch>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461502" desc="部分手工录入">
		<Quote name="PntSqlLst"/>
    <Attributes>
      <Attribute name="integrity" value="2" code="461599"/>  <!-- 条件冲正-->
			<Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
    </Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PFA:GenPrvData">
				<Arg name="PrjNum" value="PrjNum" desc="收费项目笔数"/>
				<Arg name="PrjGrp" value="PrjRec" desc="收费项目结构"/>
				<Arg name="RmkNum" value="RmkNum" desc="额外信息笔数"/>
				<Arg name="RmkGrp" value="RmkRec" desc="额外信息结构"/>
			</Exec>
			<Set>BilSts=U</Set>
			<Exec func="PUB:GetLogNo"/>
			<Set>CmtCod=312</Set>
			<Quote name="BokAccPro"/>
			<Set>BokFlg=1</Set>
			<Quote name="SndThdPro"/>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461503" desc="完全手工录入">
		<Quote name="PntSqlLst"/>
		<Attributes>
			<Attribute name="integrity" value="2" code="461599"/>  <!-- 条件冲正-->
			<Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
		</Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Set>PTCrpHD=SUBSTR($TVchId,1,2)</Set>
			<Exec func="PUB:ReadRecord" error="IGNORE">    <!--zhongshan 20090520add-->
         <Arg name="SqlCmd" value="QryPRGX"/> 
      </Exec>			
			<!--zhongshan add-->
			<Set>BilSts=U</Set>
			<Set>CmdCod=317</Set>
			<Set>TxnTyp=N</Set>
			<Set>OIFlag=O</Set>
			<Set>TxnAmt=ADDCHAR(MUL(ADD($BilAmt,$PenAmt),100),15,0,1)</Set><!--zs0309add MUL-->
			<!--end-->
			<Exec func="PFA:GenPrvData">
				<Arg name="PrjNum" value="PrjNum" desc="收费项目笔数"/>
				<Arg name="GrpNam" value="PrjRec" desc="收费项目结构"/>
				<Arg name="RmkNum" value="RmkNum" desc="额外信息笔数"/>
				<Arg name="GrpNam" value="RmkRec" desc="额外信息结构"/>
			</Exec>
			<Set>BilSts=U</Set>
			<Exec func="PUB:GetLogNo"/>
			<Set>CmtCod=317</Set>
			<Exec func="PUB:InsertRecord">   <!--zhongshan add-->
			  <Args>
			    <Arg name="tablename" value="PntTxnBok"/>
			  </Args>
		  </Exec>			
			<Quote name="BokAccPro"/>
			<!--zhongshan add-->
			<If condition="IS_EQUAL_STRING($BilSts,B)">   <!--记帐成功-->
			  <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
             <Arg name="SqlCmd" value="UpdPJNum"/> 
        </Exec>
       <!-- end--> 			
			<Set>BokFlg=1</Set>
			<Quote name="SndThdPro"/>
		<!--zhongshan add-->
		</If>	
		<Else>
				<Set>MsgTyp=E</Set>
		</Else>
		<!--end-->
		</FlowCtrl>
	</Transaction>


	<Transaction code="461504" desc="不需要手工录入">
		<Quote name="PntSqlLst"/>
		<Attributes>
			<Attribute name="integrity" value="2" code="461599"/>  <!-- 条件冲正-->
		</Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PUB:GetLogNo"/>
			<Set>PTCrpHD=SUBSTR($TVchId,1,2)</Set>
			<Exec func="PUB:ReadRecord" error="IGNORE">    <!--zhongshan 20090520add-->
         <Arg name="SqlCmd" value="QryPRGX"/> 
      </Exec>			
			<Set>BilSts=U</Set>
			<Set>CmdCod=313</Set>
			<Set>TxnTyp=N</Set>
			<Set>OIFlag=O</Set>
			<Set>TxnAmt=ADDCHAR(MUL(ADD($BilAmt,$PenAmt),100),15,0,1)</Set><!--zs0309add MUL-->
			<Exec func="PFA:GenPrvData">
				<Arg name="PrjNum" value="PrjNum" desc="收费项目笔数"/>
				<Arg name="GrpNam" value="PrjRec" desc="收费项目结构"/>
				<Arg name="RmkNum" value="RmkNum" desc="额外信息笔数"/>
				<Arg name="GrpNam" value="RmkRec" desc="额外信息结构"/>
			</Exec>									
			<Exec func="PUB:InsertRecord">   <!--zhongshan add-->
			  <Args>
			    <Arg name="tablename" value="PntTxnBok"/>
			  </Args>
		  </Exec>			
			<Quote name="BokAccPro"/>
			<If condition="IS_EQUAL_STRING($BilSts,B)">   <!--记帐成功-->			
			  <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
             <Arg name="SqlCmd" value="UpdPJNum"/> 
        </Exec>        
				<Set>BokFlg=1</Set>
				<Set>CmtCod=313</Set>
				<Quote name="SndThdPro"/>
			</If>
			<Else>
				<Set>MsgTyp=E</Set>
			</Else>
		</FlowCtrl>
	</Transaction>



	<Transaction code="461505" desc="冲正缴费">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="sql" value="GetTxnJnlByTBilNo"/>
			</Exec>
			<If condition="INTCMP(~RetCod,3,-1)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=数据库查询失败</Set>
				<Return/>
			</If>
			<If condition="INTCMP(~RetCod,3,-2)">   <!--原记录不存在-->
				<Set>MsgTyp=N</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=STRCAT(缴费记录【,$TCrpCd,-,$TVchId,-,$TBilTp,-,$TBilNo,】不存在)</Set>
				<Return/>
			</If>               
			<If condition="IS_NOEQUAL_STRING($ActDat,$OActDat)">   <!--记帐日与会计日不符-->
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=STRCAT(缴费日期【,$OActDat,-,$ActDat,】非同一会计日期，不能冲正)</Set>
				<Return/>
			</If>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="TxnCod" value="314"/>
				<Arg name="ObjSvr" value="STHDPNT1"/>
			</Exec>
			<Switch expression="~RetCod">
				<Case value="0"> <!--交易成功-->
					<Quote name="CanAccPro"/>
					<Set>MsgTyp=N</Set>
					<Set>RspCod=000000</Set>
					<Break/>
				</Case>
				<Case value="3">  <!--交易失败-->
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Break/>
				</Case>
				<Case value="-2"/>  <!--系统错误-->
				<Case value="-10">  <!--未发送-->
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Set>RspMsg=网络故障,稍后请重做交易</Set>
					<Break/>
				</Case>
				<Case value="-1">  <!--超时-->
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Set>RspMsg=交易超时,请联系业务管理部门</Set>
					<Break/>
				</Case>
				<Default>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Set>其他错误,请联系相关技术部门</Set>
					<Break/>
				</Default>
			</Switch>
		</FlowCtrl>
	</Transaction>



	<Transaction code="461506" desc="更换票据">
		<Quote name="PntSqlLst"/>
		<Attributes>
			<Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
		</Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Set>BokFlg=0</Set>
			<Set>CmtCod=315</Set>
		<Exec func="PUB:CallThirdOther" error="IGNORE">
			<Arg name="TxnCod" value="$CmtCod"/>
			<Arg name="ObjSvr" value="STHDPNT1"/>
		</Exec>
		<Switch expression="~RetCod">
			<Case value="0"> <!--交易成功-->
        <Exec func="PUB:ReadRecord" error="IGNORE">    <!--zhongshan add-->
             <Arg name="SqlCmd" value="GetLog"/> 
        </Exec>   
			  <If condition="INTCMP(~RetCod,3,-1)">
				  <Set>MsgTyp=E</Set>
				  <Set>RspCod=PNT999</Set>
				  <Set>RspMsg=数据库查询失败</Set>
				  <Return/>
			  </If>
			  <If condition="INTCMP(~RetCod,3,-2)">   <!--原记录不存在-->
				  <Set>MsgTyp=N</Set>
				  <Set>RspCod=PNT999</Set>
				  <Set>RspMsg=STRCAT(缴费记录【,$TCrpCd,-,$TVchId,-,$TBilTp,-,$TBilNo,】不存在)</Set>
				  <Return/>
			  </If>
        <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
          <Arg name="SqlCmd" value="UpdTxnBok"/> 
        </Exec>        
        
        <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
          <Arg name="SqlCmd" value="UpdTxnJnl"/> 
        </Exec>     
        
        <Exec func="PUB:ExecSql" error="IGNORE">    <!--zhongshan add-->
          <Arg name="SqlCmd" value="InsPJNum"/> 
        </Exec>
        <Set>MsgTyp=N</Set>
			  <Set>RspCod=000000</Set>                        
				<Break/>
			</Case>
			<Case value="-10"/>  <!--未发送-->
			  <Set>MsgTyp=E</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=网络故障,稍后请重做交易</Set>
			<Case value="-2">  <!--系统错误-->
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=系统错误</Set>
				<Break/>
			</Case>
			<Case value="3">  <!--交易失败-->
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=交易失败</Set>
				<Break/>
			</Case>
			<Case value="-1">  <!--超时-->
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=交易超时</Set>
				<Break/>
			</Case>
			<Default>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=其他错误,请联系相关技术部门</Set>
				<Break/>
			</Default>
		</Switch>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461507" desc="作废票据">
		<Quote name="PntSqlLst"/>
		<Attributes>
			<Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
		</Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Set>BokFlg=0</Set>
			<Set>ThdCod=316</Set>
			<Quote name="SndThdPro"/>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461508" desc="银行系统产生的收款信息文件">
		<Quote name="PntSqlLst"/>
		<DynSentence name="GetChkDtl">
			<Sentence>
				select TCrpCd,TVchId,TBilTp,TBilNo,TxnAmt from PntTxnJnl where ActDat='%s' and BilSts='S'
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		<!--zhongshan add-->
		<DynSentence name="GetTot">
			<Sentence>
				select sum(cast(txnamt as bigint)) as TotAmt,coalesce(COUNT(*),0) TotNum from PntTxnJnl where ActDat='%s' and BilSts='S'
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="InitTran"/>
<!--获取批次号-->
			<Exec func="PUB:nGetPubSeqNo">
				<Arg name="SeqNam" value="Pnt:SelVal"/>
				<Arg name="SeqCnt" value="1"/>
				<Arg name="Len"    value="2"/>
				<Arg name="CycCnd" value="D"/>
			</Exec>
			<Set>FilNam=STRCAT(YHSK,$BankCd,$ActDat,$SelVal,.txt)</Set> <!--zhongshan modify WordDt for ActDat-->
			<Set>DatFil=STRCAT($PntSndDir,yhsc/,$FilNam )</Set> 
<!--为避免同一分行并发-->
			<Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="sql" value="GetTot"/>
			</Exec>
<!--文件头-->
			<Exec func="PUB:WriteFile" error="IGNORE">
				<Arg name="FileName" value="$DatFil"/>
				<Arg name="OpenMode" value="w"/>				
				<Arg name="Data"	   value="$BankCd"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$ActDat"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$TotNum"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="AMTSIMPLEFMT($TotAmt)"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="ESCFMT"   value="\\n"/>
				<Arg name="ESCFMT"   value="\\n"/> <!--zhongshan add-->
			</Exec>
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql" value="GetChkDtl"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标【GetChkDtl】出错</Set>
				<Return/>
			</If>
			<Set>Num=0</Set>
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/>
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<Exec func="PUB:WriteFile" error="IGNORE">
					<Arg name="FileName" value="$DatFil"/>
					<Arg name="OpenMode" value="a+"/>
				  <Arg name="Data"	   value="$TCrpCd"/> 
				  <Arg name="Data"	   value="|"/>
				  <Arg name="Data"	   value="$TVchId"/> 
				  <Arg name="Data"	   value="|"/>					
					<Arg name="Data"	   value="$TBilTp"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$TBilNo"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="AMTSIMPLEFMT($TxnAmt)"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="ESCFMT"   value="\\n"/>
				</Exec>
			</While>
			<Set>ObjFil=$FilNam</Set>   <!--zhongshan add-->
			<Set>LclFil=$FilNam</Set>   <!--zhongshan add-->
			<Exec func="PUB:FtpPut">
				<Arg name="FtpId" value="PNT003"/>
			</Exec>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>


	<Transaction code="461509" desc="非税系统产生的收款问题账务信息文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<!--zhongshan add-->
		<Quote name="InitTran"/>
		<!--获取批次号-->
			<Exec func="PUB:nGetPubSeqNo">
				<Arg name="SeqNam" value="Pntwt:SelVal"/>
				<Arg name="SeqCnt" value="1"/>
				<Arg name="Len"    value="2"/>
				<Arg name="CycCnd" value="D"/>
			</Exec>
			<Set>LclFil=STRCAT(WTZW442000010,$ActDat,$SelVal,.txt)</Set>
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT002"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
	    <!--end-->
			<Set>DatFil=STRCAT( $PntRcvDir,wtzw/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="WTZWHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<!--zhongshan add -->
			<Exec func="PUB:GetFileLine" error="IGNORE">
        <Arg name="FieldName" value="DatFNms"/>
      </Exec>
      <!--end-->
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="WTZWTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($TitNum,3,$DtlNum)">
						<Break/>
					</If>
					<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
						<Arg name="ConfigName" value="BatFormat"/>
						<Arg name="RootName"   value="BATCH"/>
						<Arg name="NodeName"   value="Process"/>
						<Arg name="AttrName"   value="name"/>
						<Arg name="AttrValue"  value="WTZWDATA"/>
						<Arg name="MaxLen"     value="100000"/>
					</Exec>
				  <Exec func="PUB:InsertRecord">   <!--zhongshan add-->
			     <Args>
				       <Arg name="tablename" value="PntWtzw"/>
			     </Args>
		      </Exec>
					<Set>DtlNum=ADD($DtlNum,1)</Set>
				</While>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>



	<Transaction code="461510" desc="非税系统产生的批量扣收指令信息文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
			<Set>DatFil=STRCAT( $PntSndDir,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="PLKSHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLine" error="IGNORE">
					<Arg name="FieldName" value="LinData"/>
				</Exec>
				<Exec func="PNT:GenDBCol">
					<Arg name="LinData" value="$LinData" desc="行记录"/>
				</Exec>
				<Exec func="PFA:GenPrvData">
					<Arg name="PrjNum" value="PrjNum" desc="收费项目笔数"/>
					<Arg name="PrjGrp" value="PrjRec" desc="收费项目结构"/>
					<Arg name="RmkNum" value="RmkNum" desc="额外信息笔数"/>
					<Arg name="RmkGrp" value="RmkRec" desc="额外信息结构"/>
				</Exec>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>

	<Transaction code="461511" desc="非税系统产生的财政专户分成信息文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<Quote name="InitTran"/>
			<Set>LclFil=STRCAT(FCCZ4420000108484833,$ActDat,.txt)</Set>
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT004"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
			<Set>DatFil=STRCAT( $PntRcvDir,fcxx/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="FCCZHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<!--读空行-->
			<Exec func="PUB:GetFileLine" error="IGNORE">
        <Arg name="FieldName" value="DatFNms"/>
      </Exec>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="FCCZTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($TitNum,3,$DtlNum)">
						<Break/>
					</If>
					<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
						<Arg name="ConfigName" value="BatFormat"/>
						<Arg name="RootName"   value="BATCH"/>
						<Arg name="NodeName"   value="Process"/>
						<Arg name="AttrName"   value="name"/>
						<Arg name="AttrValue"  value="FCCZDATA"/>
						<Arg name="MaxLen"     value="100000"/>
					</Exec>
				  <Exec func="PUB:InsertRecord">   <!--zhongshan add-->
			     <Args>
				       <Arg name="tablename" value="PntFccz"/>
			     </Args>
		      </Exec>
					<Set>DtlNum=ADD($DtlNum,1)</Set>					
				</While>
			  <!--读空行-->
			  <Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNms"/>
        </Exec>				
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="461512" desc="非税系统产生的国库分成信息文件">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<Quote name="InitTran"/>
			<Set>LclFil=STRCAT(FCGK4420000108484833,$ActDat,.txt)</Set>
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT004"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
			<Set>DatFil=STRCAT( $PntRcvDir,fcxx/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="FCGKHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<!--读空行-->
			<Exec func="PUB:GetFileLine" error="IGNORE">
        <Arg name="FieldName" value="DatFNms"/>
      </Exec>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="FCGKTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($TitNum,3,$DtlNum)">
						<Break/>
					</If>
					<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
						<Arg name="ConfigName" value="BatFormat"/>
						<Arg name="RootName"   value="BATCH"/>
						<Arg name="NodeName"   value="Process"/>
						<Arg name="AttrName"   value="name"/>
						<Arg name="AttrValue"  value="FCGKDATA"/>
						<Arg name="MaxLen"     value="100000"/>
					</Exec>
				  <Exec func="PUB:InsertRecord">   <!--zhongshan add-->
			     <Args>
				       <Arg name="tablename" value="PntFcgk"/>
			     </Args>
		      </Exec>
					<Set>DtlNum=ADD($DtlNum,1)</Set>
				</While>
				<!--读空行-->
			  <Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNms"/>
        </Exec>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>	

	<Transaction code="461513" desc="银行系统产生的财政专户达账信息文件">
		<Quote name="PntSqlLst"/>
		<DynSentence name="GetTit">
			<Sentence>
				select CityCd,ActNo,ActNam,ActBnk,sum(cast(dtlamt as bigint)) as TitAmt,coalesce(COUNT(*),0) TitNum  from pntfccz where TxnDat='%s' and DtlSts='2' group by CityCd,ActNo,ActNam,ActBnk
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		<!--zhongshan add-->
		<DynSentence name="GetTot">
			<Sentence>
				select BankCd,RcvAct,sum(cast(dtlamt as bigint)) as TotAmt,coalesce(COUNT(*),0) TotNum from Pntfccz where TxnDat='%s' and DtlSts='2'  group by BankCd,RcvAct
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		
	  <DynSentence name="GetDat">
			<Sentence>
				select TCrpCd,TCrpNm,PrjCod,PrjNam,DtlAmt from pntfccz where actno='%s' and TxnDat='%s' and dtlsts='2'
			</Sentence>
			<Fields>ActNo|ActDat|</Fields>
		</DynSentence>
		
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Set>FilNam=STRCAT(DZCZ,$BankCd,$RcvAct,$ActDat,.txt)</Set> <!--zhongshan modify WordDt for ActDat-->
			<Set>DatFil=STRCAT($PntSndDir,yhsc/,$FilNam )</Set> 
<!--为避免同一分行并发-->
			<Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="sql" value="GetTot"/>
			</Exec>
<!--文件头-->
			<Exec func="PUB:WriteFile" error="IGNORE">
				<Arg name="FileName" value="$DatFil"/>
				<Arg name="OpenMode" value="w"/>				
				<Arg name="Data"	   value="$BankCd"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$RcvAct"/> 
				<Arg name="Data"	   value="|"/>				
				<Arg name="Data"	   value="$ActDat"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$TotNum"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="AMTSIMPLEFMT($TotAmt)"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="ESCFMT"   value="\\n"/>
				<Arg name="ESCFMT"   value="\\n"/> <!--zhongshan add-->
			</Exec>
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql" value="GetTit"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标【GetTit】出错</Set>
				<Return/>
			</If>
			<Set>Num=0</Set>
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/>
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<Exec func="PUB:WriteFile" error="IGNORE">
					<Arg name="FileName" value="$DatFil"/>
					<Arg name="OpenMode" value="a+"/>
				  <Arg name="Data"	   value="$CityCd"/> 
				  <Arg name="Data"	   value="|"/>
				  <Arg name="Data"	   value="$TitNum"/> 
				  <Arg name="Data"	   value="|"/>					
					<Arg name="Data"	   value="AMTSIMPLEFMT($TitAmt)"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$ActNam"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$ActBnk"/> 
					<Arg name="Data"	   value="|"/>	
					<Arg name="Data"	   value="$ActNo"/> 
					<Arg name="Data"	   value="|"/>									
					<Arg name="ESCFMT"   value="\\n"/>
				</Exec>
			  <Exec func="PUB:OpenCursor" error="IGNORE">
			  	<Arg name="sql" value="GetDat"/>
			  	<Arg name="CursorName" value="CURSOR_2"/>
			  </Exec>
			  <If condition="~RetCod!=0">
			  	<Set>MsgTyp=E</Set>
			  	<Set>RspCod=PFA999</Set>
			  	<Set>RspMsg=打开游标【GetDat】出错</Set>
			  	<Return/>
			  </If>
			  <Set>Num=0</Set>
			  <While>
			  	<Exec func="PUB:FetchCursor" error="IGNORE">
			  	  <Arg name="CursorName" value="CURSOR_2"/>
			  	</Exec>
			  	<If condition="~RetCod=100">
			  		<Break/>
			  	</If>
			  	<Exec func="PUB:WriteFile" error="IGNORE">
			  		<Arg name="FileName" value="$DatFil"/>
			  		<Arg name="OpenMode" value="a+"/>
			  	  <Arg name="Data"	   value="$TCrpCd"/> 
			  	  <Arg name="Data"	   value="|"/>
			  	  <Arg name="Data"	   value="$TCrpNm"/> 
			  	  <Arg name="Data"	   value="|"/>					
			  		<Arg name="Data"	   value="$PrjCod"/> 
			  		<Arg name="Data"	   value="|"/>
			  		<Arg name="Data"	   value="$PrjNam"/> 
			  		<Arg name="Data"	   value="|"/>
			  		<Arg name="Data"	   value="AMTSIMPLEFMT($DtlAmt)"/> 
			  		<Arg name="Data"	   value="|"/>									
			  		<Arg name="ESCFMT"   value="\\n"/>
			  	</Exec>
			  </While>
			  <Exec func="PUB:WriteFile" error="IGNORE">
			  	  <Arg name="FileName" value="$DatFil"/>
			  	  <Arg name="OpenMode" value="a+"/>
			  	  <Arg name="ESCFMT"   value="\\n"/>
			  </Exec>
			  <Exec func="PUB:CloseCursor" error="IGNORE">
			      <Arg name="CursorName" value="CURSOR_2"/>
			  </Exec>
			</While>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Set>ObjFil=$FilNam</Set>   <!--zhongshan add-->
			<Set>LclFil=$FilNam</Set>   <!--zhongshan add-->
			<Exec func="PUB:FtpPut">
				<Arg name="FtpId" value="PNT003"/>
			</Exec>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="461514" desc="银行系统产生的国库专户达账信息文件">
		<Quote name="PntSqlLst"/>
		<DynSentence name="GetTit">
			<Sentence>
				select CityCd,ActNo,ActNam,ActBnk,sum(cast(dtlamt as bigint)) as TitAmt,coalesce(COUNT(*),0) TitNum  from pntfcgk where TxnDat='%s' and DtlSts='2' group by CityCd,ActNo,ActNam,ActBnk
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		<!--zhongshan add-->
		<DynSentence name="GetTot">
			<Sentence>
				select BankCd,RcvAct,sum(cast(dtlamt as bigint)) as TotAmt,coalesce(COUNT(*),0) TotNum from Pntfcgk where TxnDat='%s' and DtlSts='2'  group by BankCd,RcvAct
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		
	  <DynSentence name="GetDat">
			<Sentence>
				select SubCod,SubNam,PrjCod,PrjNam,DtlAmt from pntfcgk where actno='%s' and TxnDat='%s' and dtlsts='2'
			</Sentence>
			<Fields>ActNo|ActDat|</Fields>
		</DynSentence>
		
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Set>FilNam=STRCAT(DZGK,$BankCd,$RcvAct,$ActDat,.txt)</Set> 
			<Set>DatFil=STRCAT($PntSndDir,yhsc/,$FilNam )</Set> 
<!--为避免同一分行并发-->
			<Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="sql" value="GetTot"/>
			</Exec>
<!--文件头-->
			<Exec func="PUB:WriteFile" error="IGNORE">
				<Arg name="FileName" value="$DatFil"/>
				<Arg name="OpenMode" value="w"/>				
				<Arg name="Data"	   value="$BankCd"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$RcvAct"/> 
				<Arg name="Data"	   value="|"/>				
				<Arg name="Data"	   value="$ActDat"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="$TotNum"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="Data"	   value="AMTSIMPLEFMT($TotAmt)"/> 
				<Arg name="Data"	   value="|"/>
				<Arg name="ESCFMT"   value="\\n"/>
				<Arg name="ESCFMT"   value="\\n"/> <!--zhongshan add-->
			</Exec>
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql" value="GetTit"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标【GetTit】出错</Set>
				<Return/>
			</If>
			<Set>Num=0</Set>
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/>
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<Exec func="PUB:WriteFile" error="IGNORE">
					<Arg name="FileName" value="$DatFil"/>
					<Arg name="OpenMode" value="a+"/>
				  <Arg name="Data"	   value="$CityCd"/> 
				  <Arg name="Data"	   value="|"/>
				  <Arg name="Data"	   value="$TitNum"/> 
				  <Arg name="Data"	   value="|"/>					
					<Arg name="Data"	   value="AMTSIMPLEFMT($TitAmt)"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$ActNam"/> 
					<Arg name="Data"	   value="|"/>
					<Arg name="Data"	   value="$ActBnk"/> 
					<Arg name="Data"	   value="|"/>	
					<Arg name="Data"	   value="$ActNo"/> 
					<Arg name="Data"	   value="|"/>									
					<Arg name="ESCFMT"   value="\\n"/>
				</Exec>
			  <Exec func="PUB:OpenCursor" error="IGNORE">
			  	<Arg name="sql" value="GetDat"/>
			  	<Arg name="CursorName" value="CURSOR_2"/>
			  </Exec>
			  <If condition="~RetCod!=0">
			  	<Set>MsgTyp=E</Set>
			  	<Set>RspCod=PFA999</Set>
			  	<Set>RspMsg=打开游标【GetDat】出错</Set>
			  	<Return/>
			  </If>
			  <Set>Num=0</Set>
			  <While>
			  	<Exec func="PUB:FetchCursor" error="IGNORE">
			  	  <Arg name="CursorName" value="CURSOR_2"/>
			  	</Exec>
			  	<If condition="~RetCod=100">
			  		<Break/>
			  	</If>
			  	<Exec func="PUB:WriteFile" error="IGNORE">
			  		<Arg name="FileName" value="$DatFil"/>
			  		<Arg name="OpenMode" value="a+"/>
			  	  <Arg name="Data"	   value="$SubCod"/> 
			  	  <Arg name="Data"	   value="|"/>
			  	  <Arg name="Data"	   value="$subNam"/> 
			  	  <Arg name="Data"	   value="|"/>					
			  		<Arg name="Data"	   value="$PrjCod"/> 
			  		<Arg name="Data"	   value="|"/>
			  		<Arg name="Data"	   value="$PrjNam"/> 
			  		<Arg name="Data"	   value="|"/>
			  		<Arg name="Data"	   value="AMTSIMPLEFMT($DtlAmt)"/> 
			  		<Arg name="Data"	   value="|"/>									
			  		<Arg name="ESCFMT"   value="\\n"/>
			  	</Exec>
			  </While>
			  <Exec func="PUB:WriteFile" error="IGNORE">
			  	  <Arg name="FileName" value="$DatFil"/>
			  	  <Arg name="OpenMode" value="a+"/>
			  	  <Arg name="ESCFMT"   value="\\n"/>
			  </Exec>
			  <Exec func="PUB:CloseCursor" error="IGNORE">
			      <Arg name="CursorName" value="CURSOR_2"/>
			  </Exec>
			</While>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Set>ObjFil=$FilNam</Set>   <!--zhongshan add-->
			<Set>LclFil=$FilNam</Set>   <!--zhongshan add-->
			<Exec func="PUB:FtpPut">
				<Arg name="FtpId" value="PNT003"/>
			</Exec>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>	

	<Transaction code="461517" desc="非税系统基础数据文件导入">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		<Quote name="InitTran"/>
		<!--获取批次号-->
		  
			<Set>LclFil=STRCAT(JCSJ,$ActDat,.txt)</Set>  
			<Set>ObjFil=$LclFil</Set>
			<Exec func="PUB:FtpGet">
				<Arg name="FtpId" value="PNT001"/>
			</Exec>		
			<Set>FilNam=$LclFil</Set>
			<Set>DatFil=STRCAT( $PntRcvDir,jcsj/,$FilNam )</Set>
			<Exec func="PUB:OpenFile">
				<Arg name="FileName"   value="$DatFil"/>
				<Arg name="Mode"       value="r"/>
			</Exec>
<!--读取文件头-->
			<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
				<Arg name="ConfigName" value="BatFormat"/>
				<Arg name="RootName"   value="BATCH"/>
				<Arg name="NodeName"   value="Process"/>
				<Arg name="AttrName"   value="name"/>
				<Arg name="AttrValue"  value="JCSJHEAD"/>
				<Arg name="MaxLen"     value="100000"/>
			</Exec>
			<If condition="INTCMP($TotNum,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
			</If>
			<Set>DatNum=0</Set>
			<While>
				<If condition="INTCMP($TotNum,3,$DatNum)">
					<Break/>
				</If>
				<Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNms"/>
        </Exec>
				<Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					<Arg name="ConfigName" value="BatFormat"/>
					<Arg name="RootName"   value="BATCH"/>
					<Arg name="NodeName"   value="Process"/>
					<Arg name="AttrName"   value="name"/>
					<Arg name="AttrValue"  value="JCSJTITLE"/>
					<Arg name="MaxLen"     value="100000"/>
				</Exec>
				<Set>DtlNum=0</Set>
				<While>
					<If condition="INTCMP($NodeNum,3,$DtlNum)">
						<Break/>
					</If>						
					 <Switch expression="$NodeId"> 
					  <!--收费项目-->				
					  <Case value="SFXM">	
            <!--If condition="IS_EQUAL_STRING($NodeId,SFXM)"-->			
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="SFXMDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   
			            <Args>
				              <Arg name="tablename" value="PntSfxm"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_sfxm"/>
                 </Exec>
		           </If>
		           <Break/>
		        </Case>   
		        <!--/If-->
		        <!--单位信息-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,DWXX)"-->
					  <Case value="DWXX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="DWXXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="Pntdwxx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_dwxx"/>
                 </Exec>
		           </If>
		           <Break/>
		        </Case>   
		        <!--/If-->		  
		        <!--单位项目-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,DWXM)"-->
					  <Case value="DWXM">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="DWXMDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntDwxm"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,3)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Delete_dwxm"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>   
		        <!--/If-->		
		        <!--票据类型-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,PJLX)"-->
					  <Case value="PJLX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="PJLXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntPjlx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_pjlx"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>   
		        <!--/If-->		
		        <!--票据发放-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,PJFF)"-->
					  <Case value="PJFF">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="PJFFDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">		
					       <Set>TBilSts=1</Set>	
					       <Set>TBilReSts=1</Set>				     			
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntPjff"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,3)">	
		             <Set>TBilSts=3</Set>		           				
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_pjff"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>   
		        <!--/If-->
		        <!--项目票据-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,XMPJ)"-->
					  <Case value="XMPJ">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="XMPJDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntXmpj"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,3)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Delete_xmpj"/>
                 </Exec>
		           </If>		           
		           <Break/>
		        </Case>
		        <!--/If-->	
		        <!--区域信息-->
					  <!--If condition="IS_EQUAL_STRING($NodeId,QYXX)"-->
					  <Case value="QYXX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="QYXXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntQyxx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_qyxx"/>
                 </Exec>
		           </If>		            
		           <Break/>
		        </Case>        
					  <Case value="PRGX">
					     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
					     	<Arg name="ConfigName" value="BatFormat"/>
					     	<Arg name="RootName"   value="BATCH"/>
					     	<Arg name="NodeName"   value="Process"/>
					     	<Arg name="AttrName"   value="name"/>
					     	<Arg name="AttrValue"  value="PRGXDATA"/>
					     	<Arg name="MaxLen"     value="100000"/>
					     </Exec>
					     <If condition="IS_EQUAL_STRING($SynChType,1)">					
				         <Exec func="PUB:InsertRecord" error="IGNORE">   <!--zhongshan add-->
			            <Args>
				              <Arg name="tablename" value="PntPrgx"/>
			            </Args>
		             </Exec>
		           </If>
		           <If condition="IS_EQUAL_STRING($SynChType,2)">					
				         <Exec func="PUB:ExecSql" error="IGNORE">   
                   <Arg name="SqlCmd" value="Update_prgx"/>
                 </Exec>
		           </If>		            
		           <Break/>
		        </Case>             		             
		        <!--/If-->
		        <Default>
		          <Break/>
		        </Default>	
		       </Switch>
            <Set>DtlNum=ADD($DtlNum,1)</Set>
				</While>
				<Set>DatNum=ADD($DatNum,1)</Set>
			</While>
		</FlowCtrl>
	</Transaction>
	
  <Transaction code="461518" desc="非税系统信息打印">
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <Set>ActDat=20090413</Set>
      <Switch expression="$RptTyp">
        <Case value="1">
          <Set>FilNam=STRCAT(PNT001,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT001_RPT.XML)</Set>
          <Set>RptHead=非税业务问题账务</Set>
          <Set>Summary=打印非税业务问题账务</Set>
          <Break/>
        </Case>
        <Case value="2">
          <Set>FilNam=STRCAT(PNT002,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT002_RPT.XML)</Set>
          <Set>RptHead=非税业务财政专户分成信息文件</Set>
          <Set>Summary=打印非税业务财政专户分成信息</Set>
          <Break/>
        </Case>
        <Case value="3">
          <Set>FilNam=STRCAT(PNT003,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT003_RPT.XML)</Set>
          <Set>RptHead=非税业务国库分成信息文件</Set>
          <Set>Summary=打印非税业务国库分成信息</Set>
          <Break/>
        </Case>     
        <Case value="4">
          <Set>FilNam=STRCAT(PNT004,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT004_RPT.XML)</Set>
          <Set>RptHead=非税业务财政专户达账信息文件</Set>
          <Set>Summary=打印非税业务财政专户达账信息</Set>
          <Break/>
        </Case>
        <Case value="5">
          <Set>FilNam=STRCAT(PNT005,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT005_RPT.XML)</Set>
          <Set>RptHead=非税业务国库达账信息文件</Set>
          <Set>Summary=打印非税业务国库达账信息</Set>
          <Break/>
        </Case>  
        <Case value="6">
          <Set>FilNam=STRCAT(PNT006,$TlrId,.RPT)</Set>
          <Set>FmtFil=STRCAT(etc/,PNT006_RPT.XML)</Set>
          <Set>RptHead=非税业务收款信息文件</Set>
          <Set>Summary=打印非税收款信息</Set>
          <Break/>
        </Case>                           
		    <Default>
		      <Break/>
		    </Default>        
      </Switch>    
      <Exec func="EXT:GenerateReport">
        <Arg name="RptName" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="RptFile" value="$FmtFil" />
        <Arg name="RptHead" value="$RptHead"/>
        <Arg name="TxnDat"  value="$TxnDat"/>
      </Exec>

      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>	
	
  <Transaction code="461519" desc="查询票据">
    <DynSentence name="QryPJNum">
      <Sentence>
        select TBilSts from pntpjnum where TBilTp='%s' and TBilNo='%s' and TBilNod='%s'
      </Sentence>
      <Fields>TBilTp|TBilNo|NodNo|</Fields>
    </DynSentence>    
    <DynSentence name="UpdPJNumSts">
      <Sentence>
        update pntpjff set TBilSts='2' where TBilTp='%s' and TBilNo='%s'
      </Sentence>
      <Fields>TBilTp|TBilNo|</Fields>
    </DynSentence>  
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
             <!--检查交易并发-->
       <Set>RecKey=STRCAT($AplCls,:,$BusTyp)</Set>
       <Exec func="PUB:Lock">
            <Arg name="RecKey" value="$RecKey"/>
            <Arg name="TimOut" value="1000"/>
            <Arg name="AutoUnlock" value="yes"/>
       </Exec>
       <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="QryPJNum" />
        </Args>
       </Exec> 
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="~RetCod=-2">
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=此票据号码不存在</Set>
        <Return/>
      </If>  
      <If condition="IS_EQUAL_STRING($TBilSts,2)">
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=此票据已经使用</Set>
        <Return/>        
      </If>                   
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>    
      <Exec func="PUB:Unlock">          <!--处理完毕，解锁-->
        <Arg name="RecKey" value="$RecKey"/>
      </Exec>                                 
    </FlowCtrl>
  </Transaction>	
  
	<Transaction code="461520" desc="分解票据">
	  <Quote name="PntSqlLst"/>
    <DynSentence name="QryPJCnt">
      <Sentence>
         select count(*) as TBilCnt from pntpjff where TBilReSts='1' 
      </Sentence>
    </DynSentence>  
    <DynSentence name="QryPJTB">
      <Sentence>
         select TBilTp,TBilStar,TBilEnd,TBilTot,TBilSts from pntpjff where TBilReSts='1' 
      </Sentence>
    </DynSentence>    		 
    <DynSentence name="InsertPJInf">
      <Sentence>
        insert into PntPjNum (TBilTp,TBilNo,TBilSts,TBilFFSts) values ('%s','%s','1','1')
      </Sentence>
      <Fields>TBilTp|TBilNo|</Fields>
    </DynSentence>     
    <DynSentence name="UpdPJSts">
      <Sentence>
        update PntPjff set TBilReSts='2' where TBilTp='%s' and TBilStar='%s' and TBilEnd='%s' and TBilTot='%s' and TBilSts='%s'
      </Sentence>
      <Fields>TBilTp|TBilStar|TBilEnd|TBilTot|TBilSts|</Fields>
    </DynSentence>     		
		<FlowCtrl>
		<Quote name="InitTran"/>
    <Exec func="PUB:ReadRecord" error="IGNORE">
      <Args>
        <Arg name="SqlCmd" value="QryPJCnt" />
      </Args>
    </Exec>
    <If condition="~RetCod=-1">
      <Exec func="PUB:RollbackWork" error="IGNORE" />
      <Set>MsgTyp=E</Set>
      <Set>RspCod=PNT999</Set>
      <Set>RspMsg=数据库查询失败</Set>
      <Return/>
    </If>
    <If condition="~RetCod=-2">
      <Set>MsgTyp=E</Set>
      <Set>RspCod=PNT999</Set>
      <Set>RspMsg=票据类型不存在</Set>
      <Return/>
    </If>       	
		<If condition="INTCMP($TBilCnt,3,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Return/>
		</If>
    <Exec func="PUB:OpenCursor" error="IGNORE">
      <Arg name="sql" value="QryPJTB"/>
    </Exec>
    <If condition="~RetCod!=0">
      <Set>MsgTyp=E</Set>
      <Set>RspCod=PFA999</Set>
      <Set>RspMsg=打开游标【QryPJTB】出错</Set>
      <Return/>
    </If>		
		<!--Set>TBNum=0</Set-->
		<While>
		  <!--If condition="INTCMP($TBilCnt,3,$TBNum)">
				<Break/>
		  </If-->
			<Exec func="PUB:FetchCursor" error="IGNORE"/>
			<If condition="~RetCod=100">
				<Break/>
			</If>		  
      <Set>TBSNum=0</Set>
      <Set>TBilNo=$TBilStar</Set>
      <While>
		     <If condition="INTCMP($TBilTot,3,$TBSNum)">
				   <Break/>
		     </If>         
         <Exec func="PUB:ExecSql">   
           <Arg name="SqlCmd" value="InsertPJInf"/>
         </Exec>   
         <If condition="~RetCod=-2">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=PNT999</Set>
           <Set>RspMsg=插入票据失败</Set>
           <Return/>
         </If>  
         <Set>$TBilNo=STRCAT(SUBSTR($TBilNo,1,SUB(STRLEN($TBilNo),STRLEN($TBilTot))),INTTOSTR(ADD(SUBSTR($TBilNo,ADD(SUB(STRLEN($TBilNo),STRLEN($TBilTot)),1),STRLEN($TBilTot)),1),STRLEN($TBilTot)))</Set>                
         <Set>$TBSNum=ADD($TBSNum,1)</Set>  
      </While>
      <Exec func="PUB:ExecSql">   
        <Arg name="SqlCmd" value="UpdPJSts"/>
      </Exec>   
      <If condition="~RetCod=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=更新票据状态失败</Set>
        <Return/>
      </If>          	  
		</While>
		<Exec func="PUB:CloseCursor"/>				   
		</FlowCtrl>
	</Transaction>  
	
	<Transaction code="461521" desc="非税系统批量扣收文件下载">
	  <Attributes>
       <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <Quote name="PntSqlLst"/>
		<DynSentence name="GetBatInf">
			<Sentence>
				SELECT b.CrpNam FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
				AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
			</Sentence>
			<Fields>CAgtNo|</Fields>
		</DynSentence>
		<DynSentence name="QueDskNam">
			<Sentence>
				SELECT DsKNo FROM pubbatinf WHERE ActDat='%s' AND DskNam='%s' AND Status='P'
			</Sentence>
			<Fields>ActDat|DskNam|</Fields>
		</DynSentence>
		<DynSentence name="QueFilNam">
			<Sentence>
				SELECT FileNo FROM pntfilctl WHERE ActDat='%s' AND FileNam='%s' and DskSts='2'
			</Sentence>
			<Fields>ActDat|DskNam|</Fields>
		</DynSentence>		
		<DynSentence name="SeleSql"> <!--取出相应的记录-->
      <Sentence>
       select ActNo,TCusNm,SeqNo from pntbatrec WHERE  DskNo='%s' and BrNo='%s' and RecSts='0'
      </Sentence>
      <Fields>DskNo|BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdBatRec">  <!--检查户名与身份证号码-->
			<Sentence>
				UPDATE pntbatrec a
				SET HRSPCD='%s',RecSts='X',IsTxn='N'
				WHERE DskNo='%s' and SeqNo='%s'
			</Sentence>
			<Fields>Rspcod|DskNo|SeqNo|</Fields>
		</DynSentence>
	  <DynSentence name="UpdFilSts">  <!--更新文件信息表-->
			<Sentence>
				UPDATE pntfilinf set Dsksts='2' where ActDat='%s' and FileNam='%s'
			</Sentence>
			<Fields>ActDat|DskNam|</Fields>
		</DynSentence>
		<FlowCtrl>
		<Quote name="InitTran"/>  
		  <Set>TxnObj=OFRTPNT1</Set>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="SqlCmd" value="QueDskNam"></Arg>
			</Exec>
			<If condition="~RetCod!=-2">
				<Set>RspCod=461521</Set>
				<Set>RspMsg=STRCAT(该批次已录入，批次号为,$DskNo)</Set>
				<Return/>
			</If>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="SqlCmd" value="QueFilNam"></Arg>
			</Exec>
			<If condition="~RetCod!=-2">
				<Set>RspCod=461521</Set>
				<Set>RspMsg=STRCAT(该文件已录入，文件号为,$FileNo)</Set>
				<Return/>
			</If>			
			<Set>RspCod=000000</Set>
			<Exec func="PUB:ReadModuleCfg">
				<Arg name="Application" value="$BrNo"/>
				<Arg name="Transaction" value="$CAgtNo"/>
			</Exec>
			<!--获取业务类型和单位名称  -->
			<Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="GetBatInf"></Arg>
			</Exec>
			<Call package="PNT" function="AFE_PNTBatByCnl"/>
			
			<Set>RspMsg=$RspCod</Set>
			
	 	 <!--If condition="AND(IS_EQUAL_STRING($RspCod,000000),IS_EQUAL_STRING($ChkNam,1))"-->
		 <If condition="AND(IS_EQUAL_STRING($RspCod,000000))">	
			
		 <!--If condition="INTCMP($TxnDir,3,1)">  代付,开始检查户名与身份证号-->
	       
	   <Exec func="PUB:OpenCursor">
      <Arg name="sql" value="SeleSql"/>
     </Exec>
     <While>
     <Exec func="PUB:FetchCursor" error="INGORE"/>
      <If condition="~RetCod=100">
           <Exec func="PUB:CloseCursor"/>
           <Break/>
       </If>
       <If condition="~RetCod!=0">
          <Exec func="PUB:CloseCursor" />
          <Return/>
       </If>
      <Set>TlrId=EZJYDK5</Set>
			<Set>CcyCod=CNY</Set>
			
			<Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
			<Call function="$AcJudFunc">
				<Input name="ActNo|NewFlg|"/>
				<Output name="OActNo|ActCls|"/>
			</Call>
			
			<Switch expression="$ActCls">
			  <Case value="0" /> <!-- 对公 -->
				<Case value="4" >
				  <Exec func="PUB:CallHostOther" error="IGNORE">
              <Arg name="HTxnCd" value="109000" />
              <Arg name="ObjSvr" value="SHSTPUB1" />
          </Exec>
				  <If condition="$MsgTyp!=N">
            <Set>RspCod=461599</Set>
            <Set>RspMsg=帐户不存在</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
					    <Arg name="SqlCmd" value="UpdBatRec"/>
		     	  </Exec>
		     	  <Break/>      
           </If>
           
           <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
           <If condition="IS_NOEQUAL_STRING($TCusNm,$ActNam)">
				      <Set>RspCod=461598</Set>
				      <Set>RspMsg=户名不符</Set>
			        <Exec func="PUB:ExecSql" error="IGNORE">
				      	 <Arg name="SqlCmd" value="UpdBatRec"/>
		          </Exec>  
		       </If>  -->    
				  <Break/>
				  </Case>
				<Case value="2" /> <!-- 对私 -->
				<Case value="3" />
				<Case value="5" >
				  <If condition="INTCMP($ActCls,3,3)">
					   <Set>ActTyp=4</Set>
					</If>
					<Else>
						 <Set>ActTyp=2</Set>
					</Else>
			    <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="HTxnCd" value="476520"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="$MsgTyp!=N">
            <Set>RspCod=461599</Set>
            <Set>RspMsg=帐户不存在</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
					    <Arg name="SqlCmd" value="UpdBatRec"/>
		     	  </Exec>
		     	  <Break/>  
          </If>
            <!--当户名与身份证均不等时-->
          <!--  
          <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
          <Set>IDNo=DELBOTHSPACE($IDNo)</Set>
          <Set>TIdNo=DELBOTHSPACE($TIdNo)</Set>
          <Set>RspMsg=$TCusNm</Set>
          <Set>RspMsg=$TIdNo</Set>
          <Set>RspMsg=$IDNo</Set>
			    <If condition="AND(IS_NOEQUAL_STRING($TCusNm,$ActNam),IS_NOEQUAL_STRING($TIdNo,$IDNo))">
             <Set>RspCod=461599</Set>
				     <Set>RspMsg=户名与证件号码均不符</Set>
			       <Exec func="PUB:ExecSql" error="IGNORE">
				   	    <Arg name="SqlCmd" value="UpdBatRec"/>
		         </Exec>      
          </If>	-->        
          <Break/>
         </Case>       
         <Default>
					<Set>RspCod=461598</Set>
          <Set>RspMsg=帐户不存在</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
					  <Arg name="SqlCmd" value="UpdBatRec"/>
		     	</Exec>
				  </Default>
			</Switch>
		 <Continue/>
    </While>
      <Exec func="PUB:ExecSql" error="IGNORE">
			  <Arg name="SqlCmd" value="UpdFilSts"/>
		  </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=操作成功</Set>
   </If>		
		</FlowCtrl>
	</Transaction>

	<Transaction code="461522" desc="文件批量完成通知前端">   <!--通知前端批量签约完成-->
    <DynSentence name="QryBatInf"><!--查询本交易所需信息-->
      <Sentence>
        SELECT DskNo,SndTlr TlrId,NodNo,FilNam From pubbatinf WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdBatInf"><!--查询本交易所需信息-->
      <Sentence>
        update pubbatinf set Status='N' WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>DskNo=$LogNo</Set>
      <Exec func="PUB:ReadRecord"><!--查询必需信息-->
        <Arg name="SqlCmd" value="QryBatInf"/>
      </Exec>
      <Exec func="PUB:Notify">
        <Arg name="BusTyp"  value="AG"/>
        <Arg name="AplCod"  value="461522"/>
        <Arg name="Summary" value="STRCAT(文件,$FilNam,实时批量完成通知)"/>
        <Arg name="MsgData" value="STRCAT(批次号为,$DskNo,的实时批量代收付处理结束!)"/>
        <Arg name="ObjNod"  value="$NodNo"/><!-- 目的机构-->
        <Arg name="ObjTlr"  value="$TlrId"/><!-- 目的柜员-->
        <Arg name="SrcOrg"  value="$NodNo"/><!-- 操作机构号-->
        <Arg name="SrcTlr"  value="$TlrId"/><!-- 操作柜员号-->
      </Exec>
      <Exec func="PUB:ExecSql">
        <Arg name="SqlCmd" value="UpdBatInf"/>
      </Exec>
      <Exec func="PUB:CancelBatchRedo"/><!--以下两句用于更新pubbatinf中的状态值-->
    </FlowCtrl>
  </Transaction>
  
  <Transaction code="461523" desc="实时批量提交">
    <Quote name="PntSqlLst"/>
		<DynSentence name="GetBatInf">
			<Sentence>
				SELECT a.OrnCnt,a.OrnAmt,b.CAgtNo,b.BBusTyp,c.CrpNam 
				FROM pubbatinf a,savcrpagr b,savcrpinf c WHERE a.DskNo='%s' AND a.BrNo='%s' AND NodNo='%s'
				AND a.RsvFld=b.CAgtNo AND b.CrpCod=c.CrpCod  AND b.BrNo=c.BrNo
			</Sentence>
			<Fields>DskNo|BrNo|NodNo|</Fields>
		</DynSentence>
		<FlowCtrl>
			<!--获取业务类型和单位名称  -->
		  <Quote name="InitTran"/>  
			<Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="GetBatInf"></Arg>
			</Exec>
			<Exec func="PUB:ConfirmBatch"/>
			<If condition="~RetCod!=0">
				<Set>RspCod=461599</Set>
				<Return/>
			</If>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="461524" desc="取批量文件信息">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		  <Quote name="InitTran"/>
		  <Exec func="PUB:GetAppInfo"/> 			
			<!--Set>RcvFil=$DskNam</Set-->
			<!--<Set>LclFil=STRCAT($RcvFil,.,$BrNo)</Set>-->
			<!--Set>LclFil=$RcvFil</Set-->
			<Set>LclDir=dat/pnt/recv</Set>
			<Set>ObjFil=STRCAT(PLKS442000107,20090431,*)</Set>
			<Exec func="PUB:FtpGet" error="IGNORE">
				<Arg name="FtpId" value="PNT006"/>
			</Exec>
			<If condition="~RetCod!=0">
			  <Set>RspCod=461597</Set>
			  <Set>RspMsg=取文件失败</Set>
			  <Return/>
			</If>	
			<Set>FilNum=0</Set>
			<Set>FilTot=0</Set>
			<While>
			  <If condition="INTCMP($FilNum,5,100)">
			    <Break/>
			  </If>
			  <Set>LclFil=$ObjFil</Set>
			  <Set>DskNam=STRCAT(PLKS442000107,20090431,ADDCHAR($FilNum,2,0,1),.txt)</Set>
			  <Set>DatFil=STRCAT($LclDir,/plks/,$DskNam)</Set>
			  
			  <Exec func="PUB:IsExistFile" error="IGNORE">
           <Arg name="FileName" value="$DatFil"/>
        </Exec>
        <If condition="~RetCod!=0">
           <Set>FilTot=ADD($FilTot,1)</Set>
        </If>
        <Else>
			     <Exec func="PUB:OpenFile">
			     	<Arg name="FileName"   value="$DatFil"/>
			     	<Arg name="Mode"       value="r"/>
			     </Exec>
           <!--读取文件头-->
           
			     <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
			     	<Arg name="ConfigName" value="BatFormat"/>
			     	<Arg name="RootName"   value="BATCH"/>
			     	<Arg name="NodeName"   value="Process"/>
			     	<Arg name="AttrName"   value="name"/>
			     	<Arg name="AttrValue"  value="PLKSINFO"/>
			     	<Arg name="MaxLen"     value="100000"/>
			     </Exec>		
			     <If condition="INTCMP($TotNum,3,0)">
			     	<Set>MsgTyp=N</Set>
			     	<Set>RspCod=000000</Set>
			     	<Return/>
			     </If>
			     <Set>FileNam=$DskNam</Set>
			     <Exec func="PUB:InsertRecord" error="IGNORE">   
			       <Args>
			          <Arg name="tablename" value="pntfilinf"/>
			       </Args>
		       </Exec>	
		       <Exec func="PUB:CloseFile"/>
		    </Else>		       
		    <Set>FilNum=ADD($FilNum,1)</Set>
		  </While>
		  <If condition="INTCMP($FilTot,3,$FilNum)">
		    <Set>RspCod=461524</Set>
		    <Set>RspMsg=无批量文件</Set>
		  </If>
		  <Else>
		    <Set>RspCod=000000</Set>
		    <Set>RspMsg=交易成功</Set>		
		  </Else>	
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="461525" desc="批量扣收文件查询">
		<Quote name="PntSqlLst"/>
		<DynSentence name="MultiQuery"><!--查询本交易所需信息-->
      <Sentence>
        SELECT FileNo,FileNam,BankCd,TcrpCd,TxnDat,TotNum,TotAmt from pntfilinf where ActDat='%s' and  DskSts='1'
      </Sentence>
      <Fields>QryDat|</Fields>
    </DynSentence>
		<FlowCtrl>
			<Quote name="InitTran"/>
		  <Exec func="PUB:MultiQuery">
				<Arg name="SqlCmd" value="MultiQuery"></Arg>
			</Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=数据库查询失败</Set>
        <Return/>
      </If>
      <If condition="~RetCod=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=PNT999</Set>
        <Set>RspMsg=无批量扣收文件</Set>
        <Return/>
      </If>                    
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>    		
		</FlowCtrl>
	</Transaction>
	
	
  <Transaction code="461526" desc="批次号查询批次信息（嵌套）">
    <DynSentence name="GetBatInf">
      <Sentence>
        SELECT a.OrnCnt,a.OrnAmt,b.CAgtNo,b.BBusTyp,c.CrpNam FROM pubbatinf a,savcrpagr b,savcrpinf c WHERE a.DskNo='%s' AND a.RsvFld=b.CAgtNo AND b.CrpCod=c.CrpCod AND b.BrNo=c.BrNo
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--获取业务类型和单位名称  -->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="GetBatInf"></Arg>
      </Exec>
    </FlowCtrl>
  </Transaction>
  
  <Transaction code="461527" desc="银行系统产生的批量收款信息文件">
		<Quote name="PntSqlLst"/>
		<DynSentence name="GetHead">
			<Sentence>
				select dskno,bankcd,TCrpcd,txndat from pntfilctl where ActDat = '%s'
			</Sentence>
			<Fields>ActDat|</Fields>
		</DynSentence>
		<DynSentence name="GetTot">
			<Sentence>
				select sum(cast(txnamt as bigint)) as TotAmt,coalesce(COUNT(*),0) TotNum from pntbatrec where ActDat='%s' and DskNo='%s' and HRspCd='SC0000' and RecSts='1'
			</Sentence>
			<Fields>ActDat|DskNo|</Fields>
		</DynSentence>		
		<DynSentence name="GetDetil">
			<Sentence>
				select TVchId,TxnAmt,ActDat,HRspCd,RecSts from pntbatrec where ActDat='%s' and DskNo='%s'
			</Sentence>
			<Fields>ActDat|DskNo|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="InitTran"/>
<!--获取批次号-->
			<Exec func="PUB:nGetPubSeqNo">
				<Arg name="SeqNam" value="Pntpl:SelVal"/>
				<Arg name="SeqCnt" value="1"/>
				<Arg name="Len"    value="2"/>
				<Arg name="CycCnd" value="D"/>
			</Exec>
<!--为避免同一分行并发-->
			<Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>
					
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql" value="GetHead"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=打开游标【GetHead】出错</Set>
				<Return/>
			</If>
			<While>
					<Exec func="PUB:FetchCursor" error="IGNORE"/>
			    <If condition="~RetCod=100">
			    	<Break/>
			    </If>
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTot"></Arg>
          </Exec>			  
			    <Set>FilNam=STRCAT(PKJG,$TCrpcd,$ActDat,$SelVal,.txt)</Set> 
			    <Set>DatFil=STRCAT($PntSndDir,yhsc/,$FilNam )</Set>             
          <!--文件头-->
			    <Exec func="PUB:WriteFile" error="IGNORE">
			    	<Arg name="FileName" value="$DatFil"/>
			    	<Arg name="OpenMode" value="a+"/>
			    	<Arg name="Data"	   value="$DskNo"/> 
			    	<Arg name="Data"	   value="|"/>
			    	<Arg name="Data"	   value="$BankCd"/> 
			    	<Arg name="Data"	   value="|"/>
			    	<Arg name="Data"	   value="$TCrpCd"/> 
			    	<Arg name="Data"	   value="|"/>
			    	<Arg name="Data"	   value="$ActDat"/> 
			    	<Arg name="Data"	   value="|"/>		
			    	<Arg name="Data"	   value="$TotNum"/> 
			    	<Arg name="Data"	   value="|"/>			    		    	
			    	<Arg name="Data"	   value="AMTSIMPLEFMT($TotAmt)"/> 
			    	<Arg name="Data"	   value="|"/>
			    	<Arg name="ESCFMT"   value="\\n"/>
			    	<Arg name="ESCFMT"   value="\\n"/> <!--zhongshan add-->
			    </Exec>
			    <Exec func="PUB:OpenCursor" error="IGNORE">
			    	<Arg name="sql" value="GetDetil"/>
			    	<Arg name="CursorName" value="CURSOR_2"/>
			    </Exec>
			    <If condition="~RetCod!=0">
			    	<Set>MsgTyp=E</Set>
			    	<Set>RspCod=PNT999</Set>
			    	<Set>RspMsg=打开游标【GetDetil】出错</Set>
			    	<Return/>
			    </If>
			    <Set>Num=0</Set>
			    <While>
			    	<Exec func="PUB:FetchCursor" error="IGNORE">
			    	  <Arg name="CursorName" value="CURSOR_2"/>
			      </Exec>
			    	<If condition="~RetCod=100">
			    		<Break/>
			    	</If>
			    	<If condition="$HRspCd!=SC0000">
			    	  <Set>HTxnAmt=""</Set>
			    	  <Switch expression="$HRspCd">
			    	    <Case value="PA1043"/>
			    	    <Case value="PD5100"/>
			    	    <Case value="SD5200"/>
			    	    <Case value="PD5100">
			    	      <Set>TRspCd=2</Set>
			    	      <Set>HTxnAmt= </Set>
			    	      <Set>TRspMsg=余额不足</Set>
			    	      <Break/>
			    	    </Case>
			    	    <Default>
			    	      <Set>TRspCd=9</Set>
			    	      <Set>HTxnAmt= </Set>
			    	      <Set>TRspMsg=其它</Set>
			    	      <Break/> 
			    	    </Default>   
			    	  </Switch>
			    	</If>
			    	<Else>
			    	  <Set>TRspCd=1</Set>
			    	  <Set>TRspMsg= </Set>
			    	  <Set>HTxnAmt=AMTSIMPLEFMT($TxnAmt)</Set>
			    	  <Set>HActDat=$ActDat</Set>
			    	</Else>
			    	<Exec func="PUB:WriteFile" error="IGNORE">
			    		<Arg name="FileName" value="$DatFil"/>
			    		<Arg name="OpenMode" value="a+"/>
			    		<Arg name="Data"	   value="$TVchId"/> 
			    		<Arg name="Data"	   value="|"/>
			    		<Arg name="Data"	   value="AMTSIMPLEFMT($TxnAmt)"/> 
			    		<Arg name="Data"	   value="|"/>
			    		<Arg name="Data"	   value="DELSPACE($HTxnAmt,both)"/> 
			    		<Arg name="Data"	   value="|"/>
			    		<Arg name="Data"	   value="$HActDat"/> 
			    		<Arg name="Data"	   value="|"/>
			    		<Arg name="Data"	   value="$TRspCd"/> 
			    		<Arg name="Data"	   value="|"/>	
			    		<Arg name="Data"	   value="DELSPACE($TRspMsg,both)"/> 
			    		<Arg name="Data"	   value="|"/>				    				    					    		
			    		<Arg name="ESCFMT"   value="\\n"/>
			    	</Exec>
			    </While>
			    <Exec func="PUB:CloseCursor" error="IGNORE">
			      <Arg name="CursorName" value="CURSOR_2"/>
			    </Exec>
			</While>
			<Exec func="PUB:CloseCursor" error="IGNORE"/>
			<Set>ObjFil=$FilNam</Set>   <!--zhongshan add-->
			<Set>LclFil=$FilNam</Set>   <!--zhongshan add-->
			<Exec func="PUB:FtpPut">
				<Arg name="FtpId" value="PNT003"/>
			</Exec>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>

	<Transaction code="461528" desc="批量开票">
		<Quote name="PntSqlLst"/>
    <DynSentence name="GetToCnt">
        <Sentence>
           select COUNT(*) as TotNum from pntbatrec where DskNo='%s' and TBilTp='%s'
        </Sentence>
      <Fields>DskNo|TBilTp|</Fields>
    </DynSentence> 		
    <DynSentence name="GetTBSts">
        <Sentence>
           select TBilSts,TBilFFSts from pntpjnum where TBilTp='%s' and TBilNo='%s' and TBilNod='%s'
        </Sentence>
      <Fields>TBilTp|TBilNo|NodNo|</Fields>
    </DynSentence>    
    <DynSentence name="GetSeqTBNo">
        <Sentence>
           select SeqNo,TBilTp from pntbatrec where DskNo='%s'
        </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>          
    <DynSentence name="UpdBatTBNo">
        <Sentence>
           update pntbatrec set TBilNo='%s' where Dskno='%s' and SeqNo='%s' and TBilTp='%s'
        </Sentence>
      <Fields>TBilNo|DskNo|SeqNo|TBilTp|</Fields>
    </DynSentence>      
    <DynSentence name="UpdTBSts">
        <Sentence>
           update pntpjnum set TBilsts='2' where TBilTp='%s' and TBilNo='%s' and TBilNod='%s'
        </Sentence>
      <Fields>TBilTp|TBilNo|NodNo|</Fields>
    </DynSentence>         		
		<FlowCtrl>
		   <Quote name="InitTran"/>
       <Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>
			<Exec func="PUB:ReadRecord">
		  	<Args>
		  		<Arg name="SqlCmd" value="GetToCnt"/>
		  	</Args>
		  </Exec>
		  <Set>TotCnt=ADD(SUB(SUBSTR($TBilNoEnd,ADD(SUB(STRLEN($TBilNoEnd),STRLEN($TotNum)),1),STRLEN($TotNum)),SUBSTR($TBilNoStar,ADD(SUB(STRLEN($TBilNoStar),STRLEN($TotNum)),1),STRLEN($TotNum))),1)</Set>
		  <If condition="INTCMP($TotNum,4,$TotCnt)">
		    <Set>MsgTyp=E</Set>
		    <Set>RspCod=PNT999</Set>
		    <Set>RspMsg=票据总数不符</Set>
		    <Break/>
		  </If> 		
		  <Set>TBilNo=$TBilNoStar</Set>			
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql" value="GetSeqTBNo"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=PNT999</Set>
				<Set>RspMsg=打开游标【GetSeqTBNo】出错</Set>
				<Return/>
			</If>
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/>
			  <If condition="~RetCod=100">
			  	<Break/>
			  </If>
			  <!--Exec func="PUB:ReadRecord">
		    	<Args>
		    		<Arg name="SqlCmd" value="GetTBSts"/>
		    	</Args>
		    </Exec-->	      
		    <Exec func="PUB:ExecSql">   
          <Arg name="SqlCmd" value="UpdBatTBNo"/>
        </Exec>
        
		    <Exec func="PUB:ExecSql">   
          <Arg name="SqlCmd" value="UpdTBSts"/>
        </Exec>  
        <Set>$TBilNo=STRCAT(SUBSTR($TBilNo,1,SUB(STRLEN($TBilNo),STRLEN($TotNum))),INTTOSTR(ADD(SUBSTR($TBilNo,ADD(SUB(STRLEN($TBilNo),STRLEN($TotNum)),1),STRLEN($TotNum)),1),STRLEN($TotNum)))</Set>                                
			</While> 
      <Set>$TBilNoEnd=STRCAT(SUBSTR($TBilNoEnd,1,SUB(STRLEN($TBilNoEnd),STRLEN($TotCnt))),INTTOSTR(ADD(SUBSTR($TBilNoEnd,ADD(SUB(STRLEN($TBilNoEnd),STRLEN($TotCnt)),1),STRLEN($TotCnt)),1),STRLEN($TotCnt)))</Set>                
      <If condition="IS_NOEQUAL_STRING($TBilNo,$TBilNoEnd)">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=PNT999</Set>
         <Break/>
      </If>			
		  <Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set> 
			<Set>RspMsg=交易成功</Set>
		</FlowCtrl>
	</Transaction>

	<Transaction code="461531" desc="请求退费">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="TxnCod" value="321"/>
				<Arg name="ObjSvr" value="STHDPNT1"/>
			</Exec>
			<Switch expression="$RtnCod">
				<Case value="100">   <!--不需要手工录入-->
					<Set>NTxnCd=461532</Set>
					<Break/>
				</Case>
				<Default>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=PNT999</Set>
					<Return/>
				</Default>
			</Switch>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>

	<Transaction code="461532" desc="执行退费">
		<Quote name="PntSqlLst"/>
		<Attributes>
			<Attribute name="integrity" value="2" code="461599"/>  <!-- 条件冲正-->
		</Attributes>
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PUB:GetLogNo"/>		
			<Set>BilSts=U</Set>
			<Set>CmdCod=323</Set>
			<Set>TxnTyp=N</Set>
			<Set>OIFlag=O</Set>
			<Set>TxnAmt=ADDCHAR(MUL(ADD($BilAmt,$PenAmt),100),15,0,1)</Set><!--zs0309add MUL-->
			<!--Exec func="PFA:GenPrvData">
				<Arg name="PrjNum" value="PrjNum" desc="收费项目笔数"/>
				<Arg name="GrpNam" value="PrjRec" desc="收费项目结构"/>
				<Arg name="RmkNum" value="RmkNum" desc="额外信息笔数"/>
				<Arg name="GrpNam" value="RmkRec" desc="额外信息结构"/>
			</Exec-->
												
			<!--Exec func="PUB:InsertRecord">   
			  <Args>
			    <Arg name="tablename" value="PntTxnBok"/>
			  </Args>
		  </Exec-->			
			<Set>BokFlg=1</Set>
				<!--Set>CmtCod=313</Set-->
			<Quote name="PSndThdPro"/><!--通知第三方执行退费-->				  
			<Quote name="BokAccPro"/>
			<!--If condition="IS_EQUAL_STRING($BilSts,B)"-->   <!--记帐成功-->			
			  <!--Exec func="PUB:ExecSql" error="IGNORE">    
           <Arg name="SqlCmd" value="UpdPJNum"/> 
        </Exec>        
			</If>
			<Else>
				<Set>MsgTyp=E</Set>
			</Else-->
			<Quote name="CSndThdPro"/> <!--通知第三方确认-->
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="461533" desc="票据发放">
		<Quote name="PntSqlLst"/>
    <DynSentence name="GetTBsts">
        <Sentence>
           select TBilSts,TBilFFSts from pntpjnum where TBilTp='%s' and TBilNo='%s'
        </Sentence> 
      <Fields>TBilTp|TBilNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdTBSts">
        <Sentence>
           update pntpjnum set TBilFFSts='%s',TBilNod='%s' where TBilTp='%s' and TBilNo='%s'
        </Sentence>
      <Fields>TBilFFSts|TBilNod|TBilTp|TBilNo|</Fields>
    </DynSentence>       		
		<FlowCtrl>
			<Quote name="InitTran"/>
			<Exec func="PUB:Lock">
				<Arg name="RecKey" value="STRCAT($BrNo,$AplCls,$TxnCod)"/>
				<Arg name="AutoUnlock" value="yes"/>
			</Exec>			
			<Set>TBilNo=$TBilStar</Set>
			<Set>TBSNum=0</Set>			
      <While>
		     <If condition="INTCMP($TotCnt,3,$TBSNum)">
				   <Break/>
		     </If>      
			   <Exec func="PUB:ReadRecord">
		     	 <Args>
		     	 	<Arg name="SqlCmd" value="GetTBsts"/>
		     	 </Args>
		     </Exec>  		
		     <If condition="AND(IS_EQUAL_STRING($TBilSts,1),IS_EQUAL_STRING($TBilFFSts,1))">
		       <Set>TBilFFSts=2</Set>		            
			     <Exec func="PUB:ExecSql">    
              <Arg name="SqlCmd" value="UpdTBSts"/> 
           </Exec>   
         </If>                
         <Set>$TBilNo=STRCAT(SUBSTR($TBilNo,1,SUB(STRLEN($TBilNo),STRLEN($TotCnt))),INTTOSTR(ADD(SUBSTR($TBilNo,ADD(SUB(STRLEN($TBilNo),STRLEN($TotCnt)),1),STRLEN($TotCnt)),1),STRLEN($TotCnt)))</Set>                
         <Set>$TBSNum=ADD($TBSNum,1)</Set>  
      </While>
      <Set>$TBilEnd=STRCAT(SUBSTR($TBilEnd,1,SUB(STRLEN($TBilEnd),STRLEN($TotCnt))),INTTOSTR(ADD(SUBSTR($TBilEnd,ADD(SUB(STRLEN($TBilEnd),STRLEN($TotCnt)),1),STRLEN($TotCnt)),1),STRLEN($TotCnt)))</Set>                
      <If condition="IS_NOEQUAL_STRING($TBilNo,$TBilEnd)">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=PNT999</Set>
      </If>
      <Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>	


	<Transaction code="461598" desc="测试主控">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
		</FlowCtrl>
	</Transaction>
	
	


	<Transaction code="461599" desc="自动抹帐">
		<Quote name="PntSqlLst"/>
		<FlowCtrl>
			<Set>TTxnCd=$TxnCod</Set>
			<Quote name="CanAccPro"/>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
		</FlowCtrl>
	</Transaction>
</Application>
