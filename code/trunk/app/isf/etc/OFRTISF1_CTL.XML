<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="ISF" code="421">
	<!--羊城通空中充值主控-->
  <LibDeclare>
    <Library name="YCT"  value="dll/yct.so" />
  </LibDeclare>	
	<ConfigDeclare>
		<Config name="BatFormat"   value="etc/LSH_FMT_441999.XML"/>
		<Config name="ParaFile"    value="etc/CFG_LSH_441999.XML"/>
		<Config name="OPFCSW"      value="etc/LSH_CSW_441999.XML"/>
	</ConfigDeclare>
	<PackageDeclare>
		<Package name="AFE"        value="etc/DAFE_PKG.XML"/>
	</PackageDeclare>
	<TableDeclare>
		<Table name="afetxnjnl"    value="afetxnjnl"/>  <!--业务流水表-->
		<Table name="savthdinf"    value="savthdinf"/>  <!--第三方信息表-->
		<Table name="savcusagt"    value="savcusagt"/>  <!--协议信息表-->
	</TableDeclare>
	<BusDefDeclare>
		<Busdef name="BrNo"  value="441999"/>
                <Busdef name="AplCls"    value="421"/><!--Added by wu_20100208-->
	</BusDefDeclare>
	<GlobalFunction>
		<Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
	</GlobalFunction>
	<Define>
		<Macro name="Chk_TxnSrc">  <!--检查交易来源-->
			<If condition="INTCMP(STRLEN(DELBOTHSPACE($TxnSrc)),3,0)">
				<Set>TxnCnl=TRM</Set>   
				<Set>CnlTyp=0</Set>
			</If>
			<Else>
				<Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
				<Exec func="PUB:CodeSwitching">
					<Arg name="DatSrc"  value="OPFCSW"/>
					<Arg name="SourNam" value="TxnSrc"/>
					<Arg name="DestNam" value="CnlTyp"/>
					<Arg name="TblNam"  value="TxnSrc2CnlTyp"/>
				</Exec>
			</Else>
		</Macro>
	</Define>

	<Transaction code="482149" desc="羊城通帐户查询签约信息" log_switch="1">
	<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="MultiQuery"> <!-- 查询签约信息表 -->
			<Sentence>
			  SELECT sign_flag,inst_no,live_flag,tran_flag,acc_type,yct_pwd,bank_acc,oper_tlr,tran_date,sys_no,ret_code,
			  paper_no,contact_no,cust_name,sex_code,phone_no,mobile_no,post_no,address,email,card1,card2,card3,card4,limite,
			  frequence,reg_date,cncl_date,cncl_flag,reserve1,reserve2,reserve3,reserve4,reserve5
			   FROM yctreg  WHERE bank_acc='%s' AND cncl_flag ='0' AND ret_code='00'
			</Sentence>
			<Fields>bank_acc|</Fields>
		</DynSentence>
		<DynSentence name="Cnt">  <!--笔数-->
			<Sentence>
				SELECT Count(*) SumCnt FROM yctreg  WHERE bank_acc='%s' AND cncl_flag ='0' AND ret_code='00'
			</Sentence>
			<Fields>bank_acc|</Fields>
		</DynSentence>
	  <FlowCtrl>
	   <Exec func="PUB:InitTransaction"/>            <!--交易初始化,预留-->

	   <Set>bank_acc=TRIM($bank_acc,right)</Set>
	   
	   <Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="SqlCmd" value="Cnt"/>
	  </Exec>

     <Exec func="PUB:MultiQuery" error="IGNORE">
        <Args>
          <Arg name="SqlCmd"  value="MultiQuery"/>
        </Args>
     </Exec>
  	</FlowCtrl>
	</Transaction>
	

	<Transaction code="482138" desc="羊城通帐户签约">
	<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="MultiQuery"> <!-- 查询签约信息表 -->
		<Sentence>
		  SELECT * FROM yctreg  WHERE bank_acc='%s' and card1='%s' AND cncl_flag ='0' AND ret_code='00'
		</Sentence>
		<Fields>bank_acc|card1|</Fields>
	</DynSentence>
	<DynSentence name="Cnt">  <!--笔数-->
		<Sentence>
			SELECT Count(*) SumCnt FROM yctreg  WHERE bank_acc='%s' and card1='%s' AND cncl_flag='0' AND ret_code='00'
		</Sentence>
		<Fields>bank_acc|card1|</Fields>
	</DynSentence>
	<DynSentence name="SUMCnt">  <!--笔数-->
		<Sentence>
			SELECT Count(*) SumCntyct FROM yctreg  WHERE bank_acc='%s' AND cncl_flag='0' AND ret_code='00'
		</Sentence>
		<Fields>bank_acc|</Fields>
	</DynSentence>
	<DynSentence name="InSertYct">  <!-- 插入签约流水表 -->
		<Sentence>
			INSERT INTO yctreg (sign_flag,	inst_no, live_flag	,tran_flag	,acc_type	,yct_pwd ,bank_acc,oper_tlr	,tran_date,sys_no,ret_code,paper_no,contact_no,cust_name,sex_code,phone_no,mobile_no,post_no,address,email,
			card1,card2,card3,card4,limite,frequence,reg_date,cncl_date,cncl_flag,reserve1,reserve2,reserve3,reserve4,reserve5 )
			VALUES( '%s','%s','%s','%s','%s', '%s','%s','%s','%s','%s', '%s','%s','%s','%s','%s', '%s','%s','%s','%s','%s',
			 '%s','%s','%s','%s','%s', '%s','%s','%s','%s','%s', '%s','%s','%s','%s' )
		</Sentence>
		<Fields>sign_flag|inst_no|live_flag|tran_flag|acc_type|yct_pwd|bank_acc|oper_tlr|tran_date|sys_no|ret_code|paper_no|contact_no|cust_name|sex_code|phone_no|mobile_no|post_no|address|email|card1|card2|card3|card4|limite|frequence|reg_date|cncl_date|cncl_flag|reserve1|reserve2|reserve3|reserve4|reserve5|</Fields>
	</DynSentence>

	<DynSentence name="UpdateYct">  <!-- 更新签约返回码 -->
		<Sentence>
			UPDATE yctreg SET ret_code ='%s',cncl_flag='0' WHERE bank_acc='%s' AND contact_no='%s'
		</Sentence>
		<Fields>ret_code|bank_acc|contact_no|</Fields>
	</DynSentence>

		<FlowCtrl>

			<!-- 设置初始化数据 -->
			
			
			<!-- 查询该帐户是否有签约记录 -->
			<Exec func="PUB:ReadRecord">
					<Arg name="SqlCmd" value="Cnt"/>
			</Exec>

			<If condition="IS_NOEQUAL_STRING($SumCnt,0)">
				<Set>RspCod=482199</Set>
				<Set>RspMsg=该羊城通卡号已有签约记录!</Set>
				<Return/>
			</If>
			
			<Exec func="PUB:ReadRecord">
					<Arg name="SqlCmd" value="SUMCnt"/>
			</Exec>

			<If condition="IS_EQUAL_STRING($SumCntyct,4)">
				<Set>RspCod=482199</Set>
				<Set>RspMsg=您的签约超出羊城通卡张数限制，最多签约四张羊城通卡!</Set>
				<Return/>
			</If>

			<!-- 产生合同编号 -->
			<Exec func="PUB:GetLogNo"/>

			<!-- 产生合同编号 -->
			<Set>contact_no=ADDCHAR($LOGNO,20, ,0)</Set>
			<!-- 系统参考号 -->
			<Set>sys_no=SUBSTR($LOGNO,3,12)</Set>
			<!-- 签约日期 -->
			<Set>reserve2=GETDATE()</Set>
			<!-- 过程代码 -->
			<Set>reserve3=$Code</Set>
			
			
			<!-- 羊城通签约操作 -->
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Args>
					<Arg name="SqlCmd" value="InSertYct"/>
				</Args>
			</Exec>

			<If condition="~RetCod=-1">
				<Set>RspCod=331000</Set>
				<Return/>
			</If> 
			 
			<!-- 设置参与运算MAC的原始数据  -->
			<Set>mac_data=STRCAT($Code,$yct_bank_acc,$TransDateTime,$sys_no,$acc_type,$sign_type,$contact_no,$cust_name,$sex_code,$phone_no,$mobile_no,$post_no,$address,$email)</Set>
			<Set>mac_data=STRCAT($mac_data,$card1,$card2,$card3,$card4,$limite,$frequence,$reg_date,$paper_no)</Set>
			
			<!-- MAC计算  -->
			<Exec func="YCT:CalYctMAC" error="IGNORE">
				<Args>
					<Arg name="MACKEY" value="$MACKEY" />
				</Args>
			</Exec>

			<Set>COMM_BUFF=STRCAT($Type,$Len,$Code,$yct_bank_acc,$TransDateTime,$sys_no,$acc_type,$sign_type,$contact_no,$cust_name,$sex_code,$phone_no)</Set>
			<Set>COMM_BUFF=STRCAT($COMM_BUFF,$mobile_no,$post_no,$address,$email,$card1,$card2,$card3,$card4,$limite,$frequence,$reg_date,$paper_no,$YCTMAC)</Set> 

			<Exec func="YCT:YctComm" error="IGNORE">
			  <Arg name="HostIp" value="10.240.18.19"/>
			  <Arg name="HostPort" value="9113" />
				<Arg name="COMM_BUFF" value="$COMM_BUFF" />
			</Exec>

			<If condition="IS_NOEQUAL_STRING($YCTRETCODE,00)">
				<Set>RspCod=333000</Set>
				<Set>RspMsg=$YCTRETMSG</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE" />
				<Return/>
			</If>
			
			<!-- 更新签约响应码数据 -->
			<Set>ret_code=00</Set>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Args>
					<Arg name="SqlCmd" value="UpdateYct"/>
				</Args>
			</Exec>
		</FlowCtrl>
	</Transaction>

	<Transaction code="482139" desc="羊城通帐户解约">
	<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="MultiQuery"> <!-- 查询签约信息表 -->
		<Sentence>
		  SELECT contact_no,cust_name,sex_code,phone_no,mobile_no,post_no,address, email,paper_no FROM yctreg  WHERE bank_acc='%s' and card1='%s' AND cncl_flag ='0' AND ret_code='00'
		</Sentence>
		<Fields>bank_acc|card1|</Fields>
	</DynSentence>
	<DynSentence name="Cnt">  <!--笔数-->
		<Sentence>
			SELECT Count(*) SumCnt FROM yctreg  WHERE bank_acc='%s' and card1='%s' AND cncl_flag='0' AND ret_code='00'
		</Sentence>
		<Fields>bank_acc|card1|</Fields>
	</DynSentence>

	<DynSentence name="UpdateYct">  <!-- 更新签约信息表 -->
		<Sentence>
			UPDATE yctreg SET cncl_flag ='1',ret_code='%s',tran_date='%s',cncl_date='%s',sys_no='%s',reserve1='%s',reserve3='%s' WHERE bank_acc='%s'  and card1='%s' AND cncl_flag ='0' AND ret_code='00'
		</Sentence>
		<Fields>YCTRETCODE|tran_date|cncl_date|sys_no|cncl_reason|reserve3|bank_acc|card1|</Fields>
	</DynSentence>

	<DynSentence name="UpdateYctCode">  <!-- 更新签约返回码 -->
		<Sentence>
			UPDATE yctreg SET ret_code='%s' WHERE bank_acc='%s'  AND contact_no='%s'
		</Sentence>
		<Fields>YCTRETCODE|bank_acc|contact_no|</Fields>
	</DynSentence>

		<FlowCtrl>

			<!-- 设置初始化数据 -->
			<Set>FullFlag=2</Set>
			
			<!-- 查询该帐户是否有签约记录 -->
			<Exec func="PUB:ReadRecord">
					<Arg name="SqlCmd" value="Cnt"/>
			</Exec>

			<If condition="IS_EQUAL_STRING($SumCnt,0)">
				<Set>RspCod=482199</Set>
				<Set>RspMsg=此帐户未有签约记录!</Set>
				<Return/>
			</If>
			<If condition="IS_EQUAL_STRING($SumCnt,1)">
				<Set>FullFlag=1</Set>
			</If>
			
			<Exec func="PUB:ReadRecord">
					<Arg name="SqlCmd" value="MultiQuery"/>
			</Exec>
			<!-- 产生流水号 -->
			<Exec func="PUB:GetLogNo"/>

			
			<!-- 系统参考号 -->
			<Set>sys_no=SUBSTR($LOGNO,3,12)</Set>

			<!-- 解约日期  -->
			<Set>cncl_date=SUBSTR(GETDATE(),5,4)</Set>
      
      <!-- 解约原因  -->
			<Set>reserve1=$cncl_reason</Set>
			<Set>contact_no=ADDCHAR($contact_no,20, ,0)</Set><!-- 合同编号  -->
			<Set>cust_name=ADDCHAR($cust_name,30, ,0)</Set><!-- 用户姓名  -->
			<Set>phone_no=ADDCHAR($phone_no,15, ,0)</Set><!-- 固定电话  -->
			<Set>mobile_no=ADDCHAR($mobile_no,15, ,0)</Set><!-- 手机号  -->
			<Set>post_no=ADDCHAR($post_no,6, ,0)</Set><!-- 邮编  -->
			<Set>address=ADDCHAR($address,50, ,0)</Set><!-- 地址  -->
			<Set>email=ADDCHAR($email,50, ,0)</Set><!-- E-mail地址  -->
			<Set>paper_no=ADDCHAR($paper_no,21, ,0)</Set><!-- 证件类型号码  -->
			<!-- 过程代码 -->
			<Set>reserve3=$Code</Set>
			<!-- 设置参与运算MAC的原始数据  -->
			<Set>mac_data=STRCAT($Code,$yct_bank_acc,$TransDateTime,$sys_no,$contact_no,$cust_name,$sex_code,$phone_no,$mobile_no,$post_no,$address,$email,$Fullflag,$card1,$card2,$card3,$cncl_date,$cncl_reason,$paper_no)</Set>
			
			<!-- MAC计算  -->
			<Exec func="YCT:CalYctMAC" error="IGNORE">
				<Args>
					<Arg name="MACKEY" value="$MACKEY" />
				</Args>
			</Exec>
 			
			<Set>COMM_BUFF=STRCAT($Type,$Len,$Code,$yct_bank_acc,$TransDateTime,$sys_no,$contact_no,$cust_name,$sex_code,$phone_no,$mobile_no)</Set>
			<Set>COMM_BUFF=STRCAT($COMM_BUFF,$post_no,$address,$email,$Fullflag,$card1,$card2,$card3,$cncl_date,$cncl_reason,$paper_no,$YCTMAC)</Set> 

			<Exec func="YCT:YctComm" error="IGNORE"> 
			  <Arg name="HostIp" value="10.240.18.19"/>
			  <Arg name="HostPort" value="9113" />
				<Arg name="COMM_BUFF" value="$COMM_BUFF" />
			</Exec>

			<If condition="IS_EQUAL_STRING($YCTRETCODE,10)">
				<Set>RspCod=333000</Set>
				<Set>RspMsg=$YCTRETMSG</Set>
				<Exec func="PUB:ExecSql" error="IGNORE">
					<Args>
						<Arg name="SqlCmd" value="UpdateYct"/>
					</Args>
				</Exec>
				<Return/>
			</If>
			<If condition="IS_NOEQUAL_STRING($YCTRETCODE,00)">
				<Set>RspCod=333000</Set>
				<Set>RspMsg=$YCTRETMSG</Set>
				<Return/>
			</If>
			
			<!-- 更新签约响应码数据 -->
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Args>
					<Arg name="SqlCmd" value="UpdateYct"/>
				</Args>
			</Exec>
		</FlowCtrl>
	</Transaction>

	<Transaction code="482140" desc="查询账户信息">
		<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
		<FlowCtrl>
			<Exec func="PUB:CallHostOther" error="IGNORE">
				<Arg name="HTxnCd" value="476520"/>
				<Arg name="ObjSvr" value="SHSTPUB1"/>
			</Exec>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="482136" desc="激活羊城通">
		<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="Cnt">  <!--笔数-->
		<Sentence>
			SELECT Count(*) SumCnt FROM yctreg  WHERE bank_acc='%s' and card1='%s' AND cncl_flag='0' AND ret_code='00'
		</Sentence>
		<Fields>bank_acc|card1|</Fields>
	</DynSentence>
	<DynSentence name="UpdateYct">  <!-- 更新激活信息表 -->
		<Sentence>
			UPDATE yctreg SET live_flag ='0',tran_flag='0' WHERE bank_acc='%s'  and card1='%s' AND cncl_flag ='0' AND ret_code='00'
		</Sentence>
		<Fields>bank_acc|card1|</Fields>
	</DynSentence>
		<FlowCtrl>
			<!-- 查询该帐户是否有签约记录 -->
			<Exec func="PUB:ReadRecord">
					<Arg name="SqlCmd" value="Cnt"/>
			</Exec>

			<If condition="IS_EQUAL_STRING($SumCnt,0)">
				<Set>RspCod=482199</Set>
				<Set>RspMsg=此帐户未有签约记录!</Set>
				<Return/>
			</If>
			
			<!-- 产生流水号 -->
			<Exec func="PUB:GetLogNo"/>
			<!-- 系统参考号 -->
			<Set>sys_no=SUBSTR($LOGNO,2,12)</Set>
			
			<!-- 设置参与运算MAC的原始数据  -->
			<Set>mac_data=STRCAT($Code,$yct_bank_acc,$TransDateTime,$sys_no,$card1)</Set>
			
			<!-- MAC计算  -->
			<Exec func="YCT:CalYctMAC" error="IGNORE">
				<Args>
					<Arg name="MACKEY" value="$MACKEY" />
				</Args>
			</Exec>

      <Set>COMM_BUFF=STRCAT($Type,$Len,$Code,$yct_bank_acc,$TransDateTime,$sys_no,$card1,$YCTMAC)</Set>

			<Exec func="YCT:YctComm" error="IGNORE"> 
			  <Arg name="HostIp" value="10.240.18.19"/>
			  <Arg name="HostPort" value="9113" />
				<Arg name="COMM_BUFF" value="$COMM_BUFF" />
			</Exec>

			<If condition="IS_NOEQUAL_STRING($YCTRETCODE,00)">
				<Set>RspCod=333000</Set>
				<Set>RspMsg=$YCTRETMSG</Set>
				<Exec func="PUB:RollbackWork" error="IGNORE" />
				<Return/>
			</If>
			
			
			<!-- 羊城通激活操作 -->
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Args>
					<Arg name="SqlCmd" value="UpdateYct"/>
				</Args>
			</Exec>

			<If condition="~RetCod=-1">
				<Set>RspCod=331000</Set>
				<Set>RspMsg=羊城通激活失败!</Set>
				<Return/>
			</If>
			
		</FlowCtrl>
	</Transaction>
	
<Transaction code="482157" desc="羊城通未激活签约反馈" log_switch="1">
	<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    
	<DynSentence name="MultiQuery"> <!-- 查询签约信息表 -->
		<Sentence>
		  SELECT card1,card2,card3,card4 FROM yctreg  WHERE bank_acc='%s' and card1='%s' AND cncl_flag ='0' AND ret_code='00' AND contact_no='%s'
		</Sentence>
		<Fields>bank_acc|Rev_card1|contact_no|</Fields>
	</DynSentence>

	<DynSentence name="Update">  <!-- 更新签约信息表 -->
		<Sentence>
		  UPDATE  yctreg  set live_flag='0' WHERE bank_acc='%s' and card1='%s' AND cncl_flag ='0' AND ret_code='00' AND contact_no='%s'
		</Sentence>
		<Fields>bank_acc|Rev_card1|contact_no|</Fields>
	</DynSentence>
		
	  <FlowCtrl>

	   <Set>ret_code=YE</Set>
	   <Set>mac_data=STRCAT($Code,$ActNo,$TransDateTime,$sys_no,$contact_no,$Rev_card1,$Rev_card2,$Rev_card3)</Set>
	

	   <!-- 效验MAC -->
	   <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		</Exec>

		<If condition="IS_NOEQUAL_STRING($YCTMAC,$YCT_MAC)">
			<Set>ret_code=12</Set>
			<Set>RspMsg=MAC校验失败!</Set>
			<Return/>
		</If>
		
	   <!-- 查询该记录是否存在 -->
	   <Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="MultiQuery"/>
	  </Exec>

	  <If condition="~RetCod=-1">
		<Set>ret_code=13</Set>
		<Set>RspMsg=该记录不存在!</Set>
		<Return/>
	  </If>

	  <!-- 更新数据表中的 激活标志 -->
	   <Exec func="PUB:ExecSql">
				<Arg name="SqlCmd" value="Update"/>
	  </Exec>
	  
	  <Set>ret_code=00</Set>
	  <!-- 计算返回包的MAC -->
	  <Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>

	  <Exec func="YCT:CalYctMAC" error="IGNORE">
		<Args>
			<Arg name="MACKEY" value="$MACKEY" />
		</Args>
	  </Exec>
	 
	</FlowCtrl>
</Transaction>

<Transaction code="482158" desc="羊城通划款" log_switch="1">
  <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
			<Sentence>
				SELECT TActNo, BBusTyp FROM savcrpagr WHERE CAgtNo='%s' AND SvrSts='1'
			</Sentence>
			<Fields>CAgtNo|</Fields>
	</DynSentence>  
	<DynSentence name="MultiQuery"> <!-- 查询签约信息表 -->
		<Sentence>
		  SELECT card1,bank_acc,CNCL_FLAG FROM yctreg  WHERE bank_acc='%s' and card1='%s' AND cncl_flag ='0' AND ret_code='00'
		</Sentence>
		<Fields>ActNo|card|</Fields>
	</DynSentence>

	<FlowCtrl>
	
		 <Exec func="PUB:InitTransaction"/>      <!--交易初始化-->
		 <Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>  
		 <Set>mac_data=STRCAT($Code,$ActNo,$Trans_Amount,$TransDateTime,$sys_no,$card)</Set>

	   <!-- 效验MAC -->
			<Exec func="YCT:CalYctMAC" error="IGNORE">
				<Args>
					<Arg name="MACKEY" value="$MACKEY" />
				</Args>
			</Exec>

		<If condition="IS_NOEQUAL_STRING($YCTMAC,$YCT_MAC)">
			<Set>ret_code=12</Set>
			<Set>RspMsg=MAC校验失败!</Set>
			<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code,$card)</Set>
		  <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
			<Return/>
		</If>

	   <!-- 查询该记录是否存在 -->
	   <Exec func="PUB:ReadRecord"  error="IGNORE">
				<Arg name="SqlCmd" value="MultiQuery"/>
	  </Exec>

	  <If condition="~RetCod!=0">
			<Set>ret_code=04</Set>
			<Set>RspMsg=该记录不存在!</Set>
			<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code,$card)</Set>
		  <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
			<Return/>
	  </If>
	  
			<Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="QryCrpAgr"/>
			</Exec>

      <If condition="AND(INTCMP(STRLEN($ActNo),3,21),INTCMP(SUBSTR($ActNo,4,1),4,9))"><!--对公-->
        <Set>HTxnCd=451610</Set>
        <Set>ActNod=SUBSTR($TActNo,1,6)</Set>
        <Set>BusSub=01</Set>
        <Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
        <Delete>TActNo</Delete>
        <Set>BusTyp=CRP51</Set>   <!--内部户类型-->
        <Set>ActFlg=2</Set>
        <Set>ActTyp=1</Set>
      </If>
      <Else><!--对私-->
        <Set>HTxnCd=471140</Set>
        <Set>VchChk=0</Set>
        <Set>PayMod=0</Set>
        <Set>VchCod=00000000</Set>
        <Set>CnlTyp=0</Set>
        <If condition="INTCMP(STRLEN($ActNo),3,21)">
          <Set>ActFlg=2</Set>  <!--对私帐号-->
          <Set>ActTyp=2</Set>
        </If>
        <Else>
          <Set>ActFlg=4</Set>  <!--对私卡号-->
          <Set>ActTyp=4</Set>
        </Else>
      </Else>
      			      
		  <Set>TxnCod=482158</Set>
			<Set>TTxnCd=482158</Set>              
      <Set>AplCls=421</Set>
      <Set>BusTyp=LSHA1</Set>
			<!--Set>TxnCnl=TRM</Set-->
			<Set>TxnCnl=WEB</Set>
			<Set>NodNo=441800</Set>
															   
      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="$AppNm"/><!--可以使用单位编号-->
        <Arg name="Transaction" value="482158"/><!--可以用交易码或者模块名-->
      </Exec>      		
      <Set>TxnSts=S</Set>   
      <Set>TTXNST=S</Set>
      <Set>CCLNO=GETDATE()</Set>
      <Call package="AFE" function="AFE_SglThdPay"/>
      
			<If condition="$RspCod=000000">
				<Set>MsgTyp=N</Set>
				<Set>ret_code=00</Set>
			</If>
			<Else>      
				<Set>ret_code=YE</Set>
      </Else>
      
	  <!-- 计算返回包的MAC -->
	  <Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code,$card)</Set>

	  <Exec func="YCT:CalYctMAC" error="IGNORE">
		<Args>
			<Arg name="MACKEY" value="$MACKEY" />
		</Args>
	  </Exec>
	        	 
	</FlowCtrl>
</Transaction>


<Transaction code="482155" desc="羊城通退款" log_switch="1">
	<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
	<DynSentence name="MultiQuery"> <!-- 查询签约信息表 -->
		<Sentence>
		  SELECT bank_acc,card1,CUST_NAME,PAPER_NO FROM yctreg  WHERE bank_acc='%s' and card1='%s'
		</Sentence>
		<Fields>ActNo|card|</Fields>
	</DynSentence>
	  <FlowCtrl>
	  <Exec func="PUB:InitTransaction"/>
	  <Exec func="PUB:GetAppInfo"/>
	  <Exec func="PUB:GetLogNo" />        <!--生成前置流水号-->
	   <Set>ret_code=YE</Set>
     <Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
	   <Set>mac_data=STRCAT($Code,$ActNo,$Trans_Amount,$TransDateTime,$sys_no,$card,$Old_TransDate,$Old_sys_no)</Set>
	   <!-- 效验MAC -->
	   <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		</Exec>

		<If condition="IS_NOEQUAL_STRING($YCTMAC,$YCT_MAC)">
			<Set>ret_code=12</Set>
			<Set>RspMsg=MAC校验失败!</Set>
			<Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
			<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code,$card)</Set>
			  <Exec func="YCT:CalYctMAC" error="IGNORE">
				<Args>
					<Arg name="MACKEY" value="$MACKEY" />
				</Args>
			  </Exec>
			<Return/>
		</If>
		<Set>AppNm=GZ_YCTTK</Set>
			<Exec func="PUB:CodeSwitching">
				<Arg name="DatSrc"  value="OPFCSW"/>
				<Arg name="SourNam" value="AppNm"/>
				<Arg name="DestNam" value="CAgtNo"/>
				<Arg name="TblNam"  value="GZ_AppNm"/>
			</Exec>
		<Set>BrNo=441999</Set>
		<Set>TTxnCd=482155</Set>
		<Set>TxnCod=482155</Set>
		<Set>TxnTyp=N</Set>
		<Set>BusTyp=PCL61</Set>
		<Set>CrpCod=9999999999</Set>
		<Set>ActDat=GETDATE()</Set>
		<Set>ItgTyp=0</Set>
		<Set>FTxnTm=GETDATETIME()</Set>
		<Set>FRspCd=000000</Set>
		<Set>HTxnSt=S</Set>
		<Set>TTxnSt=S</Set>
		<Set>TxnSts=S</Set>
		<Set>TxnAtr=00000200000000000000000000000000</Set>
		<Set>MstChk=1</Set>
		<Set>ActTyp=4</Set>
		<Set>PayMod=0</Set>
		<Set>HRspcd=SC0000</Set>
	   <!-- 查询该记录是否存在--> 
	   <Exec func="PUB:ReadRecord"  error="IGNORE">
				<Arg name="SqlCmd" value="MultiQuery"/>
	  </Exec>

	  <If condition="~RetCod!=0">
		<Set>ret_code=04</Set>
		<Set>RspMsg=该记录不存在!</Set>
		<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code,$card)</Set>
		<Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		</Exec>
		<Return/>
	  </If>
	  
	  <Set>TCusNm=$CUST_NAME</Set>
	  <Set>NodTrc=SUBSTR($PAPER_NO,2,18)</Set>
	  
      <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="afetxnjnl"/>
      </Exec>
      <If condition="~RetCod=-1"><!--插入记录失败-->
        <Set>ret_code=YE</Set>
        <Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code,$card)</Set>
				<Exec func="YCT:CalYctMAC" error="IGNORE">
					<Args>
						<Arg name="MACKEY" value="$MACKEY" />
					</Args>
				</Exec>
				<Return/>
      </If>
      <Else>
      	<Set>ret_code=00</Set><!--插入记录成功-->
      </Else>
	  <!-- 计算返回包的MAC -->
	  <Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code,$card)</Set>

	  <Exec func="YCT:CalYctMAC" error="IGNORE">
		<Args>
			<Arg name="MACKEY" value="$MACKEY" />
		</Args>
	  </Exec>
	 
	</FlowCtrl>
</Transaction>


<Transaction code="482156" desc="羊城通划款冲正" log_switch="1">
	  <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    
	<DynSentence name="MultiQuery"> <!-- 检查该交易是否为划款冲正,需再增加单位代码在里面 -->
		<Sentence>
		  SELECT ACTNO,TXNAMT,LogNo,HTXNST,TxnCnl FROM afetxnjnl  WHERE RsFld1='%s' AND RsFld2='%s' AND ThdKey='%s' AND RsFld3='%s'
		</Sentence>
		<Fields>Old_Type|Old_Code|Old_sys_no|Old_TransDateTime|</Fields>
	</DynSentence>

	  <FlowCtrl>
     <Exec func="PUB:InitTransaction"/>      <!--交易初始化-->
	   <Set>ret_code=YE</Set>
	   <Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
	   <Set>mac_data=STRCAT($Code,$ActNo,$Trans_Amount,$TransDateTime,$sys_no,$Old_Type,$Old_Code,$Old_sys_no,$Old_TransDateTime)</Set>
	

	   <!-- 效验MAC -->
	   <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		</Exec>

		<If condition="IS_NOEQUAL_STRING($YCTMAC,$YCT_MAC)">
			<Set>ret_code=12</Set>
			<Set>RspMsg=MAC校验失败!</Set>
			<Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
			<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>
	    <Exec func="YCT:CalYctMAC" error="IGNORE">
		  <Args>
			  <Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
			<Return/>
		</If>


	   <!-- 查询该记录是否存在 -->
	   <Exec func="PUB:ReadRecord"  error="IGNORE">
				<Arg name="SqlCmd" value="MultiQuery"/>
	  </Exec>

	  <If condition="~RetCod!=0">
		<Set>ret_code=09</Set>
		<Set>RspMsg=冲正交易找不到原交易!</Set>
		<Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
		<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>
	    <Exec func="YCT:CalYctMAC" error="IGNORE">
		  <Args>
			  <Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
		<Return/>
	  </If>

	  <If condition="IS_EQUAL_STRING($HTXNST,C)">
			<Set>ret_code=10</Set>
			<Set>RspMsg=原交易已经冲正!</Set>
			<Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
			<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>
	    <Exec func="YCT:CalYctMAC" error="IGNORE">
		  <Args>
			  <Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
			<Return/>
		</If>
		
		<If condition="IS_EQUAL_STRING($HTXNST,F)">
			<Set>ret_code=16</Set>
			<Set>RspMsg=该交易为失败交易，无需冲正!</Set>
			<Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
			<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>
	    <Exec func="YCT:CalYctMAC" error="IGNORE">
		  <Args>
			  <Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
			<Return/>
		</If>

	  <!-- 进行记帐处理,需补充 -->
    <!--Set>TxnCnl=WEB</Set-->
    <Set>TTXNST=F</Set>
    <Exec func="PUB:GetVirtualTeller">
       <Arg name="TxnCnl" value="AFE"/>
       <Arg name="CnlSub" value="$BrNo"/>
    </Exec>
		<Exec func="PUB:ReadModuleCfg">
			<Arg name="Application" value="GZ_YCT"/>
			<Arg name="Transaction" value="482156"/>
		</Exec>
		<Call package="AFE" function="AFE_ThdCancel"/>
	  <!-- 记帐处理完成 -->

	  <Set>ret_code=00</Set>
	  <Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
	  <!-- 计算返回包的MAC -->
	  <Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>

	  <Exec func="YCT:CalYctMAC" error="IGNORE">
		<Args>
			<Arg name="MACKEY" value="$MACKEY" />
		</Args>
	  </Exec>
	 
	</FlowCtrl>
</Transaction>


<Transaction code="482154" desc="羊城通退款冲正" log_switch="1">
	<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    
	<DynSentence name="MultiQuery">
		<Sentence>
		  SELECT ACTNO,TXNAMT,LogNo,HTXNST,TxnCnl,TckNo,HLogNo,THDCHK FROM afetxnjnl WHERE RsFld1='%s' AND RsFld2='%s' AND ThdKey='%s' AND RsFld3='%s'
		</Sentence>
		<Fields>Old_Type|Old_Code|Old_sys_no|Old_TransDateTime|</Fields>
	</DynSentence>
	<DynSentence name="Updatestatus">
		<Sentence>
		  UPDATE afetxnjnl set HTxnSt='C',TTxnSt='C',TxnSts='C' WHERE RsFld1='%s' AND RsFld2='%s' AND ThdKey='%s' AND RsFld3='%s'
		</Sentence>
		<Fields>Old_Type|Old_Code|Old_sys_no|Old_TransDateTime|</Fields>
	</DynSentence>
	  <FlowCtrl>

	   <Set>ret_code=YE</Set>
	   <Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
	   <Set>mac_data=STRCAT($Code,$ActNo,$Trans_Amount,$TransDateTime,$sys_no,$Old_Type,$Old_Code,$Old_sys_no,$Old_TransDateTime)</Set>
	   <!-- 效验MAC -->
	   <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		</Exec>

		<If condition="IS_NOEQUAL_STRING($YCTMAC,$YCT_MAC)">
			<Set>ret_code=12</Set>
			<Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
			<Set>RspMsg=MAC校验失败!</Set>
			<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>
		  <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
			<Return/>
		</If>


	   <!-- 查询该记录是否存在 -->
	  <Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="MultiQuery"/>
	  </Exec>

	  <If condition="~RetCod!=0">
		<Set>ret_code=09</Set>
		<Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
		<Set>RspMsg=冲正交易找不到原交易!</Set>
		<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>
		  <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
		<Return/>
	  </If>

	  <If condition="IS_EQUAL_STRING($HTXNST,C)">
			<Set>ret_code=10</Set>
			<Set>RspMsg=原交易已经冲正!</Set>
			<Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
			<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>
		  <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
			<Return/>
		</If>
		<Exec func="PUB:ExecSql">
				<Arg name="SqlCmd" value="Updatestatus"/>
	  </Exec>
	  <If condition="~RetCod=-1">
		<Set>ret_code=YE</Set>
		<Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
		<Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>
		  <Exec func="YCT:CalYctMAC" error="IGNORE">
			<Args>
				<Arg name="MACKEY" value="$MACKEY" />
			</Args>
		  </Exec>
		<Return/>
	  </If>
	  <Set>ret_code=00</Set>
	  <Set>ActNo=ADDCHAR($ActNo,19, ,0)</Set>
	  <!-- 计算返回包的MAC -->
	  <Set>mac_data=STRCAT($Send_Code,$ActNo,$TransDateTime,$sys_no,$ret_code)</Set>
	  <Exec func="YCT:CalYctMAC" error="IGNORE">
		<Args>
			<Arg name="MACKEY" value="$MACKEY" />
		</Args>
	  </Exec>
	 
	</FlowCtrl>
</Transaction>

<Transaction code="482165" desc="退款交易对帐">
		<DynSentence name="QryJnlInfo">            <!--查询流水信息 -->
			<Sentence>
				SELECT distinct LOGNO FROM afetxnjnl 
				WHERE  BrNo='441999' AND ActDat ='%s'and HTxnSt='S' and CAgtNo='%s' and RSFLD2='Z02011'
			</Sentence>
			<Fields>ClrDat|CAgtNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql01">            <!--查询信息 -->
			<Sentence>
				SELECT RSFLD2,ActNo,TxnAmt,RSFLD3,Thdkey,TCUSID FROM afetxnjnl 
				WHERE  BrNo='441999' AND ActDat='%s' and HTxnSt='S' and CAgtNo='%s' and LOGNO='%s' and RSFLD2='Z02011'
				<!--过程代码,银行帐号,交易金额,银行交易日期时间,系统参考号,羊城通卡号-->
			</Sentence>
			<Fields>ClrDat|CAgtNo|LOGNO|</Fields>
		</DynSentence>
		<DynSentence name="Sql02">            <!--汇总 -->
			<Sentence>
				SELECT SUM(CAST(TxnAmt AS BIGINT)) YCTAMT,COUNT(*) YCTcnt 
				FROM afetxnjnl WHERE BrNo='441999' AND ActDat='%s' and HTxnSt='S' and CAgtNo='%s' and RSFLD2='Z02011'
			</Sentence>
			<Fields>ClrDat|CAgtNo|</Fields>
		</DynSentence>		
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>
			<Exec func="PUB:GetLogNo"/>
			
			<Set>AppNm=GZ_YCTTK</Set>
			<Exec func="PUB:CodeSwitching">
				<Arg name="DatSrc"  value="OPFCSW"/>
				<Arg name="SourNam" value="AppNm"/>
				<Arg name="DestNam" value="CAgtNo"/>
				<Arg name="TblNam"  value="GZ_AppNm"/>
			</Exec>
			<Set>ClrDat=GETDATE()</Set>
			<Set>ClrDat=CALCDATE($ClrDat,-,d,1)</Set>
	    <Set>DatFil=STRCAT(dat/opf/,ZDCZCMMBTK,$ClrDat,.txt)</Set> 
		  <Set>DatFil1=STRCAT(ZDCZCMMBTK,$ClrDat,.txt)</Set>    
			
			<!--生成文件-->
			<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql02" />
			</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>			
					<Exec func="PUB:WriteFile" error="IGNORE">
					  <Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="w"/>
				    <Arg name="Data"	 value="$ClrDat"/>
				    <Arg name="Data"	 value="000000"/>
				    <Arg name="Data"	 value=","/>
				    <Arg name="Data"	 value="$ClrDat"/>
				    <Arg name="Data"	 value="595959"/>
				    <Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$YCTcnt"/>
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="AMTFMT($YCTAMT)"/> 
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>
			
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql"  value="QryJnlInfo"/>
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标出错</Set>
				<Return/>
			</If>
						
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE">
					<Arg name="CursorName" value="CURSOR_1"/>
				</Exec>
				<If condition="~RetCod=100">
					<Break/>
				</If>
		
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql01" />
					</Exec>
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>			
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="$RSFLD2"/> <!--过程代码 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="ADDCHAR($ActNo,19, ,0)"/> <!--银行帐号 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$TxnAmt"/> <!--交易金额 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$RSFLD3"/> <!--银行交易日期时间 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$Thdkey"/> <!--系统参考号 -->
						<Arg name="Data"	 value=","/>						
						<Arg name="Data"	 value="$TCUSID"/> <!--羊城通卡号 -->
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>									
      </While>
			<Set>SendFil=$DatFil</Set>
			<Exec func="PUB:CloseCursor" error="IGNORE">
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>      			      								
		
			<Exec func="PUB:FtpPut" error="IGNORE">
				<Arg name="IpAdr" value="10.240.18.21"/>
				<Arg name="UsrNam" value="cmmb"/>
				<Arg name="UsrPwd" value="cmmb123"/>
				<Arg name="ObjDir" value="import"/>
				<Arg name="LclDir" value="dat/opf"/>
				<Arg name="LclFil" value="$DatFil1"/>
			</Exec>
			
			<If condition="~RetCod=-1">						
				<Set>RspCod=478715</Set>
				<Set>RspMsg=向第三方发送文件失败</Set>
				<Return/>
			</If>	
		</FlowCtrl>
</Transaction>

<Transaction code="482162" desc="划款交易对帐">
		<DynSentence name="QryJnlInfo">            <!--查询流水信息 -->
			<Sentence>
				SELECT distinct LOGNO FROM afetxnjnl 
				WHERE BrNo='441999' AND ActDat ='%s'and HTxnSt='S' and CAgtNo='%s' and RSFLD2='Z01051'
			</Sentence>
			<Fields>ClrDat|CAgtNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql01">            <!--查询信息 -->
			<Sentence>
				SELECT RSFLD2,ActNo,TxnAmt,FTXNTM,THDKEY,TCUSID FROM afetxnjnl 
				WHERE BrNo='441999' AND ActDat='%s' and HTxnSt='S' and CAgtNo='%s' and LOGNO='%s' and RSFLD2='Z01051'
				<!--过程代码,银行帐号,交易金额,银行交易日期时间,系统参考号,羊城通卡号-->
			</Sentence>
			<Fields>ClrDat|CAgtNo|LOGNO|</Fields>
		</DynSentence>
		<DynSentence name="Sql02">            <!--汇总 -->
			<Sentence>
				SELECT SUM(CAST(TxnAmt AS BIGINT)) YCTAMT,COUNT(*) YCTcnt 
				FROM afetxnjnl WHERE BrNo='441999' AND ActDat='%s' and HTxnSt='S' and CAgtNo='%s' and RSFLD2='Z01051'
			</Sentence>
			<Fields>ClrDat|CAgtNo|</Fields>
		</DynSentence>		
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>
			<Exec func="PUB:GetLogNo"/>
			
			<Set>AppNm=GZ_YCT</Set>
			<Exec func="PUB:CodeSwitching">
				<Arg name="DatSrc"  value="OPFCSW"/>
				<Arg name="SourNam" value="AppNm"/>
				<Arg name="DestNam" value="CAgtNo"/>
				<Arg name="TblNam"  value="GZ_AppNm"/>
			</Exec>
			<Set>ClrDat=GETDATE()</Set>
			<Set>ClrDat=CALCDATE($ClrDat,-,d,1)</Set>
	    <Set>DatFil=STRCAT(dat/opf/,ZDCZCMMBHK,$ClrDat,.txt)</Set> 
		  <Set>DatFil1=STRCAT(ZDCZCMMBHK,$ClrDat,.txt)</Set>    
			
			<!--生成文件-->
			<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql02" />
			</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>			
					<Exec func="PUB:WriteFile" error="IGNORE">
					  <Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="w"/>
				    <Arg name="Data"	 value="$ClrDat"/>
				    <Arg name="Data"	 value="000000"/>
				    <Arg name="Data"	 value=","/>
				    <Arg name="Data"	 value="$ClrDat"/>
				    <Arg name="Data"	 value="595959"/>
				    <Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$YCTcnt"/>
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="AMTFMT($YCTAMT)"/> 
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>
			
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql"  value="QryJnlInfo"/>
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标出错</Set>
				<Return/>
			</If>
						
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE">
					<Arg name="CursorName" value="CURSOR_1"/>
				</Exec>
				<If condition="~RetCod=100">
					<Break/>
				</If>
		
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql01" />
					</Exec>
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>			
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="$RSFLD2"/> <!--过程代码 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="ADDCHAR($ActNo,19, ,0)"/> <!--银行帐号 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$TxnAmt"/> <!--交易金额 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$FTXNTM"/> <!--银行交易日期时间 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$THDKEY"/> <!--系统参考号 -->
						<Arg name="Data"	 value=","/>						
						<Arg name="Data"	 value="$TCUSID"/> <!--羊城通卡号 -->
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>									
      </While>
			<Set>SendFil=$DatFil</Set>
			<Exec func="PUB:CloseCursor" error="IGNORE">
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>      			      								
		
			<Exec func="PUB:FtpPut" error="IGNORE">
				<Arg name="IpAdr" value="10.240.18.21"/>
				<Arg name="UsrNam" value="cmmb"/>
				<Arg name="UsrPwd" value="cmmb123"/>
				<Arg name="ObjDir" value="import"/>
				<Arg name="LclDir" value="dat/opf"/>
				<Arg name="LclFil" value="$DatFil1"/>
			</Exec>
			
			<If condition="~RetCod=-1">						
				<Set>RspCod=478715</Set>
				<Set>RspMsg=向第三方发送文件失败</Set>
				<Return/>
			</If>	
		</FlowCtrl>
</Transaction>

<Transaction code="482166" desc="签/解约汇总及明细">
		<DynSentence name="QryJnlInfo">            <!--查询签约流水信息 -->
			<Sentence>
				SELECT distinct sys_no FROM yctreg WHERE reserve2='%s' and CNCL_FLAG='0'
			</Sentence>
			<Fields>ClrDat|</Fields>
		</DynSentence>
		<DynSentence name="QryJnlInfo1">            <!--查询解约流水信息 -->
			<Sentence>
				SELECT distinct sys_no FROM yctreg WHERE CNCL_DATE='%s' and CNCL_FLAG='1'
			</Sentence>
			<Fields>ClrDat1|</Fields>
		</DynSentence>
		<DynSentence name="Sql01">            <!--查询签约信息 -->
			<Sentence>
				SELECT reserve3,bank_acc,tran_date,sys_no,acc_type,sign_flag,contact_no,cust_name,paper_no FROM yctreg 
				WHERE reserve2='%s' and sys_no='%s' and CNCL_FLAG='0'
				<!--过程代码,银行帐号,银行交易日期时间,系统参考号,是否预扣标志,签约类型,合同号,用户名,证件类型号码-->
			</Sentence>
			<Fields>ClrDat|sys_no|</Fields>
		</DynSentence>
		<DynSentence name="Sql04">            <!--查询解约信息 -->
			<Sentence>
				SELECT reserve3,bank_acc,tran_date,sys_no,acc_type,sign_flag,contact_no,cust_name,paper_no FROM yctreg 
				WHERE CNCL_DATE='%s' and sys_no='%s' and CNCL_FLAG='1'
				<!--过程代码,银行帐号,银行交易日期时间,系统参考号,是否预扣标志,签约类型,合同号,用户名,证件类型号码-->
			</Sentence>
			<Fields>ClrDat1|sys_no|</Fields>
		</DynSentence>
		<DynSentence name="Sql02">            <!--解约汇总 -->
			<Sentence>
				SELECT COUNT(*) JYcnt FROM yctreg WHERE CNCL_DATE='%s' and reserve3='Z09021' and CNCL_FLAG='1'
			</Sentence>
			<Fields>ClrDat1|</Fields>
		</DynSentence>		
				<DynSentence name="Sql03">            <!--签约汇总 -->
			<Sentence>
				SELECT COUNT(*) QYcnt FROM yctreg WHERE reserve2='%s' and reserve3='Z09011' and CNCL_FLAG='0'
			</Sentence>
			<Fields>ClrDat|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>
			<Exec func="PUB:GetLogNo"/>

			<Set>ClrDat=GETDATE()</Set>
			<Set>ClrDat=CALCDATE($ClrDat,-,d,1)</Set>
			<Set>ClrDat1=SUBSTR($ClrDat,5,4)</Set>
			<!--<Set>ClrDat=GETDATE()</Set>-->
			<!--<Set>ClrDat=20090322</Set>-->
	    <Set>DatFil=STRCAT(dat/opf/,ZDCZCMMBQY,$ClrDat,.txt)</Set> 
		  <Set>DatFil1=STRCAT(ZDCZCMMBQY,$ClrDat,.txt)</Set>    
			
			<!--生成文件-->
			<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql02" />
			</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
			<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql03" />
			</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
					<Exec func="PUB:WriteFile" error="IGNORE">
					  <Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="w"/>
				    <Arg name="Data"	 value="$ClrDat"/>
				    <Arg name="Data"	 value="000000"/>
				    <Arg name="Data"	 value=","/>
				    <Arg name="Data"	 value="$ClrDat"/>
				    <Arg name="Data"	 value="595959"/>
				    <Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$QYcnt"/>
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$JYcnt"/> 
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>
			
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql"  value="QryJnlInfo"/>
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标出错</Set>
				<Return/>
			</If>
						
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE">
					<Arg name="CursorName" value="CURSOR_1"/>
				</Exec>
				<If condition="~RetCod=100">
					<Break/>
				</If>
		
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql01" />
					</Exec>
					<If condition="~RetCod!=0">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="$reserve3"/> <!--过程代码 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="ADDCHAR($bank_acc,19, ,0)"/> <!--银行帐号 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$tran_date"/> <!--银行交易日期时间 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$sys_no"/> <!-- 系统参考号 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$acc_type"/> <!--是否预扣标志-->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$sign_flag"/> <!--签约类型-->
						<Arg name="Data"	 value=","/>	
						<Arg name="Data"	 value="ADDCHAR($contact_no,20, ,0)"/> <!--合同号-->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="ADDCHAR($cust_name,8, ,0)"/> <!--用户名 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="ADDCHAR($paper_no,21, ,0)"/> <!--证件类型号码-->	
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>	
			</While>
			<Exec func="PUB:CloseCursor" error="IGNORE">
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec> 
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql"  value="QryJnlInfo1"/>
				<Arg name="CursorName" value="CURSOR_2"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标出错</Set>
				<Return/>
			</If>
						
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE">
					<Arg name="CursorName" value="CURSOR_2"/>
				</Exec>
				<If condition="~RetCod=100">
					<Break/>
				</If>
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql04" />
					</Exec>
					<If condition="~RetCod!=0">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="$reserve3"/> <!--过程代码 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="ADDCHAR($bank_acc,19, ,0)"/> <!--银行帐号 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$tran_date"/> <!--银行交易日期时间 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$sys_no"/> <!-- 系统参考号 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$acc_type"/> <!--是否预扣标志-->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="$sign_flag"/> <!--签约类型-->
						<Arg name="Data"	 value=","/>	
						<Arg name="Data"	 value="ADDCHAR($contact_no,20, ,0)"/> <!--合同号-->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="ADDCHAR($cust_name,8, ,0)"/> <!--用户名 -->
						<Arg name="Data"	 value=","/>
						<Arg name="Data"	 value="ADDCHAR($paper_no,21, ,0)"/> <!--证件类型号码-->	
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>								
      </While>
			<Set>SendFil=$DatFil</Set>
			<Exec func="PUB:CloseCursor" error="IGNORE">
				<Arg name="CursorName" value="CURSOR_2"/>
			</Exec>      			      								
		
			<Exec func="PUB:FtpPut" error="IGNORE">
				<Arg name="IpAdr" value="10.240.18.21"/>
				<Arg name="UsrNam" value="cmmb"/>
				<Arg name="UsrPwd" value="cmmb123"/>
				<Arg name="ObjDir" value="import"/>
				<Arg name="LclDir" value="dat/opf"/>
				<Arg name="LclFil" value="$DatFil1"/>
			</Exec>
			
			<If condition="~RetCod=-1">						
				<Set>RspCod=478715</Set>
				<Set>RspMsg=向第三方发送文件失败</Set>
				<Return/>
			</If>	
		</FlowCtrl>
</Transaction>

<Transaction code="482159" desc="查询历史交易记录" log_switch="1">
	<Attributes>
      <Attribute name="nodatabase" value="2"/>
  </Attributes>
	<DynSentence name="MultiQuery">
			<Sentence>
				SELECT TckNo,ActDat,TCUSID,Rsfld2,TxnAmt from
			  (SELECT TckNo,ActDat,TCUSID,Rsfld2,TxnAmt from afetxnjnl WHERE ActNo='%s' and Rsfld2='Z01051' and HTXNST='S'
			  union SELECT TckNo,ActDat,TCUSID,Rsfld2,TxnAmt from afetxnjnl WHERE ActNo='%s' and Rsfld2='Z02011' 
			  and HTXNST='S' and ChkFlg='1')
			  as tmp order by ActDat DESC FETCH FIRST 20 ROWS ONLY
			</Sentence>
			<Fields>ActNo|ActNo|</Fields>
	</DynSentence>
	<FlowCtrl>
	  <Exec func="PUB:InitTransaction"/>            <!--交易初始化,预留-->
		  <Exec func="PUB:MultiQuery">
	      <Args>
	        <Arg name="SqlCmd"  value="MultiQuery"/>
	        <Arg name="RecNumPerPage"  value="20"/>
	      </Args>
	    </Exec>
	</FlowCtrl>
</Transaction>

</Application>
