<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="TBCA" code="438">
  <!--广东烟草业务本地主控-->
<!--动态库定义-->
	<LibDeclare>
		<Library name="TBC"  value="app/tbc/dll/tbc.so" />
	</LibDeclare>
  <ConfigDeclare>
    <Config name="BatFormat"   value="etc/TBC_FMT_441999.XML"/>
    <Config name="ParaFile"    value="etc/CFG_TBC_441999.XML"/>
    <Config name="OPFCSW"      value="etc/TBC_CSW_441999.XML"/>
  </ConfigDeclare>
  <PackageDeclare>
    <Package name="AFE"        value="etc/DAFE_PKG.XML"/>
  </PackageDeclare>
  <TableDeclare>
    <Table name="afetxnjnl"    value="afetxnjnl"/>  <!--业务流水表-->
    <Table name="afebatrec"    value="afebatrec"/>  <!--批量扩展表-->
    <Table name="tbccusagt"    value="tbccusagt"/>  <!--烟草客户签约表-->
    <Table name="tbcbasinf"    value="tbcbasinf"/>  <!--烟草基础信息表-->
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="AplCls"    value="438"/>
  </BusDefDeclare>
  <GlobalFunction>
    <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
    <!--add by xuan_20101108-->
    <Function name="_after">
        <Process>
           <If condition="ISNULL($MsgTyp)">
              <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                 <Set>MsgTyp=N</Set>
                 <Set>RspCod=000000</Set>
              </If>
              <Else>
                 <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                    <Set>MsgTyp=E</Set>
                 </If>
                 <Else>
                    <Set>MsgTyp=N</Set>
                 </Else>
              </Else>
           </If>
        </Process>
    </Function>
    <!--end by xuan_20101108-->
  </GlobalFunction>
  <Define>
    <Macro name="Chk_TxnSrc">  <!--检查交易来源-->
      <If condition="INTCMP(STRLEN(DELBOTHSPACE($TxnSrc)),3,0)">
        <Set>TxnCnl=TRM</Set>
        <Set>CnlTyp=0</Set>
      </If>
      <Else>
        <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TxnSrc"/>
          <Arg name="DestNam" value="CnlTyp"/>
          <Arg name="TblNam"  value="TxnSrc2CnlTyp"/>
        </Exec>
      </Else>
    </Macro>

    <Macro name="TxnSrc_TxnCnl">
      <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="TxnSrc"/>
        <Arg name="DestNam" value="TxnCnl"/>
        <Arg name="TblNam"  value="TxnSrc2TxnCnl"/>
      </Exec>
    </Macro>

		<!--20121020 反洗钱接口调用 begin-->
		<Macro name="AntiMoneylaudry">
       <!--反洗钱需要增加主机接口调用BEGIN-->
       <Set>LogNo= </Set>
       <Set>TxnDat=$ActDat</Set> <!--交易日期-->
       <Set>HstTrc=$HLogNo</Set> <!--日志号-->
       <Set>HLogNo= </Set>
       <Set>OTckNo=$TckNo</Set>  <!--流水号-->
       <Set>TxnMod=000151</Set>  <!--交易方式:人民币非现金其他-->
       <Set>TCommNm=交通银行</Set>      <!--对方金融机构名称-->
       <Set>TCusNm= </Set>       <!--对方客户名称-->
       <Set>TIdTyp= </Set>       <!--对方证件种类-->
       <Set>TIdNo= </Set>        <!--对方证件号码-->
       <Set>StlActNo=$TActNo</Set> <!--交易对手账号-->
       
       <Exec func="PUB:CallHostOther" error="IGNORE">
          <Arg name="TxnCod" value="472600"></Arg>
          <Arg name="ObjSvr" value="SHSTPUB2"></Arg>
       </Exec>
       <!--反洗钱需要增加主机接口调用END-->
		</Macro>
		<!--20121020 end-->
  </Define>


<Transaction code="483888" desc="线路检测">
	 <FlowCtrl>
     <!--交易初始化,预留-->
     <Exec func="PUB:InitTransaction"/>
     <!--默认交易返回成功-->
     <Set>RspCod=0000</Set>
     <Set>RspMsg=交易成功</Set>         
	 </FlowCtrl>
</Transaction>

<Transaction code="483801" desc="签到">
	 <DynSentence name="UpdBasInf">
     <Sentence>
        UPDATE tbcbasinf SET DevId='%s',Teller='%s',TranDt='%s',SigSts='%s'
           WHERE DptId='%s'
     </Sentence>
     <Fields>DevId|Teller|TranDt|SigSts|DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="SelComKey">
     <Sentence>
         SELECT ComKey FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
	 <FlowCtrl>
     <!--交易初始化,预留-->
     <Exec func="PUB:InitTransaction"/>
     <!--默认交易返回成功-->
     <Set>RspCod=0000</Set>
     
     <Set>TranDt=SUBSTR($TranTm,1,8)</Set>
     <!--会计日期和交易发起日期是否一致 test暂时封闭
     <If condition="IS_NOEQUAL_STRING($ActDat,$TranDt)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=银行日期与交易发起日期不一致</Set>
     	 <Return/>
     </If>
     -->
     <!--获取加密密码-->
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="SelComKey"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库操作错误</Set>
       <Return/>
     </If>
     <!--获取时间戳-->
     <Set>TimStp=GETDATETIME(YYMMDDHHMISS)</Set>			
     <If condition="~RetCod=-1">
     	<Set>MsgTyp=E</Set>
     	<Set>RspCod=9999</Set>
     	<Set>RspMsg=取时间戳失败!</Set>
     	<Return/>
     </If> 
     <Set>tmpFMPVal=STRCAT($dbComkey,$TimStp)</Set>
     <!--MD5加密-->
     <Exec func="TBC:RtyGetMD5" error="IGNORE">
     	<Args>
     		<Arg name="para1" value="$tmpFMPVal" />
     	</Args>			
     </Exec>
     <If condition="~RetCod=-1">
     	<Set>MsgTyp=E</Set>
     	<Set>RspCod=9999</Set>
     	<Set>RspMsg=生成密钥失败!</Set>
     	<Return/>
     </If>
     <!--生成通讯密钥-->
     <Set>NewKey=SUBSTR($FMPVal,1,16)</Set>
     <Set>DatFil=STRCAT(key/,$DptId,.key)</Set>
     <!--生成通讯密钥文件开始-->
     <Exec func="PUB:WriteFile" error="IGNORE">
       <Arg name="FileName" value="$DatFil"/>
       <Arg name="OpenMode" value="w"/>
       <Arg name="Data"   value="$NewKey"/>
     </Exec>
     
     <Set>SigSts=0</Set>
     <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd"   value="UpdBasInf"/>
     </Exec>
     <If condition="~RetCod=-1">
       <Exec func="PUB:RollbackWork" error="IGNORE" />
       <Set>MsgTyp=E</Set>
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库处理失败!</Set>
       <Return/>
     </If>
     <Set>RspMsg=交易成功</Set>         
	 </FlowCtrl>
</Transaction>

<Transaction code="483802" desc="签退">
	 <DynSentence name="UpdBasInf">
     <Sentence>
        UPDATE tbcbasinf SET DevId='%s',Teller='%s',TranDt='%s',SigSts='%s'
           WHERE DptId='%s'
     </Sentence>
     <Fields>DevId|Teller|TranDt|SigSts|DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="STxnJnl01">
     <Sentence>
         SELECT LogNo,RsFld1,FTxnTm,TCusId,ActNo,TxnAmt FROM afetxnjnl 
           WHERE ActDat='%s' and RsFld2='%s' and  HRspCd='SC0000' and  HTxnSt='S'
             ORDER BY LogNo
     </Sentence>
     <Fields>ActDat|DptId|</Fields>
   </DynSentence>
	 <FlowCtrl>
     <!--构成分行号-->
     <!--Set>BrNo=STRCAT(SUBSTR($CAgtNo,1,3),999)</Set-->
     <!--交易初始化,预留-->
     <Exec func="PUB:InitTransaction"/>
     <!--默认交易返回成功-->
     <Set>RspCod=0000</Set>
     
     <Set>TranDt=SUBSTR($TranTm,1,8)</Set>
     <!--会计日期和交易发起日期是否一致 test暂时封闭
     <If condition="IS_NOEQUAL_STRING($ActDat,$TranDt)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=银行日期与交易发起日期不一致</Set>
     	 <Return/>
     </If>
     -->

     <Set>SigSts=1</Set>
     <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd"   value="UpdBasInf"/>
     </Exec>
     <If condition="~RetCod=-1">
       <Exec func="PUB:RollbackWork" error="IGNORE" />
       <Set>MsgTyp=E</Set>
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库处理失败!</Set>
       <Return/>
     </If>


     <Set>RspMsg=交易成功</Set>         
	 </FlowCtrl>
</Transaction>

<Transaction code="483803" desc="开户">
	 <DynSentence name="UpdCusAgt">
     <Sentence>
        UPDATE tbccusagt SET 
           BrNo='%s',CAgtNo='%s',ComId='%s',TCusNm='%s',CusTyp='%s',PasTyp='%s',PasId='%s',LiceId='%s',AccTyp='%s',
           ActNo='%s',PasFlg='%s',PasWrd='%s',Addres='%s',TelNum='%s',DevId='%s',Teller='%s',OpnDat='%s',Status='%s'
        WHERE　CustId='%s' AND DptId='%s'
     </Sentence>
     <Fields>BrNo|CAgtNo|ComId|TCusNm|CusTyp|PasTyp|PasId|LiceId|AccTyp|ActNo|PasFlg|PasWrd|Addres|TelNum|DevId|Teller|ActDat|Status|CustId|DptId|</Fields>
   </DynSentence>
	 <DynSentence name="InsCusAgt">
     <Sentence>
        INSERT INTO tbccusagt(BrNo,CAgtNo,CustId,DptId,ComId,TCusNm,CusTyp,PasTyp,PasId,LiceId,AccTyp,ActNo,PasFlg,PasWrd,Addres,TelNum,DevId,Teller,OpnDat,Status)
           VALUES('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')
     </Sentence>
     <Fields>BrNo|CAgtNo|CustId|DptId|ComId|TCusNm|CusTyp|PasTyp|PasId|LiceId|AccTyp|ActNo|PasFlg|PasWrd|Addres|TelNum|DevId|Teller|ActDat|Status|</Fields>
   </DynSentence>
 	 <DynSentence name="ChkSigSts">
     <Sentence>
         SELECT SigSts FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="ChkCusAgt">
     <Sentence>
         SELECT count(*) CNT FROM tbccusagt WHERE CustId='%s' and DptId='%s' and Status='%s'
     </Sentence>
     <Fields>CustId|DptId|Status|</Fields>
   </DynSentence>     
   <FlowCtrl>
     <!--构成分行号-->
     <Set>BrNo=STRCAT(SUBSTR($CAgtNo,1,3),999)</Set>
     <!--交易初始化,预留-->
     <Exec func="PUB:InitTransaction"/>
     <!--取前置流水号
     <Exec func="PUB:GetLogNo"/>
     -->
     <!--默认交易返回成功-->
     <Set>RspCod=0000</Set>
     
     <Set>TranDt=SUBSTR($TranTm,1,8)</Set>
     <!--会计日期和交易发起日期是否一致 test暂时封闭
     <If condition="IS_NOEQUAL_STRING($ActDat,$TranDt)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=银行日期与交易发起日期不一致</Set>
     	 <Return/>
     </If>
     -->
     <!--检查系统签到状态-->
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="ChkSigSts"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库操作错误</Set>
       <Return/>
     </If>
     <If condition="IS_NOEQUAL_STRING($SigSts,0)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=签退状态,暂停交易</Set>
     	 <Return/>
     </If>

     <!--构成网点号-->
     <Switch  expression="$BrNo">
       <Case value="441999">
         <Set>NodNo=441800</Set>
         <Break/>
       </Case>
       <Case value="444999">
         <Set>NodNo=444800</Set>
         <Break/>
       </Case>
       <Case value="446999">
         <Set>NodNo=446800</Set>
         <Break/>
       </Case>
       <Case value="445999">
         <Set>NodNo=445800</Set>
         <Break/>
       </Case>
       <Case value="483999">
         <Set>NodNo=483800</Set>
         <Break/>
       </Case>
       <Case value="484999">
         <Set>NodNo=484800</Set>
         <Break/>
       </Case>
       <Case value="485999">
         <Set>NodNo=485800</Set>
         <Break/>
       </Case>
       <Case value="491999">
         <Set>NodNo=491800</Set>
         <Break/>
       </Case>
       <Case value="476999">
         <Set>NodNo=476800</Set>
         <Break/>
       </Case>
     </Switch>
      <!--取电子柜员号-->
      <Set>TxnCnl=TBC</Set>       <!--取电子柜员号用-->
      <Set>TxnObj=OFRTTBCA</Set>
      <Exec func="PUB:GetVirtualTeller"><!--TODO-->
        <Arg name="TxnCnl" value="TBC"/>
      </Exec>
      <Set>TlrId=$TlrId</Set>
      <Set>TTxnCd=483803</Set>
           
      <!--校验各分行账号-->
      <!--441999广东省分行-->
      <!--444999珠海分行-->
      <!--446999佛山分行-->
      <!--445999汕头分行-->
      <!--483999东莞分行-->
      <!--484999中山分行-->
      <!--485999揭阳支行-->
      <!--491999惠州分行-->
      <!--761999江门分行-->
      <!--只有广州、珠海、佛山和中山有Acjud_行号函数，其他分行要加-->
      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>
      <!--向主机查询账户信息-->
      <Switch expression="$ActCls">
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
          <If condition="INTCMP($ActCls,3,3)">
             <Set>ActFlg=4</Set>  <!--对私卡号-->
             <Set>ActTyp=4</Set>
          </If>
          <Else>
             <Set>ActFlg=2</Set>  <!--对私帐号-->
             <Set>ActTyp=2</Set>
          </Else>
          <Set>CcyCod=CNY</Set>

          <!--上主机查询客户资料-->
          <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="HTxnCd" value="476520"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="$MsgTyp!=N">
            <Set>RspCod=460399</Set>
            <Set>RspMsg=帐户不存在</Set>
            <Return/>
          </If>
          <!--校验账户名称、开户证件类型和开户证件号码-->
          <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
          <Set>IDNo=DELBOTHSPACE($IDNo)</Set>
          <If condition="OR(IS_NOEQUAL_STRING($TCusNm,$ActNam),IS_NOEQUAL_STRING($PasId,$IDNo))">
            <Set>RspCod=9999</Set>
            <Set>RspMsg=账户名称或者证件号码不符</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Case value="0" /> <!-- 对公 -->
        <Case value="4" >
          <Set>ActTyp=1</Set>
          <!--上主机查询客户资料-->
          <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="HTxnCd" value="109000"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="$MsgTyp!=N">
            <Set>RspCod=9999</Set>
            <Set>RspMsg=帐户不存在</Set>
            <Return/>
          </If>
          <!--校验账户名称、开户证件类型和开户证件号码-->
          <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
          <Set>ActQ04=DELBOTHSPACE($ActQ04)</Set>
          <If condition="IS_NOEQUAL_STRING($TCusNm,$ActNam)">
            <Set>RspCod=9999</Set>
            <Set>RspMsg=账户名称不符</Set>
            <Return/>
          </If>
          <If condition="IS_NOEQUAL_STRING($PasId,$ActQ04)">
            <Set>RspCod=9999</Set>
            <Set>RspMsg=证件号码不符</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Default>
            <Set>RspCod=9999</Set>
            <Set>RspMsg=帐户类型不存在</Set>
            <Return/>
        </Default>
      </Switch> 

     <!--客户签约状态-->
     <Set>Status=0</Set>
     <!--检查该客户是否已签约-->
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="ChkCusAgt"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库操作错误</Set>
       <Return/>
     </If>
     <If condition="IS_EQUAL_STRING($CNT,0)">
       <!--新增开户-->     
       <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="InsCusAgt"/>
       </Exec>
       <If condition="~RetCod=-1">
         <Exec func="PUB:RollbackWork" error="IGNORE" />
         <Set>MsgTyp=E</Set>
         <Set>RspCod=9999</Set>
         <Set>RspMsg=数据库处理失败!</Set>
         <Return/>
       </If>
     </If>
     <Else>
     	 <!--修改开户信息-->
       <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UpdCusAgt"/>
       </Exec>
       <If condition="~RetCod=-1">
         <Exec func="PUB:RollbackWork" error="IGNORE" />
         <Set>MsgTyp=E</Set>
         <Set>RspCod=9999</Set>
         <Set>RspMsg=数据库处理失败!</Set>
         <Return/>
       </If>
     </Else>
     <Set>RspCod=0000</Set>
     <Set>RspMsg=交易成功</Set>      
   </FlowCtrl>
</Transaction>

<Transaction code="483804" desc="销户">
	 <DynSentence name="UpdCusAgt">
     <Sentence>
        UPDATE tbccusagt SET 
           Status='%s'
        WHERE　CustId='%s' and DptId='%s' and Status='0'
     </Sentence>
     <Fields>Status|DptId|CustId|</Fields>
   </DynSentence>
 	 <DynSentence name="ChkSigSts">
     <Sentence>
         SELECT SigSts FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="ChkCusAgt">
     <Sentence>
         SELECT count(*) CNT FROM tbccusagt WHERE CustId='%s' and DptID='%s' and Status='%s'
     </Sentence>
     <Fields>CustId|DptId|Status|</Fields>
   </DynSentence>
 	 <DynSentence name="SelCusAgt">
     <Sentence>
         SELECT TCusNm dbTCusNm,PasId dbPasId,LiceId dbLiceId,ActNo dbActNo FROM tbccusagt WHERE CustId='%s' and DptId='%s' and Status='%s'
     </Sentence>
     <Fields>CustId|DptId|Status|</Fields>
   </DynSentence>     
   <FlowCtrl>

     <!--交易初始化,预留-->
     <Exec func="PUB:InitTransaction"/>

     <!--默认交易返回成功-->
     <Set>RspCod=0000</Set>
     
     <Set>TranDt=SUBSTR($TranTm,1,8)</Set>
     <!--会计日期和交易发起日期是否一致 test暂时封闭
     <If condition="IS_NOEQUAL_STRING($ActDat,$TranDt)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=银行日期与交易发起日期不一致</Set>
     	 <Return/>
     </If>
     -->
     <!--检查系统签到状态-->
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="ChkSigSts"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库操作错误</Set>
       <Return/>
     </If>
     <If condition="IS_NOEQUAL_STRING($SigSts,0)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=签退状态,暂停交易</Set>
     	 <Return/>
     </If>


     <!--客户签约状态-->
     <Set>Status=0</Set>
     <!--检查该客户是否已签约-->
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="ChkCusAgt"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库操作错误</Set>
       <Return/>
     </If>
     <If condition="IS_EQUAL_STRING($CNT,0)">
       <!--已注销-->     
       <Set>RspMsg=账号已注销</Set>
       <Return/>
     </If>
     <Else>
       <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="SelCusAgt"/>
       </Exec>
       <If condition="~RetCod!=0">
         <Set>RspCod=9999</Set>
         <Set>RspMsg=数据库操作错误</Set>
         <Return/>
       </If>
       <If condition="IS_NOEQUAL_STRING($TCusNm,$dbTCusNm)">
       	 <Set>RspCod=9999</Set>
       	 <Set>RspMsg=客户姓名不符</Set>
       	 <Return/>
       </If>
       <If condition="IS_EQUAL_STRING($CusTyp,01)">
         <If condition="IS_NOEQUAL_STRING($PasId,$dbPasId)">
         	 <Set>RspCod=9999</Set>
         	 <Set>RspMsg=身份证号码不符</Set>
         	 <Return/>
         </If>
       </If>
       <Else>
         <If condition="IS_NOEQUAL_STRING($LiceId,$dbLiceId)">
         	 <Set>RspCod=9999</Set>
         	 <Set>RspMsg=营业执照号码不符</Set>
         	 <Return/>
         </If>
       </Else>
       <If condition="IS_NOEQUAL_STRING($ActNo,$dbActNo)">
       	 <Set>RspCod=9999</Set>
       	 <Set>RspMsg=卡/账户号码不符</Set>
       	 <Return/>
       </If>      	 
     	 <!--注销账号-->
     	 <Set>Status=1</Set>
       <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UpdCusAgt"/>
       </Exec>
       <If condition="~RetCod=-1">
         <Exec func="PUB:RollbackWork" error="IGNORE" />
         <Set>MsgTyp=E</Set>
         <Set>RspCod=9999</Set>
         <Set>RspMsg=数据库处理失败!</Set>
         <Return/>
       </If>
       <Set>RspCod=0000</Set>
       <Set>RspMsg=交易成功</Set> 
     </Else>
          
   </FlowCtrl>
</Transaction>

<Transaction code="483805" desc="扣款">
 	 <DynSentence name="ChkCusAgt">
     <Sentence>
         SELECT count(*) CNT FROM tbccusagt WHERE CustId='%s' and DptId='%s' and Status='%s'
     </Sentence>
     <Fields>CustId|DptId|Status|</Fields>
   </DynSentence>
 	 <DynSentence name="ChkSigSts">
     <Sentence>
         SELECT SigSts FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="SelCusAgt">
     <Sentence>
         SELECT TCusNm ,ActNo,PasWrd dbPasWrd FROM tbccusagt WHERE CustId='%s' and DptId='%s' and Status='%s'
     </Sentence>
     <Fields>CustId|DptId|Status|</Fields>
   </DynSentence>
    <DynSentence name="QryCrpAgr">    <!--检查单位协议 -->
      <Sentence>
         select BBusTyp,TActNo  from savcrpagr where BrNo='%s' and CAgtNo='%s' and SvrSts='1'
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
	 <FlowCtrl>
      <!--构成分行号-->
      <Set>BrNo=STRCAT(SUBSTR($CAgtNo,1,3),999)</Set>
      <!--交易初始化,需要分行号-->
      <Exec func="PUB:InitTransaction"/>
      <!--InitTransaction成功后才能做GetAppInfo-->
      <Exec func="PUB:GetAppInfo"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=0000</Set>
      
      <Set>TTxnCd=483805</Set>
      <Set>TCusId=$CustId</Set>
      <Set>RsFld2=$DptId</Set>
      
      <Set>TranDt=SUBSTR($TranTm,1,8)</Set>
      <!--会计日期和交易发起日期是否一致 test暂时封闭-->
      <If condition="IS_NOEQUAL_STRING($ActDat,$TranDt)">
      	 <Set>RspCod=9999</Set>
      	 <Set>RspMsg=银行日期与交易发起日期不一致</Set>
      	 <Return/>
      </If>
      <!--检查系统签到状态-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="ChkSigSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=9999</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($SigSts,0)">
      	 <Set>RspCod=9999</Set>
      	 <Set>RspMsg=签退状态,暂停交易</Set>
      	 <Return/>
      </If>
      <!--客户签约状态-->
      <Set>Status=0</Set>
      <!--检查该客户是否已签约-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="ChkCusAgt"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=9999</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </If>
      <If condition="IS_EQUAL_STRING($CNT,0)">
        <!--客户已注销或未开户--> 
        <Set>RspCod=9999</Set>    
        <Set>RspMsg=该客户未开户</Set>
        <Return/>
      </If>
      <!--取客户信息资料-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="SelCusAgt"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=9999</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </If>
      <!--检查是否需要验证密码-->
      <If condition="IS_EQUAL_STRING($PasFlg,1)">
      	<!--校验密码-->
      	<If condition="IS_NOEQUAL_STRING($dbPasWrd,PasWrd)">
          <Set>RspCod=9999</Set>    
          <Set>RspMsg=密码错误</Set>
          <Return/>
        </If>
      </If>
      <!--检查单位协议 -->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryCrpAgr"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=460299</Set>
        <Set>RspMsg=单位协议不存在</Set>
        <Return/>
      </If>
      <!--校验各分行账号-->
      <!--441999广东省分行-->
      <!--444999珠海分行-->
      <!--446999佛山分行-->
      <!--445999汕头分行-->
      <!--483999东莞分行-->
      <!--484999中山分行-->
      <!--485999揭阳支行-->
      <!--491999惠州分行-->
      <!--761999江门分行-->
      <!--只有广州、珠海、佛山和中山有Acjud_行号函数，其他分行要加-->
      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>
      <If condition="$MsgTyp=E">
         <Set>RspCod=$HRspCd</Set>
         <Set>RspMsg=账号查询错误</Set>
         <Return/>
       </If>

      <Switch expression="$ActCls">
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
         <If condition="INTCMP($ActCls,3,3)">
             <Set>ActFlg=4</Set>  <!--对私卡号-->
             <Set>ActTyp=4</Set>
          </If>
          <Else>
             <Set>ActFlg=2</Set>  <!--对私帐号-->
             <Set>ActTyp=2</Set>
          </Else>
          <Break/>
        </Case>
        <Case value="0" /> <!-- 对公 -->
        <Case value="4" >
          <Set>ActTyp=1</Set>
          <Break/>
        </Case>
        <Default>
            <Set>RspCod=9999</Set>
            <Set>RspMsg=帐户类型不存在</Set>
            <Return/>
        </Default>
      </Switch>

      <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
        <Set>HTxnCd=471140</Set>
        <Set>PayMod=1</Set>
        <Set>ActFlg=$ActTyp</Set>
        <Set>VchChk=1</Set><!--监督标志由业务上确定-->
      </If>
      <ElseIf condition="INTCMP($ActTyp,3,1)"><!--对公-->
        <Set>HTxnCd=451610</Set>
        <Set>ActNod=SUBSTR($TActNo,1,6)</Set>
        <Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
        <Delete>TActNo</Delete>
        <Set>BusTyp=CRP51</Set>
        <Set>BusSub=01</Set>   <!--应用子码，对应业务类型CRP51-->
        <Set>ActFlg=2</Set>
      </ElseIf>
      <Else>    <!--第三方-->
        <Set>RspCod=9999</Set>
        <Set>RspMsg=账号类型输入有误</Set>
        <Return/>
      </Else>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GD_YCXS"/><!--可以使用单位编号-->
        <Arg name="Transaction" value="$TxnCod"/><!--可以用交易码或者模块名-->
      </Exec>

      <Set>PayMod=0</Set>
      <Set>CnlTyp=L</Set><!--交易渠道类型：L第三方系统-->
      <Set>VchChk=1</Set><!--监督标志由业务上确定-->
      <Set>VchCod=00000000</Set>
      <Set>AplCls=438</Set>
      <Set>MstChk=1</Set>  <!--20100511-->
      <Set>FRspCd= </Set>  <!--20100511-->
      <Set>ItgTyp=0</Set>  <!--20100511-->
      <Set>TXNTYP=N</Set>  <!--20100511-->

      <!--用地区号区分电子柜员，解决省分行模式问题-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptId"/>
        <Arg name="DestNam" value="TlrId"/>
        <Arg name="TblNam"  value="DptId2TlrId"/>
      </Exec>

      <Call package="AFE" function="AFE_SglThdPay"/>
      <If condition="$RspCod=000000">
        <Set>RspCod=0000</Set>
        <Set>RspMsg=交易成功</Set>
        <Return/>
      </If>
      <!--主机记账超时-->
      <ElseIf condition="IS_EQUAL_STRING($HTxnSt,T)">
			  <Goto>CRCHOST</Goto>
      </ElseIf> 

      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="RspCod"/>
        <Arg name="DestNam" value="RspMsg"/>
        <Arg name="TblNam"  value="RspCod2TRspMsg_YC"/>
      </Exec>
      <Set>RspCod=9999</Set>
      <Return/> <!--程序结束-->

      <Label>CRCHOST</Label> <!--只上主机冲正-->
         <Set>OLogNo=$LogNo</Set>
         <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
           <Set>HTxnCd=471149</Set>
         </If>
         <ElseIf condition="INTCMP($ActTyp,3,1)"> <!--对公-->
           <Set>HTxnCd=451619</Set>
         </ElseIf>
         <Else>                                   <!--第三方-->
           <Return/>
         </Else>
      
         <Set>TIATyp=C</Set>
         <Exec func="PUB:BeginWork"/>    <!--启动完整性控制--> 
         <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
           <Arg name="HTxnCd" value="959999"/>
           <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         
        <If condition="IS_EQUAL_STRING(~RetCod,0)">    <!--上主机冲正成功-->
          <Set>HTxnSt=C</Set>
          <Set>TxnSts=C</Set>
          <Exec func="PUB:UpdateJournal">
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=9999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
          </If>       
          <Return/>
        </If>
        <Else>    <!--不成功登记自动冲正-->
          <Exec func="PUB:DefaultErrorProc"/>            
        </Else>
 
  </FlowCtrl>
</Transaction>

<Transaction code="483806" desc="校正">
 	 <DynSentence name="ChkSigSts">
     <Sentence>
         SELECT SigSts FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="ChkCusAgt">
     <Sentence>
         SELECT count(*) CNT FROM tbccusagt WHERE CustId='%s' and DptId='%s' and Status='%s'
     </Sentence>
     <Fields>CustId|DptId|Status|</Fields>
   </DynSentence>
 	 <DynSentence name="ChkTxnJnl">
     <Sentence>
         SELECT count(*) CNT FROM afetxnjnl WHERE ActDat='%s' and TCusId='%s' and TLogNo='%s'
     </Sentence>
     <Fields>ActDat|CustId|OTLogNo|</Fields>
   </DynSentence>
 	 <DynSentence name="SelTxnJnl">
     <Sentence>
         SELECT HRspCd,HTxnSt,LogNo FROM afetxnjnl WHERE ActDat='%s' and TCusId='%s' and TLogNo='%s'
     </Sentence>
     <Fields>ActDat|CustId|OTLogNo|</Fields>
   </DynSentence>
	 <FlowCtrl>
     <!--交易初始化-->
     <Exec func="PUB:InitTransaction"/>
     <!--默认交易返回成功-->
     <Set>RspCod=0000</Set>

      <Set>TranDt=SUBSTR($TranTm,1,8)</Set>
      <!--会计日期和交易发起日期是否一致 test暂时封闭-->
      <If condition="IS_NOEQUAL_STRING($ActDat,$TranDt)">
      	 <Set>RspCod=9999</Set>
      	 <Set>RspMsg=银行日期与交易发起日期不一致</Set>
      	 <Return/>
      </If>
      <!--检查系统签到状态-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="ChkSigSts"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=9999</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($SigSts,0)">
      	 <Set>RspCod=9999</Set>
      	 <Set>RspMsg=签退状态,暂停交易</Set>
      	 <Return/>
      </If>
      
      <Switch expression="$OTTxnCd">
      	<Case value='8912'> <!--开户-->
      		<Set>Status=0</Set>
          <!--检查该客户是否已开户-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkCusAgt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=9999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Set>ORspCd= </Set>    
            <Set>ORspMg= </Set>
            <Set>OLogNo= </Set>
            <Return/>
          </If>
          <If condition="IS_EQUAL_STRING($CNT,0)">
            <!--客户已注销或未开户--> 
            <Set>ORspCd=9999</Set>    
            <Set>ORspMg=该客户未开户</Set>
            <Set>OLogNo= </Set>
          </If>
          <Else>
            <Set>ORspCd=0000</Set>    
            <Set>ORspMg=交易成功</Set>
            <Set>OLogNo= </Set>
          </Else>
      		<Break/>
      	</Case>
      	<Case value='8913'> <!--销户-->
      		<Set>Status=1</Set>
          <!--检查该客户是否已销户-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkCusAgt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=9999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Set>ORspCd= </Set>    
            <Set>ORspMg= </Set>
            <Set>OLogNo= </Set>
            <Return/>
          </If>
          <If condition="IS_EQUAL_STRING($CNT,0)">
            <!--客户未销户--> 
            <Set>ORspCd=9999</Set>    
            <Set>ORspMg=该客户销户失败</Set>
            <Set>OLogNo= </Set>
          </If>
          <Else>
            <Set>ORspCd=0000</Set>    
            <Set>ORspMg=交易成功</Set>
            <Set>OLogNo= </Set>
          </Else>
      		<Break/>
      	</Case>
      	<Case value='8914'> <!--扣款-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkTxnJnl"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=9999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Set>ORspCd= </Set>    
            <Set>ORspMg= </Set>
            <Set>OLogNo= </Set>
            <Return/>
          </If>
          <If condition="IS_EQUAL_STRING($CNT,0)">
            <!--没此交易记录--> 
            <Set>ORspCd=9999</Set>    
            <Set>ORspMg=此交易不存在</Set>
            <Set>OLogNo= </Set>
          </If>
          <Else>
            <Exec func="PUB:ReadRecord">
              <Arg name="SqlCmd" value="SelTxnJnl"/>
            </Exec>
            <If condition="~RetCod!=0">
              <Set>RspCod=9999</Set>
              <Set>RspMsg=数据库操作错误</Set>
              <Set>ORspCd= </Set>    
              <Set>ORspMg= </Set>
              <Set>OLogNo= </Set>
              <Return/>
            </If>
            <If condition="IS_EQUAL_STRING($HTxnSt,S)">
              <Set>ORspCd=0000</Set>    
              <Set>ORspMg=处理成功</Set>
              <Set>OLogNo=$LogNo</Set>
            </If>
            <ElseIf condition="IS_EQUAL_STRING($HTxnSt,T)">
              <Set>ORspCd=9999</Set>    
              <Set>ORspMg=原交易记账超时</Set>
              <Set>OLogNo= </Set>
            </ElseIf>
            <ElseIf condition="IS_EQUAL_STRING($HTxnSt,F)">
              <Set>ORspCd=9999</Set>    
              <Set>ORspMg=原交易记账失败</Set>
              <Set>OLogNo= </Set>
            </ElseIf>
            <Else condition="IS_EQUAL_STRING($HTxnSt,X)">
              <Set>ORspCd=9999</Set>    
              <Set>ORspMg=原交易记账失败</Set>
              <Set>OLogNo= </Set>
            </Else>
          </Else>
      		<Break/>
      	</Case>
      	<Default>
      	  <Set>RspCod=9999</Set>
      	  <Set>RspMsg=原交易码不存在</Set>
      	  <Return/>      		
      	</Default>
      </Switch>
      <Set>RspCod=0000</Set>   
      <Set>RspMsg=处理成功</Set>
      
	 </FlowCtrl>
</Transaction>

<Transaction code="483807" desc="查询客户余额">
 	 <DynSentence name="ChkSigSts">
     <Sentence>
         SELECT SigSts FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="ChkCusAgt">
     <Sentence>
         SELECT count(*) CNT FROM tbccusagt WHERE CustId='%s' and DptId='%s' and Status='%s'
     </Sentence>
     <Fields>CustId|DptId|Status|</Fields>
   </DynSentence>
 	 <DynSentence name="SelCusAgt">
     <Sentence>
         SELECT TCusNm ,ActNo,PasWrd dbPasWrd FROM tbccusagt WHERE CustId='%s' and DptId='%s' and Status='%s'
     </Sentence>
     <Fields>CustId|DptId|Status|</Fields>
   </DynSentence>
	 <FlowCtrl>
     <!--构成分行号-->
     <Set>BrNo=STRCAT(SUBSTR($CAgtNo,1,3),999)</Set>
     <!--交易初始化-->
     <Exec func="PUB:InitTransaction"/>
     <!--默认交易返回成功-->
     <Set>RspCod=0000</Set>

     <Set>TranDt=SUBSTR($TranTm,1,8)</Set>
     <!--会计日期和交易发起日期是否一致 test暂时封闭
     <If condition="IS_NOEQUAL_STRING($ActDat,$TranDt)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=银行日期与交易发起日期不一致</Set>
     	 <Set>Bal=0</Set>
     	 <Retrun/>
     </If>
     -->
     <!--检查系统签到状态-->
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="ChkSigSts"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库操作错误</Set>
       <Return/>
     </If>
     <If condition="IS_NOEQUAL_STRING($SigSts,0)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=签退状态,暂停交易</Set>
     	 <Return/>
     </If>
     <Set>Status=0</Set>
     <!--检查该客户是否已开户-->
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="ChkCusAgt"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库操作错误</Set>
        <Return/>
     </If>
     <If condition="IS_EQUAL_STRING($CNT,0)">
       <!--客户已注销或未开户--> 
       <Set>ORspCd=9999</Set>    
       <Set>ORspMg=该客户未开户</Set>
       <Set>Bal=0</Set>
       <Return/>
     </If>
      <!--取客户信息资料-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="SelCusAgt"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=9999</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Set>Bal=0</Set>
        <Return/>
      </If>      

     <!--构成网点号-->
     <Switch  expression="$BrNo">
       <Case value="441999">
         <Set>NodNo=441800</Set>
         <Break/>
       </Case>
       <Case value="444999">
         <Set>NodNo=444800</Set>
         <Break/>
       </Case>
       <Case value="446999">
         <Set>NodNo=446800</Set>
         <Break/>
       </Case>
       <Case value="445999">
         <Set>NodNo=445800</Set>
         <Break/>
       </Case>
       <Case value="483999">
         <Set>NodNo=483800</Set>
         <Break/>
       </Case>
       <Case value="484999">
         <Set>NodNo=484800</Set>
         <Break/>
       </Case>
       <Case value="485999">
         <Set>NodNo=485800</Set>
         <Break/>
       </Case>
       <Case value="491999">
         <Set>NodNo=491800</Set>
         <Break/>
       </Case>
       <Case value="476999">
         <Set>NodNo=476800</Set>
         <Break/>
       </Case>
     </Switch>
      <!--取电子柜员号-->
      <Set>TxnCnl=TBC</Set>       <!--取电子柜员号用-->
      <Set>TxnObj=OFRTTBCA</Set>
      <Exec func="PUB:GetVirtualTeller">
        <Arg name="TxnCnl" value="TBC"/>
      </Exec>
      <Set>TlrId=$TlrId</Set>
      <Set>TTxnCd=483803</Set>
           
      <!--校验各分行账号-->
      <!--441999广东省分行-->
      <!--444999珠海分行-->
      <!--446999佛山分行-->
      <!--445999汕头分行-->
      <!--483999东莞分行-->
      <!--484999中山分行-->
      <!--485999揭阳支行-->
      <!--491999惠州分行-->
      <!--761999江门分行-->
      <!--只有广州、珠海、佛山和中山有Acjud_行号函数，其他分行要加-->
      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>
      <!--向主机查询账户信息-->
      <Switch expression="$ActCls">
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
          <If condition="INTCMP($ActCls,3,3)">
             <Set>ActFlg=4</Set>  <!--对私卡号-->
             <Set>ActTyp=4</Set>
          </If>
          <Else>
             <Set>ActFlg=2</Set>  <!--对私帐号-->
             <Set>ActTyp=2</Set>
          </Else>
          <Set>CcyCod=CNY</Set>

          <!--上主机查询客户资料-->
          <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="HTxnCd" value="476520"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="$MsgTyp!=N">
            <Set>RspCod=460399</Set>
            <Set>RspMsg=帐户不存在</Set>
            <Set>Bal=0</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Case value="0" /> <!-- 对公 -->
        <Case value="4" >
          <Set>ActTyp=1</Set>
          <!--上主机查询客户资料-->
          <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="HTxnCd" value="109000"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="$MsgTyp!=N">
            <Set>RspCod=9999</Set>
            <Set>RspMsg=帐户不存在</Set>
            <Set>Bal=0</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Default>
            <Set>RspCod=9999</Set>
            <Set>RspMsg=帐户类型不存在</Set>
            <Set>Bal=0</Set>
            <Return/>
        </Default>
      </Switch>
      <Set>RspCod=0000</Set>            
      <Set>RspMsg=处理成功</Set>
      
	 </FlowCtrl>
</Transaction>

<Transaction code="483808" desc="烟草公司发起的对账">
 	 <DynSentence name="ChkSigSts">
     <Sentence>
         SELECT SigSts FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="STxnJnl01">
     <Sentence>
         SELECT LogNo,RsFld1,FTxnTm,TCusId,ActNo,TxnAmt FROM afetxnjnl 
           WHERE ActDat='%s' and RsFld2='%s' and  HRspCd='SC0000' and  HTxnSt='S'
             ORDER BY LogNo
     </Sentence>
     <Fields>OActDt|DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="STxnJnl02">
     <Sentence>
         SELECT LogNo,RsFld1,FTxnTm,TCusId,ActNo,TxnAmt FROM afetxnjnl 
           WHERE ActDat='%s' and RsFld2='%s' and  HRspCd='SC0000' and  HTxnSt='S' and LogNo>='%s'
             ORDER BY LogNo
     </Sentence>
     <Fields>OActDt|DptId|OLogNo|</Fields>
   </DynSentence>
    <!--生成文件 总笔数-->
    <DynSentence name="TotalDeal01">
      <Sentence>
        SELECT Count(*) TotSum, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotAmt
        FROM afetxnjnl
        WHERE CAgtNo = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND HRspCd='SC0000' AND TxnCod='483805'
      </Sentence>
      <Fields>CAgtNo|OActDt|</Fields>
    </DynSentence>
    <!--生成文件 总笔数-->
    <DynSentence name="TotalDeal02">
      <Sentence>
        SELECT Count(*) TotSum, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotAmt
        FROM afetxnjnl
        WHERE CAgtNo = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND HRspCd='SC0000' AND TxnCod='483805' and LogNo>='%s'
      </Sentence>
      <Fields>CAgtNo|OActDt|OLogNo|</Fields>
    </DynSentence>
	 <FlowCtrl>

     <!--转换为协议号-->
     <Exec func="PUB:CodeSwitching">
       <Arg name="DatSrc"  value="OPFCSW"/>
       <Arg name="SourNam" value="DptId"/>
       <Arg name="DestNam" value="CAgtNo"/>
       <Arg name="TblNam"  value="GDYC_DPTID"/>
     </Exec>

     <!--构成分行号-->
     <Set>BrNo=STRCAT(SUBSTR($CAgtNo,1,3),999)</Set>

     <!--交易初始化-->
     <Exec func="PUB:InitTransaction"/>
     <!--默认交易返回成功-->
     <Set>RspCod=0000</Set>

     <Set>TranDt=SUBSTR($TranTm,1,8)</Set>
     <!--会计日期和交易发起日期是否一致 test暂时封闭
     <If condition="IS_NOEQUAL_STRING($ActDat,$TranDt)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=银行日期与交易发起日期不一致</Set>
     	 <Set>Bal=0</Set>
     	 <Retrun/>
     </If>
     -->
     
     <!--检查系统签到状态-->
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="ChkSigSts"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库操作错误</Set>
       <Return/>
     </If>
     <If condition="IS_NOEQUAL_STRING($SigSts,0)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=签退状态,暂停交易</Set>
     	 <Return/>
     </If>
  
     <Set>DatFil=STRCAT(dat/tbc/,jh,_,$DptId,_,$OActDt,.xml)</Set>
     <Set>DatFilNam=STRCAT(jh,_,$DptId,_,$OActDt,.xml)</Set>
     
     <If condition="IS_EQUAL_STRING($OLogNo,000000)">
       <!--取成功总笔数和总金额-->
       <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="TotalDeal01"/>
       </Exec>
       <If condition="~RetCod!=0">
         <Set>RspCod=9999</Set>
         <Set>RspMsg=数据库操作错误</Set>
         <Return/>
       </If>   
       <!--生成对账明细文件开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="w"/>
         <Arg name="ESCFMT"   value="\\074\\077xml\\040version\\075\\0421\\0560\\042\\040encoding\\075\\042GBK\\042\\040standalone\\075\\042no\\042\\077\\076\\n"/>
       </Exec>
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\074DLMAPS\\076\\n"/>
       </Exec>
       <!--文件PUB部分开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074PUB\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRADE_ID\\076"/>
         <Arg name="Data"     value="8918"/>
         <Arg name="ESCFMT"   value="\\074\\057TRADE_ID\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRAN_TIME\\076"/>
         <Arg name="Data"     value="$TRANTM"/>
         <Arg name="ESCFMT"   value="\\074\\057TRAN_TIME\\076\\n"/>       
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074BANK_ID\\076"/>
         <Arg name="Data"     value="$BANKID"/>
         <Arg name="ESCFMT"   value="\\074\\057BANK_ID\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074DPT_ID\\076"/>
         <Arg name="Data"     value="$DptId"/>
         <Arg name="ESCFMT"   value="\\074\\057DPT_ID\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRADE_SEQ\\076"/>
         <Arg name="Data"     value="$TLogNo"/>
         <Arg name="ESCFMT"   value="\\074\\057TRADE_SEQ\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074APP_TYPE\\076"/>
         <Arg name="Data"     value="$APPTYP"/>
         <Arg name="ESCFMT"   value="\\074\\057APP_TYPE\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\074\\057PUB\\076\\n"/>
       </Exec> 
       <!--文件PUB部分结束-->
       
       <!--文件OUT部分开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074OUT\\076\\n"/>
              
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074RET_CODE\\076"/>
         <Arg name="Data"     value="$RspCod"/>
         <Arg name="ESCFMT"   value="\\074\\057RET_CODE\\076\\n"/>
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074MSG\\076"/>
         <Arg name="Data"     value="交易成功"/>
         <Arg name="ESCFMT"   value="\\074\\057MSG\\076\\n"/>
       </Exec>
       <Exec func="PUB:OpenCursor">
         <Arg name="SqlCmd"     value="STxnJnl01"/>
         <Arg name="CursorName" value="CurTxn01"/>
       </Exec>       
       <While>
         <Exec func="PUB:FetchCursor" error="IGNORE">
           <Arg name="CursorName" value="CurTxn01"/>
         </Exec>
         <If condition="~RetCod=100">
           <Exec func="PUB:CloseCursor">
             <Arg name="CursorName" value="CurTxn01"/>
           </Exec>
           <Break/>
         </If>
         <ElseIf condition="~RetCod=-1">
           <Exec func="PUB:CloseCursor">
             <Arg name="CursorName" value="CurTxn01"/>
           </Exec>
           <Set>RspCod=9999</Set>
           <Set>RspMsg=游标FETCH操作错误</Set>
           <Return/>
         </ElseIf>
         <Set>LogNo=DELBOTHSPACE($LogNo)</Set>
         <Set>RsFld1=DELBOTHSPACE($RsFld1)</Set>
         <Set>FTxnTm=DELBOTHSPACE($FTxnTm)</Set>
         <Set>TCusId=DELBOTHSPACE($TCusId)</Set>
         <Set>ActNo=DELBOTHSPACE($ActNo)</Set>
         <Set>TxnAmt=DELBOTHSPACE($TxnAmt)</Set>
         <!--文件RE部分开始-->
         <Exec func="PUB:WriteFile" error="IGNORE">
           <Arg name="FileName" value="$DatFil"/>
           <Arg name="OpenMode" value="a+"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074RE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074BANK_SEQ\\076"/>
           <Arg name="Data"     value="$LogNo"/>
           <Arg name="ESCFMT"   value="\\074\\057BANK_SEQ\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074CO_NUM\\076"/>
           <Arg name="Data"     value="$RsFld1"/>
           <Arg name="ESCFMT"   value="\\074\\057CO_NUM\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074TIME_LABLE\\076"/>
           <Arg name="Data"     value="$FTxnTm"/>
           <Arg name="ESCFMT"   value="\\074\\057TIME_LABLE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074CUST_ID\\076"/>
           <Arg name="Data"     value="$TCusId"/>
           <Arg name="ESCFMT"   value="\\074\\057CUST_ID\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074ACC\\076"/>
           <Arg name="Data"     value="$ActNo"/>
           <Arg name="ESCFMT"   value="\\074\\057ACC\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074QTY_TRADE\\076"/>
           <Arg name="Data"     value="$TxnAmt"/>
           <Arg name="ESCFMT"   value="\\074\\057QTY_TRADE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074\\057RE\\076\\n"/>
         </Exec>
         <!--文件RE部分结束-->
       </While>
         <!--文件TOTAL部分开始-->
         <Exec func="PUB:WriteFile" error="IGNORE">
           <Arg name="FileName" value="$DatFil"/>
           <Arg name="OpenMode" value="a+"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074TOTAL\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074DEV_ID\\076"/>
           <Arg name="Data"     value="$DevId"/>
           <Arg name="ESCFMT"   value="\\074\\057DEV_ID\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074TELLER\\076"/>
           <Arg name="Data"     value="$Teller"/>
           <Arg name="ESCFMT"   value="\\074\\057TELLER\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074SUCC_COUNT\\076"/>
           <Arg name="Data"     value="$TotSum"/>
           <Arg name="ESCFMT"   value="\\074\\057SUCC_COUNT\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074SUCC_AMT\\076"/>
           <Arg name="Data"     value="$TotAmt"/>
           <Arg name="ESCFMT"   value="\\074\\057SUCC_AMT\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074\\057TOTAL\\076\\n"/>
         </Exec>
         <!--文件TOTAL部分结束-->       
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074\\057OUT\\076\\n"/>
       </Exec>      
       <!--文件OUT部分结束-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\074\\057DLMAPS\\076\\n"/>
       </Exec>      
       <!--生成对账明细文件结束-->
     </If>
     <Else>
       <!--取成功总笔数和总金额-->
       <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="TotalDeal02"/>
       </Exec>
       <If condition="~RetCod!=0">
         <Set>RspCod=9999</Set>
         <Set>RspMsg=数据库操作错误</Set>
         <Return/>
       </If> 
       <!--生成对账明细文件开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="w"/>
         <Arg name="ESCFMT"   value="\\074\\077xml\\040version\\075\\0421\\0560\\042\\040encoding\\075\\042GBK\\042\\040standalone\\075\\042no\\042\\077\\076\\n"/>
       </Exec> 
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\074DLMAPS\\076\\n"/>
       </Exec>
       <!--文件PUB部分开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074PUB\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRADE_ID\\076"/>
         <Arg name="Data"     value="8918"/>
         <Arg name="ESCFMT"   value="\\074\\057TRADE_ID\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRAN_TIME\\076"/>
         <Arg name="Data"     value="$TRANTM"/>
         <Arg name="ESCFMT"   value="\\074\\057TRAN_TIME\\076\\n"/>       
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074BANK_ID\\076"/>
         <Arg name="Data"     value="$BANKID"/>
         <Arg name="ESCFMT"   value="\\074\\057BANK_ID\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074DPT_ID\\076"/>
         <Arg name="Data"     value="$DptId"/>
         <Arg name="ESCFMT"   value="\\074\\057DPT_ID\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRADE_SEQ\\076"/>
         <Arg name="Data"     value="$TLogNo"/>
         <Arg name="ESCFMT"   value="\\074\\057TRADE_SEQ\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074APP_TYPE\\076"/>
         <Arg name="Data"     value="$APPTYP"/>
         <Arg name="ESCFMT"   value="\\074\\057APP_TYPE\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\074\\057PUB\\076\\n"/>
       </Exec> 
       <!--文件PUB部分结束-->
       
       <!--文件OUT部分开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074OUT\\076\\n"/>
              
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074RET_CODE\\076"/>
         <Arg name="Data"     value="$RspCod"/>
         <Arg name="ESCFMT"   value="\\074\\057RET_CODE\\076\\n"/>
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074MSG\\076"/>
         <Arg name="Data"     value="交易成功"/>
         <Arg name="ESCFMT"   value="\\074\\057MSG\\076\\n"/>
       </Exec>
       <Exec func="PUB:OpenCursor">
         <Arg name="SqlCmd"     value="STxnJnl02"/>
         <Arg name="CursorName" value="CurTxn02"/>
       </Exec>       
       <While>
         <Exec func="PUB:FetchCursor" error="IGNORE">
           <Arg name="CursorName" value="CurTxn02"/>
         </Exec>
         <If condition="~RetCod=100">
           <Exec func="PUB:CloseCursor">
             <Arg name="CursorName" value="CurTxn02"/>
           </Exec>
           <Break/>
         </If>
         <ElseIf condition="~RetCod=-1">
           <Exec func="PUB:CloseCursor">
             <Arg name="CursorName" value="CurTxn02"/>
           </Exec>
           <Set>RspCod=9999</Set>
           <Set>RspMsg=游标FETCH操作错误</Set>
           <Return/>
         </ElseIf>
         <Set>LogNo=DELBOTHSPACE($LogNo)</Set>
         <Set>RsFld1=DELBOTHSPACE($RsFld1)</Set>
         <Set>FTxnTm=DELBOTHSPACE($FTxnTm)</Set>
         <Set>TCusId=DELBOTHSPACE($TCusId)</Set>
         <Set>ActNo=DELBOTHSPACE($ActNo)</Set>
         <Set>TxnAmt=DELBOTHSPACE($TxnAmt)</Set>
         <!--文件RE部分开始-->
         <Exec func="PUB:WriteFile" error="IGNORE">
           <Arg name="FileName" value="$DatFil"/>
           <Arg name="OpenMode" value="a+"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074RE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074BANK_SEQ\\076"/>
           <Arg name="Data"     value="$LogNo"/>
           <Arg name="ESCFMT"   value="\\074\\057BANK_SEQ\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074CO_NUM\\076"/>
           <Arg name="Data"     value="$RsFld1"/>
           <Arg name="ESCFMT"   value="\\074\\057CO_NUM\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074TIME_LABLE\\076"/>
           <Arg name="Data"     value="$FTxnTm"/>
           <Arg name="ESCFMT"   value="\\074\\057TIME_LABLE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074CUST_ID\\076"/>
           <Arg name="Data"     value="$TCusId"/>
           <Arg name="ESCFMT"   value="\\074\\057CUST_ID\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074ACC\\076"/>
           <Arg name="Data"     value="$ActNo"/>
           <Arg name="ESCFMT"   value="\\074\\057ACC\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074QTY_TRADE\\076"/>
           <Arg name="Data"     value="$TxnAmt"/>
           <Arg name="ESCFMT"   value="\\074\\057QTY_TRADE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074\\057RE\\076\\n"/>
         </Exec>
         <!--文件RE部分结束-->
       </While>
         <!--文件TOTAL部分开始-->
         <Exec func="PUB:WriteFile" error="IGNORE">
           <Arg name="FileName" value="$DatFil"/>
           <Arg name="OpenMode" value="a+"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074TOTAL\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074DEV_ID\\076"/>
           <Arg name="Data"     value="$DevId"/>
           <Arg name="ESCFMT"   value="\\074\\057DEV_ID\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074TELLER\\076"/>
           <Arg name="Data"     value="$Teller"/>
           <Arg name="ESCFMT"   value="\\074\\057TELLER\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074SUCC_COUNT\\076"/>
           <Arg name="Data"     value="$TotSum"/>
           <Arg name="ESCFMT"   value="\\074\\057SUCC_COUNT\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074SUCC_AMT\\076"/>
           <Arg name="Data"     value="$TotAmt"/>
           <Arg name="ESCFMT"   value="\\074\\057SUCC_AMT\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074\\057TOTAL\\076\\n"/>
         </Exec>
         <!--文件TOTAL部分结束-->        
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074\\057OUT\\076\\n"/>
       </Exec>      
       <!--文件OUT部分结束-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\074\\057DLMAPS\\076\\n"/>
       </Exec>      
       <!--生成对账明细文件结束-->     	
     </Else>
      <Set>SndFil=$DatFilNam</Set>
      <Set>LclFil=$SndFil</Set>

     <Set>FtpStr=STRCAT(TBC,$DptId)</Set>
     <Exec func="PUB:FtpPut" error="IGNORE">
     	<Arg name="FtpId" value="$FtpStr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=482199</Set>
       <Set>RspMsg=取文件失败</Set>
       <Return/>
     </If>

     <Set>MsgTyp=N</Set>
     <Set>RspMsg=交易成功</Set>         
	 </FlowCtrl>
</Transaction>

<Transaction code="483809" desc="广东烟草公司信息维护">
	 <DynSentence name="SelBasInf">
     <Sentence>
        SELECT count(*) cnt1 FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
	 <DynSentence name="InsBasInf">
     <Sentence>
        INSERT INTO tbcbasinf VALUES('%s','%s','%s',' ',' ',' ','%s','1')
     </Sentence>
     <Fields>TBrNo|DptId|DptNam|DptId|</Fields>
   </DynSentence>
	 <DynSentence name="DelBasInf">
     <Sentence>
        DELETE FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
   <DynSentence name="MultiQuery">
   	<Sentence>
   		select BrNo TBrNo,DptId,DptNam from tbcbasinf
   	</Sentence>
   </DynSentence>
   <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
			<Switch expression="$TxnFlg">
				<Case value="0">		<!--insert-->
					<!--检测单位是否存在-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="SelBasInf"/>
          </Exec>
          <If condition="~RetCod!=0">
          	<Set>MsgTyp=E</Set>
            <Set>RspCod=TBC999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
          </If>
					<If condition="IS_NOEQUAL_STRING($cnt1,0)">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=TBC999</Set>
						<Set>RspMsg=该单位已经存在!</Set>
						<Return/>
					</If>
					<!--插入单位信息-->
          <Exec func="PUB:ExecSql" error="IGNORE">
             <Arg name="SqlCmd"   value="InsBasInf"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=TBC999</Set>
            <Set>RspMsg=数据库处理失败!</Set>
            <Return/>
          </If>
					<Break/>
				</Case>
				<Case value="1">		<!--multiquery-->
					<Exec func="PUB:MultiQuery" >
						<Arg name="SqlCmd" value="MultiQuery" />
					</Exec>
					<Break/>
				</Case>
				<Case value="2">		<!--delete-->
					<!--检测单位是否存在-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="SelBasInf"/>
          </Exec>
          <If condition="~RetCod!=0">
          	<Set>MsgTyp=E</Set>
            <Set>RspCod=TBC999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
          </If>
					<If condition="IS_EQUAL_STRING($cnt1,0)">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=TBC999</Set>
						<Set>RspMsg=该单位不存在!</Set>
						<Return/>
					</If>
					<!--删除单位信息-->
          <Exec func="PUB:ExecSql" error="IGNORE">
             <Arg name="SqlCmd"   value="DelBasInf"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=TBC999</Set>
            <Set>RspMsg=数据库处理失败!</Set>
            <Return/>
          </If>
					<Break/>
				</Case>
			</Switch>
			<!--正确返回-->
			<Set>Status=0</Set>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>		
	 </FlowCtrl>
</Transaction>

  <Transaction code="483810" desc="广东烟草自动清算">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryTbcTot"><!--查询烟草公司清算信息-->
      <Sentence>
        select sum(cast(TxnAmt as bigint)) as SumAmt,coalesce(COUNT(*),0) TotCnt from afetxnjnl where ActDat = '%s' and CAgtNo= '%s' and HTxnSt='S' and HRspcd='SC0000' and ChkFlg='0'
      </Sentence>
      <Fields>ClrDat|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Updafetxnjnl"><!--修改信息-->
      <Sentence>
        update afetxnjnl set ChkFlg='1' WHERE ActDat ='%s' and CAgtNo='%s' and HTxnSt IN ('S','T','U') and HRspcd='SC0000' and TTxnst IN ('S','U')
      </Sentence>
      <Fields>ClrDat|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="STbcBas"><!--查询单位信息 -->
      <Sentence>
        SELECT BrNo,DptId FROM tbcbasinf WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <FlowCtrl>
    	<Set>BrNO=$ROOT.TBANK</Set>
    	
      <Exec func="PUB:OpenCursor">
        <Arg name="SqlCmd"     value="STbcBas"/>
        <Arg name="CursorName" value="CurTbc01"/>
      </Exec>       
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE">
          <Arg name="CursorName" value="CurTbc01"/>
        </Exec>
        <If condition="~RetCod=100">
          <Exec func="PUB:CloseCursor">
            <Arg name="CursorName" value="CurTbc01"/>
          </Exec>
          <Break/>
        </If>
        <ElseIf condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor">
            <Arg name="CursorName" value="CurTbc01"/>
          </Exec>
          <Set>RspCod=9999</Set>
          <Set>RspMsg=游标FETCH操作错误</Set>
          <Return/>
        </ElseIf>
        <!--根据银行公司编号转换成单位协议号-->
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="DptId"/>
          <Arg name="DestNam" value="CAgtNo"/>
          <Arg name="TblNam"  value="GDYC_DPTID"/>
        </Exec>

        <!--交易初始化,预留-->
        <Exec func="PUB:InitTransaction"/>
        <!--取前置流水号-->
        <Exec func="PUB:GetLogNo"/>
        <!--默认交易返回成功-->
        <Set>RspCod=000000</Set>
        
        <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
          <Arg name="SqlCmd" value="QryCrpAgr"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=460299</Set>
          <Set>RspMsg=单位协议不存在</Set>
          <Return/>
        </If>
 
        <Exec func="PUB:IsExistNode" error="IGNORE">
          <Arg name="FieldName" value="ROOT.RTNDAT"/>
        </Exec>
        <If condition="INTCMP(~RetCod,3,1)">  <!--手工发起回应-->
          <Set>ClrDat=$ROOT.RTNDAT</Set>
        </If>
        <Else>
          <Set>ClrDat=$ActDat</Set>
        </Else>

        <Set>ClrDat=$ActDat</Set><!--TODO-->
        
        <Exec func="PUB:ReadRecord">
          <Arg name="SqlCmd" value="QryTbcTot"/>
        </Exec>  
        <If condition="$TotCnt=0">
          <Set>RspMsg=没有清算数据</Set>
          <Continue/>
        </If> 
        
        <!--自动清算,需要添加必要数据-->
        <Set>TxnAmt=$SumAmt</Set> 
        <Set>TTxnCd=483810</Set>  
        <Exec func="PUB:GetVirtualTeller">
          <Arg name="TxnCnl" value="TBC"/>
        </Exec>    
        <!--添加结束-->
        
        <Set>HTxnCd=451900</Set>
        <Set>BusTyp=PCL76</Set>
        <Set>RgCFlg=1</Set>   <!--贷方回单，不登记0，登记 1 -->
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
        <Switch  expression="$BrNo">
          <Case value="441999">

            <Set>ActBk1=441999</Set>
            <Set>ActBr1=441800</Set>
            <Set>NodNo=441800</Set>

            <Break/>
          </Case>
          <Case value="444999">
          	<Set>ActBk1=444999</Set>
            <Set>ActBr1=444800</Set>
            <Set>NodNo=444800</Set>
            <Break/>
          </Case>
          <Case value="446999">
            <Set>ActBk1=446999</Set>
            <Set>ActBr1=446800</Set>
            <Set>NodNo=446800</Set>
            <Break/>
          </Case>
          <Case value="445999">
            <Set>ActBk1=445999</Set>
            <Set>ActBr1=445800</Set>
            <Set>NodNo=445800</Set>
            <Break/>
          </Case>
          <Case value="483999">
            <Set>ActBk1=483999</Set>
            <Set>ActBr1=483800</Set>
            <Set>NodNo=483800</Set>
            <Break/>
          </Case>
          <Case value="484999">
            <Set>ActBk1=484999</Set>
            <Set>ActBr1=484800</Set>
            <Set>NodNo=484800</Set>          
            <Break/>
          </Case>
          <Case value="485999">
             <Set>ActBk1=485999</Set>
             <Set>ActBr1=485730</Set>
             <Set>NodNo=485800</Set>  
            <Break/>
          </Case>
          <Case value="491999">
            <Set>ActBk1=491999</Set>
            <Set>ActBr1=491800</Set>
            <Set>NodNo=491800</Set>  
            <Break/>
          </Case>
          <Case value="476999">
            <Set>ActBk1=476999</Set>
            <Set>ActBr1=476800</Set>
            <Set>NodNo=476800</Set> 
            <Break/>
          </Case>
          <Case value="761999">
            <Set>ActBk1=761999</Set>
            <Set>ActBr1=761800</Set>
            <Set>NodNo=761800</Set>
            <Break/>
          </Case>
          <Default>
            <Set>RspCod=9999</Set>
            <Set>RspMsg=该分行不存在</Set>
            <Return/>
          </Default>
        </Switch>
        
        <Set>ActSq1=SUBSTR($TActNo,14,5)</Set>
        <Set>CdFlg1=D</Set>
        <Set>OuAmt1=$TxnAmt</Set>
        <Set>PayAt5=$STLACT</Set>
        <Set>CdFlg5=C</Set>
        <Set>InAmt5=$TxnAmt</Set>
        
        <!--用地区号区分电子柜员，解决省分行模式问题-->
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="DptId"/>
          <Arg name="DestNam" value="TlrId"/>
          <Arg name="TblNam"  value="DptId2TlrId"/>
        </Exec>

        <Exec func="PUB:CallHostOther">
          <Arg name="HTxnCd" value="$HTxnCd"/>
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
        
        <!--
          <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Set>RspMsg=交易成功</Set>
        -->
        
        <If condition="~RetCod=0">  <!--recsts 0:初始化 1:成功 2:失败 -->
          <Exec func="PUB:ExecSql">
             <Arg name="SqlCmd" value="Updafetxnjnl"/>
          </Exec>
          <!--20121020 begin 反洗钱接口调用-->
          <Quote name="AntiMoneylaudry"/>
          <!--20121020 end 反洗钱接口调用-->
        </If>
      </While>
    </FlowCtrl>
  </Transaction>


  <Transaction code="483811" desc="广东烟草清算报表打印">
  <!--注意更新图形前端 GDTBC单位编码-->
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>
      <!--
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=360001</Set>
           <Set>RspMsg=本网点无权打印该报表！</Set>
           <Return/>
      </If>
      -->
     <!--检查清算分行与选择清算单位是否一致-->
     <If condition="IS_NOEQUAL_STRING(SUBSTR($BrNo,1,3),SUBSTR($CAgtNo,1,3))">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=清算单位非本分行</Set>
       <Return/>     
     </If>

    <If condition="$PrtFlg=1">
      <!--成功报表-->
      <Set>FmtFil=etc/TBC_RPT_CFG.XML</Set>
      <Set>FilNam=STRCAT(EFE,$BrNo,$TxnDat,GETDATETIME(HHMISS))</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="BrNo"   value="$BrNo"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat" value="$TxnDat"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
    </If>
    <ElseIf condition="$PrtFlg=2">
      <!--车船税和银旅通无可疑报表-->
      <If condition="OR(IS_EQUAL_STRING($CAgtNo,4410000755),IS_EQUAL_STRING($CAgtNo,4410000960))">
          <Set>MsgTyp=E</Set>
           <Set>RspCod=470728</Set>
           <Set>RspMsg=无此交易</Set>
           <Return/>
      </If>
      <!--天讯可疑报表-->
      <Set>FmtFil=etc/LSHA5_RPT_441999.XML</Set>
      <Set>FilNam=STRCAT(LSHA05,$TxnDat,GETDATETIME(HHMISS))</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat" value="$TxnDat"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
    </ElseIf>
    <!--车船税失败报表-->
    <ElseIf condition="$PrtFlg=3">
      <Set>FmtFil=etc/LSHA10_RPT_441999.XML</Set>
      <Set>FilNam=STRCAT(LSHA10_,$TxnDat,GETDATETIME(HHMISS))</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat" value="$TxnDat"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
    </ElseIf>
    <!--退款报表-->
    <ElseIf condition="$PrtFlg=4">
      <If condition="IS_EQUAL_STRING($CAgtNo,4410001101)">       <!--粤通卡退款报表-->
        <Set>FmtFil=etc/LSHJ02_RPT_441999.XML</Set>
        <Set>FilNam=STRCAT(LSHJ02_,$TxnDat,GETDATETIME(HHMISS))</Set>
        <Exec func="EXT:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="CAgtNo" value="$CAgtNo"/>
          <Arg name="TxnDat" value="$TxnDat"/>
          <Arg name="PNodNo"  value="$NodNo"/>
          <Arg name="PTlrId"  value="$TlrId"/>
        </Exec>
        <Exec func="PUB:SendFileMessage">
          <Arg name="MsgTyp"  value="4"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="48"/>
          <Arg name="AplCod"  value="482150"/>
          <Arg name="FilNam"  value="$FilNam"/>
          <Arg name="Summary" value="$Summary"/>
          <Arg name="ObjTlr"  value="$TlrId"/>
        </Exec>
      </If>
      <ElseIf condition="IS_EQUAL_STRING($CAgtNo,4410001105)">       <!--月票卡退款报表-->
        <Set>FmtFil=etc/SPC102_RPT_441999.XML</Set>
        <Set>FilNam=STRCAT(SPC102_,$TxnDat,GETDATETIME(HHMISS))</Set>
        <Exec func="EXT:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="CAgtNo" value="$CAgtNo"/>
          <Arg name="TxnDat" value="$TxnDat"/>
          <Arg name="PNodNo"  value="$NodNo"/>
          <Arg name="PTlrId"  value="$TlrId"/>
        </Exec>
        <Exec func="PUB:SendFileMessage">
          <Arg name="MsgTyp"  value="4"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="48"/>
          <Arg name="AplCod"  value="482150"/>
          <Arg name="FilNam"  value="$FilNam"/>
          <Arg name="Summary" value="$Summary"/>
          <Arg name="ObjTlr"  value="$TlrId"/>
       </Exec>
      </ElseIf>
    </ElseIf>
    <Else>
    </Else>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="483812" desc="广东烟草手工清算">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Updafetxnjnl"><!--修改信息-->
      <Sentence>
        update afetxnjnl set ChkFlg='1' WHERE ActDat ='%s' and CAgtNo='%s' and HTxnSt IN ('S','T','U') and HRspcd='SC0000' and TTxnst IN ('S','U')
      </Sentence>
      <Fields>ClrDat|CAgtNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <!--根据柜员号取BrNo,由于省辖行共用441999，因此屏蔽-->
      <!--Exec func="PUB:GetBranchNoByTeller"/-->
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>
      
     <!--检查清算分行与选择清算单位是否一致-->
     <If condition="IS_NOEQUAL_STRING(SUBSTR($BrNo,1,3),SUBSTR($CAgtNo,1,3))">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=清算单位非本分行</Set>
       <Return/>     
     </If>

     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>

      <Set>HTxnCd=451900</Set>
      <Set>BusTyp=PCL76</Set>
      <Set>RgCFlg=1</Set>   <!--贷方回单，不登记0，登记 1 -->
        <!--441999广东省分行-->
        <!--444999珠海分行-->
        <!--446999佛山分行-->
        <!--445999汕头分行-->
        <!--483999东莞分行-->
        <!--484999中山分行-->
        <!--485999揭阳支行-->
        <!--491999惠州分行-->
        <!--761999江门分行-->
      <Switch  expression="$BrNo">
        <Case value="441999">
          <Set>ActBk1=441999</Set>
          <Set>ActBr1=441800</Set>
          <Break/>
        </Case>
        <Case value="444999">
        	<Set>ActBk1=444999</Set>
          <Set>ActBr1=444800</Set>
          <Break/>
        </Case>
        <Case value="446999">
          <Set>ActBk1=446999</Set>
          <Set>ActBr1=446800</Set>
          <Break/>
        </Case>
        <Case value="445999">
          <Set>ActBk1=445999</Set>
          <Set>ActBr1=445800</Set>
          <Break/>
        </Case>
        <Case value="483999">
          <Set>ActBk1=483999</Set>
          <Set>ActBr1=483800</Set>
          <Break/>
        </Case>
        <Case value="484999">
          <Set>ActBk1=484999</Set>
          <Set>ActBr1=484800</Set>          
          <Break/>
        </Case>
        <Case value="485999">
           <Set>ActBk1=485999</Set>
           <Set>ActBr1=485730</Set>  
          <Break/>
        </Case>
        <Case value="491999">
          <Set>ActBk1=491999</Set>
          <Set>ActBr1=491800</Set>  
          <Break/>
        </Case>
        <Case value="476999">
          <Set>ActBk1=476999</Set>
          <Set>ActBr1=476800</Set>  
          <Break/>
        </Case>
        <Case value="761999">
          <Set>ActBk1=761999</Set>
          <Set>ActBr1=761800</Set>
          <Set>NodNo=761800</Set>
          <Break/>
        </Case>
        <Default>
          <Set>ActBk1=441999</Set>
          <Set>ActBr1=441800</Set>
        </Default>
      </Switch>

      <Set>ActSq1=SUBSTR($TActNo,14,5)</Set>
      <Set>CdFlg1=D</Set>
      <Set>OuAmt1=$TxnAmt</Set>
      <Set>PayAt5=$STLACT</Set>
      <Set>CdFlg5=C</Set>
      <Set>InAmt5=$TxnAmt</Set>

      <!--用地区号区分电子柜员，解决省分行模式问题-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptId"/>
        <Arg name="DestNam" value="TlrId"/>
        <Arg name="TblNam"  value="DptId2TlrId"/>
      </Exec>

      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="$HTxnCd"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>

    <!--
        <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
      -->

      <If condition="~RetCod=0">  <!--recsts 0:初始化 1:成功 2:失败 -->
        <Exec func="PUB:ExecSql">
           <Arg name="SqlCmd" value="Updafetxnjnl"/>
        </Exec>
        <!--20121020 begin 反洗钱接口调用-->
        <Quote name="AntiMoneylaudry"/>
        <!--20121020 end 反洗钱接口调用-->
      </If>

    </FlowCtrl>
  </Transaction>

  <Transaction code="483813" desc="广东省烟草查询清算金额">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryTbcTot"><!--查询烟草公司清算信息-->
      <Sentence>
        select sum(cast(TxnAmt as bigint)) as SumAmt,coalesce(COUNT(*),0) TotCnt from afetxnjnl where ActDat = '%s' and CAgtNo= '%s' and HTxnSt='S' and HRspcd='SC0000' and ChkFlg='0'
      </Sentence>
      <Fields>TxnDat|CAgtNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

     <!--检查清算分行与选择清算单位是否一致-->
     <If condition="IS_NOEQUAL_STRING(SUBSTR($BrNo,1,3),SUBSTR($CAgtNo,1,3))">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=清算单位非本分行</Set>
       <Return/>     
     </If>


     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="QryTbcTot"/>
     </Exec>  
     <If condition="$TotCnt=0">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=331012</Set>
         <Set>RspMsg=没有清算数据</Set>
         <Return/>
     </If>
    </FlowCtrl>
  </Transaction>

  <Transaction code="483820" desc="烟草对公缴费记账回执打印">

		<FlowCtrl>      
      <!--If condition="INTCMP($EndDat,5,$ActDat)"> 
        <Set>RspCod=481599</Set>
        <Set>RspMsg=结束日期大于或者等于会计日期</Set>
        <Return/>
      </If-->

      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>

      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>

     <!--检查清算分行与选择清算单位是否一致-->
     <If condition="IS_NOEQUAL_STRING(SUBSTR($BrNo,1,3),SUBSTR($CAgtNo,1,3))">
       <Set>RspCod=460299</Set>
       <Set>RspMsg=清算单位非本分行</Set>
       <Return/>     
     </If>


      <!--转换为转入账号-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptId"/>
        <Arg name="DestNam" value="IActNo"/>
        <Arg name="TblNam"  value="GDYC_IActNo"/>
      </Exec> 
       <!--转换为转入账号名称-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="DptId"/>
        <Arg name="DestNam" value="IActNm"/>
        <Arg name="TblNam"  value="GDYC_IActNm"/>
      </Exec>      
      
                          
      <Set>PrtId=$TlrId</Set>
      <Set>PrtDat=$ActDat</Set>
      
      <If condition="ISNULL(DELSPACE($TckNo,all))">
			  <Set>FilNam=STRCAT(烟草对公缴费记账回执,$BgnDat,-,$EndDat,.rpt)</Set>
			  <Set>FmtFil=etc/TBC02_RPT.XML</Set><!--根据单位编号取得相应的清单格式名称-->
			  <Exec func="PUB:GenerateReport">
			  	<Arg name="ObjFil" value="STRCAT(dat/term/send/,$FilNam)"/>
			  	<Arg name="FmtFil" value="$FmtFil"/>
			  	<Arg name="Para1"  value="$CAgtNo"/>
			  	<Arg name="Para2"  value="$BgnDat"/>
			  	<Arg name="Para3"  value="$EndDat"/>
          <Arg name="Para4"  value="$NodNo"/>
          <Arg name="Para5"  value="$PrtId"/>
          <Arg name="Para6"  value="$PrtDat"/>
          <Arg name="Para7"  value="$IActNo"/>
          <Arg name="Para8"  value="$IActNm"/>
			  </Exec>
			  <Exec func="PUB:SendFileMessage2"><!--发出文件打印指令-->
			  	<Arg name="MsgTyp" value="4"/><!-- 消息类型，1通知2广播3文件4打印，一般传文件时用3，需要在前置打印时用4-->
			  	<Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
			  	<Arg name="BusTyp" value="46"/><!-- 业务类型-->
			  	<Arg name="AplCod" value="0251"/><!-- 应用码-->
			  	<Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
			  	<Arg name="Summary" value="电力对公缴费记账回执"/><!-- 消息内容-->
			  	<Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
			  	<Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
			  	<Arg name="SrcTlr" value="Billlp2"/><!-- 消息来源柜员-->
			  </Exec>
      </If>
      <Else>
			  <Set>FilNam=STRCAT(电力对公缴费记账回执,$BgnDat,-,$EndDat,.rpt)</Set>
			  <Set>FmtFil=etc/TBC03_RPT.XML</Set><!--根据单位编号取得相应的清单格式名称-->
			  <Exec func="PUB:GenerateReport">
			  	<Arg name="ObjFil" value="STRCAT(dat/term/send/,$FilNam)"/>
			  	<Arg name="FmtFil" value="$FmtFil"/>
			  	<Arg name="Para1"  value="$CAgtNo"/>
			  	<Arg name="Para2"  value="$BgnDat"/>
			  	<Arg name="Para3"  value="$EndDat"/>
          <Arg name="Para4"  value="$NodNo"/>
          <Arg name="Para5"  value="$PrtId"/>
          <Arg name="Para6"  value="$PrtDat"/>
          <Arg name="Para7"  value="$TckNo"/>
          <Arg name="Para8"  value="$IActNo"/>
          <Arg name="Para9"  value="$IActNm"/>
			  </Exec>
			  <Exec func="PUB:SendFileMessage2"><!--发出文件打印指令-->
			  	<Arg name="MsgTyp" value="4"/><!-- 消息类型，1通知2广播3文件4打印，一般传文件时用3，需要在前置打印时用4-->
			  	<Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
			  	<Arg name="BusTyp" value="46"/><!-- 业务类型-->
			  	<Arg name="AplCod" value="0251"/><!-- 应用码-->
			  	<Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
			  	<Arg name="Summary" value="电力对公缴费记账回执"/><!-- 消息内容-->
			  	<Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
			  	<Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
			  	<Arg name="SrcTlr" value="Billlp2"/><!-- 消息来源柜员-->
			  </Exec>
      </Else>

		</FlowCtrl>
	</Transaction>


<Transaction code="483821" desc="系统自动生成对账">
 	 <DynSentence name="ChkSigSts">
     <Sentence>
         SELECT SigSts FROM tbcbasinf WHERE DptId='%s'
     </Sentence>
     <Fields>DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="STxnJnl01">
     <Sentence>
         SELECT LogNo,RsFld1,FTxnTm,TCusId,ActNo,TxnAmt FROM afetxnjnl 
           WHERE ActDat='%s' and RsFld2='%s' and  HRspCd='SC0000' and  HTxnSt='S'
             ORDER BY LogNo
     </Sentence>
     <Fields>OActDt|DptId|</Fields>
   </DynSentence>
 	 <DynSentence name="STxnJnl02">
     <Sentence>
         SELECT LogNo,RsFld1,FTxnTm,TCusId,ActNo,TxnAmt FROM afetxnjnl 
           WHERE ActDat='%s' and RsFld2='%s' and  HRspCd='SC0000' and  HTxnSt='S' and LogNo>='%s'
             ORDER BY LogNo
     </Sentence>
     <Fields>OActDt|DptId|OLogNo|</Fields>
   </DynSentence>
    <!--生成文件 总笔数-->
    <DynSentence name="TotalDeal01">
      <Sentence>
        SELECT Count(*) TotSum, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotAmt
        FROM afetxnjnl
        WHERE CAgtNo = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND HRspCd='SC0000' AND TxnCod='483805'
      </Sentence>
      <Fields>CAgtNo|OActDt|</Fields>
    </DynSentence>
    <!--生成文件 总笔数-->
    <DynSentence name="TotalDeal02">
      <Sentence>
        SELECT Count(*) TotSum, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotAmt
        FROM afetxnjnl
        WHERE CAgtNo = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND HRspCd='SC0000' AND TxnCod='483805' and LogNo>='%s'
      </Sentence>
      <Fields>CAgtNo|OActDt|OLogNo|</Fields>
    </DynSentence>
		<DynSentence name="SelId">
			<Sentence>
				select DptId,DevId,Teller	from tbcbasinf 
			</Sentence>
		</DynSentence>
	 <FlowCtrl>

     <Exec func="PUB:OpenCursor"><!--打开游标-->
     	<Arg name="SqlCur" value="SelId"></Arg>
     	<Arg name="CursorName" value="Cursor1"></Arg>
     </Exec>	
     <If condition="~RetCod!=0">
     	<Set>MsgTyp=E</Set>
     	<Set>RspCod=RTY999</Set>
     	<Set>RspMsg=打开游标错 </Set>
     	<Return/>					
     </If>	

    <While>
    	<Exec func="PUB:FetchCursor" error="IGNORE"><!--取下一笔记录-->
    	  <Arg name="CursorName" value="Cursor1"></Arg>
    	</Exec>
    	<If condition="~RetCod=100">
    		<Break/>
    	</If>
			
     <!--转换为协议号-->
     <Exec func="PUB:CodeSwitching">
       <Arg name="DatSrc"  value="OPFCSW"/>
       <Arg name="SourNam" value="DptId"/>
       <Arg name="DestNam" value="CAgtNo"/>
       <Arg name="TblNam"  value="GDYC_DPTID"/>
     </Exec>
     <If condition="IS_EQUAL_STRING($CAgtNo,xxxxxxxxxx)">
     	  <Continue/>
     </If>
     <!--构成分行号-->
     <Set>BrNo=STRCAT(SUBSTR($CAgtNo,1,3),999)</Set>

     <!--交易初始化-->
     <Exec func="PUB:InitTransaction"/>
     <!--默认交易返回成功-->
     <Set>RspCod=0000</Set>

     <!--自动生成，没烟草公司时间
     <Set>TranDt=SUBSTR($TranTm,1,8)</Set>
     -->
     <!--会计日期和交易发起日期是否一致 test暂时封闭
     <If condition="IS_NOEQUAL_STRING($ActDat,$TranDt)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=银行日期与交易发起日期不一致</Set>
     	 <Set>Bal=0</Set>
     	 <Retrun/>
     </If>
     -->
     <!--检查系统签到状态
     <Exec func="PUB:ReadRecord">
       <Arg name="SqlCmd" value="ChkSigSts"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=9999</Set>
       <Set>RspMsg=数据库操作错误</Set>
       <Return/>
     </If>
     <If condition="IS_NOEQUAL_STRING($SigSts,0)">
     	 <Set>RspCod=9999</Set>
     	 <Set>RspMsg=签退状态,暂停交易</Set>
     	 <Return/>
     </If>
      -->

     <Exec func="PUB:IsExistNode" error="IGNORE">
       <Arg name="FieldName" value="ROOT.RTNDAT"/>
     </Exec>
     <If condition="INTCMP(~RetCod,3,1)">  <!--手工发起回应-->
       <Set>OActDt=$ROOT.RTNDAT</Set>
     </If>
     <Else>
       <Set>OActDt=CALCDATE($ActDat,-,d,1)</Set>
     </Else>

     <Set>OLogNo=000000</Set>
     <Set>TRANTM=$FTxnTm</Set>
     <Set>BANKID=9999999999</Set>
     <Set>TLogNo=0000000000000</Set>
     <Set>APPTYP=1000</Set>
  
     <Set>DatFil=STRCAT(dat/tbc/,jh,_,$DptId,_,$OActDt,.xml)</Set>
     <Set>DatFilNam=STRCAT(jh,_,$DptId,_,$OActDt,.xml)</Set>
     
     <If condition="IS_EQUAL_STRING($OLogNo,000000)">
       <!--取成功总笔数和总金额-->
       <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="TotalDeal01"/>
       </Exec>
       <If condition="~RetCod!=0">
         <Set>RspCod=9999</Set>
         <Set>RspMsg=数据库操作错误</Set>
         <Return/>
       </If>
       <!--生成对账明细文件开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="w"/>
         <Arg name="ESCFMT"   value="\\074\\077xml\\040version\\075\\0421\\0560\\042\\040encoding\\075\\042GBK\\042\\040standalone\\075\\042no\\042\\077\\076\\n"/>
       </Exec>   
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\074DLMAPS\\076\\n"/>
       </Exec>
       <!--文件PUB部分开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074PUB\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRADE_ID\\076"/>
         <Arg name="Data"     value="8918"/>
         <Arg name="ESCFMT"   value="\\074\\057TRADE_ID\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRAN_TIME\\076"/>
         <Arg name="Data"     value="$TRANTM"/>
         <Arg name="ESCFMT"   value="\\074\\057TRAN_TIME\\076\\n"/>       
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074BANK_ID\\076"/>
         <Arg name="Data"     value="$BANKID"/>
         <Arg name="ESCFMT"   value="\\074\\057BANK_ID\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074DPT_ID\\076"/>
         <Arg name="Data"     value="$DptId"/>
         <Arg name="ESCFMT"   value="\\074\\057DPT_ID\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRADE_SEQ\\076"/>
         <Arg name="Data"     value="$TLogNo"/>
         <Arg name="ESCFMT"   value="\\074\\057TRADE_SEQ\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074APP_TYPE\\076"/>
         <Arg name="Data"     value="$APPTYP"/>
         <Arg name="ESCFMT"   value="\\074\\057APP_TYPE\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\074\\057PUB\\076\\n"/>
       </Exec> 
       <!--文件PUB部分结束-->
       
       <!--文件OUT部分开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074OUT\\076\\n"/>
              
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074RET_CODE\\076"/>
         <Arg name="Data"     value="$RspCod"/>
         <Arg name="ESCFMT"   value="\\074\\057RET_CODE\\076\\n"/>
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074MSG\\076"/>
         <Arg name="Data"     value="交易成功"/>
         <Arg name="ESCFMT"   value="\\074\\057MSG\\076\\n"/>
       </Exec>
       <Exec func="PUB:OpenCursor">
         <Arg name="SqlCmd"     value="STxnJnl01"/>
         <Arg name="CursorName" value="CurTxn01"/>
       </Exec>       
       <While>
         <Exec func="PUB:FetchCursor" error="IGNORE">
           <Arg name="CursorName" value="CurTxn01"/>
         </Exec>
         <If condition="~RetCod=100">
           <Exec func="PUB:CloseCursor">
             <Arg name="CursorName" value="CurTxn01"/>
           </Exec>
           <Break/>
         </If>
         <ElseIf condition="~RetCod=-1">
           <Exec func="PUB:CloseCursor">
             <Arg name="CursorName" value="CurTxn01"/>
           </Exec>
           <Set>RspCod=9999</Set>
           <Set>RspMsg=游标FETCH操作错误</Set>
           <Return/>
         </ElseIf>
         <Set>LogNo=DELBOTHSPACE($LogNo)</Set>
         <Set>RsFld1=DELBOTHSPACE($RsFld1)</Set>
         <Set>FTxnTm=DELBOTHSPACE($FTxnTm)</Set>
         <Set>TCusId=DELBOTHSPACE($TCusId)</Set>
         <Set>ActNo=DELBOTHSPACE($ActNo)</Set>
         <Set>TxnAmt=DELBOTHSPACE($TxnAmt)</Set>
         <!--文件RE部分开始-->
         <Exec func="PUB:WriteFile" error="IGNORE">
           <Arg name="FileName" value="$DatFil"/>
           <Arg name="OpenMode" value="a+"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074RE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074BANK_SEQ\\076"/>
           <Arg name="Data"     value="$LogNo"/>
           <Arg name="ESCFMT"   value="\\074\\057BANK_SEQ\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074CO_NUM\\076"/>
           <Arg name="Data"     value="$RsFld1"/>
           <Arg name="ESCFMT"   value="\\074\\057CO_NUM\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074TIME_LABLE\\076"/>
           <Arg name="Data"     value="$FTxnTm"/>
           <Arg name="ESCFMT"   value="\\074\\057TIME_LABLE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074CUST_ID\\076"/>
           <Arg name="Data"     value="$TCusId"/>
           <Arg name="ESCFMT"   value="\\074\\057CUST_ID\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074ACC\\076"/>
           <Arg name="Data"     value="$ActNo"/>
           <Arg name="ESCFMT"   value="\\074\\057ACC\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074QTY_TRADE\\076"/>
           <Arg name="Data"     value="$TxnAmt"/>
           <Arg name="ESCFMT"   value="\\074\\057QTY_TRADE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074\\057RE\\076\\n"/>
         </Exec>
         <!--文件RE部分结束-->
       </While>
         <!--文件TOTAL部分开始-->
         <Exec func="PUB:WriteFile" error="IGNORE">
           <Arg name="FileName" value="$DatFil"/>
           <Arg name="OpenMode" value="a+"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074TOTAL\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074DEV_ID\\076"/>
           <Arg name="Data"     value="$DevId"/>
           <Arg name="ESCFMT"   value="\\074\\057DEV_ID\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074TELLER\\076"/>
           <Arg name="Data"     value="$Teller"/>
           <Arg name="ESCFMT"   value="\\074\\057TELLER\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074SUCC_COUNT\\076"/>
           <Arg name="Data"     value="$TotSum"/>
           <Arg name="ESCFMT"   value="\\074\\057SUCC_COUNT\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074SUCC_AMT\\076"/>
           <Arg name="Data"     value="$TotAmt"/>
           <Arg name="ESCFMT"   value="\\074\\057SUCC_AMT\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074\\057TOTAL\\076\\n"/>
         </Exec>
         <!--文件TOTAL部分结束-->       
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074\\057OUT\\076\\n"/>
       </Exec>      
       <!--文件OUT部分结束-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\074\\057DLMAPS\\076\\n"/>
       </Exec>      
       <!--生成对账明细文件结束-->
     </If>
     <Else>
       <!--取成功总笔数和总金额-->
       <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="TotalDeal02"/>
       </Exec>
       <If condition="~RetCod!=0">
         <Set>RspCod=9999</Set>
         <Set>RspMsg=数据库操作错误</Set>
         <Return/>
       </If>
       <!--生成对账明细文件开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="w"/>
         <Arg name="ESCFMT"   value="\\074\\077xml\\040version\\075\\0421\\0560\\042\\040encoding\\075\\042GBK\\042\\040standalone\\075\\042no\\042\\077\\076\\n"/>
       </Exec>   
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="w"/>
         <Arg name="ESCFMT"   value="\\074DLMAPS\\076\\n"/>
       </Exec>
       <!--文件PUB部分开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074PUB\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRADE_ID\\076"/>
         <Arg name="Data"     value="8918"/>
         <Arg name="ESCFMT"   value="\\074\\057TRADE_ID\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRAN_TIME\\076"/>
         <Arg name="Data"     value="$TRANTM"/>
         <Arg name="ESCFMT"   value="\\074\\057TRAN_TIME\\076\\n"/>       
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074BANK_ID\\076"/>
         <Arg name="Data"     value="$BANKID"/>
         <Arg name="ESCFMT"   value="\\074\\057BANK_ID\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074DPT_ID\\076"/>
         <Arg name="Data"     value="$DptId"/>
         <Arg name="ESCFMT"   value="\\074\\057DPT_ID\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074TRADE_SEQ\\076"/>
         <Arg name="Data"     value="$TLogNo"/>
         <Arg name="ESCFMT"   value="\\074\\057TRADE_SEQ\\076\\n"/>
       
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074APP_TYPE\\076"/>
         <Arg name="Data"     value="$APPTYP"/>
         <Arg name="ESCFMT"   value="\\074\\057APP_TYPE\\076\\n"/>
         
         <Arg name="ESCFMT"   value="\\040\\040\\074\\057PUB\\076\\n"/>
       </Exec> 
       <!--文件PUB部分结束-->
       
       <!--文件OUT部分开始-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074OUT\\076\\n"/>
              
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074RET_CODE\\076"/>
         <Arg name="Data"     value="$RspCod"/>
         <Arg name="ESCFMT"   value="\\074\\057RET_CODE\\076\\n"/>
         <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\074MSG\\076"/>
         <Arg name="Data"     value="交易成功"/>
         <Arg name="ESCFMT"   value="\\074\\057MSG\\076\\n"/>
       </Exec>
       <Exec func="PUB:OpenCursor">
         <Arg name="SqlCmd"     value="STxnJnl02"/>
         <Arg name="CursorName" value="CurTxn02"/>
       </Exec>       
       <While>
         <Exec func="PUB:FetchCursor" error="IGNORE">
           <Arg name="CursorName" value="CurTxn02"/>
         </Exec>
         <If condition="~RetCod=100">
           <Exec func="PUB:CloseCursor">
             <Arg name="CursorName" value="CurTxn02"/>
           </Exec>
           <Break/>
         </If>
         <ElseIf condition="~RetCod=-1">
           <Exec func="PUB:CloseCursor">
             <Arg name="CursorName" value="CurTxn02"/>
           </Exec>
           <Set>RspCod=9999</Set>
           <Set>RspMsg=游标FETCH操作错误</Set>
           <Return/>
         </ElseIf>
         <Set>LogNo=DELBOTHSPACE($LogNo)</Set>
         <Set>RsFld1=DELBOTHSPACE($RsFld1)</Set>
         <Set>FTxnTm=DELBOTHSPACE($FTxnTm)</Set>
         <Set>TCusId=DELBOTHSPACE($TCusId)</Set>
         <Set>ActNo=DELBOTHSPACE($ActNo)</Set>
         <Set>TxnAmt=DELBOTHSPACE($TxnAmt)</Set>
         <!--文件RE部分开始-->
         <Exec func="PUB:WriteFile" error="IGNORE">
           <Arg name="FileName" value="$DatFil"/>
           <Arg name="OpenMode" value="a+"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074RE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074BANK_SEQ\\076"/>
           <Arg name="Data"     value="$LogNo"/>
           <Arg name="ESCFMT"   value="\\074\\057BANK_SEQ\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074CO_NUM\\076"/>
           <Arg name="Data"     value="$RsFld1"/>
           <Arg name="ESCFMT"   value="\\074\\057CO_NUM\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074TIME_LABLE\\076"/>
           <Arg name="Data"     value="$FTxnTm"/>
           <Arg name="ESCFMT"   value="\\074\\057TIME_LABLE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074CUST_ID\\076"/>
           <Arg name="Data"     value="$TCusId"/>
           <Arg name="ESCFMT"   value="\\074\\057CUST_ID\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074ACC\\076"/>
           <Arg name="Data"     value="$ActNo"/>
           <Arg name="ESCFMT"   value="\\074\\057ACC\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074QTY_TRADE\\076"/>
           <Arg name="Data"     value="$TxnAmt"/>
           <Arg name="ESCFMT"   value="\\074\\057QTY_TRADE\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074\\057RE\\076\\n"/>
         </Exec>
         <!--文件RE部分结束-->
       </While>
         <!--文件TOTAL部分开始-->
         <Exec func="PUB:WriteFile" error="IGNORE">
           <Arg name="FileName" value="$DatFil"/>
           <Arg name="OpenMode" value="a+"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074TOTAL\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074DEV_ID\\076"/>
           <Arg name="Data"     value="$DevId"/>
           <Arg name="ESCFMT"   value="\\074\\057DEV_ID\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074TELLER\\076"/>
           <Arg name="Data"     value="$Teller"/>
           <Arg name="ESCFMT"   value="\\074\\057TELLER\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074SUCC_COUNT\\076"/>
           <Arg name="Data"     value="$TotSum"/>
           <Arg name="ESCFMT"   value="\\074\\057SUCC_COUNT\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\040\\040\\074SUCC_AMT\\076"/>
           <Arg name="Data"     value="$TotAmt"/>
           <Arg name="ESCFMT"   value="\\074\\057SUCC_AMT\\076\\n"/>
           <Arg name="ESCFMT"   value="\\040\\040\\040\\040\\040\\040\\074\\057TOTAL\\076\\n"/>
         </Exec>
         <!--文件TOTAL部分结束-->        
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\040\\040\\074\\057OUT\\076\\n"/>
       </Exec>      
       <!--文件OUT部分结束-->
       <Exec func="PUB:WriteFile" error="IGNORE">
         <Arg name="FileName" value="$DatFil"/>
         <Arg name="OpenMode" value="a+"/>
         <Arg name="ESCFMT"   value="\\074\\057DLMAPS\\076\\n"/>
       </Exec>      
       <!--生成对账明细文件结束-->     	
     </Else>
      <Set>SndFil=$DatFilNam</Set>
      <Set>LclFil=$SndFil</Set>

     <Set>FtpStr=STRCAT(TBC,$DptId)</Set>
     <Exec func="PUB:FtpPut" error="IGNORE">
     	<Arg name="FtpId" value="$FtpStr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Exec func="PUB:CloseCursor">
         <Arg name="CursorName" value="Cursor1"></Arg>
       </Exec>
       <Set>RspCod=482199</Set>
       <Set>RspMsg=取文件失败</Set>
       <Return/>
     </If>

		</While>
    <Exec func="PUB:CloseCursor">
      <Arg name="CursorName" value="Cursor1"></Arg>
    </Exec>
			
     <Set>MsgTyp=N</Set>
     <Set>RspMsg=交易成功</Set>         
	 </FlowCtrl>
</Transaction>


</Application>


