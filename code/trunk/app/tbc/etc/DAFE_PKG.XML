<?xml version='1.0' encoding='ISO-8859-1'?>
<Package>
   <Define>
      <Macro name="Def_TxnChk"><!--功能检查相关语句定义-->
         <DynSentence name="Chk_CrpAgr"><!--检查单位协议 -->
            <Sentence>
               select BBusTyp,TActNo from savcrpagr where CAgtNo='%s' and SvrSts='1'
            </Sentence>
            <Fields>CAgtNo|</Fields>
         </DynSentence>
         <DynSentence name="Chk_CrpSignIn"><!--检查单位签到状态 -->
            <Sentence>
               SELECT 'Y' YN from table(values(1)) as anony
               where Exists(select * from savthdinf where CAgtNo='%s' and status='1')
            </Sentence>
            <Fields>CAgtNo|</Fields>
         </DynSentence>
         <DynSentence name="Chk_PsnAgr"><!--检查个人协议 -->
            <Sentence>
               select CnlSts from savcusagt
               where CAgtNo='%s' and TCusId='%s' and ActTyp='%s' and ActNo='%s' and status='0' fetch first 1 rows only
            </Sentence>
            <Fields>CAgtNo|TCusId|ActFlg|ActNo|</Fields>
         </DynSentence>
      </Macro>
      <Macro name="Do_TxnChk"><!--功能检查动作定义-->
         <Set>inTxnCnl=STRCAT(|,$TxnCnl,|)</Set>
         <If condition="OR(ISNULL(@PARA.ChkCrp),ISNULL(@PARA.CnlLst),ISNULL(@PARA.ChkPsn),ISNULL(@PARA.IsSignIn))">
            <Set>RspCod=478600</Set><!--应用参数未定义-->
            <Set>RspMsg=受理渠道 </Set>
            <Return/>
         </If>
         <If condition="INTCMP(GETSTRPOS(@PARA.CnlLst,$inTxnCnl),1,0)">
            <Set>RspCod=478601</Set><!--返回$TxnCnl渠道不允许-->
            <Return/>
         </If>
         <If condition="@PARA.ChkCrp=1">
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="Chk_CrpAgr"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>RspCod=478399</Set>
               <Set>RspMsg=查询单位协议时系统错误</Set>
               <Return/>
            </If>
            <If condition="~RetCod=-2">
               <Set>RspCod=478602</Set><!--返回无有效单位协议-->
               <Return/>
            </If>
         </If>
         <If condition="@PARA.ChkPsn=1">
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="Chk_PsnAgr"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>RspCod=478399</Set>
               <Set>RspMsg=检查个人协议时系统错误</Set>
               <Return/>
            </If>
            <If condition="~RetCod=-2">
               <Set>RspCod=478603</Set><!--返回无有效个人协议-->
               <Return/>
            </If>
            <If condition="INTCMP(GETSTRPOS(@PARA.CnlLst,$inTxnCnl),1,0)">
               <Set>RspCod=478604</Set><!--个人协议不支持该渠道功能-->
               <Return/>
            </If>
         </If>
         <If condition="@PARA.IsSignIn=1">
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="Chk_CrpSignIn"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>RspCod=478399</Set>
               <Set>RspMsg=检查单位签到状态时系统错误</Set>
               <Return/>
            </If>
            <If condition="~RetCod=-2">
               <Set>RspCod=478605</Set><!--返回该单位未签到-->
               <Return/>
            </If>
         </If>
      </Macro>
   </Define>

   <Function name="AFE_QryTotAmt" desc="待缴费总额查询">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="Qry_Fee"><!--查询待缴费用总额 -->
         <Sentence>
            Select coalesce(SUM(CAST(TotAmt AS BIGINT)),0) SumAmt FROM afefeedat %s
         </Sentence>
         <Fields>@PARA.QryCnd|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Switch expression="@PARA.TxnMod">
            <Case value="0"><!--查询本地费用表 -->
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="Qry_Fee"/>
               </Exec>
               <If condition="~RetCod=-1">
                  <Set>RspCod=478399</Set><!--无待交费用-->
                  <Set>RspMsg=查询本地费用表时系统错误</Set>
                  <Return/>
               </If>
               <If condition="~RetCod=-2">
                  <Set>RspCod=478399</Set><!--无待交费用-->
                  <Set>RspMsg=无待缴费用</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Case value="1"><!--仅查询第三方 -->
               <Exec func="PUB:CallThirdOther" error="IGNORE"><!-- 调用第三方交易-->
                  <Arg name="HTxnCd" value="@PARA.TTxnCd"/>
                  <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
               </Exec>
               <Switch expression="~RetCod"><!--~RetCod -->
                  <Case value="-1"><!--查询第三方超时 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=查询第三方超时</Set>
                     <Break/>
                  </Case>
                  <Case value="-10"><!--查询第三方时未发送成功，请重发交易 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=查询第三方时未发送成功</Set>
                     <Break/>
                  </Case>
                  <Case value="-2"><!--查询第三方时系统错误 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=查询第三方时系统错误</Set>
                     <Break/>
                  </Case>
                  <Default><!--交易有返回时处理-->
                     <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                     <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                        <Set>RspCod=478606</Set><!--交易不成功-->
                        <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
                        <Return/>
                     </If>
                     <Else>
                        <Set>RspCod=000000</Set>
                     </Else>
                     <Break/>
                  </Default>
               </Switch>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set>
               <Set>RspMsg=查询模式参数错 </Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>
      </Process>
   </Function>

   <Function name="AFE_SglBkPay" desc="单笔缴费(银行发起)">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="QryBrNo"><!--检查本地费用表是否有待缴费用-->
         <Sentence>
            SELECT OrgBk BrNo FROM cimorgtbl WHERE OrgNo='%s'
         </Sentence>
         <Fields>NodNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkFeeFlg"><!--检查本地费用表是否有待缴费用-->
         <Sentence>
            SELECT * FROM afefeedat %s
         </Sentence>
         <Fields>@PARA.QryCnd|</Fields>
      </DynSentence>
      <DynSentence name="UpdFeeFlg"><!--更新缴费标志-->
         <Sentence>
            UPDATE afefeedat SET Flg='1' %s
         </Sentence>
         <Fields>@PARA.QryCnd|</Fields>
      </DynSentence>
      <DynSentence name="UpdThdJnl"><!--更新缴费标志-->
         <Sentence>
            LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <If condition="AND(IS_NOEQUAL_STRING(@PARA.TxnMod,0),IS_NOEQUAL_STRING(@PARA.TxnMod,1),IS_NOEQUAL_STRING(@PARA.TxnMod,2))">
            <Set>RspCod=478600</Set>
            <Set>RspMsg=缴费模式 </Set>
            <Return/>
         </If>
         <Set>inTxnCnl=STRCAT(|,$TxnCnl,|)</Set>
         <If condition="AND(IS_EQUAL_STRING(@PARA.RollBack,1),INTCMP(GETSTRPOS(@PARA.RollBackCnls,$inTxnCnl),5,0))">
            <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
         </If>

         <If condition="@PARA.TxnMod=0">
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="ChkFeeFlg"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Set>RspCod=478613</Set>
               <Set>RspMsg=无待缴费数据或数据库错 </Set>
               <Return/>
            </If>
            <If condition="$Flg=1">
               <Set>RspCod=478609</Set>
               <Set>RspMsg=该费用已缴纳过,请确认!</Set>
               <Return/>
            </If>
         </If>

         <Set>Mask=STRCAT(9,$BBusTyp)</Set>
         <Set>CcyTyp=0</Set>
         <Set>TxnMod=$ActFlg</Set>
         <Exec func="PUB:GetAppInfo"/>
         <If condition="INTCMP(@PARA.NeedLogNo,4,0)">
            <Exec func="PUB:GetLogNo"/>
         </If>
         <Else>
            <If condition="ISNULL($LogNo)">
               <Set>RspCod=478614</Set>
               <Set>RspMsg=未申请流水号 </Set>
               <Return/>
            </If>
         </Else>
         <Exec func="PUB:InsertRecordExt" error="IGNORE">
            <Arg name="TblNam" value="afetxnjnl"/>
         </Exec>
         <If condition="INTCMP(~RetCod,4,0)">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=插入流水表失败</Set>
            <Return/>
         </If>
         <Exec func="PUB:CallHostOther" error="IGNORE">   <!--主机单笔缴费-->
            <Arg name="HTxnCd" value="@PARA.HTxnCd_P2C"/>
            <Arg name="ObjSvr" value="@PARA.CBHost"/>
         </Exec>
         <Switch expression="~RetCod">
            <Case value="-10">
               <Exec func="PUB:UpdateJournal"/>
               <Set>RspCod=478607</Set>
               <Set>RspMsg=发送失败</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="-2">
               <Exec func="PUB:UpdateJournal"/>
               <Set>RspCod=478607</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="-1">
               <Exec func="PUB:UpdateJournalHost"/>
               <Exec func="PUB:CommitWork"/><!--提交更新记录-->
               <If condition="IS_NOEQUAL_STRING($TxnCnl,TRM)">
                  <Exec func="PUB:SetNoResponse"/>
               </If>
               <Exec func="PUB:DefaultErrorProc"/>
               <Set>RspCod=478607</Set>
               <Set>RspMsg=主机交易超时,请立即抹帐</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="-9">
               <Set>RspMsg=交易需要授权</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="3"><!--失败 -->
               <Exec func="PUB:UpdateJournal"/>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="0">
               <Exec func="PUB:UpdateJournalHost"/>
               <Exec func="PUB:CommitWork"/>
               <Break/>
            </Case>
            <Default>
               <Exec func="PUB:UpdateJournal"/>
               <Set>RspCod=478607</Set>
               <Set>RspMsg=未知错误,请联系电脑运行中心</Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>
         <Switch expression="@PARA.TxnMod">
            <Case value="0">  <!--更新本地费用表-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdFeeFlg"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="1">  <!--去第三方记账-->
               <Exec func="PUB:CallThirdOther" error="IGNORE"><!--发第三方记账-->
                  <Arg name="HTxnCd" value="@PARA.TTxnCd"/>
                  <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
               </Exec>
               <Switch expression="~RetCod">
                  <Case value="-1"><!--第三方交易超时 -->
                     <Set>TxnSts=U</Set>
                     <Set>TTxnSt=T</Set>
                     <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                        <Arg name="TblNam" value="afetxnjnl"/>
                        <Arg name="CndSts" value="UpdThdJnl"/>
                     </Exec>
                     <If condition="INTCMP(~RetCod,4,0)">
                        <Set>RspCod=478399</Set>
                        <Set>RspMsg=更新流水表第三方信息失败</Set>
                     </If>
                     <Exec func="PUB:CommitWork"/><!--提交更新记录-->
                     <If condition="IS_NOEQUAL_STRING($TxnCnl,TRM)">
                        <Exec func="PUB:SetNoResponse"/>
                     </If>
                     <Exec func="PUB:DefaultErrorProc"/>
                     <Set>RspCod=478613</Set>
                     <Set>RspMsg=第三方交易超时</Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Case value="-10"><!--第三方交易未发送成功 -->
                     <Set>TxnSts=X</Set>
                     <Set>TTxnSt=X</Set>
                     <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                        <Arg name="TblNam" value="afetxnjnl"/>
                        <Arg name="CndSts" value="UpdThdJnl"/>
                     </Exec>
                     <If condition="INTCMP(~RetCod,4,0)">
                        <Set>RspCod=478399</Set>
                        <Set>RspMsg=更新流水表第三方信息失败</Set>
                     </If>
                     <Exec func="PUB:CommitWork"/><!--提交更新记录-->
                     <Exec func="PUB:DefaultErrorProc"/>
                     <Set>RspCod=478613</Set>
                     <Set>RspMsg=发送到第三方失败</Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Case value="-2"><!--第三方交易系统错误 -->
                     <Set>TxnSts=X</Set>
                     <Set>TTxnSt=X</Set>
                     <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                        <Arg name="TblNam" value="afetxnjnl"/>
                        <Arg name="CndSts" value="UpdThdJnl"/>
                     </Exec>
                     <If condition="INTCMP(~RetCod,4,0)">
                        <Set>RspCod=478399</Set>
                        <Set>RspMsg=更新流水表第三方信息失败</Set>
                     </If>
                     <Exec func="PUB:CommitWork"/><!--提交更新记录-->
                     <Exec func="PUB:DefaultErrorProc"/>
                     <Set>RspCod=478613</Set>
                     <Set>RspMsg=调用第三方系统错误</Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Default><!--交易有明确返回-->
                     <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                     <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                        <Set>TTxnSt=F</Set>
                        <Set>TxnSts=F</Set>
                        <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                           <Arg name="TblNam" value="afetxnjnl"/>
                           <Arg name="CndSts" value="UpdThdJnl"/>
                        </Exec>
                        <If condition="INTCMP(~RetCod,4,0)">
                           <Set>RspCod=478399</Set>
                           <Set>RspMsg=更新流水表第三方信息失败</Set>
                        </If>
                        <Exec func="PUB:CommitWork"/><!--提交更新记录-->
                        <Exec func="PUB:DefaultErrorProc"/>
                        <Set>RspCod=478613</Set><!--第三方交易失败-->
                        <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
                        <Return/>
                     </If>
                     <Else>
                        <Set>TTxnSt=S</Set>
                        <Set>TxnSts=S</Set>
                        <Set>RspCod=000000</Set>
                        <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                           <Arg name="TblNam" value="afetxnjnl"/>
                           <Arg name="CndSts" value="UpdThdJnl"/>
                        </Exec>
                        <If condition="INTCMP(~RetCod,4,0)">
                           <Set>RspCod=478399</Set>
                           <Set>RspMsg=更新流水表第三方信息失败</Set>
                           <Exec func="PUB:DefaultErrorProc"/>
                           <Return/>
                        </If>
                        <Exec func="PUB:CommitWork"/>
                     </Else>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
               <Break/>
            </Case>
            <Case value="2">  <!--个性定制 -->
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set>  <!--系统参数错误 -->
               <Set>RspMsg=第三方交易模式 </Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>
      </Process>
   </Function>


   <Function name="AFE_SglThdPay" desc="单笔缴费(第三方发起)">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="ChkRepeat"><!--检查第三方流水是否重复 -->
         <Sentence>
            SELECT 'Y' YN from table(values(1)) as anony where Exists(Select * FROM afetxnjnl WHERE ThdKey='%s')
         </Sentence>
         <Fields>@PARA.ThdKey|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Switch expression="@PARA.RepeatChk">   <!--交易重复性检查-->
            <Case value="0">
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="ChkRepeat"/>
               </Exec>
               <If condition="~RetCod=0">
                  <Set>RspCod=478608</Set>
                  <Set>RspMsg=第三方交易重复</Set>
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=-2">
                  <Break/>
               </ElseIf>
               <Else>
                  <Set>RspCod=478699</Set>
                  <Set>RspMsg=数据库操作错</Set>
                  <Return/>
               </Else>
               <Break/>
            </Case>
            <Case value="1"><!--个性检查-->
               <Call function="@PARA.IddFunc_RepeatChk"/>
               <Break/>
            </Case>
            <Case value="2"><!--不检查-->
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set><!--系统参数错误 -->
               <Set>RspMsg=交易重复性检查 </Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>

         <If condition="AND(IS_EQUAL_STRING(@PARA.RollBack,1),INTCMP(GETSTRPOS(@PARA.RollBackCnls,$TxnCnl),5,0))">
            <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
         </If>

         <Exec func="PUB:GetAppInfo"/>
         <Exec func="PUB:GetLogNo"/>
         <!--由于省分行模式，无法通过分行号获取，因此屏蔽
         <Exec func="PUB:GetVirtualTeller">
            <Arg name="TxnCnl" value="TBC"/>
            <Arg name="CnlSub" value="$BrNo"/>
         </Exec>
         -->
         <Exec func="PUB:InsertRecordExt" error="IGNORE">
            <Arg name="TblNam" value="afetxnjnl"/>
         </Exec>
         <If condition="INTCMP(~RetCod,4,0)">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=插入流水表失败</Set>
            <Return/>
         </If>
         <Set>Mask=STRCAT(9,$BBusTyp)</Set>
         <Set>CcyTyp=0</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE">   <!--主机单笔缴费-->
            <Arg name="HTxnCd" value="@PARA.HTxnCd_P2C"/>
            <Arg name="ObjSvr" value="@PARA.CBHost"/>
         </Exec>
         <Switch expression="~RetCod">
            <Case value="-10">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>RspCod=478607</Set>
               <Set>RspMsg=发送交易失败</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="-2">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>RspCod=478607</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="-1">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="T"/>
               </Exec>
               <If condition="IS_NOEQUAL_STRING($TxnCnl,TRM)">
                  <Exec func="PUB:SetNoResponse"/>
               </If>
               <Exec func="PUB:DefaultErrorProc"/>
               <Set>RspCod=478607</Set>
               <Set>RspMsg=主机交易超时</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="-9">
               <Set>RspMsg=交易需要授权</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="3">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
               <Break/>
            </Case>
            <Case value="0">
               <Exec func="PUB:UpdateJournalHost"/>
               <Break/>
            </Case>
            <Default>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>RspCod=478607</Set>
               <Set>RspMsg=未知错误,请联系电脑运行中心</Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>

         <Exec func="PUB:CommitWork"/>
      </Process>
   </Function>

   <Function name="AFE_BkCancel" desc="抹账及冲正(银行发起)">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="QryJnlInfo"><!--查询流水信息 -->
         <Sentence>
            LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="SetTTxnSt">
         <Sentence>
            UPDATE afetxnjnl SET TTxnSt='%s' WHERE LogNo='%s'
         </Sentence>
         <Fields>TTxnSt|LogNo|</Fields>
      </DynSentence>
      <DynSentence name="SetSts">
         <Sentence>
            UPDATE afetxnjnl SET (TxnSts,HTxnSt)=('%s','%s') WHERE LogNo='%s'
         </Sentence>
         <Fields>TxnSts|HTxnSt|LogNo|</Fields>
      </DynSentence>
      <Process>
         <Set>LckKey=STRCAT(afetxnjnl,:,$LogNo)</Set>
         <Exec func="PUB:Lock" error="IGNORE"><!-- 通过加锁控制批次状态 -->
            <Arg name="RecKey" value="$LckKey"/>
            <Arg name="TimOut" value="60"/>
            <Arg name="AutoUnlock" value="yes"/>
         </Exec>
         <If condition="INTCMP(~RetCod,4,0)"><!--加锁失败-->
            <Set>RspCod=478004</Set>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecordExt"><!--20060224 ReadRecordExt -->
            <Arg name="TblNam" value="afetxnjnl"/>
            <Arg name="CndSts" value="QryJnlInfo"/>
         </Exec>
         <Delete>TRspCd</Delete>
         <!--抹第三方-->
         <If condition="OR(IS_EQUAL_STRING(@PARA.TxnMod,0),IS_EQUAL_STRING(@PARA.TxnMod,2))">
            <If condition="INTCMP(GETSTRPOS(|U|S|T|,$TTxnSt),5,0)"><!--第三方交易状态需要抹账-->
               <Set>OTTxnSt=$TTxnSt</Set>
               <Switch expression="@PARA.TTxnMod">
                  <Case value="0"><!--仅调用第三方交易-->
                     <Exec func="PUB:CallThirdOther" error="IGNORE"><!-- 调用第三方交易-->
                        <Arg name="HTxnCd" value="@PARA.TTxnCd"/>
                        <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
                     </Exec>
                     <Switch expression="~RetCod">
                        <Case value="0"/><!--抹帐成功时 -->
                        <Set>TTxnSt=C</Set>
                        <Exec func="PUB:ExecSql">
                           <Arg name="SqlCmd" value="SetTTxnSt"/>
                        </Exec>
                        <Break/>
                        <Case value="3"><!--抹账返回失败时-->
                           <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                           <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                              <Set>RspCod=478614</Set><!--抹账失败-->
                              <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
                              <Set>TTxnSt=$OTTxnSt</Set>
                              <Exec func="PUB:ExecSql">
                                 <Arg name="SqlCmd" value="SetTTxnSt"/>
                              </Exec>
                              <Return/>
                           </If>
                           <Else>
                              <Set>RspCod=000000</Set>
                              <Set>TTxnSt=C</Set>
                              <Exec func="PUB:ExecSql">
                                 <Arg name="SqlCmd" value="SetTTxnSt"/>
                              </Exec>
                           </Else>
                           <Break/>
                        </Case>
                        <Default>
                           <Set>TTxnSt=$OTTxnSt</Set>
                           <Exec func="PUB:ExecSql">
                              <Arg name="SqlCmd" value="SetTTxnSt"/>
                           </Exec>
                           <If condition="IS_NOEQUAL_STRING($TxnCnl,TRM)">
                              <Exec func="PUB:SetNoResponse"/>
                           </If>
                           <Set>RspCod=478614</Set><!--第三方交易失败-->
                           <Set>RspMsg=请重新抹账</Set>
                           <Return/>
                           <Break/>
                        </Default>
                     </Switch>
                     <Break/>
                  </Case>
                  <Case value="1"><!--个性处理-->
                     <Call function="@PARA.IddCancelFunc"/>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478600</Set><!--系统参数错误 -->
                     <Set>RspMsg=第三方抹账模式错误</Set>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
            </If>
         </If>
         <!--抹主机-->
         <If condition="OR(IS_EQUAL_STRING(@PARA.TxnMod,0),IS_EQUAL_STRING(@PARA.TxnMod,1))">
            <If condition="INTCMP(GETSTRPOS(|U|S|T|,$HTxnSt),5,0)"><!--主机交易状态需要抹账-->
               <!--抹主机动作-->
               <Set>OTxnSts=$TxnSts</Set>
               <Set>OHTxnSt=$HTxnSt</Set>
               <Set>TTxnCd=$TxnCod</Set>
               <Set>TIATyp=C</Set>
               <Set>HTxnCd=@PARA.HTxnCd_DSCal</Set>
               <!--Exec func="PUB:GetBranchInf"/-->
               <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
                  <Arg name="HTxnCd" value="@PARA.HTxnCd_Cancel"/>
                  <Arg name="ObjSvr" value="@PARA.CBHost"/>
               </Exec>
               <Switch expression="~RetCod">
                  <Case value="0"><!--抹帐成功时 -->
                     <Set>TxnSts=C</Set>
                     <Set>HTxnSt=C</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="SetSts"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="3">
                     <Set>inHRspCd=STRCAT(|,$HRspCd,|)</Set>
                     <If condition="INTCMP(GETSTRPOS(@PARA.HstNoJnl,$inHRspCd),5,0)">
                        <Set>TxnSts=C</Set>
                        <Set>HTxnSt=C</Set>
                     </If>
                     <Else>
                        <Set>TxnSts=$OTxnSts</Set>
                        <Set>HTxnSt=$OHTxnSt</Set>
                     </Else>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="SetSts"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>TxnSts=$OTxnSts</Set>
                     <Set>HTxnSt=$OHTxnSt</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="SetSts"/>
                     </Exec>
                     <If condition="IS_NOEQUAL_STRING($TxnCnl,TRM)">
                        <Exec func="PUB:SetNoResponse"/>
                     </If>
                     <Set>RspCod=478614</Set>
                     <Set>RspMsg=请重新抹账</Set>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
            </If>
         </If>
      </Process>
   </Function>

   <Function name="AFE_BkOthCancel" desc="抹账及冲正(银行其他渠道发起的)">
      <DynSentence name="QryJnlInfo"><!--查询流水信息 -->
         <Sentence>
            NodTrc='%s' and ActDat='%s' and TxnCnl='%s'
         </Sentence>
         <Fields>NodTrc|TxnDat|TxnCnl|</Fields>
      </DynSentence>
      <DynSentence name="SetTTxnSt">
         <Sentence>
            UPDATE afetxnjnl SET TTxnSt='%s' WHERE LogNo='%s'
         </Sentence>
         <Fields>TTxnSt|LogNo|</Fields>
      </DynSentence>
      <DynSentence name="SetSts">
         <Sentence>
            UPDATE afetxnjnl SET (TxnSts,HTxnSt)=('%s','%s') WHERE LogNo='%s'
         </Sentence>
         <Fields>TxnSts|HTxnSt|LogNo|</Fields>
      </DynSentence>
      <Process>
         <Exec func="PUB:ReadRecordExt"><!--20060224 ReadRecordExt -->
            <Arg name="TblNam" value="afetxnjnl"/>
            <Arg name="CndSts" value="QryJnlInfo"/>
         </Exec>
         <Delete>TRspCd</Delete>

         <Set>LckKey=STRCAT(afetxnjnl,:,$LogNo)</Set>
         <Exec func="PUB:Lock" error="IGNORE"><!-- 通过加锁控制批次状态 -->
            <Arg name="RecKey" value="$LckKey"/>
            <Arg name="TimOut" value="60"/>
            <Arg name="AutoUnlock" value="yes"/>
         </Exec>
         <If condition="INTCMP(~RetCod,4,0)"><!--加锁失败-->
            <Set>RspCod=478004</Set>
            <Return/>
         </If>
         <!--抹第三方-->
         <If condition="OR(IS_EQUAL_STRING(@PARA.TxnMod,0),IS_EQUAL_STRING(@PARA.TxnMod,2))">
            <If condition="INTCMP(GETSTRPOS(|U|S|T|,$TTxnSt),5,0)"><!--第三方交易状态需要抹账-->
               <Set>OTTxnSt=$TTxnSt</Set>
               <Switch expression="@PARA.TTxnMod">
                  <Case value="0"><!--仅调用第三方交易-->
                     <Exec func="PUB:CallThirdOther" error="IGNORE"><!-- 调用第三方交易-->
                        <Arg name="HTxnCd" value="@PARA.TTxnCd"/>
                        <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
                     </Exec>
                     <Switch expression="~RetCod">
                        <Case value="0"/><!--抹帐成功时 -->
                        <Set>TTxnSt=C</Set>
                        <Exec func="PUB:ExecSql">
                           <Arg name="SqlCmd" value="SetTTxnSt"/>
                        </Exec>
                        <Break/>
                        <Case value="3"><!--抹账返回失败时-->
                           <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                           <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                              <Set>RspCod=478614</Set><!--抹账失败-->
                              <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
                              <Set>TTxnSt=$OTTxnSt</Set>
                              <Exec func="PUB:ExecSql">
                                 <Arg name="SqlCmd" value="SetTTxnSt"/>
                              </Exec>
                              <Return/>
                           </If>
                           <Else>
                              <Set>RspCod=000000</Set>
                              <Set>TTxnSt=C</Set>
                              <Exec func="PUB:ExecSql">
                                 <Arg name="SqlCmd" value="SetTTxnSt"/>
                              </Exec>
                           </Else>
                           <Break/>
                        </Case>
                        <Default>
                           <Set>TTxnSt=$OTTxnSt</Set>
                           <Exec func="PUB:ExecSql">
                              <Arg name="SqlCmd" value="SetTTxnSt"/>
                           </Exec>
                           <Exec func="PUB:SetNoResponse"/>
                           <Set>RspCod=478614</Set><!--第三方交易失败-->
                           <Set>RspMsg=请重新抹账</Set>
                           <Return/>
                           <Break/>
                        </Default>
                     </Switch>
                     <Break/>
                  </Case>
                  <Case value="1"><!--个性处理-->
                     <Call function="@PARA.IddCancelFunc"/>
                  </Case>
                  <Default>
                     <Set>RspCod=478600</Set><!--系统参数错误 -->
                     <Set>RspMsg=第三方抹账模式错误</Set>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
            </If>
         </If>
         <!--抹主机-->
         <If condition="OR(IS_EQUAL_STRING(@PARA.TxnMod,0),IS_EQUAL_STRING(@PARA.TxnMod,1))">
            <If condition="INTCMP(GETSTRPOS(|U|S|T|,$HTxnSt),5,0)"><!--主机交易状态需要抹账-->
               <!--抹主机动作-->
               <Set>OTxnSts=$TxnSts</Set>
               <Set>OHTxnSt=$HTxnSt</Set>
               <Set>TTxnCd=$TxnCod</Set>
               <Set>TIATyp=C</Set>
               <Set>HTxnCd=@PARA.HTxnCd_DSCal</Set>
               <!--Exec func="PUB:GetBranchInf"/-->
               <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
                  <Arg name="HTxnCd" value="@PARA.HTxnCd_Cancel"/>
                  <Arg name="ObjSvr" value="@PARA.CBHost"/>
               </Exec>
               <Switch expression="~RetCod">
                  <Case value="0"><!--抹帐成功时 -->
                     <Set>TxnSts=C</Set>
                     <Set>HTxnSt=C</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="SetSts"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="3">
                     <Set>inHRspCd=STRCAT(|,$HRspCd,|)</Set>
                     <If condition="INTCMP(GETSTRPOS(@PARA.HstNoJnl,$inHRspCd),5,0)">
                        <Set>TxnSts=C</Set>
                        <Set>HTxnSt=C</Set>
                     </If>
                     <Else>
                        <Set>TxnSts=$OTxnSts</Set>
                        <Set>HTxnSt=$OHTxnSt</Set>
                     </Else>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="SetSts"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>TxnSts=$OTxnSts</Set>
                     <Set>HTxnSt=$OHTxnSt</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="SetSts"/>
                     </Exec>
                     <Exec func="PUB:SetNoResponse"/>
                     <Set>RspCod=478614</Set>
                     <Set>RspMsg=请重新抹账</Set>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
            </If>
         </If>
      </Process>
   </Function>

   <Function name="AFE_ThdCancel" desc="抹账及冲正(第三方发起)">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="ThdQryJnl"><!--按第三方键值查询流水信息 -->
         <Sentence>
            SELECT HTxnCd,TTxnCd,HTxnSt,LogNo,TckNo,HLogNo FROM afetxnjnl  WHERE ThdKey='%s' AND HTxnSt in ('S','T','U')
         </Sentence>
         <Fields>@PARA.ThdKey|</Fields>
      </DynSentence>
      <DynSentence name="FrtQryJnl"><!--按前置流水号查询流水信息 -->
         <Sentence>
            SELECT HTxnCd,TTxnCd,HTxnSt,TLogNo,TckNo,HLogNo FROM afetxnjnl WHERE LogNo='%s' AND HTxnSt in ('S','T','U')
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="SetSts">
         <Sentence>
            UPDATE afetxnjnl SET (TxnSts,HTxnSt)=('%s','%s') WHERE LogNo='%s'
         </Sentence>
         <Fields>TxnSts|HTxnSt|LogNo|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Switch expression="@PARA.SeekMod">
            <Case value="0"><!--按第三方键值查询流水信息 -->
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="ThdQryJnl"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478611</Set><!--查询无此流水-->
                  <Set>~RetCod=-1</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Case value="1"><!--按前置流水号查询流水信息 -->
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="FrtQryJnl"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478611</Set><!--查询无此流水-->
                  <Set>~RetCod=-1</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Case value="2"><!--个性化查询流水信息 -->
               <Call function="@PARA.IddFunc_Seek"/>
               <If condition="OR(INTCMP(~RetCod,4,0),IS_NOEQUAL_STRING($RspCod,000000))">
                  <Set>RspCod=478611</Set><!--查询无此流水-->
                  <Set>~RetCod=-1</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set><!--系统参数错误 -->
               <Set>RspMsg=流水查询模式 </Set>
               <Set>~RetCod=-1</Set>
               <Break/>
            </Default>
         </Switch>
         <Set>TTxnCd=$TxnCod</Set>
         <Set>HTxnCd=@PARA.HTxnCd_DSCal</Set>
         <Set>TIATyp=C</Set>
         <Set>OTxnSts=$TxnSts</Set>
         <Set>OHTxnSt=$HTxnSt</Set>
         <!--Exec func="PUB:GetBranchInf"/-->
         <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
            <Arg name="HTxnCd" value="@PARA.HTxnCd_Cancel"/>
            <Arg name="ObjSvr" value="@PARA.CBHost"/>
         </Exec>
         <Switch expression="~RetCod">
            <Case value="0"><!--抹帐成功时 -->
               <Set>HTxnSt=C</Set>
               <Set>TxnSts=C</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="SetSts"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="3">
               <Set>inHRspCd=STRCAT(|,$HRspCd,|)</Set>
               <If condition="INTCMP(GETSTRPOS(@PARA.HstNoJnl,$inHRspCd),5,0)">
                  <Set>HTxnSt=C</Set>
                  <Set>TxnSts=C</Set>
               </If>
               <Else>
                  <Set>TxnSts=$OTxnSts</Set>
                  <Set>HTxnSt=$OHTxnSt</Set>
               </Else>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="SetSts"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Set>TxnSts=$OTxnSts</Set>
               <Set>HTxnSt=$OHTxnSt</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="SetSts"/>
               </Exec>
               <Exec func="PUB:SetNoResponse"/>
               <Break/>
            </Default>
         </Switch>
      </Process>
   </Function>

     <Function name="AFE_EleCancel" desc="电力抹账及冲正(第三方发起)">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="ThdQryJnl"><!--按第三方键值查询流水信息 -->
         <Sentence>
            SELECT HTxnCd,TTxnCd,HTxnSt,LogNo,TckNo,HLogNo FROM afetxnjnl  WHERE ThdKey='%s' AND HTxnSt in ('S','T','U')
         </Sentence>
         <Fields>@PARA.ThdKey|</Fields>
      </DynSentence>
      <DynSentence name="FrtQryJnl"><!--按前置流水号查询流水信息 -->
         <Sentence>
            SELECT HTxnCd,TTxnCd,HTxnSt,TLogNo,TckNo,HLogNo FROM afetxnjnl WHERE LogNo='%s' AND HTxnSt in ('S','T','U')
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="SetSts">
         <Sentence>
            UPDATE afetxnjnl SET (TxnSts,HTxnSt)=('%s','%s') WHERE LogNo='%s'
         </Sentence>
         <Fields>TxnSts|HTxnSt|LogNo|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Switch expression="@PARA.SeekMod">
            <Case value="0"><!--按第三方键值查询流水信息 -->
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="ThdQryJnl"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478611</Set><!--查询无此流水-->
                  <Set>~RetCod=-1</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Case value="1"><!--按前置流水号查询流水信息 -->
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="FrtQryJnl"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478611</Set><!--查询无此流水-->
                  <Set>~RetCod=-1</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Case value="2"><!--个性化查询流水信息 -->
               <Call function="@PARA.IddFunc_Seek"/>
               <If condition="OR(INTCMP(~RetCod,4,0),IS_NOEQUAL_STRING($RspCod,000000))">
                  <Set>RspCod=478611</Set><!--查询无此流水-->
                  <Set>~RetCod=-1</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set><!--系统参数错误 -->
               <Set>RspMsg=流水查询模式 </Set>
               <Set>~RetCod=-1</Set>
               <Break/>
            </Default>
         </Switch>
         <Set>TTxnCd=$TxnCod</Set>
         <Set>HTxnCd=@PARA.HTxnCd_DSCal</Set>
         <Set>TIATyp=C</Set>
         <Set>OTxnSts=$TxnSts</Set>
         <Set>OHTxnSt=$HTxnSt</Set>
         <If condition="$HTxnCd=471140">
            <Set>HTxnCd=471149</Set>
         </If>
         <If condition="$HTxnCd=451610">
            <Set>HTxnCd=451619</Set>
         </If>
         <!--Exec func="PUB:GetBranchInf"/-->
         <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
            <Arg name="HTxnCd" value="@PARA.HTxnCd_Cancel"/>
            <Arg name="ObjSvr" value="@PARA.CBHost"/>
         </Exec>
         <Switch expression="~RetCod">
            <Case value="0"><!--抹帐成功时 -->
               <Set>HTxnSt=C</Set>
               <Set>TxnSts=C</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="SetSts"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="3">
               <Set>inHRspCd=STRCAT(|,$HRspCd,|)</Set>
               <If condition="INTCMP(GETSTRPOS(@PARA.HstNoJnl,$inHRspCd),5,0)">
                  <Set>HTxnSt=C</Set>
                  <Set>TxnSts=C</Set>
               </If>
               <Else>
                  <Set>TxnSts=$OTxnSts</Set>
                  <Set>HTxnSt=$OHTxnSt</Set>
               </Else>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="SetSts"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Set>TxnSts=$OTxnSts</Set>
               <Set>HTxnSt=$OHTxnSt</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="SetSts"/>
               </Exec>
               <Exec func="PUB:SetNoResponse"/>
               <Break/>
            </Default>
         </Switch>
      </Process>
   </Function>

   <Function name="AFE_InvoicePrint" desc="发票打印">
      <Quote name="Def_TxnChk"/>
      <Process>
         <Quote name="Do_TxnChk"/>
         <!--组织发票信息-->
         <Switch expression="@PARA.QryMod">
            <Case value="0"/><!--第三方交易-->
            <Case value="1"><!--第三方交易后FTP取文件-->
               <Exec func="PUB:CallThirdOther" error="IGNORE"><!-- 调用第三方交易-->
                  <Arg name="HTxnCd" value="@PARA.TTxnCd"/>
                  <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
               </Exec>
               <!--Set>RetCod=-1</Set-->
               <Switch expression="$RetCod"><!--~RetCod -->
                  <Case value="-1"><!--查询第三方超时 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=交易超时</Set>
                     <Break/>
                  </Case>
                  <Case value="-10"><!--查询第三方时未发送成功，请重发交易 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=查询第三方时未发送成功，请重发交易</Set>
                     <Break/>
                  </Case>
                  <Case value="-2"><!--查询第三方时系统错误 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=系统错误</Set>
                     <Break/>
                  </Case>
                  <Default><!--交易有返回时处理-->
                     <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                     <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                        <Set>RspCod=478606</Set><!--交易不成功-->
                        <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
                        <Return/>
                     </If>
                     <Else>
                        <Set>RspCod=000000</Set>
                     </Else>
                     <Break/>
                  </Default>
               </Switch>
               <If condition="INTCMP(@PARA.QryMod,3,1)">
                  <Exec func="PUB:FtpGet">
                     <Arg name="FtpCfg" value="@PARA.FtpId_Qry"/>
                  </Exec>
               </If>
               <Break/>
            </Case>
            <Case value="2"><!--个性处理-->
               <Call function="@PARA.IddFunc_QryInv"/>
               <If condition="OR(INTCMP(~RetCod,4,0),IS_NOEQUAL_STRING($RspCod,000000))">
                  <Set>RspCod=478614</Set><!--应用错误-->
                  <Set>RspMsg=个性化组织发票信息失败 </Set>
                  <Set>~RetCod=-1</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set><!--系统参数错误 -->
               <Set>RspMsg=查询发票模式 </Set>
               <Set>~RetCod=-1</Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>

         <!--回传发票数据-->
         <Switch expression="@PARA.PrtMod">
            <Case value="0"><!--前端流水打印机-->
               <Exec func="PUB:SendFileMessage"><!--发出文件打印指令-->
                  <Arg name="MsgTyp" value="3"/><!-- 消息类型1通知2广播3文件4打印一般传文件时用3，需要在前置打印时用4-->
                  <Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
                  <Arg name="BusTyp" value="SUBSTR($TxnCod,1,2)"/><!--业务类型-->
                  <Arg name="AplCod" value="SUBSTR($TxnCod,3,4)"/><!-- 应用码-->
                  <Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
                  <Arg name="Summary" value="对账明细"/><!-- 消息内容-->
                  <Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
                  <Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
                  <Arg name="SrcTlr" value="$TlrId"/><!-- 消息来源柜员-->
               </Exec>
               <Break/>
            </Case>
            <Case value="1"><!--前端文件-->
               <Exec func="PUB:SendFileMessage2"><!--发出文件指令-->
                  <Arg name="MsgTyp" value="3"/><!--3不打印 4打印-->
                  <Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
                  <Arg name="BusTyp" value="SUBSTR($TxnCod,1,2)"/><!--业务类型-->
                  <Arg name="AplCod" value="SUBSTR($TxnCod,3,4)"/><!-- 应用码-->
                  <Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
                  <Arg name="Summary" value="对账明细"/><!-- 消息内容-->
                  <Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
               </Exec>
               <Break/>
            </Case>
            <Case value="2"><!--Ftp发文件-->
               <Exec func="PUB:FtpPut">
                  <Arg name="FtpId" value="@PARA.FtpId_Snd"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="3"><!--HiFtp发文件-->
               <Exec func="PUB:HiFtpPut">
                  <Arg name="FtpId" value="@PARA.FtpId_Snd"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="4"><!--不处理-->
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set><!--系统参数错误 -->
               <Set>RspMsg=发票打印模式 </Set>
               <Set>~RetCod=-1</Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>
      </Process>
   </Function>

   <Function name="AFE_ChkSum" desc="对总帐">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="QryJnl"><!--检查业务流水-->
         <Sentence>
            SELECT count(*) as ASumCnt,coalesce(sum(cast(TxnAmt as BIGINT)),0)
            as ASumAmt FROM  afetxnjnl  WHERE  %s
         </Sentence>
         <Fields>@PARA.QryCnd|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Switch expression="@PARA.ChkMod">
            <Case value="0"/><!--不去第三方-->
            <Case value="1"/><!--银行发总数给第三方-->
            <Case value="2"><!--第三方发总数给银行-->
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set>
               <Set>RspMsg=对账模式参数错 </Set>
               <Set>~RetCod=-1</Set>
               <Return/>
            </Default>
         </Switch>

         <Exec func="PUB:ReadRecord" >
            <Arg name="SqlCmd" value="QryJnl"/>
         </Exec>
         <Set>SumOk=0</Set><!--总账对平标志:0已对平 1笔数不平 2金额不平 3都不平-->
         <If condition="OR(INTCMP(@PARA.ChkMod,3,1),INTCMP(@PARA.ChkMod,3,2))"> <!--银行发总数给第三方,第三方对-->
            <!-- 调用第三方交易-->
            <Exec func="PUB:CallThirdOther" error="IGNORE">
               <Arg name="HTxnCd" value="@PARA.TTxnCd"/>
               <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
            </Exec>
            <If condition="INTCMP(~RetCod,1,0)">
               <Set>RspCod=478612</Set>
               <Set>RspMsg=调用第三方时:系统错误或超时或未发送,请检查后重做 </Set>
               <Set>~RetCod=-1</Set>
            </If>
            <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
            <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
               <Set>RspCod=478612</Set><!--对账不成功-->
               <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
               <Set>~RetCod=-1</Set>
               <Return/>
            </If>
            <Else>
               <Set>RspCod=000000</Set>
            </Else>
            <If condition="@PARA.ChkMod=1">
               <Return/>
            </If>
         </If>

         <Set>RspMsg= </Set>
         <If condition="@PARA.ChkCnt=1"> <!--对总笔数-->
            <If condition="INTCMP($ASumCnt,4,$SumCnt)"> <!--对总笔数-->
               <Set>RspMsg=总笔数</Set>
               <Set>SumOk=1</Set>
            </If>
         </If>
         <If condition="@PARA.ChkAmt=1"> <!--对总金额-->
            <If condition="IS_EQUAL_DOUBLE($ASumAmt,$SumAmt)!=1"> <!--对总金额-->
               <Set>RspMsg=STRCAT($RspMsg,|总金额)</Set>
               <Set>SumOk=ADD(SumOk,2)</Set>
            </If>
         </If>
         <If condition="INTCMP($SumOk,4,0)">
            <Set>RspCod=478612</Set>
            <Set>~RetCod=-1</Set>
            <Return/>
         </If>
      </Process>
   </Function>
   <Function name="AFE_ChkDtl_A" desc="对明细模式一,仅产生明细文件">
      <Quote name="Def_TxnChk"/>
      <!--需要支持多个文件，FMT与RPT共存-->
      <DynSentence name="QryJnl"><!--查询不带扩展表业务流水-->
         <Sentence>
            SELECT *  FROM  afetxnjnl  WHERE %s
         </Sentence>
         <Fields>QryCnd|</Fields>
      </DynSentence>
      <DynSentence name="QryJnlExt"><!--查询带扩展表流水-->
         <Sentence>
            %s
         </Sentence>
         <Fields>QryCnd|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <If condition="INTCMP(@PARA.GathFmt,3,1)"><!--需要按FMT生成文件-->
            <Set>QryCnd=@PARA.QryCnd</Set>
            <Set>FmtCnt=STRGETCOUNT(@PARA.FmtLst,|)</Set>
            <While condition="INTCMP($FmtCnt,6,0)">
               <Set>FmtNam=GETWORDDELIMITER(@PARA.FmtLst,|,$FmtCnt)</Set>
               <Set>LclFil=GETWORDDELIMITER(@PARA.FmtSFilLst,|,$FmtCnt)</Set>
               <Set>ObjFil=GETWORDDELIMITER(@PARA.FmtOFilLst,|,$FmtCnt)</Set>
               <Set>FilNam=STRCAT(@PARA.FilDir,$LclFil)</Set>
               <If condition="@PARA.ExtFlg=1"><!--带扩展表-->
                  <Exec func="PUB:ExportFromDB"><!--生成清单拷盘文件-->
                     <Arg name="FormatName" value="$FmtNam"/>
                     <Arg name="FileName" value="$FilNam"/>
                     <Arg name="TableName" value="afetxnjnl"/>
                     <Arg name="SqlName" value="QryJnlExt"/>
                  </Exec>
               </If>
               <Else><!--不带扩展表-->
                  <Exec func="PUB:ExportFromDB"><!--生成清单拷盘文件-->
                     <Arg name="FormatName" value="$FmtNam"/>
                     <Arg name="FileName" value="$FilNam"/>
                     <Arg name="TableName" value="afetxnjnl"/>
                     <Arg name="SqlName" value="QryJnl"/>
                  </Exec>
               </Else>
               <Set>FmtCnt=SUB($FmtCnt,1)</Set>
               <Switch expression="@PARA.SndMod">
                  <Case value="0"> <!--Ftp发出-->
                     <Set>FtpId=@PARA.FtpId</Set>
                     <Exec func="PUB:FtpPut" error="IGNORE">
                        <Arg name="FtpId" value="@PARA.FtpId"/>
                     </Exec>
                     <If condition="~RetCod!=0">
                        <Set>RspCod=478617</Set>
                        <Set>RspMsg=对账文件</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="1"> <!--HiFtp发出-->
                     <Exec func="PUB:HiFtpPut" error="IGNORE">
                        <Arg name="FtpId" value="@PARA.FtpId"/>
                     </Exec>
                     <If condition="~RetCod!=0">
                        <Set>RspCod=478617</Set>
                        <Set>RspMsg=对账文件</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="2"> <!--放在本地-->
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478600</Set>
                     <Set>RspMsg=对账文件发送模式</Set>
                     <Return/>
                  </Default>
               </Switch>
            </While>
         </If>
         <If condition="INTCMP(@PARA.GathRpt,3,1)"><!--需要按RPT生成文件-->
            <Set>FMTCnt=STRGETCOUNT(@PARA.RptLst,|)</Set>
            <While condition="INTCMP($FmtCnt,6,0)">
               <Set>FmtNam=GETWORDDELIMITER(@PARA.RptLst,|,$FmtCnt)</Set>
               <Set>LclFil=GETWORDDELIMITER(@PARA.RptSFilLst,|,$FmtCnt)</Set>
               <Set>ObjFil=GETWORDDELIMITER(@PARA.RptOFilLst,|,$FmtCnt)</Set>
               <Set>FilNam=STRCAT(@PARA.RptDir,$LclFil)</Set>
               <Set>RptDat=@PARA.RptDat</Set>
               <Exec func="PUB:GenerateReport" error="IGNORE">
                  <Arg name="ObjFil"  value="$FilNam"/>
                  <Arg name="FmtFil"  value="$FmtNam"/>
                  <Arg name="CAgtNo"  value="$CAgtNo"/>
                  <Arg name="RptDat"  value="$RptDat"/>
                  <Arg name="TlrId"   value="$TlrId"/>
               </Exec>
               <If condition="INTCMP(~RetCod,3,-100)">
                  <Set>RspCod=000000</Set>
               </If>
               <Set>FmtCnt=SUB($FmtCnt,1)</Set>
               <Switch expression="@PARA.RptSndMod">
                  <Case value="0"> <!--Ftp发出-->
                     <Exec func="PUB:FtpPut" error="IGNORE">
                        <Arg name="FtpId" value="@PARA.RptFtpId"/>
                     </Exec>
                     <If condition="~RetCod!=0">
                        <Set>RspCod=478617</Set>
                        <Set>RspMsg=对账清单</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="1"> <!--HiFtp发出-->
                     <Exec func="PUB:HiFtpPut" error="IGNORE">
                        <Arg name="FtpId" value="@PARA.RptFtpId"/>
                     </Exec>
                     <If condition="~RetCod!=0">
                        <Set>RspCod=478617</Set>
                        <Set>RspMsg=对账清单</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="2"> <!--放在本地-->
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478600</Set>
                     <Set>RspMsg=对账清单发送模式</Set>
                     <Return/>
                  </Default>
               </Switch>
            </While>
         </If>
         <If condition="INTCMP(@PARA.NeedNotice,3,1)"><!--需要通知第三方-->
            <!-- 调用第三方交易-->
            <Exec func="PUB:CallThirdOther" error="IGNORE">
               <Arg name="HTxnCd" value="@PARA.NoticeCod"/>
               <Arg name="ObjSvr" value="@PARA.NoticeSvr"/>
            </Exec>
            <If condition="INTCMP(~RetCod,1,0)">
               <Set>RspCod=478615</Set>
               <Set>RspMsg=调用第三方时:系统错误或超时或未发送,请检查后重做 </Set>
               <Return/>
            </If>
            <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
            <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
               <Set>RspCod=478615</Set><!--对账不成功-->
               <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
               <Return/>
            </If>
            <Else>
               <Set>RspCod=000000</Set>
            </Else>
         </If>
         <Return/>
      </Process>
   </Function>

   <Function name="AFE_ChkDtl_C" desc="对明细模式三,以银行明细为主逐笔明细外发核对">
      <DynSentence name="QryJnl"><!--检查业务流水-->
         <Sentence>
            SELECT *  FROM  afetxnjnl  WHERE %s
         </Sentence>
         <Fields>@PARA.QryCnd|</Fields>
      </DynSentence>
      <Quote name="Def_TxnChk"/>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Set>LckKey=STRCAT(chkdtl:,afetxnjnl,:,$CAgtNo)</Set>
         <Exec func="PUB:Lock" error="IGNORE"><!-- 通过加锁控制批次状态 -->
            <Arg name="RecKey" value="$LckKey"/>
            <Arg name="TimOut" value="1800"/>
            <Arg name="AutoUnlock" value="yes"/>
         </Exec>
         <If condition="INTCMP(~RetCod,4,0)"><!--已被加锁-->
            <Set>RspCod=478004</Set>
            <Return/>
         </If>
         <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
            <Arg name="SqlCmd" value="QryJnl"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=取明细记录时数据库操作错误</Set>
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=该单位没有流水记录</Set>
            <Return/>
         </ElseIf>
         <Set>ErrFlg=0</Set>
         <Set>SndCnt=0</Set>
         <Set>ChkNod=$NodNo</Set>
         <Set>ChkTlr=$TlrId</Set>
         <Set>MsgTyp=E</Set>
         <Set>RspCod=478399</Set>
         <Set>RspMsg=开始向第三方逐笔发送对账明细，请退出并等待对明细结束消息!</Set>
         <Exec func="PUB:PutResponse"/><!--返回查询结果信息-->
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=478699</Set>
               <Set>RspMsg=取明细记录时数据库操作错误</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Switch expression="@PARA.ChkMod">
               <Case value="0"> <!--仅调用第三方交易-->
                  <Delete>TRspCd</Delete>
                  <Exec func="PUB:CallThirdOther" error="IGNORE">
                     <Arg name="TTxnCd" value="@PARA.TTxnCd"/>
                     <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
                  </Exec>
                  <If condition="INTCMP(~RetCod,4,0)">
                     <Set>ErrFlg=ADD($ErrFlg,1)</Set>
                     <Break/>
                  </If>
                  <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                  <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                     <Set>ErrFlg=ADD($ErrFlg,1)</Set>
                  </If>
                  <Break/>
               </Case>
               <Case value="1">
                  <Call function="@PARA.IddFunc"/>
                  <If condition="IS_NOEQUAL_STRING($RspCod,000000)">
                     <Set>ErrFlg=ADD($ErrFlg,1)</Set>
                  </If>
                  <Break/>
               </Case>
               <Default>
                  <Set>RspCod=478600</Set>
                  <Set>RspMsg=对账模式参数错误</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </Default>
            </Switch>
            <Set>SndCnt=ADD($SndCnt,1)</Set>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <If condition="INTCMP($ErrFlg,6,0)">
            <Set>ChkMsg=STRCAT(发送明细总笔数：,$SndCnt, 第三方未回应或错误笔数：,$ErrFlg)</Set>
         </If>
         <Exec func="PUB:Notify"><!--发送消息给对明细上送柜员-->
            <Arg name="BusTyp"  value="AG"/><!-- 业务类型-->
            <Arg name="AplCod"  value="$TxnCod"/><!-- 应用码-->
            <Arg name="Summary" value="对账明细发送结果通知"/><!-- 消息摘要-->
            <Arg name="MsgData" value="STRCAT($BusTyp,:,$TxnCod,:对账明细记录发送完毕，请核对!,$ChkMsg)"/><!-- 消息内容-->
            <Arg name="ObjNod"  value="$ChkNod"/><!-- 目的机构-->
            <Arg name="ObjTlr"  value="$ChkTlr"/><!-- 目的柜员-->
            <Arg name="SrcOrg"  value="$ChkNod"/><!-- 操作机构号-->
            <Arg name="SrcTlr"  value="$ChkTlr"/><!-- 操作柜员号-->
         </Exec>
      </Process>
   </Function>

   <Function name="AFE_ChkRslPro" desc="第三方对账结果文件处理">
      <Quote name="Def_TxnChk"/>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Set>FilCnt=STRGETCOUNT(@PARA.FmtOFilLst,|)</Set>
         <Switch expression="@PARA.RcvMod">
            <Case value="0">
               <While condition="INTCMP($FilCnt,6,0)">
                  <Set>LclFil=GETWORDDELIMITER(@PARA.FmtRFilLst,|,$FilCnt)</Set>
                  <Set>ObjFil=GETWORDDELIMITER(@PARA.FmtOFilLst,|,$FilCnt)</Set>
                  <Set>FilNam=STRCAT(@PARA.FilDir,$LclFil)</Set>
                  <Set>FilCnt=SUB($FilCnt,1)</Set>
                  <Exec func="PUB:FtpGet" error="IGNORE"><!--从第三方系统获取文件-->
                     <Arg name="FtpId"     value="@PARA.FtpId"/>
                  </Exec>
                  <If condition="~RetCod!=0">
                     <Set>RspCod=478616</Set>
                     <Set>RspMsg=对账结果文件</Set>
                     <Return/>
                  </If>
               </While>
               <Break/>
            </Case>
            <Case value="1">
               <While condition="INTCMP($FilCnt,6,0)">
                  <Set>LclFil=GETWORDDELIMITER(@PARA.FmtRFilLst,|,$FilCnt)</Set>
                  <Set>ObjFil=GETWORDDELIMITER(@PARA.FmtOFilLst,|,$FilCnt)</Set>
                  <Set>FilNam=STRCAT(@PARA.FilDir,$LclFil)</Set>
                  <Set>FilCnt=SUB($FilCnt,1)</Set>
                  <Exec func="PUB:HiFtpGet" error="IGNORE">
                     <Arg name="FtpId"     value="@PARA.FtpId"/>
                  </Exec>
                  <If condition="~RetCod!=0">
                     <Set>RspCod=478616</Set>
                     <Set>RspMsg=对账结果文件</Set>
                  </If>
               </While>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set>
               <Set>RspMsg=接收对账结果文件模式</Set><!--返回系统参数不正确-->
               <Return/>
            </Default>
         </Switch>
         <Set>FilCnt=STRGETCOUNT(@PARA.FmtOFilLst,|)</Set>
         <Switch expression="@PARA.ProMod">
            <Case value="0"><!--文件入库-->
               <While condition="INTCMP($FilCnt,6,0)">
                  <Set>LclFil=GETWORDDELIMITER(@PARA.FmtRFilLst,|,$FilCnt)</Set>
                  <Set>ObjFil=GETWORDDELIMITER(@PARA.FmtOFilLst,|,$FilCnt)</Set>
                  <Set>FmtNam=GETWORDDELIMITER(@PARA.FmtLst,|,$FmtCnt)</Set>
                  <Set>FilNam=STRCAT(@PARA.LclDir,$LclFil)</Set>
                  <Set>FiltCnt=SUB($FilCnt,1)</Set>
                  <Exec func="PUB:ImportToDB">
                     <!--将文件拆分入批量明细表-->
                     <Arg name="Formatname" value="$FmtNam"/>
                     <Arg name="Filename"   value="$FilNam"/>
                     <Arg name="Tablename"  value="@PARA.ChkDtlTbl"/>
                     <Arg name="ApplyLogNoFlag" value="0"/>
                  </Exec>
               </While>
               <Break/>
            </Case>
            <Case value="1"> <!--放置到另外的地方-->
               <Switch expression="@PARA.SndMod">
                  <Case value="0"> <!--Ftp发出-->
                     <While condition="INTCMP($FilCnt,6,0)">
                        <Set>LclFil=GETWORDDELIMITER(@PARA.RslSFilLst,|,$FilCnt)</Set>
                        <Set>ObjFil=GETWORDDELIMITER(@PARA.RslOFilLst,|,$FilCnt)</Set>
                        <Set>FilNam=STRCAT(@PARA.LclDir,$LclFil)</Set>
                        <Set>FilCnt=SUB($FilCnt,1)</Set>
                        <Exec func="PUB:FtpPut" error="IGNORE">
                           <Arg name="FtpId" value="@PARA.SndFtpId"/>
                        </Exec>
                        <If condition="~RetCod!=0">
                           <Set>RspCod=478617</Set>
                           <Set>RspMsg=对账结果文件</Set>
                           <Return/>
                        </If>
                     </While>
                     <Break/>
                  </Case>
                  <Case value="1"> <!--HiFtp发出-->
                     <While condition="INTCMP($FilCnt,6,0)">
                        <Set>LclFil=GETWORDDELIMITER(@PARA.RslSFilLst,|,$FilCnt)</Set>
                        <Set>ObjFil=GETWORDDELIMITER(@PARA.RslOFilLst,|,$FilCnt)</Set>
                        <Set>FilNam=STRCAT(@PARA.LclDir,$LclFil)</Set>
                        <Set>FilCnt=SUB($FilCnt,1)</Set>
                        <Exec func="PUB:HiFtpPut" error="IGNORE">
                           <Arg name="FtpId" value="@PARA.SndFtpId"/>
                        </Exec>
                        <If condition="~RetCod!=0">
                           <Set>RspCod=478617</Set>
                           <Set>RspMsg=对账结果文件</Set>
                           <Return/>
                        </If>
                     </While>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478600</Set>
                     <Set>RspMsg=放置对账结果文件模式</Set>
                     <Return/>
                  </Default>
               </Switch>
               <Break/>
            </Case>
            <Case value="2"> <!--不做处理-->
               <Break/>
            </Case>
            <Default><!--返回系统参数不正确-->
               <Return/>
            </Default>
         </Switch>
      </Process>
   </Function>

   <Function name="AFE_LoadFil" desc="待收费用数据装入">
      <Quote name="Def_TxnChk"/>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Switch expression="@PARA.RcvMod">
            <Case value="0">
               <!--Ftp得到-->
               <Exec func="PUB:FtpGet">
                  <Arg name="FtpId" value="@PARA.FtpId"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="1">
               <!--HiFtp得到-->
               <Exec func="PUB:HiFtpGet">
                  <Arg name="FtpId" value="@PARA.FtpId"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="2">
               <!--放在本地-->
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set>
               <Set>RspMsg=文件获取模式 </Set>
               <Set>~RetCod=-1</Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>
         <!--文件入库-->
         <Set>File=STRCAT($LclDir,$FilNam)</Set>
         <Exec func="PUB:ImportToDB">
            <!--将文件拆分入批量明细表-->
            <Arg name="FormatName" value="@PARA.FmtNam"/>
            <Arg name="FileName" value="$File"/>
            <Arg name="TableName" value="afefeedat"/>
            <Arg name="ApplyLogNoFlag" value="0"/>
         </Exec>
      </Process>
   </Function>

   <Function name="AFE_QryPAgr" desc="个人协议查询（单笔）">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="QryDetail">
         <!--个人协议详情查询-->
         <Sentence>
            SELECT * FROM savcusagt WHERE PAgtNo='%s' AND Status='0'
         </Sentence>
         <Fields>PAgtNo|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Exec func="PUB:ReadRecordExt">
            <Arg name="SqlCmd" value="QryDetail"/>
         </Exec>
      </Process>
   </Function>

   <Function name="AFE_QryPAgrLst" desc="个人协议查询（多笔）">
      <DynSentence name="QryAgrLst">
         <!--个人协议详情查询-->
         <Sentence>
            (CAgtNo='%s' or '%s'='') AND (TCusID='%s' or '%s'='') AND (ActNo='%s' or '%s'='') AND Status='0'
         </Sentence>
         <Fields>CAgtNo|CAgtNo|TCusID|TCusID|ActNo|ActNo|</Fields>
      </DynSentence>
      <Process>
         <Exec func="PUB:QueryExt">
            <Arg name="CntSts" value="QryAgrLst"/>
            <Arg name="TblNam" value="savcusagt"/>
         </Exec>
      </Process>
   </Function>

   <Function name="AFE_CrpSign" desc="单位签到/签退">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="UpdSgnSts">
         <!--签到-->
         <Sentence>
            UPDATE savthdinf SET Status='%s', StsDat='%s' WHERE CAgtNo='%s'
         </Sentence>
         <Fields>Status|ActDat|CAgtNo|</Fields>
      </DynSentence>
      <Process>
         <If condition="@PARA.SignMod=1">  <!--要去第三方签到-->
            <Exec func="PUB:CallThirdOther" error="IGNORE">
               <Arg name="TTxnCd" value="@PARA.TTxnCd"/>
               <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
            </Exec>
            <If condition="INTCMP(~RetCod,1,0)">
               <Set>RspCod=478606</Set>
               <Set>RspMsg=第三方交易失败</Set>
               <Set>~RetCod=-1</Set>
               <Return/>
            </If>
            <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
            <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
               <Set>RspCod=478606</Set>
               <Set>RspMsg=STRCAT(第三方返回:,$TRspCd)</Set>
               <Set>~RetCod=-1</Set>
               <Return/>
            </If>
         </If>
         <!--本地签到-->
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdSgnSts"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=478699</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         <If condition="~RetCod=-2">
            <If condition="$Status=1">
               <Set>RspCod=000000</Set>
               <!--Set>BrNo=@BCFG.BrNo</Set-->
               <Set>StsDat=$ActDat</Set>
               <Set>Status=1</Set>
               <Exec func="PUB:InsertRecord">
                  <Arg name="TblNam" value="savthdinf"/>
               </Exec>
            </If>
            <Else>
               <Set>RspCod=478615</Set>
               <Set>RspMsg=无此单位签到控制信息</Set>
               <Set>~RetCod=-1</Set>
               <Return/>
            </Else>
         </If>
      </Process>
   </Function>

   <Function name="AFE_QryJnlLst" desc="柜员当日流水查询(模糊列表)">
      <Quote name="Def_TxnChk"/><!--流水列表查询-->
      <DynSentence name="QryJnlLst">
         <Sentence>
            (TckNo='%s' OR '%s'='           ')
            AND (LogNo='%s' OR '%s'='               ')
            AND (FeCod='%s' OR '%s'='      ')
            AND (CAgtNo='%s' OR '%s'='          ')
            AND (TCusID='%s' OR '%s'='                    ')
            AND (TxnAmt='%s' OR '%s'='000000000000000')
            AND TlrId='%s' AND ActDat='%s'
         </Sentence>
         <Fields>OTckNo|OTckNo|OLogNo|OLogNo|PTxnCd|PTxnCd|CAgtNo|CAgtNo|TCusID|TCusID|TxnAmt|TxnAmt|TlrId|ActDat|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnJnl"><!--流水查询 -->
         <Sentence>
            LogNo='%s'
         </Sentence>
         <Fields>$OLogNo|</Fields>
      </DynSentence>

      <Process>
         <Exec func="PUB:QueryExt" error="IGNORE">
            <Arg name="CndSts" value="QryJnlLst"/>
            <Arg name="TblNam" value="afetxnjnl"/>
         </Exec>

         <If condition="INTCMP(STRLEN(DELBOTHSPACE($OTckNo)),6,1)">
            <If condition="~RetCod=-1">
               <!--先去主机查询到前置流水号-->
               <Exec func="PUB:CallHostOther">
                  <Arg name="HTxnCd" value="@PARA.HTxnCd_SeekJnl"/>
                  <Arg name="ObjSvr" value="@PARA.CBHost"/>
               </Exec>
               <If condition="$MsgTyp!=N">
                  <Set>RspCod=360001</Set>
                  <Set>RspMsg=STRCAT(查询主机会计流水出错，主机错误码：,$HRspCd)</Set>
               </If>
               <Set>LogNo=$OLogNo</Set>
               <Exec func="PUB:ReadRecordExt">
                  <Arg name="TblNam" value="afetxnjnl"/>
                  <Arg name="CndSts" value="QryTxnJnl"/>
               </Exec>
            </If>
         </If>
      </Process>
   </Function>

   <Function name="AFE_QryTxnJnl" desc="流水查询(按会计流水号查)">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="QryJnl">
         <Sentence>
            TckNo='%s'
         </Sentence>
         <Fields>$OTckNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnJnl"><!--流水查询(按会计流水号查) -->
         <Sentence>
            LogNo='%s'
         </Sentence>
         <Fields>$LogNo|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Exec func="PUB:ReadRecordExt" error="IGNORE">
            <Arg name="CndSts" value="QryJnl"/>
            <Arg name="TblNam" value="afetxnjnl"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=查询流水时系统错误</Set>
            <Return/>
         </If>
         <If condition="~RetCod=-2">
            <!--先去主机查询到前置流水号-->
            <Exec func="PUB:CallHostOther">
               <Arg name="HTxnCd" value="@PARA.HTxnCd_SeekJnl"/>
               <Arg name="ObjSvr" value="@PARA.CBHost"/>
            </Exec>
            <Exec func="PUB:ReadRecordExt">
               <Arg name="TblNam" value="afetxnjnl"/>
               <Arg name="CndSts" value="QryTxnJnl"/>
            </Exec>
            <Return/>
         </If>
      </Process>
   </Function>

   <Function name="AFE_QryDtlAmt" desc="待缴费明细查询">  <!--基本测完，本地查询有遗留问题-->
      <Quote name="Def_TxnChk"/>
      <DynSentence name="QryDtlAmt"><!--查询待缴费用明细 -->
         <Sentence>
            %s
         </Sentence>
         <Fields>@PARA.QryDtlCnd|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Switch expression="@PARA.TxnMod">
            <Case value="0"><!--查询本地费用表 -->
               <Exec func="PUB:QueryExt">
                  <Arg name="CndSts" value="QryDtlAmt"/>
                  <Arg name="TblNam" value="@PARA.DtlAmtTbl"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="1"><!--仅查询第三方 -->
               <Exec func="PUB:CallThirdOther" error="IGNORE"><!-- 调用第三方交易-->
                  <Arg name="HTxnCd" value="@PARA.TTxnCd"/>
                  <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
               </Exec>
               <Switch expression="~RetCod">
                  <Case value="-1"><!--查询第三方超时 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=交易超时</Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Case value="-10"><!--查询第三方时未发送成功，请重发交易 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=交易发送失败</Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Case value="-2"><!--查询第三方时系统错误 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=系统错误</Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Default><!--查询有返回-->
                     <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                     <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                        <Set>TTxnSt=F</Set>
                        <Set>TxnSts=F</Set>
                        <Set>RspCod=478606</Set><!--第三方交易失败-->
                        <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
                        <Set>~RetCod=-1</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Default>
               </Switch>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set>
               <Set>RspMsg=查询模式 </Set>
               <Set>~RetCod=-1</Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>
      </Process>
   </Function>

   <Function name="AFE_SglQryPay" desc="单笔缴费(含查询)">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="QryTxnAmt">  <!--检查本地费用表是否有待缴费用-->
         <Sentence>
            %s
         </Sentence>
         <Fields>@PARA.QryCnd|</Fields>
      </DynSentence>
      <DynSentence name="UpdFeeFlg">  <!--更新缴费标志-->
         <Sentence>
            UPDATE afefeedat
            SET Flg='1'
            %s
         </Sentence>
         <Fields>@PARA.QryCnd|</Fields>
      </DynSentence>
      <DynSentence name="UpdThdJnl"><!--更新缴费标志-->
         <Sentence>
            LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>

         <Set>OLogNo=$LogNo</Set>
         <Set>CnlFlg=0</Set>
         <Set>ActFlg=$ActTyp</Set>
         <Set>CcyTyp=1</Set>
         <Set>Mask=STRCAT(9,$BBusTyp)</Set>
         <Exec func="PUB:GetVirtualTeller">
            <Arg name="TxnCnl" value="AFE"/>
            <Arg name="CnlSub" value="$BrNo"/>
         </Exec>
         <Exec func="PUB:Lock">
            <Arg name="RecKey" value="STRCAT(afetxnjnl:LogNo:,$LogNo)"/>
            <Arg name="TimOut" value="60"/>
         </Exec>

         <Switch expression="@PARA.QryMod">
            <Case value="1">       <!--本地查询-->
               <Exec func="PUB:ReadRecordExt">
                  <Arg name="TblNam" value="afefeedat"/>
                  <Arg name="CndSts" value="QryTxnAmt"/>
               </Exec>
               <Set>TxnAmt=$TotAmt</Set>
               <Break/>
            </Case>
            <Case value="2"><!-- 调用第三方交易-->
               <Exec func="PUB:CallThirdOther" error="IGNORE">
                  <Arg name="HTxnCd" value="@PARA.TTxnCd_Qry"/>
                  <Arg name="ObjSvr" value="@PARA.ThdSvr_Qry"/>
               </Exec>
               <Switch expression="~RetCod">
                  <Case value="-1"><!--查询第三方超时 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=交易超时 </Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Case value="-10"><!--查询第三方时未发送成功，请重发交易 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=交易发送失败 </Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Case value="-2"><!--查询第三方时系统错误 -->
                     <Set>RspCod=478606</Set>
                     <Set>RspMsg=系统错误 </Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Default><!--查询有返回-->
                     <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                     <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                        <Set>TTxnSt=F</Set>
                        <Set>TxnSts=F</Set>
                        <Set>RspCod=478606</Set><!--第三方交易失败-->
                        <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
                        <Set>~RetCod=-1</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Default>
               </Switch>
               <Break/>
            </Case>
            <Case value="3">     <!--个性定制-->
               <Call function="@PARA.IddFunc_Qry"/>
               <If condition="OR(INTCMP(~RetCod,4,0),IS_NOEQUAL_STRING($RspCod,000000))">
                  <Set>RspCod=478614</Set><!--应用错误-->
                  <Set>RspMsg=STRCAT(查询待缴费用,@PARA.IddFunc_Qry)</Set>
                  <Set>~RetCod=-1</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set>
               <Set>RspMsg=查询模式 </Set>
               <Set>~RetCod=-1</Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>

         <If condition="DOUBLECMP($TxnAmt,6,000000000000000)">
            <Set>HTxnSt=U</Set>
            <Set>TTxnSt=U</Set>
            <Set>TxnSts=U</Set>

            <Set>inTxnCnl=STRCAT(|,$TxnCnl,|)</Set>
            <If condition="AND(IS_EQUAL_STRING(@PARA.RollBack,1),INTCMP(GETSTRPOS(@PARA.RollBackCnls,$inTxnCnl),5,0))">
               <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
            </If>
            <Exec func="PUB:GetLogNo"/>
            <Exec func="PUB:InsertJournal"/><!--主机单笔缴费-->
            <Exec func="PUB:CallHostAcc" error="IGNORE">
               <Arg name="HTxnCd" value="@PARA.HTxnCd_P2C"/>
               <Arg name="ObjSvr" value="@PARA.CBHost"/>
            </Exec>
            <Switch expression="~RetCod">
               <Case value="-10">
                  <Exec func="PUB:UpdateJournalHost">
                     <Arg name="TxnSts" value="X"/>
                  </Exec>
                  <Set>RspCod=478607</Set>
                  <Set>RspMsg=发送交易失败 </Set>
                  <Return/>
                  <Break/>
               </Case>
               <Case value="-2">
                  <Exec func="PUB:UpdateJournalHost">
                     <Arg name="TxnSts" value="X"/>
                  </Exec>
                  <Set>RspCod=478607</Set>
                  <Set>RspMsg=系统错误 </Set>
                  <Return/>
                  <Break/>
               </Case>
               <Case value="-1">
                  <Exec func="PUB:UpdateJournalHost">
                     <Arg name="TxnSts" value="T"/>
                  </Exec>
                  <Exec func="PUB:DefaultErrorProc"/>
                  <Set>RspCod=478607</Set>
                  <Set>RspMsg=主机交易超时 </Set>
                  <Return/>
                  <Break/>
               </Case>
               <Case value="-9">
                  <Exec func="PUB:UpdateJournalHost">
                     <Arg name="TxnSts" value="F"/>
                  </Exec>
                  <Set>RspCod=478607</Set>
                  <Set>RspMsg=交易需要授权 </Set>
                  <Return/>
                  <Break/>
               </Case>
               <Case value="3">
                  <Exec func="PUB:UpdateJournalHost">
                     <Arg name="TxnSts" value="F"/>
                  </Exec>
                  <Set>RspCod=$HRspCd</Set>
                  <Return/>
                  <Break/>
               </Case>
               <Case value="0">
                  <Exec func="PUB:UpdateJournalHost"/>
                  <Break/>
               </Case>
               <Default>
                  <Exec func="PUB:UpdateJournalHost">
                     <Arg name="TxnSts" value="F"/>
                  </Exec>
                  <Set>RspCod=478607</Set>
                  <Set>RspMsg=未知错误,请联系电脑运行中心</Set>
                  <Return/>
                  <Break/>
               </Default>
            </Switch>

            <Switch expression="@PARA.TTxnMod">
               <Case value="1">  <!--更新本地费用表-->
                  <Exec func="ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="UpdFeeFlg"/>
                  </Exec>
                  <If condition="~RetCod!=0">

                     <Exec func="PUB:UpdateJournalThird"/>
                     <Exec func="PUB:DefaultErrorProc"/>
                     <Set>RspCod=478613</Set>
                     <Set>RspMsg=更新待缴费表错 </Set>
                     <Return/>
                  </If>
                  <Break/>
               </Case>
               <Case value="2">  <!--去第三方记账--><!--发第三方记账-->
                  <Exec func="PUB:CallThirdAcc" error="IGNORE">
                     <Arg name="HTxnCd" value="@PARA.TTxnCd_Pay"/>
                     <Arg name="ObjSvr" value="@PARA.ThdSvr_Pay"/>
                  </Exec>
                  <Switch expression="~RetCod">
                     <Case value="-1"><!--第三方交易超时 -->
                        <Set>TTxnSt=T</Set>
                        <Set>TxnSts=T</Set>
                        <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                           <Arg name="TblNam" value="afetxnjnl"/>
                           <Arg name="CndSts" value="UpdThdJnl"/>
                        </Exec>
                        <If condition="INTCMP(~RetCod,4,0)">
                           <Set>RspCod=478399</Set>
                           <Set>RspMsg=更新流水表第三方信息失败</Set>
                        </If>
                        <Exec func="PUB:DefaultErrorProc"/>
                        <Set>RspCod=478606</Set>
                        <Set>RspMsg=交易超时 </Set>
                        <Return/>
                        <Break/>
                     </Case>
                     <Case value="-10"><!--第三方交易未发送成功 -->
                        <Set>TTxnSt=X</Set>
                        <Set>TxnSts=X</Set>
                        <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                           <Arg name="TblNam" value="afetxnjnl"/>
                           <Arg name="CndSts" value="UpdThdJnl"/>
                        </Exec>
                        <If condition="INTCMP(~RetCod,4,0)">
                           <Set>RspCod=478399</Set>
                           <Set>RspMsg=更新流水表第三方信息失败</Set>
                        </If>
                        <Exec func="PUB:DefaultErrorProc"/>
                        <Set>RspCod=478606</Set>
                        <Set>RspMsg=交易发送失败 </Set>
                        <Return/>
                        <Break/>
                     </Case>
                     <Case value="-2"><!--第三方交易系统错误 -->
                        <Set>TTxnSt=X</Set>
                        <Set>TxnSts=X</Set>
                        <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                           <Arg name="TblNam" value="afetxnjnl"/>
                           <Arg name="CndSts" value="UpdThdJnl"/>
                        </Exec>
                        <If condition="INTCMP(~RetCod,4,0)">
                           <Set>RspCod=478399</Set>
                           <Set>RspMsg=更新流水表第三方信息失败</Set>
                        </If>
                        <Exec func="PUB:DefaultErrorProc"/>
                        <Set>RspCod=478606</Set>
                        <Set>RspMsg=系统错误 </Set>
                        <Return/>
                        <Break/>
                     </Case>
                     <Case value="0">
                        <Set>TTxnSt=S</Set>
                        <Set>TxnSts=S</Set>
                        <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                           <Arg name="TblNam" value="afetxnjnl"/>
                           <Arg name="CndSts" value="UpdThdJnl"/>
                        </Exec>
                        <If condition="INTCMP(~RetCod,4,0)">
                           <Set>RspCod=478399</Set>
                           <Set>RspMsg=更新流水表第三方信息失败</Set>
                        </If>
                        <Break/>
                     </Case>
                     <Case value="3"><!--第三方交易失败 -->
                        <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                        <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                           <Set>TTxnSt=F</Set>
                           <Set>TxnSts=F</Set>
                           <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                              <Arg name="TblNam" value="afetxnjnl"/>
                              <Arg name="CndSts" value="UpdThdJnl"/>
                           </Exec>
                           <If condition="INTCMP(~RetCod,4,0)">
                              <Set>RspCod=478399</Set>
                              <Set>RspMsg=更新流水表第三方信息失败</Set>
                           </If>
                           <Exec func="PUB:DefaultErrorProc"/>
                           <Set>RspCod=478606</Set><!--第三方交易失败-->
                           <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
                           <Set>~RetCod=-1</Set>
                           <Return/>
                        </If>
                        <Else>
                           <Set>TTxnSt=S</Set>
                           <Set>TxnSts=S</Set>
                           <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
                              <Arg name="TblNam" value="afetxnjnl"/>
                              <Arg name="CndSts" value="UpdThdJnl"/>
                           </Exec>
                           <If condition="INTCMP(~RetCod,4,0)">
                              <Set>RspCod=478399</Set>
                              <Set>RspMsg=更新流水表第三方信息失败</Set>
                           </If>
                           <Set>~RetCod=0</Set>
                        </Else>
                        <Break/>
                     </Case>
                     <Default>
                        <Set>RspCod=478606</Set>
                        <Set>RspMsg=未知错误 </Set>
                        <Set>~RetCod=-1</Set>
                        <Return/>
                        <Break/>
                     </Default>
                  </Switch>
                  <Break/>
               </Case>
               <Case value="3">  <!--个性定制 -->
                  <Call function="@PARA.IddFunc_Pay"/>
                  <Break/>
               </Case>
               <Default>
                  <Set>RspCod=478600</Set>  <!--系统参数错误 -->
                  <Set>RspMsg=第三方交易模式 </Set>
                  <Set>~RetCod=-1</Set>
                  <Return/>
                  <Break/>
               </Default>
            </Switch>

            <Exec func="PUB:UpdateRecordExt" error="IGNORE"><!--更新第三方记账信息-->
               <Arg name="TblNam" value="afetxnjnl"/>
               <Arg name="CndSts" value="UpdThdJnl"/>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
               <Set>RspCod=478399</Set>
               <Set>RspMsg=更新流水表第三方信息失败</Set>
            </If>
         </If>
         <ElseIf condition="DOUBLECMP($TxnAmt,3,000000000000000)">
            <Set>RspCod=000000</Set>
            <Return/>
         </ElseIf>
         <Else>
            <Set>RspCod=478614</Set>  <!--系统参数错误 -->
            <Set>RspMsg=交易金额小于0 </Set>
            <Set>~RetCod=-1</Set>
            <Return/>
         </Else>

         <Set>RspCod=000000</Set>

         <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT(afetxnjnl:LogNo:,$LogNo)"/>
         </Exec>
      </Process>
   </Function>

   <Function name="AFE_MultiPAgrMng" desc="个人协议维护（多笔）">
      <Quote name="Def_TxnChk"/>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Set>RecCnt=1</Set>
         <While condition="INTCMP($RecCnt,2,$RecNum)">
            <!--取参数-->
            <Set>SepCnt=STRGETCOUNT(@PARA.FldLst,|)</Set>
            <Set>seq=1</Set>
            <While condition="INTCMP($seq,2,$SepCnt)">
               <Set>FldNam=GETWORDDELIMITER(@PARA.FldLst,|,$seq)</Set>
               <Exec func="PUB:GetValue">
                  <Arg name="Sour name" value="STRCAT(ROOT.Rec_,$RecCnt,.,$FldNam)"/>
                  <Arg name="Dest name" value="STRCAT(ROOT.,$FldNam)"/>
               </Exec>
               <Set>Seq=ADD($Seq,1)</Set>
            </While>
            <!--单笔缴费-->
            <Exec func="PUB:CallLocal" error="IGNOR">
               <!--调用单笔签约-->
               <Arg name="TxnCod" value="@PARA.SglSgn"/>
               <Arg name="ObjSvr" value="@PARA.LclSvr"/>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
               <Set>RspCod=478646</Set>
               <Set>RspMsg=调用单笔签约失败</Set>
               <Return/>
            </If>
            <Exec func="PUB:Setvalue">
               <Arg name="Fieldname" value="STRCAT(ROOT.Rec_,$RecCnt,.RecSts)"/>
               <Arg name="Fieldvalue" value="$Status"/>
            </Exec>
            <Exec func="PUB:Setvalue">
               <Arg name="Fieldname" value="STRCAT(ROOT.Rec_,$RecCnt,.RecCod)"/>
               <Arg name="Fieldvalue" value="$RspCod"/>
            </Exec>
            <Set>RecCnt=ADD($RecCnt,1)</Set>
         </While>
         <Set>RspCod=000000</Set>
         <Set>MsgTyp=N</Set>
      </Process>
   </Function>


   <Function name="AFE_AgrBat" desc="协议批扣">
      <Quote name="Def_TxnChk"/>
      <DynSentence name="GetCrpAgrInf">  <!--检查商户协议是否存在且有效-->
         <Sentence>
            SELECT ChkFlg, BBusTyp
            FROM savcrpagr
            WHERE CAgtNo='%s' AND SvrSts='1'
         </Sentence>
         <Fields>CAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="GetCusAgtInf">  <!--查询有效的客户协议 -->
         <Sentence>
            SELECT TCusID,COALESCE(TCusNm,' ') AS TCusNm,ActNo,ActSqn,ActTyp
            FROM savcusagt
            WHERE CAgtNo='%s' AND Status='0' AND SUBSTR(CnlSts,19,1)='1'
         </Sentence>
         <Fields>CAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="GetOrnCnt">  <!--查询该单位编号下有效协议的总笔数 -->
         <Sentence>
            SELECT COUNT(PAgtNo) AS OrnCnt
            FROM savcusagt
            WHERE CAgtNo='%s' AND Status='0'
            GROUP BY CAgtNo
         </Sentence>
         <Fields>CAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="InBatRec"><!--将录入明细迁移到上传明细-->
         <Sentence>
            INSERT INTO afebatrec
            (LogNo,DskNo,SeqNo,
            BusTyp,CrpCod,ActDat,CcyCod,TxnAmt,ActTyp,ActSqn,ActNo,CAgtNo,
            HTxnCd,TTxnCd,TxnObj,TCusId,TCusNm,NodNo)
            SELECT CHAR(Cast('%s' AS BIGINT)-1+rank() over (order by PAgtNo)),'%s',CHAR(Cast('%s' AS BIGINT)-1+rank() over (order by PAgtNo)),BusTyp,CrpCod,'%s','CNY','000000000000000',
            ActTyp,ActSqn,ActNo,'%s','%s','%s','%s',TCusId,TCusNm,'%s'
            FROM savcusagt
            WHERE CAgtNo='%s' AND Status='0' AND SUBSTR(CnlSts,19,1)='1'
         </Sentence>
         <Fields>LogNo|DskNo|SelVal|ActDat|CAgtNo|HTxnCd|TTxnCd|TxnObj|NodNo|CAgtNo|</Fields>
      </DynSentence>

      <Process>
         <Set>LckKey=STRCAT($AplCls,:,afebatrec,:,$CAgtNo)</Set>
         <Exec func="PUB:Lock" error="IGNORE"><!-- 通过加锁控制批次状态 -->
            <Arg name="RecKey" value="$LckKey"/>
            <Arg name="TimOut" value="3000"/>
            <Arg name="AutoUnlock" value="yes"/>
         </Exec>
         <If condition="INTCMP(~RetCod,4,0)"><!--加锁失败-->
            <Set>RspCod=478004</Set>
            <Return/>
         </If>
         <Quote name="Do_TxnChk"/>
         <Set>TxnMod=1</Set>
         <Set>CmtFlg=0</Set>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCrpAgrInf"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=478799</Set>
            <Set>RspMsg=数据库错误</Set>
            <Return/>
         </If>
         <If condition="~RetCod=-2">
            <Set>RspCod=478702</Set>
            <Set>RspMsg=没有有效的商户协议</Set>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetOrnCnt"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=478799</Set>
            <Set>RspMsg=数据库错误</Set>
            <Return/>
         </If>
         <If condition="~RetCod=-2">
            <Set>RspCod=478702</Set>
            <Set>RspMsg=没有有效的客户协议</Set>
            <Return/>
         </If>
         <Exec func="PUB:GetAppInfo"/>
         <!--Set>ObjSvr=OFRTTAX1</Set>
         <Set>TxnObj=SHSTPUB1</Set-->
         <!--Set>BrNo=@BCFG.BrNo</Set-->    <!--入账分行号-->
         <Set>ActNod=@BCFG.ANodNo</Set><!--账务网点号-->

         <Set>TrdTbl=afebatrec</Set>
         <Set>NamChk=1</Set>           <!--不需要检查户名-->
         <Set>TxnMod=1</Set>           <!-- 需要单笔上送 -->
         <Set>CmtFlg=0</Set>           <!-- 大小通道发送状态 -->
         <Set>UpdFlg=N</Set>           <!--更新标志-->
         <Set>PayMod=0</Set>
         <Set>HPrChk=0</Set>
         <Set>HLsChk=0</Set>
         <Set>IsTxn=Y</Set>
         <Set>HTxnSt=U</Set>
         <Set>HTxnCd=@PARA.HTxnCd</Set>
         <Set>TxnObj=@PARA.TxnSvr</Set>
         <Set>ObjSvr=@PARA.ObjSvr</Set>
         <Set>FTxnCd=@PARA.FTxnCd</Set>   <!--后续交易(用于后续操作并通知前端批次完成的)-->
         <Set>DskNam=STRCAT(AFE,$CAgtNo)</Set>
         <Exec func="PUB:RegisterBatchDiskNo"/><!--登记批量信息到pubbatinf-->

         <!--Exec func="PUB:GetLogNo" error="PUB:DeleteDiskNo">
         <Arg name="NumBer" value="$OrnCnt"/>
         </Exec-->
         <Exec func="PUB:nGetPubSeqNo">
            <Arg name="SeqNam" value="afebatrec:SeqNo"/>
            <Arg name="SeqCnt" value="$OrnCnt"/>
            <Arg name="Len" value="7"/>
         </Exec>

         <Exec func="PUB:ExecSql" error="PUB:DeleteDiskNo">
            <Arg name="SqlCmd" value="InBatRec"/>
         </Exec>
         <!--修改本批次为确认状态，启动大小通道发送 -->
         <Exec func="PUB:UpdateBatchStatus" error="PUB:DeleteDiskNo">
            <Arg name="ChkFlg" value="1"/>
         </Exec>
         <Exec func="PUB:DeleteDiskNo"/>
      </Process>
   </Function>

   <Function name="AFE_TimCfmJnl" desc="定时查实可疑账务交易">
      <DynSentence name="QryHstUJnl">  <!--查找主机交易状态为U或T的流水-->
         <Sentence>
            SELECT FTxnTm,LogNo OLogNo,HTxnSt,TLogNo
            FROM afetxnjnl
            WHERE  ActDat='%s' AND (HTxnSt='U' OR HTxnSt='T')
         </Sentence>
         <Fields>ActDat|</Fields>
      </DynSentence>
      <DynSentence name="QryCrcJnl">  <!--查找该流水是否因超过冲正次数而停止冲正-->
         <Sentence>
            SELECT 'Y' YN FROM table(values(1)) as anony
            WHERE EXISTS
            (SELECT * FROM crcjnl WHERE  LogNo='%s' AND RvsSts='4')
         </Sentence>
         <Fields>OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="QryRdoJnl">  <!--查找该流水是否因超过重发次数而停止重发-->
         <Sentence>
            SELECT 'Y' YN FROM table(values(1)) as anony
            WHERE EXISTS
            (SELECT * FROM rdojnl WHERE  LogNo='%s' AND RvsSts='4')
         </Sentence>
         <Fields>OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdJnlSts">
         <Sentence>
            UPDATE afetxnjnl
            SET HTxnSt='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|OLogNo|</Fields>
      </DynSentence>
      <Process>
         <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
            <Arg name="SqlCmd" value="QryHstUJnl"/>
         </Exec>
         <If condition="~RetCod&lt;0">
            <Set>RspCod=478517</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor"/>
               <Set>RspCod=478517</Set>
               <Return/>
            </ElseIf>

            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="QryCrcJnl"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor"/>
               <Set>RspCod=478799</Set>
               <Set>RspMsg=查询冲正流水表时数据库错误</Set>
               <Return/>
            </If>
            <If condition="~RetCod=-2">
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="QryRdoJnl"/>
               </Exec>
               <If condition="~RetCod=-1">
                  <Exec func="PUB:CloseCursor"/>
                  <Set>RspCod=478799</Set>
                  <Set>RspMsg=查询重发流水表时数据库错误</Set>
                  <Return/>
               </If>
               <If condition="~RetCod=-2">
                  <Exec func="PUB:CloseCursor"/>
                  <Set>RspCod=000000</Set>
               </If>
            </If>
            <Exec func="PUB:CallHostOther" error="IGNORE">
               <Arg name="HTxnCd" value="@PARA.HTxnCd_Cfm"/>
               <Arg name="ObjSvr" value="@PARA.CBHost"/>
            </Exec>
            <If condition="~RetCod&lt;0">
               <Continue/>
            </If>
            <Switch expression="~RetCod">
               <Case value="3">         <!--交易失败判断主机返回码-->
                  <Switch expression="$HRspCd">
                     <Case value="AG8001"/>  <!--主机无此交易更新前置为失败-->
                     <Case value="AG8981"/>
                     <Case value="SC6129">
                        <Set>HTxnSt=X</Set>
                        <Set>TxnSts=X</Set>
                        <Exec func="PUB:ExecSql" error="IGNORE">
                           <Arg name="SqlCmd" value="UpdJnlSts"/>
                        </Exec>
                        <Break/>
                     </Case>
                     <Case value="SC6034">
                        <Set>HTxnSt=C</Set>
                        <Set>TxnSts=C</Set>
                        <Exec func="PUB:ExecSql" error="IGNORE">
                           <Arg name="SqlCmd" value="UpdJnlSts"/>
                        </Exec>
                        <Break/>
                     </Case>
                     <Default>
                        <Break/>
                     </Default>
                  </Switch>
                  <Break/>
               </Case>
               <Case value="0">    <!--主机交易成功-->
                  <If condition="$CrcSts!=Y"> <!--主机返回抹帐-->
                     <Set>HTxnSt=S</Set>
                     <Set>TxnSts=S</Set>
                  </If>
                  <Else>                      <!--主机返回正常-->
                     <Set>HTxnSt=C</Set>
                     <Set>TxnSts=C</Set>
                  </Else>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="UpdJnlSts"/>
                  </Exec>
                  <Break/>
               </Case>
               <Default>
                  <Break/>
               </Default>
            </Switch>
         </While>
         <Exec func="PUB:CloseCursor"/>
      </Process>
   </Function>

   <Function name="AFE_SglPAgrMng" desc="个人协议维护(单笔)">
      <!--协议状态Status0,有效1，无效2，增加或者删除未知3，修改协议失败-->
      <Quote name="Def_TxnChk"/>
      <DynSentence name="ChkCusAgt">
         <!--查询协议状态-->
         <Sentence>
            select Status, PAgtNo from savcusagt where CAgtNo='%s' and TCusID='%s'
         </Sentence>
         <Fields>CAgtNo|TCusId|</Fields>
      </DynSentence>
      <DynSentence name="UptCusAgt">
         <Sentence>
            PAgtNo='%s'
         </Sentence>
         <Fields>PAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="UptCusAgtSts">
         <Sentence>
            UPDATE savcusagt SET Status='%s' WHERE PAgtNo='%s'
         </Sentence>
         <Fields>Status|PAgtNo|</Fields>
      </DynSentence>
      <Process>
         <Quote name="Do_TxnChk"/>
         <Switch expression="@PARA.CChkMod">
            <Case value="0">   <!--检查证件户名-->
               <Exec func="PUB:CallHostOther" error="IGNORE">
                  <Arg name="HTxnCd" value="@PARA.HCTxnCd"/> <!--主机查询证件户名-->
                  <Arg name="ObjSvr" value="@PARA.CBHost"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478642</Set>
                  <Set>RspMsg=用户名错误</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Case value="1">
               <!--检查密码-->
               <Exec func="PUB:CallHostOther" error="IGNORE">
                  <Arg name="HTxnCd" value="@PARA.HCTxnCd"/> <!-- 主机查询密码-->
                  <Arg name="ObjSvr" value="@PARA.CBHost"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478642</Set>
                  <Set>RspMsg=密码错误</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478642</Set>
               <Set>RspMsg=参数错误</Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>
         <Switch expression="$Oper">
            <Case value="C">
               <!--新增-->
               <Exec func="PUB:ReadRecord" error="IGNORE">      <!--检查客户协议是否存在-->
                  <Arg name="SqlCmd" value="ChkCusAgt"/>
               </Exec>
               <If condition="~RetCod=-2">
                  <Set>SeqCnd=STRCAT(SUBSTR($BrNo,1,3),$BBusTyp)</Set>  <!--取个人协议编号-->
                  <Exec func="PUB:GetPubSeqNo">    <!--取个人协议编号(3位分行地区号＋7位顺序号)-->
                     <Arg name="SeqNam" value="savcusagt:PAgtNo"/>  <!--业务码待定后再将其作为生成依据-->
                     <Arg name="SeqCnd" value="$SeqCnd"/>
                     <Arg name="Len" value="7"/>
                  </Exec>
                  <Set>PAgtNo=STRCAT($SeqCnd,$SelVal)</Set>
                  <Set>Status=2</Set>	<!--0,成功；1,失败；2,未知-->
                  <Exec func="PUB:InsertRecord"><!--更新客户协议信息-->
                     <Arg name="TblNam" value="savcusagt"/>
                  </Exec>
               </If>
               <ElseIf condition="~RetCod=0"><!--记录存在-->
                  <Switch expression="$Status">
                     <Case value="0"><!--协议存在-->
                        <Set>RspCod=478641</Set>
                        <Set>RspMsg=协议已经存在</Set>
                        <Return/>
                        <Break/>
                     </Case>
                     <Case value="1"><!--协议无效-->
                        <Set>Status=2</Set>
                        <Exec func="PUB:UpdateRecord">    <!--更新客户协议信息-->
                           <Arg name="CndSts" value="UptCusAgt"/>
                           <Arg name="TblNam" value="savcusagt"/>
                        </Exec>
                        <Exec func="PUB:CommitWork"/><!--提交记录-->
                        <Break/>
                     </Case>
                     <Case value="2">
                        <!--状态未知-->
                        <Set>RspCod=478644</Set>
                        <Set>RspMsg=协议状态未知，请先删除协议</Set>
                        <Return/>
                        <Break/>
                     </Case>
                     <Case value="3">
                        <Set>RspCod=478645</Set>
                        <Set>RspMsg=修改协议失败，请先修改协议或者删除协议</Set>
                        <Return/>
                        <Break/>
                     </Case>
                     <Default>
                        <Set>RspCod=478643</Set>
                        <Set>RspMsg=协议状态不对</Set>
                        <Return/>
                        <Break/>
                     </Default>
                  </Switch>
               </ElseIf>
               <Else>
                  <!--协议无效-->
                  <Set>RspCod=478699</Set>
                  <Set>RspMsg=数据库操作错误</Set>
                  <Return/>
               </Else>
               <!--去主机签约-->
               <Exec func="PUB:GetLogNo"/>
               <Exec func="PUB:CallHostOther">
                  <!--去主机登记个人协议信息-->
                  <Arg name="HTxnCd" value="@PARA.HTxnCd"/>
                  <Arg name="ObjSvr" value="@PARA.CBHost"/>
               </Exec>
               <!--去第三方签约-->
               <Set>RspCod=000000</Set>
               <Set>MsgTyp=N</Set>
               <Switch expression="@PARA.TxnMod">
                  <Case value="0">
                     <!--不去第三方签约-->
                     <Break/>
                  </Case>
                  <Case value="1">
                     <!--需去第三方签约-->
                     <Exec func="PUB:CallThirdOther" error="IGNORE">
                        <Arg name="TTxnCd" value="@PARA.CThdCod"/>
                        <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
                     </Exec>
                     <If condition="INTCMP(~RetCod,1,0)">
                        <Set>RspCod=478606</Set>
                        <Set>RspMsg=第三方交易失败</Set>
                        <Set>~RetCod=-1</Set>
                     </If>
                     <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                     <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                        <Set>RspCod=478606</Set>
                        <Set>RspMsg=STRCAT(第三方返回:,$TRspCd)</Set>
                        <Set>~RetCod=-1</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="2">
                     <!--个性定制-->
                     <Call function="@PARA.IddQryFunc"/>
                     <If condition="IS_NOEQUAL_STRING($RspCod,000000)">
                        <Set>~RetCod=-1</Set>
                     </If>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478642</Set>
                     <Set>RspMsg=参数错误</Set>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
               <Set>Status=0</Set>
               <!--更新协议状态为有效状态-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UptCusAgtSts"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="D">
               <!--删除-->
               <If condition="INTCMP(GETSTRPOS(@PARA.AuthCnl,$TxnCnl),1,0)">
                  <!--Execfunc="PUB:AddAuthReason">
                  <Arg name="AthCod" value="30"/>
                  <Arg name="AthMsg" value="471002"/>
                  </Exec>
                  <Exec func="PUB:CheckLocalAuth">
                  <Arg name="ObjSvr" value="@PARA.HstSvr"/>
                  </Exec-->
               </If>
               <!--检查客户协议是否存在-->
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="ChkCusAgt"/>
               </Exec>
               <Switch expression="$Status">
                  <Case value="0"/>
                  <Case value="2"/>
                  <Case value="3">
                     <!--协议存在-->
                     <Break/>
                  </Case>
                  <Case value="1">
                     <Set>RspCod=478607</Set>
                     <Set>RspMsg=协议不存在</Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478643</Set>
                     <Set>RspMsg=协议状态不对</Set>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
               <!--上主机解除协议-->
               <Set>Status=2</Set>
               <!--更新协议状态为未知状态-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UptCusAgtSts"/>
               </Exec>
               <Exec func="PUB:CommitWork"/>
               <Exec func="PUB:GetLogNo"/>
               <Exec func="PUB:CallHostOther" error="IGNORE">
                  <!--去主机删除个人协议信息-->
                  <Arg name="HTxnCd" value="@PARA.HTxnCd"/>
                  <Arg name="ObjSvr" value="@PARA.CBHost"/>
               </Exec>
               <Set>inHRspCd=STRCAT(|,$HRspCd,|)</Set>
               <If condition="AND(INTCMP(~RetCod,4,0),INTCMP(GETSTRPOS(@PARA.HNoAgr,$inHRspCd),1,0))">
                  <!--删除协议不成功并且没有主机没有报无此协议-->
                  <Set>RspCod=478607</Set>
                  <Set>RspMsg=STRCAT(上主机失败,$HRspCd)</Set>
                  <Return/>
               </If>
               <Set>MsgTyp=N</Set>
               <Set>RspCod=000000</Set>
               <!--去第三方删除协议-->
               <Switch expression="@PARA.TxnMod">
                  <Case value="0">
                     <!--不去第三方签约-->
                     <Break/>
                  </Case>
                  <Case value="1">
                     <!--需去第三方签约-->
                     <Exec func="PUB:CallThirdOther" error="IGNORE">
                        <Arg name="TTxnCd" value="@PARA.DThdCod"/>
                        <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
                     </Exec>
                     <If condition="INTCMP(~RetCod,1,0)">
                        <Set>RspCod=478606</Set>
                        <Set>RspMsg=第三方交易失败</Set>
                        <Set>~RetCod=-1</Set>
                     </If>
                     <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                     <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                        <Set>RspCod=478606</Set>
                        <!--第三方交易不成功-->
                        <Set>RspMsg=STRCAT(第三方返回:,$TRspCd)</Set>
                        <Set>~RetCod=-1</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="2">
                     <!--个性定制-->
                     <Call function="@PARA.IddQryFunc"/>
                     <If condition="IS_NOEQUAL_STRING($RspCod,000000)">
                        <Set>~RetCod=-1</Set>
                     </If>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478642</Set>
                     <Set>RspMsg=参数错误</Set>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
               <Set>Status=1</Set>
               <!--更新协议状态为失效状态-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UptCusAgtSts"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="U">
               <!--修改-->
               <If condition="INTCMP(GETSTRPOS(@PARA.AuthCnl,$TxnCnl),1,0)">
                  <Exec func="PUB:AddAuthReason">
                     <Arg name="AthCod" value="30"/>
                     <Arg name="AthMsg" value="471002"/>
                  </Exec>
                  <Exec func="PUB:CheckLocalAuth">
                     <Arg name="ObjSvr" value="@PARA.HstSvr"/>
                  </Exec>
               </If>
               <Exec func="PUB:ReadRecord"><!--检查客户协议是否存在-->
                  <Arg name="SqlCmd" value="ChkCusAgt"/>
               </Exec>
               <Switch expression="$Status">
                  <Case value="0"/>
                  <Case value="3">
                     <!--协议存在-->
                     <Break/>
                  </Case>
                  <Case value="2">
                     <Set>RspCod=478644</Set>
                     <!--协议状态未知，请先删除协议-->
                     <Set>RspMsg=协议状态未知，请先删除协议</Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Case value="1">
                     <Set>RspCod=478607</Set>
                     <Set>RspMsg=协议不存在</Set>
                     <Return/>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478643</Set>
                     <Set>RspMsg=协议状态不对</Set>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
               <Set>Status=3</Set>
               <!--预计修改状态-->
               <Exec func="PUB:UpdateRecord">
                  <!--更新客户协议信息-->
                  <Arg name="CndSts" value="UptCusAgt"/>
                  <Arg name="TblNam" value="savcusagt"/>
               </Exec>
               <Exec func="PUB:CommitWork"/>
               <!--上主机修改协议-->
               <Exec func="PUB:GetLogNo"/>
               <Exec func="PUB:CallHostOther">
                  <!--去主机修改个人协议信息-->
                  <Arg name="HTxnCd" value="@PARA.HTxnCd"/>
                  <Arg name="ObjSvr" value="@PARA.CBHost"/>
               </Exec>
               <!--去第三方修改协议-->
               <Set>RspCod=000000</Set>
               <Set>MsgTyp=N</Set>
               <Switch expression="@PARA.TxnMod">
                  <Case value="0">
                     <!--不去第三方签约-->
                     <Break/>
                  </Case>
                  <Case value="1">
                     <!--需去第三方签约-->
                     <If condition="INTCMP(~RetCod,1,0)">
                        <Set>RspCod=478606</Set>
                        <Set>RspMsg=第三方交易失败</Set>
                        <Set>~RetCod=-1</Set>
                     </If>
                     <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
                     <Exec func="PUB:CallThirdOther" error="IGNORE">
                        <Arg name="TTxnCd" value="@PARA.UThdCod"/>
                        <Arg name="ObjSvr" value="@PARA.ThdSvr"/>
                     </Exec>
                     <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
                        <Set>RspCod=478606</Set>
                        <!--第三方交易不成功-->
                        <Set>RspMsg=STRCAT(第三方返回:,$TRspCd)</Set>
                        <Set>~RetCod=-1</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="2">
                     <!--个性定制-->
                     <Call function="@PARA.IddQryFunc"/>
                     <If condition="IS_NOEQUAL_STRING($RspCod,000000)">
                        <Set>~RetCod=-1</Set>
                     </If>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478642</Set>
                     <Set>RspMsg=参数错误</Set>
                     <Return/>
                     <Break/>
                  </Default>
               </Switch>
               <Set>Status=0</Set>
               <!--更新协议状态为有效状态-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UptCusAgtSts"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478642</Set>
               <Set>RspMsg=参数错误</Set>
               <Return/>
               <Break/>
            </Default>
         </Switch>
      </Process>
   </Function>

   <Function name="AFE_FilBat" desc="文件批扣">
      <DynSentence name="UpdSts">  <!--更新批次状态-->
         <Sentence>
            update savfilctl set BatSts='%s' where BrNo='%s' and DskNum='%s'
         </Sentence>
         <Fields>BatSts|BrNo|DskNum|</Fields>
      </DynSentence>
      <DynSentence name="Chk_CrpAgr"><!--检查单位协议 -->
         <Sentence>
            select BBusTyp,TActNo from savcrpagr where CAgtNo='%s' and SvrSts='1'
         </Sentence>
         <Fields>CAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkCusAgt">  <!--检查客户协议是否有效 -->
         <Sentence>
            UPDATE afebatrec a SET RecSts = 'X'  WHERE DskNo='%s' and   not exists ( SELECT TCusID FROM  savcusagt b WHERE a.CAgtNo=b.CAgtNo AND a.TCusID=b.TCusID AND a.ActNo=b.ActNo AND b.Status='0')
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="CntBatRec"><!--统计该批次的总笔数和总金额-->
         <Sentence>
            SELECT count(*) AS OrnCnt,coalesce(sum(cast(TxnAmt as BIGINT)),0) AS OrnAmt FROM afebatrec
            WHERE DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="GetBatRec"><!--导出所有需要上送主机的明细记录-->
         <Sentence>
            SELECT a.LogNo,a.DskNo,a.SeqNo,a.BSmr,a.RecSts,a.ActTyp,a.ActNo,a.ActNam,
            a.TxnAmt,a.CAgtNo,a.TxnCod,a.CcyCod,a.TxnDat,a.TxnDir,
            a.SetDat,a.FrzAmt,b.FulChk FulChk,a.CrgFlg,a.CrgCod,a.CActNo,
            a.TCusID,a.TCusNm,a.FSeqNo,'%s' BHstCd,'%s' HstFunc,
            '%s' ActDat,b.BusTyp,b.FeeMod, b.TActNo
            FROM afebatrec a,savcrpagr b
            WHERE a.DskNo='%s' and b.CAgtNo=a.CAgtNo
            ORDER BY seqno
         </Sentence>
         <Fields>BHstCd|HstFunc|ActDat|DskNo|</Fields>
      </DynSentence>
      <DynSentence name="GetInpRecs"><!--读取该单位所有代收付记录中待转换旧账号-->
         <Sentence>
            SELECT CAgtNo,SeqNo,OldAct,ActNo FROM afebatrec
            WHERE DskNo='%s' and LENGTH(RTRIM(ActNo))=20
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="GetActNo"><!--根据旧账号获取新帐号-->
         <Sentence>
            SELECT ActNo FROM savoldact
            WHERE OldAct='%s'
         </Sentence>
         <Fields>OldAct|</Fields>
      </DynSentence>
      <DynSentence name="UpdInpAct"><!--更新原有明细记录账号-->
         <Sentence>
            UPDATE afebatrec SET (ActNo,OldAct)=('%s','%s')
            WHERE  DskNo='%s' and SeqNo='%s'
         </Sentence>
         <Fields>ActNo|OldAct|DskNo|SeqNo|</Fields>
      </DynSentence>
      <DynSentence name="ClnBatRec"><!--清空该批次的所有记录-->
         <Sentence>
            DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <Process>
         <If condition="@PARA.ChkCrp=1">
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="Chk_CrpAgr"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>RspCod=478399</Set>
               <Set>RspMsg=查询单位协议时系统错误</Set>
               <Return/>
            </If>
            <If condition="~RetCod=-2">
               <Set>RspCod=478602</Set><!--返回无有效单位协议-->
               <Return/>
            </If>
         </If>
         <Set>LckKey=STRCAT($AplCls,:,afebatrec,:,$CAgtNo)</Set>
         <Exec func="PUB:Lock" error="IGNORE"><!-- 通过加锁控制批次状态 -->
            <Arg name="RecKey" value="$LckKey"/>
            <Arg name="TimOut" value="3000"/>
            <Arg name="AutoUnlock" value="yes"/>
         </Exec>
         <If condition="INTCMP(~RetCod,4,0)"><!--加锁失败-->
            <Set>RspCod=478004</Set>
            <Return/>
         </If>
         <Exec func="PUB:GetAppInfo"/>
         <If condition="IS_EQUAL_STRING($TxnCnl,THD)">
            <Set>TrmNo= </Set>
            <Set>OprLvl=3</Set>
            <Set>TTxnCd=$TxnCod</Set>
            <Exec func="PUB:GetVirtualTeller">
               <Arg name="TxnCnl" value="AFE"/>
               <Arg name="CnlSub" value="$BrNo"/>
            </Exec>
         </If>

         <Switch expression="@PARA.RcvMod">
            <Case value="0">
               <Exec func="PUB:FtpGet" error="IGNORE"><!--从第三方系统获取文件-->
                  <Arg name="FtpId"     value="@PARA.FtpId"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478799</Set>
                  <Set>RspMsg=接收文件时发生错误</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Case value="1">
               <Exec func="PUB:HiFtpGet" error="IGNORE">
                  <Arg name="FtpId"     value="@PARA.FtpId"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478302</Set>
                  <Set>RspMsg=接收文件时发生错误</Set>
               </If>
               <Break/>
            </Case>
            <Case value="2">
               <Exec func="PUB:IsExistFile" error="IGNORE">
                  <Arg name="FileName"  value="STRCAT(@PARA.RcvDir,$SndFil)"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478799</Set>
                  <Set>RspMsg=文件不存在</Set>
               </If>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set>
               <Set>RspMsg=接收文件模式 </Set>
               <Return/>
            </Default>
         </Switch>

         <Exec func="PUB:GetPubSeqNo" error="IGNORE">
            <Arg name="SeqNam" value="savfilctl:DskNum"></Arg>
            <Arg name="SeqCnd" value="$BusTyp"></Arg>
            <Arg name="Len" value="4"></Arg>
         </Exec>
         <Set>DskNum=STRCAT($BusTyp,$SelVal)</Set>
         <Exec func="PUB:RegisterBatchDiskNo"/>   <!--获取批次号-->
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam"  value="savfilctl"/>
         </Exec>
         <Exec func="PUB:DeleteDiskNo"/>

         <Set>BatSts=2</Set>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdSts"/>
         </Exec>
         <Switch expression="@PARA.NeedPrep_Rcv">
            <Case value="0">
               <Break/>
            </Case>
            <Case value="1">
               <Call function="@PARA.IddFunc_Rcv"/>
               <Break/>
            </Case>
         </Switch>

         <Exec func="PUB:IsValidFile">
            <Arg name="FileName" value="STRCAT(@PARA.RcvDir,$SndFil)"/>
         </Exec>
         <Set>OrnCnt=$FilLin</Set>
         <!--将文件拆分入批量明细表-->
         <Set>BSmr=STRCAT(9,$BBusTyp)</Set>
         <Set>SeqNo=1</Set><!--设置初始顺序号为1-->
         <Exec func="PUB:nGetPubSeqNo">
            <Arg name="SeqNam" value="Save:AgtFSeqNo"/><!--BTP文件记录标识-->
            <Arg name="Len" value="7"/><!--序号长度-->
            <Arg name="SeqCnt" value="ADD($OrnCnt,1)"/><!--取号个数-->
         </Exec>
         <Set>NFSeqNo=STRCAT($ActDat,$SelVal)</Set><!--设置拆分记录的起始记录序号-->
         <Exec func="PUB:ImportToDB" error="IGNORE">
            <Arg name="FormatName" value="@PARA.FmtNam_Rcv"/>
            <Arg name="FileName"   value="STRCAT(@PARA.RcvDir,$SndFil)"/>
            <Arg name="TableName"  value="afebatrec"/>
            <Arg name="ApplyLogNoFlag" value="0"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=478007</Set>
            <Return/>
         </If>

         <!--以下为新增新旧账号对照更新 -->
         <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
            <Arg name="SqlCmd" value="GetInpRecs"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=该单位没有录入记录</Set>
            <Return/>
         </ElseIf>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Set>RspCod=000000</Set>
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=478399</Set>
               <Set>RspMsg=数据库操作错误</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Set>OldAct=$ActNo</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="GetActNo"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Set>RspCod=000000</Set>
            </If>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="UpdInpAct"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </If>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <Exec func="PUB:CommitWork"/>   <!--提交更新记录-->


         <If condition="@PARA.ChkPsn=1">
            <!--检查协议 -->
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="ChkCusAgt"/>
            </Exec>
            <If condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
            </If>
         </If>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="CntBatRec"/>
         </Exec>
         <Set>SndFil=STRCAT(PAS,$FSysId,$DskNo)</Set><!--上送主机的文件名-->
         <Set>RslFil=STRCAT(PAR,$FSysId,$DskNo)</Set><!--上送主机下传的结果文件名-->
         <Set>OrnAmt=ADDCHAR($OrnAmt,15,0,1)</Set>
         <!--Set>BrNo=@BCFG.BrNo</Set-->
         <Set>BHstCd=470001</Set>
         <Set>HstFunc=OBPPACHM</Set><!--主机处理过程名,参考BTP上送交易手册-->
         <Exec func="PUB:ExportFromDB" error="IGNORE"><!--从数据表中导出上送主机的BTP文件-->
            <Arg name="SqlName" value="GetBatRec"/>
            <Arg name="FormatName" value="@PARA.FmtBtp_Snd"/>
            <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/host/send/,PAS,$FSysId,$DskNo)"/>
            <Arg name="TableName" value="afebatrec"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=478799</Set>
            <Exec func="PUB:DeleteRecordExt" error="IGNORE">
               <Arg name="TblNam" value="afebatrec"/>
               <Arg name="CndSts" value="ClnBatRec"/>
            </Exec>
            <Return/>
         </If>
         <Set>RspCod=000000</Set>
         <Set>BatSts=4</Set>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdSts"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=478799</Set>
            <Exec func="PUB:DeleteRecordExt" error="IGNORE">
               <Arg name="TblNam" value="afebatrec"/>
               <Arg name="CndSts" value="ClnBatRec"/>
            </Exec>
            <Return/>
         </If>

         <System command="hiFEnc" error="IGNORE"><!--文件EBCDIC转码-->
            <Arg name="flag"  value="E"/>
            <Arg name="outfile" value="STRCAT(GETENV(WORKDIR),/dat/host/send/,PAS,$FSysId,$DskNo)"/>
         </System>
         <Set>EnCodFlg=Y</Set>
         <Set>SumCnt=$OrnCnt</Set>
         <Set>SumAmt=$OrnAmt</Set>
         <Set>UIpAddr=@BCFG.LocalIp</Set><!--以下三项为上送的IP地址，用户名和密码-->
         <Set>UUsrNam=@BCFG.BTPSend</Set><!--BTP上送用户名-->
         <Set>UPin=@BCFG.HostRecvPwd</Set>
         <Set>DIpAddr=@BCFG.LocalIp</Set><!--以下三项为下传的IP地址，用户名和密码-->
         <Set>DUsrNam=@BCFG.BTPRecv</Set><!--BTP下传结果用户名-->
         <Set>DPin=@BCFG.HostSendPwd</Set>
         <Exec func="PUB:CallHostOther" error="IGNORE"><!--上送主机交易-->
            <Arg name="HTxnCd" value="034710"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <Switch expression="~RetCod">
            <Case value="-1"><!--上送主机超时-->
               <Set>BatSts=4</Set> <!--置批次状态为已提交-->
               <Set>RspCod=478049</Set>
               <Set>CmtMsg=上送主机超时!</Set>
               <Break/>
            </Case>
            <Case value="-2"><!--系统错误-->
               <Set>RspCod=478050</Set>
               <Set>CmtMsg=提交时系统错误</Set>
               <Exec func="PUB:DeleteRecordExt" error="IGNORE">
                  <Arg name="TblNam" value="afebatrec"/>
                  <Arg name="CndSts" value="ClnBatRec"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="-10"><!--未发送-->
               <Set>RspCod=478043</Set>
               <Set>CmtMsg=未发送到主机!</Set>
               <Exec func="PUB:DeleteRecordExt" error="IGNORE">
                  <Arg name="TblNam" value="afebatrec"/>
                  <Arg name="CndSts" value="ClnBatRec"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="3"><!--交易失败-->
               <Set>RspCod=$HRspCd</Set>
               <Set>CmtMsg=上送主机失败!</Set>
               <Exec func="PUB:DeleteRecordExt" error="IGNORE">
                  <Arg name="TblNam" value="afebatrec"/>
                  <Arg name="CndSts" value="ClnBatRec"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="0"><!--交易成功-->
               <Set>BatSts=4</Set>
               <Set>CmtMsg=已向主机提交!</Set>
               <Break/>
            </Case>
            <Default>
               <Set>CmtMsg=未知状态</Set>
               <Exec func="PUB:DeleteRecordExt" error="IGNORE">
                  <Arg name="TblNam" value="afebatrec"/>
                  <Arg name="CndSts" value="ClnBatRec"/>
               </Exec>
               <Break/>
            </Default>
         </Switch>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdSts"/>
         </Exec>
         <If condition="IS_NOEQUAL_STRING($TxnCnl,THD)">
            <Exec func="PUB:Notify"><!--发送消息给批次上送柜员-->
               <Arg name="BusTyp"  value="AG"/><!-- 业务类型-->
               <Arg name="AplCod"  value="FilBat"/><!-- 应用码-->
               <Arg name="Summary" value="批量入账提交通知"/><!-- 消息摘要-->
               <Arg name="MsgData" value="STRCAT($CBusTyp,:,$DskNo,批量代扣批次:,$CmtMsg,:,$RspCod)"/><!-- 消息内容-->
               <Arg name="ObjNod"  value="$NodNo"/><!-- 目的机构-->
               <Arg name="ObjTlr"  value="$TlrId"/><!-- 目的柜员-->
               <Arg name="SrcOrg"  value="$NodNo"/><!-- 操作机构号-->
               <Arg name="SrcTlr"  value="$TlrId"/><!-- 操作柜员号-->
            </Exec>
         </If>
      </Process>
   </Function>
   <Function name="AFE_BTPSnd" desc="批扣文件上送主机成功收到响应">
      <DynSentence name="UpdFmtSts">
         <Sentence>
            update savfilctl set BatSts='6',HBatSts='%s' where DskNo='%s'
         </Sentence>
         <Fields>HBatSts|DskNo|</Fields>
      </DynSentence>
      <Process>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdFmtSts"/>
         </Exec>
      </Process>
   </Function>
   <Function name="AFE_BTPRcv" desc="批扣结果文件处理">
      <DynSentence name="QueryFmtSts">
         <Sentence>
            select ModCod,SndFil,RslFil,DskNum from savfilctl where DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdBatRec">
         <Sentence>
            update afebatrec a set (a.RecSts,a.HRspCd,a.FrzAmt,a.FulChk) =(select b.RecSts,b.ErrCod,b.TxnAmt,b.FulChk from savbtprsl b where a.dskno=b.DskNo and a.fseqno=b.fseqno) where exists (select c.fseqno from savbtprsl c  where c.fseqno=a.fseqno) and a.DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdSts">
         <Sentence>
            update savfilctl set BatSts='%s',HBatSts='%s' where BrNo='%s' and DskNum='%s'
         </Sentence>
         <Fields>BatSts|HBatSts|BrNo|DskNum|</Fields>
      </DynSentence>
      <DynSentence name="CleanRsl">
         <Sentence>
            DELETE FROM savbtprsl
            WHERE DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="GetRet">
         <Sentence>
            SELECT * FROM afebatrec WHERE DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="GetRetExt">
         <Sentence>
            DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <Process>
         <Set>LckKey=STRCAT($AplCls,:,savbtprsl,:,$DskNo)</Set> <!--Modified by lxb-->
         <Exec func="PUB:Lock" error="IGNORE"><!-- 通过加锁控制批次状态 -->
            <Arg name="RecKey" value="$LckKey"/>
            <Arg name="TimOut" value="3000"/> <!--Modified by lxb from 1200s to 3000s-->
            <Arg name="AutoUnlock" value="yes"/>
         </Exec>
         <!--Add by lxb begin-->
         <If condition="~RetCod=-2">
            <Set>RspCod=478799</Set>
            <Set>RspMsg=原来已经被加锁且未失效</Set>
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-1">
            <Set>RspCod=478799</Set>
            <Set>RspMsg=错误参数</Set>
            <Return/>
         </ElseIf>
         <!--Add by lxb end-->
         <Exec func="PUB:GetAppInfo"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QueryFmtSts"/>
         </Exec>
         <Set>HRslFil=STRCAT(GETENV(WORKDIR),/dat/host/recv/,STRCAT(PAR,$FSysId,$DskNo))</Set>
         <Exec func="PUB:IsExistFile" error="IGNORE"> <!--Modified by lxb-->
            <Arg name="FileName" value="$HRslFil"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=478799</Set>
            <Set>RspMsg=文件不存在</Set><!--Add by lxb-->
            <Exec func="PUB:Unlock"><!--Add by lxb-->
               <Arg name="RecKey" value="$LckKey"/>
            </Exec>
            <Return/>
         </If>
         <!--入库,更新各标志（文件控制表和明细表)-->
         <Exec func="PUB:ExecSql" error="IGNORE"> <!--清理已经下载过该批次的明细记录-->
            <Arg name="SqlCmd" value="CleanRsl"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
         </If>
         <!--Add by lxb begin-->
         <ElseIf condition="~RetCod=-1">
            <Set>RspCod=478799</Set>
            <Set>RspMsg=系统错误</Set>
            <Exec func="PUB:Unlock">
               <Arg name="RecKey" value="$LckKey"/>
            </Exec>
            <Return/>
         </ElseIf>
         <!--Add by lxb end-->
         <Set>TTxnCd=$TxnCod</Set>
         <Exec func="PUB:ImportToDB"><!--将文件拆分入批量处理结果明细表-->
            <Arg name="FormatName" value="@PARA.FmtNam"/>
            <Arg name="FileName" value="$HRslFil"/>
            <Arg name="TableName" value="savbtprsl"/>
            <Arg name="ApplyLogNoFlag" value="0"/>
         </Exec>
         <Exec func="PUB:ExecSql"><!--更新明细表-->
            <Arg name="SqlCmd" value="UpdBatRec"/>
         </Exec>
         <Set>BatSts=9</Set>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdSts"/>
         </Exec>

         <If condition="IS_NOEQUAL_STRING(LEFTSTR($TlrId,1),E)">
            <Exec func="PUB:Notify"><!--发送消息给批次上送柜员-->
               <Arg name="BusTyp"  value="AG"/><!-- 业务类型-->
               <Arg name="AplCod"  value="BTPRcv"/><!-- 应用码-->
               <Arg name="Summary" value="BTP批次处理结果通知"/><!-- 消息摘要-->
               <Arg name="MsgData" value="STRCAT($CBusTyp,:,$DskNo,:批量代扣批次状态为,$HBatSts)"/><!-- 消息内容-->
               <Arg name="ObjNod"  value="$NodNo"/><!-- 目的机构-->
               <Arg name="ObjTlr"  value="$TlrId"/><!-- 目的柜员-->
               <Arg name="SrcOrg"  value="$NodNo"/><!-- 操作机构号-->
               <Arg name="SrcTlr"  value="$TlrId"/><!-- 操作柜员号-->
            </Exec>
         </If>
         <If condition="@PARA.IsRetFil=1"><!--是否需要回送文件 -->
            <If condition="@PARA.ExtFlg=1"><!--带扩展表-->
               <Exec func="PUB:ExportFromDB"><!--从数据表中导出回送文件-->
                  <Arg name="SqlName" value="GetRetExt"/>
                  <Arg name="FormatName" value="@PARA.RetFmt"/>
                  <Arg name="FileName" value="STRCAT(@PARA.RetDir,$RslFil)"/>
                  <Arg name="TableName" value="afebatrec"/>
               </Exec>
            </If>
            <Else><!--不带扩展表-->
               <Exec func="PUB:ExportFromDB"><!--从数据表中导出回送文件-->
                  <Arg name="SqlName" value="GetRet"/>
                  <Arg name="FormatName" value="@PARA.RetFmt"/>
                  <Arg name="FileName" value="STRCAT(@PARA.RetDir,$RslFil)"/>
                  <Arg name="TableName" value="afebatrec"/>
               </Exec>
            </Else>
            <Switch expression="@PARA.RetMod">
               <Case value="0">
                  <!--Ftp回传-->
                  <Exec func="PUB:FtpPut">
                     <Arg name="FtpId" value="@PARA.FtpId"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="1">
                  <!--HiFtp回传-->
                  <Exec func="PUB:HiFtpPut">
                     <Arg name="FtpId" value="@PARA.FtpId"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="2">
                  <!--本地保留-->
                  <Break/>
               </Case>
               <Default>
                  <Set>RspCod=478600</Set>
                  <Set>RspMsg=参数错误</Set>
                  <Return/>
                  <Break/>
               </Default>
            </Switch>
         </If>

         <!--将文件发出,更新文件控制表状态 -->
         <Set>BatSts=D</Set>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdSts"/>
         </Exec>
         <Exec func="PUB:Unlock"><!--Add by lxb-->
            <Arg name="RecKey" value="$LckKey"/>
         </Exec>
      </Process>
   </Function>


   <Function name="AFE_BTPQrySts" desc="已提交BTP批次状态查询">
      <DynSentence name="GetDskInf">
         <Sentence>
            SELECT BatSts,ActDat CmtDat,HBatSts
            FROM savfilctl
            WHERE DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdBatSts">
         <Sentence>
            UPDATE savfilctl SET (BatSts,HBatSts)=('%s','%s')
            WHERE DskNo='%s'
         </Sentence>
         <Fields>BatSts|HBatSts|DskNo|</Fields>
      </DynSentence>

      <Process>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetDskInf"/>
         </Exec>
         <Set>IBatSts=$BatSts</Set>
         <If condition="AND(INTCMP($HBatSts,4,9),INTCMP($HBatSts,4,8),INTCMP($BatSts,5,6))"><!--非已完成批次-->
            <Set>RspCod=000000</Set>
            <Set>MsgTyp=N</Set>
            <!--Set>BrNo=@BCFG.BrNo</Set-->
            <Exec func="PUB:CallHostOther" error="IGNORE"><!--查询主机批次状态-->
               <Arg name="HTxnCod" value="034750" />
               <Arg name="ObjSvr" value="SHSTPUB1" />
            </Exec>
            <If condition="IS_EQUAL_STRING($HRspCd,CM4704)"> <!--主机无此批次,上传不成功-->
               <Set>BatSts=A</Set>
               <Exec func="PUB:ExecSql">    <!--废弃当前批次-->
                  <Arg name="SqlCmd" value="UpdBatSts"/>
               </Exec>
               <Set>RspCod=000000</Set>
               <Set>MsgTyp=N</Set>
               <Return/>
            </If>
            <Exec func="PUB:PutResponse"/><!--返回查询结果信息-->
            <If condition="$HBatSts=9"><!--若主机已处理完,进行下载文件处理-->
               <Exec func="PUB:CallHostOther" error="IGNORE"><!--主机批次处理结果文件下传-->
                  <Arg name="HTxnCod" value="034720" />
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
            </If>
            <Else>
               <Switch expression="$HBatSts">
                  <Case value="I"> <!--初始,尚未取数据-->
                     <If condition="DIFFDATE($CmtDat,$ActDat)!=0">
                        <Set>BatSts=7</Set>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="0"> <!--数据传送中-->
                     <If condition="DIFFDATE($CmtDat,$ActDat)!=0">
                        <Set>BatSts=7</Set>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="1"> <!--数据传送成功-->
                     <If condition="DIFFDATE($CmtDat,$ActDat)!=0">
                        <Set>BatSts=A</Set>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="2"> <!--数据传送失败-->
                     <Set>BatSts=7</Set>
                     <Break/>
                  </Case>
                  <Case value="4"> <!--数据检查错(记录格式不符)-->
                     <Set>BatSts=A</Set>
                     <Break/>
                  </Case>
                  <Case value="5"> <!--数据检查错(总数不符)-->
                     <Set>BatSts=A</Set>
                     <Break/>
                  </Case>
                  <Case value="6"> <!--允许运行-->
                     <Set>BatSts=6</Set>
                     <Break/>
                  </Case>
                  <Case value="7"> <!--交易处理中-->
                     <Set>BatSts=8</Set>
                     <Break/>
                  </Case>
                  <Case value="8"> <!--柜员废弃-->
                     <Set>BatSts=A</Set>
                     <Break/>
                  </Case>
                  <Case value="9"> <!--交易处理结束-->
                     <Set>BatSts=9</Set>
                     <Break/>
                  </Case>
               </Switch>
               <Exec func="PUB:ExecSql">    <!--修改当前批次主机状态-->
                  <Arg name="SqlCmd" value="UpdBatSts"/>
               </Exec>
            </Else>
         </If>
      </Process>
   </Function>


   <Function name="AFE_PreChk" desc="预备对账"><!--用于当日对账前的准备 -->
      <DynSentence name="QryMaxJnl">
         <Sentence>
            SELECT LogNo MLogNo FROM pubpltinf
         </Sentence>
      </DynSentence>
      <DynSentence name="QryHstTJnl">  <!--查找主机交易状态为T的流水-->
         <Sentence>
            SELECT FTxnTm,LogNo,HTxnSt,TLogNo
            FROM afetxnjnl
            WHERE ActDat='%s' AND (HTxnSt='U' OR HTxnSt='T') AND LogNo &lt;'%s' AND CAgtNo='%s'
         </Sentence>
         <Fields>ActDat|MLogNo|CAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="QryHstUJnl">  <!--查找主机交易状态为U或T的流水-->
         <Sentence>
            SELECT FTxnTm,LogNo OLogNo,HTxnSt,TLogNo
            FROM afetxnjnl
            WHERE  ActDat='%s' AND (HTxnSt='U' OR HTxnSt='T') AND LogNo &lt;'%s' AND CAgtNo='%s'
         </Sentence>
         <Fields>ActDat|MLogNo|CAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdJnlSts">
         <Sentence>
            UPDATE afetxnjnl
            SET HTxnSt='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|OLogNo|</Fields>
      </DynSentence>
      <Process>
         <Exec func="PUB:ReadRecord"><!--参数：@PARA.QryCnd-->
            <Arg name="SqlCmd" value="QryMaxJnl"/>
         </Exec>
         <If condition="@PARA.CollectMod=1">
            <Set>MLogNo=STRCAT($ActDat,$MLogNo)</Set>
         </If>
         <Else>
            <Set>MLogNo=STRCAT(RIGHTSTR($ActDat,6),$MLogNo)</Set>
         </Else>

         <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
            <Arg name="SqlCmd" value="QryHstTJnl"/>
         </Exec>
         <If condition="~RetCod&lt;0">
            <Set>RspCod=478517</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor"/>
               <Set>RspCod=478517</Set>
               <Return/>
            </ElseIf>
            <Exec func="PUB:Lock">      <!--加锁-->
               <Arg name="RecKey"   value="STRCAT($BusTyp,$CrpCod,$LogNo)"/>
               <Arg name="TimOut"   value="20"/>
            </Exec>
            <If condition="@PARA.CelCor=1">
               <Exec func="PUB:CancelCorrect"/>  <!--停止冲正-->
               <Exec func="PUB:CancelRedo"/>  <!--停止重发-->
            </If>
            <Exec func="PUB:Unlock">
               <Arg name="RecKey"   value="STRCAT($BusTyp,$CrpCod,$LogNo)"/>
            </Exec>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <Set>RspCod=000000</Set>
         <Set>MsgTyp=N</Set>
         <!--Exec func="PUB:PutResponse"/--><!--返回查询结果信息-->
         <Exec func="PUB:Sleep">
            <Arg name="SleepTime" value="@PARA.SlpTim"/> <!--参数：@PARA.SlpTim-->
         </Exec>


         <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
            <Arg name="SqlCmd" value="QryHstUJnl"/>
         </Exec>
         <If condition="~RetCod&lt;0">
            <Set>RspCod=478517</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor"/>
               <Set>RspCod=478517</Set>
               <Return/>
            </ElseIf>

            <Exec func="PUB:CallHostOther" error="IGNORE">
               <Arg name="HTxnCd" value="@PARA.HTxnCd_Cfm"/><!--参数：@PARA.HTxnCd_Cfm-->
               <Arg name="ObjSvr" value="@PARA.CBHost"/>    <!--参数：@PARA.CBHost-->
            </Exec>
            <If condition="~RetCod&lt;0">
               <Continue/>
            </If>
            <Switch expression="~RetCod">
               <Case value="3">         <!--交易失败判断主机返回码-->
                  <Switch expression="$HRspCd">
                     <Case value="AG8001"/>  <!--主机无此交易更新前置为失败-->
                     <Case value="AG8981"/>
                     <Case value="SC6129">
                        <Set>HTxnSt=X</Set>
                        <Set>TxnSts=X</Set>
                        <Exec func="PUB:ExecSql" error="IGNORE">
                           <Arg name="SqlCmd" value="UpdJnlSts"/>
                        </Exec>
                        <Break/>
                     </Case>
                     <Case value="SC6034">
                        <Set>HTxnSt=C</Set>
                        <Set>TxnSts=C</Set>
                        <Exec func="PUB:ExecSql" error="IGNORE">
                           <Arg name="SqlCmd" value="UpdJnlSts"/>
                        </Exec>
                        <Break/>
                     </Case>
                     <Default>
                        <Break/>
                     </Default>
                  </Switch>
                  <Break/>
               </Case>
               <Case value="0">    <!--主机交易成功-->
                  <If condition="$CrcSts!=Y"> <!--主机返回抹帐-->
                     <Set>HTxnSt=S</Set>
                     <Set>TxnSts=S</Set>
                  </If>
                  <Else>                      <!--主机返回正常-->
                     <Set>HTxnSt=C</Set>
                     <Set>TxnSts=C</Set>
                  </Else>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="UpdJnlSts"/>
                  </Exec>
                  <Break/>
               </Case>
               <Default>
                  <Break/>
               </Default>
            </Switch>
         </While>
         <Exec func="PUB:CloseCursor"/>
      </Process>
   </Function>

   <!--分行特色业务空白重要凭证单张付出，供分行特色应用调用-->
   <!--需要的参数：VchCod凭证代码,VchNo凭证号码(可选),BrNo分行号-->
   <Function name="AFE_VchPay" desc="单张凭证付出">
      <!--黄炯亮,20060512新增GetCtlInf-->
      <DynSentence name="GetCtlInf"><!--取凭证信息-->
         <Sentence>
            SELECT LstBal,InCom,PayOut,PayRvk,HndIn,PayDes,Bal,ClrFlg FROM pubvchctl
            WHERE TlrId='%s' and VBFlg='%s' and VchCod='%s' and
            ActDat='%s'
         </Sentence>
         <Fields>TlrId|VBFlg|VchCod|ActDat|</Fields>
      </DynSentence>
      <DynSentence name="MQ_GetTlrInf"><!--取柜员信息-->
         <Sentence>
            SELECT TlrOrg,TlrNam,TlrTyp,TlrVch,VBoxFl,bVltInd,BkNo from cimtlrtbl
            WHERE TlrId='%s' and  '%s'>=EffDat and EprDat>='%s'
         </Sentence>
         <Fields>iTlrId|ActDat|ActDat|</Fields>
      </DynSentence>
      <DynSentence name="GetVchInf"><!--取凭证信息-->
         <Sentence>
            SELECT NumFlg,DelFlg,NumLen,PreLen  FROM pubvchinf
            WHERE BrNo='%s' and VchCod='%s'
         </Sentence>
         <Fields>BrNo|VchCod|</Fields>
      </DynSentence>
      <DynSentence name="GetVRecId"><!--取待处理凭证信息-->
         <Sentence>
            SELECT VRecId,BegNo,CurNo,EndNo FROM pubvchmng
            WHERE BrNo='%s' and NodNo='%s' and TlrId='%s' and VBFlg='%s' and VchCod='%s'
            and (('%s'='2' and PreNum='%s' and CurNo='%s') OR '%s'!='2')
            and VchSts='0'
         </Sentence>
         <Fields>BrNo|NodNo|TlrId|VBFlg|VchCod|NumFlg|PreNum|oCurNo|NumFlg|</Fields>
      </DynSentence>
      <DynSentence name="DelVchMng"><!--删除凭证箱记录-->
         <Sentence>
            DELETE FROM pubvchmng
            WHERE VRecId='%s'
         </Sentence>
         <Fields>VRecId|</Fields>
      </DynSentence>
      <DynSentence name="UpdVchMng"><!--更新凭证箱记录-->
         <Sentence>
            UPDATE pubvchmng
            SET (CurNo,BegNo)=('%s','%s')
            WHERE VRecId='%s'
         </Sentence>
         <Fields>nCurNo|nBegNo|VRecId|</Fields>
      </DynSentence>

      <DynSentence name="UpdVchJnl"><!--更新凭证日志-->
         <Sentence>
            UPDATE pubvchjnl
            set OvrNo='%s',VchCnt=CAST((CAST(VchCnt as BIGINT)+%s) as CHAR(10))
            WHERE BrNo='%s' and TxnNod='%s' and TxnTlr='%s'
            and VBFlg='%s' and VchCod='%s' and PreNum='%s'
            and MovDat='%s' and MovTyp='%s'
            and SubMov='%s' %s
         </Sentence>
         <Fields>OvrNo|VchCnt|BrNo|TxnNod|TxnTlr|VBFlg|VchCod|PreNum|MovDat|MovTyp|SubMov|WheCnd|</Fields>
      </DynSentence>
      <DynSentence name="UpdCtlInf"><!--更新柜员轧账控制表-->
         <Sentence>
            Update  pubvchctl
            Set ClrFlg='N'
            WHERE TlrId='%s' and VBFlg='%s' and VchCod='%s' and
            ActDat='%s'
         </Sentence>
         <Fields>TlrId|VBFlg|VchCod|ActDat|</Fields>
      </DynSentence>
      <Process>
         <!--Begin 黄炯亮,20060512新增-->
         <Set>MovDat=$ActDat</Set>
         <Set>TxnNod=$NodNo</Set>
         <Set>TxnTlr=$TlrId</Set>
         <Set>MovTyp=3</Set>
         <Set>SubMov=0</Set>
         <Set>iTlrId=$TlrId</Set>
         <!--End 黄炯亮,20060512新增-->

         <!--读取凭证种类信息-->
         <Exec func="PUB:ReadRecord" error="IGNORE">    <!--获取凭证参数-->
            <Arg name="SqlCmd" value="GetVchInf"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=329999</Set>
            <Set>RspMsg=取凭证参数信息错</Set>          <!-- 提示:取凭证参数信息错 -->
            <Return/>
         </If>
         <!--黄炯亮,20060512修改，$NumFlg后面多了个")"-->
         <If condition="INTCMP($NumFlg,4,0)">          <!--如是有号凭证-->
            <If condition="INTCMP(STRLEN($VchNo),4,ADD($PreLen,$NumLen))"> <!--提示：凭证号码错(长度不足)-->
               <Set>RspCod=329999</Set>
               <Set>RspMsg=凭证号码输入错</Set>
            </If>
            <Set>PreNum=LEFTSTR($VchNo,$PreLen)</Set>
            <Set>StrNo=RIGHTSTR($VchNo,$NumLen)</Set>
            <Set>OvrNo=RIGHTSTR($VchNo,$NumLen)</Set>
         </If>
         <Set>VchCnt=1</Set>
         <Set>VBFlg=0</Set>
         <Set>SeqNo=1</Set>
         <Set>ReMark=正常付出</Set>
         <Set>VchNum=1</Set><!--凭证种类数量-->

         <!--检查柜员是否凭证箱柜员-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="MQ_GetTlrInf"/>
         </Exec>

         <If condition="~RetCod!=0">
            <Set>RspCod=329999</Set>
            <Set>RspMsg=取柜员信息错</Set>          <!-- 提示:取柜员信息错 -->
            <Return/>
         </If>
         <If condition="IS_EQUAL_STRING($TlrVch,1)">
            <Set>RspCod=329999</Set>
            <Set>RspMsg=交易柜员非凭证柜员</Set>
            <Return/>
         </If>
         <If condition="IS_NOEQUAL_STRING($VBoxFl,1)">
            <Set>RspCod=329999</Set>
            <Set>RspMsg=柜员没有凭证箱</Set>
            <Return/>
         </If>

         <!--检查柜员是否有当前凭证或库存是否足够-->
         <Set>oCurNo=ADDCHAR(SUB($StrNo,1),$NumLen,0,1)</Set>
         <Exec func="PUB:ReadRecord" error="IGNORE">    <!--获取凭证参数-->
            <Arg name="SqlCmd" value="GetVRecId"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=329999</Set>
            <Set>RspMsg=控号凭证号码错或凭证箱内已无可付出凭证</Set>          <!-- 提示:取凭证参数信息错 -->
            <Return/>
         </If>

         <!--更新柜员凭证箱中的当前序号和数量-->
         <Set>nCurNo=$OvrNo</Set>
         <Set>nBegNo=ADDCHAR(ADD($OvrNo,1),$NumLen,0,1)</Set>
         <If condition="INTCMP($NumFlg,3,2)">           <!--控号凭证-->
            <If condition="INTCMP(ADD($CurNo,1),3,$EndNo)"><!--最后一张凭证-->
               <!--删除当前记录-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="DelVchMng"/>
               </Exec>
            </If>
            <Else>
               <!--黄炯亮,20060512修改，OvrNo加一 -->
               <!--修改当前记录的CurNo＝OvrNo-->
               <!--Set>nCurNo=ADDCHAR(ADD($OvrNo,1),$NumLen,0,1)</Set-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdVchMng"/>
               </Exec>
            </Else>
         </If>
         <Else>                               <!--不控号凭证-->
            <If condition="INTCMP($CurNo,3,1)">         <!--最后一张凭证-->
               <!--删除当前记录-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="DelVchMng"/>
               </Exec>
            </If>
            <Else>
               <!--修改当前记录的CurNo＝CurNo-1-->
               <Set>nCurNo=SUB($CurNo,1)</Set>
               <Set>nBegNo=$BegNo</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdVchMng"/>
               </Exec>
            </Else>
         </Else>

         <!--更新凭证流水记录-->
         <If condition="INTCMP($NumFlg,3,2)">           <!--控号凭证-->
            <Set>WheCnd=STRCAT(and OvrNo=',$CurNo,')</Set>
         </If>
         <Else>
            <Set>WheCnd= </Set>
         </Else>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <!--黄炯亮,20060512修改，UpdVchMng改为UpdVchJnl-->
            <Arg name="SqlCmd" value="UpdVchJnl"/>
         </Exec>
         <If condition="~RetCod=-2"><!--新增流水-->
            <Set>BegNo=$StrNo</Set>
            <!--黄炯亮,20060512修改，去掉error="IGNORE"-->
            <Exec func="PUB:GetLogNo"/>   <!--获取流水号-->
            <Set>VchLog=$LogNo</Set>
            <Exec func="PUB:InsertRecord">
               <Arg name="TblNam" value="pubvchjnl"/>
            </Exec>
         </If>
         <ElseIf condition="~RetCod!=0">
            <Set>RspCod=329999</Set>
            <Set>RspMsg=操作凭证调拨记录表失败</Set>
            <Return/>
         </ElseIf>

         <!--更新柜员凭证轧账表状态为N-->
         <!--黄炯亮,20060512修改，添加error="IGNORE" -->
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlString" value="UpdCtlInf" />
         </Exec>
         <If condition="~RetCod=-2"><!--新增记录-->
            <Set>LstBal=0</Set>
            <Set>PayOut=0</Set>
            <Set>PayRvk=0</Set>
            <Set>HndIn=0</Set>
            <Set>PayDes=0</Set>
            <Set>Bal=0</Set>
            <Set>ClrFlg=N</Set>
            <Set>VchLog=$LogNo</Set>
            <Exec func="PUB:InsertRecord">
               <!--黄炯亮,20060512修改，pubvchjnl改为pubvchctl-->
               <Arg name="TblNam" value="pubvchctl"/>
            </Exec>
         </If>
         <ElseIf condition="~RetCod!=0">
            <Set>RspCod=329999</Set>
            <Set>RspMsg=操作凭证控制表失败</Set>
            <Return/>
         </ElseIf>

         <Set>TActDat=$ActDat</Set>
         <Set>RspCod=000000</Set>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCtlInf"/>
         </Exec>
         <If condition="~RetCod=0">
            <If condition="STRCMP($TActDat,$ActDat)=1">
               <Set>ActDat=$TActDat</Set>
               <Set>InCom=$VchCnt</Set>

               <!--将pubvchctl里的其他字段置为0-->
               <Set>LstBal=0</Set>
               <Set>PayOut=0</Set>
               <Set>PayRvk=0</Set>
               <Set>HndIn=0</Set>
               <Set>PayDes=0</Set>
               <Set>Bal=0</Set>
               <Set>ClrFlg=N</Set>
               <Exec func="PUB:InsertRecord">
                  <Arg name="TblNam"  value="pubvchctl"/>
               </Exec>
            </If>
            <ElseIf condition="STRCMP($TActDat,$ActDat)=0">
               <Set>InCom=ADD($InCom,$VchCnt)</Set>
               <Set>Bal=ADD($Bal,$VchCnt)</Set>
            </ElseIf>
            <Else>
               <Set>RspCod=329999</Set>
               <Set>RspMsg=交易日期错误</Set>
               <Exec func="PUB:RollbackWork"/>
               <Goto>DealReturn</Goto>
            </Else>
         </If>
         <ElseIf condition="~RetCod=-2"><!--新增柜员凭证控制记录-->
            <Set>RspCod=000000</Set>
            <Set>ActDat=$TActDat</Set>
            <Set>InCom=$VchCnt</Set>
            <!--将pubvchctl里的其他字段置为0-->
            <Set>LstBal=0</Set>
            <Set>PayOut=0</Set>
            <Set>PayRvk=0</Set>
            <Set>HndIn=0</Set>
            <Set>PayDes=0</Set>
            <Set>Bal=0</Set>
            <Set>ClrFlg=N</Set>
            <Exec func="PUB:InsertRecord">
               <Arg name="TblNam" value="pubvchctl"/>
            </Exec>
         </ElseIf>
         <Else>
            <Set>RspCod=329999</Set>
            <Set>RspMsg=操作凭证控制表失败</Set>
         </Else>
      </Process>
   </Function>


   <Function name="AFE_ChkDtl_B" desc="对明细模式二,银行对账">
      <Quote name="Def_TxnChk"/>

      <DynSentence name="ChkThdInf"><!--检查单位对账状态-->
         <Sentence>
            SELECT Status,TChkNo,ChkDtlRsl  FROM  savthdinf  WHERE BrNo='%s' and CAgtNo='%s'
         </Sentence>
         <Fields>BrNo|CAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="ClrTxnChk"><!--清理对账临时表记录-->
         <Sentence>
            DELETE  FROM  afetxnchk  WHERE CAgtNo='%s'
         </Sentence>
         <Fields>CAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="PreTxnJnl"><!--准备对账记录-->
         <Sentence>
            Update afetxnjnl set (ThdChk,TChkNo,ChkFlg)=('0','%s','0')
            %s
         </Sentence>
         <Fields>TChkNo|WhereCnd|</Fields>
      </DynSentence>

      <DynSentence name="TxnJnl_Sts"><!--A表记录状态更新-->
         <Sentence>
            Update afetxnjnl set (ThdChk,ChkFlg)=('%s','%s')
            %s
         </Sentence>
         <Fields>ThdChk|ChkFlg|WhereCnd|</Fields>
      </DynSentence>
      <DynSentence name="TxnChk_Sts"><!--B表记录状态更新-->
         <Sentence>
            Update afetxnchk set (ChkFlg)=('%s')
            %s
         </Sentence>
         <Fields>ChkFlg|WhereCnd|</Fields>
      </DynSentence>

      <DynSentence name="UpdThdInf"><!--更新第三方信息表-->
         <Sentence>
            UPDATE savthdinf SET(TChkNo,ChkDtlRsl)=('%s','%s')
            WHERE BrNo='%s' and CAgtNo='%s'
         </Sentence>
         <Fields>TChkNo|ChkDtlRsl|BrNo|CAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="QryJnl"><!--查询不带扩展表业务流水-->
         <Sentence>
            SELECT *  FROM  afetxnjnl  WHERE %s
         </Sentence>
         <Fields>QryCnd|</Fields>
      </DynSentence>
      <DynSentence name="QryJnlExt"><!--查询带扩展表流水-->
         <Sentence>
            %s
         </Sentence>
         <Fields>QryCnd|</Fields>
      </DynSentence>
      <Process>
         <Set>LckKey=STRCAT($AplCls,:,savthdinf,:,$BrNo,:,$CAgtNo)</Set>
         <Exec func="PUB:Lock" error="IGNORE"><!-- 通过加锁控制批次状态 -->
            <Arg name="RecKey" value="$LckKey"/>
            <Arg name="TimOut" value="3000"/>
            <Arg name="AutoUnlock" value="yes"/>
         </Exec>
         <If condition="INTCMP(~RetCod,4,0)"><!--加锁失败-->
            <Set>RspCod=478004</Set>
            <Return/>
         </If>
         <Exec func="PUB:GetAppInfo"/>
         <Quote name="Do_TxnChk"/>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkThdInf"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=478799</Set>
            <Set>RspMsg=查询第三方单位状态信息错</Set>
            <Return/>
         </If>
         <If condition="IS_NOEQUAL_STRING($Status,C)">
            <Set>RspCod=478799</Set>
            <Set>RspMsg=当前非对账状态，不可对账</Set>
            <Return/>
         </If>
         <If condition="IS_NOEQUAL_STRING($ChkDtlRsl,0)">
            <Set>RspCod=478799</Set>
            <Set>RspMsg=当前状态为已对账，不可重新对账</Set>
            <Return/>
         </If>

         <!--从第三方获取数据文件-->
         <Switch expression="@PARA.RcvMod">
            <Case value="0">
               <Exec func="PUB:FtpGet" error="IGNORE"><!--从第三方系统获取文件-->
                  <Arg name="FtpId"     value="@PARA.FtpId"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478799</Set>
                  <Set>RspMsg=接收文件时发生错误</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Case value="1">
               <Exec func="PUB:HiFtpGet" error="IGNORE">
                  <Arg name="FtpId"     value="@PARA.FtpId"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478302</Set>
                  <Set>RspMsg=接收文件时发生错误</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Case value="2">
               <Exec func="PUB:IsExistFile" error="IGNORE">
                  <Arg name="FileName"  value="STRCAT($LclDir,$FilNam)"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=478799</Set>
                  <Set>RspMsg=文件不存在</Set>
                  <Return/>
               </If>
               <Break/>
            </Case>
            <Default>
               <Set>RspCod=478600</Set>
               <Set>RspMsg=接收文件模式 </Set>
               <Return/>
            </Default>
         </Switch>

         <!--文件入库前的个性加工-->
         <If condition="INTCMP(@PARA.NeedPrep_Fil,3,1)">
            <Call function="@PARA.IddFunc_PreFil"/>
         </If>

         <!--取对账序号-->
         <Exec func="PUB:nGetPubSeqNo">
            <Arg name="SeqNam" value="savthdinf:TChkNo"/>
            <!--BTP文件记录标识-->
            <Arg name="Len" value="4"/>
            <!--序号长度-->
         </Exec>
         <Set>TChkNo=STRCAT($ActDat,$SelVal)</Set>
         <!--清理对账临时表中的记录-->
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="ClrTxnChk"/>
         </Exec>
         <If condition="~RetCod=0">
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
         </ElseIf>
         <Else>
            <Return/>
         </Else>

         <!--第三方文件入库,注意入库时须置对账标志为0和对账批次号为TChkNo-->
         <Set>File=STRCAT($LclDir,$FilNam)</Set>
         <Exec func="PUB:ImportToDB">
            <!--将文件拆分入批量明细表-->
            <Arg name="FormatName" value="@PARA.FmtNam"/>
            <Arg name="FileName" value="$File"/>
            <Arg name="TableName" value="afetxnchk"/>
            <Arg name="ApplyLogNoFlag" value="0"/>
         </Exec>

         <!--文件入库后的个性加工-->
         <If condition="INTCMP(@PARA.NeedPrep_DB,3,1)">
            <Call function="@PARA.IddFunc_PreDB"/>
         </If>

         <!--对账,A表AFETXNJNL，B表AFETXNCHK-->

         <!--更新A表中所有未对账记录的对账标志为0,同时更新对账批次号-->
         <If condition="INTCMP(STRLEN(@PARA.QryCnd),1,3)">
            <!--未设置条件-->
            <Set>RspCod=478799</Set>
            <Set>RspMsg=未设置对账范围，请与技术人员联系</Set>
            <Return/>
         </If>
         <Set>WhereCnd=@PARA.QryCnd</Set>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="PreTxnJnl"/>
         </Exec>
         <If condition="~RetCod=0">
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
         </ElseIf>
         <Else>
            <Return/>
         </Else>

         <If condition="@PARA.IddChkMod=1">
            <Call function="@PARA.IddFunc_Chk"/>
         </If>
         <Else>
            <Set>ThdChk=1</Set><!--与第三方对账标志，0未对账1已对账-->
            <Set>TmpCnd= FROM afetxnjnl a,afetxnchk b </Set>
            <!--更新A表中所有与B表数据相符的记录-->
            <Set>ChkFlg=1</Set><!--对账结果0未处理1成功2错误3单边-->
            <Set>WhereCnd=STRCAT(WHERE \( ThdKey \)  in, )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,\(SELECT b.ThdKey,$TmpCnd)</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,WHERE b.TChkNo=',$TChkNo,' and b.TChkNo=a.TChkNo and b.ThdKey=a.ThdKey )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,AND cast\(a.TxnAmt as bigint\) = cast\(b.TxnAmt as bigint\))</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,AND a.HTxnSt = 'S'\))</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="TxnJnl_Sts"/>
            </Exec>
            <If condition="~RetCod=0">
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
            <!--更新B表中所有与A表数据相符的记录-->
            <Set>ChkFlg=1</Set><!--对账结果0未处理1成功2错误3单边-->
            <Set>WhereCnd=STRCAT(WHERE \( ThdKey \)  in, )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,\(SELECT a.ThdKey,$TmpCnd)</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,WHERE a.TChkNo=',$TChkNo,' and a.TChkNo=n.TChkNo and a.ThdKey=b.ThdKey )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,AND cast\(a.TxnAmt as bigint\) = cast\(b.TxnAmt as bigint\) )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,AND a.HTxnSt = 'S'\) )</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="TxnChk_Sts"/>
            </Exec>
            <If condition="~RetCod=0">
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
            <!--更新A表中所有与B表数据不相符的记录-->
            <Set>ChkFlg=2</Set><!--对账结果0未处理1成功2错误3单边-->
            <Set>WhereCnd=STRCAT(WHERE \( ThdKey \)  in, )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,\(SELECT b.ThdKey,$TmpCnd)</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,WHERE b.TChkNo=',$TChkNo,' and b.TChkNo=a.TChkNo and b.ThdKey=a.ThdKey )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,AND cast\(a.TxnAmt as bigint\) != cast\(b.TxnAmt as bigint\))</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,AND a.HTxnSt = 'S'\))</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="TxnJnl_Sts"/>
            </Exec>
            <If condition="~RetCod=0">
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
            <!--更新B表中所有与A表数据不相符的记录-->
            <Set>ChkFlg=2</Set><!--对账结果0未处理1成功2错误3单边-->
            <Set>WhereCnd=STRCAT(WHERE \( ThdKey \)  in, )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,\(SELECT a.ThdKey,$TmpCnd)</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,WHERE a.TChkNo=',$TChkNo,' and a.TChkNo=b.TChkNo and a.ThdKey=b.ThdKey )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,AND cast\(a.TxnAmt as bigint\) != cast\(b.TxnAmt as bigint\) )</Set>
            <Set>WhereCnd=STRCAT($WhereCnd,AND a.HTxnSt = 'S'\) )</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="TxnJnl_Sts"/>
            </Exec>
            <If condition="~RetCod=0">
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
            <!--更新A表中所有未对账的记录-->
            <Set>ChkFlg=3</Set><!--对账结果0未处理1成功2错误3单边-->
            <Set>WhereCnd=STRCAT(WHERE TChkNo=',$TChkNo,' and ThdChk=0)</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="TxnJnl_Sts"/>
            </Exec>
            <If condition="~RetCod=0">
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
            <!--更新B表中所有未对账的记录-->
            <Set>ChkFlg=3</Set><!--对账结果0未处理1成功2错误3单边-->
            <Set>WhereCnd=STRCAT(WHERE TChkNo=',$TChkNo,' and ThdChk=0)</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="TxnJnl_Sts"/>
            </Exec>
            <If condition="~RetCod=0">
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
            <!--更新第三方信息表的对账批次号为TChkNo，状态为已对账-->
            <Set>ChkDtlRsl=1</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="UpdThdInf"/>
            </Exec>
            <If condition="~RetCod=0">
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
         </Else>

         <!--生成对账文件并按指定方式发送文件-->
         <If condition="INTCMP(@PARA.GathFmt,3,1)"><!--需要按FMT生成文件-->
            <Set>QryCnd=@PARA.QryCnd</Set>
            <Set>FmtCnt=STRGETCOUNT(@PARA.FmtLst,|)</Set>
            <While condition="INTCMP($FmtCnt,6,0)">
               <Set>FmtNam=GETWORDDELIMITER(@PARA.FmtLst,|,$FmtCnt)</Set>
               <Set>LclFil=GETWORDDELIMITER(@PARA.FmtSFilLst,|,$FmtCnt)</Set>
               <Set>ObjFil=GETWORDDELIMITER(@PARA.FmtOFilLst,|,$FmtCnt)</Set>
               <Set>FilNam=STRCAT(@PARA.FilDir,$LclFil)</Set>
               <If condition="@PARA.ExtFlg=1"><!--带扩展表-->
                  <Exec func="PUB:ExportFromDB"><!--生成清单拷盘文件-->
                     <Arg name="FormatName" value="$FmtNam"/>
                     <Arg name="FileName" value="$FilNam"/>
                     <Arg name="TableName" value="afetxnjnl"/>
                     <Arg name="SqlName" value="QryJnlExt"/>
                  </Exec>
               </If>
               <Else><!--不带扩展表-->
                  <Exec func="PUB:ExportFromDB"><!--生成清单拷盘文件-->
                     <Arg name="FormatName" value="$FmtNam"/>
                     <Arg name="FileName" value="$FilNam"/>
                     <Arg name="TableName" value="afetxnjnl"/>
                     <Arg name="SqlName" value="QryJnl"/>
                  </Exec>
               </Else>
               <Set>FmtCnt=SUB($FmtCnt,1)</Set>
               <Switch expression="@PARA.SndMod">
                  <Case value="0"> <!--Ftp发出-->
                     <Set>FtpId=@PARA.FtpId</Set>
                     <Exec func="PUB:FtpPut" error="IGNORE">
                        <Arg name="FtpId" value="@PARA.FtpId"/>
                     </Exec>
                     <If condition="~RetCod!=0">
                        <Set>RspCod=478617</Set>
                        <Set>RspMsg=对账文件</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="1"> <!--HiFtp发出-->
                     <Exec func="PUB:HiFtpPut" error="IGNORE">
                        <Arg name="FtpId" value="@PARA.FtpId"/>
                     </Exec>
                     <If condition="~RetCod!=0">
                        <Set>RspCod=478617</Set>
                        <Set>RspMsg=对账文件</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="2"> <!--放在本地-->
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478600</Set>
                     <Set>RspMsg=对账文件发送模式</Set>
                     <Return/>
                  </Default>
               </Switch>
            </While>
         </If>
         <If condition="INTCMP(@PARA.GathRpt,3,1)"><!--需要按RPT生成文件-->
            <Set>FMTCnt=STRGETCOUNT(@PARA.RptLst,|)</Set>
            <While condition="INTCMP($FmtCnt,6,0)">
               <Set>FmtNam=GETWORDDELIMITER(@PARA.RptLst,|,$FmtCnt)</Set>
               <Set>LclFil=GETWORDDELIMITER(@PARA.RptSFilLst,|,$FmtCnt)</Set>
               <Set>ObjFil=GETWORDDELIMITER(@PARA.RptOFilLst,|,$FmtCnt)</Set>
               <Set>FilNam=STRCAT(@PARA.RptDir,$LclFil)</Set>
               <Set>RptDat=@PARA.RptDat</Set>
               <Exec func="PUB:GenerateReport">
                  <Arg name="ObjFil"  value="$FilNam"/>
                  <Arg name="FmtFil"  value="$FmtNam"/>
                  <Arg name="CAgtNo"  value="$CAgtNo"/>
                  <Arg name="RptDat"  value="$RptDat"/>
                  <Arg name="TlrId"   value="$TlrId"/>
               </Exec>
               <Set>FmtCnt=SUB($FmtCnt,1)</Set>
               <Switch expression="@PARA.RptSndMod">
                  <Case value="0"> <!--Ftp发出-->
                     <Exec func="PUB:FtpPut" error="IGNORE">
                        <Arg name="FtpId" value="@PARA.RptFtpId"/>
                     </Exec>
                     <If condition="~RetCod!=0">
                        <Set>RspCod=478617</Set>
                        <Set>RspMsg=对账清单</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="1"> <!--HiFtp发出-->
                     <Exec func="PUB:HiFtpPut" error="IGNORE">
                        <Arg name="FtpId" value="@PARA.RptFtpId"/>
                     </Exec>
                     <If condition="~RetCod!=0">
                        <Set>RspCod=478617</Set>
                        <Set>RspMsg=对账清单</Set>
                        <Return/>
                     </If>
                     <Break/>
                  </Case>
                  <Case value="2"> <!--放在本地-->
                     <Break/>
                  </Case>
                  <Default>
                     <Set>RspCod=478600</Set>
                     <Set>RspMsg=对账清单发送模式</Set>
                     <Return/>
                  </Default>
               </Switch>
            </While>
         </If>
         <If condition="INTCMP(@PARA.NeedNotice,3,1)"><!--需要通知第三方-->
            <!-- 调用第三方交易-->
            <Exec func="PUB:CallThirdOther" error="IGNORE">
               <Arg name="HTxnCd" value="@PARA.NoticeCod"/>
               <Arg name="ObjSvr" value="@PARA.NoticeSvr"/>
            </Exec>
            <If condition="INTCMP(~RetCod,1,0)">
               <Set>RspCod=478615</Set>
               <Set>RspMsg=调用第三方时:系统错误或超时或未发送,请检查后重做 </Set>
               <Return/>
            </If>
            <Set>inTRspCd=STRCAT(|,$TRspCd,|)</Set>
            <If condition="INTCMP(GETSTRPOS(@PARA.TRsp_Suc,$inTRspCd),1,0)">
               <Set>RspCod=478615</Set><!--对账不成功-->
               <Set>RspMsg=STRCAT(第三方返回: ,$TRspCd)</Set>
               <Return/>
            </If>
            <Else>
               <Set>RspCod=000000</Set>
            </Else>
         </If>

      </Process>
   </Function>
</Package>
