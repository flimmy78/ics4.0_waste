<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="LOTA" code="454">
   <!--广东省福彩业务本地主控-->

   <ConfigDeclare>
      <!--Config name="BatFormat"   value="etc/PSSA_FMT.XML"/-->
      <Config name="OPFCSW"      value="etc/LOT_CSW_441999.XML"/>
      <!--Config name="ParaFile"    value="etc/PSSA_CFG.XML"/-->
   </ConfigDeclare>
   <PackageDeclare>
      <Package name="LOT_PKG" value="etc/LOT_PKG.XML"/>
   </PackageDeclare>
   <BusDefDeclare>
      <Busdef name="AplCls"    value="454"/> <!--add by xuan_20101108-->
      <Busdef name="RcvPth"    value="dat/ssa" /> <!--接收目录-->
      <Busdef name="TrmRcv"    value="dat/term/recv" /> <!--终端接收目录-->
      <Busdef name="TrmSnd"    value="dat/term/send" /> <!--终端发送目录-->
      <Busdef name="DealId"    value="141" /> <!--运营商编号-->
      <Busdef name="DSCAgtNo"  value="4410001871" />     <!--代收单位编号  TEST编号-->
      <Busdef name="DFCAgtNo"  value="4410001882" />     <!--代发单位编号 TEST编号-->
      <Busdef name="DFActNo"   value="441001012620196589599" />     <!--代发内部账，TEST-->
      <Busdef name="HSActNo"   value="" />     <!--华祥对公账，TEST-->
   </BusDefDeclare>
   <TableDeclare>
      <Table name="afetxnjnl"     value="afetxnjnl"/>     <!--业务流水表-->
      <Table name="lotsyscfg"     value="lotsyscfg"/>    <!--平台参数表-->
      <Table name="lotcusinf"     value="lotcusinf"/>    <!--福彩用户表-->
      <Table name="lotautpln"     value="lotautpln"/>    <!--定投计划表-->
      <Table name="lottxnjnl"     value="lottxnjnl"/>    <!--投注流水表-->
      <Table name="lotchkctl"     value="lotchkctl"/>    <!--对账控制表-->
      <Table name="lotchkdtl"     value="lotchkdtl"/>    <!--对账明细表-->
      <Table name="lotdrwtbl"     value="lotdrwtbl"/>    <!--奖期信息表-->
      <Table name="lotprzinf"     value="lotprzinf"/>    <!--开奖公告表-->
      <Table name="lotdrwtbl"     value="lotdrwtbl"/>    <!--奖期信息表-->
      <Table name="lotprzinf"     value="lotprzinf"/>    <!--开奖公告表-->
      <Table name="lotprzctl"     value="lotprzctl"/>    <!--中奖记录控制表-->
      <Table name="lotprzdtl"     value="lotprzdtl"/>    <!--中奖记录明细表-->
      <Table name="lotawddtl"     value="lotawddtl"/>    <!--返奖奖记录明细表-->
   </TableDeclare>
   <GlobalFunction>
      <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
      <Function name="_after">
         <Process>
            <If condition="ISNULL($MsgTyp)">
               <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                  <Set>MsgTyp=N</Set>
                  <Set>RspCod=000000</Set>
               </If>
               <Else>
                  <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                     <Set>MsgTyp=E</Set>
                  </If>
                  <Else>
                     <Set>MsgTyp=N</Set>
                  </Else>
               </Else>
            </If>
         </Process>
      </Function>
   </GlobalFunction>

   <Define>
      <Macro name="Init_Trans"><!--初始化脚本-->
         <Exec func="PUB:GetBranchNoByNodeNo"></Exec>   <!--根据网点号取分行代码-->
         <Exec func="PUB:InitTransaction"></Exec>  <!--交易初始化,预留-->
         <Set>FTxnTm=GETDATETIME()</Set><!--前置平台系统时间-->
      </Macro>
      
      <Macro name="TlrAuthOper"><!--授权处理操作-->
         <!--添加授权原因-->
         <Exec func="PUB:AddAuthReason">
            <Arg name="AthCod" value="40"></Arg><!--4+0授权-->
            <Arg name="AthMsg" value="$TTxnCd"></Arg><!--授权原因-->
         </Exec>
         <!--授权-->
         <Exec func="PUB:CheckLocalAuth">
            <Arg name="ObjSvr" value="SHSTPUB1"></Arg>
         </Exec>
      </Macro>

      <Macro name="SendMSM">
        <!--短信通知-->
        <!--短信通知-->
        <!--短信通知-->
        <Set>SvrId=9901</Set>  <!--渠道代码99代表分行-->
        <Set>SndFlg=0</Set>
        <Set>BrNo=441999</Set>
        <Set>ActNo=000000000000000000</Set>
        <Set>CusId=441999xxxxxxx</Set>
        <Exec func="PUB:CallThirdOther" error="IGNORE">
          <Arg name="HTxnCd" value="463130"/>
          <Arg name="ObjSvr" value="STHDSFM2"/>
        </Exec>
      </Macro>     

      <Macro name="GenerateNonTckNo"><!-- 申请主机非会计流水 -->
         <Set>TxnTm=GETDATETIME()</Set>
         <If condition="ISNULL(DELBOTHSPACE($TxnDesc))">
            <Set>NoteInfo=STRCAT(交易码-,$TxnCod,机构-,$NodNo,柜员-,$TlrId,时间-,$TxnTm,$TxnDesc)</Set>
         </If>
         <Else>
            <Set>NoteInfo=STRCAT(交易码-,$TxnCod,机构-,$NodNo,柜员-,$TlrId,时间-,$TxnTm)</Set>
         </Else>
         <Exec func="PUB:CallHostOther">
            <Arg name="HTxnCd" value="455130"></Arg>
            <Arg name="ObjSvr" value="SHSTPUB1"></Arg>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>MstTyp=E</Set>
            <Set>RspCod=SSA999</Set>
            <Set>RspMsg=申请主机非会计流水失败!</Set>
            <Return/>
         </If>
      </Macro>
   </Define>

   <Transaction code="485404" desc="用户注册"> 
      <DynSentence name="ChkCrdCnt"><!--检查卡号是否已注册-->
         <Sentence>
          SELECT  count(LotNam) CrdCnt
          FROM    lotcusinf
          WHERE   CrdNo='%s'  and Status='1'
         </Sentence>
         <Fields>CrdNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkMobCnt"><!--检查手机号是否已注册-->
         <Sentence>
          SELECT  count(LotNam) MobCnt
          FROM    lotcusinf
          WHERE   MobTel='%s'  and Status='1'
         </Sentence>
         <Fields>MobTel|</Fields>
      </DynSentence>
      <DynSentence name="InsCusInf"><!--登记福彩用户表-->
        <Sentence>
          INSERT INTO lotcusinf(BrNo,CusNam,CrdNo,ActNo,ActNod,IdTyp,IdNo,MobTel,FixTel,LotNam,LotPsw,RegTim,Email,CityId,SEX,Status)
          VALUES('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')
        </Sentence>
        <Fields>ActBr|CusNam|CrdNo|ActNo|ActNod|IdTyp|IdNo|MobTel|FixTel|LotNam|LotPsw|RegTim|Email|CityId|Gender|Status|</Fields>
      </DynSentence>
      <Attributes>
        <Attribute name="nodatabase" value="2"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init_Trans"></Quote><!--交易初始化-->
         
         <!--检查卡号是否已注册-->
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd"        value="ChkCrdCnt"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         <If condition="INTCMP($CrdCnt,6,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=STRCAT(卡号:,$CrdNo,已注册)</Set>
            <Return/>
         </If>
         <!--检查手机号是否已使用-->
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd"        value="ChkMobCnt"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         <If condition="INTCMP($MobCnt,6,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=STRCAT(手机号码:,$MobTel,已注册)</Set>
            <Return/>
         </If>

         <Set>OIdNo=$IdNo</Set> <!--保留上送的身份证号码-->    

         <!--向核心获取客户开卡信息-->
         <Set>TTxnCd=207120</Set>
         <Exec func="PUB:GetVirtualTeller" >
            <Arg name="TxnCnl" value="PIN"/>
         </Exec>
         <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="HTxnCd" value="207120"/>
            <Arg name="ObjSvr" value="SHSTSSAA"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=查询客户开卡信息出错</Set>
            <Return/>
         </If>   
         <!--校验姓名和身份证号码-->
         <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
         <If condition="STRCMP($CusNam,$ActNam)!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=客户姓名不符</Set>
            <Return/>
         </If>
         <Set>IdNo=DELBOTHSPACE($IdNo)</Set>
         <If condition="STRCMP($OIdNo,$IdNo)!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=身份证号码不符</Set>
            <Return/>
         </If>
         <!--登记福彩用户表-->
         <Set>LotNam=$MobTel</Set><!--彩民标识-->
         <Set>LotPsw=SPACE(1)</Set><!--彩民密码-->
         <Set>RegTim=GETDATETIME()</Set><!--注册时间-->
         <Set>Status=0</Set><!--状态为正常-->
         <Set>SubNod=SUBSTR($ActNod,1,3)</Set><!--截取账户网点前三位-->
         <Exec func="PUB:CodeSwitching" error="IGNORE">
           <Arg name="DatSrc"  value="OPFCSW"/>
           <Arg name="SourNam" value="SubNod"/>
           <Arg name="DestNam" value="CityId"/>
           <Arg name="TblNam"  value="SubNod2CityId"/>
         </Exec>
         <If condition="~RetCod!=0">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=LOT999</Set>
           <Set>RspMsg=地市编码转换出错</Set>
           <Return/>
         </If>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd"    value="InsCusInf"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=登记福彩用户表失败</Set>
            <Return/>
         </If>
         
         <!--向福彩中心发出彩民注册-->
         <Exec func="PUB:CallThirdOther"  error="IGNORE">
           <Arg name="HTxnCd" value="201"/>
           <Arg name="ObjSvr" value="STHDLOTA"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=彩民注册超时</Set>           
            <Return/>
         </If>    
         <If condition="~RetCod!=0">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=彩民注册失败</Set>           
            <Return/>
         </If>        

        <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Set>RspMsg=交易成功</Set>
         
      </FlowCtrl>
   </Transaction>

   <Transaction code="485405" desc="更改用户注册">
      <DynSentence name="ChkCrdCnt"><!--检查卡号是否已注册-->
         <Sentence>
          SELECT  count(LotNam) CrdCnt
          FROM    lotcusinf
          WHERE   CrdNo='%s'  and Status='1'
         </Sentence>
         <Fields>CrdNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkMobCnt"><!--检查手机号是否已注册-->
         <Sentence>
          SELECT  count(LotNam) MobCnt
          FROM    lotcusinf
          WHERE   MobTel='%s'  and Status='1'
         </Sentence>
         <Fields>MobTel|</Fields>
      </DynSentence>
      <DynSentence name="UpdCusInf"><!--更新福彩用户表信息-->
         <Sentence>
          UPDATE  lotcusinf
          SET    LotNam='%s',MobTel='%s',RegTim='%s'
          WHERE   CrdNo='%s'  and Status='1'
         </Sentence>
         <Fields>LotNam|MobTel|RegTim|CrdNo|</Fields>
      </DynSentence>
      <DynSentence name="QryCusInf"><!--查询注册用户信息-->
         <Sentence>
          SELECT  LotNam,LotPsw,Email,CityId,IdTyp,IdNo,CusNam
          FROM    lotcusinf
          WHERE   CrdNo='%s'  and Status='1'
         </Sentence>
         <Fields>CrdNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init_Trans"></Quote><!--交易初始化-->
         
         <!--检查卡号是否已注册-->
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd"        value="ChkCrdCnt"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         <If condition="INTCMP($CrdCnt,3,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=STRCAT(卡号:,$CrdNo,未注册)</Set>
            <Return/>
         </If>
        
         <!--检查手机号是否已使用-->
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd"        value="ChkMobCnt"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         <If condition="INTCMP($MobCnt,6,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=STRCAT(手机号码:,$MobTel,已注册)</Set>
            <Return/>
         </If>
         
         <!--修改用户表的彩民标识和手机号码、注册时间-->
         <Set>LotNam=$MobTel</Set>
         <Set>RegTim=GETDATETIME</Set>
         
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd"    value="UpdCusInf"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         
         <!-- 向福彩中心发彩民注销 -->
         <Exec func="PUB:CallThirdOther"  error="IGNORE">
           <Arg name="HTxnCd" value="219"/>
           <Arg name="ObjSvr" value="STHDLOTA"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=彩民注销超时</Set>           
            <Return/>
         </If>    
         <If condition="~RetCod!=0">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=彩民注销失败</Set>           
            <Return/>
         </If>  
         
         <!-- 向福彩中心发彩民注册 -->
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd"        value="QryCusInf"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>   
         <Exec func="PUB:CallThirdOther"  error="IGNORE">
           <Arg name="HTxnCd" value="201"/>
           <Arg name="ObjSvr" value="STHDLOTA"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=彩民注册超时</Set>           
            <Return/>
         </If>    
         <If condition="~RetCod!=0">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=彩民注册失败</Set>           
            <Return/>
         </If>

        <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Set>RspMsg=交易成功</Set>
        
      </FlowCtrl>   </Transaction>
   
   <Transaction code="485406" desc="用户注册信息查询">
      <DynSentence name="QryCusInf"><!--查询注册用户信息-->
         <Sentence>
          SELECT  LotNam,LotPsw,Email,CityId,IdTyp,IdNo,CusNam,MobTel
          FROM    lotcusinf
          WHERE   CrdNo='%s'  and Status='1'
         </Sentence>
         <Fields>CrdNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init_Trans"></Quote><!--交易初始化-->
         
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd"        value="QryCusInf"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=STRCAT(卡号:,$CrdNo,没注册)</Set>
            <Return/>
         </If>  
         
        <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Set>RspMsg=交易成功</Set>        
        
      </FlowCtrl>
   </Transaction>
      <Transaction code="481950" desc="定投计划录入">
      <DynSentence name="ChkLotUser"><!--检查用户是否已注册-->
         <Sentence>
          SELECT  LotNam, CusNam, MobTel
          FROM    lotcusinf
          WHERE   CrdNo='%s'  and Status=''
         </Sentence>
         <Fields>CrdNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init_Trans"></Quote><!--交易初始化-->
         
         <!--检查用户是否已注册-->
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd"        value="ChkLotUser"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-2"><!--不存在-->
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=该卡用户还没有注册</Set>
            <Return/>
         </ElseIf>
         
         <!--检查投注号码个数合法性-->
         <If condition="IS_NOEQUAL_STRING($GameId,5)">
            <Switch expression="$BetMod">
               <Case value="1"><!--单式-->
                  
                  <Break/>
               </Case>
               <Case value="12"><!--复式-->

                  <Break/>
               </Case>
               <Case value="13"><!--胆托-->

                  <Break/>
               </Case>
               <Default>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=LOT999</Set>
                  <Set>RspMsg=双色球没此投注方式</Set>
                  <Return/>               
               </Default>
            </Switch>
         </If>
         <Else>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=定投游戏非双色球</Set>
            <Return/>        
         </Else>

         <Exec func="PUB:nGetPubSeqNo">
            <Arg name="SeqNam" value="LOT:PlanNo"></Arg>
            <!--BTP文件记录标识-->
            <Arg name="Len" value="10"></Arg>
            <!--序号长度-->
            <Arg name="SeqCnt" value="1"></Arg>
            <!--取号个数-->
            <Arg name="CycCnd" value="Y"></Arg>
            <!--循环条件为年-->
         </Exec>
                 
         <Set>PlanNo=STRCAT(99,$ActDat,$SelVal)</Set><!-- 定投计划编号 -->
         
         <If condition="ISNULL($PlanNm)">
            <Set>PlanNm=BOCPLAN</Set><!-- 定投计划名称 -->
         </If>
         
         <If condition="IS_NOEQUAL_STRING($GameId,5)">
            <Set>GamNam=双色球</Set><!-- 游戏名称 -->
         </If>
         
         <Set>BetDat=GetDateTime(YYYYMMDD)</Set><!-- 定投日期 -->
         
         <Set>BetTim=GetDateTime()</Set><!-- 定投时间 -->
         
         <Set>Status=0</Set><!-- 定投状态 -->     
         
         <!--插入定投计划表-->
         <Exec func="PUB:InsertRecord" error="IGNORE">
            <Arg name="TblNam"         value="lotautpln"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=485199</Set>
            <Set>RspMsg=登记定投计划表失败</Set>
            <Return/>
         </If>
         <Set>MsgTyp=N</Set>
         <Set>RspCod=000000</Set>
         <Set>RspMsg=交易成功</Set>       
      </FlowCtrl>
   </Transaction>

   <Transaction code="485409" desc="定投计划明细查询">
   
      <DynSentence name="TotPlnNum">
        <Sentence>
          SELECT  count(PlanNo) as TotCnt
          FROM    lotautpln
          WHERE   CrdNo='%s' and Status='0'
        </Sentence>
        <Fields>CrdNo|</Fields>
      </DynSentence>
      <DynSentence name="QryPlnMsg">
        <Sentence>
          SELECT  PlanNo,PlanNm,MobTel,BetPer,BetLin，BetAmt,DoPer,CAST(BetPer as BIGINT) - CAST(DoPer as BIGINT) LevPer
          FROM    lotautpln
          WHERE   CrdNo='%s' and Status='0'
        </Sentence>
        <Fields>CrdNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <!-- 交易初始化,预留 -->
         <!-- <Quote name="Init_Trans" desc="交易初始化"/> -->
         
         <If condition="IS_EQUAL_STRING($TIATyp,T)">
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="TotLotNum"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=LOT999</Set>
               <Set>RspMsg=统计记录笔数失败</Set>
               <Return/>
            </If>
            <If condition="$TotCnt=0">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=LOT999</Set>
               <Set>RspMsg=无记录</Set>
               <Return/>
            </If>
         </If>

         <!--多页查询-->
         <Exec func="PUB:MultiQuery" error="IGNORE">
            <Arg name="SqlCmd" value="QryPlnMsg"/>
            <Arg name="RecKey" value="STRCAT($AplCls,485409,$CrdNo)"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=交易记录表查询失败</Set>
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=无记录</Set>
            <Return/>
         </ElseIf>
         <Set>MsgTyp=N</Set>
         <Set>RspCod=000000</Set>
         <Set>RspMsg=交易成功</Set>
      </FlowCtrl>
   </Transaction>

   <Transaction code="485410" desc="定投计划取消">
      <DynSentence name="ChkPlnRec"><!--检查文件是否已经生成了-->
        <Sentence>
          SELECT  'Y' YN FROM table(values(1)) as annoy WHERE EXISTS(
          SELECT  'Y'
          FROM    lotautpln
          WHERE   PlanNo='%s'  and CrdNo='%s' and Status='0')
        </Sentence>
        <Fields>PlanNo|CrdNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdPlnSts"><!--修改定投计划状态-->
         <Sentence>
            UPDATE lotautpln
            SET    Status = '0'
            WHERE  PlanNo='%s'  and CrdNo='%s' and Status='0'
         </Sentence>
         <Fields>PlanNo|CrdNo|</Fields>
      </DynSentence>

       <FlowCtrl>
        <Exec func="PUB:ReadRecord" error="IGNORE">
           <Arg name="SqlCmd" value="ChkPlnRec"/>
        </Exec>
        <If condition="~RetCod=-2"><!--无记录-->
           <Set>MsgTyp=E</Set>
           <Set>RspCod=LOT999</Set>
           <Set>RspMsg=无记录</Set>
           <Return/>
        </If>
        <Exec func="PUB:ExecSql" error="IGNORE">
           <Arg name="SqlCmd" value="UpdPlnSts"/>
        </Exec>
        <If condition="~RetCod=-1">
           <Exec func="PUB:RollbackWork" error="IGNORE"/>
           <Set>MsgTyp=E</Set>
           <Set>RspCod=LOT999</Set>
           <Set>RspMsg=撤销定投计划失败</Set>
           <Return/>
        </If>
        <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Set>RspMsg=交易成功</Set>
       </FlowCtrl>
   </Transaction>
   
   <Transaction code="485411" desc="定投计划执行">
      <DynSentence name="ChkPlnCtl"><!--检查该期定投是否已执行过-->
        <Sentence>
          SELECT  'Y' YN FROM table(values(1)) as annoy WHERE EXISTS(
          SELECT  'Y'
          FROM    lotplnctl
          WHERE   GameId='%s'  and DrawId='%s' )
        </Sentence>
        <Fields>GameId|DrawId|</Fields>
      </DynSentence>
      <DynSentence name="InsPlnCtl"><!--登记定投控制表-->
        <Sentence>
          INSERT INTO lotplnctl(GameId,DrawId,DrawNm,BetDat,BegTim,EndTim,TxnSts)
          VALUES('%s','%s','%s','%s','%s','%s')
        </Sentence>
        <Fields>GameId|DrawId|DrawNm|BetDat|BegTim|EndTim|TxnSts|</Fields>
      </DynSentence>
      <DynSentence name="UpdPlnCtl"><!--更新定投控制表-->
        <Sentence>
          UPDATE lotplnctl 
          SET EndTim='%s',TxnSts='%s'
          WHERE GameId='%s'  and DrawId='%s'
        </Sentence>
        <Fields>EndTim|TxnSts|GameId|DrawId|</Fields>
      </DynSentence>
      <DynSentence name="ChkDrwTbl"><!--检查该奖期是否已存在-->
        <Sentence>
          SELECT  'Y' YN FROM table(values(1)) as annoy WHERE EXISTS(
          SELECT  'Y'
          FROM    lotdrwtbl
          WHERE   GameId='%s'  and DrawId='%s' )
        </Sentence>
        <Fields>GameId|DrawId|</Fields>
      </DynSentence>
      <DynSentence name="InsDrwTbl"><!--登记奖期信息表-->
        <Sentence>
          INSERT INTO lotdrwtbl(GameId,DrawId,DrawNm,SalStr,SalEnd,CshStr,CshEnd)
          VALUES('%s','%s','%s','%s','%s','%s','%s')
        </Sentence>
        <Fields>GameId|DrawId|DrawNm|SalStr|SalEnd|CshStr|CshEnd|</Fields>
      </DynSentence>
      <DynSentence name="QryAutPln"><!--查询定投计划表-->
        <Sentence>
          SELECT　PlanNo,GameId,PlayId,BetPer,BetMet,BetMod,BetMul,BetAmt,BetLin,LotNam,CrdNo,MobTel,CurPer,CurFal,ConFal,DoPer
          FROM lotautpln
          WHERE  Status='0'
        </Sentence>
        <Fields></Fields>
      </DynSentence>
      <DynSentence name="UpdAutPln"><!--更新定投控制表-->
        <Sentence>
          UPDATE lotautpln 
          SET CurPer='%s',CurFal='%s',ConFal='%s',DoPer='%s',Status='%s'
          WHERE PlanNo='%s'  and CrdNo='%s' and LotNam='%s'
        </Sentence>
        <Fields>CurPer|CurFal|ConFal|DoPer|Status|PlanNo|CrdNo|LotNam|</Fields>
      </DynSentence>      
      <FlowCtrl>
         
         <Set>GameId=5</Set><!--游戏编号-->
         
         <!-- 申请当前期号, 奖期信息下载-->
         <Exec func="PUB:CallThirdOther"  error="IGNORE">
           <Arg name="HTxnCd" value="235"/>
           <Arg name="ObjSvr" value="STHDLOTA"/>
         </Exec>
         <If condition="~RetCod!=0">
            <!--判断定投控制表有没该期记录-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="ChkPlnCtl"/>
            </Exec>
            <If condition="~RetCod=-2"><!--无记录-->
               <Set>BetDat=GETDATETIME(YYYYMMDD)</Set>
               <Set>BegTim=GETDATETIME(HHMISS)</Set>
               <Set>EndTim=GETDATETIME(HHMISS)</Set>
               <Set>TxnSts=F</Set>
               <Exec func="PUB:ExecSql" error="IGNORE">
                  <Arg name="SqlCmd"    value="InsPlnCtl"/>
               </Exec>
               <If condition="~RetCod=-1">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=LOT999</Set>
                  <Set>RspMsg=登记定投控制表失败</Set>
                  <Return/>
               </If>              
            </If>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd"    value="UpdPlnCtl"/>
            </Exec> 
            <If condition="~RetCod=-1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=LOT999</Set>
               <Set>RspMsg=更新定投控制表失败</Set>
               <Return/>
            </If>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=定投计划执行出错</Set>           
            <Return/>
         </If>

         <!--判断定投控制表有没该期记录，没就增加一条-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkPlnCtl"/>
         </Exec>
         <If condition="~RetCod=-2"><!--无记录-->
            <Set>BetDat=GETDATETIME(YYYYMMDD)</Set>
            <Set>BegTim=GETDATETIME(HHMISS)</Set>
            <Set>EndTim= SPACE(1)</Set>
            <Set>TxnSts=U</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd"    value="InsPlnCtl"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=LOT999</Set>
               <Set>RspMsg=登记定投控制表失败</Set>
               <Return/>
            </If>              
         </If>
         
         <!-- 检查期号表有没该期号，没就插入期号表 -->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkDrwTbl"/>
         </Exec>
         <If condition="~RetCod=-2"><!--无记录-->
            <!-- 补登记奖期信息表 -->
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd"    value="InsDrwTbl"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=LOT999</Set>
               <Set>RspMsg=登记奖期信息表失败</Set>
               <Return/>
            </If> 
         </If>
         
         <!-- 检查当前系统时间是否为在购彩时间 -->
         <Set>EndTim=STRCAT( SUBSTR(SalEnd,1,4),SUBSTR(SalEnd,6,2),SUBSTR(SalEnd,9,2),SUBSTR(SalEnd,12,2),SUBSTR(SalEnd,15,2),SUBSTR(SalEnd,18,2))</Set>
         <Set>CurTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
         <If condition="STRCMP(CurTim,EndTim)=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=LOT999</Set>
            <Set>RspMsg=已经超过销售结束时间</Set>
            <Return/>
         </If>
            
         <!-- 批量获取定投计划表中的有效记录，判断是否当前期号，相同的不再发起投注，否则发起投注 -->
         <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
            <Arg name="SqlCmd" value="QryAutPln"/>
            <Arg name="CursorName" value="CURSOR_1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=SSA999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE">
               <Arg name="CursorName" value="CURSOR_1"></Arg>
            </Exec>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor">
                  <Arg name="CursorName" value="CURSOR_1"></Arg>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=LOT999</Set>
               <Set>RspMsg=数据库操作错误</Set>
               <Return/>
            </ElseIf>
            <!-- 判断是否当前期号,是就不执行投注-->
            <If condition="STRCMP($DrawId，$CurPer)=0">
               <Continue/>
            </If>
            <!-- 发起购彩交易 -->
            <Exec func="PUB:CallLocal">
               <Arg name="TxnCod" value="485412"/>
               <Arg name="ObjSvr" value="OFRTLOTA"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=LOT999</Set>
               <Set>RspMsg=调用购彩交易异常,定投停止执行</Set>
               <Return/>            
            </If>
            <If condition="STRCMP($MsgTyp,N)=0">
              <!-- IF 购彩成功处理 -->
              <!-- 购彩成功处理 -->
              <!-- 更新定投计划表当前期号，已执行期数加1，置当前失败次数和连续失败次数为0-->
              <Set>CurPer=$DrawId</Set><!--当前期号-->
              <Set>DoPer=ADD($DoPer,1)</Set><!--已执行期数加1-->
              <Set>CurFal=0</Set><!--当前失败次数清0-->
              <Set>ConFal=0</Set><!--连续失败次数清0-->
              <If condition="STRCMP($DoPer,$BetPer)=0"><!--检查期数是否已执行完-->
                  <Set>Status=3</Set><!--定投计划执行完成-->
              </If>
            </If>
            <Else>           
              <!-- ELSE 购彩失败处理 -->
              <!-- 购彩失败处理 -->
              <!-- 置当前失败次数和连续失败次数加1，判断连续失败次数大于3，定投计划取消-->
              <Set>CurPer=$DrawId</Set><!--当前期号-->
              <Set>DoPer=$DoPer</Set><!--已执行期不变-->
              <Set>CurFal=ADD($CurFal,1)</Set><!--当前失败次数加1-->
              <Set>ConFal=ADD($ConFal,1)</Set><!--连续失败次数加1-->            
              <If condition="STRCMP($ConFal,3)=0"><!--检查连续失败次数为3次,撤销该定投计划-->
                 <Set>Status=2</Set><!--定投计划系统撤销-->
              </If>
            </Else>
            <!--更新定投计划表-->
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd"    value="UpdAutPln"/>
            </Exec> 
            <If condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor">
                  <Arg name="CursorName" value="CURSOR_1"></Arg>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=LOT999</Set>
               <Set>RspMsg=更新定投计划表失败</Set>
               <Set>EndTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
               <Set>TxnSts=F</Set>
               <Exec func="PUB:ExecSql" error="IGNORE">
                   <Arg name="SqlCmd"    value="UpdPlnCtl"/>
               </Exec> 
               <If condition="~RetCod=-1">
                  <Exec func="PUB:CloseCursor">
                     <Arg name="CursorName" value="CURSOR_1"></Arg>
                  </Exec>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=LOT999</Set>
                  <Set>RspMsg=更新定投控制表失败</Set>
                  <Return/>
               </If>
               <Return/>
            </If>           
        </While>
        <Exec func="PUB:CloseCursor">
           <Arg name="CursorName" value="CURSOR_1"></Arg>
        </Exec>
        <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Set>RspMsg=交易成功</Set>
      </FlowCtrl>
   </Transaction>
   
   
   <Transaction code="485425" desc="定时返奖">
      <DynSentence name="QryDrwTbl"><!--查询奖期信息表未返奖奖期-->
        <Sentence>
          SELECT　GameId,DrawId,KenoId,FlwCtl
          FROM lotdrwtbl
          WHERE  SalEnd &lt;'%s' AND FlwCtl != '10' AND KenoId !='AAAAA'
          ORDER BY GameId DESC,DrawId ASC
        </Sentence>
        <Fields>SysTim|</Fields>
      </DynSentence>      
      <DynSentence name="UpdDrwTbl_FlwCtl"><!--更新定投控制表流程标志-->
        <Sentence>
          UPDATE lotdrwtbl 
          SET FlwCtl='%s'
          WHERE GameId='%s'  and DrawId='%s' and KenoId='%s' and FlwCtl='%s'
        </Sentence>
        <Fields>NFlwCtl|GameId|DrawId|KenoId|FlwCtl|</Fields>
      </DynSentence>
      <DynSentence name="ChkPrzInf"><!--检查该期开奖公告是否有-->
        <Sentence>
          SELECT  'Y' YN FROM table(values(1)) as annoy WHERE EXISTS(
          SELECT  'Y'
          FROM    lotprzinf
          WHERE   GameId='%s'  and DrawId='%s' and KenoId='%s')
        </Sentence>
        <Fields>GameId|DrawId|KenoId|</Fields>
      </DynSentence>
      <DynSentence name="InsLotPrzInf"><!--登记开奖公告表-->
        <Sentence>
          INSERT INTO lotprzinf(GameId,DrawId,DrawNm,KenoId,KenoNm,
                                StrTim,StpTim,TotPrz,JacPot,OpnTot,
                                OpnNum,BonCod,ClsNum,ClsNam,BonAmt,
                                BonNum)
          VALUES('%s','%s','%s','%s','%s',
                 '%s','%s','%s','%s','%s',
                 '%s','%s','%s','%s','%s',
                 '%s')
        </Sentence>
        <Fields>GameId|DrawId|DrawNm|KenoId|KenoNm|StrTim|StpTim|TotPrz|JacPot|OpnTot|OpnNum|BonCod|ClsNum|ClsNam|BonAmt|BonNum|</Fields>
      </DynSentence>
      <DynSentence name="ChkLotPrzDtl"><!--检查该期中奖记录是否有-->
        <Sentence>
          SELECT  'Y' YN FROM table(values(1)) as annoy WHERE EXISTS(
          SELECT  'Y'
          FROM    lotprzdtl
          WHERE   GameId='%s'  and DrawId='%s' and KenoId='%s')
        </Sentence>
        <Fields>GameId|DrawId|KenoId|</Fields>
      </DynSentence>
      <DynSentence name="InsLotPrzCtl"><!--登记中奖记录控制表-->
        <Sentence>
          INSERT INTO lotprzCtl(GameId,DrawId,KenoId,Cipher,BigBon                               
                                TotPrz,TxnLog,TermID)
          VALUES('%s','%s','%s','%s','%s',
                 '%s','%s','%s')
        </Sentence>
        <Fields>GameId|DrawId|KenoId|Cipher|BigBon|TotPrz|TxnLog|TermID|</Fields>
      </DynSentence>
      <DynSentence name="ChkLotAwdDtl"><!--检查返奖记录明细表是否有-->
        <Sentence>
          SELECT  'Y' YN FROM table(values(1)) as annoy WHERE EXISTS(
          SELECT  'Y'
          FROM    lotawddtl
          WHERE   GameId='%s'  and DrawId='%s' and KenoId='%s')
        </Sentence>
        <Fields>GameId|DrawId|KenoId|</Fields>
      </DynSentence>
      <DynSentence name="Inslotawddtl"><!--登记中奖记录控制表-->
        <Sentence>
          INSERT INTO lotawddtl(BrNo,GameId,DrawId,KenoId,LotNam，
                                TxnLog,TLogNo,CusNam，CrdNo,AwdAmt)
          SELECT b.BrNo,a.GameId,a.DrawId,a.KenoId,b.LotNam,a.TxnLog,a.TLogNo，b.CusNam，b.CrdNo,b.TotPrz
          FROM  lotprzctl a,lottxnjnl b
          WHERE a.GameId=b.GAmeID and a.DrawId=b.DrawId and a.KenoId=b.KenoId 
                and a.BigBon='false' and a.TxnLog=b.TxnLog and a.TLogNo=b.TLogNo and b.TxnSts in ('S','T')
        </Sentence>
        <Fields>GameId|DrawId|KenoId|Cipher|BigBon|TotPrz|TxnLog|TermID|</Fields>
      </DynSentence>
      <DynSentence name="UpdLotTxnJnl_AwdFlg"><!--更新"投注流水表"的中奖标志-->
        <Sentence>
          UPDATE lottxnjnl a
          SET AwdRtn='%s'
          FROM lottxnjnl b
          WHERE  a.GameId=b.GAmeID and a.DrawId=b.DrawId and a.KenoId=b.KenoId 
                 and a.BigBon='false' and a.TxnLog=b.TxnLog and a.TLogNo=b.TLogNo and b.TxnSts in ('S','T')
        </Sentence>
        <Fields>AwdRtn|GameId|DrawId|KenoId|TxnLog|</Fields>
      </DynSentence>
      <DynSentence name="UpdLotTxnJnl_AwdRtn"><!--更新"投注流水表"的返奖标志-->
        <Sentence>
          UPDATE lottxnjnl 
          SET AwdRtn='%s'
          WHERE  GameId='%s'  and DrawId='%s' and KenoId='%s'  and  TxnLog='%s'
        </Sentence>
        <Fields>AwdRtn|GameId|DrawId|KenoId|TxnLog|</Fields>
      </DynSentence>
      <DynSentence name="QryPrzAmt"><!--统计当期返奖总金额-->
        <Sentence>
          SELECT　COALESCE(SUM(CAST(AwdAmt AS BIGINT)),0) PrzAmt
          FROM lotawddtl
          WHERE  GameId='%s'  and DrawId='%s' and KenoId='%s'   
        </Sentence>
        <Fields>GameId|DrawId|KenoId|</Fields>
      </DynSentence>
      <DynSentence name="UpdLotDrwTbl_PrzAmt"><!--更新"奖期表"的返奖总金额-->
        <Sentence>
          UPDATE lotdrwtbl 
          SET PrzAmt='%s'
          WHERE  GameId='%s'  and DrawId='%s' and KenoId='%s'   
        </Sentence>
        <Fields>PrzAmt|GameId|DrawId|KenoId|</Fields>
      </DynSentence>
      <DynSentence name="Chk_CrpAgr"><!--检查单位协议 -->
         <Sentence>
            select BBusTyp,TActNo from savcrpagr where CAgtNo='%s' and SvrSts='1'
         </Sentence>
         <Fields>DSCAgtNo|</Fields>
      </DynSentence>
      <DynSentence name="QryLotDrwTbl_PrzAmt"><!--查询返奖总金额-->
        <Sentence>
          SELECT　PrzAmt
          FROM lotawddtl
          WHERE  GameId='%s'  and DrawId='%s' and KenoId='%s'   
        </Sentence>
        <Fields>GameId|DrawId|KenoId|</Fields>
      </DynSentence>
      <DynSentence name="UpdLotDrwTbl_PayFlg"><!--更新"奖期表"的返奖垫付标志-->
        <Sentence>
          UPDATE lotdrwtbl 
          SET PayFlg='%s',PayAmt='%s'
          WHERE  GameId='%s'  and DrawId='%s' and KenoId='%s'   
        </Sentence>
        <Fields>PayFlg|PayAmt|GameId|DrawId|KenoId|</Fields>
      </DynSentence>
      <DynSentence name="QryLotAwdDtl"><!--查询未返奖记录-->
        <Sentence>
          SELECT　CusNam,CrdNo,AwdAmt,TxnLog
          FROM lotawddtl
          WHERE  GameId='%s'  and DrawId='%s' and KenoId='%s' and AwdRtn='0'
        </Sentence>
        <Fields>GameId|DrawId|KenoId|</Fields>
      </DynSentence>
      <DynSentence name="UpdLotAwdDtl"><!--更新"返奖记录明细表"的-->
        <Sentence>
          UPDATE lotdrwtbl 
          SET AwdRtn='%s',HTxnCd='%s',HLogNo='%s',HRspCd='%s',HTxnSt='%s',AwdDat='%s',AwdTim='%s',TckNo='%s',LogNo='%s'
          WHERE  GameId='%s'  and DrawId='%s' and KenoId='%s'  and TxnLog='%s'
        </Sentence>
        <Fields>AwdRtn|AwdRtn|HLogNo|HRspCd|HTxnSt|AwdDat|AwdTim|TckNo|LogNo|GameId|TDrawId|KenoId|TxnLog|</Fields>
      </DynSentence>
      <DynSentence name="UpdLotTxnJnl_AwdRtn"><!--更新"投注流水表"的返奖标志-->
        <Sentence>
          UPDATE lottxnjnl 
          SET AwdRtn='%s'
          WHERE  GameId='%s'  and DrawId='%s' and KenoId='%s'  and  TxnLog='%s'
        </Sentence>
        <Fields>AwdRtn|GameId|DrawId|KenoId|TxnLog|</Fields>
      </DynSentence>      
      <FlowCtrl>  
                   
         <!-- 从"奖期信息表"中批量取系统时间比销售结束时间大，且返奖流程控制为非6的记录，按先7快乐十分5双色球、期号最小排序 -->
         <Set>SysTim=GETDATETIME()</Set>
         <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
            <Arg name="SqlCmd" value="QryDrwTbl"/>
            <Arg name="CursorName" value="CURSOR_LOT"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=SSA999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
         </If>        
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE">
               <Arg name="CursorName" value="CURSOR_LOT"></Arg>
            </Exec>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor">
                  <Arg name="CursorName" value="CURSOR_LOT"></Arg>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=SSA999</Set>
               <Set>RspMsg=数据库操作错误</Set>
               <Return/>
            </ElseIf>
            <Switch expression="$FlwCtl">

               <Case value='0'><!--返奖流程初始状态-->
                  <Set>NFlwCtl=1</Set>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=更新定投控制表流程标志</Set>
                     <Return/>
                  </If> 
                  <Exec func="PUB:CommitWork" error="IGNORE"/>                
               </Case>
               
               <Case value='1'> <!--1开奖公告下载开始-->
                  <!-- 检查"开奖公告表"对应的游戏编号、期号、keno期号对应的开奖公告是否下载 -->
                  <!-- 否，向福彩中心下载开奖公告，下载开奖公告成功，更新流程返奖标志为2，继续往下做，否则没开奖，循环到下一个游戏编号奖期记录 -->
                  <!-- 是，继续执行 -->
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                     <Arg name="SqlCmd" value="ChkPrzInf"/>
                  </Exec>
                  <If condition="~RetCod=-1"><!--系统出错-->
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=执行步骤1系统出错</Set>
                     <Return/>             
                  </If>
                  <If condition="~RetCod=-2"><!--无记录-->
                     <!-- 向福彩中心下载开奖公告 -->
                     <Exec func="PUB:CallThirdOther" error="IGNORE">
                        <Arg name="HTxnCd" value="236" />
                        <Arg name="ObjSvr" value="STHDLOTA" />
                     </Exec>
                     <If condition="IS_NOEQUAL_STRING(~RetCod,0)">
                        <!-- 查询失败，退出 -->
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                        </Exec>                     
                        <Return/>
                     </If>
                     <If condition="IS_NOEQUAL_STRING($resultCode,0)">
                        <!-- 查询失败，退出 -->
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                        </Exec>                     
                        <Return/>
                     </If>
                     <Set>Cnt=1</Set>
                     <Set>Cnt1=1</Set>
                     <While condition="INTCMP($Cnt1,2,$OpnTot)"><!--开奖总次数-->
                        <!-- 删除旧数据 -->
                        <Delete>ROOT.OpnNum</Delete><!--开奖次数-->
                        <Delete>ROOT.BonCod</Delete><!--开奖号码-->
                        <Delete>ROOT.ClsNum</Delete><!--奖级个数-->
                        <!-- 获取新数据 -->
                        <Exec func="PUB:GetValue">
                            <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$OpnNum)"/>
                            <Arg name="DestName" value="OpnNum"/><!--开奖次数-->
                        </Exec>
                        <Exec func="PUB:GetValue">
                            <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$BonCod)"/>
                            <Arg name="DestName" value="BonCod"/><!--开奖号码-->
                        </Exec>
                        <Exec func="PUB:GetValue">
                            <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$ClsNum)"/>
                            <Arg name="DestName" value="ClsNum"/><!--奖级个数-->
                        </Exec>
                        <While condition="INTCMP($Cnt2,2,$ClsNum)"><!--奖级个数-->
                           <Exec func="PUB:GetValue">
                              <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$Rec1_,$Cnt1,.,$ClsNam)"/>
                              <Arg name="DestName" value="ClsNam"/><!--奖级-->
                           </Exec>
                           <Exec func="PUB:GetValue">
                              <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$Rec1_,$Cnt1,.,$BonAmt)"/>
                              <Arg name="DestName" value="BonAmt"/><!--中奖金额-->
                           </Exec>
                           <Exec func="PUB:GetValue">
                              <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$Rec1_,$Cnt1,.,$BonNum)"/>
                              <Arg name="DestName" value="BonNum"/><!--中奖注数-->
                           </Exec>
                           <!-- 递增 -->
                           <Set>Cnt1=ADD($Cnt1,1)</Set>                                                    
                        </While>                        
                        <!-- 新增明细记录 -->
                        <Exec func="PUB:ExecSql" error="IGNORE">
                            <Arg name="SqlCmd"    value="InsLotPrzInf"/>
                        </Exec>
                        <If condition="IS_NOEQUAL_STRING(~RetCod,0)">
                            <!-- 新增记录异常，退出处理 -->
                            <Exec func="PUB:CloseCursor">
                               <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                            </Exec>                         
                            <Return/>
                        </If>                       
                        <!-- 递增 -->
                        <Set>Cnt=ADD($Cnt,1)</Set>                      
                     </While>
                  </If><!--无记录结束-->                 
                  <!--设置下一步-->
                  <Set>NFlwCtl=2</Set>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=更新定投控制表流程标志出错</Set>
                     <Return/>
                  </If> 
                  <Exec func="PUB:CommitWork" error="IGNORE"/>                    
               </Case>

               
               <Case value='2'><!--开奖公告下载完成-->
                  <Set>NFlwCtl=3</Set>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=更新定投控制表流程标志出错</Set>
                     <Return/>
                  </If> 
                  <Exec func="PUB:CommitWork" error="IGNORE"/>                
               </Case>             

               
               <Case value='3'><!--中奖文件下载开始-->
                  <!-- 检查"中奖记录表"对应的游戏编号、期号、keno期号（快乐十分）对应的是否下载 -->
                  <!-- 否,中奖记录下载，双色球是下载文件导入，快乐十分是报文下载，导入完成改为4 -->
                  <!-- 是，继续执行 -->            
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                     <Arg name="SqlCmd" value="ChkLotPrzCtl"/>
                  </Exec>
                  <If condition="~RetCod=-1"><!--系统出错-->
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=执行步骤3系统出错</Set>
                     <Return/>             
                  </If>
                  <If condition="~RetCod=-2"><!--无记录-->
                     <!-- 向福彩中心下载中奖信息 -->
                     <Exec func="PUB:CallThirdOther" error="IGNORE">
                        <Arg name="HTxnCd" value="236" />
                        <Arg name="ObjSvr" value="STHDLOTA" />
                     </Exec>
                     <If condition="IS_NOEQUAL_STRING(~RetCod,0)">
                        <!-- 查询失败，退出 -->
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                        </Exec>
                        <Set>MsgTyp=E</Set>
                        <Set>RspCod=LOT999</Set>
                        <Set>RspMsg=向第三方发送236失败</Set>
                        <Return/>
                     </If>
                     <If condition="IS_NOEQUAL_STRING($resultCode,0)">
                        <!-- 查询失败，退出 -->
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                        </Exec>
                        <Return/>
                     </If>
                       <!-- 判断是双色球还是快乐十分，快乐十分联机下载，双色球文件下载 -->
                     <If condition="STRCMP($GameId,7)=0">
                       <!-- 快乐十分中奖下载 -->
                       <Exec func="PUB:CallThirdOther" error="IGNORE">
                          <Arg name="HTxnCd" value="240" />
                          <Arg name="ObjSvr" value="STHDLOTA" />
                       </Exec>
                       <If condition="IS_NOEQUAL_STRING(~RetCod,0)">
                          <!-- 查询失败，退出 -->
                          <Exec func="PUB:CloseCursor">
                             <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                          </Exec>
                          <Set>MsgTyp=E</Set>
                          <Set>RspCod=LOT999</Set>
                          <Set>RspMsg=向第三方发送240出错</Set>
                          <Return/>
                       </If>
                       <If condition="IS_NOEQUAL_STRING($resultCode,0)">
                          <!-- 查询失败，退出 -->
                          <Exec func="PUB:CloseCursor">
                             <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                          </Exec>                         
                          <Return/>
                       </If>
                       <Set>Cnt=1</Set>
                       <While condition="INTCMP($Cnt,2,$bonusItemNum)">
                          <!-- 删除旧数据 -->
                          <Delete>ROOT.TxnLog</Delete><!--系统投注流水号-->
                          <Delete>ROOT.Cipher</Delete><!--彩票密码-->
                          <Delete>ROOT.BigBon</Delete><!--大奖标记-->
                          <Delete>ROOT.TotPrz</Delete><!--中奖总金额-->
                          <Delete>ROOT.TLogNo</Delete><!--彩票流水号-->
                          <Delete>ROOT.TermID</Delete><!--系统投注终端号-->
                          <!-- 获取新数据 -->
                          <Exec func="PUB:GetValue">
                              <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$TxnLog)"/>
                              <Arg name="DestName" value="TxnLog"/><!--系统投注流水号-->
                          </Exec>
                          <Exec func="PUB:GetValue">
                              <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$Cipher)"/>
                              <Arg name="DestName" value="Cipher"/><!--彩票密码-->
                          </Exec>
                          <Exec func="PUB:GetValue">
                              <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$BigBon)"/>
                              <Arg name="DestName" value="BigBon"/><!--大奖标记-->
                          </Exec>
                          <Exec func="PUB:GetValue">
                              <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$TotPrz)"/>
                              <Arg name="DestName" value="TotPrz"/><!--中奖总金额-->
                          </Exec>
                          <Exec func="PUB:GetValue">
                              <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$TLogNo)"/>
                              <Arg name="DestName" value="TLogNo"/><!--彩票流水号-->
                          </Exec>
                          <Exec func="PUB:GetValue">
                              <Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,$TermID)"/>
                              <Arg name="DestName" value="TermID"/><!--系统投注终端号-->
                          </Exec>
                          <!-- 新增中奖记录控制表 -->
                          <Exec func="PUB:ExecSql" error="IGNORE">
                              <Arg name="SqlCmd"    value="InsLotPrzCtl"/>
                          </Exec>
                          <If condition="IS_NOEQUAL_STRING(~RetCod,0)">
                              <!-- 新增记录异常，退出处理 -->
                              <Exec func="PUB:CloseCursor">
                                 <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                              </Exec>                             
                              <Set>MsgTyp=E</Set>
                              <Set>RspCod=LOT999</Set>
                              <Set>RspMsg=插中奖记录控制表出错</Set> 
                              <Return/>
                          </If>
                          <!-- 新增中奖记录明细表 -->
                          <Exec func="PUB:InsertRecord">
                             <Arg name="TblNam" value="lotprzdtl"/>
                             <Arg name="GrpNam" value="STRCAT(ROOT.REC_,$Cnt,.Rec1)"/>
                             <Arg name="FldLst" value="GameId|DrawId|KenoId|TxnLog|TLogNo|"/>
                          </Exec>
                          <If condition="IS_NOEQUAL_STRING(~RetCod,0)">
                              <!-- 新增记录异常，退出处理 -->
                              <Exec func="PUB:CloseCursor">
                                 <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                              </Exec>                             
                              <Set>MsgTyp=E</Set>
                              <Set>RspCod=LOT999</Set>
                              <Set>RspMsg=插中奖记录明细表出错</Set>                         
                              <Return/>
                          </If>                       
                          <Set>Cnt=ADD($Cnt,1)</Set>                      
                       </While>
 
                     </If>
                     <ElseIf condition="STRCMP($GameId,5)=0">
                       <!-- 双色球中奖文件下载 -->
                       <Set>FilTyp=2</Set><!--文件类型-->
                       <Set>GameId=$GameId</Set>
                       <Set>DrawId=$DrawId</Set>
                       <Call package="LOT_PKG" function="DownloadFile" desc="文件明细入库"/>
                       <If condition="STRCMP($DownloadStatus,0)!=0">
                          <Exec func="PUB:CloseCursor">
                             <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                          </Exec>                    
                          <Set>MsgTyp=E</Set>
                          <Set>RspCod=LOT999</Set>
                          <Set>RspMsg=调用中奖文件下载异常,定投停止执行</Set>
                          <Return/>
                       </If>                   
                     </ElseIf>
                                               
                  </If>         
                  
                  <Set>NFlwCtl=4</Set><!--4中奖文件下载完成-->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=更新定投控制表流程标志出错</Set>
                     <Return/>
                  </If> 
                  <Exec func="PUB:CommitWork" error="IGNORE"/>                
               </Case>

               
               <Case value='4'><!--4中奖文件下载完成-->
                  <Set>NFlwCtl=5</Set>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=更新定投控制表流程标志出错</Set>
                     <Return/>
                  </If> 
                  <Exec func="PUB:CommitWork" error="IGNORE"/>                
               </Case> 

               <Case value='5'><!--5插入返奖明细开始-->
                 <!-- 检查"返奖记录明细表"的游戏编号、期号、keno期号（快乐十分）对应是否已经插入 -->
                 <!-- 否,根据游戏编号、期号、keno期号（快乐十分）、投注交易流水号匹配投注交易流水表和中奖记录控制表 ，
                      将返奖记录插入返奖记录明细表,更新"奖期表"的返奖总金额字段，导入完成改为6 -->
                 <!---是,继续执行 -->
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                     <Arg name="SqlCmd" value="ChkLotAwdDtl"/>
                  </Exec>
                  <If condition="~RetCod=-1"><!--系统出错-->
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=执行步骤5系统出错</Set>
                     <Return/>             
                  </If>
                  <If condition="~RetCod=-2"><!--无记录-->
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd"    value="InsLotAwddtl"/>
                     </Exec>
                     <If condition="IS_NOEQUAL_STRING(~RetCod,0">
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                        </Exec>
                        <Set>MsgTyp=E</Set>
                        <Set>RspCod=LOT999</Set>
                        <Set>RspMsg=插入返奖记录明细表出错</Set>
                        <Return/>
                     </If>
                     <!--统计返奖总金额-->
                     <Exec func="PUB:ReadRecord" error="IGNORE">
                        <Arg name="SqlCmd"    value="QryPrzAmt"/>
                     </Exec>
                     <If condition="IS_NOEQUAL_STRING(~RetCod,0">
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                        </Exec>
                        <Set>MsgTyp=E</Set>
                        <Set>RspCod=LOT999</Set>
                        <Set>RspMsg=统计返奖总金额出错</Set>
                        <Return/>
                     </If>
                     <!--更新"奖期表"的当期返奖总金额-->
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd"    value="UpdLotDrwTbl_PrzAmt"/>
                     </Exec>
                     <If condition="IS_NOEQUAL_STRING(~RetCod,0">
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                        </Exec>
                        <Set>MsgTyp=E</Set>
                        <Set>RspCod=LOT999</Set>
                        <Set>RspMsg=更新奖期表的返奖总金额出错</Set>
                        <Return/>
                     </If>
                     <!--更新"投注流水表"的中奖标志-->    
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd"    value="UpdLotTxnJnl_AwdFlg"/>
                     </Exec>
                     <If condition="IS_NOEQUAL_STRING(~RetCod,0">
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                        </Exec>
                        <Set>MsgTyp=E</Set>
                        <Set>RspCod=LOT999</Set>
                        <Set>RspMsg=更新投注流水表的中奖标志出错</Set>
                        <Return/>
                     </If>           
                  </If>
                  <Set>NFlwCtl=6</Set>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=更新定投控制表流程标志出错</Set>
                     <Return/>
                  </If> 
                  <Exec func="PUB:CommitWork" error="IGNORE"/>                    
               </Case>
                 
               <Case value='6'><!--6插入返奖明细结束-->
                  <Set>NFlwCtl=7</Set>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=更新定投控制表流程标志出错</Set>
                     <Return/>
                  </If> 
                  <Exec func="PUB:CommitWork" error="IGNORE"/>                
               </Case>
 
 
              <Case value='7'><!--7返奖资金划拨开始-->
                 <!-- 更新"奖期信息表"的返奖流程控制标准为7 -->
                 <!-- 查询购彩内部账余额，并比较是否大于当期返奖总金额-->
                 <!-- 是,从购彩内部帐划款到代发内部账，更新返奖流程控制标志为8和返奖垫付标志为0 -->
                 <!-- 否,查询华祥对公账户余额，并比较是否大于当期返奖总金额-->
                 <!-- 华祥余额足够扣划，从华祥对公账户划钱到代发内部账，更新返奖流程控
                 制标志为8和返奖垫付标志为1和返奖垫付金额 -->
                 <!-- 华祥余额不够扣款，发短信通知补款 -->
                 
                 <!--查询代收内部账户-->
                 <Exec func="PUB:ReadRecord" error="IGNORE">
                     <Arg name="SqlCmd"    value="Chk_CrpAgr"/>
                 </Exec>
                 <If condition="~RetCod=-1">
                    <Exec func="PUB:CloseCursor">
                       <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                    </Exec>
                    <Set>MsgTyp=E</Set>
                    <Set>RspCod=LOT999</Set>
                    <Set>RspMsg=查询代收内部账户出错</Set>
                    <Return/>
                 </If>
                 <!--查询返奖金额-->
                 <Exec func="PUB:ReadRecord" error="IGNORE">
                     <Arg name="SqlCmd"    value="QryLotDrwTbl_PrzAmt"/>
                 </Exec>
                 <If condition="~RetCod=-1">
                    <Exec func="PUB:CloseCursor">
                       <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                    </Exec>
                    <Set>MsgTyp=E</Set>
                    <Set>RspCod=LOT999</Set>
                    <Set>RspMsg=查询返奖总金额出错</Set>
                    <Return/>
                 </If>
                 <!--向核心查询代收内部账余额-->
                 <Set>ActNo=$TActNo</Set>
                 <Set>TTxnCd=098061</Set> <!--第三方交易码-->
                 <Exec func="PUB:CallHostOther" error="IGNORE"> <!--上主机查询帐户余额-->
                    <Args>
                      <Arg name="TxnCod" value="098061"></Arg>
                      <Arg name="ObjSvr" value="SHSTPUB1"></Arg>
                    </Args>
                 </Exec>                 
                 <If condition="~RetCod!=0">
                    <Exec func="PUB:CloseCursor">
                       <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                    </Exec>
                    <Set>MstTyp=E</Set>
                    <Set>RspCod=LOT999</Set>
                    <Set>RspMsg=查询内部帐余额失败</Set>
                    <Return/>                
                 </If>
                 <!--判断代购内部账余额是否大于等于当期返奖总金额-->
                 <If condition="INTCMP($Bal,5,$PrzAmt)">
                    <!--从购彩内部帐划款到代发内部账，更新返奖流程控制标志为8和返奖垫付标志为0-->
                    <Set>BusTyp=PCL83</Set><!--业务类型-->
                    <Set>OActBr=441800</Set> <!--出帐网点机构 从账务中心出帐-->
                    <Set>OActSq=SUBSTR($TActNo,14,5)</Set><!--出帐账号的顺序号-->
                    <Set>CclNo=000000000000</Set> <!--销账号-->
                    <Set>CDFlg1=D</Set> <!--借贷标志 借-->
                    <Set>TxnAmt=$PrzAmt</Set><!--出账金额-->
                    <Set>Smr=STRCAT(游戏编号:,$GameId,期号:,$DrawId,Keno期号:$KenoId,返奖金)</Set>
                    <Set>ActBr2=SUBSTR($DFActNo,1,6)</Set> <!--入帐网点机构号 入账务中心帐-->
                    <Set>ActSq2=SUBSTR($DFActNo,14,5)</Set> <!--入帐账号的顺序号-->
                    <Set>CDFlg2=C</Set> <!--借贷标志 贷-->
                    <Set>PyeAmt=$PrzAmt</Set> <!--入账金额-->
                    <Set>CrgFee=000000000000000</Set> <!--手续费金额-->
                    <Set>RemFee=000000000000000</Set> <!--汇划费金额-->
                    <Set>PstFee=000000000000000</Set> <!--邮电费金额-->
                    <Set>TTxnCd=451800</Set> <!--第三方交易码-->                 
                    <Exec func="PUB:CallHostOther" error="IGNORE"> <!--AI-AI户单笔借方转账(不需复核)-->
                       <Args>
                         <Arg name="TxnCod" value="451800"></Arg>
                         <Arg name="ObjSvr" value="SHSTPUB1"></Arg>
                       </Args>
                    </Exec>              
                    <If condition="~RetCod!=0">
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                       </Exec>
                       <Set>MstTyp=E</Set>
                       <Set>RspCod=LOT999</Set>
                       <Set>RspMsg=划转内部帐失败</Set>
                       <Return/>                 
                    </If>
                    <!--更新返奖垫付标志和返奖金额-->
                    <Set>PayFlg=0</Set><!--0没垫付-->
                    <Set>PayAmt=0</Set><!--返奖垫付金额-->
                    <Exec func="PUB:ExecSql" error="IGNORE">
                       <Arg name="SqlCmd"    value="UpdLotDrwTbl_PayFlg"/>
                    </Exec>
                    <If condition="~RetCod=-1">
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                       </Exec>
                       <Set>MsgTyp=E</Set>
                       <Set>RspCod=LOT999</Set>
                       <Set>RspMsg=更新奖期信息表返奖垫付标志出错</Set>
                       <Return/>
                    </If> 
                 </If>
                 <Else>
                    <!--从华祥对公账户划款到代发内部账，返奖垫付标志为1和返奖垫付金额-->
                    <!--查询华祥对公账户余额-->
                    <Set>ActNo=$HSActNo</Set>
                    <Exec func="PUB:CallHostOther" error="IGNORE"> <!--CD帐户查询-->
                       <Args>
                         <Arg name="TxnCod" value="109000"></Arg>
                         <Arg name="ObjSvr" value="SHSTPUB1"></Arg>
                       </Args>
                    </Exec>              
                    <If condition="~RetCod!=0">
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                       </Exec>
                       <Set>MstTyp=E</Set>
                       <Set>RspCod=LOT999</Set>
                       <Set>RspMsg=查询华祥内部账出错</Set>
                       <Return/>                 
                    </If>
                    <If condition="INTCMP($Bal,1,$PrzAmt)"><!--华祥对公账户余额小于返奖资金-->
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                       </Exec>
                       <Set>MobTel=xxx</Set>
                       <Set>MsgTxt=STRCAT(华祥对公账户余额小于返奖金额,$PrzAmt,请补款)</Set>
                       <Quote name="SendMSM"/><!--发信息-->
                       <Set>MstTyp=E</Set>
                       <Set>RspCod=LOT999</Set>
                       <Set>RspMsg=查询华祥内部账出错</Set>
                       <Return/>                    
                    </If>
                    <!--华祥对公账户划款到代发内部账-->
                    <Set>HTxnCd=451720</Set> <!--主机交易码-->
                    <Set>BusTyp=CBS53</Set> <!--业务类型-->
                    <!--<Set>CrpCod=</Set> 中间业务单位代码-->
                    <Set>ActNo=$HSActNo</Set> <!--扣款帐户-->
                    <Set>CDFlg1=D</Set> <!--借贷标志D-借,C-贷-->
                    <Set>CcyCd1=CNY</Set> <!--货币-->
                    <Set>TxnAmt=$PrzAmt</Set> <!--出账金额-->
                    <Set>Smr=STRCAT(游戏编号:,$GameId,期号:,$DrawId,Keno期号:$KenoId,返奖金)</Set> <!--摘要-->
                    <Set>AccMod=1</Set> <!--入帐方式-->
                    <Set>ActBr2=SUBSTR($DFActNo,1,6)</Set> <!--入帐网点-->
                    <Set>ActSq2=SUBSTR($DFActNo,14,5)</Set> <!--入帐账号的顺序号-->
                    <Set>CDFlg2=C</Set> <!--借贷标志D-借，C-贷-->
                    <Set>CcyCd2=CNY</Set> <!--货币-->
                    <Set>InAmt=$PrzAmt</Set> <!--入账金额-->
                    <Exec func="PUB:CallHostOther" error="IGNORE"> <!--CD-AI户单笔借方转账(不需复核)-->
                       <Args>
                         <Arg name="TxnCod" value="451720"></Arg>
                         <Arg name="ObjSvr" value="SHSTPUB1"></Arg>
                       </Args>
                    </Exec>              
                    <If condition="~RetCod!=0">
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                       </Exec>
                       <Set>MstTyp=E</Set>
                       <Set>RspCod=LOT999</Set>
                       <Set>RspMsg=查询华祥内部账出错</Set>
                       <Return/>                 
                    </If>
                    <!--更新"奖期表"的返奖垫付标志为1和返奖垫付金额-->
                    <Set>PayFlg=1</Set><!--0没垫付-->
                    <Set>PayAmt=$PreAmt</Set><!--返奖垫付金额-->
                    <Exec func="PUB:ExecSql" error="IGNORE">
                       <Arg name="SqlCmd"    value="UpdLotDrwTbl_PayFlg"/>
                    </Exec>
                    <If condition="~RetCod=-1">
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                       </Exec>
                       <Set>MsgTyp=E</Set>
                       <Set>RspCod=LOT999</Set>
                       <Set>RspMsg=更新奖期信息表返奖垫付标志出错</Set>
                       <Return/>
                    </If>                   
                 </Else>
                 
                 <Set>NFlwCtl=8</Set>
                 <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                 </Exec>
                 <If condition="~RetCod=-1">
                    <Exec func="PUB:CloseCursor">
                       <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                    </Exec>
                    <Set>MsgTyp=E</Set>
                    <Set>RspCod=LOT999</Set>
                    <Set>RspMsg=更新定投控制表流程标志出错</Set>
                    <Return/>
                 </If> 
                 <Exec func="PUB:CommitWork" error="IGNORE"/>                                
              </Case>

              <Case value='8'><!--8返奖资金划拨完成-->
                 <Set>NFlwCtl=9</Set>
                 <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                 </Exec>
                 <If condition="~RetCod=-1">
                    <Exec func="PUB:CloseCursor">
                       <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                    </Exec>
                    <Set>MsgTyp=E</Set>
                    <Set>RspCod=LOT999</Set>
                    <Set>RspMsg=更新定投控制表流程标志出错</Set>
                    <Return/>
                 </If> 
                 <Exec func="PUB:CommitWork" error="IGNORE"/>                
              </Case>  
         
              <Case value='9'><!-- 9开始返奖 -->
                 <!--  游戏编号、期号、keno期号（快乐十分）批量取出没返奖记录，进行返奖-->
                 <!-- 返奖成功更新对应的投注流水表和返奖记录表返奖标志 -->
                 <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
                    <Arg name="SqlCmd" value="QryLotAwdDtl"/>
                    <Arg name="CursorName" value="CURSOR_AWD"/>
                 </Exec>
                 <If condition="~RetCod!=0">
                    <Set>MsgTyp=E</Set>
                    <Set>RspCod=LOT999</Set>
                    <Set>RspMsg=数据库操作错误</Set>
                    <Return/>
                 </If>        
                 <While>
                    <Exec func="PUB:FetchCursor" error="IGNORE">
                       <Arg name="CursorName" value="CURSOR_AWD"></Arg>
                    </Exec>
                    <If condition="~RetCod=100">
                       <Break/>
                    </If>
                    <ElseIf condition="~RetCod=-1">
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_AWD"></Arg>
                       </Exec>                  
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                       </Exec>
                       <Set>MsgTyp=E</Set>
                       <Set>RspCod=SSA999</Set>
                       <Set>RspMsg=数据库操作错误</Set>
                       <Return/>
                    </ElseIf>
                    <!--上核心记账-->
                    <Set>HTxnCd=471340</Set>
                    <Set>TTxnCd=471340</Set>
                    <Set>BusTyp=LOT02</Set>
                    <Set>CnlTyp=L</Set>        <!--交易渠道类型：Z-批量-->
                    <Set>PActNo=$DFActNo</Set>  <!--扣账账号-->
                    <Set>ActFlg=4</Set>        <!--转入账户凭证标识 0－现金，1－一本通，2－普通存折，4－卡-->
                    <Set>Mask=9033</Set>       <!--摘要码9033彩票返奖-->
                    <Set>CcyTyp=0</Set>        <!--钞汇标志 0-钞 1-汇-->
                    <!--<Set>CashNo=121</Set>      现金分析号-->
                    <Set>VchChk=0</Set>        <!--监督标志 0-不监督 1-监督 2-有凭证不监督-->
                    <Set>TxnAmt=ADDCHAR($AwdAmt,15,0,1)</Set>  <!--出账金额-->
                    <!--<Set>RvsNo=$CclNo</Set>    销账号-->
                    <Exec func="PUB:CallHostAcc" error="IGNORE"><!--中间业务代付账务接口交易-->
                       <Arg name="HTxnCd"  value="$HTxnCd"/>
                       <Arg name="ObjSvr"  value="SHSTPUB1"/>
                    </Exec>
                    <If condition="~RetCod=0"><!--返奖成功-->
                       <Set>AwdDat=$ActDat</Set><!--返奖日期-->
                       <Set>AwdTim=GETDATETIME()</Set><!--返奖时间-->
                       <Set>AwdRtn=1</Set><!--返奖标志:1未返奖-->
                    </If>
                    <Else><!--返奖失败或者超时-->
                       <Set>AwdDat=$ActDat</Set><!--返奖日期-->
                       <Set>AwdTim=GETDATETIME()</Set><!--返奖时间-->
                       <Set>AwdRtn=0</Set><!--返奖标志:0未返奖-->
                    </Else>
                    <!--更新返奖记录表信息-->
                    <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd"    value="UpdLotAwdDtl"/>
                    </Exec>
                    <ElseIf condition="~RetCod=-1">
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_AWD"></Arg>
                       </Exec>                  
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                       </Exec>
                       <Set>MsgTyp=E</Set>
                       <Set>RspCod=LOT999</Set>
                       <Set>RspMsg=数据库操作错误</Set>
                       <Return/>
                    </ElseIf>
                    <!--更新投注流水表返奖标志-->
                    <Set>AwdRtn=1</Set><!--返奖标志-->
                    <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd"    value="UpdLotTxnJnl_AwdRtn"/>
                    </Exec>
                    <ElseIf condition="~RetCod=-1">
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_AWD"></Arg>
                       </Exec>                  
                       <Exec func="PUB:CloseCursor">
                          <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                       </Exec>
                       <Set>MsgTyp=E</Set>
                       <Set>RspCod=LOT999</Set>
                       <Set>RspMsg=数据库操作错误</Set>
                       <Return/>
                    </ElseIf>                   
                    <Exec func="PUB:CommitWork" error="IGNORE"/><!--确保每条信息更新成功-->
                  </While>

                  <Exec func="PUB:CloseCursor"><!--关闭返奖游标-->
                     <Arg name="CursorName" value="CURSOR_AWD"></Arg>
                  </Exec>
                  
                  <Set>NFlwCtl=10</Set>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd"    value="UpdDrwTbl_FlwCtl"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_LOT"></Arg>
                     </Exec>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=LOT999</Set>
                     <Set>RspMsg=更新定投控制表流程标志出错</Set>
                     <Return/>
                  </If> 
                  <Exec func="PUB:CommitWork" error="IGNORE"/> 
              </Case>

              <Case value='10'><!--10返奖完成 -->
          
              </Case>
            </Switch>

            <!-- 调用宏，检查当期对账和返奖都完成，就计算返奖总金额与购彩总金额,更新扎差金额 -->            
            <Exec func="PUB:CloseCursor"><!--关闭整个交易返奖游标-->
               <Arg name="CursorName" value="CURSOR_LOT"></Arg>
            </Exec>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
            <Set>RspMsg=交易成功</Set>
         </While>
         
          
      
      </FlowCtrl>
   </Transaction>

   <Transaction code="" desc="">
   </Transaction>
</Application>
