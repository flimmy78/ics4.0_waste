<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="LOTA" code="454">
   <!--广东省福彩业务本地主控-->
   <ConfigDeclare>
      <Config name="OPFCSW"      value="etc/LOT_CSW_441999.XML"/>
   </ConfigDeclare>
	<PackageDeclare>
		<Package name="LOT_PKG" value="etc/LOT_PKG.XML"/>
	</PackageDeclare>
   <BusDefDeclare>
      <Busdef name="AplCls"    value="454"/> <!--add by xuan_20101108-->
      <Busdef name="RcvPth"    value="dat/ssa" /> <!--接收目录-->
      <Busdef name="TrmRcv"    value="dat/term/recv" /> <!--终端接收目录-->
      <Busdef name="TrmSnd"    value="dat/term/send" /> <!--终端发送目录-->
	  <Busdef name="DealId"    value="141" /> <!--运营商编号-->
   </BusDefDeclare>
   <TableDeclare>
      <Table name="afetxnjnl"     value="afetxnjnl"/>    <!--业务流水表-->
      <Table name="lotsyscfg"     value="lotsyscfg"/>    <!--平台参数表-->
      <Table name="lotcusinf"     value="lotcusinf"/>    <!--福彩用户表-->
      <Table name="lotautpln"     value="lotautpln"/>    <!--定投计划表-->
      <Table name="lottxnjnl"     value="lottxnjnl"/>    <!--投注流水表-->
      <Table name="lotchkctl"     value="lotchkctl"/>    <!--对账控制表-->
      <Table name="lotchkdtl"     value="lotchkdtl"/>    <!--对账明细表-->
      <Table name="lotdrwtbl"     value="lotdrwtbl"/>    <!--奖期信息表-->
      <Table name="lotprzinf"     value="lotprzinf"/>    <!--开奖公告表-->
      <Table name="lotdrwtbl"     value="lotdrwtbl"/>    <!--奖期信息表-->
      <Table name="lotprzinf"     value="lotprzinf"/>    <!--开奖公告表-->
      <Table name="lotprzctl"     value="lotprzctl"/>    <!--中奖记录控制表-->
      <Table name="lotprzdtl"     value="lotprzdtl"/>    <!--中奖记录明细表-->
      <Table name="lotawddtl"     value="lotawddtl"/>    <!--返奖奖记录明细表-->
   </TableDeclare>
   <GlobalFunction>
      <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
      <Function name="_after">
         <Process>
            <If condition="ISNULL($MsgTyp)">
               <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                  <Set>MsgTyp=N</Set>
                  <Set>RspCod=000000</Set>
               </If>
               <Else>
                  <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                     <Set>MsgTyp=E</Set>
                  </If>
                  <Else>
                     <Set>MsgTyp=N</Set>
                  </Else>
               </Else>
            </If>
         </Process>
      </Function>
   </GlobalFunction>

	<Define>
      <Macro name="Init_Trans"><!--初始化脚本-->
         <Exec func="PUB:GetBranchNoByNodeNo"></Exec>  <!--根据网点号取分行代码-->
         <Exec func="PUB:InitTransaction"></Exec>  <!--交易初始化,预留-->
         <Set>FTxnTm=GETDATETIME()</Set><!--前置平台系统时间-->
         <Set>@MSG.XVE=STRCAT(&lt;,\?,xml ,version='1.0' encoding='UTF-8',\?,&gt;)</Set>
      </Macro>
      <Macro name="CommonSql"><!--公共SQL宏-->
      </Macro>
	</Define>

	<Transaction code="485412" desc="实时投注">
		<Quote name="CommonSql"/>
		<DynSentence name="ChkLotCusInf" desc="检查用户信息">
			<Sentence>
				select BrNo,CusNam,ActNo,ActNod,IdTyp,IdNo,MobTel,FixTel,LotNam,LotPsw,RegTim,Email,CityId
				from LotCusInf
				where CrdNo='%s' and Status='1'
			</Sentence>
			<Fields>CrdNo|</Fields>
		</DynSentence>
		<DynSentence name="QryLotDrwTbl" desc="查询奖期信息(没有keno期)">
			<Sentence>
				select DrawId, DrawNm, KenoId, KenoNm
				from LotDrwTbl
				where FlwCtl='0' and GameId='%s' and KenoId != 'AAAAA'
					and SalStr &lt; '%s' and SalEnd &gt; '%s'
				order by SalStr asc
				fetch first 1 rows only
			</Sentence>
			<Fields>GameId|FcTim|FcTim|</Fields>
		</DynSentence>
		<DynSentence name="QryLotDrwTblKeno" desc="查询奖期信息(有keno期)">
			<Sentence>
				select DrawId, DrawNm, KenoId, KenoNm
				from LotDrwTbl
				where FlwCtl='0' and GameId='%s' and KenoId != 'AAAAA'
					and KSalSt &lt; '%s' and KSalEd &gt; '%s'
				order by SalStr,KSalSt asc
				fetch first 1 rows only
			</Sentence>
			<Fields>GameId|FcTim|FcTim|</Fields>
		</DynSentence>
		<DynSentence name="InsLotTxnJnl" desc="增加投彩流水表">
			<Sentence>
				insert into LotTxnJnl(BrNo,LogNo,TTxnCd,TxnCod,SchTyp,
									SchTit,SecLev,CityId,DrawId,KenoId,
									GameId,GamNam,PlayId,BetMet,BetMod,
									BetMul,TxnAmt,BetLin,LotNam,BetDat,
									TxnTim,TxnLog,SchId,TLogNo,Cipher,
									Verify,CusNam,CrdNo,HTxnCd,HTxnSb,
									HLogNo,HRspCd,HTxnSt,TRspCd,TTxnSt,
									ThdChk,TChkNo,ChkTim,ChkFlg,AwdFlg,
									AwdRtn,CAgtNo,TckNo,TxnCnl,BetTyp,
									LChkTm,TxnSts)
				values ('%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s')
			</Sentence>
			<Fields>BrNo|LogNo|TTxnCd|TxnCod|SchTyp|SchTit|SecLev|CityId|DrawId|KenoId|GameId|GamNam|PlayId|BetMet|BetMod|BetMul|TxnAmt|BetLin|LotNam|BetDat|TxnTim|TxnLog|SchId|TLogNo|Cipher|Verify|CusNam|CrdNo|HTxnCd|HTxnSb|HLogNo|HRspCd|HTxnSt|TRspCd|TTxnSt|ThdChk|TChkNo|ChkTim|ChkFlg|AwdFlg|AwdRtn|CAgtNo|TckNo|TxnCnl|BetTyp|LChkTm|TxnSts|</Fields>
		</DynSentence>
		<DynSentence name="UpdLotTxnJnl4Acc" desc="记账后更新购彩流水">
			<Sentence>
				update LotTxnJnl 
				set HLogNo='%s', HRspCd='%s', HTxnSt='%s', TckNo='%s', TxnSts='%s'
				where TxnLog='%s'
			</Sentence>
			<Fields>HLogNo|HRspCd|HTxnSt|TckNo|TxnSts|TxnLog|</Fields>
		</DynSentence>
		<DynSentence name="UpdLotTxnJnl4Snd" desc="发送购彩后更新购彩流水">
			<Sentence>
				update LotTxnJnl
				set TRspCd='%s', TTxnSt='%s', TLogNo='%s', Cipher='%s', Verify='%s', TxnSts='%s', HTxnSt='%s', SchId='%s'
				where TxnLog='%s'
			</Sentence>
			<Fields>RRspCd|TTxnSt|TLogNo|Cipher|Verify|TxnSts|HTxnSt|SchId|TxnLog|</Fields>
		</DynSentence>
		<DynSentence name="QryAgtInf" desc="查询代收协议信息">
			<Sentence>
				select TACTNO TACTNO
				from SAVCRPINF
				where CAGTNO='%s'
			</Sentence>
			<Fields>DSCAgtNo|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			<Call package="LOT_PKG" function="GetSysCfg" desc="获取系统配置"/>
			<Set>CTTxnCd=$TTxnCd</Set>
			<Set>TzCod=TZ0000</Set>
			
			<!-- 检查客户注册信息 -->
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="SqlCmd" value="ChkLotCusInf"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<!-- 客户未注册或状态异常，返回错误 -->
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=客户未注册或状态异常</Set>
				<Set>TzCod=TZ9001</Set>
				<Return/>
			</If>
			
			<!-- 检查当前是否有可用奖期，如果没有则下载一次，下载后再检查一次，如果没有则返回错误 -->
			<Call package="LOT_PKG" function="GetFcTim" desc="获取福彩时间"/>
			<Exec func="PUB:CodeSwitching">
				<Arg name="DatSrc" value="OPFCSW"/>
				<Arg name="SourNam" value="GameId"/>
				<Arg name="DestNam" value="IsKeno"/>
				<Arg name="TblNam" value="IsKenoChg"/>
			</Exec>
			<If condition="IS_EQUAL_STRING($IsKeno,Y)">
				<Set>sql=QryLotDrwTblKeno</Set>
			</If>
			<Else>
				<Set>sql=QryLotDrwTbl</Set>
			</Else>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="SqlCmd" value="$sql"/>
			</Exec>
			<If condition="IS_EQUAL_STRING(~RetCod,-2)">
				<!-- 没有奖期信息，执行奖期下载 -->
				<Exec func="PUB:CallLocal" error="IGNORE">
					<Arg name="TxnCod" value="485441" />
					<Arg name="ObjSvr" value="OFRTLOTB"/>
				</Exec>
				<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
					<!-- 下载奖期信息异常，返回错误 -->
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=下载奖期信息异常</Set>
					<Set>TzCod=TZ9002</Set>
					<Return/>
				</If>
				<!-- 下载奖期信息成功后，再次检查是否有符合的奖期 -->
				<Exec func="PUB:ReadRecord" error="IGNORE">
					<Arg name="SqlCmd" value="$sql"/>
				</Exec>
				<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
					<!-- 下载奖期信息异常，返回错误 -->
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=不在购买时间（无可用奖期）</Set>
					<Set>TzCod=TZ9003</Set>
					<Return/>
				</If>
				</If>
				<ElseIf condition="IS_NOEQUAL_STRING(~RetCod,0)">
					<!-- 查询奖期信息异常 -->
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=查询奖期信息异常</Set>
					<Set>TzCod=TZ9004</Set>
					<Return/>
				</ElseIf>
			
			<!-- 登记购彩记录(commit) -->
			<Exec func="PUB:CodeSwitching">
				<Arg name="DatSrc" value="OPFCSW"/>
				<Arg name="SourNam" value="SchTyp"/>
				<Arg name="DestNam" value="SchTypDesc"/>
				<Arg name="TblNam" value="SchTypDescChg"/>
			</Exec>
			<Exec func="PUB:CodeSwitching">
				<Arg name="DatSrc" value="OPFCSW"/>
				<Arg name="SourNam" value="GameId"/>
				<Arg name="DestNam" value="GameIdDesc"/>
				<Arg name="TblNam" value="GameIdDescChg"/>
			</Exec>
			<Call package="LOT_PKG" function="GetTxnLogNo" desc="获取购彩流水号"/>
			<Set>TxnAmt=$BetAmt</Set>
			<Set>LogNo=$LogNo</Set><!-- 前置流水号 -->
			<Set>TTxnCd=231</Set><!-- 第三方交易码 -->
			<Set>TxnCod=485412</Set><!-- 前置流水号 -->
			<Set>SchTit=$SchTypDesc</Set><!-- 方案标题 -->
			<Set>GamNam=$GameIdDesc</Set><!-- 游戏名称 -->
			<Set>BetDat=GETDATETIME(YYYYMMDD)</Set><!-- 投注日期 -->
			<Set>TxnTim=GETDATETIME(YYYYMMDDHHMISS)</Set><!-- 投注时间 -->
			<Set>TxnLog=$SelVal</Set><!-- 投注交易流水号 -->
			<Set>SchId= </Set><!-- 系统生成的方案编号 -->
			<Set>TLogNo= </Set><!-- 彩票流水号 -->
			<Set>Cipher= </Set><!-- 彩票密码 -->
			<Set>Verify= </Set><!-- 彩票校验码 -->
			<Set>HTxnCd=471140</Set><!-- 主机交易码 -->
			<Set>HTxnSb=002</Set><!-- 交易子码 -->
			<Set>HLogNo= </Set><!-- 主机流水号 -->
			<Set>HRspCd= </Set><!-- 主机响应码 -->
			<Set>HTxnSt=U</Set><!-- 主机交易状态 -->
			<Set>TRspCd= </Set><!-- 第三方响应码 -->
			<Set>TTxnSt=U</Set><!-- 第三方交易状态 -->
			<Set>ThdChk=0</Set><!-- 与第三方对帐标志,0未对账 1已对账 -->
			<Set>TChkNo=00000000000</Set><!-- 与第三方对帐批次 -->
			<Set>ChkTim= </Set><!-- 对帐时间 -->
			<Set>ChkFlg=0</Set><!-- 对账标志 -->
			<Set>AwdFlg=0</Set><!-- 中奖标志 -->
			<Set>AwdRtn=0</Set><!-- 返奖标志 -->
			<Set>CAgtNo=$DSCAgtNo</Set><!-- 商户协议编号 -->
			<Set>TckNo= </Set><!-- 会计流水号 -->
			<Set>TxnCnl=$TxnCnl</Set><!-- 交易渠道 -->
			<Set>LChkTm= </Set><!-- 1970年距今的秒数 -->
			<Set>TxnSts=U</Set><!-- 交易状态 -->
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="InsLotTxnJnl"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<!-- 新增购彩流水异常 -->
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=新增购彩流水异常</Set>
				<Set>TzCod=TZ9005</Set>
				<Return/>
			</If>
			<!-- 防止后续账务处理异常导致回滚，此处先提交数据库事务 -->
			<Exec  func="PUB:CommitWork"  />
			
			<!-- 发起账务扣账，借客户帐 贷26201 -->
			<Set>TTxnCd=$CTTxnCd</Set>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="SqlCmd" value="QryAgtInf"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=送主机记账失败（无法获取代收协议信息）</Set>
				<Set>TzCod=TZ9006</Set>
				<Return/>
			</If>
			<Set>BusTyp=CBS52</Set>
			<Set>CnlTyp=L</Set>
			<Set>ActFlg=4</Set><!-- 默认为太平洋卡 -->
			<Set>Mask=9145</Set>
			<Set>ActNo=$CrdNo</Set>
			<Set>VchTyp=000</Set>
			<Set>VchCod=00000000</Set>
			<Set>PayMod=0</Set>
			<Set>CcyCod=CNY</Set>
			<Set>CcyTyp=1</Set>
			<Set>VchChk=0</Set>
			<Set>TActNo=$TActNo</Set>
			<Set>ActSeq=SUBSTR($TActNo,14,5)</Set>
			<Set>TxnAmt=$BetAmt</Set>
			<Set>Smr=彩票投注</Set>
			<Set>CAgtNo=$DSCAgtNo</Set>
			<Exec  func="PUB:GetLogNo" error="IGNORE"/> <!--取前置流水号-->
			<If condition="~RetCod != 0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=送主机记账失败（无法获取前置流水号）</Set>
				<Set>TzCod=TZ9007</Set>
				<Return/>
			</If>
			<Set>AccStatus=N</Set><!-- 当前记账状态 -->
			<Exec func="PUB:CallHostOther" error="IGNORE">
				<Arg name="HTxnCd" value="471140" desc="主机交易码"/>
				<Arg name="ObjSvr" value="SHSTPUB1" desc="服务"/>
			</Exec>
			<Set>TxnSts=$TxnSts</Set><!-- 交易状态 -->
			<Switch expression="~RetCod">
				<Case value="-10" desc="发送不成功"/>
				<Case value="-2" desc="系统错误， 可以归为发送不成功">
					<Set>AccStatus=F</Set>
					<Set>AccMsg=送主机记账失败（系统错误)</Set>
					<Set>TxnSts=F</Set>
					<Set>TzCod=TZ9008</Set>
					<Break/>
				</Case>
				<Case value="3" desc="交易失败">
					<Set>AccStatus=F</Set>
					<Set>AccMsg=送主机记账失败（交易失败)</Set>
					<Set>TxnSts=F</Set>
					<Set>TzCod=TZ9009</Set>
					<Break/>
				</Case>
				<Case value="-1" desc="超时">
					<Set>AccStatus=T</Set>
					<Set>AccMsg=送主机记账超时</Set>
					<Set>TxnSts=T</Set>
					<Set>TzCod=TZ9010</Set>
					<Break/>
				</Case>
				<Case value="0">
					<Set>AccStatus=S</Set>
					<Set>AccMsg=送主机记账成功</Set>
					<Set>TxnSts=A</Set>
					<Set>TzCod=TZ9011</Set>
					<Break/>
				</Case>
				<Default>
					<Set>AccStatus=F</Set>
					<Set>AccMsg=送主机记账失败（未知错误）</Set>
					<Set>TxnSts=F</Set>
					<Set>TzCod=TZ9012</Set>
					<Break/>
				</Default>
			</Switch>

			<!-- 更新扣账结果(commit) -->
			<Set>HLogNo=$HLogNo</Set>
			<Set>HRspCd=$HRspCd</Set>
			<Set>HTxnSt=$AccStatus</Set>
			<Set>TckNo=$TckNo</Set>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="UpdLotTxnJnl4Acc"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=更新购彩流水异常（账务结果）</Set>
				<Set>TzCod=TZ9013</Set>
				<Return/>
			</If>
			<!-- 送第三方报文之前先提交数据库事务 -->
			<Exec  func="PUB:CommitWork"  />
			
			<!-- 向福彩中心发送购彩报文 -->
			<Set>TxnSts=$TxnSts</Set>
			<Set>TTxnCd=231</Set><!-- 第三方交易码 -->
			<If condition="IS_NOEQUAL_STRING($AccStatus,S)">
				<!-- 如果账务处理未成功，则返回 -->
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=$AccMsg</Set>
				<Return/>
			</If>
			<Set>LotTxnTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
			<Set>GrpNum=$GrpNum</Set>
			<Set>BetNum=$BetNum</Set>
			<Set>BetLin=$BetLin</Set>
			<!--
			<Exec func="PUB:SetValue">
				<Arg name="FieldName" value="ROOT.Rec_1.BetLin"/>
				<Arg name="FieldValue" value="$ROOT.BetLin"/>
			</Exec>
			-->
			<Set>TTXNCD=231</Set>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
			   <Arg name="HTxnCd" value="$TTXNCD" />
			   <Arg name="ObjSvr" value="STHDLOTA" />
			</Exec>
			<Set>SndStatus=F</Set>
			<Switch expression="~RetCod">
				<Case value="0">
					<Set>SndStatus=S</Set>
					<Set>SndMsg=发送购彩成功</Set>
					<Set>TxnSts=S</Set>
					<Set>TTxnSt=S</Set><!-- 第三方交易状态 -->
					<Break/>
				</Case>
				<Case value="-1">
					<Set>SndStatus=T</Set>
					<Set>SndMsg=发送购彩超时</Set>
					<Set>TxnSts=T</Set>
					<Set>TTxnSt=T</Set><!-- 第三方交易状态 -->
					<Set>TzCod=TZ9014</Set>
					<Break/>
				</Case>
				<Default>
					<Set>SndStatus=F</Set>
					<Set>SndMsg=STRCAT($RRspMsg,[,$RRspCod,])</Set>
					<Set>TxnSts=F</Set>
					<Set>TTxnSt=F</Set><!-- 第三方交易状态 -->
					<Set>TzCod=TZ9015</Set>
					<Break/>
				</Default>
			</Switch>
			
			<!-- 发送不成功/福彩中心返回购彩失败，则发起冲正 -->
			<If condition="AND(IS_EQUAL_STRING($SndStatus,F),IS_NOEQUAL_STRING($TckNo,))">
				<Set>TzCod=TZ9017</Set>
				<Set>TTxnCd=$CTTxnCd</Set>
				<Set>HTxnCd=471149</Set>
				<Set>OHLogNo=$HLogNo</Set>
				<Set>OTckNo=$TckNo</Set>
				<Set>TIATyp=C</Set>
				<Set>OTTxnCd=$CTTxnCd</Set>
				<Set>HLogNo= </Set>
				<Exec func="PUB:CallHostOther"><!--上主机系统抹账 -->
					<Arg name="HTxnCd" value="959999" /><!--主机交易码 -->
					<Arg name="ObjSvr" value="SHSTPUB1" />
				</Exec>
				<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
					<Set>AccStatus=$AccStatus</Set><!-- 如果冲正失败，则主机状态不变（S） -->
				</If>
				<Else>
					<Set>AccStatus=F</Set><!-- 如果冲正成功，主机状态为失败（F） -->
				</Else>
			</If>
			
			<!-- 更新购彩结果 -->
			<Set>RRspCd=$RRspCod</Set>
			<Set>HTxnSt=$AccStatus</Set>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="UpdLotTxnJnl4Snd"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=STRCAT(更新购彩流水状态为,$TxnSts,时失败)</Set>
				<Set>TzCod=TZ9016</Set>
				<Return/>
			</If>
			
			<!-- 最后一步（发送实时购彩）处理完成后返回购彩结果 -->
			<If condition="IS_EQUAL_STRING($TxnSts,S)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Set>RspMsg=交易成功</Set>
			</If>
			<Else>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=STRCAT(购彩失败（,$SndMsg,）)</Set>
			</Else>
			
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485413" desc="投注查询">
		<Quote name="CommonSql"/>
		<DynSentence name="QryLotTxnJnl" desc="查询购彩记录">
			<Sentence>
				select * from
					(select GameId, PlayId, TLogNo, DrawId, KenoId, BetMul, TxnAmt, BetLin, TxnTim
					from LotTxnJnl 
					where CrdNo='%s' %s and BetDat between '%s' and '%s' and TxnSts='S'
					order by TxnTim desc
					fetch first 10 rows only) as tmptbl
				order by TxnTim asc
			</Sentence>
			<Fields>CrdNo|SubSql|BegDat|EndDat|</Fields>
		</DynSentence>
		<FlowCtrl>
			<!-- 根据查询条件卡号、投注方式（实时、定投、全部）
				查询投注成功的近三个月的10笔投注信息，返回投注期名、
				投注号码、投注金额 -->
			<If condition="IS_EQUAL_STRING($BetTyp,)">
				<Set>SubSql= </Set>
			</If>
			<Else>
				<Set>SubSql=STRCAT(and BetTyp=',$BetTyp,')</Set>
			</Else>
				
			<!-- 判断是否多页查询 -->
			<If condition="IS_EQUAL_STRING($TIATyp,P)">
				<Exec func="PUB:MultiQuery" />
				<Return/>
			</If>

			<!-- 限定查询条件 -->
			<If condition="IS_EQUAL_STRING($EndDat,)">
				<Set>EndDat=GETDATETIME(YYYYMMDD)</Set>
			</If>
			<If condition="IS_EQUAL_STRING($BegDat,)">
				<Set>BegDat=CALCDATE($EndDat,-,m,3)</Set>
			</If>
			
			<!-- 开始查询并组织数据 -->
			<Exec func="PUB:MultiQuery" error="IGNORE">
				<Arg name="SqlCmd" value="QryLotTxnJnl"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<Set>MsgTyp=E</Set>
				<Set>RspMsg=查询失败</Set>
				<Set>RspCod=LOT999</Set>
			</If>
			<Else>
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
			</Else>
			
			
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485414" desc="中奖查询">
		<Quote name="CommonSql"/>
		<DynSentence name="QryLotTxnJnl" desc="查询购彩记录">
			<Sentence>
				select * from
					(select b.TLogNo, b.DrawId, b.KenoId, b.BetMul, b.BetLin, b.BetMod, a.PrzAmt, b.TxnTim
					from LotPrzDtl a, LotTxnJnl b
					where a.GameId=b.GameId and a.DrawId=b.DrawId and a.KenoId=b.KenoId
						and a.TxnLog=b.TxnLog and a.TLogNo=b.TLogNo
						and CrdNo='%s' %s and BetDat between '%s' and '%s' and TxnSts='S'
					order by TxnTim desc
					fetch first 10 rows only) as tmptbl
				order by TxnTim asc
			</Sentence>
			<Fields>CrdNo|SubSql|BegDat|EndDat|</Fields>
		</DynSentence>
		<FlowCtrl>
			<!-- 根据查询条件卡号、投注方式（实时、定投、全部），
				查询中奖记录表的中奖期号、中奖号码、中奖金额 -->
			<If condition="IS_EQUAL_STRING($BetTyp,)">
				<Set>SubSql= </Set>
			</If>
			<Else>
				<Set>SubSql=STRCAT(and BetTyp=',$BetTyp,')</Set>
			</Else>

			<!-- 判断是否多页查询 -->
			<If condition="IS_EQUAL_STRING($TIATyp,P)">
				<Exec func="PUB:MultiQuery" />
				<Return/>
			</If>
      
			<!-- 限定查询条件 -->
			<If condition="IS_EQUAL_STRING($EndDat,)">
				<Set>EndDat=GETDATETIME(YYYYMMDD)</Set>
			</If>
			<If condition="IS_EQUAL_STRING($BegDat,)">
				<Set>BegDat=CALCDATE($EndDat,-,m,3)</Set>
			</If>
			
			<!-- 开始查询并组织数据 -->
			<Exec func="PUB:MultiQuery" error="IGNORE">
				<Arg name="SqlCmd" value="QryLotTxnJnl"/>
			</Exec>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485415" desc="实时单笔投注查询">
		<Quote name="CommonSql"/>
		<DynSentence name="ChkLotCusInf" desc="检查用户信息">
			<Sentence>
				select BrNo,CusNam,ActNo,ActNod,IdTyp,IdNo,MobTel,FixTel,LotNam,LotPsw,RegTim,Email,CityId
				from LotCusInf
				where CrdNo='%s' and Status='1'
			</Sentence>
			<Fields>CrdNo|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			
			<!-- 检查客户注册信息 -->
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="SqlCmd" value="ChkLotCusInf"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<!-- 客户未注册或状态异常，返回错误 -->
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=客户未注册或状态异常</Set>
				<Return/>
			</If>
			
			<Set>TTXNCD=232</Set>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
			   <Arg name="HTxnCd" value="$TTXNCD" />
			   <Arg name="ObjSvr" value="STHDLOTA" />
			</Exec>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>

		</FlowCtrl>
	</Transaction>

	<Transaction code="485420" desc="对账文件下载">
		<Quote name="CommonSql"/>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			
			<Set>FilTyp=3</Set>
			<Call package="LOT_PKG" function="DownloadFile" desc="下载文件"/>
			
			<If condition="IS_EQUAL_STRING($DownloadStatus,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Set>RspMsg=交易成功</Set>
			</If>
			<Else>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=$DownloadMsg</Set>
			</Else>

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485426" desc="返奖文件下载">
		<Quote name="CommonSql"/>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			
			<Set>FilTyp=2</Set>
			<Call package="LOT_PKG" function="DownloadFile" desc="下载文件"/>
			
			<If condition="IS_EQUAL_STRING($DownloadStatus,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Set>RspMsg=交易成功</Set>
			</If>
			<Else>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=$DownloadMsg</Set>
			</Else>

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485421" desc="游戏对账">
		<Quote name="CommonSql"/>
		<DynSentence name="QryLotChkCtl" desc="查询对账控制表">
			<Sentence>
				select * from LotChkCtl
				where GameId='%s' and DrawId='%s'
			</Sentence>
			<Fields>GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="QryLotChkDtl" desc="查询对账明细表">
			<Sentence>
				select * from LotChkDtl
				where GameId='%s' and DrawId='%s'
			</Sentence>
			<Fields>GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="UpdLotTxnJnlInit" desc="更新购彩流水为初始状态">
			<Sentence>
				update LotTxnJnl
				set ChkFlg='0', ChkTim=''
				where GameId='%s' and DrawId='%s'
			</Sentence>
			<Fields>GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="UpdLotChkDtlInit" desc="更新对账明细表为初始状态">
			<Sentence>
				update LotChkDtl
				set ChkFlg='0', ChkTim=''
				where GameId='%s' and DrawId='%s'
			</Sentence>
			<Fields>GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="MatchLotTxnJnl" desc="对购彩记录进行对账(对账成功)">
			<Sentence>
				update LotTxnJnl
				set ChkFlg='1', ChkTim='%s', TxnSts='S'
				where GameId='%s' and DrawId='%s'
					and TxnLog in
						(select a.TxnLog from LotTxnJnl a, LotChkDtl b
						 where a.GameId=b.GameId and a.DrawId=b.DrawId and a.KenoId=b.KenoId
						 	and a.SchId=b.SchId and a.LotNam=b.LotNam and a.TxnLog=b.TxnLog
						 	and a.PlayId=b.PlayId and a.TxnAmt=b.TxnAmt
						 	and a.TxnSts in ('S', 'T')
						)
			</Sentence>
			<Fields>CurTim|GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="MatchLotChkDtl" desc="对对账明细进行对账(对账成功)">
			<Sentence>
				update LotChkDtl
				set ChkFlg='1', ChkTim='%s'
				where GameId='%s' and DrawId='%s'
					and TxnLog in
						(select TxnLog from LotTxnJnl where GameId='%s' and DrawId='%s' and ChkFlg='1'
						)
			</Sentence>
			<Fields>CurTim|GameId|DrawId|GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="UnMatchLotTxnJnl" desc="对购彩记录进行对账(对账失败)">
			<Sentence>
				update LotTxnJnl
				set ChkFlg='2', ChkTim='%s'
				where GameId='%s' and DrawId='%s'
					and ChkFlg='0' and TxnSts in ('S', 'T')
			</Sentence>
			<Fields>CurTim|GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="StatLotChkDtlUnChk" desc="统计对账明细中未对账的数量">
			<Sentence>
				select count(*) LotChkUnCnt 
				from LotChkDtl 
				where ChkFlg='0' and GameId='%s' and DrawId='%s'
			</Sentence>
			<Fields>GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="StatLotTxnJnlUnChk" desc="统计购彩明细中未对账的数量">
			<Sentence>
				select count(*) LotTxnUnCnt 
				from LotTxnJnl 
				where ChkFlg!='1' and GameId='%s' and DrawId='%s' and TxnSts in ('S', 'T')
			</Sentence>
			<Fields>GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="QryTotDat" desc="查询购彩总金额总笔数">
			<Sentence>
				select COALESCE(sum(bigint(TotAmt)),0) TotAmt, COALESCE(sum(bigint(TotNum)),0) TotNum 
				from LotChkCtl 
				where GameId='%s' and DrawId='%s'
			</Sentence>
			<Fields>GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="UpdLotChkCtl4Chk" desc="更新对账控制表对账结果">
			<Sentence>
				update LotChkCtl set ChkFlg='%s', ChkTim='%s'
				where GameId='%s' and DrawId='%s'
			</Sentence>
			<Fields>ChkFlg|ChkTim|GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="UpdLotDrwTbl4Chk" desc="更新奖期表对账结果">
			<Sentence>
				update LotDrwTbl set ChkFlg='%s', ChkTim='%s', TotAmt='%s'
				where GameId='%s' and DrawId='%s' and kenoId in ('','AAAAA')
			</Sentence>
			<Fields>ChkFlg|ChkTim|TotAmt|GameId|DrawId|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			<Set>CurTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
			
			<!-- 检查对应的对账数据是否已经下载 -->
			<Exec func="PUB:ReadRecord" error="IGNORE">
			   <Arg name="SqlCmd" value="QryLotChkCtl"/>
			</Exec>
			<Switch expression="~RetCod">
				<Case value="0">
					<Break/>
				</Case>
				<Case value="-1">
					<Exec func="PUB:RollbackWork"/>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=查询对账信息异常</Set>
					<Return/>
					<Break/>
				</Case>
				<Case value="-2">
					<!-- 下载对账信息 -->
					<Set>FilTyp=3</Set>
					<Call package="LOT_PKG" function="DownloadFile" desc="下载文件"/>
					<If condition="IS_NOEQUAL_STRING($DownloadStatus,0)">
						<Exec func="PUB:RollbackWork"/>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=STRCAT(下载对账文件失败[,$DownloadMsg,])</Set>
					</If>
					
					<!-- 下载完成后，再查询一次 -->
					<Exec func="PUB:ReadRecord" error="IGNORE">
					   <Arg name="SqlCmd" value="QryLotChkCtl"/>
					</Exec>
					<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
						<Exec func="PUB:RollbackWork"/>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=无对账信息</Set>
						<Return/>
					</If>
					<Break/>
				</Case>
			</Switch>
			
			<!-- 设置对账初始状态 -->
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="UpdLotTxnJnlInit"/>
			</Exec>
			<If condition="IS_EQUAL_STRING(~RetCod,-1)">
				<Exec func="PUB:RollbackWork"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=对账更新状态失败（UpdLotTxnJnlInit）</Set>
				<Return/>
			</If>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="UpdLotChkDtlInit"/>
			</Exec>
			<If condition="IS_EQUAL_STRING(~RetCod,-1)">
				<Exec func="PUB:RollbackWork"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=对账更新状态失败（UpdLotChkDtlInit）</Set>
				<Return/>
			</If>
			
			<!-- 更新核对成功的状态 -->
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="MatchLotTxnJnl"/>
			</Exec>
			<If condition="IS_EQUAL_STRING(~RetCod,-1)">
				<Exec func="PUB:RollbackWork"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=对账更新状态失败（MatchLotTxnJnl）</Set>
				<Return/>
			</If>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="MatchLotChkDtl"/>
			</Exec>
			<If condition="IS_EQUAL_STRING(~RetCod,-1)">
				<Exec func="PUB:RollbackWork"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=对账更新状态失败（MatchLotChkDtl）</Set>
				<Return/>
			</If>
			
			<!-- 更新我方多账的状态 -->
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="UnMatchLotTxnJnl"/>
			</Exec>
			<If condition="IS_EQUAL_STRING(~RetCod,-1)">
				<Exec func="PUB:RollbackWork"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=对账更新状态失败（MatchLotChkDtl）</Set>
				<Return/>
			</If>
			
			<!-- 判断是否对账成功，如果是则更新奖期表的对账标志并通知购彩总金额 -->
			<!-- 判断对账明细中是否还有未对账的 -->
			<Exec func="PUB:ReadRecord" error="IGNORE">
			   <Arg name="SqlCmd" value="StatLotChkDtlUnChk"/>
			</Exec>
			<!-- 判断交易明细中是否还有未对账的 -->
			<Exec func="PUB:ReadRecord" error="IGNORE">
			   <Arg name="SqlCmd" value="StatLotTxnJnlUnChk"/>
			</Exec>
			<Set>ChkTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
			<If condition="AND(IS_EQUAL_STRING($LotChkUnCnt,0),IS_EQUAL_STRING($LotTxnUnCnt,0))">
				<Exec func="PUB:ReadRecord" error="IGNORE">
				   <Arg name="SqlCmd" value="QryTotDat"/>
				</Exec>
				<If condition="IS_EQUAL_STRING(~RetCod,-1)">
					<Exec func="PUB:RollbackWork"/>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=统计购彩总金额失败（QryTotDat）</Set>
					<Return/>
				</If>
				<Set>ChkFlg=2</Set>
			</If>
			<Else>
				<Set>ChkFlg=1</Set>
				<Set>TotAmt= </Set>
			</Else>
			<!-- 更新奖期表、对账控制表中对应的对账信息 -->
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="UpdLotChkCtl4Chk"/>
			</Exec>
			<If condition="IS_EQUAL_STRING(~RetCod,-1)">
				<Exec func="PUB:RollbackWork"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=对账更新状态失败（UpdLotChkCtl4Chk）</Set>
				<Return/>
			</If>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="UpdLotDrwTbl4Chk"/>
			</Exec>
			<If condition="IS_EQUAL_STRING(~RetCod,-1)">
				<Exec func="PUB:RollbackWork"/>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=对账更新状态失败（UpdLotDrwTbl4Chk）</Set>
				<Return/>
			</If>
			
			<!-- 生成对账报表 -->
			

			<!-- 计算轧差 -->
			<Call package="LOT_PKG" function="CalcLotDifAmt" desc="计算轧差"/>

			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=对账完成，请检查差错报表</Set>

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485422" desc="游戏对账清单打印">
		<Quote name="CommonSql"/>
		<DynSentence name="QryDrawInf" desc="查询奖期信息">
			<Sentence>
				select DrawNm
				from LotDrwTbl
				where GameId='%s' and DrawId='%s'
			</Sentence>
			<Fields>GameId|DrawId|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			
			<If condition="IS_EQUAL_STRING($FunTyp,0)">
				<!-- 生成报表 -->
				<Exec func="PUB:CodeSwitching">
					<Arg name="DatSrc" value="OPFCSW"/>
					<Arg name="SourNam" value="RptTyp"/>
					<Arg name="DestNam" value="RptTil"/>
					<Arg name="TblNam" value="LotChkRptChg"/>
				</Exec>
				<Exec func="PUB:CodeSwitching">
					<Arg name="DatSrc" value="OPFCSW"/>
					<Arg name="SourNam" value="GameId"/>
					<Arg name="DestNam" value="GameIdDesc"/>
					<Arg name="TblNam" value="GameIdDescChg"/>
				</Exec>
				<Exec func="PUB:ReadRecord" error="IGNORE">
				   <Arg name="SqlCmd" value="QryDrawInf"/>
				</Exec>
				
				<!-- 浏览/打印 -->
				<Set>FilNm=STRCAT(LOTCHK,$RptTyp,_,$TlrId,_,GETDATETIME(YYYYMMDDHHMISS),.RPT)</Set>
				<Exec func="EXT:GenerateReport" error="IGNORE">
					<Arg name="RptName"  value="STRCAT(dat/term/send/,$FilNm)"/>
					<Arg name="RptFile"  value="STRCAT(etc/LOT_RPT_CHK_,$RptTyp,.XML)"/>
					<Arg name="RptTyp"   value="$RptTyp" />
					<Arg name="GameId"   value="$GameId" />
					<Arg name="GameNm"   value="$GameIdDesc" />
					<Arg name="DrawId"   value="$DrawId" />
					<Arg name="DrawNm"   value="$DrawNm" />
					<Arg name="TlrId"    value="$TlrId" />
				</Exec>
				<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
					<Set>FilNm= </Set>
				</If>
				<Else>
					<Exec func="PUB:SendFileMessage2">
						<Arg name="MsgTyp"  value="3"/><!-- 发送 -->
						<Arg name="ObjNod"  value="$NodNo"/>
						<Arg name="BusTyp"  value="46"/>
						<Arg name="AplCod"  value="$TxnCod"/>
						<Arg name="FilNam"  value="$FilNm"/>
						<Arg name="Summary" value="STRCAT(文件【,$FilNm,】发送)"/>
						<Arg name="ObjTlr"  value="$TlrId"/> 
					</Exec>
				</Else>
			</If>
			<Else>
				<Exec func="PUB:SendFileMessage2">
					<Arg name="MsgTyp"  value="4"/><!-- 发送打印 -->
					<Arg name="ObjNod"  value="$NodNo"/>
					<Arg name="BusTyp"  value="46"/>
					<Arg name="AplCod"  value="$TxnCod"/>
					<Arg name="FilNam"  value="$FilNm"/>
					<Arg name="Summary" value="STRCAT(文件【,$FilNm,】发送打印)"/>
					<Arg name="ObjTlr"  value="$TlrId"/> 
				</Exec>
			</Else>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485440" desc="游戏规则文件下载">
		<Quote name="CommonSql"/>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			
			<Set>FilTyp=1</Set>
			<Call package="LOT_PKG" function="DownloadFile" desc="下载文件"/>
			
			<If condition="IS_EQUAL_STRING($DownloadStatus,0)">
				<Set>MsgTyp=N</Set>
				<Set>RspCod=000000</Set>
				<Set>RspMsg=交易成功</Set>
			</If>
			<Else>
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=$DownloadMsg</Set>
			</Else>

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485441" desc="奖期信息下载">
		<Quote name="CommonSql"/>
		<DynSentence name="ChkLotDrwTbl" desc="检查奖期信息是否已经存在">
			<Sentence>
				SELECT  'Y' YN FROM table(values(1)) as annoy WHERE EXISTS(
				SELECT  'Y'
				FROM    LotDrwTbl
				WHERE   GameId='%s' and DrawId='%s')
			</Sentence>
			<Fields>GameId|DrawId|</Fields>
		</DynSentence>
		<DynSentence name="InsLotDrwTbl" desc="检查奖期信息是否已经存在">
			<Sentence>
				insert into LotDrwTbl(GameId,DrawId,DrawNm,SalStr,SalEnd,
									CshStr,CshEnd,KenoId,KenoNm,KSalSt,
									KSalEd,ChkFlg,ChkTim,DowPrz,PrzAmt,
									TotAmt,DifFlg,DifAmt,PayFlg,PayAmt,
									FlwCtl)
				values('%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s','%s','%s','%s','%s',
						'%s')
			</Sentence>
			<Fields>GameId|DrawId|DrawNm|SalStr|SalEnd|CshStr|CshEnd|KenoId|KenoNm|KSalSt|KSalEd|ChkFlg|ChkTim|DowPrz|PrzAmt|TotAmt|DifFlg|DifAmt|PayFlg|PayAmt|FlwCtl|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->

			<!--发送第三方获取奖期信息-->
			<Set>TTXNCD=235</Set>
			<Exec func="PUB:CallThirdOther" error="IGNORE">
				<Arg name="HTxnCd" value="$TTXNCD" />
				<Arg name="ObjSvr" value="STHDLOTA" />
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<!-- 查询失败，退出 -->
				<Return/>
			</If>
			<If condition="IS_NOEQUAL_STRING($RRspCod,0)">
				<!-- 查询失败，退出 -->
				<Return/>
			</If>
			
			<!-- 判断本地的奖期表中是否已有信息，如果有则新增，否则忽略 -->
			<Exec func="PUB:ReadRecord" error="IGNORE">
			   <Arg name="SqlCmd" value="ChkLotDrwTbl"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,-2)">
				<!-- 存在记录或查询异常，退出处理 -->
				<Return/>
			</If>

			<!-- 如果是双色球，则新增一条奖期记录，如果是快乐十分，则需要增加总奖期和小奖期信息 -->
			<Set>ChkFlg=0</Set><!-- 对账清算标志 -->
			<Set>DowPrz=0</Set><!-- 是否已下载中奖文件  0未下载,1已下载 -->
			<Set>DifFlg= </Set><!-- 扎差标志：1借方（购彩总金额大于返奖总金额）,0贷方（购彩总金额小于奖总金额） -->
			<Set>PayFlg= </Set><!-- 返奖垫付标志: 0没垫付,1华祥垫付,2已返垫付 -->
			<Set>FlwCtl=0</Set><!-- 返奖流程控制标志 -->
			<Set>KenoId= </Set><!-- keno期号 -->
			<Set>KenoNm= </Set><!-- keno期名 -->
			<Set>KSalSt= </Set><!-- Keno销售开始时间 -->
			<Set>KSalEd= </Set><!-- Keno销售结束时间 -->
			<Set>ChkTim= </Set><!-- 对帐清算时间 -->
			<Set>PrzAmt= </Set><!-- 返奖总金额 -->
			<Set>TotAmt= </Set><!-- 购彩总金额 -->
			<Set>PayAmt= </Set><!-- 返奖垫付金额 -->
			<Set>DifAmt= </Set><!-- 购彩总金额与返奖总金额扎差金额 -->
			<If condition="IS_EQUAL_STRING($isKeno,1)">
				<Set>KenoId=AAAAA</Set><!-- 如果有keno期(快乐十分)时需要增加一条记录期号为AAAAA，为了统计快开游戏的总金额 -->
			</If>
			<Exec func="PUB:ExecSql" error="IGNORE">
				<Arg name="SqlCmd"    value="InsLotDrwTbl"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<!-- 新增记录异常，退出处理 -->
				<Return/>
			</If>

			<If condition="IS_EQUAL_STRING($isKeno,1)">
				<!-- 如果有keno期，则需要分别新增 -->
				<Set>Cnt=1</Set>
				<While condition="INTCMP($Cnt,2,$KenoNum)">
					<!-- 删除旧数据 -->
					<Delete>ROOT.KenoId</Delete>
					<Delete>ROOT.KenoNm</Delete>
					<Delete>ROOT.KSalSt</Delete>
					<Delete>ROOT.KSalEd</Delete>
					<!-- 获取新数据 -->
					<Exec func="PUB:GetValue">
						<Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,KenoId)"/>
						<Arg name="DestName" value="KenoId"/>
					</Exec>
					<Exec func="PUB:GetValue">
						<Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,KenoNm)"/>
						<Arg name="DestName" value="KenoNm"/>
					</Exec>
					<Exec func="PUB:GetValue">
						<Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,KSalSt)"/>
						<Arg name="DestName" value="KSalSt"/>
					</Exec>
					<Exec func="PUB:GetValue">
						<Arg name="SourName" value="STRCAT(ROOT.Rec_,$Cnt,.,KSalEd)"/>
						<Arg name="DestName" value="KSalEd"/>
					</Exec>
					<!-- 新增明细记录 -->
					<Exec func="PUB:ExecSql" error="IGNORE">
						<Arg name="SqlCmd"    value="InsLotDrwTbl"/>
					</Exec>
					<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
						<!-- 新增记录异常，退出处理 -->
						<Return/>
					</If>
					
					<!-- 递增 -->
					<Set>Cnt=ADD($Cnt,1)</Set>
				</While>
			</If>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>
			
			<!-- 下载奖期信息后提交数据库 -->
			<Exec  func="PUB:CommitWork"  />

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485450" desc="查询奖期信息">
		<Quote name="CommonSql"/>
		<DynSentence name="QryDrwInfByDate" desc="根据日期查询奖期信息">
			<Sentence>
				select DrawId, DrawNm, SalStr, SalEnd, CshStr, CshEnd, ChkFlg, ChkTim, PrzAmt, TotAmt, DifFlg, DifAmt, PayFlg, PayAmt, FlwCtl
				from LotDrwTbl
				where GameId='%s' and SubStr(SalEnd, 1, 8)='%s'
			</Sentence>
			<Fields>GameId|SalEnd|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			
			<Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="QryDrwInfByDate"/>
			</Exec>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>

		</FlowCtrl>
	</Transaction>
						
	<Transaction code="485433" desc="清算轧差试算">
		<Quote name="CommonSql"/>
		<DynSentence name="QryTolPayInf" desc="查询汇总垫付信息">
			<Sentence>
				select COALESCE(sum(bigint(PayAmt)),0) TolPayAmt
				from LotDrwTbl
				where GameId = '%s' and SubStr(SalEnd, 1, 8) &lt; '%s'
					and PayFlg = '1' and PayAmt != '' and ChkFlg in ('2', '3')
			</Sentence>
			<Fields>GameId|ClrDat|</Fields>
		</DynSentence>
		<DynSentence name="QryTolDifInf" desc="查询汇总垫付信息">
			<Sentence>
				select COALESCE(sum(bigint(case when DifFlg='1' then DifAmt else '-'||DifAmt end)),0)  TolDifAmt
				from LotDrwTbl
				where GameId = '%s' and SubStr(SalEnd, 1, 8) &lt; '%s'
					and ChkFlg = '2' and DifAmt != ''
			</Sentence>
			<Fields>GameId|ClrDat|</Fields>
		</DynSentence>
		<DynSentence name="QryClrDatInf" desc="查询清算区间信息">
			<Sentence>
				select min(SalEnd) StrDat, max(SalEnd) EndDat
				from LotDrwTbl
				where GameId = '%s' and SubStr(SalEnd, 1, 8) &lt; '%s'
					and ChkFlg = '2' and DifAmt != ''
			</Sentence>
			<Fields>GameId|ClrDat|</Fields>
		</DynSentence>
		<DynSentence name="ChkClrFlg" desc="检查是否可以进行清算">
			<Sentence>
				SELECT  'Y' YN FROM table(values(1)) as annoy WHERE EXISTS(
				SELECT  'Y'
				FROM    LotDrwTbl
				WHERE   GameId='%s' and SubStr(SalEnd, 1, 8) &lt; '%s' and (ChkFlg in ('','0','1') or FlwCtl != '10') and KenoId in ('','AAAAA'))
			</Sentence>
			<Fields>GameId|ClrDat|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			<Call package="LOT_PKG" function="GetSysCfg" desc="获取系统配置"/>
			
			<!-- 统计轧差和垫付金额 -->
			<Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="QryTolPayInf" error="IGNORE"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=统计垫付金额失败</Set>
				<Return/>
			</If>
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="SqlCmd" value="QryTolDifInf" error="IGNORE"/>
			</Exec>
			<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=统计轧差金额失败</Set>
				<Return/>
			</If>
			<If condition="INTCMP($TolDifAmt,1,0)">
				<Set>DifFlg=0</Set>
				<Set>TolDifAmt=SUBSTR($TolDifAmt,2,SUB(STRLEN($TolDifAmt),2))</Set>
			</If>
			<Else>
				<Set>DifFlg=1</Set>
			</Else>
			
			<!-- 查询时点余额 -->
			<Set>ActNo=$GcActNo</Set>
			<Set>CcyCod=CNY</Set>
			<Exec  func="PUB:GetLogNo" error="IGNORE"/> <!--取前置流水号-->
			<If condition="~RetCod != 0">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=LOT999</Set>
				<Set>RspMsg=查询内部户时点余额失败[无法获取前置流水号]</Set>
				<Return/>
			</If>
			<Exec func="PUB:CallHostOther" error="IGNORE">
				<Arg name="HTxnCd" value="098061" desc="主机交易码"/>
				<Arg name="ObjSvr" value="SHSTPUB1" desc="服务"/>
			</Exec>
			<Switch expression="~RetCod">
				<Case value="-10" desc="发送不成功"/>
				<Case value="-2" desc="系统错误， 可以归为发送不成功">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=查询内部户时点余额失败[系统错误]</Set>
					<Return/>
					<Break/>
				</Case>
				<Case value="3" desc="失败">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=查询内部户时点余额失败[返回失败]</Set>
					<Return/>
					<Break/>
				</Case>
				<Case value="-1">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=查询内部户时点余额失败[发送超时]</Set>
					<Return/>
					<Break/>
				</Case>
				<Case value="0">
					<Break/>
				</Case>
				<Default>
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=查询内部户时点余额失败[其他错误]</Set>
					<Return/>
					<Break/>
				</Default>
			</Switch>
			<Set>CurBal=$Bal</Set>
			
			<Exec func="PUB:ReadRecord" error="IGNORE">
				<Arg name="SqlCmd" value="ChkClrFlg" error="IGNORE"/>
			</Exec>
			<If condition="IS_EQUAL_STRING(~RetCod,-2)">
				<Set>ClrFlg=1</Set>
			</If>
			<Else>
				<Set>ClrFlg=0</Set>
			</Else>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485434" desc="清算轧差">
		<Quote name="CommonSql"/>
		<DynSentence name="UpdTolPayInf" desc="更新垫付状态">
			<Sentence>
				update LotDrwTbl
				set PayFlg = '2', RtnTim = '%s'
				where GameId = '%s' and SubStr(SalEnd, 1, 8) &lt; '%s'
					and PayFlg = '1' and (PayAmt != '' or PayAmt != '0')
			</Sentence>
			<Fields>CurTim|GameId|ClrDat|CurTim|</Fields>
		</DynSentence>
		<DynSentence name="UpdTolDifInf" desc="更新清算状态">
			<Sentence>
				update LotDrwTbl
				set ChkFlg = '3', ClrTim = '%s'
				where GameId = '%s' and SubStr(SalEnd, 1, 8) &lt; '%s'
					and ChkFlg = '2' and (DifAmt != '' or DifAmt!='0')
			</Sentence>
			<Fields>CurTim|GameId|ClrDat|CurTim|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			<Call package="LOT_PKG" function="GetSysCfg" desc="获取系统配置"/>
			<Set>CurTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
						
			<If condition="IS_NOEQUAL_STRING($PayAmt,0)">
				<!-- 执行还垫付款的操作,借购彩内部户 贷华翔对公户 -->
				<Set>BusTyp=PFT57</Set> <!--业务类型        -->
				<Set>CrpCod=9999999999</Set> <!--中间业务单位代码-->
				<Set>DAcSqn=SUBSTR($GcActNo,14,5)</Set> <!--借记帐户顺序号  -->
				<Set>CcyCod=CNY</Set> <!--币种            -->
				<Set>TxnAmt=$PayAmt</Set> <!--金额            -->
				<Set>AccMod=0</Set> <!--入帐方式 0-转CD户 1－转内部户 -->
				<Set>TActNo=$HSActNo</Set> <!--入帐帐号        -->
				<Set>TActNo=441167421018010105327</Set> <!--入帐帐号        --><!-- =============================================================测试 -->
				<Set>TActNm= </Set> <!--入帐户名        -->
				<Set>NamChk=1</Set> <!--户名检查标志 0-检查户名 1－不检查-->
				<Set>RgCFlg=0</Set> <!--是否登记贷方回单0-否，1-是；默认0-->
				<Set>NodNo=$NodNo</Set>
				<Set>SmrCod=8013</Set>
				<Set>Smr=还返奖垫付资金</Set>
				<!-- 发起记账请求 -->
				<Exec  func="PUB:GetLogNo" error="IGNORE"/> <!--取前置流水号-->
				<If condition="~RetCod != 0">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=还垫付款失败[无法获取前置流水号]</Set>
					<Return/>
				</If>
				<Exec func="PUB:CallHostOther" error="IGNORE">
					<Arg name="HTxnCd" value="451400" desc="主机交易码"/>
					<Arg name="ObjSvr" value="SHSTPUB1" desc="服务"/>
				</Exec>
				<Switch expression="~RetCod">
					<Case value="-10" desc="发送不成功"/>
					<Case value="-2" desc="系统错误， 可以归为发送不成功">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=还垫付款失败[系统错误]</Set>
						<Return/>
						<Break/>
					</Case>
					<Case value="3" desc="失败">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=还垫付款失败[返回失败]</Set>
						<Return/>
						<Break/>
					</Case>
					<Case value="-1">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=还垫付款失败[发送超时],请及时查询会计流水!</Set>
						<Return/>
						<Break/>
					</Case>
					<Case value="0">
						<Break/>
					</Case>
					<Default>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=还垫付款失败[其他错误]</Set>
						<Return/>
						<Break/>
					</Default>
				</Switch>
				<!-- 更新垫付状态,commit -->
				<Exec func="PUB:ExecSql" error="IGNORE">
					<Arg name="SqlCmd"    value="UpdTolPayInf"/>
				</Exec>
				<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
					<Set>TTxnCd=$TTxnCd</Set>
					<Set>HTxnCd=451409</Set>
					<Set>OHLogNo=$HLogNo</Set>
					<Set>OTckNo=$TckNo</Set>
					<Set>TIATyp=C</Set>
					<Set>OTTxnCd=$TTxnCd</Set>
					<Set>HLogNo= </Set>
					<Exec func="PUB:CallHostOther"><!--上主机系统抹账 -->
						<Arg name="HTxnCd" value="959999" /><!--主机交易码 -->
						<Arg name="ObjSvr" value="SHSTPUB1" />
					</Exec>
					<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=更新垫款状态失败且冲正失败,请及时处理!</Set>
						<Return/>
					</If>
					<Else>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=更新垫款状态失败[已冲正]</Set>
						<Return/>
					</Else>
				</If>
				<Exec  func="PUB:CommitWork"  />
			</If>
			
			<If condition="IS_NOEQUAL_STRING($DifAmt,0)">
				<!-- 执行清轧差的操作 借购彩内部户 贷福彩对公户 -->
				<Set>BusTyp=PFT57</Set> <!--业务类型        -->
				<Set>CrpCod=9999999999</Set> <!--中间业务单位代码-->
				<Set>DAcSqn=SUBSTR($GcActNo,14,5)</Set> <!--借记帐户顺序号  -->
				<Set>CcyCod=CNY</Set> <!--币种            -->
				<Set>TxnAmt=$DifAmt</Set> <!--金额            -->
				<Set>AccMod=0</Set> <!--入帐方式 0-转CD户 1－转内部户 -->
				<Set>TActNo=$FCActNo</Set> <!--入帐帐号        -->
				<Set>TActNm= </Set> <!--入帐户名        -->
				<Set>NamChk=1</Set> <!--户名检查标志 0-检查户名 1－不检查-->
				<Set>RgCFlg=0</Set> <!--是否登记贷方回单0-否，1-是；默认0-->
				<Set>NodNo=$NodNo</Set>
				<Set>SmrCod=9009</Set>
				<Set>Smr=清算</Set>
				<!-- 发起记账请求 -->
				<Exec  func="PUB:GetLogNo" error="IGNORE"/> <!--取前置流水号-->
				<If condition="~RetCod != 0">
					<Set>MsgTyp=E</Set>
					<Set>RspCod=LOT999</Set>
					<Set>RspMsg=清算轧差失败[无法获取前置流水号]</Set>
					<Return/>
				</If>
				<Exec func="PUB:CallHostOther" error="IGNORE">
					<Arg name="HTxnCd" value="451400" desc="主机交易码"/>
					<Arg name="ObjSvr" value="SHSTPUB1" desc="服务"/>
				</Exec>
				<Switch expression="~RetCod">
					<Case value="-10" desc="发送不成功"/>
					<Case value="-2" desc="系统错误， 可以归为发送不成功">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=清算轧差失败[系统错误]</Set>
						<Return/>
						<Break/>
					</Case>
					<Case value="3" desc="失败">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=清算轧差失败[返回失败]</Set>
						<Return/>
						<Break/>
					</Case>
					<Case value="-1">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=清算轧差失败[发送超时],请及时查询会计流水!</Set>
						<Return/>
						<Break/>
					</Case>
					<Case value="0">
						<Break/>
					</Case>
					<Default>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=清算轧差失败[其他错误]</Set>
						<Return/>
						<Break/>
					</Default>
				</Switch>
				
				<!-- 更新清算状态,commit -->
				<Exec func="PUB:ExecSql" error="IGNORE">
					<Arg name="SqlCmd"    value="UpdTolDifInf"/>
				</Exec>
				<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
					<Set>TTxnCd=$TTxnCd</Set>
					<Set>HTxnCd=451409</Set>
					<Set>OHLogNo=$HLogNo</Set>
					<Set>OTckNo=$TckNo</Set>
					<Set>TIATyp=C</Set>
					<Set>OTTxnCd=$TTxnCd</Set>
					<Set>HLogNo= </Set>
					<Exec func="PUB:CallHostOther"><!--上主机系统抹账 -->
						<Arg name="HTxnCd" value="959999" /><!--主机交易码 -->
						<Arg name="ObjSvr" value="SHSTPUB1" />
					</Exec>
					<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=更新清算状态失败且冲正失败,请及时处理!</Set>
						<Return/>
					</If>
					<Else>
						<Set>MsgTyp=E</Set>
						<Set>RspCod=LOT999</Set>
						<Set>RspMsg=更新清算状态失败[已冲正]</Set>
						<Return/>
					</Else>
				</If>
				<Exec  func="PUB:CommitWork"  />
			</If>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485451" desc="奖期查询">
		<Quote name="CommonSql"/>
		<DynSentence name="QryLotDrwTbl" desc="查询奖期记录">
			<Sentence>
				select *
				from LotDrwTbl
				where GameId = '%s' and (DrawId = '%s' or '%s' = '') and (DrawNm = '%s' or '%s' = '')
					and (KenoId = '%s' or '%s' = '') and (KenoNm = '%s' or '%s' = '')
					and (SubStr(SalStr,1,8) = '%s' or '%s' = '') and (SubStr(SalEnd,1,8) = '%s' or '%s' = '')
					and (ChkFlg = '%s' or '%s' = '') and (PayFlg = '%s' or '%s' = '')
					%s
				order by GameId, DrawId asc
			</Sentence>
			<Fields>GameId|DrawId|DrawId|DrawNm|DrawNm|KenoId|KenoId|KenoNm|KenoNm|SalStr|SalStr|SalEnd|SalEnd|ChkFlg|ChkFlg|PayFlg|PayFlg|SubSql|</Fields>
		</DynSentence>
		<FlowCtrl>
				
			<!-- 判断是否多页查询 -->
			<If condition="IS_EQUAL_STRING($TIATyp,P)">
				<Exec func="PUB:MultiQuery" />
				<Return/>
			</If>
			
			<!-- 组织附加条件 -->
			<Set>SubSql= </Set>
			<If condition="IS_EQUAL_STRING(SUBSTR($AddCon,1,1),1)">
				<!-- 流程未完成 -->
				<Set>SubSql=STRCAT($SubSql,STRCAT( and FlwCtl != '10' ))</Set>
			</If>
			<If condition="IS_EQUAL_STRING(SUBSTR($AddCon,2,1),1)">
				<!-- 购彩金额非零 -->
				<Set>SubSql=STRCAT($SubSql,STRCAT( and TotAmt != '' and TotAmt != '0' ))</Set>
			</If>
			<If condition="IS_EQUAL_STRING(SUBSTR($AddCon,3,1),1)">
				<!-- 购彩金额非零 -->
				<Set>SubSql=STRCAT($SubSql,STRCAT( and PrzAmt != '' and PrzAmt != '0' ))</Set>
			</If>
			
			<!-- 开始查询并组织数据 -->
			<Exec func="PUB:MultiQuery" error="IGNORE">
				<Arg name="SqlCmd" value="QryLotDrwTbl"/>
			</Exec>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			
		</FlowCtrl>
	</Transaction>

	<Transaction code="485452" desc="清算清单打印">
		<Quote name="CommonSql"/>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			
			<If condition="IS_EQUAL_STRING($FunTyp,0)">
				<!-- 生成报表 -->
				<Exec func="PUB:CodeSwitching">
					<Arg name="DatSrc" value="OPFCSW"/>
					<Arg name="SourNam" value="GameId"/>
					<Arg name="DestNam" value="GameIdDesc"/>
					<Arg name="TblNam" value="GameIdDescChg"/>
				</Exec>
				
				<!-- 浏览/打印 -->
				<Set>FilNm=STRCAT(LOTCLR,$RptTyp,_,$TlrId,_,GETDATETIME(YYYYMMDDHHMISS),.RPT)</Set>
				<Exec func="EXT:GenerateReport" error="IGNORE">
					<Arg name="RptName"  value="STRCAT(dat/term/send/,$FilNm)"/>
					<Arg name="RptFile"  value="STRCAT(etc/LOT_RPT_CLR_,$RptTyp,.XML)"/>
					<Arg name="GameId"   value="$GameId" />
					<Arg name="GameNm"   value="$GameIdDesc" />
					<Arg name="DrawNm"   value="$ClrDat" />
					<Arg name="TlrId"    value="$TlrId" />
				</Exec>
				<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
					<Set>FilNm= </Set>
				</If>
				<Else>
					<Exec func="PUB:SendFileMessage2">
						<Arg name="MsgTyp"  value="3"/><!-- 发送 -->
						<Arg name="ObjNod"  value="$NodNo"/>
						<Arg name="BusTyp"  value="46"/>
						<Arg name="AplCod"  value="$TxnCod"/>
						<Arg name="FilNam"  value="$FilNm"/>
						<Arg name="Summary" value="STRCAT(文件【,$FilNm,】发送)"/>
						<Arg name="ObjTlr"  value="$TlrId"/> 
					</Exec>
				</Else>
			</If>
			<Else>
				<Exec func="PUB:SendFileMessage2">
					<Arg name="MsgTyp"  value="4"/><!-- 发送打印 -->
					<Arg name="ObjNod"  value="$NodNo"/>
					<Arg name="BusTyp"  value="46"/>
					<Arg name="AplCod"  value="$TxnCod"/>
					<Arg name="FilNam"  value="$FilNm"/>
					<Arg name="Summary" value="STRCAT(文件【,$FilNm,】发送打印)"/>
					<Arg name="ObjTlr"  value="$TlrId"/> 
				</Exec>
			</Else>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485453" desc="返奖清单打印">
		<Quote name="CommonSql"/>
		<FlowCtrl>
			<Quote name="Init_Trans"></Quote><!--交易初始化-->
			
			<If condition="IS_EQUAL_STRING($FunTyp,0)">
				<!-- 生成报表 -->
				<Exec func="PUB:CodeSwitching">
					<Arg name="DatSrc" value="OPFCSW"/>
					<Arg name="SourNam" value="GameId"/>
					<Arg name="DestNam" value="GameIdDesc"/>
					<Arg name="TblNam" value="GameIdDescChg"/>
				</Exec>
				
				<!-- 浏览/打印 -->
				<Set>FilNm=STRCAT(LOTAWD,$RptTyp,_,$TlrId,_,GETDATETIME(YYYYMMDDHHMISS),.RPT)</Set>
				<Exec func="EXT:GenerateReport" error="IGNORE">
					<Arg name="RptName"  value="STRCAT(dat/term/send/,$FilNm)"/>
					<Arg name="RptFile"  value="STRCAT(etc/LOT_RPT_AWD_,$RptTyp,.XML)"/>
					<Arg name="GameId"   value="$GameId" />
					<Arg name="GameNm"   value="$GameIdDesc" />
					<Arg name="DrawId"   value="$DrawId" />
					<Arg name="TlrId"    value="$TlrId" />
				</Exec>
				<If condition="IS_NOEQUAL_STRING(~RetCod,0)">
					<Set>FilNm= </Set>
				</If>
				<Else>
					<Exec func="PUB:SendFileMessage2">
						<Arg name="MsgTyp"  value="3"/><!-- 发送 -->
						<Arg name="ObjNod"  value="$NodNo"/>
						<Arg name="BusTyp"  value="46"/>
						<Arg name="AplCod"  value="$TxnCod"/>
						<Arg name="FilNam"  value="$FilNm"/>
						<Arg name="Summary" value="STRCAT(文件【,$FilNm,】发送)"/>
						<Arg name="ObjTlr"  value="$TlrId"/> 
					</Exec>
				</Else>
			</If>
			<Else>
				<Exec func="PUB:SendFileMessage2">
					<Arg name="MsgTyp"  value="4"/><!-- 发送打印 -->
					<Arg name="ObjNod"  value="$NodNo"/>
					<Arg name="BusTyp"  value="46"/>
					<Arg name="AplCod"  value="$TxnCod"/>
					<Arg name="FilNam"  value="$FilNm"/>
					<Arg name="Summary" value="STRCAT(文件【,$FilNm,】发送打印)"/>
					<Arg name="ObjTlr"  value="$TlrId"/> 
				</Exec>
			</Else>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>

		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485454" desc="清算奖期查询">
		<Quote name="CommonSql"/>
		<DynSentence name="QryLotDrwTbl" desc="查询奖期记录">
			<Sentence>
				select *
				from LotDrwTbl
				where GameId = '%s' and SubStr(SalEnd, 1, 8) &lt; '%s'
					and (ChkFlg != '3' or PayFlg not in ('0','2'))
					and KenoId in ('','AAAAA')
				order by GameId, DrawId asc
			</Sentence>
			<Fields>GameId|ClrDat|</Fields>
		</DynSentence>
		<FlowCtrl>
				
			<!-- 判断是否多页查询 -->
			<If condition="IS_EQUAL_STRING($TIATyp,P)">
				<Exec func="PUB:MultiQuery" />
				<Return/>
			</If>
			
			<!-- 开始查询并组织数据 -->
			<Exec func="PUB:MultiQuery" error="IGNORE">
				<Arg name="SqlCmd" value="QryLotDrwTbl"/>
			</Exec>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="485455" desc="投注查询">
		<Quote name="CommonSql"/>
		<DynSentence name="QryLotTxnJnl" desc="查询投注记录">
			<Sentence>
				select a.*, b.PrzAmt
				from LotTxnJnl a left join LotPrzDtl b
				on (a.gameId = b.gameid and a.drawid = b.drawid and a.txnlog = b.txnlog)
				where a.GameId = '%s' and (a.DrawId = '%s' or '%s' = '')
					and (a.KenoId = '%s' or '%s' = '')
					and (a.TxnSts = '%s' or '%s' = '') and (a.HTxnSt = '%s' or '%s' = '')
					and (a.TTxnSt = '%s' or '%s' = '') and (a.TxnLog = '%s' or '%s' = '')
					and (a.BetMod = '%s' or '%s' = '')
					and a.BetDat between '%s' and '%s'
					%s
				order by a.GameId, a.DrawId, a.TxnLog asc
			</Sentence>
			<Fields>GameId|DrawId|DrawId|KenoId|KenoId|TxnSts|TxnSts|HTxnSt|HTxnSt|TTxnSt|TTxnSt|TxnLog|TxnLog|BetMod|BetMod|TxnDatStr|TxnDatEnd|PrzSql|</Fields>
		</DynSentence>
		<FlowCtrl>
				
			<!-- 判断是否多页查询 -->
			<If condition="IS_EQUAL_STRING($TIATyp,P)">
				<Exec func="PUB:MultiQuery" />
				<Return/>
			</If>
			
			<If condition="IS_EQUAL_STRING($PrzFlg,1)">
				<Set>PrzSql=STRCAT( and PrzAmt != '')</Set>
			</If>
			<Else>
				<Set>PrzSql= </Set>
			</Else>
			
			<If condition="IS_EQUAL_STRING($TxnDatStr,)">
				<Set>TxnDatStr=19000101</Set>
			</If>
			<If condition="IS_EQUAL_STRING($TxnDatEnd,)">
				<Set>TxnDatEnd=20991331</Set>
			</If>
			
			<!-- 开始查询并组织数据 -->
			<Exec func="PUB:MultiQuery" error="IGNORE">
				<Arg name="SqlCmd" value="QryLotTxnJnl"/>
			</Exec>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			
		</FlowCtrl>
	</Transaction>

</Application>