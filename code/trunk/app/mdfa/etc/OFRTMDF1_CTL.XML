<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="MDF" code="248">
  <LibDeclare>
    <Library name="CBS" value="app/cbs/dll/cbs.so"/>
    <Library name="MDF" value="app/mdfa/dll/mdfa.so"/>
  </LibDeclare>
  <ConfigDeclare>
    <Busdef name="AplCls" value="248"/>
    <Config name="BatFormat" value="etc/MDF_FMT.XML"/>
    <Config name="MDFCSW" value="etc/MDF_CSW.XML"/>
  </ConfigDeclare>
  <TableDeclare>
    <Table name="MDFFILLST" value="MDFFILLST"/>
    <Table name="MDFYHYSHZ" value="MDFYHYSHZ"/>
    <Table name="MDFYHYSMX" value="MDFYHYSMX"/>
    <Table name="MDFCUSINF" value="MDFCUSINF"/>
    <Table name="MDFTXNJNL" value="MDFTXNJNL"/>
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="RptDir" value="dat/term/send/"/>
    <Busdef name="MdfSndDir" value="dat/mdf/send/"/>
    <Busdef name="MdfRcvDir" value="dat/mdf/recv/"/>
    <Busdef name="BankCd" value="53"/>
    <Busdef name="ClrAct" value="441800012620196570499"/>
  </BusDefDeclare>
  <Define>
    <Macro name="InitTran" desc="初始化">
      <Exec func="PUB:GetBranchNoByNodeNo"/>
      <Exec func="PUB:InitTransaction"/>
      <Exec func="PUB:GetAppInfo"/>
    </Macro>
  </Define>


  <Transaction code="464801" desc="客户资料查询">
    <DynSentence name="GetCusInf">
      <Sentence>
        select * from MdfCusInf where TBSDM='%s' and SBBM='%s'
      </Sentence>
      <Fields>TBSDM|SBBM|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetCusInf"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,3,-1)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=MDF999</Set>
        <Set>RspMsg=STRCAT(查询投保属地码【,$TBSDM,】社保编码【,$SBBM,】资料错误)</Set>
        <Return/>
      </If>
      <If condition="INTCMP(~RetCod,3,-2)">
        <Exec func="PUB:CallThirdOther">
          <Arg name="TxnCod" value="$TxnCod"/>
          <Arg name="ObjSvr" value="STHDMDF1"/>
        </Exec>
        <Set>RegDat=$ActDat</Set>
        <Exec func="PUB:InsertRecord" error="IGNORE">
          <Arg name="TblNam" value="MDFCUSINF"/>
        </Exec>
      </If>
    </FlowCtrl>
  </Transaction>


  <Transaction code="464802" desc="医保应收明细浏览">
    <DynSentence name="MultiQuery">
      <Sentence>
        select YSLSH, TBSDM, SBBM, TZNY, SSRQ, XZDM, JE, BokAmt from MDFYHYSMX
         where ( YSLSH='%s' or '%s'='' ) and ( TBSDM='%s' or '%s'='' ) and ( SBBM='%s' or '%s'='' ) and ( TZNY='%s' or '%s'='' )
      </Sentence>
      <Fields>YSLSH|YSLSH|TBSDM|TBSDM|SBBM|SBBM|TZNY|TZNY|</Fields>
    </DynSentence>
    <DynSentence name="GETSINGLE">
      <Sentence>
        select * from MDFYHYSMX where YSLSH='%s'
      </Sentence>
      <Fields>YSLSH|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Switch expression="$Func">
        <Case value="1">
          <Exec func="PUB:MultiQuery"/>
          <Break/>
        </Case>
        <Case value="2">
          <Exec func="PUB:ReadRecord">
            <Args>
              <Arg name="SqlCmd" value="GETSINGLE"/>
            </Args>
          </Exec>
          <Break/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>


  <Transaction code="464803" desc="医保柜面缴款">
    <DynSentence name="GETCUSINF" desc="获取客户资料">
      <Sentence>
        select ZJLX, ZJHM, DWMC from MDFCUSINF where TBSDM='%s' and SBBM='%s'
      </Sentence>
      <Fields>TBSDM|SBBM|</Fields>
    </DynSentence>
    <DynSentence name="GETYHYSMX" desc="前台多笔明细显示">
      <Sentence>
        select TZNY, SSRQ, XZDM, JE, BokAmt from MDFYHYSMX
         where TBSDM='%s' and SBBM='%s' and XZDM='%s' and TZNY='%s' and CDFlag='D' and YSMXZT='F'
           and ( SSRQ between '%s' and '%s' )
      </Sentence>
      <Fields>TBSDM|SBBM|XZDM|TZNY|BSSRQ|ESSRQ|</Fields>
    </DynSentence>
    <DynSentence name="GETSUMAMT" desc="计算金额">
      <Sentence>
        select value(sum(bigint(BokAmt)),0) SumAmt from MDFYHYSMX
         where TBSDM='%s' and SBBM='%s' and XZDM='%s' and TZNY='%s' and CDFlag='D' and YSMXZT='F'
           and ( SSRQ between '%s' and '%s' )
      </Sentence>
      <Fields>TBSDM|SBBM|XZDM|TZNY|BSSRQ|ESSRQ|</Fields>
    </DynSentence>
    <DynSentence name="UPDYHYSMX" desc="更新明细状态">
      <Sentence>
        TBSDM='%s' and SBBM='%s' and XZDM='%s' and TZNY='%s' and CDFlag='D' and YSMXZT='%s' and ( SSRQ between '%s' and '%s' )
      </Sentence>
      <Fields>TBSDM|SBBM|XZDM|TZNY|OYSMXZT|BSSRQ|ESSRQ|</Fields>
    </DynSentence>
    <DynSentence name="UpdTxnJnl" desc="更新流水状态">
      <Sentence>
        LogNo='%s'
      </Sentence>
      <Fields>LogNo|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
    </Attributes>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <Switch expression="$Func">
        <Case value="1"> <!-- 查询 -->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GETCUSINF"/>
            </Args>
          </Exec>
<!--
          <If condition="INTCMP(~RetCod,4,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=MDF999</Set>
            <Set>RspMsg=STRCAT(无投保属地码【,$TBSDM,】社保编码【,$SBBM,】对应资料)</Set>
            <Return/>
          </If>
-->
          <Exec func="PUB:QueryInGroup">
            <Arg name="SqlCmd" value="GETYHYSMX"/>
            <Arg name="RecordName" value="Rec"/>
          </Exec>
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Break/>
        </Case>
        <Case value="2"> <!-- 处理 -->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GETSUMAMT"/>
            </Args>
          </Exec>
          <If condition="OR(INTCMP(~RetCod,4,0),INTCMP($TotAmt,4,$SumAmt))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=MDF999</Set>
            <Set>RspMsg=STRCAT(资料【,$TBSDM,】【,$SBBM,】【,$XZDM,】已变，请重新提交)</Set>
            <Return/>
          </If>
<!--帐务处理-->
<!--更新状态为正在处理-->
          <Set>TxnAmt=FABSAMT($SumAmt,15)</Set>
          <Set>YHHH=441800</Set>
          <Set>ZSFS=02</Set>
          <Set>OYSMXZT=F</Set>
          <Set>YSMXZT=B</Set>
          <Set>JYSJ=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
          <Exec func="PUB:GetLogNo"/>
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="MDFYHYSMX"/>
            <Arg name="CndSts" value="UPDYHYSMX"/>
          </Exec>
          <Set>Smr=医保扣费</Set>
          <Set>ActFlg=$ActTyp</Set>
          <Exec func="PUB:CodeSwitching" error="IGNORE">
            <Arg name="DatSrc"  value="MDFCSW"/>
            <Arg name="SourNam" value="XZDM"/>
            <Arg name="DestNam" value="MASK"/>
            <Arg name="TblNam"  value="XZDMTOMASK"/>
          </Exec>
          <Switch expression="$ActTyp">
            <Case value="0">   <!--现金-->
              <Set>HTxnCd=471140</Set>
              <Set>BusTyp=PCL51</Set>
              <Set>CnlTyp=L</Set>
              <Set>PayMod=0</Set>
              <Set>TActNo=$ClrAct</Set>
              <Set>CcyTyp=0</Set>
              <Set>VchChk=1</Set>
              <Set>CAgtNo=MDF999999999</Set>
              <Break/>
            </Case>
            <Case value="1"/>   <!--一本通-->
            <Case value="2"/>   <!--普通存折-->
            <Case value="4">    <!--太平洋卡-->
              <Set>HTxnCd=471140</Set>
              <Set>BusTyp=PCL52</Set>
              <Set>CnlTyp=L</Set>
              <If condition="IS_EQUAL_STRING($ActTyp,1)">   <!--存折-->
                <Set>VchCod=00000000</Set>
              </If>
              <Set>PayMod=1</Set>
              <Set>TActNo=$ClrAct</Set>
              <Set>CcyTyp=1</Set>
              <Set>VchChk=0</Set>
              <Set>CAgtNo=MDF999999999</Set>
<!--
              <Set>GthFlg=N</Set>
-->
              <Break/>
            </Case>
            <Case value="A">   <!--对公-->
              <Set>HTxnCd=451720</Set>
              <Set>BusTyp=FTT53</Set>
              <Set>BusTyp=FTT53</Set>
              <Set>CrpCod=MDF999999999</Set>
              <Set>RgDFlg=0</Set>
              <Set>OvrSe1=0</Set>
              <Set>RGFlg1=0</Set>
              <Set>CDFlg1=D</Set>
              <Set>CcyCd1=CNY</Set>
              <Set>AccMod=1</Set>
              <Set>ActBk2=$BrNo</Set>
              <Set>ActBr2=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
              <Set>ActSq2=SUBSTR($ClrAct,14,5)</Set>
              <Set>OvrSe2=0</Set>
              <Set>RGFlg2=0</Set>
              <Set>CDFlg2=C</Set>
              <Set>CcyCd2=CNY</Set>
              <Set>InAmt=$TxnAmt</Set>
              <Break/>
            </Case>
            <Case value="B"/>   <!--央财-->
            <Case value="C">   <!--省财-->
              <Set>MsgTyp=E</Set>
              <Set>RspCod=MDF999</Set>
              <Set>RspMsg=暂不支持该类账户缴纳医保</Set>
              <Break/>
            </Case>
          </Switch>
          <Set>CdFlag=D</Set>
          <Set>OIFlag=0</Set>
          <Set>TxnTyp=N</Set>
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="MDFTXNJNL"/>
          </Exec>
          <Exec func="PUB:CallHostAcc" error="IGNORE">
            <Arg name="TxnCod" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <Switch expression="~RetCod">
            <Case value="-10"/>  <!--未发送-->
            <Case value="-2">    <!--系统错误-->
              <Set>YSMXZT=X</Set>
              <Set>TxnSts=X</Set> 
              <Set>HTxnSt=X</Set>
              <Set>HRspCd=341703</Set>
              <Break/>
            </Case>
            <Case value="-1">  <!--上送主机超时-->
              <Set>YSMXZT=T</Set>
              <Set>TxnSts=T</Set> 
              <Set>HTxnSt=T</Set>
              <Set>HRspCd=CD7770</Set>
              <Break/>
            </Case>
            <Case value="0"> <!--交易成功-->
              <Set>TxnSts=S</Set> 
              <Set>HTxnSt=S</Set>
              <Set>YSMXZT=S</Set>
              <Set>BokDat=$ActDat</Set>
              <Set>RtnFlg=0</Set>
              <Set>RspCod=000000</Set>
              <Break/>
            </Case>
            <Default>
              <Set>TckNo= </Set>
              <Set>TxnSts=F</Set> 
              <Set>HTxnSt=F</Set>
              <Set>YSMXZT=F</Set>
              <Set>RspCod=$HRspCd</Set>
              <Break/>
            </Default>
          </Switch>
          <Exec func="PUB:CodeSwitching" error="IGNORE">
            <Arg name="DatSrc"  value="MDFCSW"/>
            <Arg name="SourNam" value="HRSPCD"/>
            <Arg name="DestNam" value="SJZT"/>
            <Arg name="TblNam"  value="HRSPCDTOSJZT"/>
          </Exec>
          <Set>OYSMXZT=B</Set>
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="MDFTXNJNL"/>
            <Arg name="CndSts" value="UpdTxnJnl"/>
          </Exec>
          <Exec func="PUB:UpdateRecord">
            <Arg name="TblNam" value="MDFYHYSMX"/>
            <Arg name="CndSts" value="UPDYHYSMX"/>
          </Exec>
          <Break/>
        </Case>
      </Switch>
    </FlowCtrl>
  </Transaction>



  <Transaction code="464804" desc="医保报表打印">
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Switch expression="$RptTyp">
        <Case value="1"> <!-- 银行代征收社会保险费汇总申报表 -->
          <Set>FmtFil=STRCAT(etc/,MDF001_RPT.XML)</Set>
          <Set>FilNam=STRCAT(MDF001,$TlrId,.RPT)</Set>
          <Set>Summary=银行代征收社会保险费汇总申报表</Set>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=MDF999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="ObjFil" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="BgnDat" value="$BgnDat"/>
        <Arg name="EndDat" value="$EndDat"/>
        <Arg name="PrtDat" value="$ActDat"/>
        <Arg name="PrtTlr" value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="reptprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="464805" desc="医保回单打印">
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Switch expression="$RptTyp">
        <Case value="1"> <!-- 银行代征收社会保险费回单 -->
          <Set>FmtFil=STRCAT(etc/,MDF002_RPT.XML)</Set>
          <Set>FilNam=STRCAT(MDF002,$TlrId,.RPT)</Set>
          <Set>Summary=银行代征收社会保险费回单</Set>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=MDF999</Set>
          <Set>RspMsg=系统错误</Set>
          <Return/>
        </Default>
      </Switch>
      <Exec func="PUB:GenerateReport">
        <Arg name="ObjFil" value="STRCAT($RptDir,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="TBSDM"  value="$TBSDM"/>
        <Arg name="SBBM"   value="$SBBM"/>
        <Arg name="TZNY"   value="$TZNY"/>
        <Arg name="BgnDat" value="$BgnDat"/>
        <Arg name="EndDat" value="$EndDat"/>
        <Arg name="ZSFS"   value="$ZSFS"/>
        <Arg name="PrtDat" value="$ActDat"/>
        <Arg name="PrtTlr" value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="$TxnCod"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="reptprt"/> 
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>
<!--以下为非柜面交易-->
<!--以下为非柜面交易-->
<!--以下为非柜面交易-->
<!--以下为非柜面交易-->
<!--以下为非柜面交易-->
  <Transaction code="464811" desc="接收客户资料及应收明细文件" timeout="3600">
    <DynSentence name="CHKYSPC" desc="判断批次的重复">
      <Sentence>
        select YSPC from MDFYHYSHZ where YSPC='%s'
      </Sentence>
      <Fields>YSPC|</Fields>
    </DynSentence>
    <DynSentence name="UpdYHDZLSH" desc="更新银行对账流水号">
      <Sentence>
        update MDFYHYSMX set YHDZLSH=right('0000000000000000000000000000'||rtrim(char((row_number()over()+%s))),28)||'%s'
         where YSPC='%s' and RegDat='%s'
      </Sentence>
      <Fields>SelVal|BankCd|YSPC|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="UpdCUSINF" desc="更新客户信息表">
      <Sentence>
         TBSDM='%s' and SBBM='%s'
      </Sentence>
      <Fields>TBSDM|SBBM|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Quote name="InitTran"/>  
<!--获取应收明细文件-->
      <If condition="INTCMP(STRLEN(DELSPACE($LstFNm,all)),3,0)">
          <Exec func="PUB:CallThirdOther" error="IGNORE">
            <Arg name="TxnCod" value="$TxnCod"/>
            <Arg name="ObjSvr" value="STHDMDF1"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=MDF999</Set>
            <Set>RspMsg=系统故障，请稍后重做交易</Set>
            <Return/>
          </If>
      </If>
      <Set>OIFlag=1</Set>
      <Set>FilNam=DELSPACE($LstFNm,all)</Set>
      <Set>LclDir=$MdfRcvDir</Set>
      <Exec func="PUB:FtpGet">
        <Arg name="FtpId" value="MDF001"/>
      </Exec>
      <Set>LstFil=STRCAT( $MdfRcvDir,$LstFNm )</Set>
      <Exec func="PUB:OpenFile">
        <Arg name="FileName" value="$LstFil"/>
        <Arg name="Mode" value="r"/>
      </Exec>
      <While>
        <Delete>DatFNm</Delete>
        <Delete>FilNam</Delete>
        <Delete>DatFil</Delete>
        <Exec func="PUB:CommitWork"/>
        <Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNm"/>
        </Exec>
        <If condition="~RetCod=1">  <!--读到文件尾-->
          <Exec func="PUB:CloseFile"/>
          <Break/>
        </If>
        <Set>DatFNm=TRIM($DatFNm,all)</Set>
        <Set>TblNam=SUBSTR($DatFNm,1,9)</Set>
        <Set>FilNam=$DatFNm</Set>
        <Exec func="PUB:FtpGet">
          <Arg name="FtpId" value="MDF001"/>
        </Exec>
        <System command="MdfFileChg.sh">
          <Arg name="MDFFIL" value="$DatFNm"/>
        </System>
        <Set>DatFil=STRCAT( $MdfRcvDir,$DatFNm )</Set>
<!--文件入库处理-->
<!--设置计数变量，用于判断是否是文件首行-->
        <Set>cnt=0</Set>
        <Set>FilSts=S</Set>
        <Set>SrcFil=STRCAT(GETENV(WORKDIR),/,$DatFil)</Set>
        <Exec func="PUB:OpenFile">
          <Arg name="FileName"   value="$SrcFil"/>
          <Arg name="Mode"       value="r"/>
          <Arg name="ObjectName" value="FilPnt"/>
        </Exec>
        <Exec func="PUB:InitDataParser">
          <Arg name="ConfigName" value="BatFormat"/>
          <Arg name="RootName"   value="BATCH"/>
        </Exec>
        <While>
          <If condition="AND(INTCMP($cnt,3,0),IS_EQUAL_STRING($TblNam,MDFYHYSMX))">   <!--明细第一行-->
            <Delete>YSPC</Delete>
            <Delete>DSJBR</Delete>
            <Delete>PCFSSJ</Delete>
            <Delete>MXBS</Delete>
            <Delete>MXZJE</Delete>
            <Delete>CJBS</Delete>
            <Delete>CJZJE</Delete>
            <Delete>JFYH</Delete>
            <Delete>YHJBR</Delete>
            <Delete>JSSJ</Delete>
            <Delete>JSMXBS</Delete>
            <Delete>JSMXZJE</Delete>
            <Delete>JSCJBS</Delete>
            <Delete>JSCJZJE</Delete>
            <Delete>DZBZ</Delete>
            <Delete>PCBZ</Delete>
            <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
              <Arg name="ConfigName" value="BatFormat"/>
              <Arg name="RootName"   value="BATCH"/>
              <Arg name="NodeName"   value="Process"/>
              <Arg name="AttrName"   value="name"/>
              <Arg name="AttrValue"  value="MDFYHYSHZ"/>
              <Arg name="MaxLen"     value="512"/>
              <Arg name="ObjectName" value="FilPnt"/>
            </Exec>
            <If condition="INTCMP(~RetCod,3,-1)">   <!--解析失败返回-->
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>RspMsg=STRCAT(解析文件【,$DatFNm,】文件头失败)</Set>
              <Break/>
            </If>
            <If condition="OR(INTCMP(~RetCod,3,1),INTCMP($MXBS,3,0))">   <!--文件结束或笔数为零-->
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Break/>
            </If>
<!-- 判断批次的重复性-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="CHKYSPC"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,3,0)">
              <Set>FilSts=R</Set>
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Break/>
            </If>
          </If>
          <Switch expression="$TblNam">
            <Case value="MDFCUSINF">
              <Delete>TBSDM</Delete>
              <Delete>SBBM</Delete>
              <Delete>JFZT</Delete>
              <Delete>SSQ</Delete>
              <Delete>DWMC</Delete>
              <Delete>GRSF</Delete>
              <Delete>CBDWBM</Delete>
              <Delete>CBDWMC</Delete>
              <Delete>ZJLX</Delete>
              <Delete>ZJHM</Delete>
              <Delete>XJHM</Delete>
              <Delete>JFYH</Delete>
              <Delete>YHHH</Delete>
              <Delete>KHYH</Delete>
              <Delete>YHZH</Delete>
              <Delete>YHHM</Delete>
              <Delete>YB</Delete>
              <Delete>DWDZ</Delete>
              <Delete>LXR</Delete>
              <Delete>LXDH</Delete>
              <Break/>
            </Case>
            <Case value="MDFYHYSMX">
<!--
              <Delete>YSPC</Delete>
-->
              <Delete>YSLSH</Delete>
              <Delete>SBPC</Delete>
              <Delete>SBLSH</Delete>
              <Delete>DYSBLSH</Delete>
              <Delete>TBSDM</Delete>
              <Delete>SBBM</Delete>
              <Delete>SSQ</Delete>
              <Delete>HDFS</Delete>
              <Delete>TZNY</Delete>
              <Delete>SSRQ</Delete>
              <Delete>XZDM</Delete>
              <Delete>ZMDM</Delete>
              <Delete>TmpAmt</Delete>
              <Delete>JFZT</Delete>
              <Delete>JFLX</Delete>
              <Delete>JFFS</Delete>
<!--
              <Delete>JFYH</Delete>
-->
              <Delete>YHHH</Delete>
              <Delete>KHYH</Delete>
              <Delete>YHZH</Delete>
              <Delete>YHHM</Delete>
              <Delete>LSH</Delete>
              <Delete>TZTZ</Delete>
              <Delete>FSSJ</Delete>
              <Delete>SJZT</Delete>
              <Delete>SJLY</Delete>
              <Delete>BZ</Delete>
              <Delete>KDM</Delete>
              <Break/>
            </Case>
          </Switch>
          <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
            <Arg name="NodeName"   value="Process"/>
            <Arg name="AttrName"   value="name"/>
            <Arg name="AttrValue"  value="$TblNam"/>
            <Arg name="MaxLen"     value="10240"/>
            <Arg name="ObjectName" value="FilPnt"/>
          </Exec>
          <If condition="INTCMP(~RetCod,3,-1)">   <!--解析失败返回，退出本文件处理，但是继续下一文件-->
            <Exec func="PUB:CloseFile">
              <Arg name="ObjectName" value="FilPnt"/>
            </Exec>
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>RspMsg=STRCAT(解析文件【,$DatFNm,】文件体失败)</Set>
            <Break/>
          </If>
          <If condition="~RetCod=1">   <!--文件已经读取完毕-->
            <Exec func="PUB:CloseFile">
              <Arg name="ObjectName" value="FilPnt"/>
            </Exec>
            <Break/>
          </If>
<!--处理流程-->
<!--客户信息表解析原则：有则更新，无则插入,不考虑数据库出错-->
          <If condition="IS_EQUAL_STRING($TblNam,MDFCUSINF)">
            <Exec func="PUB:UpdateRecord" error="IGNORE">
              <Arg name="TblNam" value="$TblNam"/>
              <Arg name="CndSts" value="UpdCUSINF"/>
            </Exec>
            <If condition="INTCMP(~RetCod,3,-2)">
              <Exec func="PUB:InsertRecord" error="IGNORE">
                <Arg name="TblNam" value="$TblNam"/>
              </Exec>
            </If>
            <Exec func="PUB:CommitWork"/>
          </If>
<!--应收明细表解析原则：插入任意一条失败，当批次数据需全部回滚，然后继续下一个文件处理-->
          <If condition="IS_EQUAL_STRING($TblNam,MDFYHYSMX)">   <!--应收收明细表-->
            <Exec func="PUB:InsertRecord" error="IGNORE">
              <Arg name="TblNam" value="$TblNam"/>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Exec func="PUB:CloseFile">
                <Arg name="ObjectName" value="FilPnt"/>
              </Exec>
              <Exec func="PUB:RollbackWork" error="IGNORE"/>
              <Set>RspMsg=STRCAT(解析文件【,$DatFNm,】文件体失败)</Set>
              <Set>FilSts=F</Set>
              <Break/>
            </If>
          </If>
          <Set>cnt=ADD($cnt,1)</Set>
        </While>
        <If condition="AND(IS_EQUAL_STRING($TblNam,MDFYHYSMX),IS_EQUAL_STRING($FilSts,S))">
          <Set>OIFlag=1</Set>
          <Exec func="PUB:InsertRecord" error="IGNORE">
            <Arg name="TblNam" value="MDFYHYSHZ"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>RspMsg=插入数据表【MDFYHYSHZ】失败</Set>
            <Set>FilSts=F</Set>
            <Exec func="PUB:InsertRecord">
              <Arg name="TblNam" value="MDFFILLST"/>
            </Exec>
            <Continue/>
          </If>
<!--更新对账流水号-->
          <Exec func="PUB:nGetPubSeqNo"> <!--每次查询批次号-->
            <Arg name="SeqNam" value="MDFYHYSMX:YHDZLSH"/>
            <Arg name="SeqCnt" value="$MXBS"/>
            <Arg name="Len"    value="15"/>
            <Arg name="CycCnd" value="Y"/>
          </Exec>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdYHDZLSH"/>
            </Args>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>RspMsg=更新数据表【MDFYHYSMX】【YHDZLSH】失败</Set>
            <Set>FilSts=F</Set>
            <Exec func="PUB:InsertRecord">
              <Arg name="TblNam" value="MDFFILLST"/>
            </Exec>
            <Continue/>
          </If>
        </If>
        <Exec func="PUB:InsertRecord">
          <Arg name="TblNam" value="MDFFILLST"/>
        </Exec>
      </While>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="464812" desc="帐务处理" timeout="7200">
    <DynSentence name="GETYHYSHZ" desc="获取批量文件记录">
      <Sentence>
        select YSPC,bigint(MXBS)-bigint(CJBS) BokNum from MDFYHYSHZ where YSHZZT='U' 
      </Sentence>
    </DynSentence>
    <DynSentence name="UPDYHYSHZ" desc="修改本批次为入账状态，防止重复">
      <Sentence>
        update MDFYHYSHZ set YSHZZT='B', DskNo='%s', BokDat='%s' where YSPC='%s' and YSHZZT='U'
      </Sentence>
      <Fields>DskNo|ActDat|YSPC|</Fields>
    </DynSentence>
    <DynSentence name="UpdBatInf" desc="更新数据提交大小通道">
      <Sentence>
        update PubBatInf set OrnCnt='%s', ChkFlg='1' where DskNo='%s'
      </Sentence>
      <Fields>OrnCnt|DskNo|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
<!--
      <Attribute name="noresponse" value="1"/>
-->
    </Attributes>
    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Set>TTxnCd=464812</Set>
      <Quote name="InitTran"/>
      <Exec func="PUB:Lock">
        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
      </Exec>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GETYHYSHZ"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=MDF999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
        </Exec>
        <Return/>
      </If>
<!--大小通道参数-->
      <Set>TxnCnl=MDF</Set>
      <Set>ObjSvr=OFRTMDF1</Set>
      <Set>TxnObj=OFRTMDF1</Set>
      <Set>HTxnCd=464813</Set>
      <Set>SumFlg=N</Set>          <!--是否进行金额或数量汇总-->
      <Set>NamChk=1</Set>          <!--不需要检查户名-->
      <Set>TxnMod=1</Set>          <!--需要单笔上送-->
      <Set>CmtFlg=0</Set>          <!--大小通道发送状态-->
      <Set>TrdTbl=MDFTXNJNL</Set>
      <Set>UpdFlg=Y</Set>
      <Set>UpdFld=HTXNCD|TCKNO|</Set>
      <Set>IsTxn=Y</Set>
      <Set>SucCnt=0</Set>
      <Set>SucAmt=0</Set>
      <Set>FalCnt=0</Set>
      <Set>FalAmt=0</Set>
      <Set>FTxnCd=464814</Set>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
<!--修改汇总表状态-->
        <Exec func="PUB:ExecSql">
          <Args>
            <Arg name="SqlCmd" value="UPDYHYSHZ"/>
          </Args>
        </Exec>
<!--处理冲正记录-->
        <Exec func="MDF:MdfCanProc" error="IGNORE">
          <Args>
            <Arg name="YSPC" value="$YSPC"/>
          </Args>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=MDF999</Set>
          <Set>RspMsg=处理MDF批量数据出错</Set>
          <Return/>
        </If>
        <Exec func="PUB:CommitWork"/>
<!--处理记账记录-->
        <Exec func="PUB:GetVirtualTeller"/>
        <Delete>DskNo</Delete>
        <Exec func="PUB:RegisterBatchDiskNo"/>
        <Exec func="MDF:MdfBokProc" error="IGNORE">
          <Args>
            <Arg name="YSPC" value="$YSPC"/>
            <Arg name="BokNum" value="$BokNum"/>
          </Args>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
          </Exec>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=MDF999</Set>
          <Set>RspMsg=处理MDF批量数据出错</Set>
          <Return/>
        </If>
        <Exec func="PUB:ExecSql">
          <Args>
            <Arg name="SqlCmd" value="UpdBatInf"/>
          </Args>
        </Exec>
        <Exec func="PUB:CommitWork"/>
        <Exec func="PUB:Sleep">
          <Arg name="SleepTime" value="5"/>
        </Exec>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="STRCAT($AplCls,$BrNo,$TxnCod)"/>
      </Exec>
      <Set>MsgTye=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="464813" desc="明细提交记帐" timeout="3600">
    <DynSentence name="GetNewAct">
      <Sentence>
        select YHZH ActNo, YHHM from MdfCusInf where TBSDM='%s' and SBBM='%s'
      </Sentence>
      <Fields>TBSDM|SBBM|</Fields>
    </DynSentence>
    <DynSentence name="UpdTxnJnl">
      <Sentence>
        LogNo='%s'
      </Sentence>
      <Fields>LogNo|</Fields>
    </DynSentence>
    <DynSentence name="UPDYHYSMX" desc="修改明细状态，处理时间">
      <Sentence>
        LogNo='%s'
      </Sentence>
      <Fields>LogNo|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
    </Attributes>
    <FlowCtrl>
      <Set>YHHH=441800</Set>
      <Set>JYSJ=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
      <Set>ZSFS=03</Set>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Args>
          <Arg name="SqlCmd" value="GetNewAct"/>
        </Args>
      </Exec>
      <If condition="OR(INTCMP(~RetCod,4,0),INTCMP(STRLEN(DELSPACE($ActNo,all)),3,0))">
        <Set>TckNo= </Set>
        <Set>HTxnCd= </Set>
        <Set>YSMXZT=F</Set>
        <Set>SJZT=0003</Set>  <!--如果不存在资料也统一更新为0003,5315暂未启用-->
        <Set>TxnSts=F</Set>
        <Goto>UpdTag</Goto>
      </If>
      <Set>YHHM=DELSPACE($YHHM,all)</Set>
      <Exec func="CBS:CbsGetAccFlg">
        <Args>
          <Arg name="ActNo" value="$ActNo"/>
        </Args>
      </Exec>
      <Set>ActTyp=$LActFg</Set>
      <Switch expression="$ActTyp">
        <Case value="0"/>   <!--对公-->
        <Case value="A"/>   <!--对公-->
        <Case value="B">    <!--对公-->
          <Set>HTxnCd=109000</Set>
          <Break/>
        </Case>
        <Case value="1"/>   <!--一本通-->
        <Case value="2"/>   <!--普通存折-->
        <Case value="4">    <!--太平洋卡-->
          <Set>CcyCod=CNY</Set>
          <Set>HTxnCd=476520</Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:CallHostOther" error="INGORE">
        <Arg name="HTxnCd" value="$HTxnCd"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>YSMXZT=F</Set>
        <Set>SJZT=5301</Set>
        <Set>TxnSts=F</Set>
        <Goto>UpdTag</Goto>
      </If>
      <Else>
        <If condition="IS_NOEQUAL_STRING(DELSPACE($ActNam,all),$YHHM)">
          <Set>YSMXZT=F</Set>
          <Set>SJZT=5303</Set>
          <Set>TxnSts=F</Set>
          <Goto>UpdTag</Goto>
        </If>
      </Else>
<!--帐务处理-->
      <If condition="IS_EQUAL_STRING($CdFlag,C)">   <!--退款-->
<!--检查原扣款交易状态-->
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="GetOrgDtl"/>
          </Args>
        </Exec>
        <If condition="OR(INTCMP(~RetCod,4,0),IS_EQUAL_STRING($OSts,F))"> <!--无记录-->
          <Exec func="PUB:ExecSql">
            <Args>
              <Arg name="SqlCmd" value="UpdOrgDtl"/>
            </Args>
          </Exec>
          <Set>TckNo= </Set>
          <Set>HTxnCd= </Set>
          <Set>YSMXZT=S</Set>
          <Set>SJZT=0053</Set>
          <Set>TxnSts=S</Set> 
        </If>
        <Else>
          <If condition="IS_EQUAL_STRING(OSts,S)">
            <Set>YSMXZT=F</Set>
            <Set>SJZT=0051</Set>
            <Set>TxnSts=F</Set> 
          </If>
        </Else>
        <Goto>UpdTag</Goto>
      </If>
      <Else>   <!--扣款【客户－＞26201】-->
        <Set>Smr=医保扣费</Set>
        <Switch expression="$ActTyp">
          <Case value="1"/>   <!--一本通-->
          <Case value="2"/>   <!--普通存折-->
          <Case value="4">    <!--太平洋卡-->
            <Set>HTxnCd=471140</Set>
            <Set>BusTyp=PCL52</Set>
            <Set>CnlTyp=L</Set>
            <Set>Mask=9117</Set>
            <If condition="OR(IS_EQUAL_STRING($ActTyp,1),IS_EQUAL_STRING($ActTyp,2))">   <!--存折-->
              <Set>ActFlg=2</Set>
              <Set>VchCod=00000000</Set>
            </If>
            <Else>
              <Set>ActFlg=4</Set>
            </Else>
            <Set>ActNo=$BokAct</Set>
            <Set>PayMod=0</Set>
            <Set>TActNo=$ClrAct</Set>
            <Set>CcyTyp=1</Set>
            <Set>VchChk=0</Set>
            <Set>CAgtNo=MDF999999999</Set>
<!--
            <Set>GthFlg=N</Set>
-->
            <Break/>
          </Case>
          <Case value="A">   <!--对公-->
            <Set>HTxnCd=451720</Set>
            <Set>BusTyp=FTT53</Set>
            <Set>BusTyp=FTT53</Set>
            <Set>CrpCod=MDF999999999</Set>
            <Set>RgDFlg=0</Set>
            <Set>ActNo=$BokAct</Set>
            <Set>OvrSe1=0</Set>
            <Set>RGFlg1=0</Set>
            <Set>CDFlg1=D</Set>
            <Set>CcyCd1=CNY</Set>
            <Set>AccMod=1</Set>
            <Set>ActBk2=$BrNo</Set>
            <Set>ActBr2=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
            <Set>ActSq2=SUBSTR($ClrAct,14,5)</Set>
            <Set>OvrSe2=0</Set>
            <Set>RGFlg2=0</Set>
            <Set>CDFlg2=C</Set>
            <Set>CcyCd2=CNY</Set>
            <Set>InAmt=$TxnAmt</Set>
            <Break/>
          </Case>
        </Switch>
        <Exec func="PUB:CallHostAcc" error="IGNORE">
          <Arg name="TxnCod" value="$HTxnCd"/>
          <Arg name="ObjSvr" value="SHSTPUB1"/>
        </Exec>
        <Switch expression="~RetCod">
          <Case value="-10"/>  <!--未发送-->
          <Case value="-2">    <!--系统错误-->
            <Set>YSMXZT=X</Set>
            <Set>TxnSts=X</Set> 
            <Set>HTxnSt=X</Set>
            <Set>HRspCd=341703</Set>
            <Break/>
          </Case>
          <Case value="-1">  <!--上送主机超时-->
            <Set>YSMXZT=T</Set>
            <Set>TxnSts=T</Set> 
            <Set>HTxnSt=T</Set>
            <Set>HRspCd=CD7770</Set>
            <Break/>
          </Case>
          <Case value="0"> <!--交易成功-->
            <Set>TxnSts=S</Set> 
            <Set>HTxnSt=S</Set>
            <Set>YSMXZT=S</Set>
            <Break/>
          </Case>
          <Default>
            <Set>TckNo= </Set>
            <Set>TxnSts=F</Set> 
            <Set>HTxnSt=F</Set>
            <Set>YSMXZT=F</Set>
            <Break/>
          </Default>
        </Switch>
        <Exec func="PUB:CodeSwitching" error="IGNORE">
          <Arg name="DatSrc"  value="MDFCSW"/>
          <Arg name="SourNam" value="HRSPCD"/>
          <Arg name="DestNam" value="SJZT"/>
          <Arg name="TblNam"  value="HRSPCDTOSJZT"/>
        </Exec>
      </Else>
      <Label>UpdTag</Label>
      <Delete>XZDM</Delete> <!--避免由于汇总扣款造成原记录错误-->
      <Set>BokDat=$ActDat</Set>
      <Exec func="PUB:UpdateRecord">
        <Arg name="TblNam" value="MDFTXNJNL"/>
        <Arg name="CndSts" value="UpdTxnJnl"/>
      </Exec>
      <Exec func="PUB:UpdateRecord">
        <Arg name="TblNam" value="MDFYHYSMX"/>
        <Arg name="CndSts" value="UPDYHYSMX"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>




  <Transaction code="464814" desc="更新批次状态">
    <DynSentence name="UPDYHYSHZ"> <!--修改本批次为已处理状态-->
      <Sentence>
        update MDFYHYSHZ set YSHZZT='2' where DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Set>DskNo=$LogNo</Set>
      <Exec func="PUB:ExecSql">
       <Args>
          <Arg name="SqlCmd" value="UPDYHYSHZ"/>
        </Args>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="464815" desc="成功数据返回" timeout="3600">
    <DynSentence name="UpdMxDZPC"> <!--修改状态-->
      <Sentence>
        update MDFYHYSMX set DZPC='%s', RtnFlg='1', YHFSSJ='%s' where YSMXZT='S' and CdFlag='D' and BokDat='%s'
      </Sentence>
      <Fields>DZPC|YHFSSJ|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="GetMDFYHYSHZ"> <!--获取文件头-->
      <Sentence>
        select count(*) Num, value(sum(bigint(BokAmt)),0) Amt from MDFYHYSMX where YSMXZT='S' and DZPC='%s' and %s and CdFlag='D' 
      </Sentence>
      <Fields>DZPC|SqlStr|</Fields>
    </DynSentence>
    <DynSentence name="GetMDFYHDZMX"> <!--获取返回记录-->
      <Sentence>
        select YHDZLSH, SBPC, SBLSH, TBSDM, SBBM, SSQ, TZNY, SSRQ, XZDM, ZMDM, JFYH, LogNo JYLSH, JYSJ, ZSFS,
               YHHH, KHYH, YHZH, YHHM, HDFS, JFFS, JFZT, JFLX, KDM, DZPC, YHFSSJ,
               case when CdFlag='C' then (-1)*bigint(JE)  when CdFlag='D' then bigint(JE) end JE,
               case when CdFlag='C' then (-1)*bigint(BokAmt)  when CdFlag='D' then bigint(BokAmt) end BokAmt
          from MDFYHYSMX where YSMXZT='S' and DZPC='%s' and CDFlag='D'
      </Sentence>
      <Fields>DZPC|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>  <!--设置数据库全程连接-->
    </Attributes>

    <FlowCtrl>
      <Exec func="PUB:IsExistNode" error="IGNORE">
        <Arg name="FieldName" value="RtnDat"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,1)">  <!--手工发起回应-->
        <Set>ActDat=$RtnDat</Set>
      </If>
      <Set>NodNo=441800</Set>
      <Quote name="InitTran"/>
      <Exec func="PUB:GetPubSeqNoCircle">
        <Arg name="SeqNam" value="MDF:DZPC"/>
        <Arg name="Len"    value="9"/>
      </Exec>
      <Set>DZPC=STRCAT($SelVal,$BankCd)</Set>
      <Set>YHFSSJ=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
<!--更新发送批次、发送明细状态为"发送"-->
      <Exec func="PUB:ExecSql">
        <Args>
          <Arg name="SqlCmd" value="UpdMxDZPC"/>
        </Args>
      </Exec>
<!--统计冲减(贷方)总笔数、金额-->
      <Set>CdFlag=C</Set>
<!--
      <Set>SqlStr=STRCAT( CdFlag=',$CdFlag,' )</Set>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetMDFYHYSHZ"/>
        </Args>
      </Exec>
      <Set>CJBS=$Num</Set>
      <Set>CJZJE=$Amt</Set>
-->
<!--统计冲减(贷方)总成功笔数、金额-->
      <Set>SqlStr=STRCAT( CdFlag=',$CdFlag,' and YSMXZT='S' )</Set>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetMDFYHYSHZ"/>
        </Args>
      </Exec>
      <Set>CJBS=$Num</Set>
      <Set>CJZJE=$Amt</Set>
      <Set>JSCJBS=0</Set>
      <Set>JSCJZJE=0.00</Set>
<!--统计扣收(借方)总笔数、金额-->
      <Set>CdFlag=D</Set>
<!--
      <Set>SqlStr=STRCAT( CdFlag=',$CdFlag,' )</Set>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetMDFYHYSHZ"/>
        </Args>
      </Exec>
      <Set>MXBS=ADD( $Num,$CJBS )</Set>
      <Set>MXZJE=SUB( $Amt,$CJZJE )</Set>
-->
<!--统计扣收(借方)总成功笔数、金额-->
      <Set>SqlStr=STRCAT( CdFlag=',$CdFlag,' and YSMXZT='S' )</Set>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetMDFYHYSHZ"/>
        </Args>
      </Exec>
      <Set>MXBS=$Num</Set>
      <Set>MXZJE=$Amt</Set>
      <Set>JSMXBS=0</Set>
      <Set>JSMXZJE=0.00</Set>
<!--其他文件头要素-->
      <Set>JFYH=$BankCd</Set>
      <Set>YHJBR=EMDFBI1</Set>
      <Set>FilTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
      <Set>FSSJ=$YHFSSJ</Set>
      <Set>DSJBR= </Set>
      <Set>JSSJ=$YHFSSJ</Set>
      <Set>DZBZ=2</Set>
      <Set>SZZT=0002</Set>
      <Set>BZ= </Set>
      <Set>FilNam=STRCAT(FILE,$FilTim,.txt)</Set>
      <Set>LclDir=$MdfSndDir</Set>
      <Set>DatFil=STRCAT( $MdfSndDir,$FilNam )</Set>
      <Exec func="PUB:ExportFromDB">
        <Args>
          <Arg name="FormatName" value="MDFYHDZMX"/>
          <Arg name="FileName"   value="$DatFil"/>
          <Arg name="TableName"  value="MDFYHDZMX"/>
          <Arg name="SqlName"    value="GetMDFYHDZMX"/>
        </Args>
      </Exec>
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="MDF001"/>
      </Exec>
      <Exec func="PUB:CallThirdOther">
        <Arg name="TxnCod" value="464815"/>
        <Arg name="ObjSvr" value="STHDMDF1"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="464816" desc="全部数据返回" timeout="3600">
    <DynSentence name="GetMDFYHYSMXALL" desc="返回数据">
      <Sentence>
        select YSPC, YSLSH, SBPC, SBLSH, DYSBLSH, TBSDM, SBBM, SSQ, HDFS, TZNY, SSRQ, XZDM, ZMDM, JFZT, JFLX, JFFS,
               JFYH, YHHH, KHYH, YHZH, YHHM, LSH, TZTZ, FSSJ, SJZT, SJLY, BZ, KDM,
               case when CdFlag='C' then (-1)*bigint(JE) when CdFlag='D' then bigint(JE) end JE,
               case when CdFlag='C' then (-1)*bigint(BokAmt) when CdFlag='D' then bigint(BokAmt) end BokAmt
          from MDFYHYSMX where YSMXZT in ( 'S','F' ) and BokDat='%s' and ( RtnFlg='0' or ( RtnFlg='1' and JE=BOKAMT ) ) 
      </Sentence>
      <Fields>ActDat|</Fields>
    </DynSentence>
    <DynSentence name="UpdMxRtnFlg"> <!--修改状态-->
      <Sentence>
        update MDFYHYSMX set RtnFlg='1' where BokDat='%s' 
      </Sentence>
      <Fields>ActDat|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Exec func="PUB:IsExistNode" error="IGNORE">
        <Arg name="FieldName" value="RtnDat"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,1)">  <!--手工发起回应-->
        <Set>ActDat=$RtnDat</Set>
      </If>
      <Set>NodNo=441800</Set>
      <Quote name="InitTran"/>
      <Set>FilTim=GETDATETIME(YYYYMMDDHHMISS)</Set>
      <Set>FSSJ=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
      <Set>FilNam=STRCAT(FILE,$FilTim,.txt)</Set>
      <Set>LclDir=$MdfSndDir</Set>
      <Set>DatFil=STRCAT( $MdfSndDir,$FilNam )</Set>
      <Exec func="PUB:ExportFromDB">
        <Args>
          <Arg name="FormatName" value="MDFYHYSMXALL"/>
          <Arg name="FileName"   value="$DatFil"/>
          <Arg name="TableName"  value="MDFYHDZMX"/>
          <Arg name="SqlName"    value="GetMDFYHYSMXALL"/>
        </Args>
      </Exec>
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="MDF001"/>
      </Exec>
      <Exec func="PUB:CallThirdOther" error="IGNORE">
        <Arg name="TxnCod" value="464816"/>
        <Arg name="ObjSvr" value="STHDMDF1"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=MDF999</Set>
        <Set>RspMsg=发送文件失败</Set>
        <Return/>
      </If>
      <Exec func="PUB:ExecSql">
        <Args>
          <Arg name="SqlCmd" value="UpdMxRtnFlg"/>
        </Args>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="464899" desc="根据身份证号获取投保属地码、设备编码">
    <DynSentence name="GetSBBMByZJHM" desc="获取客户资料">
      <Sentence>
        select distinct TBSDM, SBBM from MDFCUSINF where ZJHM='%s'
      </Sentence>
      <Fields>ZJHM|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:ReadRecord">
        <Args>
          <Arg name="SqlCmd" value="GetSBBMByZJHM"/>
        </Args>
      </Exec>
    </FlowCtrl>
  </Transaction>




  <Transaction code="464891" desc="接收客户资料及应收明细文件【老版本，已停用，未删除】" timeout="3600">
    <DynSentence name="CHKYSPC" desc="判断批次的重复">
      <Sentence>
        select YSPC from MDFYHYSHZ where YSPC=substr('%s',22,6)
      </Sentence>
      <Fields>DatFNm|</Fields>
    </DynSentence>
    <DynSentence name="UpdYHDZLSH" desc="更新银行对账流水号">
      <Sentence>
        update MDFYHYSMX set YHDZLSH=right('0000000000000000000000000000'||rtrim(char((row_number()over()+%s))),28)||'%s'
         where YSPC='%s' and RegDat='%s'
      </Sentence>
      <Fields>SelVal|BankCd|YSPC|ActDat|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Set>NodNo=441800</Set>
      <Quote name="InitTran"/>  
<!--获取应收明细文件-->
      <If condition="INTCMP(STRLEN(DELSPACE($LstFNm,all)),3,0)">
        <Exec func="PUB:CallThirdOther" error="IGNORE">
          <Arg name="TxnCod" value="$TxnCod"/>
          <Arg name="ObjSvr" value="STHDMDF1"/>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=MDF999</Set>
          <Set>RspMsg=系统故障，请稍后重做交易</Set>
          <Return/>
        </If>
      </If>
      <Set>OIFlag=1</Set>
      <Set>FilNam=DELSPACE($LstFNm,all)</Set>
      <Set>LclDir=$MdfRcvDir</Set>
      <Exec func="PUB:FtpGet">
        <Arg name="FtpId" value="MDF001"/>
      </Exec>
      <Set>LstFil=STRCAT( $MdfRcvDir,$LstFNm )</Set>
      <Exec func="PUB:OpenFile">
        <Arg name="FileName" value="$LstFil"/>
        <Arg name="Mode" value="r"/>
      </Exec>
      <While>
        <Delete>DatFNm</Delete>
        <Delete>FilNam</Delete>
        <Delete>DatFil</Delete>
        <Exec func="PUB:CommitWork"/>
        <Exec func="PUB:GetFileLine" error="IGNORE">
          <Arg name="FieldName" value="DatFNm"/>
        </Exec>
        <If condition="~RetCod=1">  <!--读到文件尾-->
          <Exec func="PUB:CloseFile"/>
          <Break/>
        </If>
        <Set>DatFNm=TRIM($DatFNm,all)</Set>
        <Set>TblNam=SUBSTR($DatFNm,1,9)</Set>
<!-- 判断批次的重复性-->
        <If condition="IS_EQUAL_STRING($TblNam,MDFYHYSMX)">
<!--清除FMT中HEAD部分变量-->
          <Delete>YSPC</Delete>
          <Delete>DSJBR</Delete>
          <Delete>PCFSSJ</Delete>
          <Delete>MXBS</Delete>
          <Delete>MXZJE</Delete>
          <Delete>CJBS</Delete>
          <Delete>CJZJE</Delete>
          <Delete>JFYH</Delete>
          <Delete>YHJBR</Delete>
          <Delete>JSSJ</Delete>
          <Delete>JSMXBS</Delete>
          <Delete>JSMXZJE</Delete>
          <Delete>JSCJBS</Delete>
          <Delete>JSCJZJE</Delete>
          <Delete>DZBZ</Delete>
          <Delete>PCBZ</Delete>
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="CHKYSPC"/>
            </Args>
          </Exec>
          <If condition="INTCMP(~RetCod,3,0)">
            <Continue/>
          </If>
        </If>
        <Set>FilNam=$DatFNm</Set>
        <Exec func="PUB:FtpGet">
          <Arg name="FtpId" value="MDF001"/>
        </Exec>
        <System command="MdfFileChg.sh">
          <Arg name="MDFFIL" value="$DatFNm"/>
        </System>
        <Set>DatFil=STRCAT( $MdfRcvDir,$DatFNm )</Set>
        <Exec func="PUB:ImportToDB" error="IGNORE">
          <Args>
            <Arg name="FormatName" value="$TblNam"/>
            <Arg name="FileName"   value="$DatFil"/>
            <Arg name="TableName"  value="$TblNam"/>
          </Args>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Exec func="PUB:RollbackWork" error="IGNORE"/>
          <Set>RspMsg=STRCAT(文件【,$DatFil,】解析失败)</Set>
          <Set>FilSts=F</Set>
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="MDFFILLST"/>
          </Exec>
          <Continue/>
        </If>
<!--插入汇总记录-->
        <If condition="IS_EQUAL_STRING($TblNam,MDFYHYSMX)">
          <Set>OIFlag=1</Set>
          <Exec func="PUB:InsertRecord" error="IGNORE">
            <Arg name="TblNam" value="MDFYHYSHZ"/>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>RspMsg=插入数据表【MDFYHYSHZ】失败</Set>
            <Set>FilSts=F</Set>
            <Exec func="PUB:InsertRecord">
              <Arg name="TblNam" value="MDFFILLST"/>
            </Exec>
            <Continue/>
          </If>
<!--更新对账流水号-->
          <Exec func="PUB:nGetPubSeqNo"> <!--每次查询批次号-->
            <Arg name="SeqNam" value="MDFYHYSMX:YHDZLSH"/>
            <Arg name="SeqCnt" value="$MXBS"/>
            <Arg name="Len"    value="15"/>
            <Arg name="CycCnd" value="Y"/>
          </Exec>
          <Set>SelVal=SUB($SelVal,1)</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdYHDZLSH"/>
            </Args>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Exec func="PUB:RollbackWork" error="IGNORE"/>
            <Set>RspMsg=更新数据表【MDFYHYSMX】【YHDZLSH】失败</Set>
            <Set>FilSts=F</Set>
            <Exec func="PUB:InsertRecord">
              <Arg name="TblNam" value="MDFFILLST"/>
            </Exec>
            <Continue/>
          </If>
        </If>
        <Set>FilSts=S</Set>
        <Exec func="PUB:InsertRecord">
          <Arg name="TblNam" value="MDFFILLST"/>
        </Exec>
      </While>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>



</Application>
