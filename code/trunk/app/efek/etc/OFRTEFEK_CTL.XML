<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="EFEA" code="202">
  <!--电力电费业务本地主控-->
  <ConfigDeclare>
    <Config name="BatFormat"   value="etc/EFE_FMT_441999.XML"/>
    <Config name="ParaFile"    value="etc/CFG_EFE_441999.XML"/>
    <Config name="OPFCSW"      value="etc/EFE_CSW_441999.XML"/>
  </ConfigDeclare>
  <PackageDeclare>
    <Package name="EFE"        value="etc/EFEK_JOB_PKG.XML"/>
    <Package name="AFE"        value="etc/DAFE_PKG.XML"/>
  </PackageDeclare>
  <TableDeclare>
    <Table name="afetxnjnl"  value="afetxnjnl"/>  <!--业务流水表-->
    <Table name="afebatrec"  value="afebatrec"/>  <!--批量扩展表-->
    <Table name="EfekRunCtl" value="EfeKRunCtl" desc="业务控制表"/>
    <Table name="EfekCusAgt" value="EfekCusAgt" desc="客户协议表"/>
    <Table name="EfekTxnJnl" value="EfekTxnJnl" desc="交易流水表"/>
    <Table name="EfekTxnDtl" value="EfekTxnDtl" desc="交易明细表"/>
    <Table name="EfekBchRec" value="EfekBchRec" desc="交易批量表"/>
    <!--Table name="efeinfctl"  value="efeinfctl"/-->  <!--银电开工控制表-->
    <!--Table name="efechkinf"  value="efechkinf"/-->  <!--银电对账信息表-->
    <!--Table name="efekchkdtl" value="efekchkdtl"/-->  <!--银电对账明细表-->
    <!--Table name="efecusagt"  value="efecusagt"/-->  <!--银电客户签约表-->
    <!--Table name="efebatinf"  value="efebatinf"/-->  <!--银电批量代扣表-->
    <!--Table name="efechkrec"  value="efechkrec"/-->  <!--银电对账记录表-->
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="AplCls"    value="202"/> <!--add by xuan_20101108-->
  </BusDefDeclare>
  <GlobalFunction>
    <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
    <!--add by xuan_20101108-->
    <Function name="_after">
        <Process>
           <If condition="ISNULL($MsgTyp)">
              <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                 <Set>MsgTyp=N</Set>
                 <Set>RspCod=000000</Set>
              </If>
              <Else>
                 <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                    <Set>MsgTyp=E</Set>
                 </If>
                 <Else>
                    <Set>MsgTyp=N</Set>
                 </Else>
              </Else>
           </If>
        </Process>
    </Function>
    <!--end by xuan_20101108-->
  </GlobalFunction>
  <Define>
    <Include file="etc/EFEK_MCR.XML"/>
  </Define>


  <Transaction code="460460" desc="广东电力电费清算报表打印">
    <DynSentence name="QryJnlInfo">            <!--流水信息 -->
      <Sentence>
        SELECT LogNo FROM afetxnjnl WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat &gt;='%s' and ActDat &lt;='%s' order by LogNo asc
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat1|TxnDat2|</Fields>
    </DynSentence>
    
    <DynSentence name="Updatquery">
      <Sentence>
        update afetxnjnl set ChkFlg='1' where CAgtNo='%s' AND ActDat='%s' and logno='%s'
      </Sentence>
      <Fields>CAgtNo|TxnDat|logno|</Fields>
    </DynSentence>
  
    <FlowCtrl>
    	 <!--Quote name="GetEfeId"/-->
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>
      <Exec func="PUB:ReadRecord">  <!--查询 -->
        <Arg name="SqlCmd" value="QryJnlInfo"/>
      </Exec>
     <Switch expression="~RetCod">
         <Case value="-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
            <Return/>
         </Case>
         <Case value="0">
            <Break/>
         </Case>
       <Default>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据不存在</Set>
            <Return/>
         </Default>
    </Switch>
     <If condition="$PrtFlg=1"><!--批扣成功报表 -->
        <Set>FmtFil=etc/EFE_RPT_CFG.XML</Set>
        <Set>FilNam=STRCAT(EFE批扣成功报表,$EfeId,$TxnDat1,$TxnDat2,GETDATETIME(HHMISS))</Set>
    </If>
    <If condition="$PrtFlg=2"><!--单笔成功报表-->
        <Set>FmtFil=etc/EFE_RPT_CFG2.XML</Set>
        <Set>FilNam=STRCAT(EFE单笔成功报表,$EfeId,$TxnDat1,$TxnDat2,GETDATETIME(HHMISS))</Set>
    </If>
     <If condition="$PrtFlg=3"><!--批扣可疑报表 -->
        <Set>FmtFil=etc/EFE_RPT_CFG3.XML</Set>
        <Set>FilNam=STRCAT(EFE批扣可疑报表,$EfeId,$TxnDat1,$TxnDat2,GETDATETIME(HHMISS))</Set>
    </If>
    <If condition="$PrtFlg=4"><!--单笔可疑报表-->
        <Set>FmtFil=etc/EFE_RPT_CFG4.XML</Set>
        <Set>FilNam=STRCAT(EFE单笔可疑报表,$EfeId,$TxnDat1,$TxnDat2,GETDATETIME(HHMISS))</Set>
    </If>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="BrNo"   value="$BrNo"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat1" value="$TxnDat1"/>
        <Arg name="TxnDat2" value="$TxnDat2"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Set>LclFil=$FilNam</Set>   
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="EFESnd493181"/>
      </Exec>
      
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
        
    </FlowCtrl>
  </Transaction>

  <Transaction code="460461" desc="广东电力电费清算">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Updafetxnjnl"><!--修改信息-->
      <Sentence>
        update afetxnjnl set ChkFlg='1' WHERE ActDat ='%s' and CAgtNo='%s' and TxnSts='S'
      </Sentence>
      <Fields>ClrDat|CAgtNo|</Fields>
    </DynSentence>

    <FlowCtrl>
    	 <!--Quote name="GetEfeId"/-->
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=EFE999</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>

     <Exec func="PUB:AddAuthReason" >
         <Arg name="AthCod" value="40" />
         <Arg name="AthMsg" value="EFE000" />
     </Exec>
     <Exec  func="PUB:CheckLocalAuth" >
         <Arg name="ObjSvr" value="SHSTPUB1" />
     </Exec>

      <Set>HTxnCd=451900</Set>
      <Set>BusTyp=PCL76</Set>
      <Set>RgCFlg=1</Set>   <!--贷方回单，不登记0，登记 1 -->
        <!--441999广东省分行-->
        <!--444999珠海分行-->
        <!--446999佛山分行-->
        <!--445999汕头分行-->
        <!--483999东莞分行-->
        <!--484999中山分行-->
        <!--485999揭阳支行-->
        <!--491999惠州分行-->
        <!--761999江门分行-->
      <Switch  expression="$EfeId">
      	 <Case value="493999">
          <Set>ActBk1=493999</Set>
          <Set>ActBr1=493800</Set>
          <Break/>
        </Case>
        <Case value="441999">
          <Set>ActBk1=441999</Set>
          <Set>ActBr1=441800</Set>
          <Break/>
        </Case>
        <Case value="444999">
        	<Set>ActBk1=444999</Set>
          <Set>ActBr1=444800</Set>
          <Break/>
        </Case>
        <Case value="446999">
          <Set>ActBk1=446999</Set>
          <Set>ActBr1=446800</Set>
          <Break/>
        </Case>
        <Case value="445999">
          <Set>ActBk1=445999</Set>
          <Set>ActBr1=445800</Set>
          <Break/>
        </Case>
        <Case value="483999">
          <Set>ActBk1=483999</Set>
          <Set>ActBr1=483800</Set>
          <Break/>
        </Case>
        <Case value="484999">
          <Set>ActBk1=484999</Set>
          <Set>ActBr1=484800</Set>          
          <Break/>
        </Case>
        <Case value="485999">
           <Set>ActBk1=485999</Set>
           <Set>ActBr1=485730</Set>  
          <Break/>
        </Case>
        <Case value="491999">
          <Set>ActBk1=491999</Set>
          <Set>ActBr1=491800</Set>  
          <Break/>
        </Case>
        <Case value="476999">
          <Set>ActBk1=476999</Set>
          <Set>ActBr1=476800</Set>  
          <Break/>
        </Case>
        <Default>
          <Set>ActBk1=441999</Set>
          <Set>ActBr1=441800</Set>
        </Default>
      </Switch>

      <Set>ActSq1=SUBSTR($TActNo,14,5)</Set>
      <Set>CdFlg1=D</Set>
      <Set>OuAmt1=$TxnAmt</Set>
      <Set>PayAt5=$STLACT</Set>
      <Set>CdFlg5=C</Set>
      <Set>InAmt5=$TxnAmt</Set>

      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>

      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="$HTxnCd"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>

    <!--
        <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
      -->

      <If condition="~RetCod=0">  <!--recsts 0:初始化 1:成功 2:失败 -->
        <Exec func="PUB:ExecSql">
           <Arg name="SqlCmd" value="Updafetxnjnl"/>
        </Exec>
      </If>

    </FlowCtrl>
  </Transaction>

   <Transaction code="460464" desc="广东省电力电费查询清算金额">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryEfeTot">
      <Sentence>
        select sum(cast(TxnAmt as bigint)) as SumAmt,coalesce(COUNT(*),0) TotCnt from afetxnjnl where ActDat = '%s' and CAgtNo= '%s' and HTxnSt IN ('S','T','U') and HRspcd='SC0000' and  TTxnst IN ('S','U') and ChkFlg='0'
      </Sentence>
      <Fields>TxnDat|CAgtNo|</Fields>
    </DynSentence>
    <FlowCtrl>
    	 <!--Quote name="GetEfeId"/-->
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=EFE999</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>

     <Exec func="PUB:ReadRecord">     <!--广东电力电费业务清算-->
       <Arg name="SqlCmd" value="QryEfeTot"/>
     </Exec>
     <If condition="$TotCnt=0">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=EFE999</Set>
         <Set>RspMsg=没有清算数据</Set>
         <Return/>
     </If>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460465" desc="对账信息查询">
    <DynSentence name="QryChkRec">
      <Sentence>
        select SndTim,LogNo,ChkFil,TRspCd,RtnMsg from efechkrec where EfeId='%s' and ActDat &gt;='%s' and ActDat &lt;='%s'
      </Sentence>
      <Fields>EfeId|BgnDat|EndDat|</Fields>
    </DynSentence>
    <FlowCtrl>
    	 <!--Quote name="GetEfeId"/-->
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>

      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>

			<Exec func="PUB:MultiQuery" >
				<Arg name="SqlCmd" value="QryChkRec" />
			</Exec>
      <If condition="~RetCod=-1">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=查询失败</Set>
        <Return/>
      </If>
       <If condition="~RetCod=-2">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没有该查询流水号</Set>
        <Return/>
      </If>      
    </FlowCtrl>
  </Transaction>


  <Transaction code="460440" desc="银行查询客户缴费记录交易">
    <FlowCtrl>
      <Set>SvrCod=460440</Set>
      <Quote name="SendThirdOther"/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460441" desc="银行发起批量查询欠费客户请求">
    <DynSentence name="GetCusAgt" desc="根据单位代码获取签约客户信心">
      <Sentence>
        select DWBM, JFH from EfeCusAgt where DWDM='%s' and QYBZ in ( '0','1' ) and QYZT in ( '0','1' ) and ChkFlg='S'
      </Sentence>
      <Fields>DWDM|</Fields>
    </DynSentence>

    <FlowCtrl>
<!--获取文件序号-->
      <Set>OBrNo=$BrNo</Set>
      <Set>BrNo=999999</Set>
      <Exec func="PUB:nGetPubSeqNo">
        <Arg name="SeqNam" value="EFE:FILSEQ"/>
        <Arg name="SeqCnt" value="1"/>
        <Arg name="Len"    value="4"/>
        <Arg name="CycCnd" value="D"/>
      </Exec>
<!--生成银行查询客户信息文件-->
      <Set>FilNam=STRCAT(PL0301,$DWBM,$ActDat,$SelVal,.txt)</Set>
      <Set>LclDir=$EfeSndDir</Set>
      <Set>DatFil=STRCAT( $LclDir,$FilNam )</Set>
      <Exec func="PUB:ExportFromDB">
        <Args>
          <Arg name="FormatName" value="EfeCusAgt"/>
          <Arg name="FileName"   value="$DatFil"/>
          <Arg name="TableName"  value="EfeCusAgt"/>
          <Arg name="SqlName"    value="GetCusAgt"/>
        </Args>
      </Exec>
<!--将文件发到电力-->
      <System command="EfeFilSend.sh" error="IGNORE">
        <Arg name="FilNam" value="$FilNam"/>
      </System>
      <Set>SvrCod=460441</Set>
      <Quote name="SendThirdOther"/>
    </FlowCtrl>
  </Transaction>

  <!--50交易电网那边只接收单笔,不接收多笔报文,否则报ad,该交易只允许有一个子包-->
  <Transaction code="460450@Deprecated" desc="银行对总账服务【GROUP模式】">
    <Quote name="EfeSqlLst"/>
    <DynSentence name="GetBchRec" desc="批量业务对账">
      <Sentence>
        select PLDSXXBS DZPCLSH, DWBM, SFFS, FYLX, CGBS ZBS, CGJE ZJE, JSFJYRQ DAZRQ, JSFJYSJ DAZSJ
          from EfekBchRec
         where JSFJYRQ='%s' and RecSts='S' and OIFlag='I' for read only
      </Sentence>
      <Fields>ChkDat|</Fields>
    </DynSentence>

    <DynSentence name="GetTxnDtl" desc="单笔业务对账">
      <Sentence>
        select FQFJYLSH DZPCLSH, DWBM, SFFS, FYLX, JSFJYRQ DAZRQ, JSFJYSJ DAZSJ, count(SKJE) ZBS, value(sum(bigint(SKJE)),0) ZJE
          from EfekTxnDtl
         where JSFJYRQ='%s' and DtlSts='S' and BatFlg='S'
      group by FQFJYLSH, DWBM, SFFS, FYLX, JSFJYRQ, JSFJYSJ for read only
      </Sentence>
      <Fields>ChkDat|</Fields>
    </DynSentence>

    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>

    <FlowCtrl>
	  <Quote name="InitTranByNodNo"/>
	  <Exec func="PUB:IsExistNode" error="IGNORE">
        <Arg name="FieldName" value="ChkDat"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,0)" desc="非手工">
        <Set>ChkDat=CALCDATE($ActDat,-,d,1)</Set>
      </If>
<!--批量类业务对账-->
<!--批量类业务对账-->
<!--批量类业务对账-->
      <Exec func="PUB:QueryInGroup" error="IGNORE">
        <Arg name="SqlCmd" value="GetBchRec"/>
        <Arg name="RecordName" value="Rec1"/>
      </Exec>
      <Set>Cnt=1</Set>
      <Set>PKGCNT=$RecNum</Set>
      <While condition="INTCMP($Cnt,2,$RecNum)">
        <!--Delete>ROOT.JSFJYLSH</Delete-->
        <!--Quote name="InitTranByNodNo"/-->
        <!--Set>JSFJYLSH_Nam=STRCAT(ROOT.Rec1_,$Cnt,.JSFJYLSH)</Set>
        <Exec func="PUB:SetValue">
          <Arg name="FieldName" value="$JSFJYLSH_Nam"/>
          <Arg name="FieldValue" value="$ROOT.JSFJYLSH"/>
        </Exec-->
        <Set>FQFJYLSH_Nam=STRCAT(ROOT.Rec1,$Cnt,.FQFJYLSH)</Set>
        <Set>FQFJYRQ_Nam=STRCAT(ROOT.Rec1,$Cnt,.FQFJYRQ)</Set>
        <Set>FQFJYSJ_Nam=STRCAT(ROOT.Rec1,$Cnt,.FQFJYSJ)</Set>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="ROOT.FQFJYLSH"/>
          <Arg name="DestName" value="$FQFJYLSH_Nam"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="ROOT.FQFJYRQ"/>
          <Arg name="DestName" value="$FQFJYRQ_Nam"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="ROOT.FQFJYSJ"/>
          <Arg name="DestName" value="$FQFJYSJ_Nam"/>
        </Exec>

        <Set>Cnt=ADD($Cnt,1)</Set>
      </While>
<!--单笔类业务对账-->
<!--单笔类业务对账-->
<!--单笔类业务对账-->
      <Exec func="PUB:QueryInGroup" error="IGNORE">
        <Arg name="SqlCmd" value="GetTxnDtl"/>
        <Arg name="RecordName" value="Rec2"/>
      </Exec>
      <Set>Cnt=1</Set>
      <Set>PKGCNT=ADD($PKGCNT,$RecNum)</Set>
      <While condition="INTCMP($Cnt,2,$RecNum)">
        <!--Delete>ROOT.JSFJYLSH</Delete-->
        <!--Quote name="InitTranByNodNo"/-->
        <!--Set>YHJYLSH_Nam=STRCAT(ROOT.Rec2_,$Cnt,.YHJYLSH)</Set>
        <Exec func="PUB:SetValue">
          <Arg name="FieldName" value="$YHJYLSH_Nam"/>
          <Arg name="FieldValue" value="$ROOT.YHJYLSH"/>
        </Exec-->
        <Set>FQFJYLSH_Nam=STRCAT(ROOT.Rec2_,$Cnt,.FQFJYLSH)</Set>
        <Set>FQFJYRQ_Nam=STRCAT(ROOT.Rec2_,$Cnt,.FQFJYRQ)</Set>
        <Set>FQFJYSJ_Nam=STRCAT(ROOT.Rec2_,$Cnt,.FQFJYSJ)</Set>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="ROOT.FQFJYLSH"/>
          <Arg name="DestName" value="$FQFJYLSH_Nam"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="ROOT.FQFJYRQ"/>
          <Arg name="DestName" value="$FQFJYRQ_Nam"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="ROOT.FQFJYSJ"/>
          <Arg name="DestName" value="$FQFJYSJ_Nam"/>
        </Exec>

        <Set>Cnt=ADD($Cnt,1)</Set>
      </While>
      <Set>SvrCod=460450</Set>
      <Quote name="SendThirdOther"/>
      <If condition="IS_NOEQUAL_STRING($TRspCd,000000)" desc="对账异常">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <If condition="INTCMP(STRLEN(TRIM($CWTSXX,all)),3,0)">
          <Set>RspMsg=电网方返回未知错误</Set>
        </If>
        <Else>
          <Set>RspMsg=$CWTSXX</Set>
        </Else>
      </If>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="460450" desc="银行对总账服务【游标模式】">
    <Quote name="EfeSqlLst"/>
    <!--DynSentence name="GetBchRec" desc="批量业务对账">
      <Sentence>
        select PLDSXXBS DZPCLSH, DWBM, SFFS, FYLX, CGBS ZBS, CGJE ZJE, YHJYRQ DAZRQ, YHJYSJ DAZSJ
          from EfekBchRec
         where YHJYRQ='%s' and RecSts='S' and OIFlag='I' for read only
      </Sentence>
      <Fields>ChkDat|</Fields>
    </DynSentence>

    <DynSentence name="GetTxnDtl" desc="单笔业务对账">
      <Sentence>
        select JYLSH DZPCLSH, DWBM, SFFS, FYLX, YHJYRQ DAZRQ, YHJYSJ DAZSJ, count(SKJE) ZBS, value(sum(bigint(SKJE)),0) ZJE
          from EfekTxnDtl
         where YHJYRQ='%s' and DtlSts='S' and BatFlg='S'
      group by JYLSH, DWBM, SFFS, FYLX, YHJYRQ, YHJYSJ for read only
      </Sentence>
      <Fields>ChkDat|</Fields>
    </DynSentence-->
    <DynSentence name="GetBchRec" desc="批量业务对账">
      <Sentence>
        select PLDSXXBS DZPCLSH, DWBM, SFFS, FYLX, CGBS ZBS, CGJE ZJE, JSFJYRQ DAZRQ, JSFJYSJ DAZSJ
          from EfekBchRec
         where JSFJYRQ='%s' and RecSts='S' and OIFlag='I' for read only
      </Sentence>
      <Fields>ChkDat|</Fields>
    </DynSentence>

    <DynSentence name="GetTxnDtl" desc="单笔业务对账">
      <Sentence>
        select FQFJYLSH DZPCLSH, DWBM, SFFS, FYLX, JSFJYRQ DAZRQ, JSFJYSJ DAZSJ, count(SKJE) ZBS, value(sum(bigint(SKJE)),0) ZJE
          from EfekTxnDtl
         where JSFJYRQ='%s' and DtlSts='S' and BatFlg='S'
      group by FQFJYLSH, DWBM, SFFS, FYLX, JSFJYRQ, JSFJYSJ for read only
      </Sentence>
      <Fields>ChkDat|</Fields>
    </DynSentence>

    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>

    <FlowCtrl>
      <Quote name="InitTranByNodNo"/>
      <Exec func="PUB:IsExistNode" error="IGNORE">
        <Arg name="FieldName" value="ChkDat"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,0)" desc="非手工">
        <Set>ChkDat=CALCDATE($ActDat,-,d,1)</Set>
      </If>
<!--批量类业务对账-->
<!--批量类业务对账-->
<!--批量类业务对账-->
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetBchRec"/>
        <Arg name="CursorName" value="cur_bchrec"/>
      </Exec>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE">
          <Arg name="CursorName" value="cur_bchrec"/>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Break/>
        </If>
        <Set>SvrCod=460450</Set>
        <Quote name="SendThirdOther"/>
        <If condition="IS_NOEQUAL_STRING($TRspCd,000000)" desc="对账异常">
          <Set>RspMsg=STRCAT(批量业务【,$DZPCLSH,】发送对账数据异常)</Set>
          <Set>JYFHDM=00</Set>
        </If>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE">
        <Arg name="CursorName" value="cur_bchrec"/>
      </Exec>
<!--单笔类业务对账-->
<!--单笔类业务对账-->
<!--单笔类业务对账-->
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetTxnDtl"/>
        <Arg name="CursorName" value="cur_txndtl"/>
      </Exec>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE">
          <Arg name="CursorName" value="cur_txndtl"/>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Break/>
        </If>
        <Set>SvrCod=460450</Set>
        <Quote name="SendThirdOther"/>
        <If condition="IS_NOEQUAL_STRING($TRspCd,000000)" desc="对账异常">
          <Set>RspMsg=STRCAT(单笔业务【,$DZPCLSH,】发送对账数据异常)</Set>
          <Set>JYFHDM=00</Set>
        </If>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE">
        <Arg name="CursorName" value="cur_txndtl"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460450EFEK" desc="银行发起银行代扣代收电费对帐交易">
    <Quote name="EfeSqlLst"/>
    <DynSentence name="QryTolDS">    <!--银行发起单笔代收 -->
      <Sentence>
         select JYLSH DZPCLSH, DWBM, FYLX, SFFS, count(*) ZBS, sum(cast(YKJE as bigint)) ZJE  from EfekTxnDtl group by JYLSH, DWBM, FYLX, SFFS
      </Sentence> <Fields>DAZRQ|</Fields>
    </DynSentence>
    <DynSentence name="QryTolDK">    <!--供电发起单笔代扣 -->
      <Sentence>
         select JYLSH DZPCLSH, DWBM, SFFS, count(*) ZBS, sum(cast(YKJE as bigint)) ZJE  from EfekTxnDtl group by JYLSH, DWBM, SFFS
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryTolBat">    <!--供电发起批量 -->
      <Sentence>
         select JYLSH DZPCLSH, DWBM, SFFS, count(*) ZBS, sum(cast(YKJE as bigint)) ZJE  from EfekTxnDtl group by JYLSH, DWBM, SFFS
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <FlowCtrl>

      <!--Quote name="InitTran"/-->
<!--Set>MYSY= </Set>
<Set>MYCSXL= </Set>
<Set>MYCSXL= </Set-->
      <!--配置基本数据，银行发起单笔代收-->
      <Set>DAZRQ= </Set>
      <Set>DAZSJ= </Set>

      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="QryTolDS"/>
        <Arg name="CursorName" value="CURSOR_PRC"/>
      </Exec>
      <If condition="IS_NOEQUAL_STRING(~RetCod,0)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE9999</Set>
        <Set>RspMsg=无对账明细信息</Set>
        <Return/>
      </If>

      <!-- 循环处理每一笔明细 -->
      <While>
        <!--删除旧数据 -->
        <Delete>ROOT.DZPCLSH</Delete>
        <Delete>ROOT.DWBM</Delete>
        <Delete>ROOT.SFFS</Delete>
        <Delete>ROOT.ZBS</Delete>
        <Delete>ROOT.ZJE</Delete>
        <!--由于对方返回的PKGCNT字段为000000,
        会将我们这边的字段覆盖,因此需要重新赋值-->
        <Set>PKGCNT=000001</Set>

        <Exec func="PUB:FetchCursor" error="IGNORE">
          <Arg name="CursorName" value="CURSOR_PRC"/>
        </Exec>
        <If condition="~RetCod=100">
          <Break/>
        </If>

        <!--Exec func="PUB:CallThirdOther"-->  <!--通知供电方-->
          <!--Arg name="HTxnCd" value="460450"/>
          <Arg name="ObjSvr" value="STDKEFE1"/>
        </Exec-->

        <Set>SvrCod=460450</Set>
        <Quote name="SendThirdOther"/>
        
      </While>

      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功!</Set>      
      <Return/>

    </FlowCtrl>

  </Transaction>

  <Transaction code="460451" desc="银行对明细账交易">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryBasInf">
       <Sentence>
          select * from efeksffs, efekfylx, efekdwbm
       </Sentence>
       <Fields></Fields>
    </DynSentence>
    <FlowCtrl>
      <!--Quote name="GetEfeId"/-->

      <!--读取开工信息记录-->
      <Call package="EFE" function="CheckOpenByEfeId"/>

      <!--得到网点名称-->
      <Call package="EFE" function="GetWDMC"/>

      <!--得到外发交易流水号-->
      <!--Quote name="InitTran"/-->

      <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
        <Arg name="SqlCmd" value="QryBasInf"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </If>
      <ElseIf condition="~RetCod=-2">
        <Set>RspCod=000000</Set>
        <Set>RspMsg=无记录</Set>
        <Return/>
      </ElseIf>

      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
        <If condition="~RetCod=100">
           <Break/>
        </If>
        <ElseIf condition="~RetCod=-1">
           <Set>RspCod=478699</Set>
           <Set>RspMsg=取明细记录时数据库操作错误</Set>
           <Exec func="PUB:CloseCursor"/>
           <Return/>
        </ElseIf>

        <Set>LclDir=dat/efek</Set>
        <Set>LclFil=STRCAT(DZ05,$SFFS,$FYLX,_,301,$DWBM,GETDATETIME(YYYYMMDD)</Set>
        <Set>FmFile=EFE_DZMX</Set>
        <Call package="EFE" function="CrtDzFil"/>
        <!--发送第三方-->
        <Exec func="PUB:CallThirdOther">
          <Arg name="HTxnCd" value="460451"/>
          <Arg name="ObjSvr" value="STHDEFEK"/>
        </Exec>
        <If condition="$RspCod=000000">
          <Set>MsgTyp=N</Set>
        </If>
        <Else>
          <Set>MsgTyp=E</Set>
          <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc"  value="OPFCSW"/>
            <Arg name="SourNam" value="TRspCd"/>
            <Arg name="DestNam" value="RspMsg"/>
            <Arg name="TblNam"  value="EFE_TRspCd2RspMsg"/>
          </Exec>
          <Return/>
       </Else>

      </While>
      <Exec func="PUB:CloseCursor"/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460490" desc="银行对明细账交易">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryLog">
       <Sentence>
          SELECT * FROM efekerrlog
       </Sentence>
       <Fields></Fields>
    </DynSentence>
    <DynSentence name="DelLog">
       <Sentence>
          DELETE FROM efekerrlog WHERE JYLSH = '%s'
       </Sentence>
       <Fields>JYLSH</Fields>
    </DynSentence>
    <FlowCtrl>

      <Exec func="PUB:OpenCursor" error="IGNORE">  <!--打开游标-->
        <Arg name="SqlCmd" value="QryJnl"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=取日志时数据库操作错误</Set>
        <Return/>
      </If>
      <ElseIf condition="~RetCod=-2">
        <Set>RspCod=000000</Set>
        <Set>RspMsg=无错误日志</Set>
        <Return/>
      </ElseIf>

      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
        <If condition="~RetCod=100">
           <Break/>
        </If>
        <ElseIf condition="~RetCod=-1">
           <Set>RspCod=478699</Set>
           <Set>RspMsg=取明细记录时数据库操作错误</Set>
           <Exec func="PUB:CloseCursor"/>
           <Return/>
        </ElseIf>

        <!--发送第三方-->
        <Exec func="PUB:CallThirdOther" error="IGNORE">   <!--第三方查询-->
          <Arg name="HTxnCd" value="460490"/>
          <Arg name="ObjSvr" value="STHDEFEK"/>
        </Exec>
        <If condition="INTCMP(~RetCod,1,0)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=调用第三方时:系统错误或超时或未发送,请检查后重做 </Set>
          <Return/>
        </If>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="sql" value="DelLog" />
        </Exec>

      </While>
      <Exec func="PUB:CloseCursor"/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460443" desc="银行方发起查询客户信息请求">
    <DynSentence name="GetCusAgt" desc="根据单位代码、缴费号获取签约客户信息">
      <Sentence>
        select DWBM, JFH from EfeCusAgt where DWDM='%s' and JFH='%s'
      </Sentence>
      <Fields>DWDM|JFH</Fields>
    </DynSentence>

    <FlowCtrl>
      <Set>SvrCod=460443</Set>
      <Quote name="SendThirdOther"/>
      <If condition="INTCMP(~RetCod,3,0)" desc="交易成功">
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCusAgt"/>
        </Exec>
        <If condition="INTCMP(~RetCod,3,-2)" desc="客户记录不存在">
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="EfekCusAgt"/>
          </Exec>
        </If>
      </If>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460430" desc="银行方发起到供电方变更代扣协议请求">
    <DynSentence name="UpdCusAgt" desc="根据单位代码、缴费号获取签约客户信息">
      <Sentence>
        DWDM='%s' and JFH='%s'
      </Sentence>
      <Fields>DWDM|JFH</Fields>
    </DynSentence>

    <FlowCtrl>
      <Set>QYZT=2</Set>
      <Set>ChkFlg=U</Set>
      <Exec func="PUB:UpdateRecord" desc="更新协议内容到最新">
         <Arg name="TblNam" value="EfekCusAgt"/>
         <Arg name="CndSts" value="UpdCusAgt"/>
      </Exec>
      <Set>SvrCod=460430</Set>
      <Quote name="SendThirdOther"/>
      <If condition="INTCMP(~RetCod,3,0)" desc="交易成功">
        <Set>ChkFlg=S</Set>
        <Exec func="PUB:UpdateRecord" desc="更新协议核对状态为成功">
           <Arg name="TblNam" value="EfekCusAgt"/>
           <Arg name="CndSts" value="UpdCusAgt"/>
        </Exec>
      </If>
    </FlowCtrl>
  </Transaction>
</Application>
