<?xml version='1.0' encoding='ISO-8859-1'?>
<FrontTab>
  <Macro name="EfeSqlLst" desc="数据操作宏清单">
    <DynSentence name="GetRunCtl" desc="根据单位编码获取参数">
      <Sentence>
        select ZT, BrNo, InAcNo, ClrAct from EfekRunCtl where DWBM='%s'
      </Sentence>
      <Fields>DWBM|</Fields>
    </DynSentence>
  </Macro>
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
  <Macro name="Chk_TxnSrc">  <!--检查交易来源-->
    <If condition="INTCMP(STRLEN(DELBOTHSPACE($TxnSrc)),3,0)">
      <Set>TxnCnl=TRM</Set>
      <Set>CnlTyp=0</Set>
    </If>
    <Else>
      <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="TxnSrc"/>
        <Arg name="DestNam" value="CnlTyp"/>
        <Arg name="TblNam"  value="TxnSrc2CnlTyp"/>
      </Exec>
    </Else>
  </Macro>

  <Macro name="GetEfeId">
    <Set>EfeId=STRCAT(SUBSTR($NodNo,1,3),999)</Set>
  </Macro>

  <Macro name="TxnSrc_TxnCnl">
    <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
    <Exec func="PUB:CodeSwitching">
      <Arg name="DatSrc"  value="OPFCSW"/>
      <Arg name="SourNam" value="TxnSrc"/>
      <Arg name="DestNam" value="TxnCnl"/>
      <Arg name="TblNam"  value="TxnSrc2TxnCnl"/>
    </Exec>
  </Macro>

<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
  <Macro name="GetSysPar" desc="获取交易参数">
    <Exec func="PUB:ReadRecord" error="IGNORE">
      <Args>
        <Arg name="SqlCmd" value="GetRunCtl"/>
      </Args>
    </Exec>
    <If condition="INTCMP(~RetCod,4,0)">
      <Set>MsgTyp=E</Set>
      <Set>RspCod=EFE999</Set>
      <Set>RspMsg=STRCAT(获取单位编码【,$DWBM,】交易参数错)</Set>
      <Return/>
    </If>
  </Macro>


  <Macro name="InitTran" desc="交易初始化">
    <Quote name="GetSysPar"/>
    <Exec func="PUB:InitTransaction"/>
    <Set>YHJYRQ=GETDATETIME(YYYYMMDD)</Set>
    <Set>YHJYSJ=GETDATETIME(HHMISS)</Set>
    <Exec func="PUB:nGetPubSeqNo">
      <Arg name="SeqNam" value="EFE:YHJYLSH"/>
      <Arg name="SeqCnt" value="1"/>
      <Arg name="Len"    value="9"/>
      <Arg name="CycCnd" value="Y"/>
    </Exec>
    <Set>YHJYBSH=STRCAT($YHJYRQ,SUBSTR($BrNo,1,3),$SelVal)</Set>
    <Set>YHJYLSH=STRCAT($YHJYRQ,0301,SUBSTR($BrNo,1,3),$SelVal)</Set>
  </Macro>


  <Macro name="SendThirdOther" desc="发送第三方流程【查询类】">
    <Quote name="InitTran"/>
    <Set>WDMC=@BCFG.BrNam</Set>
    <Exec func="PUB:CallThirdOther" error="IGNORE">
      <Arg name="TxnCod" value="SUBSTR($SvrCod,1,6)"/>
      <Arg name="ObjSvr" value="STHDEFEK"/>
    </Exec>
    <Switch expression="~RetCod">
      <Case value="0" desc="成功">
        <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Break/>
      </Case>
      <Case value="3" desc="交易失败">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=$TRspCd</Set>
        <Break/>
      </Case>
      <Case value="-1" desc="超时">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=交易超时</Set>
        <Break/>
      </Case>
      <Case value="-2" desc="系统故障">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=系统故障</Set>
        <Break/>
      </Case>
      <Case value="-10" desc="交易发送失败">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=交易发送失败</Set>
        <Break/>
      </Case>
      <Default>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=交易失败，其他未知情况</Set>
        <Break/>
      </Default>
    </Switch>
  </Macro>
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
</FrontTab>
