<?xml version='1.0' encoding='ISO-8859-1'?>
<FrontTab>
  <Macro name="EfeSqlLst" desc="数据操作宏清单">
    <!--modify by qm 20141218, 由于对方有可能以供电局或者供电所来进行签到或签退
        操作,但是只要判断供电所或者上级供电局签到了即可进行交易
    -->
    <DynSentence name="GetRunCtl" desc="根据单位编码获取参数">
      <Sentence>
        select ZT, JYRQ, BrNo, InAcNo, ClrAct from EfekRunCtl where DWBM='%s' or DWBM=SUBSTR('%s',1,4) for read only
      </Sentence>
      <Fields>DWBM|</Fields>
    </DynSentence>

    <DynSentence name="GetCanDat" desc="根据业务唯一标志获取抹账信息">
      <Sentence>
        select LogNo, HLogNo OHLogNo, TckNo OTckNo, TTxnCd OTTxnCd, HTxnCd OHTxnCd, NodNo ONodNo from efektxndtl where LogNo='%s'
      </Sentence>
      <Fields>LogNo|</Fields>
    </DynSentence>

    <DynSentence name="UpdTxnDtl" desc="根据业务唯一标志更新流水信息">
      <Sentence>
        OIFLAG='%s' and JYLSH='%s' and XH='%s'
      </Sentence>
      <Fields>OIFLAG|JYLSH|XH|</Fields>
    </DynSentence>

    <DynSentence name="UpdTxnJnl" desc="根据业务唯一标志更新流水信息">
      <Sentence>
        LogNo='%s'
      </Sentence>
      <Fields>LogNo|</Fields>
    </DynSentence>

    <DynSentence name="UpdTxnJnlSts" desc="根据业务唯一标志更新流水信息">
      <Sentence>
        update EfekTxnJnl set HRspCd='%s', HTxnSt='%s', HLogNo='%s', TckNo='%s' where LogNo='%s'
      </Sentence>
      <Fields>HRspCd|HTxnSt|HLogNo|TckNo|LogNo|</Fields>
    </DynSentence>

    <DynSentence name="UpdTxnDtlSts" desc="根据业务唯一标志更新明细信息">
      <Sentence>
        update EfekTxnDtl set DtlSts='%s', TckNo='%s' where OIFLAG='%s' and JYLSH='%s' and XH='%s'
      </Sentence>
      <Fields>DtlSts|TckNo|OIFLAG|JYLSH|XH|</Fields>
    </DynSentence>


    <DynSentence name="GetCusAgt" desc="根据文件名获取文件处理记录">
      <Sentence>
        select ActFlg from EfekCusAgt where DWBM='%s' and JFH='%s' and QYYHZH='%s'
      </Sentence>
      <Fields>DWBM|JFH|KKZH|</Fields>
    </DynSentence>
    <DynSentence name="GetCusAgtByJFH" desc="根据文件名获取文件处理记录">
      <Sentence>
        select ActFlg from EfekCusAgt where DWBM='%s' and JFH='%s'
      </Sentence>
      <Fields>DWBM|JFH|</Fields>
    </DynSentence>
  </Macro>
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
<!--以下是应用操作的宏清单-->
  <Macro name="Chk_TxnSrc">  <!--检查交易来源-->
    <If condition="INTCMP(STRLEN(DELBOTHSPACE($TxnSrc)),3,0)">
      <Set>TxnCnl=TRM</Set>
      <Set>CnlTyp=0</Set>
    </If>
    <Else>
      <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="TxnSrc"/>
        <Arg name="DestNam" value="CnlTyp"/>
        <Arg name="TblNam"  value="TxnSrc2CnlTyp"/>
      </Exec>
    </Else>
  </Macro>

  <Macro name="GetEfeId">
    <Set>EfeId=STRCAT(SUBSTR($NodNo,1,3),999)</Set>
  </Macro>

  <Macro name="TxnSrc_TxnCnl">
    <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
    <Exec func="PUB:CodeSwitching">
      <Arg name="DatSrc"  value="OPFCSW"/>
      <Arg name="SourNam" value="TxnSrc"/>
      <Arg name="DestNam" value="TxnCnl"/>
      <Arg name="TblNam"  value="TxnSrc2TxnCnl"/>
    </Exec>
  </Macro>

<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
<!-- ADD BY ZXF BEGIN -->
  <Macro name="GetSysPar" desc="获取交易参数">
    <Exec func="PUB:ReadRecord" error="IGNORE">
      <Args>
        <Arg name="SqlCmd" value="GetRunCtl"/>
      </Args>
    </Exec>
    <If condition="INTCMP(~RetCod,4,0)">
      <Set>MsgTyp=E</Set>
      <Set>RspCod=EFE999</Set>
      <Set>RspMsg=STRCAT(获取单位编码【,$DWBM,】交易参数错)</Set>
      <Return/>
    </If>
  </Macro>


  <Macro name="InitTran" desc="交易初始化">
    <Quote name="GetSysPar"/>
    <Exec func="PUB:InitTransaction"/>
    <Set>YHJYRQ=GETDATETIME(YYYYMMDD)</Set>
    <Set>YHJYSJ=GETDATETIME(HHMISS)</Set>
    <Exec func="PUB:nGetPubSeqNo">
      <Arg name="SeqNam" value="EFE:YHJYLSH"/>
      <Arg name="SeqCnt" value="1"/>
      <Arg name="Len"    value="9"/>
      <Arg name="CycCnd" value="Y"/>
    </Exec>
    <!--供电使用JYBSH唯一定位一笔交易-->
    <If condition="IS_EQUAL_STRING($JYBSH,)" >
      <Set>YHJYBSH=STRCAT($YHJYRQ,SUBSTR($BrNo,1,3),$SelVal)</Set>
    </If>
    <Else>
      <Set>YHJYBSH=$JYBSH</Set>
    </Else>
    <Set>YHJYLSH=STRCAT($YHJYRQ,0301,SUBSTR($BrNo,1,3),$SelVal)</Set>
  </Macro>


  <Macro name="SendThirdOther" desc="发送第三方流程【查询类】">
    <Quote name="InitTran"/>
    <Set>WDMC=@BCFG.BrNam</Set>
    <Set>MYSY=0</Set>
    <Set>MYCSXL= </Set>
    <Set>JYJSF=030600</Set>
    <Set>JYYDZ= </Set>
    <Set>JYMBDZ= </Set>
    <Set>JYMBDZ= </Set>
    <Exec func="PUB:CallThirdOther" error="IGNORE">
      <Arg name="TxnCod" value="SUBSTR($SvrCod,1,6)"/>
      <Arg name="ObjSvr" value="STDKEFE1"/>
    </Exec>
    <Switch expression="~RetCod">
      <Case value="0" desc="成功">
        <Set>MsgTyp=N</Set>
        <Set>RspCod=000000</Set>
        <Break/>
      </Case>
      <Case value="3" desc="交易失败">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=$TRspCd</Set>
        <Break/>
      </Case>
      <Case value="-1" desc="超时">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=交易超时</Set>
        <Break/>
      </Case>
      <Case value="-2" desc="系统故障">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=系统故障</Set>
        <Break/>
      </Case>
      <Case value="-10" desc="交易发送失败">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=交易发送失败</Set>
        <Break/>
      </Case>
      <Default>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=交易失败，其他未知情况</Set>
        <Break/>
      </Default>
    </Switch>
  </Macro>

  <Macro name="SyncHost" desc="同步主机流水">
    <Exec func="PUB:CallHostOther" error="IGNORE">
      <Arg name="HTxnCd" value="458980"/>
      <Arg name="ObjSvr" value="SHSTPUB1"/>
    </Exec>
    <Set>LogNo=$OLogNo</Set>
    <Switch expression="$MsgTyp">
      <Case value="E">
        <Switch expression="$HRspCd">
          <Case value="AG8001" desc="该前置流水号不存在"/>
          <Case value="AG8981" desc="该前置流水号不存在"/>
          <Case value="SC6129" desc="原交易不存在">
            <Set>HTxnSt=F</Set>
            <Set>DtlSts=F</Set>
            <Exec func="PUB:ExecSql">
              <Arg name="sql" value="UpdTxnJnlSts"/>
            </Exec>
            <Exec func="PUB:ExecSql">
              <Arg name="sql" value="UpdTxnDtlSts"/>
            </Exec>
            <Exec func="PUB:CommitWork" error="IGNORE"/>
            <Break/>
          </Case>
          <Default>     <!--其他错误(非原交易不存在)-->
            <Set>MsgTyp=E</Set>
            <Set>RspCod=$HRspCd</Set>
            <Return/>
          </Default>
        </Switch>
        <Break/>
      </Case>
      <Case value="N">
        <If condition="$CrcSts=Y">  <!--交易状态为抹账,该情况出现可能也不大-->
          <Set>HTxnSt=C</Set>
          <Set>DtlSts=C</Set>
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdTxnJnlSts"/>
          </Exec>
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdTxnDtlSts"/>
          </Exec>
          <Break/>
        </If>
        <Else>
          <Set>HTxnSt=S</Set>
          <Set>DtlSts=S</Set>
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdTxnJnlSts"/>
          </Exec>
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdTxnDtlSts"/>
          </Exec>
          <Exec func="PUB:CommitWork" error="IGNORE"/>
        </Else>
        <Break/>
      </Case>
      <Default>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=STRCAT(查询主机流水【,$OLogNo,】失败)</Set>
        <Return/>
      </Default>
    </Switch>
  </Macro>
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
<!--以上是应用操作的宏清单-->
</FrontTab>
