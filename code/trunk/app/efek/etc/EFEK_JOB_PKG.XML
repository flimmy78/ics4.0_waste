<?xml version='1.0' encoding='ISO-8859-1'?>
<Package>
  <TableDeclare>
    <Table name="afetxnjnl"    value="afetxnjnl"/>  <!--业务流水表-->
  </TableDeclare>

  <Function name="CheckZtByDWBM" desc="使用DWBM查询供电局开工情况">
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT ZT FROM efekinfctl WHERE DWBM='%s'
      </Sentence>
      <Fields>DWBM|</Fields>
    </DynSentence>
    <Process>
      <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
    </Process>
  </Function>


  <Function name="UpdInfByDWBM" desc="修改开工信息表">
    <DynSentence name="UdpInfCtl">             <!--修改开工信息表 -->
      <Sentence>
       UPDATE efekinfctl Set JYLSH='%s',JYRQ='%s',JYSJ='%s',GDDW='%s',YWBSH='%s',CZRY='%s',ZT='%s',BZ='%s' WHERE DWBM='%s'
      </Sentence>
      <Fields>JYLSH|JYRQ|JYSJ|GDDW|YWBSH|CZRY|ZT|BZ|DWBM|</Fields>
    </DynSentence>
    <Process>
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd"   value="UdpInfCtl"/>
      </Exec>
      <If condition="~RetCod=-1">
      <Exec func="PUB:RollbackWork" error="IGNORE" />
      <Set>MsgTyp=E</Set>
      <Set>RspCod=EFE999</Set>
      <Set>RspMsg=数据库处理失败!</Set>
      <Return/>
      </If>
    </Process>
  </Function>


  <Function name="GetWDMC" desc="获取网点名称">
    <DynSentence name="QryPubInf">
      <Sentence>
        select nodnam WDMC from pubnodinf where nodno='%s'
      </Sentence>
      <Fields>NodNo|</Fields>
    </DynSentence>
    <Process>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryPubInf"/>
      </Exec>
    </Process>
  </Function>


  <Function name="ChkIsExistAgt" desc="查询是否存在代扣协议">
    <DynSentence name="QryCusCnt">             <!--查询协议存在 -->
      <Sentence>
        SELECT count(*) cnt1 from efekcusagt WHERE JFH='%s' AND Status='0'
      </Sentence>
      <Fields>JFH|</Fields>
    </DynSentence>
    <Process>
      <!--根据缴费号检查是否签约-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryCusCnt"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=缴费号查询失败</Set>
        <Return/>      <Call package="AFE" function="CheckOpenByEfeId"/><!--由于银行发起没有DWBM,因此需要使用额外的方式判断是否开工-->

      </If>
      <If condition="STRCMP($cnt1,0)=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=该缴费号没签约</Set>
        <Return/>
      </If>
    </Process>
  </Function>


  <Function name="QryCusAgt" desc="查询代扣协议明细">
    <DynSentence name="QryCusAgt">             <!--查询协议信息 -->
      <Sentence>
        SELECT * from efekcusagt WHERE JFH='%s' AND Status='0'
      </Sentence>
      <Fields>JFH|</Fields>
    </DynSentence>
    <Process>
      <!--根据缴费号检查是否签约-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryCusAgt"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=缴费号查询失败</Set>
        <Return/>
      </If>
    </Process>
  </Function>


  <Function name="Chk476520" desc="检查对私资料">
    <Process>
      <!--上主机查询客户资料-->
      <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="HTxnCd" value="476520"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="$MsgTyp!=N">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=帐户不存在</Set>
        <Return/>
      </If>
      <!--校验账户名称、开户证件类型和开户证件号码-->
      <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
      <Set>IDNo=DELBOTHSPACE($IDNo)</Set>
      <If condition="OR(IS_NOEQUAL_STRING($TActNm,$ActNam),IS_NOEQUAL_STRING($TIdNo,$IDNo))">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=账户名称或者证件号码不符</Set>
        <Return/>
      </If>
    </Process>
  </Function>


  <Function name="Chk109000" desc="检查对公资料">
    <Process>
      <!--上主机查询客户资料-->
      <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="HTxnCd" value="109000"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="$MsgTyp!=N">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=帐户不存在</Set>
        <Return/>
      </If>
      <!--校验账户名称、开户证件类型和开户证件号码-->
      <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
      <Set>ActQ04=DELBOTHSPACE($ActQ04)</Set>
      <If condition="IS_NOEQUAL_STRING($TActNm,$ActNam)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=账户名称不符</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($TIdNo,$ActQ04)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=证件号码不符</Set>
        <Return/>
      </If>
    </Process>
  </Function>




</Package>
