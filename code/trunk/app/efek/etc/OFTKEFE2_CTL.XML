<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="EFEA" code="202">
<!--电力发起业务主控-->
  <ConfigDeclare>
    <Config name="BatFormat" value="etc/EFEK_FMT.XML"/>
    <Config name="OPFCSW"    value="etc/EFE_CSW_441999.XML"/>
  </ConfigDeclare>
  <TableDeclare>
    <Table name="EfekRunCtl" value="EfeKRunCtl" desc="业务控制表"/>
    <Table name="EfekCusAgt" value="EfekCusAgt" desc="客户协议表"/>
    <Table name="EfekTxnJnl" value="EfekTxnJnl" desc="交易流水表"/>
    <Table name="EfekTxnDtl" value="EfekTxnDtl" desc="交易明细表"/>
    <Table name="EfekBchRec" value="EfekBchRec" desc="交易批量表"/>
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="AplCls" value="202"/>
    <Busdef name="EfekRcvDir" value="/dat/efek/recv/"/>
  </BusDefDeclare>
  <GlobalFunction>
    <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
    <Function name="_after">
      <Process>
        <If condition="ISNULL($MsgTyp)">
          <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
          </If>
          <Else>
            <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
              <Set>MsgTyp=E</Set>
            </If>
            <Else>
              <Set>MsgTyp=N</Set>
            </Else>
          </Else>
        </If>
      </Process>
    </Function>
  </GlobalFunction>
  <Define>
    <Include file="etc/EFEK_MCR.XML"/>
  </Define>


  <Transaction code="460420" error="PUB:DeleteDiskNoAndRollback" timeout="3600" desc="供电方发起批量代扣交易请求">
    <Quote name="EfeSqlLst"/>
    <DynSentence name="GetBchRec" desc="根据文件名获取文件处理记录">
      <Sentence>
        select RecSts from EfekBchRec where OIFlag='%s' and WJMC='%s'
      </Sentence>
      <Fields>OIFlag|WJMC|</Fields>
    </DynSentence>
    <DynSentence name="UpdBchRec" desc="根据文件名获取文件处理记录">
      <Sentence>
        update EfekBchRec set RecSts='%s',DskNo='%s' where OIFlag='%s' and WJMC='%s'
      </Sentence>
      <Fields>RecSts|DskNo|OIFlag|WJMC|</Fields>
    </DynSentence>

    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="GetBchRec"></Arg>
      </Exec>
      <Switch expression="~RetCod">
        <Case value="0" desc="存在记录">
          <If condition="IS_EQUAL_STRING($ZT,U)">
            <Exec func="PUB:ExecSql">
              <Arg name="sql" value="DelTxnDtl"/>
            </Exec>
            <Exec func="PUB:ExecSql">
              <Arg name="sql" value="DelTxnRec"/>
            </Exec>
          </If>
          <Else>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=STRCAT(文件【,$WJMC,】重复发送)</Set>
            <Return/>
          </Else>
          <Break/>
        </Case>
        <Case value="-2" desc="不存在记录">
          <Set>RecSts=u</Set>
          <Exec func="PUB:InsertRecord" error="IGNORE">
            <Args>
              <Arg name="tablename" value="EfekBchRec"/>
            </Args>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=STRCAT(文件【,$WJMC,】登记汇总表错)</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=STRCAT(获取文件【,$WJMC,】处理状态异常)</Set>
          <Return/>
        </Default>
      </Switch>
<!--
      <System command="EfeFilRecv.sh" error="IGNORE">
        <Arg name="FilNam" value="$FilNam"/>
      </System>
-->
      <Set>CrpCod=EFE9999999</Set>
      <Set>ObjSvr=OFTKEFE2</Set>
      <Set>TxnObj=OFTKEFE2</Set>
      <Set>SumFlg=N</Set>          <!--是否进行金额或数量汇总-->
      <Set>NamChk=1</Set>          <!--不需要检查户名-->
      <Set>TxnMod=1</Set>          <!--需要单笔上送-->
      <Set>CmtFlg=0</Set>          <!--大小通道发送状态-->
      <Set>TrdTbl=EfekTxnDtl</Set>
      <Set>UpdFlg=Y</Set>
      <Set>UpdFld=STRCAT(HTXNCD,|,TCKNO,|,BUSTYP)</Set>
      <Set>HTxnSt=U</Set>
      <Set>TTxnCd=$TxnCod</Set>
      <Set>HTxnCd=460499</Set>
      <Set>FTxnCd=460498</Set>
      <Set>IsTxn=Y</Set><!-- 交易不等于Y的明细,不会被触发-->
      <Set>OrnCnt=$ZBS</Set>
      <Delete>DskNo</Delete>
      <Exec func="PUB:RegisterBatchDiskNo"/><!--登记入pubbatinf-->
      <Set>DatFil=STRCAT(GETENV(WORKDIR),$EfekRcvDir,$WJMC)</Set>
      <Exec func="PUB:ImportToDB" error="IGNORE">
        <Args>
          <Arg name="FormatName" value="PTFS"/>
          <Arg name="FileName"   value="$DatFil"/>
          <Arg name="TableName"  value="EfekTxnDtl"/>
          <Arg name="ApplyLogNoFlag" value="1"/>
        </Args>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Exec func="PUB:DeleteDiskNo"/>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=STRCAT(文件【,$WJMC,】处理异常)</Set>
        <Exec func="PUB:RollbackWork" error="IGNORE"/>
        <Return/>
      </If>
      <Set>RecSts=b</Set>
      <Exec func="PUB:ExecSql">
        <Arg name="sql" value="UpdBchRec"/>
      </Exec>
      <Exec func="PUB:UpdateBatchStatus">
        <Arg name="ChkFlg" value="1"/>
      </Exec>
      <Exec func="PUB:DeleteDiskNo" error="IGNORE"/>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460499" desc="供电方发起批量代扣交易请求【大、小通道处理】">
    <Quote name="EfeSqlLst"/>
    <FlowCtrl>
<!--协议判断-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="GetCusAgt"></Arg>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>DtlSts=F</Set>
        <Set>HTxnSt=F</Set>
        <Set>HRspCd=EFE999</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=STRCAT(单位【,$DWBM,】缴费号【,$JFH,】账号【,$KKZH,】为与银行签订代扣协议)</Set>
        <Goto>UpdTag</Goto>
      </If>
      <Set>FTxnTm=GETDATETIME(YYYYMMDDHHMISS)</Set>
      <Set>TxnAmt=$YKJE</Set>
      <Set>TxnCnl=EFE</Set>
      <Set>CnlSub= </Set>
      <Exec func="PUB:GetVirtualTeller"/>
      <Switch expression="$ActFlg">
        <Case value="0" desc="对公">
          <Set>HTxnCd=451240</Set>
          <Set>BusTyp=PFT57</Set>
          <Set>CrpCod=EFE999999999</Set>
          <Set>ActNo=$KKZH</Set>
          <Set>ActNam=$KKZHMC</Set>
          <Set>NamChk=1</Set> <!--测试不检查，生产考虑打开-->
          <Set>VchFlg=0</Set> <!--渠道交易不检查-->
          <Set>VchTyp=000</Set>
          <Set>VchNo=00000000</Set>
          <Set>BilDat=$YHJYRQ</Set>
          <Set>CcyCod=CNY</Set>
          <Set>AccMod=1</Set>
          <Set>ActSqn=SUBSTR($InAcNo,14,5)</Set>
          <Set>ActSqn=SUBSTR($InAcNo,1,6)</Set>
          <Set>Smr=代扣电费</Set>
          <Break/>
        </Case>
        <Case value="2" desc="存折"/>
        <Case value="4" desc="卡">
          <Set>HTxnCd=471140</Set>
          <Set>BusTyp=PCL52</Set>
          <Set>CnlTyp=L</Set>
          <Set>Mask=9102</Set>
          <Set>ActNo=$KKZH</Set>
          <If condition="IS_EQUAL_STRING($ActFlg,4)" desc="卡">
            <Set>VchCod=00000000</Set>
          </If>
          <Set>PayMod=0</Set>
          <Set>TActNo=$InAcNo</Set>
          <Set>CcyTyp=1</Set>
          <Set>VchChk=0</Set>
          <Set>CAgtNo=EFE9999999</Set>
          <Set>GthFlg=N</Set>
          <Break/>
        </Case>
<!--
        <Case value="A" desc="中央">
          <Set>BrNam=@BCFG.BrNam</Set>
          <Set>EleBk=@BCFG.EleBk</Set>
          <Set>APVchN=$LogNo</Set>
          <Set>PayCod=$SubCod</Set>
          <Set>FinAre=999</Set>
          <Set>ActNo=$KKZH</Set>
          <Set>ActNam=$KKZHMC</Set>
          <Set>ANodNm=@BCFG.BrNam</Set>
          <Set>PyeAct=$InAcNo</Set>
          <Set>PyeNam=$InAcNm</Set>
          <Set>PyeBk=@BCFG.BrNam</Set>
          <Set>UdwDat=$ActDat</Set>
          <Set>ActSqn=SUBSTR($InAcNo,14,5)</Set>
          <Set>ActNod=SUBSTR($InAcNo,1,6)</Set>
          <Set>StlMod=07</Set>
          <Set>AthAmt=$TxnAmt</Set>
          <Set>VInTlr=$TlrId</Set>
          <Set>VRgNod=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
          <Set>HSubCd=001</Set>
          <Exec func="PUB:CallThirdOther" error="IGNORE">
            <Arg name="TxnCod" value="363412"/>
            <Arg name="ObjSvr" value="STHDFAP2"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="B" desc="地方">
          <Set>PayAct=$KKZH</Set>
          <Set>PayNam=$KKZHMC</Set>
          <Set>PayBNm=@BCFG.BrNam</Set>
          <Set>PyeAct=$InAcNo</Set>
          <Set>PyeNam=$InAcNm</Set>
          <Set>BankNo=$RcvBNo</Set>
          <Quote name="ChkBankCd"/>
          <Set>PyeBNm=@BCFG.BrNam</Set>
          <Set>VchDat=$ActDat</Set>
          <Set>TOIFlg=O</Set>
          <Set>VchSmr=$Smr</Set>
          <Set>ActSqn=SUBSTR($InAcNo,14,5)</Set>
          <Set>ActNod=SUBSTR($InAcNo,1,6)</Set>
          <Set>NodNo=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
          <Set>HSubCd=001</Set>
          <Exec func="PUB:CallThirdOther" error="IGNORE">
            <Arg name="TxnCod" value="461181"/>
            <Arg name="ObjSvr" value="STHDPFA3"/>
          </Exec>
          <Break/>
        </Case>
-->
      </Switch>
      <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="TxnCod" value="$HTxnCd"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <Switch expression="~RetCod">
        <Case value="0" desc="成功">
          <Set>HTxnSt=S</Set>
          <Set>DtlSts=S</Set>
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Break/>
        </Case>
        <Case value="3" desc="交易失败">
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=$TRspCd</Set>
          <Break/>
        </Case>
        <Case value="-9" desc="交易需要授权">
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=客户账户异常，请查询开户银行</Set>
          <Break/>
        </Case>
        <Case value="-1" desc="超时">
          <Set>HTxnSt=T</Set>
          <Set>DtlSts=T</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易超时</Set>
          <Break/>
        </Case>
        <Case value="-2" desc="系统故障">
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=系统故障</Set>
          <Break/>
        </Case>
        <Case value="-10" desc="交易发送失败">
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易发送失败</Set>
          <Break/>
        </Case>
        <Default>
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易失败，其他未知情况</Set>
          <Break/>
        </Default>
      </Switch>
      <Label>UpdTag</Label>
      <Exec func="PUB:UpdateRecord" desc="更新明细">
        <Arg name="TblNam" value="EfekTxnDtl"/>
        <Arg name="CndSts" value="UpdTxnDtl"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460498" desc="供电方发起批量代扣交易请求【大、小通道处理】">
    <DynSentence name="UpdBchRecByDskNo" desc="根据磁盘号更新处理状态">
      <Sentence>
        update EfekBchRec set RecSts='%s' where DskNo='%s'
      </Sentence>
      <Fields>RecSts|DskNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>RecSts=B</Set>
      <Set>DskNo=$LogNo</Set>
      <Exec func="PUB:ExecSql">
        <Arg name="sql" value="UpdBchRecByDskNo"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>

<!--TODO 定时机制发起银行方发起批量代扣记账交易请求-->

  <Transaction code="460422" desc="供电方发起单笔代扣交易请求">
    <Quote name="EfeSqlLst"/>

    <FlowCtrl>
      <Quote name="InitTran"/>
<!--协议判断-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="GetCusAgt"></Arg>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=STRCAT(单位【,$DWBM,】缴费号【,$JFH,】账号【,$KKZH,】为与银行签订代扣协议)</Set>
        <Return/>
      </If>
      <Set>TxnCnl=EFE</Set>
      <Set>CnlSub= </Set>
      <Set>NodNo=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
      <Exec func="PUB:GetVirtualTeller"/>
<!--登记流水-->
      <Set>TTxnCd=$TxnCod</Set>
      <Exec func="PUB:GetLogNo"/>
<!--
      <Exec func="PUB:InsertRecord">
        <Args>
          <Arg name="tablename" value="EfekTxnJnl"/>
        </Args>
      </Exec>
-->
      <Exec func="PUB:InsertRecord">
        <Args>
          <Arg name="tablename" value="EfekTxnDtl"/>
        </Args>
      </Exec>
      <Switch expression="$ActFlg">
        <Case value="0" desc="对公">
          <Set>HTxnCd=451240</Set>
          <Set>BusTyp=PFT57</Set>
          <Set>CrpCod=EFE999999999</Set>
          <Set>ActNo=$KKZH</Set>
          <Set>ActNam=$KKZHMC</Set>
          <Set>NamChk=1</Set> <!--测试不检查，生产考虑打开-->
          <Set>VchFlg=0</Set> <!--渠道交易不检查-->
          <Set>VchTyp=000</Set>
          <Set>VchNo=00000000</Set>
          <Set>BilDat=$YHJYRQ</Set>
          <Set>CcyCod=CNY</Set>
          <Set>TxnAmt=FABSAMT($KFJE,15)</Set>
          <Set>AccMod=1</Set>
          <Set>ActSqn=SUBSTR($InAcNo,14,5)</Set>
          <Set>ActSqn=SUBSTR($InAcNo,1,6)</Set>
          <Set>Smr=代扣电费</Set>
          <Break/>
        </Case>
        <Case value="2" desc="存折"/>
        <Case value="4" desc="卡">
          <Set>HTxnCd=471140</Set>
          <Set>BusTyp=PCL52</Set>
          <Set>CnlTyp=L</Set>
          <Set>Mask=9102</Set>
          <Set>ActNo=$KKZH</Set>
          <Set>VchTyp=000</Set>
          <If condition="IS_EQUAL_STRING($ActFlg,4)" desc="卡">
            <Set>VchCod=00000000</Set>
          </If>
          <Set>PayMod=0</Set>
          <Set>TActNo=$InAcNo</Set>
          <Set>CcyCod=CNY</Set>
          <Set>TxnAmt=FABSAMT($KFJE,15)</Set>
          <Set>CcyTyp=1</Set>
          <Set>VchChk=0</Set>
          <Set>ActSeq=SUBSTR($TActNo,14,5)</Set>
          <Set>CAgtNo=EFE9999999</Set>
          <Set>GthFlg=N</Set>
          <Break/>
        </Case>
<!--
        <Case value="A" desc="中央">
          <Set>BrNam=@BCFG.BrNam</Set>
          <Set>EleBk=@BCFG.EleBk</Set>
          <Set>APVchN=$LogNo</Set>
          <Set>PayCod=$SubCod</Set>
          <Set>FinAre=999</Set>
          <Set>ActNo=$KKZH</Set>
          <Set>ActNam=$KKZHMC</Set>
          <Set>ANodNm=@BCFG.BrNam</Set>
          <Set>PyeAct=$InAcNo</Set>
          <Set>PyeNam=$InAcNm</Set>
          <Set>PyeBk=@BCFG.BrNam</Set>
          <Set>UdwDat=$ActDat</Set>
          <Set>ActSqn=SUBSTR($InAcNo,14,5)</Set>
          <Set>ActNod=SUBSTR($InAcNo,1,6)</Set>
          <Set>StlMod=07</Set>
          <Set>AthAmt=$TxnAmt</Set>
          <Set>VInTlr=$TlrId</Set>
          <Set>VRgNod=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
          <Set>HSubCd=001</Set>
          <Exec func="PUB:CallThirdOther" error="IGNORE">
            <Arg name="TxnCod" value="363412"/>
            <Arg name="ObjSvr" value="STHDFAP2"/>
          </Exec>
          <Break/>
        </Case>
        <Case value="B" desc="地方">
          <Set>PayAct=$KKZH</Set>
          <Set>PayNam=$KKZHMC</Set>
          <Set>PayBNm=@BCFG.BrNam</Set>
          <Set>PyeAct=$InAcNo</Set>
          <Set>PyeNam=$InAcNm</Set>
          <Set>BankNo=$RcvBNo</Set>
          <Quote name="ChkBankCd"/>
          <Set>PyeBNm=@BCFG.BrNam</Set>
          <Set>VchDat=$ActDat</Set>
          <Set>TOIFlg=O</Set>
          <Set>VchSmr=$Smr</Set>
          <Set>ActSqn=SUBSTR($InAcNo,14,5)</Set>
          <Set>ActNod=SUBSTR($InAcNo,1,6)</Set>
          <Set>NodNo=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
          <Set>HSubCd=001</Set>
          <Exec func="PUB:CallThirdOther" error="IGNORE">
            <Arg name="TxnCod" value="461181"/>
            <Arg name="ObjSvr" value="STHDPFA3"/>
          </Exec>
          <Break/>
        </Case>
-->
      </Switch>

      <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="TxnCod" value="$HTxnCd"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
<!--TEST BEGIN BY QM ,20141206-->
          <Set>~RetCod=0</Set>
<!--TEST BEGIN BY QM ,20141206-->
      <Switch expression="~RetCod">
        <Case value="0" desc="成功">
          <Set>HTxnSt=S</Set>
          <Set>DtlSts=S</Set>
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Break/>
        </Case>
        <Case value="3" desc="交易失败">
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=$TRspCd</Set>
          <Break/>
        </Case>
        <Case value="-9" desc="交易需要授权">
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=客户账户异常，请查询开户银行</Set>
          <Break/>
        </Case>
        <Case value="-1" desc="超时">
          <Set>HTxnSt=T</Set>
          <Set>DtlSts=T</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易超时</Set>
          <Break/>
        </Case>
        <Case value="-2" desc="系统故障">
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=系统故障</Set>
          <Break/>
        </Case>
        <Case value="-10" desc="交易发送失败">
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易发送失败</Set>
          <Break/>
        </Case>
        <Default>
          <Set>HTxnSt=F</Set>
          <Set>DtlSts=F</Set>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易失败，其他未知情况</Set>
          <Break/>
        </Default>
      </Switch>
<!--
      <Exec func="PUB:UpdateRecord" desc="更新流水">
        <Arg name="TblNam" value="EfekTxnJnl"/>
        <Arg name="CndSts" value="UpdTxnJnl"/>
      </Exec>
-->
      <Exec func="PUB:UpdateRecord" desc="更新明细">
        <Arg name="TblNam" value="EfekTxnDtl"/>
        <Arg name="CndSts" value="UpdTxnDtl"/>
      </Exec>
    </FlowCtrl>
  </Transaction>




  <Transaction code="460423" desc="供电方发起单笔当日代扣抹账请求">
    <Quote name="EfeSqlLst"/>
    <DynSentence name="GetTxnDtl" desc="根据文件名获取文件处理记录">
      <Sentence>
        select DtlSts, LogNo OLogNo, TlrId, XH from EfekTxnDtl where OIFlag='I' and JYLSH='%s' and XH='%s' for read only
      </Sentence>
      <Fields>YJYLSH|XH|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Quote name="InitTran"/>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="GetTxnDtl"></Arg>
      </Exec>
      <Switch expression="~RetCod">
        <Case value="0" desc="存在记录">
          <Switch expression="$DtlSts">
            <Case value="U" desc="初始"/>
            <Case value="T" desc="超时">
              <Set>OJYLSH=$JYLSH</Set>
              <Set>JYLSH=$YJYLSH</Set>
              <Quote name="SyncHost"/>
              <Set>JYLSH=$OJYLSH</Set>
              <If condition="IS_EQUAL_STRING($DtlSts,F)" desc="失败">
                <Set>MsgTyp=N</Set>
                <Set>RspCod=000000</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Case value="F" desc="失败">
              <Set>MsgTyp=N</Set>
              <Set>RspCod=000000</Set>
              <Return/>
            </Case>
            <Case value="S" desc="成功">
              <Break/>
            </Case>
          </Switch>
          <Break/>
        </Case>
        <Case value="-1" desc="故障">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=000000</Set>
          <Set>RspMsg=系统处理异常，请稍后重新提交</Set>
          <Return/>
        </Case>
        <Case value="-2" desc="无记录">
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Return/>
        </Case>
      </Switch>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="GetCanDat"></Arg>
      </Exec>
      <Set>TIATyp=C</Set>
      <Set>HTxnCd=STRCAT(SUBSTR($OHTxnCd,1,5),9)</Set>
      <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="HTxnCd" value="959999"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <Switch expression="~RetCod">
        <Case value="0" desc="成功">
          <Set>HTxnSt=C</Set>
          <Set>DtlSts=C</Set>
<!--
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdTxnJnl"/>
          </Exec>
-->
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdTxnDtl"/>
          </Exec>
          <Exec func="PUB:CommitWork" error="IGNORE"/>
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Break/>
        </Case>
        <Case value="3" desc="交易失败"/>
        <Case value="-9" desc="交易需要授权"/>
        <Case value="-1" desc="超时"/>
        <Case value="-2" desc="系统故障"/>
        <Case value="-10" desc="交易发送失败">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易发送失败</Set>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易失败，其他未知情况</Set>
          <Break/>
        </Default>
      </Switch>
    </FlowCtrl>
  </Transaction>



  <Transaction code="460491" desc="供电方发起银电业务开工交易请求">
<!--
    <DynSentence name="UpdRunCtl" desc="根据单位代码更新开工信息">
      <Sentence>
        DWBM='%s'
      </Sentence>
      <Fields>DWBM</Fields>
    </DynSentence>
-->
    <DynSentence name="UpdRunCtl" desc="根据单位代码更新开工信息">
      <Sentence>
        update EfekRunCtl set JYLSH='%s', JYRQ='%s', JYSJ='%s', YWBSH='%s', CZRY='%s', ZT='%s', BZ='%s' where DWBM = '%s'
      </Sentence>
      <Fields>ROOT.JYLSH|ROOT.JYRQ|ROOT.JYSJ|ROOT.YWBSH|ROOT.CZRY|ROOT.ZT|ROOT.BZ|ROOT.DWBM|</Fields>
    </DynSentence>

    <DynSentence name="InsRunCtl" desc="添加开工记录">
      <Sentence>
        insert into EfekRunCtl values( '%s', '%s', '%s', '%s', '%s', '%s', 'Q' ,'%s','','','' )
      </Sentence>
      <Fields>ROOT.DWBM|ROOT.JYLSH|ROOT.JYRQ|ROOT.JYSJ|ROOT.YWBSH|ROOT.CZRY|ROOT.BZ|</Fields>
    </DynSentence>


    <FlowCtrl>
      <Set>Cnt=1</Set>
      <While condition="INTCMP($Cnt,2,$PKGCNT)">
        <Delete>ROOT.JYLSH</Delete>
        <Delete>ROOT.JYRQ</Delete>
        <Delete>ROOT.JYSJ</Delete>
        <Delete>ROOT.DWBM</Delete>
        <Delete>ROOT.YWBSH</Delete>
        <Delete>ROOT.CZRY</Delete>
        <Delete>ROOT.ZT</Delete>
        <Delete>ROOT.BZ</Delete>
        <Set>JYLSH_Nam=STRCAT(ROOT.Rec_,$Cnt,.JYLSH)</Set>
        <Set>JYRQ_Nam=STRCAT(ROOT.Rec_,$Cnt,.JYRQ)</Set>
        <Set>JYSJ_Nam=STRCAT(ROOT.Rec_,$Cnt,.JYSJ)</Set>
        <Set>DWBM_Nam=STRCAT(ROOT.Rec_,$Cnt,.DWBM)</Set>
        <Set>YWBSH_Nam=STRCAT(ROOT.Rec_,$Cnt,.YWBSH)</Set>
        <Set>CZRY_Nam=STRCAT(ROOT.Rec_,$Cnt,.CZRY)</Set>
        <Set>ZT_Nam=STRCAT(ROOT.Rec_,$Cnt,.ZT)</Set>
        <Set>BZ_Nam=STRCAT(ROOT.Rec_,$Cnt,.BZ)</Set>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JYLSH_Nam"/>
          <Arg name="DestName" value="ROOT.JYLSH"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JYRQ_Nam"/>
          <Arg name="DestName" value="ROOT.JYRQ"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JYSJ_Nam"/>
          <Arg name="DestName" value="ROOT.JYSJ"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$DWBM_Nam"/>
          <Arg name="DestName" value="ROOT.DWBM"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$YWBSH_Nam"/>
          <Arg name="DestName" value="ROOT.YWBSH"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$CZRY_Nam"/>
          <Arg name="DestName" value="ROOT.CZRY"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$ZT_Nam"/>
          <Arg name="DestName" value="ROOT.ZT"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$BZ_Nam"/>
          <Arg name="DestName" value="ROOT.BZ"/>
        </Exec>
<!--
        <Exec func="PUB:UpdateRecord" desc="更新开工">
           <Arg name="TblNam" value="EfekRunCtl"/>
           <Arg name="CndSts" value="UpdRunCtl"/>
        </Exec>
-->
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="UpdRunCtl"/>
          </Args>
        </Exec>
        <Switch expression="~RetCod">
          <Case value="0" desc="更新成功">
            <Break/>
          </Case>
          <Case value="-1" desc="更新失败">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE9999</Set>
            <Set>RspMsg=STRCAT(单位编码【,$ROOT.DWBM】更新开工状态失败)</Set>
            <Set>Cnt=ADD($Cnt,1)</Set>
            <Continue/>
<!--
            <Return/>
-->
          </Case>
          <Case value="-2" desc="没有记录">
<!--添加状态为"签退"记录，待业务维护分行号的资料后，在下一"开工"报文到达时开展交易-->
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="InsRunCtl"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)" desc="数据库更新失败">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=EFE9999</Set>
              <Set>RspMsg=STRCAT(单位编码【,$ROOT.DWBM】更新开工状态失败)</Set>
              <Set>Cnt=ADD($Cnt,1)</Set>
              <Continue/>
<!--
              <Return/>
-->
            </If>
            <Break/>
          </Case>
        </Switch>
        <Set>Cnt=ADD($Cnt,1)</Set>
<!--提交当前成功更新的记录，在异常的情况下，保证部分业务也可以开展交易-->
        <Exec func="PUB:CommitWork"/>
      </While>
      <Set>PKGCNT=000000</Set>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="460492" desc="供电方发起银电业务签退交易请求">
<!--
    <DynSentence name="UpdRunCtl" desc="根据单位代码更新签退信息">
      <Sentence>
        DWBM='%s'
      </Sentence>
      <Fields>DWBM</Fields>
    </DynSentence>
-->
    <DynSentence name="UpdRunCtl" desc="根据单位代码更新签退信息">
      <Sentence>
        update EfekRunCtl set JYLSH='%s', JYRQ='%s', JYSJ='%s', YWBSH='%s', CZRY='%s', ZT='%s', BZ='%s' where DWBM='%s'
      </Sentence>
      <Fields>ROOT.JYLSH|ROOT.JYRQ|ROOT.JYSJ|ROOT.YWBSH|ROOT.CZRY|ROOT.ZT|ROOT.BZ|ROOT.DWBM|</Fields>
    </DynSentence>

    <DynSentence name="InsRunCtl" desc="添加签退记录">
      <Sentence>
        insert into EfekRunCtl values( '%s', '%s', '%s', '%s', '%s', '%s', '%s' ,'%s','','','' )
      </Sentence>
      <Fields>ROOT.DWBM|ROOT.JYLSH|ROOT.JYRQ|ROOT.JYSJ|ROOT.YWBSH|ROOT.CZRY|ROOT.ZT|ROOT.BZ|</Fields>
    </DynSentence>


    <FlowCtrl>
      <Set>Cnt=1</Set>
      <While condition="INTCMP($Cnt,2,$PKGCNT)">
        <Delete>ROOT.JYLSH</Delete>
        <Delete>ROOT.JYRQ</Delete>
        <Delete>ROOT.JYSJ</Delete>
        <Delete>ROOT.DWBM</Delete>
        <Delete>ROOT.YWBSH</Delete>
        <Delete>ROOT.CZRY</Delete>
        <Delete>ROOT.ZT</Delete>
        <Delete>ROOT.BZ</Delete>
        <Set>JYLSH_Nam=STRCAT(ROOT.Rec_,$Cnt,.JYLSH)</Set>
        <Set>JYRQ_Nam=STRCAT(ROOT.Rec_,$Cnt,.JYRQ)</Set>
        <Set>JYSJ_Nam=STRCAT(ROOT.Rec_,$Cnt,.JYSJ)</Set>
        <Set>DWBM_Nam=STRCAT(ROOT.Rec_,$Cnt,.DWBM)</Set>
        <Set>YWBSH_Nam=STRCAT(ROOT.Rec_,$Cnt,.YWBSH)</Set>
        <Set>CZRY_Nam=STRCAT(ROOT.Rec_,$Cnt,.CZRY)</Set>
        <Set>ZT_Nam=STRCAT(ROOT.Rec_,$Cnt,.ZT)</Set>
        <Set>BZ_Nam=STRCAT(ROOT.Rec_,$Cnt,.BZ)</Set>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JYLSH_Nam"/>
          <Arg name="DestName" value="ROOT.JYLSH"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JYRQ_Nam"/>
          <Arg name="DestName" value="ROOT.JYRQ"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JYSJ_Nam"/>
          <Arg name="DestName" value="ROOT.JYSJ"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$DWBM_Nam"/>
          <Arg name="DestName" value="ROOT.DWBM"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$YWBSH_Nam"/>
          <Arg name="DestName" value="ROOT.YWBSH"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$CZRY_Nam"/>
          <Arg name="DestName" value="ROOT.CZRY"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$ZT_Nam"/>
          <Arg name="DestName" value="ROOT.ZT"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$BZ_Nam"/>
          <Arg name="DestName" value="ROOT.BZ"/>
        </Exec>
<!--
        <Exec func="PUB:UpdateRecord" desc="更新签退">
           <Arg name="TblNam" value="EfekRunCtl"/>
           <Arg name="CndSts" value="UpdRunCtl"/>
        </Exec>
-->
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="UpdRunCtl"/>
          </Args>
        </Exec>
        <Switch expression="~RetCod">
          <Case value="0" desc="更新成功">
            <Break/>
          </Case>
          <Case value="-1" desc="更新失败">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE9999</Set>
            <Set>RspMsg=STRCAT(单位编码【,$ROOT.DWBM】更新签退状态失败)</Set>
			<Set>Cnt=ADD($Cnt,1)</Set>
            <Continue/>
<!--
            <Return/>
-->
          </Case>
          <Case value="-2" desc="没有记录">
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="InsRunCtl"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)" desc="数据库更新失败">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=EFE9999</Set>
              <Set>RspMsg=STRCAT(单位编码【,$ROOT.DWBM】更新签退状态失败)</Set>
			  <Set>Cnt=ADD($Cnt,1)</Set>
              <Continue/>
<!--
              <Return/>
-->
            </If>
            <Break/>
          </Case>
        </Switch>
        <Set>Cnt=ADD($Cnt,1)</Set>
<!--提交当前成功更新的记录，在异常的情况下，保证部分业务也可以关闭交易-->
        <Exec func="PUB:CommitWork"/>
      </While>
      <Set>PKGCNT=000000</Set>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>



  <Transaction code="460432" desc="供电方发起供电到银行变更代扣协议请求">
    <DynSentence name="UpdCusAgt" desc="根据单位代码更新开工信息">
      <Sentence>
        DWBM='%s' and JFH='%s'
      </Sentence>
      <Fields>DWBM|JFH|</Fields>
    </DynSentence>
    <DynSentence name="GetCusAgt" desc="根据单位代码更新开工信息">
      <Sentence>
        select coalesce(COUNT(*),0) CusCnt from EfekCusAgt where DWBM='%s' and JFH='%s'
      </Sentence>
      <Fields>DWBM|JFH|</Fields>
    </DynSentence>
    <!--DynSentence name="GetCusAgt" desc="根据单位代码更新开工信息">
      <Sentence>
        select * from EfekCusAgt where DWBM='%s' and JFH='%s'
      </Sentence>
      <Fields>DWBM|JFH|</Fields>
    </DynSentence-->

    <FlowCtrl>

      <!--上主机查询客户资料-->
      <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="HTxnCd" value="476520"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="$MsgTyp!=N">
        <Set>RspCod=ZH009</Set>
        <Set>RspMsg=帐户不存在</Set>
        <Return/>
      </If>
      <!--校验账户名称、开户证件类型和开户证件号码-->
      <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
      <Set>IDNo=DELBOTHSPACE($IDNo)</Set>
      <If condition="IS_NOEQUAL_STRING(TRIM($XQYZHMC,both),$ActNam)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=账户名称不符</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING(TRIM($ZJHM,both),$IDNo)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=证件号码不符</Set>
        <Return/>
      </If>


      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="GetCusAgt"></Arg>
      </Exec>
      <Switch expression="~RetCod">
        <Case value="0" desc="存在记录">
          <If condition="INTCMP($CusCnt,6,0)">
            <Set>QYBZ=1</Set>
            <Exec func="PUB:UpdateRecord" desc="更新记录">
              <Arg name="TblNam" value="EfekCusAgt"/>
              <Arg name="CndSts" value="UpdCusAgt"/>
            </Exec>
            <Break/>
          </If>
          <Else>
            <Set>QYBZ=0</Set>
            <Exec func="PUB:InsertRecord" error="IGNORE">
              <Args>
                <Arg name="tablename" value="EfekCusAgt"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=EFE999</Set>
              <Set>RspMsg=STRCAT(登记【,$JFH,】错误)</Set>
              <Return/>
            </If>
          </Else>
          <Break/>
        </Case>
        <Case value="-2" desc="不存在记录">
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=STRCAT(登记【,$JFH,】错误)</Set>
          <Return/>
        </Default>
      </Switch>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>

<!-- ADD OR MOD BY ZXF END -->
<!-- ADD OR MOD BY ZXF END -->
<!-- ADD OR MOD BY ZXF END -->
<!-- ADD OR MOD BY ZXF END -->
<!-- ADD OR MOD BY ZXF END -->
<!-- ADD OR MOD BY ZXF END -->

</Application>
