<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="EFEA" code="202">
<!--银行发起业务-->
  <ConfigDeclare>
    <Config name="BatFormat" value="etc/EFEK_FMT.XML"/>
    <Config name="OPFCSW"    value="etc/EFE_CSW_441999.XML"/>
  </ConfigDeclare>
  <PackageDeclare>
    <Package name="EFE"        value="etc/EFEK_JOB_PKG.XML"/>
  </PackageDeclare>
  <TableDeclare>
    <Table name="EfekCusAgt" value="EfekCusAgt" desc="客户协议表"/>
    <Table name="EfekRunCtl" value="EfekRunCtl" desc="业务状态控制表"/>
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="AplCls" value="202"/>
  </BusDefDeclare>
  <GlobalFunction>
    <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
    <Function name="_after">
        <Process>
           <If condition="ISNULL($MsgTyp)">
              <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                 <Set>MsgTyp=N</Set>
                 <Set>RspCod=000000</Set>
              </If>
              <Else>
                 <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                    <Set>MsgTyp=E</Set>
                 </If>
                 <Else>
                    <Set>MsgTyp=N</Set>
                 </Else>
              </Else>
           </If>
        </Process>
    </Function>
    <!--end by xuan_20101108-->
  </GlobalFunction>
  <Define>
    <Include file="etc/EFEK_MCR.XML"/>
  </Define>


  <Transaction code="460410" desc="银行柜台电费代收查询交易">
    <Quote name="EfeSqlLst"/>
    <FlowCtrl>
      <Set>SvrCod=460410</Set>
      <Quote name="SendThirdOther"/>
    </FlowCtrl>
  </Transaction>



  <Transaction code="460411" desc="银行发起客户记账交易请求">
    <Quote name="EfeSqlLst"/>
    <Attribute name="integrity" value="2" code="EFECAN" desc="交易失败自动冲正"/>
    <FlowCtrl>
      <!--外发的时候会自动调用-->
      <!--Quote name="InitTran"/-->
<!--
460410查询接口数据
费用类型	FYLX
单位编码	DWBM
缴费号	  JFH
扣款银行代码	KKYHDM
扣款账户	KKZH
扣款账户名称	KKZHMC
部分缴费标志	BFJFBZ
账务流水号	ZWLSH
电费年月	  DFNY
欠费金额	  QFJE
本金	      BJ
违约金	    WYJ
460411柜面录入数据
收费方式	SFFS
付款方式  FKFS
-->
      <Set>FKFS=2</Set><!--1 现金;2 非现金-->
      <Set>HBFH=RMB</Set>
      <Set>SKJE=$QFJE</Set>
      <!--Set>KKRQ=GETDATETIME(YYYYMMDD)</Set>
      <Set>KKSJ=GETDATETIME(HHMISS)</Set-->
<!--登记流水、明细表-->
<!--主机账务处理
451240 PCL51
471140 PCL52-->

      <Set>SvrCod=460411</Set>
      <Quote name="SendThirdOther"/>

    </FlowCtrl>
  </Transaction>



  <Transaction code="460412" desc="银行方发起单笔当日代收抹账业务请求">
    <Quote name="EfeSqlLst"/>
    <DynSentence name="GetTxnJnl" desc="获取原交易流水">
      <Sentence>
        select  YHLSH YJYLSH, YHJYRQ YJYRQ, YHJYSJ YJYSJ, SFFS, FYLX, DWBM, JFH, KKYHDM, KKZH, KKZHMC, BFJFBZ, ZWLSH, DFNY, HBFH, YKJE YSKJE, YKJE CXJE from efektxndtl where TckNo='%s'
      </Sentence>
      <Fields>TckNo|</Fields>
    </DynSentence>
    <FlowCtrl>
<!--
460411交易数据
原交易流水号	YJYLSH
原交易日期	YJYRQ
原交易时间	YJYSJ
收费方式	SFFS
费用类型	FYLX
单位编码	DWBM
缴费号	JFH
扣款银行代码	KKYHDM
扣款账户	KKZH
扣款账户名称	KKZHMC
部分缴费标志	BFJFBZ
账务流水号	ZWLSH
电费年月	DFNY
货币符号	HBFH
原实扣金额	YSKJE
460412柜面录入数据
冲销金额  CXJE == 原实扣金额
冲销原因	CXYY
-->
      <If condition="IS_NOEQUAL_STRING($ActDat,$OActdat)">
        <Set>MsgTyp=$</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=非当日业务，不能冲销</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING($TIATYP,A)" desc="当前非授权交易，先发第三方处理">
<!--查询原交易流水-->
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetTxnJnl"></Arg>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=STRCAT(会计流水号【,$TckNo,】交易不存在</Set>
          <Return/>
        </If>

        <Quote name="InitTran"/>
        <Set>WDMC=@BCFG.BrNam</Set>
        <Set>MYSY=0</Set>
        <Set>MYCSXL= </Set>
        <Set>JYJSF=030600</Set>
        <Set>JYYDZ= </Set>
        <Set>JYMBDZ= </Set>
        <Set>JYMBDZ= </Set>
        <Set>SvrCod=460412</Set>
        <Exec func="PUB:CallThirdOther" error="IGNORE">
          <Arg name="TxnCod" value="$SvrCod"/>
          <Arg name="ObjSvr" value="STDKEFE1"/>
        </Exec>
        <Switch expression="~RetCod">
          <Case value="0" desc="成功">
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
            <Set>RspMsg=交易成功</Set>
<!--变更明细状态，第三方冲销成功，主机待冲销-->
            <Set>TTxnSt=C</Set>
            <Break/>
          </Case>
          <Case value="3" desc="交易失败">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=$TRspCd</Set>
            <Set>RspMsg=$CWTSXX</Set>
            <Return/>
          </Case>
          <Case value="-1" desc="超时">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=交易超时</Set>
<!--变更明细状态-->
<!--如果有同步交易，执行同步操作-->
            <Return/>
          </Case>
          <Case value="-2" desc="系统故障">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=系统故障</Set>
            <Return/>
          </Case>
          <Case value="-10" desc="交易发送失败">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=交易发送失败</Set>
            <Return/>
          </Case>
          <Default>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=交易失败，其他未知情况</Set>
            <Return/>
          </Default>
        </Switch>
        <Exec func="PUB:CommitWork"/>
      </If>
<!--第三方，交易成功-->
      <Set>TIATyp=C</Set>
      <Set>HTxnCd=STRCAT(SUBSTR($OHTxnCd,1,5),9)</Set>
      <Exec func="PUB:CallHostAcc" error="IGNORE">
        <Arg name="HTxnCd" value="959999"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <Switch expression="~RetCod">
        <Case value="0" desc="成功">
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Set>RspMsg=交易成功</Set>
<!--变更明细状态，主机冲销成功-->
          <Set>HTxnSt=C</Set>
          <Break/>
        </Case>
        <Case value="-10" desc="交易发送失败">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易发送失败</Set>
          <Return/>
        </Case>
        <Case value="-2" desc="系统故障">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=系统故障</Set>
          <Return/>
        </Case>
        <Case value="-1" desc="超时">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易超时</Set>
<!--如果有同步交易，执行同步操作-->
          <Return/>
        </Case>
        <Case value="3" desc="交易失败">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=$TRspCd</Set>
          <Set>RspMsg=$CWTSXX</Set>
          <Return/>
        </Case>
        <Case value="-9" desc="交易需要授权">
          <Set>MsgTyp=A</Set>
          <Set>RspCod=$HRspCd</Set>
          <Return/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易失败，其他未知情况</Set>
          <Return/>
        </Default>
      </Switch>
    </FlowCtrl>
  </Transaction>



  <Transaction code="460413" desc="银行方发起存入预付款交易请求">
    <Attribute name="integrity" value="2" code="EFECAN" desc="交易失败自动冲正"/>
    <FlowCtrl>
      <Quote name="InitTran"/>
<!--
460413柜面录入数据
收费方式	SFFS
费用类型	FYLX
单位编码	DWBM
缴费号	JFH
存入日期	CRRQ
存入时间	CRSJ
存入预付款	CRYFK
付款方式	FKFS
操作员号	CZYH
备注说明	BZSM
-->
      <Set>CRRQ=$JYRQ</Set>
      <Set>CRSJ=$JYSJ</Set>
<!--登记流水、明细表-->
<!--主机账务处理-->
      <Exec func="PUB:CallThirdOther" error="IGNORE">
        <Arg name="TxnCod" value="$SvrCod"/>
        <Arg name="ObjSvr" value="STHDEFEK"/>
      </Exec>
      <Switch expression="~RetCod">
        <Case value="0" desc="成功">
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
<!--变更明细状态-->
          <Set>RspMsg=交易成功</Set>
          <Break/>
        </Case>
        <Case value="3" desc="交易失败">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=$TRspCd</Set>
          <Set>RspMsg=$CWTSXX</Set>
<!--变更明细状态-->
<!--
          <Exec func="PUB:DefaultErrorProc"/>
-->
          <Break/>
        </Case>
        <Case value="-1" desc="超时">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易超时</Set>
<!--变更明细状态-->
<!--如果有同步交易，执行同步操作-->
          <Break/>
        </Case>
        <Case value="-2" desc="系统故障">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=系统故障</Set>
<!--变更明细状态-->
<!--
          <Exec func="PUB:DefaultErrorProc"/>
-->
          <Break/>
        </Case>
        <Case value="-10" desc="交易发送失败">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易发送失败</Set>
<!--变更明细状态-->
<!--
          <Exec func="PUB:DefaultErrorProc"/>
-->
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=交易失败，其他未知情况</Set>
<!--变更明细状态-->
          <Break/>
        </Default>
      </Switch>
    </FlowCtrl>
  </Transaction>




  <Transaction code="460421" desc="银行方发起批量代扣记账交易请求【电力批扣的回应】">
    <DynSentence name="GetBchRec" desc="获取扣款处理完成的交易">
      <Sentence>
        select JYLSH YJYLSH, JYRQ YJYRQ, JYSJ YJYSJ, DWBM, SFFS, FYLX, '02' WJLX, ZBS, ZJE, CGBS, CGJE, SBBS, SBJE, KHBZ, DSKNO
          from EfekBchRec where RecSts='B'
      </Sentence>
    </DynSentence>

    <DynSentence name="GetTxnJnl" desc="获取扣款处理完成的交易">
      <Sentence>
        select * from EfekTxnJnl where DSKNO=''
      </Sentence>
    </DynSentence>

    <FlowCtrl>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GETYHYSHZ"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=MDF999</Set>
        <Set>RspMsg=打开游标出错</Set>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <Quote name="InitTran"/>
        <Exec func="PUB:nGetPubSeqNo">
          <Arg name="SeqNam" value="EFE:FILSEQ"/>
          <Arg name="SeqCnt" value="1"/>
          <Arg name="Len"    value="4"/>
          <Arg name="CycCnd" value="D"/>
        </Exec>
        <Set>WJMC=STRCAT(PTFH_,$KHBZ,0301,$DWBM,GETDATETIME(YYYYMMDD),$SelVal,.txt)</Set>
        <Set>DatFil=STRCAT( $EfeSndDir,$FilNam )</Set>
        <Exec func="PUB:ExportFromDB">
          <Args>
            <Arg name="FormatName" value="EfekTxnJnl"/>
            <Arg name="FileName"   value="$DatFil"/>
            <Arg name="TableName"  value="EfekTxnJnl"/>
            <Arg name="SqlName"    value="GetTxnJnl"/>
          </Args>
        </Exec>
<!--将文件发到电力-->
      <System command="EfeFilSend.sh" error="IGNORE">
        <Arg name="FilNam" value="$FilNam"/>
      </System>
      <Set>SvrCod=460421</Set>
      <Quote name="SendThirdOther"/>
      </While>
    </FlowCtrl>
  </Transaction>





  <Transaction code="460431" desc="银行方发起银行到供电核对代扣协议请求">
    <Quote name="EfeSqlLst"/>
    <DynSentence name="GetCusAgtDWBM" desc="单位代码">
      <Sentence>
        select distinct DWBM from EfekCusAgt where JYRQ='%s'
      </Sentence>
      <Fields>QryDat|</Fields>
    </DynSentence>
     <DynSentence name="CntCusAgt" desc="统计数量">
      <Sentence>
        select count(*) MXBS from EfekCusAgt where JYRQ='%s' and DWBM='%s'
      </Sentence>
      <Fields>QryDat|DWBM|</Fields>
    </DynSentence>
    <DynSentence name="GetCusDtl" desc="明细记录">
      <Sentence>
        select * from EfekCusAgt where JYRQ='%s' and DWBM='%s'
      </Sentence>
      <Fields>QryDat|DWBM|</Fields>
    </DynSentence>
    <!--程序里面没有使用到-->
    <!--DynSentence name="UpdCusAgt" desc="更新明细记录发送状态">
      <Sentence>
        update EfeCusAgt set SndFlg='1' where ActDat='%s' and DWBM='%s' and SndFlg='0'
      </Sentence>
      <Fields>QryDat|DWBM|</Fields>
    </DynSentence-->

    <Attributes>
      <Attribute name="nodatabase" value="2" desc="数据库长连接"/>
    </Attributes>

    <FlowCtrl>
      <Quote name="InitTran"/>
      <!--赋值表头的银行代码-->
      <Set>YHDM=301</Set>
      <Set>RemoteIp=182.53.201.46</Set>
      <Set>UserName=bcm</Set>
      <Set>RemoteDir=exchange</Set>
      <Set>LocalDir=/app/ics/dat/efek/send/</Set>
      <Set>EfeSndDir=dat/efek/send/</Set>

      <Set>RecKey=STRCAT($AplCls,$BrNo,$TxnCod)</Set>
      <Exec func="PUB:Lock">
        <Arg name="RecKey" value="$RecKey"/>
        <Arg name="AutoUnlock" value="yes"/>
      </Exec>
      <Exec func="PUB:IsExistNode" error="IGNORE">
        <Arg name="FieldName" value="QryDat"/>
      </Exec>
      <If condition="INTCMP(~RetCod,3,0)" desc="非手工">
        <Set>QryDat=CALCDATE($ActDat,-,d,1)</Set>
      </If>
      <Exec func="PUB:OpenCursor" error="IGNORE">
        <Arg name="sql" value="GetCusAgtDWBM"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
        <Exec func="PUB:CloseCursor" error="IGNORE"/>
        <Exec func="PUB:Unlock">
          <Arg name="RecKey" value="$RecKey"/>
        </Exec>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=打开游标出错</Set>
        <Return/>
      </If>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Args>
            <Arg name="SqlCmd" value="CntCusAgt"/>
          </Args>
        </Exec>
        <If condition="INTCMP(~RetCod,4,0)">
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="$RecKey"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=统计明细记录总数出错</Set>
          <Return/>
        </If>
        <Set>ZKHS=$MXBS</Set>
        <Set>FilNam=STRCAT(HDXY0301,$DWBM,$QRYDAT,001.txt)</Set>
        <Set>WJMC=$FilNam</Set>
        <Set>WJLX=04</Set>
        <!--Set>WJMD5=</Set-->
        <!--Set>LclDir=$EfeSndDir</Set-->
        <Set>LclDir=$EfeSndDir</Set>
        <Set>DatFil=STRCAT( $LclDir,$FilNam )</Set>
        <Exec func="PUB:ExportFromDB">
          <Args>
            <Arg name="FormatName" value="HDXY"/>
            <Arg name="FileName"   value="$DatFil"/>
            <Arg name="TableName"  value="EfekCusAgt"/>
            <Arg name="SqlName"    value="GetCusDtl"/>
          </Args>
        </Exec>
        <!--生成文件的md5-->
        <Set>DatFilNam=STRCAT(/app/ics/,$DatFil)</Set>
        <Call package="EFE" function="GetFilMD5"/>
        <Set>WJMD5=DELCTRL($Md5Val)</Set>
        <System command="EfeFilSend.sh" error="IGNORE">
          <Arg name="RemoteIp" value="$RemoteIp"/>
          <Arg name="UserName" value="$UserName"/>
          <Arg name="RemoteDir" value="$RemoteDir"/>
          <Arg name="LocalDir" value="$LocalDir"/>
          <Arg name="Localfile" value="$FilNam"/>
        </System>
        <!--Exec func="PUB:CallThirdOther" error="IGNORE">
          <Arg name="TxnCod" value="460431"/>
          <Arg name="ObjSvr" value="STDKEFE1"/>
        </Exec-->
        <Set>SvrCod=460431</Set>
        <Quote name="SendThirdOther"/>
        <If condition="INTCMP(~RetCod,3,0)">
          <!--Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UpdCusAgt"/>
            </Args>
          </Exec>
          <If condition="INTCMP(~RetCod,4,0)">
            <Exec func="PUB:CloseCursor" error="IGNORE"/>
            <Exec func="PUB:Unlock">
              <Arg name="RecKey" value="$RecKey"/>
            </Exec>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=STRCAT(更新单面编码【,$DWBM,】明细记录出错)</Set>
            <Return/>
          </If-->
          <Exec func="PUB:CommitWork"/>
        </If>
        <Else>
          <Exec func="PUB:CloseCursor" error="IGNORE"/>
          <Exec func="PUB:Unlock">
            <Arg name="RecKey" value="$RecKey"/>
          </Exec>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=发送电网通讯异常</Set>
          <Return/>
        </Else>
      </While>
      <Exec func="PUB:CloseCursor" error="IGNORE"/>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="$RecKey"/>
      </Exec>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>





  <Transaction code="460440" desc="银行查询客户缴费记录交易">
    <FlowCtrl>
      <Set>SvrCod=460440</Set>
      <Quote name="SendThirdOther"/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460441" desc="银行发起批量查询欠费客户请求">
    <DynSentence name="GetCusAgt" desc="根据单位代码获取签约客户信心">
      <Sentence>
        select DWBM, JFH from EfekCusAgt where DWDM='%s' and QYBZ in ( '0','1' ) and QYZT in ( '0','1' ) and ChkFlg='S'
      </Sentence>
      <Fields>DWDM|</Fields>
    </DynSentence>

    <FlowCtrl>
<!--获取文件序号-->
      <Exec func="PUB:nGetPubSeqNo">
        <Arg name="SeqNam" value="EFE:FILSEQ"/>
        <Arg name="SeqCnt" value="1"/>
        <Arg name="Len"    value="4"/>
        <Arg name="CycCnd" value="D"/>
      </Exec>
<!--生成银行查询客户信息文件-->
      <Set>FilNam=STRCAT(PL0301,$DWBM,$ActDat,$SelVal,.txt)</Set>
      <Set>LclDir=$EfeSndDir</Set>
      <Set>DatFil=STRCAT( $LclDir,$FilNam )</Set>
      <Exec func="PUB:ExportFromDB">
        <Args>
          <Arg name="FormatName" value="EfekCusAgt"/>
          <Arg name="FileName"   value="$DatFil"/>
          <Arg name="TableName"  value="EfekCusAgt"/>
          <Arg name="SqlName"    value="GetCusAgt"/>
        </Args>
      </Exec>
<!--将文件发到电力-->
      <System command="EfeFilSend.sh" error="IGNORE">
        <Arg name="FilNam" value="$FilNam"/>
      </System>
      <Set>SvrCod=460441</Set>
      <Quote name="SendThirdOther"/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460443" desc="银行方发起查询客户信息请求">
    <Quote name="EfeSqlLst"/>
    <!--DynSentence name="GetCusAgt" desc="根据单位代码、缴费号获取签约客户信息">
      <Sentence>
        select DWBM, JFH from EfekCusAgt where DWDM='%s' and JFH='%s'
      </Sentence>
      <Fields>DWDM|JFH|</Fields>
    </DynSentence-->

    <FlowCtrl>
      <Set>SvrCod=460443</Set>
      <Quote name="SendThirdOther"/>
      <!--由于多个业务流程都会使用到这个查询客户信息,为避免副作用,屏蔽返回时的
      客户信息更新-->
      <!--If condition="INTCMP(~RetCod,3,0)" desc="交易成功">
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="GetCusAgtByJFH"/>
        </Exec>
        <If condition="INTCMP(~RetCod,3,-2)" desc="客户记录不存在">
          <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="EfekCusAgt"/>
          </Exec>
        </If>
      </If-->
    </FlowCtrl>
  </Transaction>



  <Transaction code="460444" desc="银行方发起查询客户基本信息请求">
    <Quote name="EfeSqlLst"/>
    <FlowCtrl>
      <Set>SvrCod=460444</Set>
      <Quote name="SendThirdOther"/>
    </FlowCtrl>
  </Transaction>

  <Transaction code="460445" desc="查询客户基本信息">
    <Quote name="EfeSqlLst"/>
    <FlowCtrl>
      <Set>SvrCod=460445</Set>
      <Quote name="SendThirdOther"/>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460430" desc="银行方发起到供电方变更代扣协议请求">
    <Quote name="EfeSqlLst"/>
    <DynSentence name="UpdCusAgt" desc="根据单位代码、缴费号获取签约客户信息">
      <Sentence>
        DWBM='%s' and JFH='%s'
      </Sentence>
      <Fields>DWBM|JFH|</Fields>
    </DynSentence>
    <DynSentence name="GetCusAgtCnt" desc="查询签约信息">
      <Sentence>
        select count(*) CusCnt from EfekCusAgt where DWBM='%s' and JFH='%s'
      </Sentence>
      <Fields>DWBM|JFH|</Fields>
    </DynSentence>

    <FlowCtrl>

      <!--上主机查询客户资料-->
      <Exec func="PUB:InitTransaction"/>
      <Exec func="PUB:GetLogNo"/>
      <Set>TTxnCd=460430</Set>
      <Set>CcyCod=CNY</Set>
      <Set>ActTyp=4</Set>
      <!--TODO 主机报SC6041,经咨询总行环境异常-->
      <!--Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="HTxnCd" value="476520"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="$MsgTyp!=N">
        <Set>RspCod=ZH009</Set>
        <Set>RspMsg=帐户不存在</Set>
        <Return/>
      </If-->
      <!--校验账户名称、开户证件类型和开户证件号码-->
      <!--Set>ActNam=DELBOTHSPACE($ActNam)</Set>
      <Set>IDNo=DELBOTHSPACE($IDNo)</Set>
      <If condition="IS_NOEQUAL_STRING(TRIM($XQYZHMC,both),$ActNam)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=账户名称不符</Set>
        <Return/>
      </If>
      <If condition="IS_NOEQUAL_STRING(TRIM($ZJHM,both),$IDNo)">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=证件号码不符</Set>
        <Return/>
      </If-->

      <Set>QYZT=TRIM($QYZT,both)</Set>
      <If condition="IS_EQUAL_STRING($QYZT,0">
        <Set>QDBZ=0</Set>
      </If>
      <ElseIf condition="IS_EQUAL_STRING($QYZT,1)">
        <Set>QDBZ=1</Set>
      </ElseIf>
      <ElseIf condition="IS_EQUAL_STRING($QYZT,2)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=STRCAT(【,$JFH,】本行已变更待确定)</Set>
      </ElseIf>
      <ElseIf condition="IS_EQUAL_STRING($QYZT,3)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=STRCAT(【,$JFH,】他行已签)</Set>
      </ElseIf>

      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="GetCusAgtCnt"></Arg>
      </Exec>
      <Switch expression="~RetCod">
        <Case value="0" desc="存在记录">
          <If condition="INTCMP($CusCnt,6,0)">
            <Set>QYBZ=1</Set>
            <Exec func="PUB:UpdateRecord" desc="更新记录">
              <Arg name="TblNam" value="EfekCusAgt"/>
              <Arg name="CndSts" value="UpdCusAgt"/>
            </Exec>
          </If>
          <Else>
            <Set>QYBZ=0</Set>
            <Set>QYZT=2</Set>
            <Set>ChkFlg=U</Set>
            <Exec func="PUB:UpdateRecord" desc="更新协议内容到最新">
               <Arg name="TblNam" value="EfekCusAgt"/>
               <Arg name="CndSts" value="UpdCusAgt"/>
            </Exec>
            <Exec func="PUB:InsertRecord" error="IGNORE">
              <Args>
                <Arg name="tablename" value="EfekCusAgt"/>
              </Args>
            </Exec>
            <If condition="INTCMP(~RetCod,4,0)">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=EFE999</Set>
              <Set>RspMsg=STRCAT(登记【,$JFH,】错误)</Set>
              <Return/>
            </If>
          </Else>
          <Break/>
        </Case>
        <Default>
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=STRCAT(登记【,$JFH,】错误)</Set>
          <Return/>
        </Default>
      </Switch>


      <Set>SvrCod=460430</Set>
      <Quote name="SendThirdOther"/>
      <If condition="INTCMP(~RetCod,3,0)" desc="交易成功">
        <Set>ChkFlg=S</Set>
        <Exec func="PUB:UpdateRecord" desc="更新协议核对状态为成功">
           <Arg name="TblNam" value="EfekCusAgt"/>
           <Arg name="CndSts" value="UpdCusAgt"/>
        </Exec>
      </If>

      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
    </FlowCtrl>
  </Transaction>
</Application>
