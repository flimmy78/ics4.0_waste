<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="LSHF" code="421">
  <LibDeclare>
    <Library name="MQ"  value="app/lshf/dll/mq.so" />
  </LibDeclare>
	<!--银旅通本地主控-->
	<ConfigDeclare>
		<Config name="BatFormat"   value="etc/LSH_FMT_441999.XML"/>
		<Config name="ParaFile"    value="etc/CFG_LSH_441999.XML"/>
		<Config name="OPFCSW"      value="etc/LSH_CSW_441999.XML"/>
	</ConfigDeclare>
	<PackageDeclare>
		<Package name="AFE"        value="etc/DAFE_PKG.XML"/>
	</PackageDeclare>
	<TableDeclare>
		<Table name="afetxnjnl"    value="afetxnjnl"/>  <!--业务流水表-->
		<Table name="savthdinf"    value="savthdinf"/>  <!--第三方信息表-->
		<Table name="savcusagt"    value="savcusagt"/>  <!--协议信息表-->
		<Table name="scence_xxb"    value="scence_xxb"/>  <!--景点信息表-->
		<Table name="gzteshzbb"    value="gzteshzbb"/>
	</TableDeclare>
	<BusDefDeclare>
		<Busdef name="BrNo"      value="441999"/>
		<Busdef name="AplCls"    value="421"/><!--Added by xuan_20100202-->
	</BusDefDeclare>
	<GlobalFunction>
		<Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
		<!--Added by xuan_20100202-->
    <Function name="_after">
        <Process>
           <If condition="ISNULL($MsgTyp)">
              <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                 <Set>MsgTyp=N</Set>
                 <Set>RspCod=000000</Set>
              </If>
              <Else>
                 <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                    <Set>MsgTyp=E</Set>
                 </If>
                 <Else>
                    <Set>MsgTyp=N</Set>
                 </Else>
              </Else>
           </If>
        </Process>
    </Function>
	</GlobalFunction>
	<Define>
		<Macro name="Chk_TxnSrc">  <!--检查交易来源-->
			<If condition="INTCMP(STRLEN(DELBOTHSPACE($TxnSrc)),3,0)">
				<Set>TxnCnl=TRM</Set>   
				<Set>CnlTyp=0</Set>
			</If>
			<Else>
				<Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
				<Exec func="PUB:CodeSwitching">
					<Arg name="DatSrc"  value="OPFCSW"/>
					<Arg name="SourNam" value="TxnSrc"/>
					<Arg name="DestNam" value="CnlTyp"/>
					<Arg name="TblNam"  value="TxnSrc2CnlTyp"/>
				</Exec>
			</Else>
		</Macro>
		<!--20090615 begin-->
		<Macro name="TxnSrc_TxnCnl">
			<Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
			<Exec func="PUB:CodeSwitching">
				<Arg name="DatSrc"  value="OPFCSW"/>
				<Arg name="SourNam" value="TxnSrc"/>
				<Arg name="DestNam" value="TxnCnl"/>
				<Arg name="TblNam"  value="TxnSrc2TxnCnl"/>
			</Exec>
		</Macro>
		<!--20090615 end-->

	</Define>
	
	<Transaction code="482133" desc="景点信息查询" log_switch="1">
		  <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="MultiQuery">
			<Sentence>
			  SELECT scence_code,remark from scence_xxb order by scence_code 
			</Sentence>
		</DynSentence>
		<DynSentence name="Cnt">  <!--笔数-->
			<Sentence>
				SELECT Count(*) SumCnt FROM scence_xxb 
			</Sentence>
		</DynSentence>
	  <FlowCtrl>
	   <Exec func="PUB:InitTransaction"/>            <!--交易初始化,预留-->
	   
	   <Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="Cnt"/>
			</Exec>
     
 
     <Exec func="PUB:MultiQuery">
        <Args>
          <Arg name="SqlCmd"  value="MultiQuery"/>
        </Args>
      </Exec>
      
      
      
		</FlowCtrl>
	</Transaction>
	
	
	
	
	
	<Transaction code="482134" desc="景点门票查询">
		<FlowCtrl>
			<Exec func="PUB:GetLogNo"/>
							
			<Exec func="PUB:CallThirdOther">         <!--第三方查询-->
				<Arg name="HTxnCd" value="$TTxnCd"/>
				<Arg name="ObjSvr" value="STDALSHF"/>
			</Exec>
			
		<If condition="IS_EQUAL_STRING($RecNum,0000)">
		 <Set>RspCod=482199</Set>
		 <Set>RspMsg=该景区门票已售完，请等待</Set>
	   <Return/>
	    </If> 
	    
			<Set>RspCod=$RspCod</Set>
		</FlowCtrl>
	</Transaction>
	
	
	<Transaction code="482131" desc="订单门票查询">
		<FlowCtrl>
			<Exec func="PUB:GetLogNo"/>
		
			<Exec func="PUB:CallThirdOther">         <!--第三方查询-->
				<Arg name="HTxnCd" value="$TTxnCd"/>
				<Arg name="ObjSvr" value="STDALSHF"/>
			</Exec>
			
		<If condition="IS_EQUAL_STRING($Arrearage_Amount,00000000000000)">
		 <Set>RspCod=482199</Set>
		 <Set>RspMsg=该订单号已缴清，请返回。</Set>
	   <Return/>
	  </If> 
	    
			<Set>RspCod=$RspCod</Set>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="482137" desc="订单门票-确认信息">
		<FlowCtrl>
			<Set>TDate=GETDATE()</Set>
			<If condition="IS_NOEQUAL_STRING(CHECKDATE($Begin_Date),0)">
				<Set>RspCod=482199</Set>
		 		<Set>RspMsg=输入的日期格式不合法，请输入合法的日期</Set>
	   		<Return/>
	  	</If>
<!--	  	
	  	<If condition="OR(IS_EQUAL_STRING(INTCMP($Begin_Date, 5, $Valid_Begin_Date), 0), IS_EQUAL_STRING(INTCMP($Begin_Date, 2, $Valid_End_Date), 0), IS_EQUAL_STRING(INTCMP($Begin_Date, 5, $TDate),0))">
				<Set>RspCod=482199</Set>
		 		<Set>RspMsg=输入的日期不合法，输入的日期应该在有效日期范围内</Set>
	   		<Return/>
	  	</If>
-->	  	
	  	<Exec func="MQ:CaclValidDays" error="IGNORE">
			<Args>
			  <Arg name="Use_Date" value="$Begin_Date" />
			  <Arg name="Valid_Begin_Date" value="$Valid_Begin_Date" />
			  <Arg name="Valid_End_Date" value="$Valid_End_Date" />
			  <Arg name="Valid_Days" value="$Valid_Days" />
			  <Arg name="Today" value="$TDate" />
			</Args>
		  </Exec>
		  <If condition="~RetCod=-1">
				<Set>RspCod=482199</Set>
		 		<Set>RspMsg=输入的日期不合法，输入的日期应该在有效日期范围内</Set>
	   		<Return/>
			</If>
		  	  	
			<Set>TMPAmount=MUL($Reserve_Amoun,$TxnAmt)</Set>
			<Set>Trans_Total_Amount=ADDCHAR($TMPAmount,14,0,1)</Set>
			<Exec func="MQ:TrimSpace" error="IGNORE">
			<Args>
			  <Arg name="Remark" value="$Remark" />
			</Args>
		  </Exec>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="482132" desc="查询缴费-缴费信息">
	<!--自动冲正-->
	<!--
		<Attributes>
			<Attribute name="integrity" value="2" code="482107" interval="5" timeout="30" maxtimes="15"/>
		</Attributes>
	-->	
		<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
		<DynSentence name="QryCrpAgr">             <!--查询单位信息 -->
			<Sentence>
				SELECT TActNo, BBusTyp FROM savcrpagr WHERE CAgtNo='%s' AND SvrSts='1'
			</Sentence>
			<Fields>CAgtNo|</Fields>
		</DynSentence>
		<!--modify 20090224 begin-->
		<DynSentence name="InsTrans"> <!-- -->
       <Sentence>
         insert into ylttrans(kh,rq,jym,jqdm,jqmc,mpdm,mpmc,dj,sl,jyje,sjhm,syrq,ddbh,zdbh,fws,ydnr,beizhu,yx,kjls) values('%s','%s','%s','','','','','','','%s','','','%s','%s','%s','%s','','','%s')
       </Sentence>
       <Fields>ActNo|ActDat|Trans_Code|Trans_Amount|TCusNm|Terminal_Code|Provide_Name|Product_Name|TckNo|</Fields>
     </DynSentence>
     <!--modify 20090224 end-->
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>       <!--交易初始化,预留-->
			<Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="QryCrpAgr"/>
			</Exec>
			
			
			
			<Exec func="PUB:GetLogNo"/>
			<Set>Trans_Code=010004</Set>
			<!--Set>System_Ref_Code=SUBSTR($LOGNO,2,12)</Set-->
			<Set>ThdKey=STRCAT($LOGNO,0000)</Set>
			<Set>RsFld3=SUBSTR($LOGNO,2,12)</Set>
			
			<!--对帐用-->
			<Set>CntrId=010003</Set>
			<Set>CrpCod=$Member_id</Set>>			
			<Set>TActDt=GETDATE()</Set>
			<Set>RsFld1=STRCAT($LOGNO,0000)</Set>
			
			<Set>NodNo=441800</Set>
			<Set>RcvAmt=$Trans_Amount</Set>
			<If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
				<Set>HTxnCd=471140</Set>
				<Set>VchChk=0</Set>
				<Set>PayMod=0</Set>
				<Set>ActFlg=$ActTyp</Set>
				<Set>VchCod=00000000</Set>
			</If>
			<ElseIf condition="INTCMP($ActTyp,3,1)"> <!--对公-->
				<Set>HTxnCd=451610</Set>
				<Set>ActNod=SUBSTR($TActNo,1,6)</Set>
				<Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
				<Delete>TActNo</Delete>
				<Set>BusTyp=CRP51</Set>
				<Set>BusSub=01</Set>                   <!--应用子码，对应业务类型CRP51-->
				<Set>ActFlg=2</Set>
			</ElseIf>
			<Else>                                   <!--第三方-->
				<!--
				<Set>TTxnCd=STRCAT($TTxnCd,_T)</Set>
				<Set>ThdSvr=STDDOPFP</Set>-->
				<!--他行卡暂时不做-->
				<Return/>
			</Else>
						
			<Set>FTxnTm=GETDATETIME()</Set>
			<Quote name="Chk_TxnSrc"/>
     	<!--20090615 begin-->
			<Quote name="TxnSrc_TxnCnl"/>
      <!--20090615  end-->
 
			<Exec func="PUB:ReadModuleCfg">
				<Arg name="Application" value="$AppNm"/>
				<Arg name="Transaction" value="482132"/>   <!--CFG_LSH_441999.XML -->
			</Exec>
			

			<Call package="AFE" function="AFE_SglBkPay"/>
			<!--add 20090224 begin-->
			<Set>Trans_Code=010004</Set>
			<!--add 20090224 end-->
			<Exec func="PUB:ExecSql" error="IGNORE">
         <Arg name="SqlCmd"   value="InsTrans"/>
      </Exec>
      
	    <Set>DskNo=$Return_Code</Set>
	    
			<If condition="$RspCod=000000">
				<Set>MsgTyp=N</Set>
			</If>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="482135" desc="门票预订信息-缴费信息">
		<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
		<DynSentence name="QryCrpAgr">             <!--查询单位信息 -->
			<Sentence>
				SELECT TActNo, BBusTyp FROM savcrpagr WHERE CAgtNo='%s' AND SvrSts='1'
			</Sentence>
			<Fields>CAgtNo|</Fields>
		</DynSentence>
		<!--modify 20090224 begin-->
		<DynSentence name="InsTrans"> <!-- -->
       <Sentence>
         insert into ylttrans(kh,rq,jym,jqdm,jqmc,mpdm,mpmc,dj,sl,jyje,sjhm,syrq,ddbh,zdbh,fws,ydnr,beizhu,yx,kjls) values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','','','%s','%s','%s')
       </Sentence>
       <Fields>ActNo|ActDat|Trans_Code|Scence_Code|Scence_Name|Product_Code|Product_Name|E_Discount_Price1|Reserve_Amoun|Amount1|Mobile_Phone_Number|Begin_Date|TCusNm|Terminal_Code|Remark1|Valid_Days|TckNo|</Fields>
     </DynSentence>
    <!--modify 20090224 end-->    
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>       <!--交易初始化,预留-->
			<Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="QryCrpAgr"/>
			</Exec>
			<!--计算总金额-->
			
			<Set>TXNAMT=ADDCHAR($Trans_Total_Amount,14,0,1)</Set>
			
			<Exec func="PUB:GetLogNo"/>
			
			<Set>ThdKey=STRCAT($LOGNO,0000)</Set>
			<Set>RsFld3=SUBSTR($LOGNO,2,12)</Set>
			<!--对帐用-->
			<Set>Scence_Code1=SUBSTR($Scence_Code,1,4)</Set>
			<Set>CclNo1=STRCAT($Scence_Code1,_)</Set>
			<Set>CclNo=STRCAT($CclNo1,$Mobile_Phone_Number)</Set>			
			<Set>TActDt=GETDATE()</Set>
			<Set>CntrId=090003</Set>
			<Set>RsFld1=STRCAT($LOGNO,0000)</Set>
						
			<Set>NodNo=441800</Set>
			<Set>RcvAmt=$Trans_Amount</Set>
			<If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
				<Set>HTxnCd=471140</Set>
				<Set>VchChk=0</Set>
				<Set>PayMod=0</Set>
				<Set>ActFlg=$ActTyp</Set>
				<Set>VchCod=00000000</Set>
			</If>
			<ElseIf condition="INTCMP($ActTyp,3,1)"> <!--对公-->
				<Set>HTxnCd=451610</Set>
				<Set>ActNod=SUBSTR($TActNo,1,6)</Set>
				<Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
				<Delete>TActNo</Delete>
				<Set>BusTyp=CRP51</Set>
				<Set>BusSub=01</Set>                   <!--应用子码，对应业务类型CRP51-->
				<Set>ActFlg=2</Set>
			</ElseIf>
			<Else>                                   <!--第三方-->
				<!--
				<Set>TTxnCd=STRCAT($TTxnCd,_T)</Set>
				<Set>ThdSvr=STDDOPFP</Set>-->
				<!--他行卡暂时不做-->
				<Return/>
			</Else>
						
			<Set>FTxnTm=GETDATETIME()</Set>
			<Quote name="Chk_TxnSrc"/>
			<!--20090615 begin-->
			<Quote name="TxnSrc_TxnCnl"/>
      <!--20090615  end-->
      
			<Exec func="PUB:ReadModuleCfg">
				<Arg name="Application" value="$AppNm"/>
				<Arg name="Transaction" value="482135"/>   <!--CFG_LSH_441999.XML -->
			</Exec>
     
     <Set>DskNo=$Return_Code</Set>
     
			<Call package="AFE" function="AFE_SglBkPay"/>
			<!--modify begin 20090223-->			
			<If condition="OR(IS_EQUAL_STRING($RspCod,478607), IS_EQUAL_STRING($RspCod,478613))"><!--冲正-->
				<Set>MsgTyp=E</Set>				
				<Set>RspCod=482199</Set>
        <Set>RspMsg=$PB_Return_Code_Msg</Set>
				<Goto>CRCHOST</Goto>
				<Return/>
			</If>
			<If condition="IS_NOEQUAL_STRING($RspCod,000000)">
				<Return/>
			</If>
			<!--modify end 20090223-->				
			<Exec func="MQ:TrimSpace" error="IGNORE">
			<Args>
			  <Arg name="Remark1" value="$Remark1" />
			</Args>
		  </Exec>

			<Exec func="PUB:ExecSql" error="IGNORE">
         <Arg name="SqlCmd"   value="InsTrans"/>
      </Exec>	
      <Exec func="PUB:CallThirdOther">         <!--第三方查询-->
				<Arg name="HTxnCd" value="482136"/>
				<Arg name="ObjSvr" value="STDALSHF"/>
			</Exec>								
			<If condition="$RspCod=000000">
				<Set>MsgTyp=N</Set>
				<Return/>
			</If>
			
			<Label>CRCHOST</Label> <!--只上主机冲正-->
         <Set>OLogNo=$LogNo</Set>
				 <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
					<Set>HTxnCd=471149</Set>
				 </If>
				 <ElseIf condition="INTCMP($ActTyp,3,1)"> <!--对公-->
					<Set>HTxnCd=451619</Set>
				 </ElseIf>
				 <Else>                                   <!--第三方-->
					<Return/>
				 </Else>
			
         <Set>TIATyp=C</Set>
         <Exec func="PUB:BeginWork"/>    <!--启动完整性控制--> 
         <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
            <Arg name="HTxnCd" value="959999"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         
				<If condition="IS_EQUAL_STRING(~RetCod,0)">    <!--上主机冲正成功-->
						<Set>HTxnSt=C</Set>
						<Set>TxnSts=C</Set>
						<Exec func="PUB:UpdateJournal">
						</Exec>
					  <Set>RspCod=482199</Set>
            <Set>RspMsg=$PB_Return_Code_Msg</Set>
            <Return/>
				</If>
				<Else>    <!--不成功登记自动冲正-->
            <Exec func="PUB:DefaultErrorProc"/>            
				</Else>
		</FlowCtrl>
	</Transaction>
	
	
  <Transaction code="482147" desc="补打凭条查询">
		<Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <!--modify 20090224 begin-->
    <DynSentence name="MultiQuery">
			<Sentence>
			  SELECT jym,jqmc,mpmc,ddbh,sjhm,jyje,dj,sl,syrq,fws,ydnr,beizhu,yx,kjls,rq from ylttrans WHERE kh='%s' order by rq,kjls DESC FETCH FIRST 15 ROWS ONLY
			</Sentence>
			<Fields>ActNo|</Fields>
		</DynSentence>
		<!--modify 20090224 end -->
		<DynSentence name="Cnt">  <!--笔数-->
			<Sentence>
				SELECT Count(*) SumCnt FROM (select * from ylttrans  where kh='%s' FETCH FIRST 15 ROWS ONLY) as tmp				
			</Sentence>
			<Fields>ActNo|</Fields>
		</DynSentence>
	  <FlowCtrl>
	  
	  
	   <Exec func="PUB:InitTransaction"/>            <!--交易初始化,预留-->	   
	   <!--Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="Cnt"/>
		</Exec--> 
		 <Exec func="PUB:ReadRecord">
				<Arg name="SqlCmd" value="Cnt"/>
		 </Exec>
     <If condition="$SumCnt=0">
        <If condition="~RetCod=-1">
            <Set>RspCod=RX9999</Set>
            <Set>RspMsg=数据库错误</Set>
            <Return/>
        </If>
        <Set>RspCod=RX9999</Set>
        <Set>RspMsg=此卡无银旅通业务交易记录</Set>
        <Return/>
     </If>
     <Set>Stsxx=如有疑问或问题请咨询银旅通客户服务热线：4008-960-168</Set>
     <Exec func="PUB:MultiQuery">
        <Args>
          <Arg name="SqlCmd"  value="MultiQuery"/>
          <arg name="RecNumPerPage"  value="15"/>
        </Args>
      </Exec>
      
			<!--If condition="INTCMP($SumCnt,6,20)">	
				<Set>SumCnt=20</Set>
			</If-->	                    
		</FlowCtrl>
	</Transaction>

<Transaction code="482144" desc="银旅通对帐">
		<DynSentence name="QryJnlInfo">            <!--查询流水信息 -->
			<Sentence>
				SELECT distinct TCusNm FROM afetxnjnl WHERE BrNo='441999' AND ActDat ='%s'and HTxnSt='S' and CAgtNo='%s'
			</Sentence>
			<Fields>ClrDat|CAgtNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql01">            <!--查询信息 -->
			<Sentence>
				SELECT CntrId,CrpCod,TCusNm,RsFld1,RsFld2,ActNo,CclNo,TxnAmt,DskNo,HTxnSt 
				FROM afetxnjnl WHERE BrNo='441999' AND ActDat='%s' and HTxnSt='S' and CAgtNo='%s' and TCusNm='%s'
				<!--交易码,单位代码,订单号,交易流水号,交易时间,银行账号,景点ID_手机号,交易金额,结果代码（金旅）,交易结果（交通银行）-->
			</Sentence>
			<Fields>ClrDat|CAgtNo|TCusNm|</Fields>
		</DynSentence>
		<DynSentence name="Sql02">            <!--汇总 -->
			<Sentence>
				SELECT SUM(CAST(TxnAmt AS BIGINT)) YLTAMT,COUNT(*) YLTcnt 
				FROM afetxnjnl WHERE BrNo='441999' AND ActDat='%s' and HTxnSt='S' and CAgtNo='%s' 
			</Sentence>
			<Fields>ClrDat|CAgtNo|</Fields>
		</DynSentence>		
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>
			<Exec func="PUB:GetLogNo"/>
			
			<Set>AppNm=GZ_GZL</Set>
			<Exec func="PUB:CodeSwitching">
				<Arg name="DatSrc"  value="OPFCSW"/>
				<Arg name="SourNam" value="AppNm"/>
				<Arg name="DestNam" value="CAgtNo"/>
				<Arg name="TblNam"  value="GZ_AppNm"/>
			</Exec>
			<Set>ClrDat=GETDATE()</Set>
			
			<Set>ClrDat=CALCDATE($ClrDat,-,d,1)</Set>
			
			<!--<Set>ClrDat=GETDATE()</Set>-->
			<!--<Set>ClrDat=20090322</Set>-->
	    <Set>DatFil=STRCAT(dat/opf/,BOCOM,$ClrDat)</Set> 
		  <Set>DatFil1=STRCAT(BOCOM,$ClrDat)</Set>    
			
			<!--生成文件-->
			<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql02" />
			</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
			
					<Set>YLTcnt1=ADDCHAR($YLTcnt,8,0,1)</Set>
					<Set>YLTAMT1=ADDCHAR($YLTAMT,14,0,1)</Set>
										
					<Exec func="PUB:WriteFile" error="IGNORE">
					  <Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="w"/>
				    <Arg name="Data"	 value="$ClrDat"/>
				    <Arg name="Data"	 value=" "/> 
						<Arg name="Data"	 value="$YLTcnt1"/> 
						<Arg name="Data"	 value=" "/>
						<Arg name="Data"	 value="$YLTAMT1"/> 
						<Arg name="Data"	 value=" "/>
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>
			
			<Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql"  value="QryJnlInfo"/>
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标出错</Set>
				<Return/>
			</If>
						
			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE">
					<Arg name="CursorName" value="CURSOR_1"/>
				</Exec>
				<If condition="~RetCod=100">
					<Break/>
				</If>
		
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql01" />
					</Exec>
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>	
   
					<Set>CntrId1=ADDCHAR($CntrId,6, ,0)</Set>
					<Set>CrpCod1=ADDCHAR($CrpCod,8, ,0)</Set>
					<Set>TCusNm1=ADDCHAR($TCusNm,12, ,0)</Set>
					<Set>RsFld11=ADDCHAR($RsFld1,18, ,0)</Set>
					<Set>RsFld21=ADDCHAR($RsFld2,27, ,0)</Set>
					<Set>ActNo1=ADDCHAR($ActNo,23, ,0)</Set>
					<Set>SCclNo1=ADDCHAR($CclNo,16, ,0)</Set>
					<Set>TxnAmt1=ADDCHAR($TxnAmt,14, ,0)</Set>
					<Set>DskNo1=ADDCHAR($DskNo,3, ,0)</Set>
					<If condition="IS_EQUAL_STRING($HTxnSt,S)">
					 <Set>HTxnSt1=交易成功</Set>
					</If>
					<Else>
					 <Set>HTxnSt1=交易失败</Set>
					</Else>
					<Set>HTxnSt2=ADDCHAR($HTxnSt1,30, ,0)</Set>
					
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="$CntrId1"/> <!--交易码 -->
						<Arg name="Data"	 value=" "/>
						<Arg name="Data"	 value="$CrpCod1"/> <!--单位代码 -->
						<Arg name="Data"	 value=" "/>
						<Arg name="Data"	 value="$TCusNm1"/> <!--订单号 -->
						<Arg name="Data"	 value=" "/>
						<Arg name="Data"	 value="$RsFld11"/> <!--交易流水号 -->
						<Arg name="Data"	 value=" "/>
						<Arg name="Data"	 value="$RsFld21"/> <!--交易时间 -->
						<Arg name="Data"	 value=" "/>						
						<Arg name="Data"	 value="$ActNo1"/> <!--银行账号 -->
						<Arg name="Data"	 value=" "/>
						<Arg name="Data"	 value="$SCclNo1"/> <!--景点ID_手机号（旅游缴款无此项内容） -->
						<Arg name="Data"	 value=" "/>
						<Arg name="Data"	 value="$TxnAmt1"/> <!--交易金额 -->
						<Arg name="Data"	 value=" "/>
						<Arg name="Data"	 value="$DskNo1"/> <!--结果代码（金旅）-->
						<Arg name="Data"	 value=" "/>
						<Arg name="Data"	 value="$HTxnSt2"/> <!--交易结果（交通银行）-->
						<Arg name="Data"	 value=" "/>
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>									
      </While>
			<Set>SendFil=$DatFil</Set>
			<Exec func="PUB:CloseCursor" error="IGNORE">
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>      			      								
		
			<Exec func="PUB:FtpPut" error="IGNORE">
				<Arg name="IpAdr" value="182.53.15.200"/>
				<Arg name="UsrNam" value="icsadm"/>
				<Arg name="UsrPwd" value="134679"/>
				<Arg name="ObjDir" value="dat"/>
				<Arg name="LclDir" value="dat/opf"/>
				<Arg name="LclFil" value="$DatFil1"/>
			</Exec>
			
			<If condition="~RetCod=-1">						
				<Set>RspCod=478715</Set>
				<Set>RspMsg=向第三方发送文件失败</Set>
				<Return/>
			</If>	
			<!--
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>-->
		</FlowCtrl>
</Transaction>

<Transaction code="482162" desc="报表打印">
		<DynSentence name="QryJnlInfo">            <!--查询流水信息 -->
			<Sentence>
				SELECT distinct RsFld2 FROM afetxnjnl WHERE BrNo='441999' AND ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') and RsFld2='%s'
			</Sentence>
			<Fields>ActDat1|ActDat2|RsFld2|</Fields>
		</DynSentence>
		<DynSentence name="Sql07">            <!--查询流水信息 -->
			<Sentence>
				SELECT distinct RsFld2 FROM afetxnjnl WHERE BrNo='441999' AND ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') 
			</Sentence>
			<Fields>ActDat1|ActDat2|</Fields>
		</DynSentence>
		<DynSentence name="Sql01">            <!--自助通金额和笔数 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) SAgtAmt,COUNT(*) Scnt
			 FROM afetxnjnl WHERE TXNCNL= 'TRM' and ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') and BrNo='441999' and RsFld2='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|RsFld2|</Fields>
		</DynSentence>
		<DynSentence name="Sql02">            <!--网银金额和笔数 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) WAgtAmt,COUNT(*) Wcnt
			 FROM afetxnjnl WHERE TXNCNL= 'WEB' and ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') and BrNo='441999' and RsFld2='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|RsFld2|</Fields>
		</DynSentence>
		<DynSentence name="Sql03">            <!--手续费 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT))*12/10000 sxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') and BrNo='441999' and RsFld2='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|RsFld2|</Fields>
		</DynSentence>
		<DynSentence name="Sql04">            <!--自助通汇总 -->
			<Sentence>
				SELECT SUM(CAST(TxnAmt AS BIGINT)) SSAgtAmt,COUNT(*) SScnt 
				FROM afetxnjnl WHERE TXNCNL= 'TRM' and BrNo='441999' AND ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') 
			</Sentence>
			<Fields>ActDat1|ActDat2|</Fields>
		</DynSentence>
		<DynSentence name="Sql05">            <!--网银汇总 -->
			<Sentence>
				SELECT SUM(CAST(TxnAmt AS BIGINT)) SWAgtAmt,COUNT(*) SWcnt 
				FROM afetxnjnl WHERE TXNCNL= 'WEB' and BrNo='441999' AND ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') 
			</Sentence>
			<Fields>ActDat1|ActDat2|</Fields>
		</DynSentence>
		<DynSentence name="Sql06">            <!--手续费汇总 -->
			<Sentence>
				SELECT SUM(CAST(TxnAmt AS BIGINT))*12/10000 Ssxf 
				FROM afetxnjnl WHERE BrNo='441999' AND ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') 
			</Sentence>
			<Fields>ActDat1|ActDat2|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>
	    <Set>DatFil=STRCAT(dat/term/send/,LSHF003,$ActDat1,$ActDat2,.dat)</Set>

	    <Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql"  value="Sql07"/>
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标出错</Set>
				<Return/>
			</If>
			
			<Exec func="PUB:WriteFile" error="IGNORE">
			<Arg name="FileName" value="$DatFil"/>
				<Arg name="OpenMode" value="w"/>
				<Arg name="Data"	 value="[2]:ActDat1="/> 
				<Arg name="Data"	 value="$ActDat1"/>
				<Arg name="Data"	 value="|"/> 
				<Arg name="Data"	 value="ActDat2="/> 
				<Arg name="Data"	 value="$ActDat2"/> 
				<Arg name="Data"	 value="|"/>
				<Arg name="ESCFMT"   value="\\n"/>
			</Exec>	
				
				<While>
				<Exec func="PUB:FetchCursor" error="IGNORE">
					<Arg name="CursorName" value="CURSOR_1"/>
				</Exec>
				<If condition="~RetCod=100">
					<Break/>
				</If>
								
				  <Exec func="PUB:OpenCursor" error="IGNORE">
						<Arg name="sql"  value="QryJnlInfo"/>
						<Arg name="CursorName" value="CURSOR_2"/>
					</Exec>
					<If condition="~RetCod!=0">
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=打开游标出错</Set>
					<Return/>
				  </If>
				
				<While>
					<Exec func="PUB:FetchCursor" error="IGNORE">
						<Arg name="CursorName" value="CURSOR_2"/>
					</Exec>
					<If condition="~RetCod=100">
						<Break/>
					</If>
								
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql01" />
					</Exec>
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>	
						
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql02" />
					</Exec>
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>		
							
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql03" />
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>											

					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="[3]:RsFld2="/> 
						<Arg name="Data"	 value="$RsFld2"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SAgtAmt="/> 
						<Arg name="Data"	 value="$SAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="Scnt="/> 
						<Arg name="Data"	 value="$Scnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="WAgtAmt="/> 
						<Arg name="Data"	 value="$WAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="Wcnt="/> 
						<Arg name="Data"	 value="$Wcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="sxf="/> 
						<Arg name="Data"	 value="$sxf"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>					
					</While>
				
				  <Exec func="PUB:CloseCursor" error="IGNORE">
					  <Arg name="CursorName" value="CURSOR_2"/>
				  </Exec>
				
      </While>

			<Exec func="PUB:CloseCursor" error="IGNORE">
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
      
			
      <Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql04" />
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
					
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql05" />
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>	
					
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql06" />
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
					
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="[7]:SSAgtAmt="/> 
						<Arg name="Data"	 value="$SSAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SScnt="/> 
						<Arg name="Data"	 value="$SScnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SWAgtAmt="/> 
						<Arg name="Data"	 value="$SWAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SWcnt="/> 
						<Arg name="Data"	 value="$SWcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="Ssxf="/> 
						<Arg name="Data"	 value="$Ssxf"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>
					
			<Exec func="PUB:GenerateReport" desc="根据转换后的文件生成报表">
				<Arg name="ObjFil" value="STRCAT(dat/term/send/,LSHF,$TlrId,.RPT)"/>
				<Arg name="FmtFil" value="etc/LSHF_RPT.XML"/>
				<Arg name="DatFil" value="$DatFil"/>
			</Exec>

			<Exec func="PUB:SendFileMessage2">
				<Arg name="MsgTyp"  value="4"/>
				<Arg name="ObjNod"  value="$NodNo"/>
				<Arg name="BusTyp"  value="48"/>
				<Arg name="AplCod"  value="482150"/>
				<Arg name="FilNam" value="STRCAT(LSHF,$TlrId,.RPT)"/>
				<Arg name="Summary" value="广州特色业务报表"/>
				<Arg name="ObjTlr"  value="$TlrId"/> 
			</Exec>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>
		</FlowCtrl>
	</Transaction>


<Transaction code="482163" desc="全省业务汇总代理收费报表">
		<DynSentence name="QryJnlInfo">            <!--查询流水信息 -->
			<Sentence>
				SELECT distinct BRNO FROM afetxnjnl WHERE HTxnSt IN ('S','T','U') and BRNO='%s'
			</Sentence>
			<Fields>BRNO|</Fields>
		</DynSentence>
		<DynSentence name="QryJnlInfo1">            <!--查询流水信息 -->
			<Sentence>
				SELECT distinct BRNO FROM afetxnjnl WHERE HTxnSt IN ('S','T','U') 
			</Sentence>
		</DynSentence>
		<DynSentence name="Sql01">            <!--移动充值易金额和笔数,手续费4410000226-->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YDAgtAmt,COUNT(*) YDcnt,SUM(CAST(TxnAmt AS BIGINT))*75/10000 YDsxf
			 FROM afetxnjnl WHERE CAgtNo= '4410000533' and HTxnSt IN ('S','T','U') and BrNo='%s' 
			</Sentence>
			<Fields>BrNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql02">            <!--福利彩票金额和笔数,手续费 4410000101-->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) FLCPAgtAmt,COUNT(*) FLCPcnt,SUM(CAST(TxnAmt AS BIGINT))*6/100 FLCPsxf
			 FROM afetxnjnl WHERE CAgtNo= '4410000577' and HTxnSt IN ('S','T','U') and BrNo='%s' 
			</Sentence>
			<Fields>BrNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql03">            <!--银旅通金额和笔数,手续费 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YLTAgtAmt,COUNT(*) YLTcnt,SUM(CAST(TxnAmt AS BIGINT))*5/1000 YLTsxf
			 FROM afetxnjnl WHERE CAgtNo= '4410000539' and HTxnSt IN ('S','T','U') and BrNo='%s' 
			</Sentence>
			<Fields>BrNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql04">            <!--粤通卡金额和笔数,手续费 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YTKAgtAmt,COUNT(*) YTKcnt,SUM(CAST(TxnAmt AS BIGINT))*1/1000 YTKsxf
			 FROM afetxnjnl WHERE CAgtNo= '4410000532' and HTxnSt IN ('S','T','U') and BrNo='%s' 
			</Sentence>
			<Fields>BrNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql05">            <!--羊城通月卡充值金额和笔数,手续费 4410000011-->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YCTAgtAmt,COUNT(*) YCTcnt,SUM(CAST(TxnAmt AS BIGINT))*1/1000 YCTsxf
			 FROM afetxnjnl WHERE CAgtNo= '4410000531' and HTxnSt IN ('S','T','U') and BrNo='%s' 
			</Sentence>
			<Fields>BrNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql06">            <!--合计金额和笔数 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) HJAgtAmt,COUNT(*) HJcnt
			 FROM afetxnjnl WHERE HTxnSt IN ('S','T','U') and BrNo='%s' 
			</Sentence>
			<Fields>BrNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql07">            <!--汇总 金额和笔数-->
			<Sentence>
				SELECT SUM(CAST(TxnAmt AS BIGINT)) HZAgtAmt,COUNT(*) HZcnt 
				FROM afetxnjnl WHERE HTxnSt IN ('S','T','U') 
			</Sentence>
		</DynSentence>

		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>
	    <Set>DatFil=STRCAT(dat/term/send/,LSHF01,$TlrId,.dat)</Set>

	    <Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql"  value="QryJnlInfo1"/>
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标出错</Set>
				<Return/>
			</If>
			
				
				<While>
				<Exec func="PUB:FetchCursor" error="IGNORE">
					<Arg name="CursorName" value="CURSOR_1"/>
				</Exec>
				<If condition="~RetCod=100">
					<Break/>
				</If>
								
				  <Exec func="PUB:OpenCursor" error="IGNORE">
						<Arg name="sql"  value="QryJnlInfo"/>
						<Arg name="CursorName" value="CURSOR_2"/>
					</Exec>
					<If condition="~RetCod!=0">
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=打开游标出错</Set>
					<Return/>
				  </If>
				
				<While>
					<Exec func="PUB:FetchCursor" error="IGNORE">
						<Arg name="CursorName" value="CURSOR_2"/>
					</Exec>
					<If condition="~RetCod=100">
						<Break/>
					</If>
								
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql01" />     <!--移动充值易金额和笔数,手续费-->
					</Exec>
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>	
						
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql02" />         <!--福利彩票金额和笔数,手续费 -->
					</Exec>
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>		
							
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql03" />       <!--银旅通金额和笔数,手续费 -->
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>	
					
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql04" />    <!--粤通卡金额和笔数,手续费 -->
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
					
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql05" />   <!--羊城通月卡充值金额和笔数,手续费 -->
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>	
					
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql06" />    <!--合计金额和笔数 -->
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>									
          <!--手续费-->
          <Set>sxf1=ADDAMT($YDsxf,$FLCPsxf)</Set>
          <Set>sxf2=ADDAMT($sxf1,$YLTsxf)</Set>
          <Set>sxf3=ADDAMT($sxf2,$YTKsxf)</Set>
          <Set>sxf=ADDAMT($sxf3,$YCTsxf)</Set>
          
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="[3]:BrNo="/> 
						<Arg name="Data"	 value="$BrNo"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YDAgtAmt="/> <!--移动充值易金额和笔数,手续费-->
						<Arg name="Data"	 value="$YDAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YDcnt="/> 
						<Arg name="Data"	 value="$YDcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="FLCPAgtAmt="/> <!--福利彩票金额和笔数,手续费 -->
						<Arg name="Data"	 value="$FLCPAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="FLCPcnt="/> 
						<Arg name="Data"	 value="$FLCPcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YLTAgtAmt="/> <!--银旅通金额和笔数,手续费 -->
						<Arg name="Data"	 value="$YLTAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YLTcnt="/> 
						<Arg name="Data"	 value="$YLTcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YTKAgtAmt="/>  <!--粤通卡金额和笔数,手续费 -->
						<Arg name="Data"	 value="$YTKAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YTKcnt="/> 
						<Arg name="Data"	 value="$YTKcnt"/>
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YCTAgtAmt="/> <!--羊城通月卡充值金额和笔数,手续费 -->
						<Arg name="Data"	 value="$YCTAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YCTcnt="/> 
						<Arg name="Data"	 value="$YCTcnt"/>
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="HJAgtAmt="/> <!--合计金额和笔数 -->
						<Arg name="Data"	 value="$HJAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="HJcnt="/> 
						<Arg name="Data"	 value="$HJcnt"/>
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="sxf="/> 
						<Arg name="Data"	 value="$sxf"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>					
					</While>
				  
          <Set>Ssxf=ADDAMT($Ssxf,$sxf)</Set>
				  
				  <Exec func="PUB:CloseCursor" error="IGNORE">
					  <Arg name="CursorName" value="CURSOR_2"/>
				  </Exec>
				
      </While>

			<Exec func="PUB:CloseCursor" error="IGNORE">
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
      
			
      <Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql07" />
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
										
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="[7]:HZAgtAmt="/> 
						<Arg name="Data"	 value="$HZAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="HZcnt="/> 
						<Arg name="Data"	 value="$HZcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="Ssxf="/> 
						<Arg name="Data"	 value="$Ssxf"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>
					
			<Exec func="PUB:GenerateReport" desc="根据转换后的文件生成报表">
				<Arg name="ObjFil" value="STRCAT(dat/term/send/,LSHF01,$TlrId,.RPT)"/>
				<Arg name="FmtFil" value="etc/LSHF01_RPT.XML"/>
				<Arg name="DatFil" value="$DatFil"/>
			</Exec>

			<Exec func="PUB:SendFileMessage2">
				<Arg name="MsgTyp"  value="4"/>
				<Arg name="ObjNod"  value="$NodNo"/>
				<Arg name="BusTyp"  value="09"/>
				<Arg name="AplCod"  value="090010"/>
				<Arg name="FilNam" value="STRCAT(LSHF01,$TlrId,.RPT)"/>
				<Arg name="Summary" value="全省业务汇总代理收费报表"/>
				<Arg name="ObjTlr"  value="$TlrId"/> 
			</Exec>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>
		</FlowCtrl>
	</Transaction>
	
	<Transaction code="482164" desc="终端代理收费报表">
		<DynSentence name="QryJnlInfo">            <!--查询流水信息 -->
			<Sentence>
				SELECT distinct NodNo FROM afetxnjnl WHERE ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') and NodNo='%s'
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
		<DynSentence name="QryJnlInfo1">            <!--查询流水信息 -->
			<Sentence>
				SELECT distinct NodNo FROM afetxnjnl WHERE ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') 
			</Sentence>
			<Fields>ActDat1|ActDat2|</Fields>
		</DynSentence>
		<DynSentence name="Sql01">            <!--交有线电视费金额和笔数,手续费-->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YXDSAgtAmt,COUNT(*) YXDScnt,SUM(CAST(TxnAmt AS BIGINT))*12/10000 YXDSsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000530' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql02">            <!--车船税金额和笔数,手续费-->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) CCSAgtAmt,COUNT(*) CCScnt,SUM(CAST(TxnAmt AS BIGINT))*12/10000 CCSsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000537' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql03">            <!--移动交费金额和笔数,手续费-->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YDJFAgtAmt,COUNT(*) YDJFcnt,SUM(CAST(TxnAmt AS BIGINT))*12/10000 YDJFsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000536' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql04">            <!--联通交费金额和笔数,手续费-->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) LTAgtAmt,COUNT(*) LTcnt,SUM(CAST(TxnAmt AS BIGINT))*12/10000 LTsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000535' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql05">            <!--电信金额和笔数,手续费-->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) DXAgtAmt,COUNT(*) DXcnt,SUM(CAST(TxnAmt AS BIGINT))*12/10000 DXsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000125' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql06">            <!--移动充值易金额和笔数,手续费-->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YDAgtAmt,COUNT(*) YDcnt,SUM(CAST(TxnAmt AS BIGINT))*75/10000 YDsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000533' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql07">            <!--粤通卡金额和笔数,手续费 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YTKAgtAmt,COUNT(*) YTKcnt,SUM(CAST(TxnAmt AS BIGINT))*1/1000 YTKsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000532' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql08">            <!--银旅通金额和笔数,手续费 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YLTAgtAmt,COUNT(*) YLTcnt,SUM(CAST(TxnAmt AS BIGINT))*5/1000 YLTsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000539' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>		
		<DynSentence name="Sql09">            <!--羊城通金额和笔数,手续费 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) YCTAgtAmt,COUNT(*) YCTcnt,SUM(CAST(TxnAmt AS BIGINT))*1/1000 YCTsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000531' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
		<DynSentence name="Sql10">            <!--福利彩票金额和笔数,手续费 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) FLCPAgtAmt,COUNT(*) FLCPcnt,SUM(CAST(TxnAmt AS BIGINT))*6/100 FLCPsxf
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and CAgtNo= '4410000577' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>	
		<DynSentence name="Sql11">            <!--合计金额和笔数 -->
			<Sentence>
			SELECT SUM(CAST(TxnAmt AS BIGINT)) HJAgtAmt,COUNT(*) HJcnt
			 FROM afetxnjnl WHERE ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') and NodNo='%s' 
			</Sentence>
			<Fields>ActDat1|ActDat2|NodNo|</Fields>
		</DynSentence>
    <DynSentence name="Sql12">            <!--汇总 金额和笔数-->
			<Sentence>
				SELECT SUM(CAST(TxnAmt AS BIGINT)) HZAgtAmt,COUNT(*) HZcnt 
				FROM afetxnjnl WHERE ActDat between '%s' and '%s' and HTxnSt IN ('S','T','U') 
			</Sentence>
			<Fields>ActDat1|ActDat2|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Exec func="PUB:InitTransaction"/>
	    <Set>DatFil=STRCAT(dat/term/send/,LSHF02,$ActDat1,$ActDat2,.dat)</Set>

	    <Exec func="PUB:OpenCursor" error="IGNORE">
				<Arg name="sql"  value="QryJnlInfo1"/>
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
			<If condition="~RetCod!=0">
				<Set>RspCod=PFA999</Set>
				<Set>RspMsg=打开游标出错</Set>
				<Return/>
			</If>
			
			<Exec func="PUB:WriteFile" error="IGNORE">
			<Arg name="FileName" value="$DatFil"/>
				<Arg name="OpenMode" value="w"/>
				<Arg name="Data"	 value="[2]:ActDat1="/> 
				<Arg name="Data"	 value="$ActDat1"/>
				<Arg name="Data"	 value="|"/> 
				<Arg name="Data"	 value="ActDat2="/> 
				<Arg name="Data"	 value="$ActDat2"/> 
				<Arg name="Data"	 value="|"/>
				<Arg name="ESCFMT"   value="\\n"/>
			</Exec>	
				
				<While>
				<Exec func="PUB:FetchCursor" error="IGNORE">
					<Arg name="CursorName" value="CURSOR_1"/>
				</Exec>
				<If condition="~RetCod=100">
					<Break/>
				</If>
								
				  <Exec func="PUB:OpenCursor" error="IGNORE">
						<Arg name="sql"  value="QryJnlInfo"/>
						<Arg name="CursorName" value="CURSOR_2"/>
					</Exec>
					<If condition="~RetCod!=0">
					<Set>RspCod=PFA999</Set>
					<Set>RspMsg=打开游标出错</Set>
					<Return/>
				  </If>
			
				<While>
					<Exec func="PUB:FetchCursor" error="IGNORE">
						<Arg name="CursorName" value="CURSOR_2"/>
					</Exec>
					<If condition="~RetCod=100">
						<Break/>
					</If>
								
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql01" />     
					</Exec>
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>	
						
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql02" />         
					</Exec>
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>		
							
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql03" />       
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>	
					
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql04" />    
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
					
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql05" />   
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>	
					
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql06" />    
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>			
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql07" />    
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>		
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql08" />    
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>		
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql09" />    
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>		
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql10" />    
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>		
					<Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql11" />    
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>		
													
          <!--手续费-->
          <Set>sxf1=ADDAMT($YXDSsxf,$CCSsxf)</Set>
          <Set>sxf2=ADDAMT($sxf1,$YDJFsxf)</Set>
          <Set>sxf3=ADDAMT($sxf2,$LTsxf)</Set>
          <Set>sxf4=ADDAMT($sxf3,$DXsxf)</Set>
          <Set>sxf5=ADDAMT($sxf4,$YDsxf)</Set>
          <Set>sxf6=ADDAMT($sxf5,$YTKsxf)</Set>
          <Set>sxf7=ADDAMT($sxf6,$YLTsxf)</Set>
          <Set>sxf8=ADDAMT($sxf7,$YCTsxf)</Set>
          <Set>sxf=ADDAMT($sxf8,$FLCPsxf)</Set>         
          
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="[3]:TlrId="/> 
						<Arg name="Data"	 value="$TlrId"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="NodNo="/> 
						<Arg name="Data"	 value="$NodNo"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YXDSAgtAmt="/> 
						<Arg name="Data"	 value="$YXDSAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YXDScnt="/> 
						<Arg name="Data"	 value="$YXDScnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="CCSAgtAmt="/> 
						<Arg name="Data"	 value="$CCSAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="CCScnt="/> 
						<Arg name="Data"	 value="$CCScnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YDJFAgtAmt="/> 
						<Arg name="Data"	 value="$YDJFAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YDJFcnt="/> 
						<Arg name="Data"	 value="$YDJFcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="LTAgtAmt="/> 
						<Arg name="Data"	 value="$LTAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="LTcnt="/> 
						<Arg name="Data"	 value="$LTcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="DXAgtAmt="/> 
						<Arg name="Data"	 value="$DXAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="DXcnt="/> 
						<Arg name="Data"	 value="$DXcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YDAgtAmt="/> 
						<Arg name="Data"	 value="$YDAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YDcnt="/> 
						<Arg name="Data"	 value="$YDcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YTKAgtAmt="/>  
						<Arg name="Data"	 value="$YTKAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YTKcnt="/> 
						<Arg name="Data"	 value="$YTKcnt"/>
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YLTAgtAmt="/> 
						<Arg name="Data"	 value="$YLTAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YLTcnt="/> 
						<Arg name="Data"	 value="$YLTcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YCTAgtAmt="/> 
						<Arg name="Data"	 value="$YCTAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="YCTcnt="/> 
						<Arg name="Data"	 value="$YCTcnt"/>
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="FLCPAgtAmt="/> 
						<Arg name="Data"	 value="$FLCPAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="FLCPcnt="/> 
						<Arg name="Data"	 value="$FLCPcnt"/> 
						<Arg name="Data"	 value="|"/>						
						<Arg name="Data"	 value="HJAgtAmt="/> <!--合计金额和笔数 -->
						<Arg name="Data"	 value="$HJAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="HJcnt="/> 
						<Arg name="Data"	 value="$HJcnt"/>
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="sxf="/> 
						<Arg name="Data"	 value="$sxf"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>					
					</While>
				  <Set>SYXDSAgtAmt=ADDAMT($SYXDSAgtAmt,$YXDSAgtAmt)</Set>
				  <Set>SYXDScnt=ADD($SYXDScnt,$YXDScnt)</Set>
				  <Set>SCCSAgtAmt=ADDAMT($SCCSAgtAmt,$CCSAgtAmt)</Set>
				  <Set>SCCScnt=ADD($SCCScnt,$CCScnt)</Set>
				  <Set>SYDJFAgtAmt=ADDAMT($SYDJFAgtAmt,$YDJFAgtAmt)</Set>
				  <Set>SYDJFcnt=ADD($SYDJFcnt,$YDJFcnt)</Set>
				  <Set>SLTAgtAmt=ADDAMT($SLTAgtAmt,$LTAgtAmt)</Set>
				  <Set>SLTcnt=ADD($SLTcnt,$LTcnt)</Set>
				  <Set>SDXAgtAmt=ADDAMT($SDXAgtAmt,$DXAgtAmt)</Set>
				  <Set>SDXcnt=ADD($SDXcnt,$DXcnt)</Set>
				  <Set>SYDAgtAmt=ADDAMT($SYDAgtAmt,$YDAgtAmt)</Set>
				  <Set>SYDcnt=ADD($SYDcnt,$YDcnt)</Set>
				  <Set>SYTKAgtAmt=ADDAMT($SYTKAgtAmt,$YTKAgtAmt)</Set>
				  <Set>SYTKcnt=ADD($SYTKcnt,$YTKcnt)</Set>
				  <Set>SYLTAgtAmt=ADDAMT($SYLTAgtAmt,$YLTAgtAmt)</Set>
				  <Set>SYLTcnt=ADD($SYLTcnt,$YLTcnt)</Set>
				  <Set>SYCTAgtAmt=ADDAMT($SYCTAgtAmt,$YCTAgtAmt)</Set>
				  <Set>SYCTcnt=ADD($SYCTcnt,$YCTcnt)</Set>
				  <Set>SFLCPAgtAmt=ADDAMT($FLCPAgtAmt,$FLCPAgtAmt)</Set>
				  <Set>SFLCPcnt=ADD($SFLCPcnt,$FLCPcnt)</Set>
          <Set>Ssxf=ADDAMT($Ssxf,$sxf)</Set>
				  
				  <Exec func="PUB:CloseCursor" error="IGNORE">
					  <Arg name="CursorName" value="CURSOR_2"/>
				  </Exec>
				
      </While>

			<Exec func="PUB:CloseCursor" error="IGNORE">
				<Arg name="CursorName" value="CURSOR_1"/>
			</Exec>
      
			
      <Exec func="PUB:ReadRecord" error="IGNORE">
						<Arg name="SqlCmd" value="Sql12" />
					</Exec>	
					<If condition="~RetCod=-1">
						<Exec func="PUB:RollbackWork" error="IGNORE" />
						<Set>MsgTyp=E</Set>
						<Set>RspCod=PFA999</Set>
						<Set>RspMsg=数据库查询失败</Set>
						<Return/>
					</If>
										
					<Exec func="PUB:WriteFile" error="IGNORE">
						<Arg name="FileName" value="$DatFil"/>
						<Arg name="OpenMode" value="a+"/>
						<Arg name="Data"	 value="[7]:SYXDSAgtAmt="/> 
						<Arg name="Data"	 value="$SYXDSAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYXDScnt="/> 
						<Arg name="Data"	 value="$SYXDScnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SCCSAgtAmt="/> 
						<Arg name="Data"	 value="$SCCSAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SCCScnt="/> 
						<Arg name="Data"	 value="$SCCScnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYDJFAgtAmt="/> 
						<Arg name="Data"	 value="$SYDJFAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYDJFcnt="/> 
						<Arg name="Data"	 value="$SYDJFcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SLTAgtAmt="/> 
						<Arg name="Data"	 value="$SLTAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SLTcnt="/> 
						<Arg name="Data"	 value="$SLTcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SDXAgtAmt="/> 
						<Arg name="Data"	 value="$SDXAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SDXcnt="/> 
						<Arg name="Data"	 value="$SDXcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYDAgtAmt="/> 
						<Arg name="Data"	 value="$SYDAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYDcnt="/> 
						<Arg name="Data"	 value="$SYDcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYTKAgtAmt="/> 
						<Arg name="Data"	 value="$SYTKAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYTKcnt="/> 
						<Arg name="Data"	 value="$SYTKcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYLTAgtAmt="/> 
						<Arg name="Data"	 value="$SYLTAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYLTcnt="/> 
						<Arg name="Data"	 value="$SYLTcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYCTAgtAmt="/> 
						<Arg name="Data"	 value="$SYCTAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SYCTcnt="/> 
						<Arg name="Data"	 value="$SYCTcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SFLCPAgtAmt="/> 
						<Arg name="Data"	 value="$SFLCPAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="SFLCPcnt="/> 
						<Arg name="Data"	 value="$SFLCPcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="HZAgtAmt="/> 
						<Arg name="Data"	 value="$HZAgtAmt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="HZcnt="/> 
						<Arg name="Data"	 value="$HZcnt"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="Data"	 value="Ssxf="/> 
						<Arg name="Data"	 value="$Ssxf"/> 
						<Arg name="Data"	 value="|"/>
						<Arg name="ESCFMT"   value="\\n"/>
					</Exec>
					
			<Exec func="PUB:GenerateReport" desc="根据转换后的文件生成报表">
				<Arg name="ObjFil" value="STRCAT(dat/term/send/,LSHF02,$TlrId,.RPT)"/>
				<Arg name="FmtFil" value="etc/LSHF02_RPT.XML"/>
				<Arg name="DatFil" value="$DatFil"/>
			</Exec>
      
      <Set>NodNo=441800</Set>
			<Exec func="PUB:SendFileMessage2">
				<Arg name="MsgTyp"  value="4"/>
				<Arg name="ObjNod"  value="$NodNo"/>
				<Arg name="BusTyp"  value="09"/>
				<Arg name="AplCod"  value="090012"/>
				<Arg name="FilNam" value="STRCAT(LSHF02,$TlrId,.RPT)"/>
				<Arg name="Summary" value="终端代理收费报表"/>
				<Arg name="ObjTlr"  value="$TlrId"/> 
			</Exec>
			
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功</Set>
		</FlowCtrl>
	</Transaction>

</Application>
