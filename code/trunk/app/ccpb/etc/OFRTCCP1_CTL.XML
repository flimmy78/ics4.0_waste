<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="CCP" code="255" trace="yes">

<!--added by wy 20100208 for ics4.0 start-->
<GlobalFunction>
<Function name="_after">
	<Process>
		<If condition="AND(ISNULL($MsgTyp),IS_NOEQUAL_STRING($RspCod,000000))">
			<Set>MsgTyp=E</Set>
		</If>
		<ElseIf condition="ISNULL($MsgTyp)">
			<Set>MsgTyp=N</Set>
		</ElseIf>
	</Process>
</Function>
</GlobalFunction>
<BusDefDeclare>
	<Busdef name="AplCls"    value="255"/>
	<Busdef name="BrNo"      value="444999"/>	<!--分行号-->
</BusDefDeclare>
<!--added by wy 20100208 for ics4.0 end-->

  <TableDeclare>
	<Table name="ccpshlcod" value="ccpshlcod"/>
	<Table name="ccptxnjnl" value="ccptxnjnl"/>
	<Table name="ccptmptbl" value="ccptmptbl"/>
	<Table name="ccpjnldtl" value="ccpjnldtl"/>
	<Table name="cadjnldtl" value="cadjnldtl"/>
	<Table name="cadfshact" value="cadfshact"/>
  </TableDeclare>
  <ConfigDeclare>
    <!--声明格式文件-->
    <Config name="SRFCSW"      value="etc/SRFA_CSW_444999.XML"/>
    <Config name="BatFormat"      value="etc/CCP_FMT.XML"/>
    <Config name="FtpPutCfg"      value="etc/CCPPUT1.XML"/>     <!--前置发送轧账文件FTP配置-->
  </ConfigDeclare>
  <Define>
    <Macro name="ZHAmtToCap">
      <Set>TotAmt=AMTDELZERO($TxnAmt)</Set>
      <Set>AmtLen=STRLEN($TotAmt)</Set>	
      <Set>LopCnt=0</Set>	
      <Set>CapAmt= </Set>
      <While condition ="$LopCnt&lt;$AmtLen">
        <Set>LopCnt=ADD($LopCnt,1)</Set>
        <Switch expression="SUBSTR($TotAmt,$LopCnt,1)">
           <Case value="0">
             <Set>DitCap=零</Set>
             <Break/>
           </Case>
           <Case value="1">
             <Set>DitCap=壹</Set>
             <Break/>
           </Case>
           <Case value="2">
             <Set>DitCap=贰</Set>
             <Break/>
           </Case>
           <Case value="3">
             <Set>DitCap=叁</Set>
             <Break/>
           </Case>
           <Case value="4">
             <Set>DitCap=肆</Set>
             <Break/>
           </Case>
           <Case value="5">
             <Set>DitCap=伍</Set>
             <Break/>
           </Case>
           <Case value="6">
             <Set>DitCap=陆</Set>
             <Break/>
           </Case>
           <Case value="7">
             <Set>DitCap=柒</Set>
             <Break/>
           </Case>
           <Case value="8">
             <Set>DitCap=捌</Set>
             <Break/>
           </Case>
           <Case value="9">
             <Set>DitCap=玖</Set>
             <Break/>
           </Case>
        </Switch>
        <Set>CapAmt=STRCAT($CapAmt,$DitCap,    )</Set>
      </While>       
      <Set>CapAmt=STRCAT(￥   ,$CapAmt)</Set>
      <!--右填空格使得长度固定-->
      <Set>LopCnt=0</Set>	
      <While condition ="$LopCnt&lt;SUB(7,$AmtLen)">
        <Set>LopCnt=ADD($LopCnt,1)</Set>
        <Set>CapAmt=STRCAT(    ,$CapAmt)</Set>
      </While> 
    </Macro>
    <Macro name="DealAuth">
      <!--添加授权原因 -->
      <Exec func="PUB:AddAuthReason" >
        <Arg name="AthCod" value="30"/>
        <Arg name="AthMsg" value="PB5056"/>
      </Exec>
      <!--授权检查-->
      <Exec  func="PUB:CheckHostAuth">
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
    </Macro>
    <Macro name="Inscadjnldtl">     
      <Set>RcpTyp=5</Set> 
      <Set>CcyCod=CNY</Set>                 
      <Set>CadCcp=2</Set>
      <Set>CrgDpt=$ShlNam</Set>
      <If condition="IS_EQUAL_INT($TxnAt1,0)=0">
        <Set>ItmSqn=1</Set>
        <Set>CrgCod=STRCAT(780,SUBSTR($ShlCod,1,2),01)</Set>
        <Set>CrgItm=学杂费</Set>
        <Set>ItmAmt=$TxnAt1</Set>
        <Exec func="PUB:InsertRecord">	<!-- 插入行政收费明细 -->
          <Arg name="tablename" value="cadjnldtl"/>
        </Exec>
      </If>
      <If condition="IS_EQUAL_INT($TxnAt2,0)=0">
        <Set>ItmSqn=2</Set>
        <Set>CrgCod=STRCAT(780,SUBSTR($ShlCod,1,2),02)</Set>
        <Set>CrgItm=住宿费</Set>
        <Set>ItmAmt=$TxnAt2</Set>
        <Exec func="PUB:InsertRecord">	<!-- 插入行政收费明细 -->
          <Arg name="tablename" value="cadjnldtl"/>
        </Exec>
      </If>  
      <If condition="IS_EQUAL_INT($TxnAt3,0)=0">
        <Set>ItmSqn=3</Set>
        <Set>CrgCod=STRCAT(780,SUBSTR($ShlCod,1,2),03)</Set>
        <Set>CrgItm=实习实验费</Set>
        <Set>ItmAmt=$TxnAt3</Set>
        <Exec func="PUB:InsertRecord">	<!-- 插入行政收费明细 -->
          <Arg name="tablename" value="cadjnldtl"/>
        </Exec>       
      </If>  
      <If condition="IS_EQUAL_INT($TxnAt4,0)=0">
        <Set>ItmSqn=4</Set>
        <Set>CrgCod=STRCAT(780,SUBSTR($ShlCod,1,2),04)</Set>
        <Set>CrgItm=补考费</Set>
        <Set>ItmAmt=$TxnAt4</Set>
        <Exec func="PUB:InsertRecord">	<!-- 插入行政收费明细 -->
          <Arg name="tablename" value="cadjnldtl"/>
        </Exec>
      </If>  
      <If condition="IS_EQUAL_INT($TxnAt5,0)=0">
        <Set>ItmSqn=5</Set>
        <Set>CrgCod=STRCAT(780,SUBSTR($ShlCod,1,2),05)</Set>
        <Set>CrgItm=重修费</Set>
        <Set>ItmAmt=$TxnAt5</Set>
        <Exec func="PUB:InsertRecord">	<!-- 插入行政收费明细 -->
          <Arg name="tablename" value="cadjnldtl"/>
        </Exec>
      </If>  
      <If condition="IS_EQUAL_INT($TxnAt6,0)=0">
        <Set>ItmSqn=6</Set>
        <Set>CrgCod=STRCAT(780,SUBSTR($ShlCod,1,2),06)</Set>
        <Set>CrgItm=其它</Set>
        <Set>ItmAmt=$TxnAt6</Set>
        <Exec func="PUB:InsertRecord">	<!-- 插入行政收费明细 -->
          <Arg name="tablename" value="cadjnldtl"/>
        </Exec>   
      </If>  
    </Macro>
  </Define>

  <!-- 现金缴款记账 -->
  <Transaction code="465501">
    <DynSentence name="IsExist">
      <Sentence>
        SELECT RcpNo FROM ccpjnldtl WHERE RcpNo='%s' and RecSts='1'  and CrgWay in ('0','1')
      </Sentence>
      <Fields>RcpNo|</Fields>
    </DynSentence>
    <DynSentence name="IsFshAct">
      <Sentence>
        SELECT TxnSts from cadfshact WHERE ActDat='%s' and CrgTyp='1' and NodNo='%s'
      </Sentence>
      <Fields>ActDat|NodNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdateSql">
      <Sentence>
        update ccpjnldtl set RecSts='%s',TckNo='%s' where LogNo='%s'
      </Sentence>
      <Fields>RecSts|TckNo|LogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Set>SavNod=$NodNo</Set>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="IsFshAct"/>
      </Exec>
      <If condition="~RetCod=0">
        <If condition="$TxnSts=S">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>  <!-- 当天已结账 -->
          <Set>RspMsg=当天已结账</Set>
          <Return/>
        </If>
        <If condition="$TxnSts=T">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>  <!-- 当天结账超时 -->
          <Set>RspMsg=当天结账超时</Set>
          <Return/>
        </If>
      </If>
      <ElseIf condition ="~RetCod!=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </ElseIf>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="IsExist"/>
      </Exec>
      <If condition="~RetCod=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>    <!--收据编号重复-->
        <Set>RspMsg=此收据编号已缴款</Set>
        <Return/>
      </If>
      <ElseIf condition ="~RetCod!=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </ElseIf>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      
      <If condition="INTCMP($TxnAmt,5,5000000)">
        <Quote name="DealAuth"/>
      </If>

      <Exec func="PUB:GetAppInfo"/>
      <Exec func="PUB:GetAgentAgreement"/><!-- 从单位协议中取得现金的付款账号TActNo -->
      <Set>ActSqn=$TActNo</Set>
      <!--Set>OActBk=@BCFG.BrNo</Set-->
      <Set>OActBk=$BrNo</Set>
      <Set>OActBr=$NodNo</Set>
      <Set>OActSq=00001</Set>
      <Set>CDFlg1=D</Set>
      <Set>CshUse=001</Set>
      <Set>ActSq2=$TActNo</Set>
      <!--Set>ActBk2=@BCFG.BrNo</Set-->
      <Set>ActBk2=$BrNo</Set>
      <Set>ActBr2=$NodNo</Set>
      <Set>PyeAmt=$TxnAmt</Set>
      <Set>CDFlg2=C</Set>

      <Set>CrgWay=0</Set>		<!--0-现金,1-转账,2-主机查询转账,3-划账-->
      <!--Set>HTxnCd=451840</Set-->
      <Set>HTxnCd=451980</Set>
      <Exec func="PUB:GetLogNo" />
      <Exec func="PUB:InsertJournal"/>	<!-- 预记流水 -->

      <Set>RecSts=0</Set>		<!--记录状态-->
      <Exec func="PUB:InsertRecord">	<!-- 预记明细 -->
        <Arg name="tablename" value="ccpjnldtl"/>
      </Exec>	

      <Exec func="PUB:CallHostAcc" error="IGNORE">	<!-- 上主机 -->
        <!--Arg name="TTxnCd" value="451840"/-->
        <Arg name="TTxnCd" value="451980"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>RecSts=T</Set>
        <Set>TckNo= </Set>
      </If>
      <ElseIf condition="~RetCod!=0">
        <Return/>
      </ElseIf>
      <Else>
        <Set>RecSts=1</Set>
      </Else>

      <Set>NodNo=$SavNod</Set>
      <Exec func="PUB:UpdateJournal"/>	<!-- 更新流水 -->
      <If condition="$MsgTyp=N">
         <Set>RecSts=1</Set>
      </If>
      <Exec func="PUB:ExecSql">		<!-- 更新明细表 -->
        <Arg name="SqlCmd" value="UpdateSql"/>
      </Exec>
      <Quote name="Inscadjnldtl"/>	<!-- 插入行政收费明细表 -->

      <Quote name="ZHAmtToCap"/>
    </FlowCtrl>
  </Transaction>

  <!--现金缴款记账嵌套-->
  <Transaction code="465521">
    <DynSentence name="QuerySql">
      <Sentence>
        select ShlNam,ShlGr,SubNam  from ccpshlcod where ShlCod='%s'
      </Sentence>
      <Fields>ShlCod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QuerySql"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <!-- 转账 -->
  <Transaction code="465502">
    <DynSentence name="IsExist">
      <Sentence>
        SELECT RcpNo FROM ccpjnldtl WHERE RcpNo='%s' and RecSts='1'  and CrgWay in ('0','1')
      </Sentence>
      <Fields>RcpNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdateSql">
      <Sentence>
         update ccpjnldtl set RecSts='%s',TckNo='%s' where LogNo='%s' and RecSts='0'
      </Sentence>
      <Fields>RecSts|TckNo|LogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="IsExist"/>
      </Exec>
      <If condition="~RetCod=0">
        <Set>RspCod=465599</Set>    <!--收据编号重复-->
        <Set>RspMsg=此收据编号已缴款</Set>
        <Return/>
      </If>
      <ElseIf condition ="~RetCod!=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </ElseIf>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>

      <If condition="INTCMP($TxnAmt,6,$SpsAmt)">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>        <!--剩余金额不足-->
        <Set>RspMsg=剩余金额不足</Set>
        <Return/>
      </If>

      <Set>RecSts=1</Set>
      <!--Set>CrgWay=1</Set>		<收费方式-->
      <Exec func="PUB:GetLogNo" />	<!--前置流水号-->
      <Exec func="PUB:InsertRecord">	<!-- 插入明细表 -->
        <Arg name="tablename" value="ccpjnldtl"/>
      </Exec>
      <Quote name="Inscadjnldtl"/>	<!-- 插入行政收费明细表 -->

      <Set>SpsAmt=SUBAMT($SpsAmt,$TxnAmt)</Set>
      <Quote name="ZHAmtToCap"/>
    </FlowCtrl>
  </Transaction>

  <!-- 上主机查询 -->
  <Transaction code="465524">
    <DynSentence name="IsExist">
      <Sentence>
        SELECT TxnAmt FROM ccptxnjnl WHERE ActDat='%s' and TckNo='%s' and VchSeq='%s' and CrgWay='2' and TxnSts='S'
      </Sentence>
      <Fields>ActDat|TckNo|VchSeq|</Fields>
    </DynSentence>
    <DynSentence name="QuerySpsAmt">
      <Sentence>
        SELECT COALESCE(SUM(CAST(TxnAmt AS BIGINT)),0) SucAmt FROM ccpjnldtl WHERE TckNo='%s' and VchSeq='%s' and CrgWay='%s' and RecSts='1' and ActDat='%s'
      </Sentence>
      <Fields>TckNo|VchSeq|CrgWay|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="DelSql">
      <Sentence>
        delete from ccptmptbl
      </Sentence>
    </DynSentence>
    <DynSentence name="QueryTmpTbl">
      <Sentence>
        select * from ccptmptbl where VchSeq='%s'
      </Sentence>
      <Fields>VchSeq|</Fields>
    </DynSentence>
    <FlowCtrl> 
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="IsExist"/>
      </Exec>
      <If condition="~RetCod=0">
         <Exec func="PUB:ReadRecord" error="IGNORE">
           <Arg name="sql" value="QuerySpsAmt"/><!--查询已转金额-->
         </Exec>
         <Set>SpsAmt=SUBAMT($TxnAmt,$SucAmt)</Set>
         <Return/>
      </If>
      <ElseIf condition ="~RetCod!=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </ElseIf>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>

      <Set>OTckNo=$TckNo</Set>
      <Set>SrcFil=DELSPACE(STRCAT(CCP,$TckNo,.dat),all)</Set>      
      <Set>ObjFil=STRCAT(O,$SrcFil)</Set>
      <System command="rm" error="IGNORE">
        <Arg name="TmpFil" value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$ObjFil)"/>
      </System>
      
      <Set>BegRec=0</Set>
      <Set>TotRec=0</Set>
      <Set>EndFlg=1</Set>
      <While>
        <Exec func="PUB:CallHostOther" error="IGNORE"><!--上主机系统 -->
          <Arg name="HTxnCd" value="034180" /><!--主机交易码 -->
          <Arg name="ObjSvr" value="SHSTPUB1" /><!--主机目标服务器 -->
        </Exec>
        <If condition="~RetCod!=0">          
          <Return/>
        </If>           
        <Exec func="PUB:DumpFile">
          <Arg name="FileName"    value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$SrcFil)"/>
          <Arg name="ConfigName"  value="BatFormat"/>
          <Arg name="RootName"    value="BATCH"/>
          <Arg name="NodeName"    value="Process"/>
          <Arg name="AttrName"    value="name"/>
          <Arg name="AttrValue"   value="Format1"/>
        </Exec>
        <System command="cat">
          <Arg name="SrcFile" value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$SrcFil)"/>
          <Arg name="cat"     value="&gt;&gt;"/>
          <Arg name="ObjFil"  value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$ObjFil)"/>
        </System>

        <Set>TotRec=ADD($TotRec,$ROOT.RecNum)</Set>
        <If condition="$TotRec &gt; 0">
          <!-- 此交易已经抹账 -->
          <If condition="$ROOT.REC_1.VchSts=Y">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=465599</Set>
            <Set>RspMsg=此交易已经抹账</Set>
            <Return/>
          </If>
        </If>

        <If condition="$EndFlg=0">
            <Break/>
        </If>
        <Set>BegRec=ADD($BegRec,30)</Set>
      </While> 

      <If condition="$TotRec &gt; 0">
        <Exec func="PUB:ExecSql" error="IGNORE">  <!--删除原有表中记录-->
          <Arg name="SqlCmd"   value="DelSql"/>
        </Exec>
        <If condition="~RetCod=-2">
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
        </If>
        <ElseIf condition="~RetCod!=0">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>
          <Set>RspMsg=数据库操作错误</Set>
          <Return/>
        </ElseIf>
        <Exec func="EXT:DeleteGroup">
          <Arg name="GroupName" value="Rec"/>
        </Exec>
        <Set>RecNo=1</Set>
        <Exec func="EXT:ImportToDB">  <!--将文件倒入数据库 -->
          <Arg name="FormatName" value="Format2"/>
          <Arg name="FileName"   value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$ObjFil)"/>
          <Arg name="TableName"  value="ccptmptbl"/>
        </Exec>
        <Exec func="PUB:ReadRecord">
          <Arg name="Sql"  value="QueryTmpTbl"/>
        </Exec>

        <!-- 借贷方不对 -->
        <If condition="$VchSig=D">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>
          <Set>RspMsg=借贷方不正确</Set>
          <Return/>
        </If>
        <!-- 货币代码不对 -->
        <If condition="$CcyCod!=CNY">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>
          <Set>RspMsg=货币代码不正确</Set>
          <Return/>
        </If>

        <!-- 账号不对 -->
        <Exec func="PUB:GetAppInfo"/>
        <Exec func="PUB:GetAgentAgreement"/><!-- 从单位协议中取得现金的付款账号TActNo -->
        <Set>PyeAct1=DELBOTHSPACE($TActNo2)</Set>
        <Set>PyeAct2=DELBOTHSPACE($TActNo3)</Set>
        <Set>QryAct=DELBOTHSPACE($ActNo)</Set>

        <If condition="AND(IS_NOEQUAL_STRING($QryAct,$PyeAct1),IS_NOEQUAL_STRING($QryAct,$PyeAct2))">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>
          <Set>RspMsg=入账账号不正确</Set>
          <Return/>
        </If>
      </If>

      <Exec func="PUB:GetLogNo" />
      <Set>CrgWay=2</Set>		<!--0-现金,1-转账,2-主机查询转账,3-划账-->
      <Set>TckNo=$OTckNo</Set>		<!--原会计流水-->
      <Exec func="PUB:InsertJournal"/>	<!-- 插入流水 -->
      <Exec func="PUB:ReadRecord">
        <Arg name="sql" value="QuerySpsAmt"/><!--查询已转金额-->
      </Exec>
      <Set>SpsAmt=SUBAMT($TxnAmt,$SucAmt)</Set>
    </FlowCtrl>
  </Transaction>

  <!-- 打印流水清单和渠道汇总 -->
  <Transaction code="465504">
    <DynSentence name="selsql">
      <Sentence>
         select * from ccpjnldtl where NodNo='%s' and ActDat='%s' and RecSts='1'  and CrgWay in ('0','1') order by ShlCod
      </Sentence>
      <Fields>QNodNo|QryDat|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>
      
      <!-- 打印大中专流水清单 -->      
      <If condition="$PrtFlg=1">
        <Set>RptFil=DELSPACE(STRCAT(CCPRllAct,$ActDat,1.rpt),all)</Set>
        <Exec  func="EXT:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(dat/term/send/,$RptFil)"/>
          <Arg name="FmtFil" value="STRCAT(etc/,CCP001_RPT.XML)"/>
        </Exec>
        <Exec  func="EXT:SendFileMessage2">
          <Arg name="MsgTyp"     value="4"/>
          <Arg name="ObjNod"     value="$NodNo"/>
          <Arg name="BusTyp"     value="46"/>
          <Arg name="AplCod"     value="5504"/>
          <Arg name="FilNam"     value="$RptFil"/>
          <Arg name="Summary"    value="大中专收费流水表"/>
          <Arg name="ObjTlr"     value="$TlrId"/>
        </Exec>
      </If>   
            
     <!-- 打印大中专各渠道单个网点汇总 -->    
      <ElseIf condition="$PrtFlg=2">       
        <Set>RptFil2=DELSPACE(STRCAT(CCPTxnCnl,$ActDat,2.rpt),all)</Set>
        <Exec  func="EXT:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(dat/term/send/,$RptFil2)"/>
          <Arg name="FmtFil" value="STRCAT(etc/,CCP002_RPT_444999.XML)"/>
        </Exec>
        <Exec  func="EXT:SendFileMessage2">
          <Arg name="MsgTyp"     value="4"/>
          <Arg name="ObjNod"     value="$NodNo"/>
          <Arg name="BusTyp"     value="46"/>
          <Arg name="AplCod"     value="5504"/>
          <Arg name="FilNam"     value="$RptFil2"/>
          <Arg name="Summary"    value="大中专缴费各渠道汇总单"/>
          <Arg name="ObjTlr"     value="$TlrId"/>
        </Exec> 
      </ElseIf>          
      
      <!--如果是业务主办支行444006，则打印大中专各渠道全行汇总-->
      <ElseIf condition="$PrtFlg=3">
      	 <If condition="$NodNo=444006">
           <Set>RptFil3=DELSPACE(STRCAT(CCPTxnCnl,$ActDat,3.rpt),all)</Set>
           <Exec  func="EXT:GenerateReport">
             <Arg name="ObjFil" value="STRCAT(dat/term/send/,$RptFil3)"/>
             <Arg name="FmtFil" value="STRCAT(etc/,CCP003_RPT_444999.XML)"/>
           </Exec>
           <Exec  func="EXT:SendFileMessage2">
             <Arg name="MsgTyp"     value="4"/>
             <Arg name="ObjNod"     value="$NodNo"/>
             <Arg name="BusTyp"     value="46"/>
             <Arg name="AplCod"     value="5504"/>
             <Arg name="FilNam"     value="$RptFil3"/>
             <Arg name="Summary"    value="大中专缴费各渠道全行汇总单"/>
             <Arg name="ObjTlr"     value="$TlrId"/>
           </Exec> 
         </If> 
         <Else>
           <Set>RspCod=465599</Set>
           <Set>RspMsg=全行汇总单仅供主办行打印</Set>
           <Return/>
         </Else>
      </ElseIf>  
      <Else>
         <Set>RspCod=465599</Set>
         <Set>RspMsg=报表类型选择错误</Set>
         <Return/>
      </Else>
    </FlowCtrl>
  </Transaction>

  <!--大中专收费流水查询-->
  <Transaction code="465505">
    <DynSentence name="MultiQuery">
      <Sentence>
        Select ActDat QryDat,TckNo,VchSeq,RcpTyp,RcpNo,CusNam,ShlCod,ShlNam,ShlGr,SubNam, TxnAt1,TxnAt2,TxnAt3,TxnAt4,TxnAt5,TxnAt6,TxnAmt,RecSts,CrgWay
        from ccpjnldtl
        where (ActDat='%s' or '%s'='00000000') and (NodNo='%s' or '%s'='000000') and (TlrId='%s' or '%s'='       ') and (TckNo='%s' or '%s'='           ') and (ShlCod like '%s%%' or '%s'='          ') and (TxnAmt='%s' or '%s'='000000000000000') and (RcpNo='%s' or '%s'='               ') and (CusNam='%s' or '%s'='                                                            ') and (RecSts='%s' or '%s'=' ') and CrgWay in ('0','1') order by TckNo
      </Sentence>
      <Fields>QActDat|QActDat|QNodNo|QNodNo|QTlrId|QTlrId|QTckNo|QTckNo|QShlCod1|QShlCod|QTxnAmt|QTxnAmt|QRcpNo|QRcpNo|QCusNam|QCusNam|QRecSts|QRecSts|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Set>QShlCod1=DELBOTHSPACE($QShlCod)</Set>
      <Exec func="PUB:MultiQuery" >
        <Arg name="SqlCmd" value="MultiQuery" />
      </Exec>
    </FlowCtrl>
  </Transaction>

  <!--学校班级代码增加-->
  <Transaction code="465506">
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:InsertRecord" error="IGNORE">
        <Arg name="TblNam" value="ccpshlcod"/>
      </Exec>
      <If condition="$SqlCod=-803">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=该学校班级编码已存在</Set>
      </If>
      <ElseIf condition="~RetCod!=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=数据库操作错误</Set>
      </ElseIf>
    </FlowCtrl>
  </Transaction>

  <!--学校名称查询-->
  <Transaction code="465563">
    <DynSentence name="QuerySql">
      <Sentence>
        select ShlNam from ccpshlcod where ShlCod like '%s%%'
      </Sentence>
      <Fields>ShlCod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QuerySql"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <!--学校班级代码修改-->
  <Transaction code="465507">
    <DynSentence name="UpdateSql1">
      <Sentence>
        update ccpshlcod set ShlNam='%s',ShlGr='%s',SubNam='%s' where ShlCod='%s'
       </Sentence>
       <Fields>ShlNam|ShlGr|SubNam|ShlCod|</Fields>
    </DynSentence>
    <DynSentence name="UpdateSql2">
      <Sentence>
        update ccpshlcod set ShlNam='%s' where ShlCod like '%s%%'
      </Sentence>
      <Fields>ShlNam|ShlCod1|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:ExecSql">
        <Arg name="SqlCmd" value="UpdateSql1"/>
      </Exec>
      <Set>ShlCod1=SUBSTR($ShlCod,1,2)</Set>
      <Exec func="PUB:ExecSql">
        <Arg name="SqlCmd" value="UpdateSql2"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <!-- 多页查询学校班级代码信息 -->
  <Transaction code="465508" >
    <DynSentence name="MultiQuery">
      <Sentence>
        select * from ccpshlcod where ShlCod like '%s%%' or '%s'='       ' order by ShlCod
      </Sentence>
      <Fields>ShlCod1|ShlCod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

       <Set>ShlCod1=DELBOTHSPACE($ShlCod)</Set>
       <Exec func="PUB:MultiQuery">
        <Arg name="SqlCmd" value="MultiQuery"/>
      </Exec>
    </FlowCtrl>
  </Transaction>
  
  <!--学校班级代码删除-->
  <Transaction code="465510">
    <DynSentence name="SqlDelete">
      <Sentence>
        delete from ccpshlcod where ShlCod='%s'
      </Sentence>
      <Fields>ShlCod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:ExecSql">
        <Arg name="SqlCmd" value="SqlDelete"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <!-- 现金缴费抹账  -->
  <Transaction code="465509">
    <DynSentence name="IsFshAct">
      <Sentence>
        SELECT TxnSts from cadfshact WHERE ActDat='%s' and CrgTyp='1' and NodNo='%s'
      </Sentence>
      <Fields>ActDat|NodNo|</Fields>
    </DynSentence>
    <DynSentence name="QuerySql">
      <Sentence>
        Select HTxnSt OHTxnSt,TTxnSt,TxnSts,HTxnCd OHTxnCd,TxnCnl OTxnCnl,TlrId QTlrId from ccptxnjnl where LogNo='%s'
      </Sentence>
      <Fields>OLogNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdSql1">
      <Sentence>
        update ccptxnjnl set HTxnSt='%s',TxnSts='%s' where LogNo='%s'
      </Sentence>
      <Fields>HTxnSt|TxnSts|OLogNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdSql2">
      <Sentence>
         update %s set RecSts='%s', TckNo='%s' where LogNo='%s' and ActDat='%s'
      </Sentence>
      <Fields>TblNam|RecSts|OTckNo|OLogNo|ActDat|</Fields>
    </DynSentence>
    <FlowCtrl>      
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Set>LogNo=$OLogNo</Set>

      <Exec func="PUB:ReadRecord" >
        <Arg name="sql" value="QuerySql"/>
      </Exec>
      <If condition="$TxnSts=C">
        <Set>RspCod=465599</Set>
        <Set>RspMsg=本交易已抹账</Set>
        <Return/>
      </If>
			<!--原交易渠道判断-->
			<If condition="$OTxnCnl!=TRM">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=465599</Set>
				<Set>RspMsg=原交易非柜台交易,不能用该交易退费</Set>
				<Return/>
			</If>
      <If condition="IS_EQUAL_STRING($QTlrId,$TlrId)=0">
        <Set>RspCod=465599</Set>
        <Set>RspMsg=只能用原交易柜员抹账</Set>
        <Return/>
      </If>


      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="IsFshAct"/>
      </Exec>
      <If condition="~RetCod=0">
        <If condition="$TxnSts=S">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>  <!-- 当天已结账 -->
          <Set>RspMsg=当天已结账</Set>
          <Return/>
        </If>
        <ElseIf condition="$TxnSts=T">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>  <!-- 当天结账超时 -->
          <Set>RspMsg=当天结账超时</Set>
          <Return/>
        </ElseIf>
      </If>
      <ElseIf condition="~RetCod!=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=数据库系统故障 </Set>
        <Return/>
      </ElseIf>

      <Set>OTTxnCd=465501</Set>

      <Set>HTxnCd=STRCAT(SUBSTR($OHTxnCd,1,5),9)</Set>
      <Switch expression="$OHTxnSt">
        <Case value="U"/>
        <Case value="S"/>
        <Case value="T">
          <Set>TIATyp=C</Set>
          <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="TTxnCd" value="959999"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="~RetCod=0">    <!--抹账成功-->
            <Set>HTxnSt=C</Set>
            <Set>TxnSts=C</Set>
            <Set>RecSts=C</Set>
          </If>
          <ElseIf condition="~RetCod=-1">    <!--抹账超时-->
            <Set>HTxnSt=T</Set>
            <Set>TxnSts=T</Set>
            <Set>RecSts=T</Set>
          </ElseIf>
          <Else>
            <Switch expression="$HRspCd">
              <Case value="AG8001"/>      <!--该前置流水号不存在-->
              <Case value="AG8981"/>      <!--该前置流水号不存在-->
              <Case value="SC6129">       <!--原交易不存在-->
                <Set>MsgTyp=N</Set>
                <Set>RspCod=000000</Set>
                <Set>HTxnSt=F</Set>
                <Set>TxnSts=F</Set>
                <Set>RecSts=0</Set>
                <Break/>
              </Case>
              <Case value="SC6034">       <!--原交易已经被抹-->
                <Set>MsgTyp=N</Set>
                <Set>RspCod=000000</Set>
                <Set>HTxnSt=C</Set>
                <Set>TxnSts=C</Set>
                <Set>RecSts=C</Set>
                <Break/>
              </Case>
              <Default>
                <Return/>
              </Default>
            </Switch>
          </Else>
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdSql1"/>
          </Exec>
          <Set>TblNam=ccpjnldtl</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="sql" value="UpdSql2"/>
          </Exec>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
          </If>
          <ElseIf condition ="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=465599</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
          </ElseIf>
          <Set>TblNam=cadjnldtl</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="sql" value="UpdSql2"/>
          </Exec>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
          </If>
          <ElseIf condition ="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=465599</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
          </ElseIf>
          <Break/>
        </Case>
        <Default>
          <Set>RspCod=465599</Set>
          <Set>RspMsg=原交易未成功，不需抹账</Set>
          <Return/>
        </Default>
      </Switch>
    </FlowCtrl>
  </Transaction>

  <!--抹账明细嵌套-->
  <Transaction code="465523">
    <DynSentence name="QuerySql">
      <!--Sentence>
         select TlrId QTlrId, LogNo OLogNo, HTxnSt, TxnSts,TxnAmt from ccptxnjnl where ActDat='%s' and TckNo='%s' and HTxnSt='S' and CrgWay='0'
      </Sentence-->
      <Sentence>
         select TlrId QTlrId, LogNo OLogNo, HTxnSt, TxnSts,TxnAmt from ccptxnjnl where ActDat='%s' and TckNo='%s' and CrgWay in ('0','1')
      </Sentence>
      <Fields>ActDat|OTckNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdateSql">   <!--同步主机流水信息-->
      <Sentence>
        update ccptxnjnl set TckNo='%s',HLogNo='%s' WHERE LogNo='%s'
      </Sentence>
      <Fields>OTckNo|OHLogNo|OLogNo|</Fields>
    </DynSentence>
    <DynSentence name="SqlString1">   <!--查询流水信息-->
      <Sentence>
         select TlrId QTlrId, LogNo OLogNo, HTxnSt, TxnAmt from ccptxnjnl where LogNo='%s' and CrgWay in ('0','1')
      </Sentence>
      <Fields>OLogNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdSql1">
      <Sentence>
        update ccptxnjnl set HTxnSt='C',TxnSts='C' where LogNo='%s'
      </Sentence>
      <Fields>OLogNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdSql2">
      <Sentence>
         update ccpjnldtl set RecSts='C', TckNo='%s' where LogNo='%s' and ActDat='%s'
      </Sentence>
      <Fields>OTckNo|OLogNo|ActDat|</Fields>
    </DynSentence>
    <DynSentence name="SqlReadDtl">
      <Sentence>
        select CusNam,ShlCod,ShlNam,ShlGr,SubNam,TxnAt1,TxnAt2,TxnAt3,TxnAt4,TxnAt5,TxnAt6 from ccpjnldtl where LogNo='%s' and RecSts='1' and CrgWay in ('0','1')
      </Sentence>
      <Fields>OLogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QuerySql" />
      </Exec>
      <If condition="~RetCod=0">
      	<!--
        <If condition="IS_EQUAL_STRING($QTlrId,$TlrId)=0">
          <Set>RspCod=465599</Set>
          <Set>RspMsg=只能用原交易柜员抹账</Set>
          <Return/>
        </If>
        -->
        <If condition="$TxnSts=C">
          <Set>RspCod=465599</Set>
          <Set>RspMsg=本交易已抹账</Set>
        <Return/>
      </If>
        <Goto>QueryInf</Goto>
      </If>
      <ElseIf condition="~RetCod!=-2">
        <Return/>
      </ElseIf>
      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="458970" />
        <Arg name="ObjSvr" value="SHSTPUB1" />
      </Exec>
      <If condition="$MsgTyp!=N">
        <Return/>
      </If>
      <Exec func="PUB:ExecSql">
        <Arg name="sql" value="UpdateSql"/>
      </Exec>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="SqlString1" />
      </Exec>
      <If condition="$CrcSts=Y">
        <Exec func="PUB:ExecSql">
          <Arg name="sql" value="UpdSql1"/>
        </Exec>
        <Exec func="PUB:ExecSql">
          <Arg name="sql" value="UpdSql2"/>
        </Exec>

        <Set>RspCod=465599</Set>
        <Set>RspMsg=该笔会计流水主机已抹账</Set>
      </If>

      <Label>QueryInf</Label>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="SqlReadDtl"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <!--转账交易抹账查询-->
  <Transaction code="465519">
    <DynSentence name="MultiQuery">
      <Sentence>
        select LogNo,TckNo,VchSeq,RcpTyp,RcpNo,CusNam,ShlCod,ShlNam,ShlGr,SubNam,TxnAt1,TxnAt2,TxnAt3,TxnAt4,TxnAt5,TxnAt6,TxnAmt
        from ccpjnldtl where ActDat='%s' and TckNo='%s' AND TlrId='%s' and RecSts='1' and (RcpNo='%s' or '%s'='                ') and CrgWay in ('0','1')
      </Sentence>
      <Fields>ActDat|TckNo|TlrId|RcpNo|RcpNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:MultiQuery" >
        <Arg name="SqlCmd" value="MultiQuery" />
      </Exec>
    </FlowCtrl>
  </Transaction>

  <!--转账交易抹账-->
  <Transaction code="465551">
    <DynSentence name="UpdateSql">
      <Sentence>
        update ccpjnldtl set RecSts='C' where ActDat='%s' and TckNo='%s' and TlrId='%s' and RecSts='1' and  (RcpNo='%s' or '%s'='               ') and CrgWay in ('0','1')
      </Sentence>
      <Fields>ActDat|TckNo|TlrId|RcpNo|RcpNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdateCadSql">
      <Sentence>
        update cadjnldtl set RecSts='C' where ActDat='%s' and TckNo='%s' and TlrId='%s' and RecSts='1' and CadCcp='2' and  (RcpNo='%s' or '%s'='               ') and CrgWay in ('0','1')
      </Sentence>
      <Fields>ActDat|TckNo|TlrId|RcpNo|RcpNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:ExecSql"><!--   全部更新-->
        <Arg name="SqlCmd" value="UpdateSql"/>
      </Exec>
      <Exec func="PUB:ExecSql"><!--更新行政收费明细表-->
        <Arg name="sql" value="UpdateCadSql"/>
      </Exec>
    </FlowCtrl>
  </Transaction>


  <!-- 为自助通渠道添加，卡缴款记账 -->
  <Transaction code="465531">
    <DynSentence name="IsExist">
      <Sentence>
        SELECT RcpNo FROM ccpjnldtl WHERE RcpNo='%s' and RecSts='1'  and CrgWay in ('0','1')
      </Sentence>
      <Fields>RcpNo|</Fields>
    </DynSentence>
    <DynSentence name="IsFshAct">
      <Sentence>
        SELECT TxnSts from cadfshact WHERE ActDat='%s' and CrgTyp='1' and NodNo='%s'
      </Sentence>
      <Fields>ActDat|NodNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdateSql">
      <Sentence>
        update ccpjnldtl set RecSts='%s',TckNo='%s' where LogNo='%s'
      </Sentence>
      <Fields>RecSts|TckNo|LogNo|</Fields>
    </DynSentence>
		<!--add for 自助通-->
		<DynSentence name="ChkCAgtNo">
			<Sentence>
				SELECT TActNo,BBusTyp
				FROM savcrpagr
				WHERE CAgtNo='%s'
				AND SvrSts='1'
			</Sentence>
			<Fields>CAgtNo|</Fields>
		</DynSentence>
    <FlowCtrl>
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

	<!--add for 自助通开始-->
      <!--判断单位编号是否存在-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="ChkCAgtNo"/>
      </Exec>
      <If condition="~RetCod=0">
          <Set>Mask=STRCAT(9,$BBusTyp)</Set>
      </If>
      <ElseIf condition="~RetCod=-2">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>
          <Set>RspMsg=单位协议不存在或无效</Set>
          <Return/>
      </ElseIf>
      <Else>
          <Return/>
      </Else>
	<!--add for 自助通结束-->

	<!--add for 自助通开始-->
	<!--判断总金额与明细金额核对是否相符-->
	<Set>TmpAmt1=0</Set>
	<Set>TmpAmt2=0</Set>
	<Set>TmpAmt1=ADD($TmpAmt1,$TxnAt1)</Set>
	<Set>TmpAmt1=ADD($TmpAmt1,$TxnAt2)</Set>
	<Set>TmpAmt1=ADD($TmpAmt1,$TxnAt3)</Set>
	<Set>TmpAmt1=ADD($TmpAmt1,$TxnAt4)</Set>
	<Set>TmpAmt1=ADD($TmpAmt1,$TxnAt5)</Set>
	<Set>TmpAmt1=ADD($TmpAmt1,$TxnAt6)</Set>
	<Set>TmpAmt2=ADD(0,$TxnAmt)</Set>
	<If condition="NOT(IS_EQUAL_INT($TmpAmt1,$TmpAmt2))">
		<Set>MsgTyp=E</Set>
		<Set>RspCod=465599</Set>
		<Set>RspMsg=总金额与明细金额核对不符</Set>
		<Return/>
	</If>
	<!--add for 自助通结束-->


      <Set>SavNod=$NodNo</Set>
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="IsFshAct"/>
      </Exec>
      <If condition="~RetCod=0">
        <If condition="$TxnSts=S">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>  <!-- 当天已结账 -->
          <Set>RspMsg=当天已结账</Set>
          <Return/>
        </If>
        <If condition="$TxnSts=T">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>  <!-- 当天结账超时 -->
          <Set>RspMsg=当天结账超时</Set>
          <Return/>
        </If>
      </If>
      <ElseIf condition ="~RetCod!=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </ElseIf>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="IsExist"/>
      </Exec>
      <If condition="~RetCod=0">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>    <!--收据编号重复-->
        <Set>RspMsg=此收据编号已缴款</Set>
        <Return/>
      </If>
      <ElseIf condition ="~RetCod!=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=数据库操作错误</Set>
        <Return/>
      </ElseIf>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      
      <If condition="INTCMP($TxnAmt,5,5000000)">
        <Quote name="DealAuth"/>
      </If>


      <Exec func="PUB:GetAppInfo"/>
      <!--Exec func="PUB:GetAgentAgreement"/-->	<!-- 从单位协议中取得现金的付款账号TActNo，从自助通发起交易时应该用不到，所以屏蔽之 -->
      <Set>ActSqn=$TActNo</Set>
      <!--Set>OActBk=@BCFG.BrNo</Set-->
      <Set>OActBk=$BrNo</Set>
      <Set>OActBr=$NodNo</Set>
      <Set>OActSq=00001</Set>
      <Set>CDFlg1=D</Set>
      <Set>CshUse=001</Set>
      <Set>ActSq2=$TActNo</Set>
      <!--Set>ActBk2=@BCFG.BrNo</Set-->
      <Set>ActBk2=$BrNo</Set>
      <Set>ActBr2=$NodNo</Set>
      <Set>PyeAmt=$TxnAmt</Set>
      <Set>CDFlg2=C</Set>
      <Set>CrgWay=1</Set>		<!--收费方式--><!--0-现金,1-转账,2-主机查询转账,3-划账-->


      <!--add for 自助通卡缴费开始-->
      <Set>HTxnCd=471140</Set>
      <Set>ActFlg=4</Set>	<!--交易方式(0－现金，1－一本通，2－普通存折，4－卡，5－支票)-->
      <!--add for 自助通卡缴费结束-->

      <Exec func="PUB:GetLogNo" />
      <Exec func="PUB:InsertJournal"/>	<!-- 预记流水 -->

      <Set>RecSts=0</Set>		<!--记录状态-->
      <Exec func="PUB:InsertRecord">	<!-- 预记明细 -->
        <Arg name="tablename" value="ccpjnldtl"/>
      </Exec>	

      <Exec func="PUB:CallHostAcc" error="IGNORE">	<!-- 上主机 -->
        <!--Arg name="TTxnCd" value="451840"/-->
        <!--Arg name="TTxnCd" value="451980"/-->	<!-- 原现金收费主机接口 -->
        <Arg name="TTxnCd" value="471140"/>		<!-- 自助通卡缴费用接口 -->
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      
      <If condition="~RetCod=-1">
        <Set>RecSts=T</Set>
        <Set>TckNo= </Set>
      </If>
      <ElseIf condition="~RetCod!=0">
        <Return/>
      </ElseIf>
      <Else>
        <Set>RecSts=1</Set>
      </Else>

      <Set>NodNo=$SavNod</Set>
      <Exec func="PUB:UpdateJournal"/>	<!-- 更新流水 -->
      <If condition="$MsgTyp=N">
         <Set>RecSts=1</Set>
      </If>
      <Exec func="PUB:ExecSql">		<!-- 更新明细表 -->
        <Arg name="SqlCmd" value="UpdateSql"/>
      </Exec>
      <Quote name="Inscadjnldtl"/>	<!-- 插入行政收费明细表 -->

      <Quote name="ZHAmtToCap"/>
    </FlowCtrl>
  </Transaction>

	<Transaction code="465532" desc="大中专自助缴费收据打印">
		<!--本交易仅打印网银和自助通办理的大中专缴费收据-->
		<DynSentence name="GetTxnJnl">
			<Sentence>
				SELECT ActDat OActDat,ShlCod,ShlNam,ShlGr,SubNam,CusNam,TxnAt1,TxnAt2,TxnAt3,TxnAt4,TxnAt5,TxnAt6,TxnAmt,LogNo OLogNo,NodNo ONodNo,TlrId OTlrId,TckNo OTckNo
				FROM ccpjnldtl 
				WHERE cast(ActDat AS BIGINT)&gt;=cast('%s' AS BIGINT)
				AND cast(ActDat AS BIGINT)&lt;=cast('%s' AS BIGINT)
				AND (ShlCod='%s' OR '%s'='')
				AND (CusNam='%s' OR '%s'='')
				AND RecSts='1'
				AND TlrId NOT like '444%%'
				FETCH FIRST 1 ROWS ONLY
			</Sentence>
			<Fields>StaDat|EndDat|OShlCod|OShlCod|OCusNam|OCusNam|</Fields>
		</DynSentence>
		<DynSentence name="QryTxnJnl">
			<Sentence>
				SELECT ActDat OActDat,ShlCod,ShlNam,ShlGr,SubNam,CusNam,TxnAt1,TxnAt2,TxnAt3,TxnAt4,TxnAt5,TxnAt6,TxnAmt,LogNo OLogNo,NodNo ONodNo,TlrId OTlrId,TckNo OTckNo
				FROM ccpjnldtl 
				WHERE cast(ActDat AS BIGINT)&gt;=cast('%s' AS BIGINT)
				AND cast(ActDat AS BIGINT)&lt;=cast('%s' AS BIGINT)
				AND (ShlCod='%s' OR '%s'='')
				AND (CusNam='%s' OR '%s'='')
				AND RecSts='1'
				AND TlrId NOT like '444%%'
				order by ShlCod
			</Sentence>
			<Fields>StaDat|EndDat|OShlCod|OShlCod|OCusNam|OCusNam|</Fields>
		</DynSentence>
		<FlowCtrl>
			<Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
			<Exec func="PUB:InitTransaction"/>
			<Exec func="PUB:GetAppInfo"/>

			<If condition="ISNULL($StaDat)">
				<Set>StaDat=00000000</Set>
			</If>

			<If condition="ISNULL($EndDat)">
				<Set>EndDat=99999999</Set>
			</If>

				<Set>FilNam=DELSPACE(STRCAT(批量收据打印_,$StaDat,_,$EndDat,_,$TlrId),all)</Set>

				<System command="" error="IGNORE">
					<Arg name="ObjFil" value="STRCAT(&gt;,GETENV(WORKDIR),/dat/ccp/,$FilNam)"/>
				</System>

				<Exec func="PUB:OpenCursor">
					<Arg name="SqlCmd" value="QryTxnJnl"/>
				</Exec>

				<Set>@BAS.pcnt=0</Set>   <!--打印凭证数-->

				<While>
					<Exec func="PUB:FetchCursor" error="IGNORE"/>
					<If condition="~RetCod=100">
						<Break/>
					</If>
					<ElseIf condition="~RetCod=-1">
						<Exec func="PUB:DeleteDiskNo"/>
						<Set>RspCod=478399</Set>
						<Set>RspMsg=数据库操作错误</Set>
						<Return/>
					</ElseIf>

					<Set>Tmp1=(</Set>
					<Set>Tmp2=)</Set>
					<Set>TmpTxnAmt=ADDCHAR(AMTDELZERO($TxnAmt),7,X,1)</Set>
					<Set>TmpTxnAmt1=SUBSTR($TmpTxnAmt,1,1)</Set>
					<Set>TmpTxnAmt2=SUBSTR($TmpTxnAmt,2,1)</Set>
					<Set>TmpTxnAmt3=SUBSTR($TmpTxnAmt,3,1)</Set>
					<Set>TmpTxnAmt4=SUBSTR($TmpTxnAmt,4,1)</Set>
					<Set>TmpTxnAmt5=SUBSTR($TmpTxnAmt,5,1)</Set>
					<Set>TmpTxnAmt6=SUBSTR($TmpTxnAmt,6,1)</Set>
					<Set>TmpTxnAmt7=SUBSTR($TmpTxnAmt,7,1)</Set>

					<Set>DitCap=$TmpTxnAmt1</Set>
					<Exec func="PUB:CodeSwitching">
						<Arg name="DatSrc"  value="SRFCSW"/>
						<Arg name="SourNam" value="DitCap"/>
						<Arg name="DestNam" value="Des"/>
						<Arg name="TblNam"  value="DitCap"/>
					</Exec>
					<Set>Des1=$Des</Set>

					<Set>DitCap=$TmpTxnAmt2</Set>
					<Exec func="PUB:CodeSwitching">
						<Arg name="DatSrc"  value="SRFCSW"/>
						<Arg name="SourNam" value="DitCap"/>
						<Arg name="DestNam" value="Des"/>
						<Arg name="TblNam"  value="DitCap"/>
					</Exec>
					<Set>Des2=$Des</Set>

					<Set>DitCap=$TmpTxnAmt3</Set>
					<Exec func="PUB:CodeSwitching">
						<Arg name="DatSrc"  value="SRFCSW"/>
						<Arg name="SourNam" value="DitCap"/>
						<Arg name="DestNam" value="Des"/>
						<Arg name="TblNam"  value="DitCap"/>
					</Exec>
					<Set>Des3=$Des</Set>

					<Set>DitCap=$TmpTxnAmt4</Set>
					<Exec func="PUB:CodeSwitching">
						<Arg name="DatSrc"  value="SRFCSW"/>
						<Arg name="SourNam" value="DitCap"/>
						<Arg name="DestNam" value="Des"/>
						<Arg name="TblNam"  value="DitCap"/>
					</Exec>
					<Set>Des4=$Des</Set>

					<Set>DitCap=$TmpTxnAmt5</Set>
					<Exec func="PUB:CodeSwitching">
						<Arg name="DatSrc"  value="SRFCSW"/>
						<Arg name="SourNam" value="DitCap"/>
						<Arg name="DestNam" value="Des"/>
						<Arg name="TblNam"  value="DitCap"/>
					</Exec>
					<Set>Des5=$Des</Set>

					<Set>DitCap=$TmpTxnAmt6</Set>
					<Exec func="PUB:CodeSwitching">
						<Arg name="DatSrc"  value="SRFCSW"/>
						<Arg name="SourNam" value="DitCap"/>
						<Arg name="DestNam" value="Des"/>
						<Arg name="TblNam"  value="DitCap"/>
					</Exec>
					<Set>Des6=$Des</Set>

					<Set>DitCap=$TmpTxnAmt7</Set>
					<Exec func="PUB:CodeSwitching">
						<Arg name="DatSrc"  value="SRFCSW"/>
						<Arg name="SourNam" value="DitCap"/>
						<Arg name="DestNam" value="Des"/>
						<Arg name="TblNam"  value="DitCap"/>
					</Exec>
					<Set>Des7=$Des</Set>

					<Set>FilConA=STRCAT(SPACE(2),ADDCHAR($CusNam,20, ,0),\\n,SPACE(2),ADDCHAR($SubNam,20, ,0),SPACE(22),SUBSTR($OActDat,1,4),SPACE(6),SUBSTR($OActDat,5,2),SPACE(6),SUBSTR($OActDat,7,2),\\n,\\n,\\n)</Set>

					<Set>FilConB=STRCAT(SPACE(50),ADDCHAR(AMTSIMPLEFMT($TxnAt1),10, ,1),\\n,\\n,SPACE(50),ADDCHAR(AMTSIMPLEFMT($TxnAt2),10, ,1),\\n,SPACE(50),ADDCHAR(AMTSIMPLEFMT($TxnAt3),10, ,1))</Set>

					<Set>FilConC=STRCAT(SPACE(50),ADDCHAR(AMTSIMPLEFMT($TxnAt4),10, ,1),\\n,\\n,SPACE(50),ADDCHAR(AMTSIMPLEFMT($TxnAt5),10, ,1),\\n,\\n,SPACE(25),其它,SPACE(21),ADDCHAR(AMTSIMPLEFMT($TxnAt6),10, ,1),\\n)</Set>

		      <Set>FilConD=STRCAT(SPACE(20),年级,$Tmp1,ADDCHAR($ShlGr,2, ,0),$Tmp2,SPACE(10),学校,$Tmp1,ADDCHAR($ShlNam,20, ,0),$Tmp2,\\n)</Set>

					<Set>FilConE=STRCAT(SPACE(14),ADDCHAR($Des1,6, ,0),ADDCHAR($Des2,6, ,0),ADDCHAR($Des3,6, ,0),ADDCHAR($Des4,6, ,0),ADDCHAR($Des5,6, ,0),ADDCHAR($Des6,6, ,0),ADDCHAR($Des7,6, ,0),ADDCHAR(AMTSIMPLEFMT($TxnAmt),10, ,1),\\n)</Set>

					<Set>FilConF=STRCAT(SPACE(4),$ONodNo,SPACE(6),$OTlrId,SPACE(12),$OTckNo,SPACE(6),$OLogNo,\\n)</Set>

					<Set>FilCon=STRCAT(\\n,\\n,\\n,\\n,$FilConA,,$FilConB,\\n,$FilConC,\\n,$FilConD,\\n,$FilConE,\\n,$FilConF,\\n)</Set>

<!--
              <Set>@BAS.pcnt=ADD(@BAS.pcnt,1)</Set> 
              <If condition="INTCMP(MOD(@BAS.pcnt,6),3,0)">
                  <Set>FilCon=STRCAT($FilCon)</Set>
              </If>
              <ElseIf>
                  <Set>FilCon=STRCAT($FilCon,\\n,\\n)</Set>
              </ElseIf>
-->
					<Exec func="PUB:WriteFile">
						<Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam)"/>
						<Arg name="OpenMode" value="a"/>
						<Arg name="ESCFMT" value="$FilCon"/>
					</Exec>
				</While>

				<Exec func="PUB:CloseCursor"/>

				<Set>SrcFil=STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam)</Set>
				<Set>ObjFil=STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)</Set>
				<Exec func="PUB:CopyFile">
					<Arg name="SrcFil"    value="$SrcFil"/>
					<Arg name="ObjFil"    value="$ObjFil"/>
				</Exec>

				<Exec func="PUB:SendFileMessage2">
					<Arg name="MsgTyp"  value="4"/>
					<Arg name="ObjNod"  value="$NodNo"/>
					<Arg name="BusTyp"  value="46"/>
					<Arg name="AplCod"  value="5532"/>
					<Arg name="FilNam"  value="$FilNam"/>
					<Arg name="Summary" value="批量收据打印"/>
					<Arg name="ObjTlr"  value="$TlrId"/>
				</Exec>
		</FlowCtrl>
	</Transaction>
	
	  <!-- 自助缴费抹账 （自助通，网银等渠道的缴费退费） -->
  <Transaction code="465533">
    <DynSentence name="IsFshAct">
      <Sentence>
        SELECT TxnSts from cadfshact WHERE ActDat='%s' and CrgTyp='1' and NodNo='%s'
      </Sentence>
      <Fields>ActDat|NodNo|</Fields>
    </DynSentence>
    <DynSentence name="QuerySql">
      <Sentence>
        Select HTxnSt OHTxnSt,TTxnSt,TxnSts,HTxnCd OHTxnCd,TxnCnl OTxnCnl,TlrId from ccptxnjnl where LogNo='%s'
      </Sentence>
      <Fields>OLogNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdSql1">
      <Sentence>
        update ccptxnjnl set HTxnSt='%s',TxnSts='%s' where LogNo='%s'
      </Sentence>
      <Fields>HTxnSt|TxnSts|OLogNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdSql2">
      <Sentence>
         update %s set RecSts='%s', TckNo='%s' where LogNo='%s' and ActDat='%s'
      </Sentence>
      <Fields>TblNam|RecSts|OTckNo|OLogNo|ActDat|</Fields>
    </DynSentence>
    <FlowCtrl>      
      <Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
      <Exec func="PUB:InitTransaction"/>

      <!--授权检查-->
			<Exec func="PUB:AddAuthReason" error="IGNORE">
				<Arg name="AthCod" value="40" />
				<Arg name="AthMsg" value="465533" />
			</Exec>
			<If condition="~RetCod!=0">
				<Return/>
			</If>
			<Exec  func="PUB:CheckLocalAuth" error="IGNORE">
				<Arg name="ObjSvr" value="SHSTPUB1" />
			</Exec>
			<If condition="~RetCod!=0">
				<Return/>
			</If>
			<Set>AthLvl=00</Set> 


      <Set>LogNo=$OLogNo</Set>

      <Exec func="PUB:ReadRecord" >
        <Arg name="sql" value="QuerySql"/>
      </Exec>
      <If condition="$TxnSts=C">
        <Set>RspCod=465599</Set>
        <Set>RspMsg=本交易已抹账</Set>
        <Return/>
      </If>

			<!--原交易渠道判断-->
			<If condition="$OTxnCnl=TRM">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=465599</Set>
				<Set>RspMsg=原交易是柜台交易,不能用该交易退费</Set>
				<Return/>
			</If>

      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="IsFshAct"/>
      </Exec>
      <If condition="~RetCod=0">
        <If condition="$TxnSts=S">
          <!-- 当天已结账，因此交易为自助通交易抹账，与柜台结账无关（结账只结柜台渠道的，自助通的帐由第二天其他交易结账划转） -->
          <!--Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>
          <Set>RspMsg=当天已结账</Set>
          <Return/-->
        </If>
        <ElseIf condition="$TxnSts=T">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=465599</Set>  <!-- 当天结账超时 -->
          <Set>RspMsg=当天结账超时</Set>
          <Return/>
        </ElseIf>
      </If>
      <ElseIf condition="~RetCod!=-2">
        <Set>MsgTyp=E</Set>
        <Set>RspCod=465599</Set>
        <Set>RspMsg=数据库系统故障 </Set>
        <Return/>
      </ElseIf>



			<!--主机抹账-->
      <Set>OTTxnCd=465531</Set>
      <Set>HTxnCd=STRCAT(SUBSTR($OHTxnCd,1,5),9)</Set>
			<Set>TTxnCd=STRCAT(SUBSTR($OTTxnCd,1,5),9)</Set>
      <Switch expression="$OHTxnSt">
        <Case value="U"/>
        <Case value="S"/>
        <Case value="T">
          <Set>TIATyp=C</Set>
          <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="TTxnCd" value="959999"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
          </Exec>
          <If condition="~RetCod=0">    <!--抹账成功-->
            <Set>HTxnSt=C</Set>
            <Set>TxnSts=C</Set>
            <Set>RecSts=C</Set>
          </If>
          <ElseIf condition="~RetCod=-1">    <!--抹账超时-->
            <Set>HTxnSt=T</Set>
            <Set>TxnSts=T</Set>
            <Set>RecSts=T</Set>
          </ElseIf>
          <Else>
            <Switch expression="$HRspCd">
              <Case value="AG8001"/>      <!--该前置流水号不存在-->
              <Case value="AG8981"/>      <!--该前置流水号不存在-->
              <Case value="SC6129">       <!--原交易不存在-->
                <Set>MsgTyp=N</Set>
                <Set>RspCod=000000</Set>
                <Set>HTxnSt=F</Set>
                <Set>TxnSts=F</Set>
                <Set>RecSts=0</Set>
                <Break/>
              </Case>
              <Case value="SC6034">       <!--原交易已经被抹-->
                <Set>MsgTyp=N</Set>
                <Set>RspCod=000000</Set>
                <Set>HTxnSt=C</Set>
                <Set>TxnSts=C</Set>
                <Set>RecSts=C</Set>
                <Break/>
              </Case>
              <Default>
                <Return/>
              </Default>
            </Switch>
          </Else>
          <Exec func="PUB:ExecSql">
            <Arg name="sql" value="UpdSql1"/>
          </Exec>
          <Set>TblNam=ccpjnldtl</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="sql" value="UpdSql2"/>
          </Exec>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
          </If>
          <ElseIf condition ="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=465599</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
          </ElseIf>
          <Set>TblNam=cadjnldtl</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="sql" value="UpdSql2"/>
          </Exec>
          <If condition="~RetCod=-2">
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
          </If>
          <ElseIf condition ="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=465599</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
          </ElseIf>
          <Break/>
        </Case>
        <Default>
          <Set>RspCod=465599</Set>
          <Set>RspMsg=原交易未成功，不需抹账</Set>
          <Return/>
        </Default>
      </Switch>
    </FlowCtrl>
  </Transaction>
  
  
	<Transaction code="465534" desc="自助渠道大中专学费轧账">
		<DynSentence name="SqlCur">
			<Sentence>
				SELECT LogNo OLogNo
				FROM ccptxnjnl
				WHERE (ActDat BETWEEN '%s' AND '%s')
				AND (HTxnSt='T' or HTxnSt='U')
				AND (TXNCNL='MME' or TXNCNL='WEB')
			</Sentence>
			<Fields>StaDat|EndDat|</Fields>
		</DynSentence>
		<DynSentence name="UpdHTxnSt"><!--更新主机流水状态-->
			<Sentence>
				UPDATE ccptxnjnl
				SET (HTxnSt,TxnSts)=('%s','%s')
				WHERE LogNo='%s'
			</Sentence>
			<Fields>Sts|Sts|OLogNo|</Fields>
		</DynSentence>
		<DynSentence name="QryNodInf">
			<Sentence>
				SELECT NodNo NodRec,NODCOD
				FROM cadnodinf
			</Sentence>
			<Fields></Fields>
		</DynSentence>
		<DynSentence name="QryXzsJnl">
			<Sentence>
			SELECT CrgCod SrfCod,coalesce(COUNT(*),0) SrfCnt, COALESCE(SUM(CAST(ItmAmt AS BIGINT)),0) SrfAmt
			from cadjnldtl 
			where (ActDat BETWEEN '%s' AND '%s')
			and NodNo='%s'
      and CrgTyp='1'
      and CadCcp='2'			
			and RecSts='1' 
			and CrgWay in ('0','1') 
			and TLRID not like '444%%' 
			group by CrgCod order by CrgCod
			</Sentence>
			<Fields>StaDat|EndDat|NodRec|</Fields>
		</DynSentence>


		<DynSentence name="GetSrfInf">
			<Sentence>
				SELECT coalesce(COUNT(*),0) SumCnt,coalesce(SUM(cast(ItmAmt as bigint)),0) SumAmt
				FROM cadjnldtl
				WHERE  (ActDat BETWEEN '%s' AND '%s')
				AND NodNo='%s'
        AND CrgTyp='1'
        AND CadCcp='2'				
			  AND RecSts='1' 
			  AND CrgWay in ('0','1') 
			  AND TLRID not like '444%%' 
			</Sentence>
			<Fields>StaDat|EndDat|NodRec|</Fields>
		</DynSentence>
		<DynSentence name="QryXzsJnl2">
			<Sentence>
				SELECT CrgCod SrfCod,coalesce(COUNT(*),0) SrfCnt,coalesce(SUM(cast(ItmAmt as bigint)),0) SrfAmt
				FROM cadjnldtl
				WHERE (ActDat BETWEEN '%s' AND '%s')
				AND NodNo='%s'
        AND CrgTyp='1'
        AND CadCcp='2'				
			  AND RecSts='1' 
			  AND CrgWay in ('0','1') 
			  AND TLRID not like '444%%' 
				GROUP BY CrgCod
			</Sentence>
			<Fields>StaDat|EndDat|NodRec|</Fields>
		</DynSentence>
		<DynSentence name="GetCntInf">
			<Sentence>
				SELECT TxnCnl,coalesce(COUNT(*),0) CnlCnt,coalesce(SUM(cast(TxnAmt as bigint)),0) CnlAmt
				FROM ccptxnjnl
				WHERE (ActDat BETWEEN '%s' AND '%s')
				AND NodNo='%s'
				AND TxnSts='S'
				AND (TXNCNL='MME' or TXNCNL='WEB')
				GROUP BY TxnCnl
			</Sentence>
			<Fields>StaDat|EndDat|NodRec|</Fields>
		</DynSentence>

		<DynSentence name="GetTotInf">
			<Sentence>
				SELECT coalesce(COUNT(*),0) TotCnt,coalesce(SUM(cast(TxnAmt as bigint)),0) TotAmt
				FROM ccptxnjnl
				WHERE (ActDat BETWEEN '%s' AND '%s')
				AND TxnSts='S'
			</Sentence>
			<Fields>StaDat|EndDat|</Fields>
		</DynSentence>

		<Attributes>
			<Attribute name="nodatabase" value="2"/>
		</Attributes>
		<FlowCtrl>
			<Set>BrNo=@BCFG.BrNo</Set>	<!--added by wy 20100208 for ics4.0-->
			<Exec func="PUB:InitTransaction"/>
			<Exec func="PUB:GetAppInfo"/>

			<If condition="ISNULL($StaDat)">
				<Set>StaDat=00000000</Set>
			</If>

			<If condition="ISNULL($EndDat)">
				<Set>EndDat=$ActDat</Set>
			</If>

			<If condition="INTCMP($RknDat,6,$ActDat)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=465599</Set>
				<Set>RspMsg=清算日期必须小于或等于会计日期</Set>
				<Return/>
			</If>

			<If condition="INTCMP($EndDat,6,$RknDat)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=465599</Set>
				<Set>RspMsg=起始日期必须小于或等于终止日期</Set>
				<Return/>
			</If>

			<If condition="INTCMP($StaDat,6,$EndDat)">
				<Set>MsgTyp=E</Set>
				<Set>RspCod=465599</Set>
				<Set>RspMsg=起始日期必须小于或等于终止日期</Set>
				<Return/>
			</If>

			<!--主机预对账-->
			<Exec func="PUB:OpenCursor">
				<Arg name="SqlCmd" value="SqlCur"/>
			</Exec>

			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/>
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<ElseIf condition="~RetCod=-1">
					<Return/>
				</ElseIf>

				<Exec func="PUB:GetLogNo"/>
				<Exec func="PUB:CallHostOther" error="IGNORE">
					<Arg name="HTxnCd" value="458980"/>
					<Arg name="ObjSvr" value="SHSTPUB1"/>
				</Exec>
				<If condition="~RetCod&lt;0">
					<Return/>
				</If>
				<If condition="$MsgTyp!=N">
					<Switch expression="$HRspCd">
						<Case value="AG8001"/>
						<Case value="AG8981"/>
						<Case value="SC6129">
							<Set>Sts=F</Set>
							<Break/>
						</Case>
						<Case value="SC6034">
							<Set>Sts=C</Set>
							<Break/>
						</Case>
						<Default>
							<Return/>
						</Default>
					</Switch>
				</If>
				<Else>
					<If condition="$CrcSts!=Y">
						<Set>Sts=S</Set>
					</If>
					<Else>
						<Set>Sts=C</Set>
					</Else>
				</Else>

				<Exec func="PUB:ExecSql">
					<Arg name="SqlCmd" value="UpdHTxnSt"/>
				</Exec>

			</While>

			<Exec func="PUB:CloseCursor"/>
			<Set>MsgTyp=N</Set>
      <Set>HRspCd=SC0000</Set>

			<!--打印全行自助渠道大中专收费数据-->
			<Set>Month=SUBSTR($RknDat,5,2)</Set>

			<Exec func="PUB:CodeSwitching">
				<Arg name="DatSrc"  value="SRFCSW"/>
				<Arg name="SourNam" value="Month"/>
				<Arg name="DestNam" value="MthIdx"/>
				<Arg name="TblNam"  value="Month"/>
			</Exec>

			<Exec func="PUB:OpenCursor">
				<Arg name="SqlCmd" value="QryNodInf"/>
			</Exec>

			<While>
				<Exec func="PUB:FetchCursor" error="IGNORE"/>
				<If condition="~RetCod=100">
					<Break/>
				</If>
				<ElseIf condition="~RetCod=-1">
					<Exec func="PUB:DeleteDiskNo"/>
					<Set>RspCod=465599</Set>
					<Set>RspMsg=数据库操作错误</Set>
					<Return/>
				</ElseIf>


				<Set>FilNam=DELSPACE(STRCAT(sf,$NodCod,.,$MthIdx,SUBSTR($RknDat,7,2)),all)</Set>

				<Exec func="PUB:ExportFromDB">
					<Arg name="FormatName" value="srfxzsjnl"/>
					<Arg name="FileName"   value="STRCAT(dat/ccp/,$FilNam)"/>
					<Arg name="TableName"  value="cadjnldtl"/>
					<Arg name="SqlName"    value="QryXzsJnl"/>
				</Exec>

			</While>

			<Exec func="PUB:CloseCursor"/>



			<!--打印轧账单-->
			<Set>ChkDat=$StaDat</Set>
			<While condition="INTCMP($ChkDat,2,$EndDat)">

				<Set>FilNam=DELSPACE(STRCAT(自助渠道大中专收费轧账单_,$ChkDat),all)</Set>

				<System command="" error="IGNORE">
					<Arg name="ObjFil" value="STRCAT(&gt;,GETENV(WORKDIR),/dat/ccp/,$FilNam)"/>
				</System>

				<Set>Tmp1=(</Set>
				<Set>Tmp2=)</Set>
				<Set>Tmp3=━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</Set>

				<Exec func="PUB:OpenCursor">
					<Arg name="SqlCmd" value="QryNodInf"/>
				</Exec>

				<While>
					<Exec func="PUB:FetchCursor" error="IGNORE"/>
					<If condition="~RetCod=100">
						<Break/>
					</If>
					<ElseIf condition="~RetCod=-1">
						<Exec func="PUB:DeleteDiskNo"/>
						<Set>RspCod=465599</Set>
						<Set>RspMsg=数据库操作错误</Set>
						<Return/>
					</ElseIf>

					<Exec func="PUB:ReadRecord">
						<Arg name="SqlCmd" value="GetSrfInf"/>
					</Exec>

					<Exec func="PUB:ExportFromDB">
						<Arg name="FormatName" value="srfxzsjnl2"/>
						<Arg name="FileName"   value="STRCAT(dat/ccp/,$FilNam,_tmp)"/>
						<Arg name="TableName"  value="cadjnldtl"/>
						<Arg name="SqlName"    value="QryXzsJnl2"/>
					</Exec>

					<Exec func="PUB:ExportFromDB">
						<Arg name="FormatName" value="srftxnjnl"/>
						<Arg name="FileName"   value="STRCAT(dat/ccp/,$FilNam,_tmp2)"/>
						<Arg name="TableName"  value="ccptxnjnl"/>
						<Arg name="SqlName"    value="GetCntInf"/>
					</Exec>

					<Set>FilConA=STRCAT(SPACE(30),大中专收费自助渠道轧账单,$Tmp1,人民币,$Tmp2,\\n)</Set>
					<Set>FilConB=STRCAT(网点:,$NodRec,SPACE(50),日期:,$ChkDat,\\n,$Tmp3,\\n,收费编码,SPACE(25),笔数,SPACE(25),金额,\\n,$Tmp3,\\n)</Set>
					<Set>FilCon=STRCAT($FilConA,$FilConB)</Set>

					<Exec func="PUB:WriteFile">
						<Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam)"/>
						<Arg name="OpenMode" value="a"/>
						<Arg name="ESCFMT" value="$FilCon"/>
					</Exec>

					<Set>ObjFil=DELRIGHTSPACE(STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam))</Set>
					<Set>SrcFil=DELRIGHTSPACE(STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam,_tmp))</Set>
					<Exec func="PUB:CatFile">
						<Arg name="ObjFil"    value="$ObjFil"/>
						<Arg name="SrcFile"    value="$SrcFil"/>
					</Exec>


					<Set>ObjFil=DELRIGHTSPACE(STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam))</Set>
					<Set>SrcFil=DELRIGHTSPACE(STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam,_tmp2))</Set>
					<Exec func="PUB:CatFile">
						<Arg name="ObjFil"    value="$ObjFil"/>
						<Arg name="SrcFile"    value="$SrcFil"/>
					</Exec>

				</While>

				<Exec func="PUB:CloseCursor"/>

				<Exec func="PUB:CopyFile">
					<Arg name="SrcFil" value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam)"/>
					<Arg name="objFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
				</Exec>

				<Exec func="PUB:SendFileMessage2">
					<Arg name="MsgTyp"  value="4"/>
					<Arg name="ObjNod"  value="$NodNo"/>
					<Arg name="BusTyp"  value="$BusTyp"/>
					<Arg name="AplCod"  value="255"/>
					<Arg name="FilNam"  value="$FilNam"/>
					<Arg name="Summary" value="自助渠道大中专收费轧账单"/>
					<Arg name="ObjTlr"  value="$TlrId"/>
				</Exec>

				<Set>ChkDat=CALCDATE($ChkDat,+,d,1)</Set>
			</While>

			<!--打印当日全行汇总表-->
			<Set>ChkDat=$StaDat</Set>
			<!--INTCMP函数中第二个参数说明：1<  2<= 3= 4!= 5>= 6> -->
			<While condition="INTCMP($ChkDat,2,$EndDat)">
				<Set>FilNam=DELSPACE(STRCAT(大中专收费各渠道全行汇总_,$ChkDat),all)</Set>

				<Exec func="PUB:ReadRecord">
					<Arg name="SqlCmd" value="GetTotInf"/>
				</Exec>

				<If condition="$TotCnt=0">
					<System command="" error="IGNORE">
						<Arg name="ObjFil" value="STRCAT(&gt;,GETENV(WORKDIR),/dat/ccp/,$FilNam)"/>
					</System>
				</If>
				<Else>
					<Exec func="PUB:GenerateReport">
						<Arg name="RptName" value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam)"/>
						<Arg name="RptFile" value="etc/CCP004_RPT_444999.XML"/>
						<Arg name="ChkDat" value="$ChkDat"/>
						<Arg name="TotAmt" value="$TotAmt"/>
					</Exec>
				</Else>

				<Exec func="PUB:CopyFile">
					<Arg name="SrcFil" value="STRCAT(GETENV(WORKDIR),/dat/ccp/,$FilNam)"/>
					<Arg name="objFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
				</Exec>

				<Exec func="PUB:SendFileMessage2">
					<Arg name="MsgTyp"  value="4"/>
					<Arg name="ObjNod"  value="$NodNo"/>
					<Arg name="BusTyp"  value="$BusTyp"/>
					<Arg name="AplCod"  value="255"/>
					<Arg name="FilNam"  value="$FilNam"/>
					<Arg name="Summary" value="大中专收费各渠道当日全行汇总"/>
					<Arg name="ObjTlr"  value="$TlrId"/>
				</Exec>

				<Set>ChkDat=CALCDATE($ChkDat,+,d,1)</Set>
			</While>

		</FlowCtrl>
	</Transaction>


</Application>
