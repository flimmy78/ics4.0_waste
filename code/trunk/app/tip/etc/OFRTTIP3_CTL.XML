<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="TIP" code="037">
   <!--
   BoCom00031634_XuChg_20080222_增加915225机构拆并交易
   BoCom00034838_zhq_20080325_915226_自动更新三方协议表中的卡号和验证状态
   Modified by zhq_BoCom00041319_20080620_915231_缴税通报表(报表名:缴税通对公客户签约进度表)
   Added By zhq_BoCom00041319_20080707_915227_定时更新地区码表
   Added by sundx for cq57421 新增918761总行对账登记簿查询交易
   Modified by LiuYj_BoCom00076186_20090929_修改918762和918740
   Modified by ly_BoCom00087568_20090915_修改918750,918760,918720,918730,918770,918775,918800,918810   
   -->
   <BusDefDeclare>
      <Busdef name="VER" value="1.0"></Busdef>
      <Busdef name="SrcNod" value="601100000010"></Busdef>
      <Busdef name="DstNod" value="100000000000"></Busdef>
      <Busdef name="APP" value="TIPS"></Busdef>
      <Busdef name="TxnCnl" value="TIP"></Busdef>
   </BusDefDeclare>
   <ConfigDeclare>
      <Config name="TIPCSW"           value="etc/TIP_CSW.XML"/>
      <Config name="BatFormat"        value="etc/TIP_FMT.XML"/>
   </ConfigDeclare>
   <TableDeclare>
      <Table name="tipfmgrec" value="tipfmgrec"/><!--自由报文明细表-->
      <Table name="tiptrerkn" value="tiptrerkn"/><!--国库清算行-->
      <Table name="tipbrkinf" value="tipbrkinf"/><!--上线分行-->
      <Table name="tipsyssts" value="tipsyssts"/><!--系统状态-->
      <Table name="tipchkbok" value="tipchkbok"/><!--人行对账包登记簿-->
      <Table name="tiptxnbok" value="tiptxnbok"/><!--人行帐务交易登记簿-->
      <Table name="tipnodchg" value="tipnodchg"/><!--机构整体撤并历史表-->
      <Table name="tipacchg"  value="tipacchg"/><!--账户撤并历史表-->
      <Table name="tipbusnty" value="tipbusnty"/><!--国库业务提示记录表-->
      <Table name="tipcrdchg" value="tipcrdchg"/><!--账户拆并历史表-->
      <Table name="tiprgnbrk" value="tiprgnbrk"/><!--地区码表-->
   </TableDeclare>
   <Define>
      <Macro name="GetSeq"><!--取序号-->
         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="TIP:MsgId"/>
            <Arg name="SeqCnd" value="MsgId"/>
            <Arg name="Len" value="10"/>
         </Exec>
         <Set>MsgId=STRCAT(0000000000,$SelVal)</Set>
      </Macro>
      <Macro name="GetBrkSQL">  <!--根据地区号取分行号SQL语句-->
         <DynSentence name="GetBrkNo">   <!--根据地区号取分行号-->
            <Sentence>
               SELECT BrkNo
               FROM tiprgnbrk
               WHERE Rgn='%s'
            </Sentence>
            <Fields>Rgn|</Fields>
         </DynSentence>
      </Macro>
      <Macro name="GetBrkCTL">  <!--根据网点号取分行号-->
         <Set>Rgn=SUBSTR($NodNo,1,3)</Set>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkNo"/>
         </Exec>
      </Macro>
      <Macro name="Init">
         <Set>BrNo=999001</Set>
         <Exec func="PUB:InitTransaction"/>
      </Macro>
      <!--BoCom00031634_XuChg_20080222_增加915225机构拆并交易_通过CD取文件-->
      <Macro name="GetTipFile">
         <!--检查文件是否重复接收-->
         <Exec func="PUB:CollateRepeatRecord"/>
         <!--通过CD取文件-->
         <System command="TipGetFile.sh" error="IGNORE">
            <Arg name="AcDate" value="$SelDat"/>
            <Arg name="SrcFil" value="STRCAT(STRCAT(/app/ade/data/D1/ICS/,$SelDat),/,$DskNam)"/>
            <Arg name="ObjFil" value="STRCAT(STRCAT(GETENV(WORKDIR),/dat/tip/,$SelDat),/,$DskNam)"/>
         </System>
         <If condition="~RetCod!=0">
            <Set>RecLvl=2</Set>
            <Quote name="BusNty"/>
            <Set>RspMsg=STRCAT($DskNam,取文件失败)</Set>      <!--文件读取失败-->
            <Return/>
         </If>
      </Macro>

      <!--BoCom00031634_XuChg_20080222_增加915225机构拆并交易_登记业务提示表-->
      <Macro name="BusNty">
         <Set>BrkNo=$BrNo</Set>
         <Set>RecTim=GETDATETIME(HHMISS)</Set>
         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="tipbusnty:RecNo"/>
            <Arg name="SeqCnd" value="RecNo"/>
            <Arg name="Len" value="8"/>
         </Exec>
         <Set>RecNo=$SelVal</Set>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tipbusnty"/>
         </Exec>
      </Macro>
      <!--Added By zhq_BoCom00034838_20080328-->
      <Macro name="ErrToDB">
         <Set>RecLvl=2</Set>
         <Quote name="BusNty"/>
      </Macro>
      <!-- add by lyj at 20090729 for cq76186 begin -->
      <!-- add by ly at 20090915 for cq87568 begin -->  
      <Macro name="MSBrAuChk"> <!--省行代理权限检查SQL-->
         <DynSentence name="SelBrNo1"> <!--获取交易网点所在分行号,上级机构号,以及辖行标志(0-省分行 1-辖行)-->
      <Sentence>
         SELECT OrgBk BrNo1,SupBk SupBk1,CASE WHEN OrgBk=SupBk THEN '0' ELSE '1' END Flag1  FROM cimorgtbl WHERE OrgNo IN (SELECT OrgBk FROM cimorgtbl WHERE OrgNo='%s')
      </Sentence>
      <Fields>NodNo|</Fields>
         </DynSentence>
         <DynSentence name="SelBrNo2"><!--获取被代理机构所在分行号,上级机构号，以及辖行标志(0-省分行 1-辖行)-->
      <Sentence>
         SELECT OrgBk OprBr,SupBk SupBk2,CASE WHEN OrgBk=SupBk THEN '0' ELSE '1' END Flag2  FROM cimorgtbl WHERE OrgNo IN (SELECT OrgBk FROM cimorgtbl WHERE OrgNo='%s')
      </Sentence>
      <Fields>OprNod|</Fields>
         </DynSentence>
      </Macro>
      <Macro name="MCBrAuChk"> <!--省行代理权限检查-->	 
        <Exec func="PUB:ReadRecord" error="IGNORE">
           <Arg name="SqlCmd" value="SelBrNo1" desc=" "/>
        </Exec>
        <If condition="~RetCod!=0">
           <!-- 提示：找不到分行记录，返回错误 -->
           <Set>RspCod=910699</Set>
           <Set>RspMsg=无法查找网点所在分行信息</Set>
           <Return/>
        </If>   
        <Exec func="PUB:ReadRecord" error="IGNORE">
           <Arg name="SqlCmd" value="SelBrNo2" desc=" "/>
        </Exec>
        <If condition="~RetCod!=0">
           <!-- 提示：找不到分行记录，返回错误 -->
           <Set>RspCod=910699</Set>
           <Set>RspMsg=无法查找被代理机构归属分行号以及上级机构信息</Set>
           <Return/>
        </If>
        
        <If condition="IS_NOEQUAL_STRING($BrNo1,$OprBr)">
           <If condition="$Flag1=0"> <!--交易行是省分行-->
              <If condition="$Flag2=0"> <!--被代理机构是省分行-->
                 <Set>RspCod=910699</Set>
                 <Set>RspMsg=不能跨行操作</Set>
                 <Return/>
              </If>
       
              <Else> <!--被代理机构是辖行-->
                 <If condition="IS_NOEQUAL_STRING($SupBk1,$SupBk2)">
                    <Set>RspCod=910699</Set>
                    <Set>RspMsg=辖属关系不存在</Set>
                    <Return/>
                 </If>  
              </Else> 
           </If>
           <Else><!--辖行-->
              <If condition="IS_NOEQUAL_STRING($BrNo1,$OprBr)">
                 <Set>RspCod=910699</Set>
                 <Set>RspMsg=辖行只能处理本行交易</Set>
                 <Return/>
              </If>
           </Else> 
        </If>
      </Macro>
      <!-- add by ly at 20090915 for cq87568 end -->        
   </Define>

   <!-- 系统登录 -->
   <Transaction code="915140" desc="系统登录">
      <DynSentence name="ChkSysSts"><!--检查系统状态-->
         <Sentence>
            SELECT * FROM tipsyssts
         </Sentence>
      </DynSentence>
      <DynSentence name="UpdSysSts"><!--修改系统状态-->
         <Sentence>
            UPDATE tipsyssts SET (WorkDt,Status)=('%s','%s')
         </Sentence>
         <Fields>WrkDat|Status|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--Modified by sundx at 20081117 for cq51121,canceling addauth-->
         <!--Exec func="PUB:AddAuthReason" ><添加授权原因>
            <Arg name="AthCod" value="70" />
            <Arg name="AthMsg" value="910221" />
         </Exec>
         <Exec  func="PUB:CheckHostAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec-->
         <!--Ended by sundx at 20081117 for cq51121,canceling addauth-->
         <Exec func="PUB:ReadRecord"><!--检查系统状态-->
            <Arg name="SqlCmd" value="ChkSysSts"/>
         </Exec>
         <If condition="IS_EQUAL_STRING($Status,1)">
            <Set>RspCod=910201</Set><!--系统状态为日切模式下禁止登录-->
            <Return/>
         </If>
         <Exec func="PUB:GetLogNo"/>
         <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
         <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,授权柜员:,$Sup1Id,备注:系统登录)</Set>
         <!--去掉授权信息-->

         <!--Set>TIATyp=T</Set>
         <Set>AthLvl=00</Set>
         <Set>Sup1Id=       </Set>
         <Set>Sup2Id=       </Set>
         <Set>Sup1Pw=      </Set>
         <Set>Sup2Pw=      </Set>
         <Set>Sup1Dv=0</Set>
         <Set>Sup1Dv=0</Set>
         <Set>AthTbl=      </Set-->

         <Set>TTxnCd=915880</Set>
         <Exec func="PUB:CallHostOther">
            <Arg name="TxnCod" value="915880" />
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>

         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Set>WrkDat=$WorkDt</Set>
         <Exec func="PUB:CallThirdOther" error="IGNORE">
            <Arg name="HTxnCd" value="9006"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>HTxnCd=915880</Set>
            <Set>NoteInfo=STRCAT($HLogNo,$TckNo,$HTxnCd,$NoteInfo)</Set>
            <Set>HTxnCd=915886</Set>
            <Set>TTxnCd=915886</Set>
            <Exec func="PUB:CallHostOther"> <!--失败则抹去非会计流水-->
               <Arg name="TxnCod" value="915886" />
               <Arg name="ObjSvr" value="SHSTPUB1"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Return/>
            </If>

            <Set>MsgTyp=E</Set>
            <Set>RspCod=910612</Set>
            <Return/>
         </If>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdSysSts"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 系统退出 -->
   <Transaction code="915145" desc="系统退出">
      <DynSentence name="ChkSysSts"><!--检查系统状态-->
         <Sentence>
            SELECT * FROM tipsyssts
         </Sentence>
      </DynSentence>
      <DynSentence name="UpdSysSts"><!--修改系统状态-->
         <Sentence>
            UPDATE tipsyssts SET Status='3'
         </Sentence>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--Modified by sundx at20081117 for cq51121,canceling addauth-->
         <!--Exec func="PUB:AddAuthReason" >
            <Arg name="AthCod" value="70" />
            <Arg name="AthMsg" value="910222" />
         </Exec>
         <Exec  func="PUB:CheckHostAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec-->
         <!--Ended by sundx at20081117 for cq51121,canceling addauth-->
         <Exec func="PUB:ReadRecord"><!--检查系统状态-->
            <Arg name="SqlCmd" value="ChkSysSts"/>
         </Exec>
         <If condition="IS_EQUAL_STRING($Status,1)">
            <Set>RspCod=910202</Set><!--系统状态为日切模式下禁止退出-->
            <Return/>
         </If>
         <!--去掉授权信息-->

         <!--Set>TIATyp=T</Set>
         <Set>AthLvl=00</Set>
         <Set>Sup1Id=       </Set>
         <Set>Sup2Id=       </Set>
         <Set>Sup1Pw=      </Set>
         <Set>Sup2Pw=      </Set>
         <Set>Sup1Dv=0</Set>
         <Set>Sup1Dv=0</Set>
         <Set>AthTbl=      </Set-->

         <Set>TTxnCd=915880</Set>
         <Exec func="PUB:GetLogNo"/>
         <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
         <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,授权柜员:,$Sup1Id,备注:系统退出)</Set>
         <Exec func="PUB:CallHostOther"><!--产生非会计流水-->
            <Arg name="TxnCod" value="915880" />
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Set>WrkDat=$WorkDt</Set>
         <Exec func="PUB:CallThirdOther" error="IGNORE">
            <Arg name="HTxnCd" value="9008"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>HTxnCd=915880</Set>
            <Set>NoteInfo=STRCAT($HLogNo,$TckNo,$HTxnCd,$NoteInfo)</Set>
            <Set>HTxnCd=915886</Set>
            <Set>TTxnCd=915886</Set>
            <Exec func="PUB:CallHostOther"> <!--失败则抹去非会计流水-->
               <Arg name="TxnCod" value="915886" />
               <Arg name="ObjSvr" value="SHSTPUB1"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Return/>
            </If>

            <Set>MsgTyp=E</Set>
            <Set>RspCod=910612</Set>
            <Return/>
         </If>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdSysSts"/>
         </Exec>
         <Set>MsgTyp=N</Set>
         <Set>RspCod=000000</Set>
      </FlowCtrl>
   </Transaction>
   <!-- 连接测试请求(去人行) -->
   <Transaction code="918820" desc="连接测试请求(去人行)">
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>TTxnCd=915880</Set>
         <Exec func="PUB:GetLogNo"/>
         <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
         <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,备注:人行连接测试)</Set>
         <Exec func="PUB:CallHostOther"><!--产生非会计流水-->
            <Arg name="TxnCod" value="915880" />
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Set>WrkDat=$ActDat</Set>
         <Exec func="PUB:CallThirdOther" error="IGNORE"><!--连接测试请求-->
            <Arg name="HTxnCd" value="9005X"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=910612</Set><!--连接测试超时或失败-->
         </If>
      </FlowCtrl>
   </Transaction>
   <!-- 连接测试请求(人行来) -->
   <Transaction code="918825" desc="连接测试请求(人行来)">
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>OMsgNo=$MsgNo</Set>
         <Set>Result=90000</Set>
         <Set>AddWord=Are you ready</Set>
      </FlowCtrl>
   </Transaction>
   <!-- 故障通知 -->
   <Transaction code="915141" desc="故障通知">
      <DynSentence name="UpdCodSts"><!--修改节点状态-->
         <Sentence>
            UPDATE tipnodinf SET Status='%s' WHERE NodCod='%s'
         </Sentence>
         <Fields>Status|NodCod|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:SetNoResponse"/>
         <If condition="$NodSts=0">
            <Set>Status=1</Set>
         </If>
         <Else>
            <Set>Status=0</Set>
         </Else>
         <Exec func="PUB:ExecSql"><!--修改节点状态-->
            <Arg name="SqlCmd" value="UpdCodSts"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 强制退出通知 -->
   <Transaction code="915142" desc="强制退出通知">
      <DynSentence name="ForceQtUpd"><!--设置状态为强制退出-->
         <Sentence>
            UPDATE tipsyssts SET (Status)=('4')
         </Sentence>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:SetNoResponse"/>
         <Exec func="PUB:ExecSql"><!--更新系统状态-->
            <Arg name="SqlCmd" value="ForceQtUpd"/>
         </Exec>
         <Set>AAA=$FQtRsn</Set>
      </FlowCtrl>
   </Transaction>
   <!-- 停运通知 -->
   <Transaction code="915143" desc="停运通知">
      <DynSentence name="MainTainUpd"><!--设置状态为强制退出-->
         <Sentence>
            UPDATE tipsyssts SET Status='%s'
         </Sentence>
         <Fields>Status|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:SetNoResponse"/>
         <If condition="$RunSig=0">
            <Set>Status=4</Set>
         </If>
         <ElseIf condition="$RunSig=1">
            <Set>Status=0</Set>
         </ElseIf>
         <Exec func="PUB:ExecSql"><!--更新系统状态 -->
            <Arg name="SqlCmd" value="MainTainUpd"/>
         </Exec>

      </FlowCtrl>
   </Transaction>
   <!-- 交易状态查询 -->
   <Transaction code="918720" desc="交易状态查询">
      <DynSentence name="QryRLtFlg"><!--检查是否国库关联行-->
         <Sentence>
            SELECT RLtFlg FROM tipbrkinf WHERE BrkNo='%s'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <DynSentence name="QryCbkNo"><!--检查交易归属国库关联行-->
         <Sentence>
            SELECT CBrkNo FROM tiptxnbok WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <!--Quote name="GetBrkSQL"/--> <!-- deleted by ly 20090915 CQ87568 -->
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--Quote name="GetBrkCTL"/--><!--获取分行号--> <!-- deleted ly 20090915 CQ87568 -->
         <!-- add by ly at 20090915 for CQ87568 begin -->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryCbkNo"/>
         </Exec>
         <Set>OprNod=$CBrkNo</Set>
         <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
         <Set>BrkNo=$OprBr</Set>
         <!-- add by ly at 20090915 for CQ87568 end -->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryRLtFlg"/>
         </Exec>
         <If condition="IS_EQUAL_STRING($RLtFlg,0)">
            <Set>RspCod=910210</Set><!--柜员非国库关联行帐务中心柜员，交易拒绝-->
            <Return/>
         </If>
         <If condition="IS_EQUAL_STRING($QryTyp,1)">
            <Set>SPckNo=$TraNo</Set>
         </If>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Set>OMsgNo=3001</Set>
         <Exec func="PUB:CallThirdOther"><!--交易状态查询-->
            <Arg name="HTxnCd" value="9003"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910612</Set>
            <Return/>
         </If>
      </FlowCtrl>
   </Transaction>
   <!-- 明细对账重发申请 -->
   <Transaction code="915862" desc="明细对账重发申请">
      <DynSentence name="GetBrkNo"><!--获取关联行号-->
         <Sentence>
            SELECT BrkNo FROM tiptrerkn WHERE RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkRecord"><!--检查对账登记簿记录-->
         <Sentence>
            SELECT ChkSts FROM tipchkbok
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="DelChkRec"><!--删除对账明细-->
         <Sentence>
            DELETE FROM tipchkrec
            WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
         </Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="DelChkBok"><!--删除对账登记簿记录-->
         <Sentence>
            DELETE FROM tipchkbok
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:AddAuthReason" ><!--添加授权原因-->
            <Arg name="AthCod" value="30" /><!--30-->
            <Arg name="AthMsg" value="910225" />
         </Exec>
         <Exec  func="PUB:CheckLocalAuth" ><!--授权-->
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>

         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkNo"/>
         </Exec>
         <Set>Cent=SUBSTR($BrkNo,1,3)</Set>
         <Set>Centre=STRCAT($Cent,800)</Set><!--拼接账务中心号-->
         <If condition="IS_NOEQUAL_STRING($Centre,$NodNo)">
            <Set>RspCod=910210</Set>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkRecord"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=000000</Set><!--即使无记录，亦可继续流程-->
         </If>
         <Else>
            <If condition="$ChkSts=1">
               <Set>RspCod=910613</Set><!--对账已成功-->
               <Return/>
            </If>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="DelChkRec"/>
            </Exec>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="DelChkBok"/>
            </Exec>
            <Set>RspCod=000000</Set>
         </Else>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Set>EntDat=$ActDat</Set>
         <Exec func="PUB:CallThirdOther"><!--对账重发申请-->
            <Arg name="HTxnCd" value="9112"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 银行端缴款核对重发申请 -->
   <Transaction code="919113" desc="银行端缴款核对重发申请">
      <FlowCtrl>
         <Quote name="Init"/>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:CallThirdOther"><!--重发核对报文请求-->
            <Arg name="HTxnCd" value="9113"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 批扣明细包重发申请 -->
   <Transaction code="919112" desc="批扣明细包重发申请">
      <FlowCtrl>
         <Quote name="Init"/>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:CallThirdOther"><!--重发包明细请求-->
            <Arg name="HTxnCd" value="9111"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 交易登记簿模糊查询 -->
   <Transaction code="918750" desc="交易登记簿模糊查询">
      <DynSentence name="GetTxnInf"><!--交易登记簿模糊查询-->
         <Sentence>
            SELECT ActDat,RBnkNo,PBnkNo,ActNo,TxnAmt,BilSts,ChkSts,RknSts,TckNo,OrgCod,EntDat,TraNo
            FROM tiptxnbok
            WHERE ('%s' = '' OR OrgCod='%s')
            AND (('%s' = '' AND '%s' = '') OR EntDat BETWEEN '%s' AND '%s')
            AND (('%s' = '' AND '%s' = '') OR TraNo BETWEEN '%s' AND '%s')
            AND (('%s' = '' AND '%s' = '') OR ActDat BETWEEN '%s' AND '%s')
            AND ('%s' = '' OR ActNo='%s') AND ('%s' = '' OR TCusId='%s')
            AND ('%s' = '' OR SPckNo='%s') AND ('%s' = '' OR BilSts='%s')
            AND ('%s' = '' OR ChkSts='%s') AND ('%s' = '' OR RknSts='%s')
            AND ('%s' = 'A' OR RBrkNo='%s') AND ('%s' = 'B' OR CBrkNo='%s')
            AND ('%s' = 'C' OR OBrkNo='%s') AND ('%s' = 'A' OR PayMod='%s')
            AND ('%s' = ''  OR ChkDat='%s') order by ActDat,TckNo
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|OrgCod|BEntDt|EEntDt|BEntDt|EEntDt|BTraNo|ETraNo|BTraNo|ETraNo|BActDt|EActDt|BActDt|EActDt|ActNo|ActNo|TCusId|TCusId|SPckNo|SPckNo|BilSts|BilSts|ChkSts|ChkSts|RknSts|RknSts|RBrkNo|RBrkNo|CBrkNo|CBrkNo|OBrkNo|OBrkNo|PayMod|PayMod|ChkDat|ChkDat|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInfLim"><!--非账务中心交易登记簿模糊查询-->
         <Sentence>
            SELECT ActDat,RBnkNo,PBnkNo,ActNo,TxnAmt,BilSts,ChkSts,RknSts,TckNo,OrgCod,EntDat,TraNo
            FROM tiptxnbok
            WHERE ('%s' = '' OR OrgCod='%s')
            AND (('%s' = '' AND '%s' = '') OR EntDat BETWEEN '%s' AND '%s')
            AND (('%s' = '' AND '%s' = '') OR TraNo BETWEEN '%s' AND '%s')
            AND (('%s' = '' AND '%s' = '') OR ActDat BETWEEN '%s' AND '%s')
            AND ('%s' = '' OR ActNo='%s') AND ('%s' = '' OR TCusId='%s')
            AND ('%s' = '' OR SPckNo='%s') AND ('%s' = '' OR BilSts='%s')
            AND ('%s' = '' OR ChkSts='%s') AND ('%s' = '' OR RknSts='%s')
            AND ('%s' = 'A' OR RBrkNo='%s') AND ('%s' = 'B' OR CBrkNo='%s')
            AND ('%s' = 'C' OR OBrkNo='%s') AND ('%s' = 'A' OR PayMod='%s')
            AND (NodNo='%s' OR ONodNo='%s') AND ('%s' = ''  OR ChkDat='%s')
            order by ActDat,TckNo
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|OrgCod|BEntDt|EEntDt|BEntDt|EEntDt|BTraNo|ETraNo|BTraNo|ETraNo|BActDt|EActDt|BActDt|EActDt|ActNo|ActNo|TCusId|TCusId|SPckNo|SPckNo|BilSts|BilSts|ChkSts|ChkSts|RknSts|RknSts|RBrkNo|RBrkNo|CBrkNo|CBrkNo|OBrkNo|OBrkNo|PayMod|PayMod|NodNo|NodNo|ChkDat|ChkDat|</Fields>
      </DynSentence>
      <!--Quote name="GetBrkSQL"/--><!-- delete by ly 20090915 CQ87568 -->
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
            <If condition="IS_EQUAL_STRING(DIFFDATE($BActDt,$EActDt),NULL)">
               <Set>RspCod=910219</Set><!--计算天数出错-->
               <Return/>
            </If>
            <If condition="INTCMP(DIFFDATE($BActDt,$EActDt),6,31)">
               <Set>RspCod=910220</Set><!--时间跨度超31天-->
               <Return/>
            </If>
            <!--Quote name="GetBrkCTL"/--><!--获取分行号--><!-- delete by ly 20090915 CQ87568 -->
            <!-- add by ly at 20090915 for CQ87568 begin -->
            <Set>OprNod=$OprBr</Set>        
            <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
            <Set>BrkNo=$OprBr</Set>
            <!-- add by ly at 20090915 for CQ87568 end -->
            <Set>RBrkNo=A</Set>
            <Set>CBrkNo=B</Set>
            <Set>OBrkNo=C</Set>
            <Switch expression="$BrkTyp">
               <Case value="1">
                  <Set>RBrkNo=$BrkNo</Set>
                  <Break/>
               </Case>
               <Case value="2">
                  <Set>CBrkNo=$BrkNo</Set>
                  <Break/>
               </Case>
               <Case value="3">
                  <Set>OBrkNo=$BrkNo</Set>
                  <Break/>
               </Case>
            </Switch>
         </If>
         <Set>CtrNod=STRCAT(SUBSTR($NodNo,1,3),800)</Set>
         <If condition="IS_NOEQUAL_STRING($CtrNod,$NodNo)">
            <Exec func="PUB:MultiQuery"><!--非账务中心柜员可查记录的交易或开户网点是本网点的记录-->
               <Arg name="SqlCmd"     value="GetTxnInfLim"/>
            </Exec>
            <Return/>
         </If>
         <Exec func="PUB:MultiQuery"><!--账务中心柜员可查所有符合条件记录-->
            <Arg name="SqlCmd"     value="GetTxnInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 交易登记簿记录查询 -->
   <Transaction code="918755" desc="交易登记簿记录查询">
      <DynSentence name="QryTxnDtl">
         <Sentence>
            SELECT * FROM tiptxnbok
            WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTtpRec">
         <Sentence>
            SELECT TaxTNm,TTpAmt,TaxBDt,TaxEDt FROM tipttprec
            WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryTxnDtl"/>
         </Exec>
         <Exec func="PUB:QueryInGroup" error="IGNORE">
            <Arg name="SqlCmd"     value="QryTtpRec"/>
            <Arg name="RecordName" value="TTPRec"/>
         </Exec>
         <Set>RspCod=000000</Set>
         <Set>MsgTyp=N</Set>
      </FlowCtrl>
   </Transaction>
   <!-- 对账登记簿模糊查询 -->
   <Transaction code="918760" desc="对账登记簿模糊查询">
      <DynSentence name="GetChkInf"><!--对账登记簿模糊查询-->
         <Sentence>
            SELECT RBnkNo,PBnkNo,ChkDat,ChkOrd,ChkMod,ChkSts,RknSts,AllAmt,AllNum
            FROM tipchkbok
            WHERE (('%s' = '' AND '%s' = '') OR ChkDat BETWEEN '%s' AND '%s')
            AND (('%s' = '' AND '%s' = '') OR ChkOrd BETWEEN '%s' AND '%s')
            AND ('%s' = 'A' OR RBrkNo='%s') AND ('%s' = 'B' OR CBrkNo='%s')
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BChkDt|EChkDt|BChkOrd|EChkOrd|BChkOrd|EChkOrd|RBrkNo|RBrkNo|CBrkNo|CBrkNo|</Fields>
      </DynSentence>
      <!--Quote name="GetBrkSQL"/--><!-- delete by ly 20090915 CQ87568 -->
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
            <!--Quote name="GetBrkCTL"/--><!--获取分行号--><!-- delete by ly 20090915 CQ87568 -->
            <!-- add by ly at 20090915 for CQ87568 begin -->
            <Set>OprNod=$OprBr</Set>
            <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
            <Set>BrkNo=$OprBr</Set>
            <!-- add by ly at 20090915 for CQ87568 end -->
            <Set>RBrkNo=A</Set>
            <Set>CBrkNo=B</Set>
            <Switch expression="$BrkTyp">
               <Case value="1">
                  <Set>RBrkNo=$BrkNo</Set>
                  <Break/>
               </Case>
               <Case value="2">
                  <Set>CBrkNo=$BrkNo</Set>
                  <Break/>
               </Case>
            </Switch>
         </If>
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd"     value="GetChkInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 对账登记簿记录查询 -->
   <Transaction code="918765" desc="对账登记簿记录查询">
      <DynSentence name="QryChkDtl">
         <Sentence>
            SELECT * FROM tipchkbok
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryChkDtl"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 对账明细查询 -->
   <Transaction code="918762" desc="对账明细查询">
      <DynSentence name="QryCBrkNo"><!--获取记录的国库关联行号-->
         <Sentence>
            SELECT CBrkNo FROM tipchkbok
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="GetChkRec"><!--查询明细记录信息-->
         <Sentence>
            SELECT OrgCod,EntDat,TraNo,ChkMod,ChkSts,POBkNo,ActNo,TxnAmt,TaxVID
            FROM tipchkrec
            WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            AND ('%s' = 'A' OR ChkSts='%s')
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|ChkOrd|ChkSts|ChkSts|</Fields>
      </DynSentence>
      <!--Quote name="GetBrkSQL"/-->     <!--根据网点号取分行号--> <!-- deleted by lyj 20090729 CQ76186 -->
      <Quote name="MSBrAuChk"/><!-- add by lyj 20090729 CQ76186 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
            <!--Quote name="GetBrkCTL"/--><!--获取分行号--> <!-- deleted by lyj 20090728 for CQ76186 -->
            <Exec func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="QryCBrkNo"/>
            </Exec>
            <!--If condition="IS_NOEQUAL_STRING($BrkNo,$CBrkNo)"--> <!-- deleted by lyj 20090728 for CQ76186 -->
               <!--Set>RspCod=910210</Set--><!--柜员非国库关联行柜员，交易拒绝-->
               <!--Return/>
            </If-->
            <!-- add by lyj at 20090728 for cq76186 begin -->
            <Set>OprNod=$CBrkNo</Set>
            <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
            <!-- add by lyj at 20090728 for cq76186 end -->
         </If>
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd"     value="GetChkRec"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!--接收人行自由报文-->
   <Transaction code="918731" desc="接收人行自由报文">
      <DynSentence name="GetBrkInf"><!--获取分行号-->
         <Sentence>
            SELECT BrkNo FROM tipbrkinf WHERE PBnkNo='%s'
         </Sentence>
         <Fields>ROrgCd|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:SetNoResponse"/>
         <Exec  func="PUB:IsExistNode">
            <Arg name="FieldName" value="ROrgCd"/>
         </Exec>
         <If condition="~RetCod=1">
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="GetBrkInf"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Return/>
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set><!--即使无记录，亦可继续流程-->
               <Set>BrkNo=XXXXXX</Set>
            </ElseIf>
         </If>
         <ElseIf condition="~RetCod=0">
            <Set>BrkNo=XXXXXX</Set>
         </ElseIf>
         <Set>FMgTyp=2</Set>
         <Set>WrkDat=$ActDat</Set>
         <Exec func="PUB:InsertRecord"><!--添加信息入自由报文记录表-->
            <Arg name="TblNam"  value="tipfmgrec"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 浏览自由报文 -->
   <Transaction code="918730" desc="浏览自由报文">
      <DynSentence name="QryFmgRec"><!--查询自由报文-->
         <Sentence>
            SELECT SndNod,RcvNod,SOrgCd,ROrgCd,Content FROM tipfmgrec
            WHERE BrkNo='%s' AND WrkDat='%s' AND FMgTyp='%s'
         </Sentence>
         <Fields>BrkNo|WrkDat|FMgTyp|</Fields>
      </DynSentence>
      <!--Quote name="GetBrkSQL"/--><!-- delete by ly 20090915 CQ87568 -->
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
            <If condition="IS_EQUAL_STRING($NodNo,315900)">
               <Set>BrkNo=XXXXXX</Set>
            </If>
            <Else>
               <!--Quote name="GetBrkCTL"/--><!--获取分行号--><!-- delete by ly 20090915 CQ87568 -->
                <!-- add by ly at 20090915 for CQ87568 begin -->
               <Set>OprNod=$OprBr</Set>
               <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
               <Set>BrkNo=$OprBr</Set>
               <!-- add by ly at 20090915 for CQ87568 end -->
            </Else>
         </If>
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd"        value="QryFmgRec"/>
            <Arg name="RecNumPerPage" value="10"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!--发送人行自由报文-->
   <Transaction code="918735" desc="发送人行自由报文">
      <DynSentence name="GetPBnkNo"><!--获取清算行号-->
         <Sentence>
            SELECT PBnkNo FROM tipbrkinf WHERE BrkNo='%s'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetRcvNodORG"><!--从征收机关表获取接收节点号-->
         <Sentence>
            SELECT NodCod FROM tiporginf WHERE OrgCod='%s'
         </Sentence>
         <Fields>ROrgCd|</Fields>
      </DynSentence>
      <DynSentence name="GetRcvNodTRE"><!--从国库表获取接收节点号-->
         <Sentence>
            SELECT NodCod FROM tiptreinf WHERE TreCod='%s'
         </Sentence>
         <Fields>ROrgCd|</Fields>
      </DynSentence>
      <DynSentence name="ChkNodSts"><!--检查节点状态-->
         <Sentence>
            SELECT Status FROM tipnodinf WHERE NodCod='%s'
         </Sentence>
         <Fields>NodCod|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>WrkDat=$ActDat</Set>
         <Set>SndNod=$SrcNod</Set>
         <Quote name="GetBrkCTL"/><!--获取分行号-->
         <Exec func="PUB:ReadRecord"><!--获取清算行号-->
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>
         <Set>SOrgCd=$PBnkNo</Set>
         <If condition="$DstTyp=1">
            <Exec func="PUB:ReadRecord"><!--从征收机关表获取接收节点号-->
               <Arg name="SqlCmd" value="GetRcvNodORG"/>
            </Exec>
         </If>
         <Else>
            <Exec func="PUB:ReadRecord"><!--从国库表获取接收节点号-->
               <Arg name="SqlCmd" value="GetRcvNodTRE"/>
            </Exec>
         </Else>
         <Exec func="PUB:ReadRecord"><!--检查节点状态-->
            <Arg name="SqlCmd" value="ChkNodSts"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>
         <If condition="$Status=0">
            <Set>RcvNod=$NodCod</Set>
         </If>
         <Else>
            <Set>RspCod=910211</Set><!--节点状态异常-->
            <Return/>
         </Else>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:CallThirdOther"><!--向人行发送自由报文-->
            <Arg name="HTxnCd" value="9105toPBC"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="~RetCod=0">
            <Set>FMgTyp=1</Set>
            <Set>MsgNo=9105</Set>
            <Exec func="PUB:InsertRecord"><!--添加信息入自由报文记录表-->
               <Arg name="TblNam"  value="tipfmgrec"/>
            </Exec>
         </If>
      </FlowCtrl>
   </Transaction>
   <!-- 对账差错清单打印 -->
   <Transaction code="918740" desc="对账差错清单打印">
      <DynSentence name="QryChkRec"><!--查询登记对账簿记录-->
         <Sentence>
            SELECT CBrkNo,RBrkNo,ChkDat,ChkOrd,AllNum,AllAmt,ChkMod,ChkSts,RknSts
            FROM tipchkbok
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="QryRBnkNm"><!--获取清算国库支付行名称及清算国库代码-->
         <Sentence>
            SELECT RBnkNm,RTreNo FROM tiptrerkn WHERE RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="QryCBrkNm"><!--获取国库关联行名称-->
         <Sentence>
            SELECT BrkNam CBrkNm FROM tipbrkinf
            WHERE BrkNo='%s' AND RltFlg='1'
         </Sentence>
         <Fields>CBrkNo|</Fields>
      </DynSentence>
      <DynSentence name="QryRBrkNm"><!--获取清算行名称-->
         <Sentence>
            SELECT BrkNam RBrkNm FROM tipbrkinf
            WHERE BrkNo='%s' AND RknFlg='1'
         </Sentence>
         <Fields>RBrkNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>
      <Quote name="MSBrAuChk"/><!-- add by lyj 20090729 CQ76186 -->
      <DynSentence name="QryChkExist"><!--判断是否存在人行长款记录-->
         <Sentence>
            SELECT 'Y' YN FROM table(values(1)) as anony
            WHERE exists(SELECT * FROM tipchkrec
            WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s'
            AND ChkOrd='%s' AND ChkSts='2')
         </Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnExistA"><!--判断是否存在系统长款记录-->
         <Sentence>
            SELECT 'Y' YN FROM table(values(1)) as anony
            WHERE exists(SELECT * FROM tiptxnbok
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s'
            AND ChkOrd='%s' AND ChkSts='2')
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnExistB"><!--判断是否存在关键信息核对不符记录-->
         <Sentence>
            SELECT 'Y' YN FROM table(values(1)) as anony
            WHERE exists(SELECT * FROM tiptxnbok
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s'
            AND ChkOrd='%s' AND ChkSts='3')
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnExistC"><!--判断是否存在隔日未核对统计信息-->
         <Sentence>
            SELECT 'Y' YN FROM table(values(1)) as anony
            WHERE exists(SELECT * FROM tiptxnbok
            WHERE PBnkNo='%s' AND BilSts='1'
            AND ChkSts='0' AND RspDat &lt; '%s')
         </Sentence>
         <Fields>PBnkNo|ChkDat|</Fields>
      </DynSentence>
      <DynSentence name="GetPbc"><!--获取人行差错数据-->
         <Sentence>
            SELECT coalesce(COUNT(*),0) PbcENm,
            coalesce(SUM(CAST(TxnAmt AS BIGINT)),0) PbcEAt
            FROM tipchkrec
            WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s' AND ChkSts='2'
         </Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="GetTip"><!--获取系统差错数据-->
         <Sentence>
            SELECT coalesce(COUNT(*),0) TipENm,
            coalesce(SUM(CAST(TxnAmt AS BIGINT)),0) TipEAt
            FROM tiptxnbok
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            AND ChkSts IN ('2','3')
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="GetMyInf"><!--获取我行总笔数总金额-->
         <Sentence>
            SELECT coalesce(COUNT(*),0) MyBCnt,
            coalesce(SUM(CAST(TxnAmt AS BIGINT)),0) MyBAmt
            FROM tiptxnbok
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            AND BilSts='1'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord"><!--查询登记对账簿记录-->
            <Arg name="SqlCmd" value="QryChkRec"/>
         </Exec>
         <Quote name="GetBrkCTL"/><!--获取分行号-->
         <!--If condition="IS_NOEQUAL_STRING($CBrkNo,$BrkNo)"> 
            <Set>RspCod=910210</Set>
            <Return/>
         </If--> <!-- deleted by lyj 20090728 for CQ76186 -->
         <!-- add by lyj at 20090728 for cq76186 begin -->
         <Set>OprNod=$CBrkNo</Set>
         <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
         <!-- add by lyj at 20090728 for cq76186 end -->
         <Set>CtrNod=STRCAT(SUBSTR($NodNo,1,3),800)</Set>
         <If condition="IS_NOEQUAL_STRING($CtrNod,$NodNo)">
            <Set>RspCod=910210</Set>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord"><!--获取清算国库支付行名称及清算国库代码-->
            <Arg name="SqlCmd" value="QryRBnkNm"/>
         </Exec>
         <Exec func="PUB:ReadRecord"><!--获取国库关联行名称-->
            <Arg name="SqlCmd" value="QryCBrkNm"/>
         </Exec>
         <Exec func="PUB:ReadRecord"><!--获取清算行名称-->
            <Arg name="SqlCmd" value="QryRBrkNm"/>
         </Exec>
         <Set>AAA=$CBrkNm</Set><!--查错用-->
         <Set>BBB=$RBrkNm</Set>
         <Exec func="PUB:ReadRecord"><!--获取我行总笔数总金额-->
            <Arg name="SqlCmd" value="GetMyInf"/>
         </Exec>
         <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"></Arg>
            <Arg name="SourNam" value="ChkSts"></Arg>
            <Arg name="DestNam" value="CChkSts"></Arg>
            <Arg name="TblNam" value="ChkStsTrans"></Arg>
         </Exec>
         <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"></Arg>
            <Arg name="SourNam" value="RknSts"></Arg>
            <Arg name="DestNam" value="CRknSts"></Arg>
            <Arg name="TblNam" value="RknStsTrans"></Arg>
         </Exec>
         <Set>FilNam=STRCAT(TIPCHKERR,$CBrkNo,GETDATETIME())</Set><!--测试暂定值--> <!-- modified by lyj 20090730 CQ76186 -->
         <Set>FilCon=\\n</Set>
         <Set>FilCon=STRCAT($FilCon,                                                               财  税  库  对  账  差  错  清  单                                                               ,\\n)</Set>
         <Set>FilCon=STRCAT($FilCon,\\n)</Set>
         <Set>FilCon=STRCAT($FilCon,ADDCHAR(  清算国库支付行号：,20, ,0),ADDCHAR($RBnkNo,20, ,0),ADDCHAR(清算国库代码：,20, ,0),ADDCHAR($RTreNo,60, ,0),ADDCHAR(清算国库名称：,20, ,0),ADDCHAR($RBnkNm,60, ,0),\\n)</Set>
         <Set>FilCon=STRCAT($FilCon,ADDCHAR(  国库关联行行号：,20, ,0),ADDCHAR($CBrkNo,20, ,0),ADDCHAR(国库关联行名称：,20, ,0),ADDCHAR($CBrkNm,60, ,0),ADDCHAR(行内清算行行号：,20, ,0),ADDCHAR($RBrkNo,20, ,0),ADDCHAR(行内清算行名称：,20, ,0),ADDCHAR($RBrkNm,60, ,0),\\n)</Set>
         <Set>FilCon=STRCAT($FilCon,  ,ADDCHAR(对账日期：,12, ,0),ADDCHAR($ChkDat,30, ,0),ADDCHAR(对账批次：,20, ,0),ADDCHAR($ChkOrd,30, ,0),ADDCHAR(对账结果：,20, ,0),ADDCHAR($CChkSts,30, ,0),ADDCHAR(清算结果：,20, ,0),ADDCHAR($CRknSts,30, ,0),\\n)</Set>
         <Set>FilCon=STRCAT($FilCon,  ,ADDCHAR(人行总笔数：,12, ,0),ADDCHAR($AllNum,30, ,0),ADDCHAR(人行总金额：,20, ,0),ADDCHAR(AMTFMT($AllAmt),30, ,0),ADDCHAR(我行总笔数：,20, ,0),ADDCHAR($MyBCnt,30, ,0),ADDCHAR(我行总金额：,20, ,0),ADDCHAR(AMTFMT($MyBAmt),30, ,0),\\n)</Set>
         <Set>FilCon=STRCAT($FilCon,\\n)</Set>
         <Exec func="PUB:WriteFile">
            <Arg name="FileName" value="STRCAT(dat/term/send/,$FilNam)"/>
            <Arg name="OpenMode" value="a"/>
            <Arg name="ESCFMT"   value="$FilCon"/>
         </Exec>
         <Exec func="PUB:ReadRecord" error="IGNORE"><!--判断有没人行长款记录-->
            <Arg name="SqlCmd" value="QryChkExist"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
            <Set>FilCon=STRCAT(ADDCHAR(  没有“人行多”记录,80, ,0),\\n)</Set>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a"/>
               <Arg name="ESCFMT"   value="$FilCon"/>
            </Exec>
         </ElseIf>
         <Else>
            <Set>TempFilNam1=TempFile1</Set><!--表一-->
            <Exec func="PUB:GenerateReport"><!--生成对账差错报表――人行长款记录-->
               <Arg name="RptName" value="STRCAT(dat/term/send/,$TempFilNam1)"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP01_RPT.XML)"/>
               <Arg name="RBnkNo"  value="$RBnkNo"/>
               <Arg name="PBnkNo"  value="$PBnkNo"/>
               <Arg name="ChkDat"  value="$ChkDat"/>
               <Arg name="ChkOrd"  value="$ChkOrd"/>
            </Exec>
            <System command="cat" >
               <Arg name="SrcFile" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$TempFilNam1)"/>
               <Arg name="cat"     value="&gt;&gt;"/>
               <Arg name="ObjFil"  value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            </System>
         </Else>
         <Exec func="PUB:ReadRecord" error="IGNORE"><!--判断有没系统长款记录-->
            <Arg name="SqlCmd" value="QryTxnExistA"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
            <Set>FilCon=STRCAT(ADDCHAR(  没有“我行多”记录,80, ,0),\\n)</Set>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a"/>
               <Arg name="ESCFMT"   value="$FilCon"/>
            </Exec>
         </ElseIf>
         <Else>
            <Set>TempFilNam2=TempFile2</Set><!--表二-->
            <Exec func="PUB:GenerateReport"><!--生成对账差错报表――系统长款记录-->
               <Arg name="RptName" value="STRCAT(dat/term/send/,$TempFilNam2)"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP02_RPT.XML)"/>
               <Arg name="RBnkNo"  value="$RBnkNo"/>
               <Arg name="PBnkNo"  value="$PBnkNo"/>
               <Arg name="ChkDat"  value="$ChkDat"/>
               <Arg name="ChkOrd"  value="$ChkOrd"/>
            </Exec>
            <System command="cat" >
               <Arg name="SrcFile" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$TempFilNam2)"/>
               <Arg name="cat"     value="&gt;&gt;"/>
               <Arg name="ObjFil"  value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            </System>
         </Else>
         <Exec func="PUB:ReadRecord" error="IGNORE"><!--判断有没关键信息核对不符记录-->
            <Arg name="SqlCmd" value="QryTxnExistB"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
            <Set>FilCon=STRCAT(ADDCHAR(  没有“明细要素不符”记录,80, ,0),\\n)</Set>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a"/>
               <Arg name="ESCFMT"   value="$FilCon"/>
            </Exec>
         </ElseIf>
         <Else>
            <Set>TempFilNam5=TempFile3</Set><!--表三-->
            <Exec func="PUB:GenerateReport"><!--生成对账差错报表――关键信息核对不符记录-->
               <Arg name="RptName" value="STRCAT(dat/term/send/,$TempFilNam5)"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP03_RPT.XML)"/>
               <Arg name="RBnkNo"  value="$RBnkNo"/>
               <Arg name="PBnkNo"  value="$PBnkNo"/>
               <Arg name="ChkDat"  value="$ChkDat"/>
               <Arg name="ChkOrd"  value="$ChkOrd"/>
            </Exec>
            <System command="cat" >
               <Arg name="SrcFile" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$TempFilNam5)"/>
               <Arg name="cat"     value="&gt;&gt;"/>
               <Arg name="ObjFil"  value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            </System>
         </Else>
         <Exec func="PUB:ReadRecord" error="IGNORE"><!--判断是否存在隔日未核对统计信息-->
            <Arg name="SqlCmd" value="QryTxnExistC"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
            <Set>FilCon=STRCAT(ADDCHAR(  没有“未核对统计信息”记录,80, ,0),\\n)</Set>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a"/>
               <Arg name="ESCFMT"   value="$FilCon"/>
            </Exec>
         </ElseIf>
         <Else>
            <Set>TempFilNam6=TempFile4</Set><!--表四-->
            <Exec func="PUB:GenerateReport"><!--生成对账差错报表――未核对统计信息-->
               <Arg name="RptName" value="STRCAT(dat/term/send/,$TempFilNam6)"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP05_RPT.XML)"/>
               <Arg name="PBnkNo"  value="$PBnkNo"/>
               <Arg name="ChkDat"  value="$ChkDat"/>
               <Arg name="TlrId"   value="$TlrId"/>
               <Arg name="NodNo"   value="$NodNo"/>
            </Exec>
            <System command="cat" >
               <Arg name="SrcFile" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$TempFilNam6)"/>
               <Arg name="cat"     value="&gt;&gt;"/>
               <Arg name="ObjFil"  value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            </System>
         </Else>
         <Exec func="PUB:ReadRecord"><!--获取人行差错数据-->
            <Arg name="SqlCmd" value="GetPbc"/>
         </Exec>
         <Exec func="PUB:ReadRecord"><!--获取系统差错数据-->
            <Arg name="SqlCmd" value="GetTip"/>
         </Exec>
         <Set>MsgSmr=STRCAT($NodNo,对账差错清单)</Set>
         <Exec func="PUB:SendFileToOther">
            <Arg name="MsgTyp" value="4"/>
            <Arg name="ObjNod" value="$BrkNo"/>
            <Arg name="BusTyp" value="CM"/>
            <Arg name="AplCod" value="999999"/>
            <Arg name="FilNam" value="$FilNam"/>
            <Arg name="Summary" value="$MsgSmr"/>
            <Arg name="ObjTlr" value="$TlrId"/>
         </Exec>
<!--
         <Exec func="PUB:SendFileToOther">
         <Arg name="MsgTyp" value="3"/>
         <Arg name="ObjNod" value="$BrkNo"/>
         <Arg name="BusTyp" value="EB"/>
         <Arg name="AplCod" value="910000"/>
         <Arg name="FilNam" value="$FilNam"/>
         <Arg name="Summary" value="$MsgSmr"/>
         <Arg name="ObjTlr" value="$TlrId"/>
         </Exec>
         <Exec func="PUB:CodeSwitching">
         <Arg name="DatSrc" value="TIPCSW"></Arg>
         <Arg name="SourNam" value="BrkNo"></Arg>
         <Arg name="DestNam" value="SRN"></Arg>
         <Arg name="TblNam" value="Cod2SRN"></Arg>
         </Exec>
         <Set>@MSG.SRN=$SRN</Set>
         <Exec func="PUB:CallLocal">
         <Arg name="TxnCod" value="910290" />
         <Arg name="ObjSvr" value="OFRTTIP5"/>
         </Exec>
         <Delete>@MSG.SRN</Delete>
         -->
      </FlowCtrl>
   </Transaction>
   <!-- 业务提示通知清单打印 -->
   <Transaction code="918800" desc="业务提示通知清单打印">
      <DynSentence name="GetRecNum"><!--统计记录数-->
         <Sentence>
            SELECT coalesce(COUNT(*),0) RecNum FROM tipbusnty WHERE BrkNo='%s' AND ActDat='%s'
         </Sentence>
         <Fields>BrkNo|QryDat|</Fields>
      </DynSentence>
      <DynSentence name="GetBrkNam"><!--获取分行名称-->
         <Sentence>
            SELECT BrkNam FROM tipbrkinf WHERE BrkNo='%s' AND RLtFlg='1'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>CtrNod=STRCAT(SUBSTR($NodNo,1,3),800)</Set>
         <If condition="IS_NOEQUAL_STRING($CtrNod,$NodNo)">
            <Set>RspCod=910210</Set><!--柜员不属于所查询分行帐务中心柜员，交易拒绝-->
            <Return/>
         </If>
         <!-- add by ly at 20090915 for CQ87568 begin -->
         <Quote name="GetBrkCTL"/>         
         <Set>OprNod=$OprBr</Set>
         <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
         <Set>BrkNo=$OprBr</Set>
         <!-- add by ly at 20090915 for CQ87568 end -->
         <Exec func="PUB:GetLogNo"/>
         <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
         <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,授权柜员:,$Sup1Id,备注:业务提示通知清单打印)</Set>
         <Set>TTxnCd=915880</Set>
         <Exec func="PUB:CallHostOther"><!--产生非会计流水-->
            <Arg name="TxnCod" value="915880" />
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>
         <!--Quote name="GetBrkCTL"/-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetRecNum"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>
         <If condition="IS_EQUAL_STRING($RecNum,0)">
            <Set>MsgTyp=N</Set>
            <Set>RecNum=000</Set>
            <Set>RspCod=000000</Set>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkNam"/>
         </Exec>
         <Set>FilNam=STRCAT(TIPNOTIFY,$BrkNo,GETDATETIME())</Set>
         <Exec func="PUB:GenerateReport">
            <Arg name="RptName" value="STRCAT(dat/term/send/,$FilNam)"/>
            <Arg name="RptFile" value="STRCAT(etc/,TIP04_RPT.XML)"/>
            <Arg name="BrkNo"   value="$BrkNo"/>
            <Arg name="QryDat"  value="$QryDat"/>
            <Arg name="BrkNam"  value="$BrkNam"/>
            <Arg name="ActDat"  value="$ActDat"/>
            <Arg name="TlrId"   value="$TlrId"/>
            <Arg name="NodNo"   value="$NodNo"/>
         </Exec>
         <Set>MsgSmr=STRCAT($NodNo,业务提示通知)</Set>
         <Exec func="PUB:SendFileToOther">
            <Arg name="MsgTyp" value="4"/>
            <Arg name="ObjNod" value="$BrNo"/> <!-- modified by ly 20090915 CQ87568 -->
            <Arg name="BusTyp" value="CM"/>
            <Arg name="AplCod" value="999999"/>
            <Arg name="FilNam" value="$FilNam"/>
            <Arg name="Summary" value="$MsgSmr"/>
            <Arg name="ObjTlr" value="$TlrId"/>
         </Exec>
<!--
         <Exec func="PUB:SendFileToOther">
         <Arg name="MsgTyp" value="3"/>
         <Arg name="ObjNod" value="$BrkNo"/>
         <Arg name="BusTyp" value="EB"/>
         <Arg name="AplCod" value="910000"/>
         <Arg name="FilNam" value="$FilNam"/>
         <Arg name="Summary" value="$MsgSmr"/>
         <Arg name="ObjTlr" value="$TlrId"/>
         </Exec>
         <Exec func="PUB:CodeSwitching">
         <Arg name="DatSrc" value="TIPCSW"></Arg>
         <Arg name="SourNam" value="BrkNo"></Arg>
         <Arg name="DestNam" value="SRN"></Arg>
         <Arg name="TblNam" value="Cod2SRN"></Arg>
         </Exec>
         <Set>@MSG.SRN=$SRN</Set>
         <Exec func="PUB:CallLocal">
         <Arg name="TxnCod" value="910290" />
         <Arg name="ObjSvr" value="OFRTTIP5"/>
         </Exec>
         <Delete>@MSG.SRN</Delete>
         -->
      </FlowCtrl>
   </Transaction>
   <!-- 国库清算行数据维护 -->
   <Transaction code="915150" desc="国库清算行数据维护">
      <DynSentence name="UpdTreRkn"><!--修改-->
         <Sentence>
            RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="DelTreRkn"><!--删除-->
         <Sentence>
            DELETE FROM tiptrerkn WHERE RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTreRkn"><!--查询-->
         <Sentence>
            SELECT * FROM tiptrerkn WHERE RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Switch expression="$OprTyp">
            <Case value="1"><!--新增-->
               <Exec func="PUB:AddAuthReason" ><!--添加授权原因-->
                  <Arg name="AthCod" value="70" /><!--70-->
                  <Arg name="AthMsg" value="910223" />
               </Exec>
               <Exec  func="PUB:CheckHostAuth" ><!--授权-->
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               <!--去掉授权信息-->
               <!--Set>TIATyp=T</Set>
               <Set>AthLvl=00</Set>
               <Set>Sup1Id=       </Set>
               <Set>Sup2Id=       </Set>
               <Set>Sup1Pw=      </Set>
               <Set>Sup2Pw=      </Set>
               <Set>Sup1Dv=0</Set>
               <Set>Sup1Dv=0</Set>
               <Set>AthTbl=      </Set-->
               <Set>TTxnCd=915880</Set>
               <Exec func="PUB:GetLogNo"/>
               <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
               <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,授权柜员:,$Sup1Id,备注:清算国库数据维护-新增)</Set>
               <Exec func="PUB:CallHostOther">
                  <Arg name="TxnCod" value="915880" />
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Return/>
               </If>
               <Set>NtckNo=STRCAT(9,$TckNo)</Set>
               <Set>EffDat=$ActDat</Set>
               <Exec func="PUB:InsertRecord">
                  <Arg name="TblNam" value="tiptrerkn"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="2"><!--修改-->
               <Exec func="PUB:AddAuthReason" ><!--添加授权原因-->
                  <Arg name="AthCod" value="70" /><!--70-->
                  <Arg name="AthMsg" value="910223" />
               </Exec>
               <Exec  func="PUB:CheckHostAuth" ><!--授权-->
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               <!--去掉授权信息-->
               <!--Set>TIATyp=T</Set>
               <Set>AthLvl=00</Set>
               <Set>Sup1Id=       </Set>
               <Set>Sup2Id=       </Set>
               <Set>Sup1Pw=      </Set>
               <Set>Sup2Pw=      </Set>
               <Set>Sup1Dv=0</Set>
               <Set>Sup1Dv=0</Set>
               <Set>AthTbl=      </Set-->
               <Set>TTxnCd=915880</Set>
               <Exec func="PUB:GetLogNo"/>
               <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
               <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,授权柜员:,$Sup1Id,备注:清算国库数据维护-修改)</Set>
               <Exec func="PUB:CallHostOther">
                  <Arg name="TxnCod" value="915880" />
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Return/>
               </If>
               <Set>NtckNo=STRCAT(9,$TckNo)</Set>
               <Exec func="PUB:UpdateRecord">
                  <Arg name="TblNam"  value="tiptrerkn"/>
                  <Arg name="CndSts"  value="UpdTreRkn"/>
               </Exec>
               <Exec func="PUB:CommitWork"/>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="QryTreRkn"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="3"><!--删除-->
               <Exec func="PUB:AddAuthReason" ><!--添加授权原因-->
                  <Arg name="AthCod" value="70" /><!--70-->
                  <Arg name="AthMsg" value="910223" />
               </Exec>
               <Exec  func="PUB:CheckHostAuth" ><!--授权-->
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               <!--去掉授权信息-->
               <!--Set>TIATyp=T</Set>
               <Set>AthLvl=00</Set>
               <Set>Sup1Id=       </Set>
               <Set>Sup2Id=       </Set>
               <Set>Sup1Pw=      </Set>
               <Set>Sup2Pw=      </Set>
               <Set>Sup1Dv=0</Set>
               <Set>Sup1Dv=0</Set>
               <Set>AthTbl=      </Set-->
               <Set>TTxnCd=915880</Set>
               <Exec func="PUB:GetLogNo"/>
               <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
               <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,授权柜员:,$Sup1Id,备注:清算国库数据维护-删除)</Set>
               <Exec func="PUB:CallHostOther">
                  <Arg name="TxnCod" value="915880" />
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Return/>
               </If>
               <Set>NtckNo=STRCAT(9,$TckNo)</Set>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="QryTreRkn"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="DelTreRkn"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="4"><!--查询-->
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="QryTreRkn"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>
   <!-- 上线行数据维护 -->
   <Transaction code="915160" desc="上线行数据维护">
      <DynSentence name="UpdBrkInf"><!--修改-->
         <Sentence>
            BrkNo='%s'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <DynSentence name="DelBrkInf"><!--删除-->
         <Sentence>
            DELETE FROM tipbrkinf WHERE BrkNo='%s'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <DynSentence name="QryBrkInf"><!--查询-->
         <Sentence>
            SELECT * FROM tipbrkinf WHERE BrkNo='%s'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkPBKExist"><!--查询清算行标志及支付行号是否重复-->
         <Sentence>
            SELECT 'Y' YN  FROM TABLE(VALUES(1)) AS anony
            WHERE EXISTS (SELECT * FROM tipbrkinf
            WHERE RknFlg='1' AND PBnkNo='%s' AND BrkNo&lt;&gt;'%s')
         </Sentence>
         <Fields>PBnkNo|BrkNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Switch expression="$OprTyp">
            <Case value="1"><!--新增-->
               <Exec func="PUB:AddAuthReason" ><!--添加授权原因-->
                  <Arg name="AthCod" value="70" /><!--70-->
                  <Arg name="AthMsg" value="910224" />
               </Exec>
               <Exec  func="PUB:CheckHostAuth" ><!--授权-->
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               <If condition="$RknFlg=1">
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                     <Arg name="SqlCmd" value="ChkPBKExist"/>
                  </Exec>
                  <If condition="~RetCod!=-2"><!--配置错误-->
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=支付清算行号已被其他清算行使用</Set>
                     <Return/>
                  </If>
               </If>
               <Set>RspCod=000000</Set>
               <!--去掉授权信息-->
               <!--Set>TIATyp=T</Set>
               <Set>AthLvl=00</Set>
               <Set>Sup1Id=       </Set>
               <Set>Sup2Id=       </Set>
               <Set>Sup1Pw=      </Set>
               <Set>Sup2Pw=      </Set>
               <Set>Sup1Dv=0</Set>
               <Set>Sup1Dv=0</Set>
               <Set>AthTbl=      </Set-->
               <Set>TTxnCd=915880</Set>
               <Exec func="PUB:GetLogNo"/>
               <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
               <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,授权柜员:,$Sup1Id,备注:上线行数据维护-新增)</Set>
               <Exec func="PUB:CallHostOther">
                  <Arg name="TxnCod" value="915880" />
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Return/>
               </If>
               <Set>NtckNo=STRCAT(9,$TckNo)</Set>
               <Set>EffDat=$ActDat</Set>
               <Exec func="PUB:InsertRecord">
                  <Arg name="TblNam" value="tipbrkinf"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="2"><!--修改-->
               <Exec func="PUB:AddAuthReason" ><!--添加授权原因-->
                  <Arg name="AthCod" value="70" /><!--70-->
                  <Arg name="AthMsg" value="910224" />
               </Exec>
               <Exec  func="PUB:CheckHostAuth" ><!--授权-->
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               <If condition="$RknFlg=1">
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                     <Arg name="SqlCmd" value="ChkPBKExist"/>
                  </Exec>
                  <If condition="~RetCod!=-2"><!--配置错误-->
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=支付清算行号已被其他清算行使用</Set>
                     <Return/>
                  </If>
               </If>
               <Set>RspCod=000000</Set>
               <!--去掉授权信息-->
               <!--Set>TIATyp=T</Set>
               <Set>AthLvl=00</Set>
               <Set>Sup1Id=       </Set>
               <Set>Sup2Id=       </Set>
               <Set>Sup1Pw=      </Set>
               <Set>Sup2Pw=      </Set>
               <Set>Sup1Dv=0</Set>
               <Set>Sup1Dv=0</Set>
               <Set>AthTbl=      </Set-->
               <Set>TTxnCd=915880</Set>
               <Exec func="PUB:GetLogNo"/>
               <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
               <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,授权柜员:,$Sup1Id,备注:上线行数据维护-修改)</Set>
               <Exec func="PUB:CallHostOther">
                  <Arg name="TxnCod" value="915880" />
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Return/>
               </If>
               <Set>NtckNo=STRCAT(9,$TckNo)</Set>
               <Exec func="PUB:UpdateRecord">
                  <Arg name="TblNam"  value="tipbrkinf"/>
                  <Arg name="CndSts"  value="UpdBrkInf"/>
               </Exec>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="QryBrkInf"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="3"><!--删除-->
               <Exec func="PUB:AddAuthReason" ><!--添加授权原因-->
                  <Arg name="AthCod" value="70" /><!--70-->
                  <Arg name="AthMsg" value="910224" />
               </Exec>
               <Exec  func="PUB:CheckHostAuth" ><!--授权-->
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               <!--去掉授权信息-->
               <!--Set>TIATyp=T</Set>
               <Set>AthLvl=00</Set>
               <Set>Sup1Id=       </Set>
               <Set>Sup2Id=       </Set>
               <Set>Sup1Pw=      </Set>
               <Set>Sup2Pw=      </Set>
               <Set>Sup1Dv=0</Set>
               <Set>Sup1Dv=0</Set>
               <Set>AthTbl=      </Set-->
               <Set>TTxnCd=915880</Set>
               <Exec func="PUB:GetLogNo"/>
               <Set>Time=GETDATETIME(YYYY-MM-DD HH:MI:SS)</Set>
               <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,授权柜员:,$Sup1Id,备注:上线行数据维护-删除)</Set>
               <Exec func="PUB:CallHostOther">
                  <Arg name="TxnCod" value="915880" />
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <Return/>
               </If>
               <Set>NtckNo=STRCAT(9,$TckNo)</Set>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="QryBrkInf"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="DelBrkInf"/>
               </Exec>
               <Break/>
            </Case>
            <Case value="4"><!--查询-->
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="QryBrkInf"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>
   <!-- 批扣登记簿模糊查询 -->
   <Transaction code="918810" desc="批扣登记簿模糊查询">
      <DynSentence name="GetBatInf"><!--批扣登记簿模糊查询-->
         <Sentence>
            SELECT OrgCod,EntDat,SPckNo,Status,AllNum,AllAmt
            FROM tipbatbok
            WHERE ('%s' = '' OR OrgCod='%s')
            AND (('%s' = '' AND '%s' = '') OR EntDat BETWEEN '%s' AND '%s')
            AND (('%s' = '' AND '%s' = '') OR SPckNo BETWEEN '%s' AND '%s')
            AND ('%s' = 'A' OR RBrkNo='%s') AND ('%s' = 'B' OR CBrkNo='%s')
            AND (ReqDat='%s' OR '%s'='')
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|OrgCod|BEntDt|EEntDt|BEntDt|EEntDt|BPckNo|EPckNo|BPckNo|EPckNo|RBrkNo|RBrkNo|CBrkNo|CBrkNo|ReqDat|ReqDat|</Fields>
      </DynSentence>
      <!--Quote name="GetBrkSQL"/--><!-- delete by ly 20090915 CQ87568 -->
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
            <!--Quote name="GetBrkCTL"/--><!--获取分行号--><!-- delete by ly 20090915 CQ87568 -->
            <!-- add by ly at 20090915 for CQ87568 begin -->
            <Set>OprNod=$OprBr</Set>
            <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
            <Set>BrkNo=$OprBr</Set>
            <!-- add by ly at 20090915 for CQ87568 end -->
            <Set>RBrkNo=A</Set>
            <Set>CBrkNo=B</Set>
            <Switch expression="$BrkTyp">
               <Case value="1">
                  <Set>RBrkNo=$BrkNo</Set>
                  <Break/>
               </Case>
               <Case value="2">
                  <Set>CBrkNo=$BrkNo</Set>
                  <Break/>
               </Case>
            </Switch>
         </If>
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd"     value="GetBatInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 批扣登记簿记录查询 -->
   <Transaction code="918815" desc="批扣登记簿记录查询">
      <DynSentence name="QryBatDtl">
         <Sentence>
            SELECT * FROM tipbatbok
            WHERE OrgCod='%s' AND EntDat='%s' AND SPckNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryBatDtl"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 浏览征收机关信息 -->
   <Transaction code="918780" desc="浏览征收机关信息">
      <DynSentence name="QryOrgInf">
         <Sentence>
            SELECT a.OrgCod,a.OrgNam,a.OrgTyp,a.NodCod,b.Status
            FROM tiporginf a,tipnodinf b
            WHERE (OrgCod LIKE '%s') AND b.NodCod=a.NodCod
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>OrgCod=STRCAT($OrgCod,\%)</Set>
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd" value="QryOrgInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 查询征收机关信息 -->
   <Transaction code="918785" desc="查询征收机关信息">
      <DynSentence name="GetOrgInf">
         <Sentence>
            SELECT * FROM tiporginf WHERE OrgCod='%s'
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <DynSentence name="GetNodInf">
         <Sentence>
            SELECT Status FROM tipnodinf WHERE NodCod='%s'
         </Sentence>
         <Fields>NodCod|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetOrgInf"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetNodInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 浏览国库信息 -->
   <Transaction code="918790" desc="浏览国库信息">
      <DynSentence name="QryTreInf">
         <Sentence>
            SELECT a.TreCod,a.TreNam,a.TreLev,a.NodCod,b.Status
            FROM tiptreinf a,tipnodinf b
            WHERE (TreCod LIKE '%s') AND b.NodCod=a.NodCod
         </Sentence>
         <Fields>TreCod|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>TreCod=STRCAT($TreCod,\%)</Set>
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd" value="QryTreInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 查询国库信息 -->
   <Transaction code="918795" desc="查询国库信息">
      <DynSentence name="GetTreInf">
         <Sentence>
            SELECT * FROM tiptreinf WHERE TreCod='%s'
         </Sentence>
         <Fields>TreCod|</Fields>
      </DynSentence>
      <DynSentence name="GetNodInf">
         <Sentence>
            SELECT Status FROM tipnodinf WHERE NodCod='%s'
         </Sentence>
         <Fields>NodCod|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTreInf"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetNodInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 冲正登记簿模糊查询 -->
   <Transaction code="918770" desc="冲正登记簿模糊查询">
      <DynSentence name="GetRvsInf">
         <Sentence>
            SELECT OOrgCod,OEntDat,OTraNo,CnlNo,CnlSts,CnlRsn,FTxnTm
            FROM tiprvsbok
            WHERE ('%s' = '' OR OOrgCod='%s')
            AND (('%s' = '' AND '%s' = '') OR OEntDat BETWEEN '%s' AND '%s')
            AND (CBrkNo='%s' OR CBrkNo='XXXXXX')
         </Sentence>
         <Fields>OrgCod|OrgCod|BEntDt|EEntDt|BEntDt|EEntDt|BrkNo|</Fields>
      </DynSentence>
      <!--Quote name="GetBrkSQL"/--><!-- delete by ly 20090915 CQ87568 -->
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--Quote name="GetBrkCTL"/--><!--获取分行号--><!-- delete by ly 20090915 CQ87568 -->
         <!-- add by ly at 20090915 for CQ87568 begin -->
         <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
           <Set>OprNod=$OprBr</Set>
           <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
           <Set>BrkNo=$OprBr</Set>
         </If>
         <!-- add by ly at 20090915 for CQ87568 end -->
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd" value="GetRvsInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!-- 止付登记簿模糊查询 -->
   <Transaction code="918775" desc="止付登记簿模糊查询">
      <DynSentence name="GetStpInf">
         <Sentence>
            SELECT OrgCod,EntDat,StopNo,StopTyp,OEntDat,OPackNo,OTraNo,StpAsw,ChkSts,StopRsn,AddWord,FTxnTm
            FROM tipstpbok
            WHERE ('%s' = '' OR OrgCod='%s')
            AND (('%s' = '' AND '%s' = '') OR EntDat BETWEEN '%s' AND '%s')
            AND (CBrkNo='%s' OR CBrkNo='XXXXXX')
         </Sentence>
         <Fields>OrgCod|OrgCod|BEntDt|EEntDt|BEntDt|EEntDt|BrkNo|</Fields>
      </DynSentence>
      <!--Quote name="GetBrkSQL"/--><!-- delete by ly 20090915 CQ87568 -->
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--Quote name="GetBrkCTL"/--><!--获取分行号--><!-- delete by ly 20090915 CQ87568 -->
         <!-- add by ly at 20090915 for CQ87568 begin -->
         <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
           <Set>OprNod=$OprBr</Set>
           <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
           <Set>BrkNo=$OprBr</Set>
         </If>
         <!-- add by ly at 20090915 for CQ87568 end -->
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd" value="GetStpInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--对账文件下载-->
   <Transaction code="915210">
      <DynSentence name="GetPBnkNo">
         <Sentence>
            SELECT PBnkNo FROM tipbrkinf WHERE BrkNo ='%s'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetRBnkNo">
         <Sentence>
            SELECT RBnkNo FROM tipchkbok WHERE PBnkNo ='%s'
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkChkSts">  <!--检查上日日切对账是否做过SQL语句-->
         <Sentence>
            SELECT ChkSts
            FROM tipchkbok
            WHERE ChkDat='%s' and PBnkNo='%s'  and  RBnkNo='%s' and ChkMod='1'
         </Sentence>
         <Fields>PrevDt|PBnkNo|PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetChkOrd">   <!--从tipchkbok取最大的对账批次号SQL语句-->
         <Sentence>
            SELECT ChkOrd
            FROM tipchkbok
            WHERE ChkDat='%s' and RBnkNo='%s' and PBnkNo='%s'
            ORDER BY CHKORD DESC FETCH FIRST ROWS ONLY
         </Sentence>
         <Fields>WorkDt|PBnkNo|PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetOCkOrd">
         <Sentence>
            SELECT OCkOrd
            FROM tipchkbok
            WHERE ChkOrd='%s'
         </Sentence>
         <Fields>ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="GetAll">  <!--统计该对账批次的总笔数，总金额SQL语句-->
         <Sentence>
            SELECT AllNum,AllAmt
            FROM tipchkbok
            WHERE ChkOrd='%s'
         </Sentence>
         <Fields>ChkOrd|</Fields>
      </DynSentence>
      <!--DynSentence name="GetTxt"-->  <!--从数据库表中导出数据到文件中SQL语句-->
      <!--Sentence>
      SELECT OBnkNo,ActNo,ChkDat,ChkOrd,TxnAmt,OrgCod,EntDat,PackNo,TraNo
      FROM tiptxnbok
      WHERE RspDat='%s' and PBnkNo='%s' and RBnkNo='%s' and Bilsts='1'
      </Sentence>
      <Fields>WorkDt|PBnkNo|PBnkNo|</Fields>
      </DynSentence-->
      <DynSentence name="GetTxt">
         <Sentence>
            Select *
            from tiptxnbok
            where ActDat='%s' and RspDat='%s' and PBnkNo='%s' and RBnkNo='%s' and BilSts='1'
         </Sentence>
         <Fields>ChkDat|WorkDt|PBnkNo|PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetDt"> <!--对账类型为日间对账，从tipsyssts取得人行工作日期WorkDt,PrevDt人行上个工作日期-->
         <Sentence>
            Select WorkDt,PrevDt from tipsyssts
         </Sentence>
         <Fields>ChkMod|</Fields>
      </DynSentence>

      <FlowCtrl>
         <Quote name="Init"/>
         <!--Set>BrkNo=SUBSTR($NodNo,1,3)</Set>
         <Set>BrkNo=STRCAT($BrkNo,999)</Set-->
         <Set>BrkNo=STRCAT(SUBSTR($NodNo,1,3),999)</Set>
         <Exec func="PUB:ReadRecord" >
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>
         <If condition="$ChkMod=0">             <!--取人行工作日期WorkDt,PrevDt人行上个工作日期。-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="GetDt"/>
            </Exec>
         </If>
         <Exec func="PUB:ReadRecord" error="IGNORE">  <!--检查上日日切对账是否做过-->
            <Arg name="SqlCmd" value="ChkChkSts"/>
         </Exec>
         <!--If condition="ChkSts=0">
         <Set>RspMsg=柜员错误信息</Set>
         <Return/>
         <Break/>
         </If-->
         <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspMsg="上日日切对账未做"</Set>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord" error="IGNORE">  <!--从tipchkbk取最大的对账批次号-->
            <Arg name="SqlCmd" value="GetChkOrd"/>
         </Exec>
         <Switch expression="~RetCod">
            <Case value="0">
               <Set>MsgTyp=N</Set>
               <Set>RspMsg=成功</Set>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetOCkOrd"/>
               </Exec>
               <Set>ChkOrd=$OCkOrd</Set>
               <Set>ChkOrd=ADD($ChkOrd,1)</Set>
               <Break/>
            </Case>
            <Case value="-2">
               <Set>RspCod=000000</Set>
               <Set>RspMsg=没有记录</Set>
               <Set>ChkOrd=0001</Set>
               <Set>OCkOrd=0001</Set>
               <Break/>
            </Case>
         </Switch>
         <Exec func="PUB:ReadRecord" error="IGNORE">   <!--统计该对账批次的总笔数，总金额-->
            <Arg name="SqlCmd" value="GetAll"/>
         </Exec>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetRBnkNo"/>
         </Exec>
         <Set>FileName=STRCAT(dat/term/send/,$PBnkNo,.,$RBnkNo,.,$ChkDat,.,$ChkOrd,.SEND)</Set>
         <Exec func="PUB:ExportFromDB" desc="生成下载的对账文件" >
            <Arg name="FormatName" value="CHKTIP"/>
            <Arg name="FileName" value="$FileName"/>
            <Arg name="TableName" value="tiptxnbok"/>
            <Arg name="SqlName" value="GetTxt"/>
         </Exec>
         <Exec func="PUB:SendFileToOther">     <!--传送文件到分行前置-->
            <Arg name="MsgTyp" value="4"/>
            <Arg name="ObjNod" value="$BrkNo"/>
            <Arg name="BusTyp" value="EB"/>
            <Arg name="AplCod" value="910000"/>
            <Arg name="FilNam" value="$FilNam"/>
            <Arg name="Summary" value="$MsgSmr"/>
            <Arg name="ObjTlr" value="$TlrId"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--对账结果文件上传-->
   <Transaction code="915220">
      <DynSentence name="GetRBnkNo">
         <Sentence>
            SELECT RBnkNo,PBnkNo,ChkOrd FROM tipchkbok WHERE ChkDat ='%s'
         </Sentence>
         <Fields>ChkDat|</Fields>
      </DynSentence>

      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetRBnkNo"/>
         </Exec>
         <Set>FileName=STRCAT($RBnkNo,.,$PBnkNo,.,$ChkDat,.,$ChkOrd,.RECV)</Set>
         <Set>FilNam=DELBOTHSPACE($FileName)</Set>     <!--循环检查对账结果文件是否存在-->
         <Set>SndCnt=1</Set>
         <Set>SndLmt=44</Set>
         <While condition="INTCMP($SndCnt,2,$SndLmt)">
            <Exec func="PUB:IsExistFile" error="IGNORE">
               <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/recv/,$FilNam"/>
            </Exec>
            <If condition="~RetCod!=0">
               <If condition="IS_EQUAL_INT($SndCnt,$SndLmt)">
                  <Set>RspMsg=分行前置检查转发文件失败</Set>
                  <Return/>
               </If>
               <Else>
                  <Set>SndCnt=ADD($SndCnt,1)</Set>
               </Else>
            </If>
            <Else>
               <Break/>
            </Else>
         </While>
         <Set>RspCod=000000</Set>

         <Exec func="PUB:ImportToDB" desc="从文件中取数据插入到数据库表" error="IGNORE">
            <Arg name="FormatName" value="CHKTIP" />
            <Arg name="FileName" value="$FilNam"/>
            <Arg name="TableName" value="tipchkbok" />
         </Exec>
         <Exec func="PUB:ImportToDB" desc="从文件中取数据插入到数据库表" error="IGNORE">
            <Arg name="FormatName" value="CHKTIP" />
            <Arg name="FileName" value="$FilNam"/>
            <Arg name="TableName" value="tipchkrec" />
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!--BoCom00031634_XuChg_20080222_增加915225机构拆并交易-->
   <Transaction code="915225"  desc="机构拆并">
      <DynSentence name="UpdBrChg">                         <!--从整体机构撤并历史记录表更新记录到国库纳税人三方协议表网点-->
         <Sentence>
            UPDATE tipnodchg SET HActDat='%s' WHERE HActDat='99999999'
         </Sentence>
         <Fields>HActDat|</Fields>
      </DynSentence>
      <DynSentence name="UpdAcChg">                         <!--从整体机构撤并历史记录表更新记录到国库纳税人三方协议表网点-->
         <Sentence>
            UPDATE tipacchg SET HActDat='%s' WHERE HActDat='99999999'
         </Sentence>
         <Fields>HActDat|</Fields>
      </DynSentence>
      <DynSentence name="UpdCusAgrNodFromBr">               <!--从整体机构撤并历史记录表更新记录到国库纳税人三方协议表网点-->
         <Sentence>
            UPDATE tipcusagr a SET a.%s=
            (
            SELECT NewNodNo FROM tipnodchg b WHERE b.ActDat='%s' AND a.%s=b.OldNodNo
            )
            WHERE a.%s IN (SELECT OldNodNo FROM tipnodchg WHERE ActDat='%s')
         </Sentence>
         <Fields>NodTyp|ActDat|NodTyp|NodTyp|ActDat|</Fields>
      </DynSentence>
      <DynSentence name="UpdCusAgrNodFromAc">               <!--从账户撤并历史记录表更新记录到国库纳税人三方协议表网点-->
         <Sentence>
            UPDATE tipcusagr a SET a.%s=
            (
            SELECT NewNodNo FROM tipacchg b WHERE b.ActDat='%s' and a.ActNo=b.ActNo AND a.%s=b.OldNodNo
            )
            WHERE (a.ActNo,a.%s) IN (SELECT ActNo,OldNodNo FROM tipacchg WHERE ActDat='%s')
         </Sentence>
         <Fields>NodTyp|ActDat|NodTyp|NodTyp|ActDat|</Fields>
      </DynSentence>
      <FlowCtrl>
         <!--交易初始化-->
         <Quote name="Init"/>
         <Set>RspCod=000000</Set>
         <!--取业务管理信息-->
         <Exec func="PUB:GetAppInfo"/>
         <!--取list文件-->
         <Set>SelDat=CALCDATE($ActDat,-,d,1)</Set>
         <Set>DskNam=STRCAT(OSUINFXX_,$SelDat,.list)</Set>
         <Set>Content=STRCAT(机构拆并|,$DskNam,取文件失败|)</Set>
         <Quote name="GetTipFile"/>
         <If condition="GETFILESIZE(STRCAT(STRCAT(GETENV(WORKDIR),/dat/tip/,$SelDat),/,$LstFil))=0">
            <Set>RspMsg=STRCAT($DskNam,文件大小为零)</Set>  <!--列表文件大小为零-->
            <Return/>
         </If>
         <!--读列表文件-->
         <Exec func="PUB:OpenFile">
            <Arg name="FileName"    value="STRCAT(STRCAT(GETENV(WORKDIR),/dat/tip/,$SelDat),/,$DskNam)"/>
            <Arg name="Mode"        value="r"/>
         </Exec>
         <!--初始化数据解析器-->
         <Exec func="PUB:InitDataParser">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
         </Exec>
         <While>
            <!--读取文件详细-->
            <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
               <Arg name="ConfigName" value="BatFormat"/>
               <Arg name="RootName"   value="BATCH"/>
               <Arg name="NodeName"   value="Process"/>
               <Arg name="AttrName"   value="name"/>
               <Arg name="AttrValue"  value="OSUINFXXFmt"/>
            </Exec>
            <If condition="~RetCod=1">                          <!--列表文件已经读取完毕-->
               <Exec func="PUB:CloseFile"/>
               <Break/>
            </If>
            <ElseIf condition="~RetCod!=0">                     <!--列表文件读取失败-->
               <Set>RecLvl=2</Set>
               <Set>Content=STRCAT(机构拆并|,$DskNam,文件解析失败|)</Set>
               <Quote name="BusNty"/>
               <Exec func="PUB:CloseFile"/>
               <!--显式回滚数据库事务-->
               <Exec func="PUB:RollbackWork"/>
               <Set>RspMsg=STRCAT($DskNam,文件解析失败)</Set>
               <!--关闭文件解析器-->
               <Exec func="PUB:CloseDataParser"/>
               <Return/>
            </ElseIf>
            <Else>
               <!--判断文件类型-->
               <Set>FilTyp=SUBSTR($OFilNam,7,2)</Set>
               <If condition="$FilTyp=BR">
                  <!--针对整机构拆并-->
                  <Set>TabNam=tipnodchg</Set>
                  <Set>SqlNam=UpdCusAgrNodFromBr</Set>
                  <Set>SqlNamA=UpdBrChg</Set>
               </If>
               <ElseIf condition="$FilTyp=AC">
                  <!--针对单帐户拆并-->
                  <Set>TabNam=tipacchg</Set>
                  <Set>SqlNam=UpdCusAgrNodFromAc</Set>
                  <Set>SqlNamA=UpdAcChg</Set>
               </ElseIf>
               <Else>                                            <!--文件类型未知-->
                  <!--关闭文件-->
                  <Exec func="PUB:CloseFile"/>
                  <!--显式回滚数据库事务-->
                  <Exec func="PUB:RollbackWork"/>
                  <Set>RspMsg=STRCAT(列表文件中,$OFilNam,文件类型未知)</Set>
                  <!--关闭文件解析器-->
                  <Exec func="PUB:CloseDataParser"/>
                  <Return/>
               </Else>
               <Set>DskNam=STRCAT(OSUINF,$FilTyp,_,$SelDat,.dat)</Set>
               <!--取数据文件-->
               <Set>Content=STRCAT(机构拆并|,$DskNam,取文件失败|)</Set>
               <Quote name="GetTipFile"/>
               <Set>FilNam=STRCAT(STRCAT(GETENV(WORKDIR),/dat/tip/,$SelDat),/,$DskNam)</Set>
               <If condition="GETFILESIZE($FilNam)!=0">
                  <!--从文件中取数据插入到数据库表-->
                  <Exec func="PUB:ImportToDB" desc="从文件中取数据插入到数据库表">
                     <Arg name="FormatName" value="STRCAT(OSUINF,$FilTyp,Fmt)" />
                     <Arg name="FileName" value="$FilNam"/>
                     <Arg name="TableName" value="$TabNam" />
                  </Exec>
                  <!--更新HActDat-->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="$SqlNamA"/>
                  </Exec>
                  <Set>NodTyp=NodNo</Set>
                  <!--根据拆并记录表修改三方协议表的登记网点-->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="$SqlNam"/>
                  </Exec>
                  <Set>NodTyp=ONodNo</Set>
                  <!--根据拆并记录表修改三方协议表的开户网点-->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="$SqlNam"/>
                  </Exec>
                  <Set>NodTyp=PrtNod</Set>
                  <!--根据拆并记录表修改三方协议表的打印网点-->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="$SqlNam"/>
                  </Exec>
               </If>
               <!--文件汇总记录解析后形成SUM节点，因此需删除SUM节点后再进行下一文件解析-->
               <Delete>SUM</Delete>
            </Else>
         </While>
         <!--关闭文件解析器-->
         <Exec func="PUB:CloseDataParser"/>
      </FlowCtrl>
   </Transaction>

   <!--BoCom00034838_zhq_20080325-->
   <Transaction code="915226"  desc="更新三方协议表中的卡号">
      <DynSentence name="DelCrdChg">
         <Sentence>
            DELETE FROM tipcrdchg WHERE ActDat='%s'        <!--删除换卡历史表中此次导入的所有记录-->
         </Sentence>
         <Fields>ActDat|</Fields>
      </DynSentence>

      <!--DynSentence name="UpdActDat"-->                       <!--更新换卡历史表中的日期-->
      <!--Sentence>
      UPDATE tipcrdchg SET LstDat='%s' WHERE LstDat='99999999'
      </Sentence>
      <Fields>LstDat|</Fields>
      </DynSentence-->

      <!--DynSentence name="GetTotRec"-->                  <!--统计导入的记录数量(转换为4位字符格式，不足4位前补0)-->
      <!--Sentence>
      SELECT SUBSTR(DIGITS(CAST(COUNT(*) AS BIGINT)),16,4) Number FROM tipcrdchg WHERE LstDat='%s'
      </Sentence>
      <Fields>LstDat|</Fields>
      </DynSentence-->

      <DynSentence name="GetTotRec">                       <!--统计导入的记录数量-->
         <Sentence>
            SELECT COUNT(*)  Number FROM tipcrdchg WHERE ActDat='%s'
         </Sentence>
         <Fields>ActDat|</Fields>
      </DynSentence>

      <DynSentence name="UpdAcToCusAgr">                   <!--更新三方协议表中的卡号和验证状态-->
         <Sentence>
            UPDATE tipcusagr SET VrySts='0',ActNo =
            (
            SELECT NewAcNo FROM tipcrdchg WHERE tipcrdchg.ActDat='%s' AND tipcrdchg.AcTyp='0'  AND tipcusagr.ActNo=tipcrdchg.OrnAcNo
            )
            WHERE ActNo IN (SELECT OrnAcNo FROM tipcrdchg WHERE ActDat='%s' AND AcTyp='0'  )
         </Sentence>
         <Fields>ActDat|ActDat|</Fields>
      </DynSentence>

      <FlowCtrl>
         <!--交易初始化-->
         <Quote name="Init"/>
         <Set>RspCod=000000</Set>
         <!--取业务管理信息-->
         <Exec func="PUB:GetAppInfo"/>
         <Set>SelDat=CALCDATE($ActDat,-,d,1)</Set>
         <Set>LstFil=STRCAT(CBKICSXX_,$SelDat,.list)</Set>  <!--列表文件名-->
         <Set>DatFil=STRCAT(CITCDNOR_,$SelDat,.dat)</Set>   <!--数据文件名-->
         <Set>FilPath=STRCAT(GETENV(WORKDIR),/dat/tip/,$SelDat)</Set>

         <!--获取列表文件-->
         <Set>DskNam=$LstFil</Set>
         <Set>Content=STRCAT(915226|取列表文件:,$DskNam,失败)</Set>
         <Quote name="GetTipFile"/>
         <If condition="GETFILESIZE(STRCAT($FilPath,/,$LstFil))=0">
            <Set>Content=STRCAT(915226|列表文件:,$LstFil,大小为零)</Set>
            <Quote name="ErrToDB"/>
            <Set>RspMsg=列表文件大小为零</Set>
            <Return/>
         </If>

         <!--获取数据文件-->
         <Set>DskNam=$DatFil</Set>
         <Set>Content=STRCAT(915226|取数据文件:,$DskNam,失败)</Set>
         <Quote name="GetTipFile"/>
         <If condition="GETFILESIZE(STRCAT($FilPath,/,$DatFil))=0">
            <Set>Content=STRCAT(915226|数据文件:,$DatFil,大小为零)</Set>
            <Quote name="ErrToDB"/>
            <Set>RspMsg=数据文件大小为零</Set>
            <Return/>
         </If>

         <!--读列表文件-->
         <Exec func="PUB:OpenFile">
            <Arg name="FileName"    value="STRCAT($FilPath,/,$LstFil)"/>
            <Arg name="Mode"        value="r"/>
         </Exec>

         <!--初始化数据解析器-->
         <Exec func="PUB:InitDataParser">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
         </Exec>

         <!--读取文件详细-->
         <Exec func="PUB:GetFileLineAndParse" error="IGNORE">
            <Arg name="ConfigName" value="BatFormat"/>
            <Arg name="RootName"   value="BATCH"/>
            <Arg name="NodeName"   value="Process"/>
            <Arg name="AttrName"   value="name"/>
            <Arg name="AttrValue"  value="CBKICSXXFmt"/>
         </Exec>

         <!--列表文件读取失败-->
         <If condition="~RetCod!=0">
            <Set>Content=STRCAT(915226|文件:,$LstFil,解析失败|)</Set>
            <Quote name="ErrToDB"/>
            <Exec func="PUB:CloseFile"/>
            <!--显式回滚数据库事务-->
            <Exec func="PUB:RollbackWork"/>
            <!--关闭文件解析器-->
            <Exec func="PUB:CloseDataParser"/>
            <Set>RspMsg=STRCAT(文件:,$LstFil,解析失败)</Set>
            <Return/>
         </If>
         <!--关闭文件和数据解析器-->
         <Exec func="PUB:CloseFile"/>
         <Exec func="PUB:CloseDataParser"/>

         <!--数据文件入库-->
         <Exec func="PUB:ImportToDB" error="IGNORE">
            <Arg name="FormatName"   value="CITCDNORFmt" />
            <Arg name="FileName"     value="STRCAT($FilPath,/,$DatFil)"/>
            <Arg name="TableName"    value="tipcrdchg" />
         </Exec>
         <If condition="~RetCod=0" >
            <!--Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdActDat"/>
            </Exec>
            <If condition="~RetCod!=0">
            <Exec func="PUB:RollbackWork"/>
            <Set>Content=915226:更新换卡历史表中的日期出错</Set>
            <Quote name="ErrToDB"/>
            <Set>RspMsg=更新换卡历史表出错</Set>
            <Return/>
            </If>
            <Else>
            <Exec func="PUB:CommitWork"/>
            </Else-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="GetTotRec"/>
            </Exec>

            <If condition="~RetCod!=0">
               <Set>Content=915226|统计导入数据记录数出错</Set>
               <Quote name="ErrToDB"/>
               <Set>RspMsg=统计导入数据记录数出错</Set>
               <Return/>
            </If>
            <!--导入的记录数与数据文件中记录的记录数不一致就删除导入的记录并将错误信息记录到国库业务提示记录表（tipbusnty）中-->
            <If condition="IS_NOEQUAL_STRING($Number,$TotRec)">
               <Exec func="PUB:ExecSql" error="IGNORE">
                  <Arg name="SqlCmd" value="DelCrdChg"/>
               </Exec>
               <Set>Content=915226|导入记录数与数据文件中的记录数不等</Set>
               <Quote name="ErrToDB"/>
               <Set>RspMsg=导入记录数与文件中的记录数不等</Set>
               <Return/>
            </If>
            <Exec func="PUB:ExecSql" error="IGNORE">  <!--更新卡号和验证状态-->
               <Arg name="SqlCmd" value="UpdAcToCusAgr"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>Content=915226|系统出错</Set>
               <Quote name="ErrToDB"/>
               <Set>RspMsg=系统出错</Set>
               <Return/>
            </If>
         </If>
         <Else>
            <Set>Content=STRCAT(915226|数据文件:,$DatFil,解析入库失败)</Set>
            <Quote name="ErrToDB"/>
            <Set>RspMsg=STRCAT(数据文件:,$DatFil,解析入库失败)</Set>
         </Else>
         <Delete>SUM</Delete>
      </FlowCtrl>
   </Transaction>

   <!--Added By zhq_BoCom00041319_20080707-->
   <Transaction code ="915227" desc="定时更新地区码表" >
      <DynSentence name="DelRgnBrk">
         <Sentence>
            DELETE FROM tiprgnbrk        <!--清空地区码表原有的记录-->
         </Sentence>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>RspCod=000000</Set>
         <Exec func="PUB:GetAppInfo"/>
         <Set>SelDat=CALCDATE($ActDat,-,d,1)</Set>
         <Set>FilNam=STRCAT(CMTRGNXX_,$SelDat,.dat)</Set>
         <Set>SrcFil=STRCAT(STRCAT(/app/ade/data/D1/TIP/,$SelDat),/,$FilNam)</Set>
         <Set>LocFil=STRCAT(STRCAT(GETENV(WORKDIR),/dat/tip/,$SelDat),/,$FilNam)</Set>
         <Set>DSKNam=$FilNam</Set>

         <!--检查文件是否重复接收-->
         <Exec func="PUB:CollateRepeatRecord"/>
         <!--通过CD取文件-->
         <System command="TipGetFile.sh" error="IGNORE">
            <Arg name="AcDate" value="$SelDat"/>
            <Arg name="SrcFil" value="$SrcFil"/>
            <Arg name="ObjFil" value="$LocFil"/>
         </System>
         <If condition="~RetCod!=0">
            <Set>RecLvl=2</Set>
            <Set>Content=STRCAT(915227|取地区码表数据文件:,$FilNam,失败)</Set>
            <Quote name="BusNty"/>
            <Set>RspMsg=STRCAT(取地区码表数据文件:,$FilNam,失败)</Set>      <!--文件读取失败-->
            <Return/>
         </If>

         <!--判断文件是否为空-->
         <Exec func="PUB:IsValidFile" error ="IGNORE">
            <Arg name="args1" value="$LocFil"/>
         </Exec>
         <If condition="INTCMP($FilByt,3,0)">
            <Set>Content=STRCAT(915227|数据文件:,$FilNam,大小为零)</Set>
            <Quote name="ErrToDB"/>
            <Set>RspMsg=地区码表文件为空</Set>
            <Return/>
         </If>

         <!--清空原有的历史数据-->
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd"   value="DelRgnBrk"/>
         </Exec>
         <If condition="~RetCod!=0">
            <If condition="~RetCod!=-2">
               <Set>Content=915227|清除地区码表历史记录时出错</Set>
               <Quote name="ErrToDB"/>
               <Set>RspMsg=清空历史记录的时候出错</Set>
               <Return/>
            </If>
            <Set>RspCod=000000</Set>
         </If>
         <Exec func="PUB:ImportToDB" error="IGNORE">
            <Arg name="FormatName" value="CMTRGNXX"/>
            <Arg name="FileName"   value="$LocFil"/>
            <Arg name="TableName"  value="tiprgnbrk"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>Content=STRCAT(915227|数据文件:,$FilNam,解析入库失败)</Set>
            <Quote name="ErrToDB"/>
            <Set>RspMsg=STRCAT(数据文件:,$FilNam,解析入库失败)</Set>
         </If>
         <Delete>SUM</Delete>

      </FlowCtrl>
   </Transaction>


   <!--Added By zhq_BoCom00041319_20080620-->
   <Transaction code ="915231" desc="缴税通对公客户签约进度表" >
      <FlowCtrl>
         <If condition="INTCMP($StaDat,6,$EndDat)">
            <Set>RspCod=915231</Set>
            <Set>RspMsg=起始日期不能大于结束日期</Set>
            <Return/>
         </If>

         <Set>FilNam=STRCAT(TipRpt_1_,$StaDat,_,$EndDat)</Set>
         <Exec func="PUB:IsExistFile" error="IGNORE">
            <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
         </Exec>
         <If condition="~RetCod !=0">
            <Exec func="PUB:GenerateReport">
               <Arg name="args1"  value="STRCAT(dat/term/send/,$FilNam)"/>
               <Arg name="args2"  value="STRCAT(etc/,TIP08_RPT.XML)"/>
               <Arg name="args3"  value="$StaDat"/>
               <Arg name="args4"  value="$EndDat"/>
            </Exec>
            <Set>RspCod=000000</Set>
         </If>

         <!-- 下发文件到打印网点 -->
         <!--Exec func="PUB:SendFileMessage">
            <Arg name="MsgTyp" value="4"/>                        
            <Arg name="ObjNod" value="$NodNo"/>                   
            <Arg name="BusTyp" value="CM"/>                       
            <Arg name="AplCod" value="999999"/>                   
            <Arg name="FilNam" value="$FilNam"/>                  
            <Arg name="Summary" value="缴税通对公客户签约进度表"/>
            <Arg name="ObjTlr" value="$TlrId"/>                   
            <Arg name="SrcNod" value="$NodNo"/>                   
            <Arg name="SrcTlr" value="$TlrId"/>                   
         </Exec-->
         
         <!--将税票文件下传网点-->
         <Set>MsgSmr=STRCAT($NodNo,缴税通对公客户签约进度表)</Set>
         <Set>BrkNo=STRCAT(SUBSTR($NodNo,1,3),999)</Set>
         <Exec func="PUB:SendFileToOther">
            <Arg name="MsgTyp" value="4"/>
            <Arg name="ObjNod" value="$BrkNo"/>
            <Arg name="BusTyp" value="CM"/>
            <Arg name="AplCod" value="999999"/>
            <Arg name="FilNam" value="$FilNam"/>
            <Arg name="Summary" value="$MsgSmr"/>
            <Arg name="ObjTlr" value="$TlrId"/>
         </Exec>
         
      </FlowCtrl>
   </Transaction>
   
   <!--Added by sundx for cq57421 总行对账登记簿查询 --> 
   <Transaction code="918761" desc="总行对账登记簿查询">
      <DynSentence name="GetChkInf"><!--总行对账登记簿查询-->
         <Sentence>
            SELECT RBnkNo,PBnkNo,ChkDat,ChkOrd,ChkMod,ChkSts,RknSts,AllAmt,AllNum
            FROM tipchkbok
            WHERE ChkDat BETWEEN '%s' AND '%s'
            AND (CBrkNo = '%s' OR '%s' = ' ')
            AND (ChkMod='%s' OR '%s'='2')
            AND (('%s' = '' AND '%s' = '') OR ChkOrd BETWEEN '%s' AND '%s')           
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BrkNo|BrkNo|ChkMod|ChkMod|BChkOrd|EChkOrd|BChkOrd|EChkOrd|</Fields>
      </DynSentence>      
      <FlowCtrl>
         <Quote name="Init"/>         
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd"     value="GetChkInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
</Application>
