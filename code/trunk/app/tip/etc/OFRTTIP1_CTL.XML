<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="TIP" code="037">
   <!--modified by xhb_20080125_915850_BoCom00031672(自动清算的时候根据国库数据表中的值来登记大额系统支付信息)-->
   <!--modified by zhq_20080307_915853_BoCom00031672(手动清算的时候根据国库数据表中的值来登记大额系统支付信息)-->
   <!--modified by zhq_20080513_915856_BoCom00038409(将原有的文件传输方式由FTP改为CD)-->
   <!--modified by zhq_20080707_915856_BoCom00041319(生成缴税通报表)-->
   <!--Modified By zhq_BoCom00045601_20080820_915851_合并交易中实时和批量的逻辑处理，添加自动冲帐功能-->
   <!--Modified By zhq_BoCom00047053_20080918_915856_在原来国库缴税通报表的基础上新增加缴税通报表-->
   <!--Modified By zhq_BoCom00050337_20081017_915851_修改sql“Online”-->
   <!--Modified By sundx_BoCom00052077_20081201 日终对账后不自动清算，改成次日清算，新加交易915842，915843-->
   <!--Modified By zhangy_BoCom00059401_20090210 每日定时清算前判断大额工作日和核心会计日起是否一致,修改交易915842 -->
   <!--Modified By sundx_BoCom00057421_20090211 特殊日期需要当日清算,修改交易915850 -->
   <!--Modified By sundx_BoCom00061739_20090330 修改交易915856，每天增量导出tiptxnbok数据，生成文件传送给ADE -->
   <!--Modified By sundx_BoCom00067299_20090602 修改交易915830，915803,915812,使财政零余额账户实时以及批量扣税后能打印税票-->
   <!--Modified By zhangx_BoCom00078003_20090724 修改交易915856，由导出一天的tiptxnbok数据改为导出30天的数据-->
   <!--Modified by LiuYj_BoCom00076186_20090929_修改915855 将MMQMTIP1改为SMQMTIP2--> 
   <!--Modified by ly_BoCom00087568_20090915_修改915200,918745,918805-->
   
   <BusDefDeclare>
      <Busdef name="SrcNod" value="601100000010"></Busdef>
      <Busdef name="DstNod" value="100000000000"></Busdef>
      <Busdef name="TxnCnl" value="TIP"></Busdef>
      <Busdef name="MstChk" value="0"></Busdef>
      <Busdef name="TSDir"  value="dat/term/send/"/>
      <Busdef name="IFSDir"  value="dat/filesvr/"/>
   </BusDefDeclare>
   <LibDeclare>
      <Library name="BEP9" value="dll/bep9.so"/>
   </LibDeclare>
   <ConfigDeclare>
      <Config name="TIPCSW"          value="etc/TIP_CSW.XML"/>
      <!--Modified By zhq_BoCom00038409_20080513-->
      <!--Config name="FtpGetIFSS"      value="etc/IFSSFtpGet.XML" /-->
      <Config name="BatFormat"       value="etc/TIP_FMT.XML" />
   </ConfigDeclare>
   <TableDeclare>
      <Table name="tipsyssts" value="tipsyssts"/> <!--国库系统状态表-->
      <Table name="tipnodinf" value="tipnodinf"/> <!--国库节点表-->
      <Table name="tiptreinf" value="tiptreinf"/> <!--国库信息表-->
      <Table name="tiporginf" value="tiporginf"/> <!--国库征收机关表-->
      <Table name="tiprgnbrk" value="tiprgnbrk"/> <!--国库地区代码分行对照表-->
      <Table name="tiptrerkn" value="tiptrerkn"/> <!--国库清算行-->
      <Table name="tipbrkinf" value="tipbrkinf"/> <!--国库已上线分行表-->
      <Table name="tipcusagr" value="tipcusagr"/> <!--国库纳税人三方协议表-->
      <Table name="tiptxnbok" value="tiptxnbok"/> <!--国库人行帐务交易登记簿-->
      <Table name="tiptxnjnl" value="tiptxnjnl"/> <!--国库主机交易流水表-->
      <Table name="tipttprec" value="tipttprec"/> <!--国库税种明细表-->
      <Table name="tiptaxrec" value="tiptaxrec"/> <!--国库税目明细表-->
      <Table name="tipbatbok" value="tipbatbok"/> <!--国库人行批量交易包登记簿-->
      <Table name="tiprvsbok" value="tiprvsbok"/> <!--国库人行冲正交易登记簿-->
      <Table name="tipstpbok" value="tipstpbok"/> <!--国库人行止付交易登记簿-->
      <Table name="tipchkbok" value="tipchkbok"/> <!--国库人行对账包登记簿-->
      <Table name="tippkgrec" value="tippkgrec"/> <!--国库人行子包明细表-->
      <Table name="tipchkrec" value="tipchkrec"/> <!--国库人行对账明细表-->
      <Table name="tipfmgrec" value="tipfmgrec"/> <!--国库自由报文明细表-->
      <Table name="tipsbjbal" value="tipsbjbal"/> <!--国库主机科目余额临时表-->
      <Table name="tipbusnty" value="tipbusnty"/> <!--国库业务提示记录表-->
      <Table name="tiptaxtyp" value="tiptaxtyp"/> <!--国库税种表-->
      <Table name="tiptaxsbj" value="tiptaxsbj"/> <!--国库税目表-->
      <Table name="tipnodupd" value="tipnodupd"/> <!--国库节点更新表-->
      <Table name="tiptreupd" value="tiptreupd"/> <!--国库信息更新表-->
      <Table name="tiporgupd" value="tiporgupd"/> <!--国库征收机关更新表-->
      <Table name="tiptypupd" value="tiptypupd"/> <!--国库税种更新表-->
      <Table name="tipsbjupd" value="tipsbjupd"/> <!--国库税目更新表-->
      <Table name="tiphstjnl" value="tiphstjnl"/> <!--主机对账流水表-->
      <Table name="tipfapact" value="tipfapact"/> <!--财政零余额帐户表-->
   </TableDeclare>
   <Define>
      <Macro name="GetSeq"><!--取序号-->
         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="TIP:MsgId"/>
            <Arg name="SeqCnd" value="MsgId"/>
            <Arg name="Len" value="10"/>
         </Exec>
         <Set>MsgId=STRCAT(0000000000,$SelVal)</Set>
      </Macro>

      <Macro name="GetBrkSQL">  <!--根据网点号取分行号SQL-->
         <DynSentence name="GetBrkNo">
            <Sentence>
               SELECT BrkNo FROM tiprgnbrk WHERE Rgn='%s'
            </Sentence>
            <Fields>Rgn|</Fields>
         </DynSentence>
      </Macro>

      <Macro name="GetBrkCTL"> <!--根据网点号取分行号-->
         <Set>Rgn=SUBSTR($NodNo,1,3)</Set>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkNo"/>
         </Exec>
         <Set>BrNo=$BrkNo</Set>
      </Macro>

      <Macro name="BusNty"><!--登记业务提示表-->
         <Set>RecTim=GETDATETIME(HHMISS)</Set>
         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="tipbusnty:RecNo"/>
            <Arg name="SeqCnd" value="RecNo"/>
            <Arg name="Len" value="8"/>
         </Exec>
         <Set>RecNo=$SelVal</Set>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tipbusnty"/>
         </Exec>
      </Macro>

      <Macro name="ChkStsSQL"><!--检查系统状态SQL-->
         <DynSentence name="ChkStsSQL">
            <Sentence>
               SELECT * FROM tipsyssts WHERE ONodCd='%s'
            </Sentence>
            <Fields>SrcNod|</Fields>
         </DynSentence>
      </Macro>

      <Macro name="ChkStsCTL"><!--检查系统状态-->
         <Exec  func="PUB:ReadRecord" >
            <Arg name="SqlCmd" value="ChkStsSQL" />
         </Exec>
         <If condition="$WrkDat!=$WorkDt">
            <Set>RspCod=38001</Set>
            <Set>AddWord=系统当前非工作状态</Set>
            <Return/>
         </If>
         <If condition="$Status!=0">
            <Set>RspCod=38001</Set>
            <Set>AddWord=系统当前非工作状态</Set>
            <Return/>
         </If>
      </Macro>

      <Macro name="ChkArgSQL"><!--检查协议SQL-->
         <DynSentence name="ChkAgr">
            <Sentence>
               SELECT brkno,TCusId,PrtNod FROM tipcusagr WHERE Agrno='%s' AND ActNo='%s' AND status='0'
            </Sentence>
            <Fields>AgrNo|ActNo|</Fields>
         </DynSentence>
         <DynSentence name="UpdTxnBok2"><!--协议无效时，更新登记簿状态-->
            <Sentence>
               UPDATE tiptxnbok SET BilSts='%s'
               WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
            </Sentence>
            <Fields>BilSts|OrgCod|EntDat|TraNo|</Fields>
         </DynSentence>
      </Macro>

      <Macro name="ChkArg"><!--检查协议-->
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkAgr" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=24009</Set>
            <Set>HRspCd=24009</Set>
            <Set>AddWord=账户未签约</Set>
            <Set>BilSts=2</Set>
            <Exec  func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok2" />
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdAddWord"/>
            </Exec>
            <Return/>
         </If>
      </Macro>

      <Macro name="UpdPrtNodSQL"><!--更新打印网点SQL-->
         <DynSentence name="UpdPrtNod">
            <Sentence>
               UPDATE tiptxnbok SET PrtNod='%s'
               WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
            </Sentence>
            <Fields>PrtNod|OrgCod|EntDat|TraNo|</Fields>
         </DynSentence>
      </Macro>

      <Macro name="UpdPrtNod"><!--更新打印网点-->
         <Exec  func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdPrtNod" />
         </Exec>
      </Macro>

      <Macro name="UpdRspInf"><!--批扣失败时更新单笔交易-->
         <Exec  func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdRspInf" />
         </Exec>
      </Macro>

      <Macro name="2111SQL">      <!--发送明细对账回执SQL-->
         <DynSentence name="UpdMsgRef">
            <Sentence>
               UPDATE tipchkbok SET MsgRef='%s',RspNum=cast(cast(RspNum as smallint)+1 as char(1)) WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            </Sentence>
            <Fields>MsgRef|PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
      </Macro>

      <Macro name="2111">      <!--发送明细对账回执-->
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:CallThirdOther"><!--明细对账回执-->
            <Arg name="HTxnCd" value="2111"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
         <Exec  func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdMsgRef" />
         </Exec>
      </Macro>

      <Macro name="HangAcc"><!--通过挂账方式清算-->
         <Set>TTxnCd=915850</Set>
         <Set>CcyCod=CNY</Set>
         <Set>TxnAmt=$AllAmt</Set>
         <Set>HTxnCd=915850</Set>
         <Set>RecTyp=3</Set>
         <Set>RknTyp=0</Set>
         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <Set>CAcNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set>
         <!--Set>Smr=STRCAT(对账日期:,$ChkDat, 对账批次:,$ChkOrd, 对账笔数:,$AllNum)</Set-->
         <Exec func="PUB:GetLogNo"/>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdLogNo"/>
         </Exec>
         <Exec func="PUB:InsertJournal" />
         <Exec func="PUB:CallHostAcc" error="IGNORE">
            <Arg name="HTxnCd" value="915850" />
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>
         <If condition="~RetCod!=0"><!--失败-->
            <Set>ChkSts=1</Set>
            <Set>RknSts=2</Set>
            <Set>BrkNo=$CBrkNo</Set>
            <Set>RecLvl=1</Set>
            <Set>Content=STRCAT(挂账清算失败 ,收款行号,$RBnkNo, 付款行号,$PBnkNo, 对账日期,$ChkDat, 对账批次,$ChkOrd, 错误代码,$HRspCd)</Set>
            <Quote name="BusNty"/>
         </If>
         <Else>                     <!--成功-->
            <Set>ChkSts=1</Set>
            <Set>RknSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTckNo"/>
            </Exec>
         </Else>
         <Exec func="PUB:UpdateJournal"/>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdChkBok"/>
         </Exec>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdTxnBok"/>
         </Exec>
      </Macro>

      <Macro name="Pms"><!--通过大额支付清算-->
         <Set>BrkNo=$DBrkNo</Set><!--直接参与者行号-->
         <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"></Arg>
            <Arg name="SourNam" value="BrkNo"></Arg>
            <Arg name="DestNam" value="SRN"></Arg>
            <Arg name="TblNam" value="Cod2SRN"></Arg>
         </Exec>
         <Set>@MSG.SRN=$SRN</Set>
         <Set>TTxnCd=915850</Set>

         <!--将 PMBTyp/CMTCod的值改为外部输入的值,不再使用固定值 BoCom00031672 解宏波-->
         <Set>PMBTyp=$TBusTyp</Set> <!--对应外部传入的业务种类-->
         <Set>CMTCod=$TRptTyp</Set> <!--对应外部传入的报文类型-->
         <Set>TxnDat=$ActDat</Set>
         <Set>BilDat=$ActDat</Set>
         <Set>CcyCod=CNY</Set>
         <Set>TxnAmt=$AllAmt</Set>
         <!--Set>Smr=STRCAT(税款入库 对账日期:,$ChkDat, 对账批次:,$ChkOrd, 对账笔数:,$AllNum)</Set-->
         <Set>RBkNo=$RBnkNo</Set>
         <Set>RcvAct=$RcvNo</Set>
         <Set>RpdFlg=1</Set><!--普通-->
         <Set>PayRet=0</Set><!--汇路标识-->
         <Set>OBusTy=$BusTyp</Set>
         <Set>NodNo=STRCAT(SUBSTR($DBrkNo,1,3),800)</Set>
         <Set>SOpnBk=$PBnkNo</Set>
         <Set>ROpnBk=$RBkNo</Set>

         <!--主机接口相关-->
         <Set>HTxnCd=915850</Set>
         <Set>RknTyp=1</Set>
         <Set>ActNod=STRCAT(SUBSTR($DBrkNo,1,3),800)</Set><!--清算行部门号-->
         <Set>CAcNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set><!--关联行部门号-->

         <Exec func="PUB:GetLogNo"/>
         <Set>LogNo=STRCAT(SUBSTR($LogNo,1,8),A,SUBSTR($LogNo,10,5))</Set><!--防止总行前置与分行前置LogNo冲突-->
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdLogNo"/>
         </Exec>
         <Delete>$ActNo</Delete>
         <Delete>$CclNo</Delete>
         <Exec func="PUB:CallLocal" error="IGNORE">
            <Arg name="TxnCod" value="359220" />
            <Arg name="ObjSvr" value="OFRTPMS1"/>
         </Exec>
         <Delete>@MSG.SRN</Delete>
         <If condition="~RetCod!=0"><!--失败-->
            <Set>ChkSts=1</Set>
            <Set>RknSts=2</Set>
            <Set>BrkNo=$CBrkNo</Set>
            <Set>RecLvl=1</Set>
            <Set>Content=STRCAT(大额支付清算失败 ,收款行号,$RBnkNo, 付款行号,$PBnkNo, 对账日期,$ChkDat, 对账批次,$ChkOrd, 错误代码,$RspCod)</Set>
            <Quote name="BusNty"/>
         </If>
         <Else>                     <!--成功-->
            <Set>ChkSts=1</Set>
            <Set>RknSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdBusLog"/>
            </Exec>
         </Else>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdChkBok"/>
         </Exec>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdTxnBok"/>
         </Exec>
      </Macro>

      <Macro name="Reckon"><!--资金清算-->
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="BankCompare3111"/>
         </Exec>
         <If condition="INTCMP($AllAmt,3,0)=1"><!--清算金额为零-->
            <Set>RspCod=90000</Set>
            <Set>ChkSts=1</Set>
            <Set>RknSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Return/>
         </If>
         <Set>CnlSub=$BrkNo</Set>
         <Exec func="PUB:GetVirtualTeller"/>
         <If condition="$RknTyp=0"><!--大额支付-->
            <Quote name="Pms"/>
         </If>
         <ElseIf condition="$RknTyp=2"><!--挂账-->
            <Quote name="HangAcc"/>
         </ElseIf>
         <ElseIf condition="$RknTyp=1"><!--小额支付-->
            <Return/>
         </ElseIf>
      </Macro>

      <Macro name="CheckSQL"><!--对账SQL-->
         <DynSentence name="sql1">      <!--对账相符-->
            <Sentence>
               UPDATE tiptxnbok SET ChkSts='1',ChkDat='%s',ChkOrd='%s'
               WHERE   (OrgCod,EntDat,TraNo) IN
               (SELECT bok.OrgCod,bok.EntDat,bok.TraNo FROM tiptxnbok bok,tipchkrec rec
               WHERE rec.OrgCod = bok.OrgCod
               AND rec.EntDat = bok.EntDat
               AND rec.TraNo = bok.TraNo
               AND cast(rec.TxnAmt as bigint) = cast(bok.TxnAmt as bigint)
               AND bok.BilSts='1'
               AND bok.ChkSts IN ('0','2','3')
               AND rec.RBnkNo = '%s' AND rec.PBnkNo='%s' AND rec.ChkDat='%s' AND rec.ChkOrd='%s')
            </Sentence>
            <Fields>ChkDat|ChkOrd|RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="sql2">      <!--对账相符-->
            <Sentence>
               UPDATE tipchkrec SET ChkSts='1'
               WHERE   (OrgCod,EntDat,TraNo) IN
               (SELECT rec.OrgCod,rec.EntDat,rec.TraNo FROM tiptxnbok bok,tipchkrec rec
               WHERE rec.OrgCod = bok.OrgCod
               AND rec.EntDat = bok.EntDat
               AND rec.TraNo = bok.TraNo
               AND cast(rec.TxnAmt as bigint) = cast(bok.TxnAmt as bigint)
               AND bok.BilSts='1'
               AND rec.ChkSts='0'
               AND rec.RBnkNo = '%s' AND rec.PBnkNo='%s' AND rec.ChkDat='%s' AND rec.ChkOrd='%s')
            </Sentence>
            <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="sql3">      <!--对账不符-->
            <Sentence>
               UPDATE tiptxnbok SET ChkSts='3',ChkDat='%s',ChkOrd='%s'
               WHERE   (OrgCod,EntDat,TraNo) IN
               (SELECT bok.OrgCod,bok.EntDat,bok.TraNo FROM tiptxnbok bok,tipchkrec rec
               WHERE rec.OrgCod = bok.OrgCod
               AND rec.EntDat = bok.EntDat
               AND rec.TraNo = bok.TraNo
               AND cast(rec.TxnAmt as bigint) != cast(bok.TxnAmt as bigint)
               AND bok.BilSts='1'
               AND bok.ChkSts IN ('0','2','3')
               AND rec.RBnkNo = '%s' AND rec.PBnkNo='%s' AND rec.ChkDat='%s' AND rec.ChkOrd='%s')
            </Sentence>
            <Fields>ChkDat|ChkOrd|RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="sql4">      <!--对账不符-->
            <Sentence>
               UPDATE tipchkrec SET ChkSts='3'
               WHERE   (OrgCod,EntDat,TraNo) IN
               (SELECT rec.OrgCod,rec.EntDat,rec.TraNo FROM tiptxnbok bok,tipchkrec rec
               WHERE rec.OrgCod = bok.OrgCod
               AND rec.EntDat = bok.EntDat
               AND rec.TraNo = bok.TraNo
               AND (cast(rec.TxnAmt as bigint) != cast(bok.TxnAmt as bigint))
               AND bok.BilSts='1'
               AND rec.ChkSts='0'
               AND rec.RBnkNo = '%s' AND rec.PBnkNo='%s' AND rec.ChkDat='%s' AND rec.ChkOrd='%s')
            </Sentence>
            <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="sql5">      <!--人行单边账-->
            <Sentence>
               UPDATE tipchkrec SET ChkSts='2' WHERE ChkSts='0' AND PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            </Sentence>
            <Fields>PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="sql6">      <!--我行单边账-->
            <Sentence>
               UPDATE tiptxnbok SET ChkSts='2',ChkDat='%s',ChkOrd='%s' WHERE ChkSts='0' AND BilSts='1' AND PBnkNo='%s' AND RBnkNo='%s' AND RspDat='%s'
            </Sentence>
            <Fields>ChkDat|ChkOrd|PBnkNo|RBnkNo|ChkDat|</Fields>
         </DynSentence>
      </Macro>

      <Macro name="Check"><!--对账-->
         <!--两表核对-->
         <Set>UpdNum=1</Set>
         <While condition="$UpdNum&lt;7">
            <Set>UpdCmd=STRCAT(sql,$UpdNum)</Set>
            <Exec  func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="$UpdCmd"/>
            </Exec>
            <If condition="~RetCod=-2">
               <Set>MsgTyp=N</Set>
               <Set>RspCod=000000</Set>
            </If>
            <ElseIf condition="~RetCod!=0">
               <Set>RspCod=360001</Set>
               <Set>RspMsg=数据库操作失败</Set>
               <Return/>
            </ElseIf>
            <Else>
               <Set>UpdNum=ADD($UpdNum,1)</Set>
               <Continue/>
            </Else>
            <Set>UpdNum=ADD($UpdNum,1)</Set>
         </While>
         <Exec func="PUB:CommitWork"/>
      </Macro>

      <Macro name="CheckResultSQL"><!--检查对账结果SQL-->
         <DynSentence name="ChkRslSql1"><!--检查是否存在人行多或者关键信息不符的记录-->
            <Sentence>
               SELECT 'Y' YN FROM TABLE(VALUES(1)) AS anony WHERE EXISTS
               (SELECT 'Y' FROM tipchkrec  WHERE ChkSts IN ('2','3') AND RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s')
               OR EXISTS
               (SELECT 'Y' FROM tiptxnbok  WHERE ChkSts = '3' AND RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s')
            </Sentence>
            <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>

         <DynSentence name="ChkRslSql2"> <!--检查是否存在我行多的记录-->
            <Sentence>
               SELECT 'Y' YN  FROM TABLE(VALUES(1)) AS anony
               WHERE EXISTS
               ( SELECT 'Y' FROM tiptxnbok WHERE ChkSts = '2' AND BilSts='1' AND RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s')
               or EXISTS
               ( SELECT 'Y' FROM tiptxnbok WHERE ChkSts='0' AND HTxnSt='T' AND BilSts='T' AND RBnkNo='%s' AND PBnkNo='%s' AND ActDat='%s' AND PayMod IN ('0','1'))
            </Sentence>
            <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|RBnkNo|PBnkNo|ChkDat|</Fields>
         </DynSentence>
         <DynSentence name="ChkRslSql3"><!--检查是否存在人行多的记录-->
            <Sentence>
               SELECT 'Y' YN FROM TABLE(VALUES(1)) AS anony WHERE EXISTS
               (SELECT 'Y' FROM tipchkrec  WHERE ChkSts = '2' AND RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s')
            </Sentence>
            <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="ChkRslSql4"><!--检查是否存在关键信息不符的记录-->
            <Sentence>
               SELECT 'Y' YN FROM TABLE(VALUES(1)) AS anony WHERE EXISTS
               (SELECT 'Y' FROM tipchkrec  WHERE ChkSts = '3' AND RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s')
               OR EXISTS
               (SELECT 'Y' FROM tiptxnbok  WHERE ChkSts = '3' AND RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s')
            </Sentence>
            <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
      </Macro>

      <Macro name="ChkRknUpdSQL"> <!--对账清算公共更新SQL-->
         <DynSentence name="UpdChkSts"><!--更新交易登记簿的对账状态为未对账-->
            <Sentence>
               UPDATE tiptxnbok SET (chksts,chkdat,chkord)=('0',' ',' ')
               WHERE pbnkno='%s' AND rbnkno='%s' AND chkdat='%s' AND chkord='%s' AND bilsts='1' AND chksts='2' AND paymod='1'
               AND spckno IN (SELECT spckno FROM tipbatbok WHERE pbnkno='%s' AND rbnkno='%s' AND rspdat='%s' AND status ='5')
            </Sentence>
            <Fields>PBnkNo|RBnkNo|ChkDat|ChkOrd|PBnkNo|RBnkNo|ChkDat|</Fields>
         </DynSentence>
         <DynSentence name="UpdChkBok"><!--更新对账登记簿中的对账状态 清算状态-->
            <Sentence>
               UPDATE tipchkbok SET ChkSts='%s',RknSts='%s' WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            </Sentence>
            <Fields>ChkSts|RknSts|PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="UpdLogNo"><!--清算后更新对账登记簿LogNo-->
            <Sentence>
               UPDATE tipchkbok SET LogNo='%s' WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            </Sentence>
            <Fields>LogNo|PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="UpdTxnBok"><!--清算后更新帐务登记簿的清算状态 清算日期-->
            <Sentence>
               UPDATE tiptxnbok SET RknSts='%s',RknDat='%s' WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s' AND ChkSts='1'
            </Sentence>
            <Fields>RknSts|ActDat|PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="UpdTckNo"><!--更新会计流水号-->
            <Sentence>
               UPDATE tipchkbok SET TckNo='%s',RknDat='%s',DActNo='%s',CActNo='%s',CclNo='%s',TxnCID='%s' WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            </Sentence>
            <Fields>TckNo|ActDat|DActNo|CActNo|CclNo|TxnCID|PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
         <DynSentence name="UpdBusLog"><!--更新会计流水号,支付序号-->
            <Sentence>
               UPDATE tipchkbok SET TckNo='%s',BusLog='%s',RknDat='%s' WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
            </Sentence>
            <Fields>TckNo|BusLog|ActDat|PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
         </DynSentence>
      </Macro>
      <Macro name="IFssRptFmt"><!--IFss报表数据域格式-->
         <!--数据域格式加工-->
         <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"></Arg>
            <Arg name="SourNam" value="BilSts"></Arg>
            <Arg name="DestNam" value="CBilSts"></Arg>
            <Arg name="TblNam" value="BilStsTrans"></Arg>
         </Exec>
         <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"></Arg>
            <Arg name="SourNam" value="PayMod"></Arg>
            <Arg name="DestNam" value="CPayMod"></Arg>
            <Arg name="TblNam" value="PayModTrans"></Arg>
         </Exec>
         <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"></Arg>
            <Arg name="SourNam" value="PayTyp"></Arg>
            <Arg name="DestNam" value="CPayTyp"></Arg>
            <Arg name="TblNam" value="PayTypTrans"></Arg>
         </Exec>
         <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"></Arg>
            <Arg name="SourNam" value="RspSts"></Arg>
            <Arg name="DestNam" value="CRspSts"></Arg>
            <Arg name="TblNam" value="RspStsTrans"></Arg>
         </Exec>
         <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"></Arg>
            <Arg name="SourNam" value="ChkSts"></Arg>
            <Arg name="DestNam" value="CChkSts"></Arg>
            <Arg name="TblNam" value="ChkStsTrans"></Arg>
         </Exec>
         <Set>TckNo=ADDCHAR($TckNo,11, ,0)</Set>
         <Set>SPckNo=ADDCHAR($SPckNo,8, ,0)</Set>
         <Set>AddWord=ADDCHAR($AddWord,60, ,0)</Set>
         <Set>OrgCod=ADDCHAR($OrgCod,12, ,0)</Set>
         <Set>RAccNo=ADDCHAR($RAccNo,32, ,0)</Set>
         <Set>ActNo=ADDCHAR($ActNo,21, ,0)</Set>
         <Set>TxnAmt=ADDCHAR(AMTSIMPLEFMT($TxnAmt),15,0,1)</Set>
         <Set>TaxVID=ADDCHAR($TaxVID,18, ,0)</Set>
         <Set>TCusID=ADDCHAR($TCusID,20, ,0)</Set>
         <Set>TCusNm=ADDCHAR($TCusNm,60, ,0)</Set>
         <Set>VchNo=ADDCHAR($VchNo,8, ,0)</Set>
         <Set>VchTyp=ADDCHAR($VchTyp,3, ,0)</Set>
         <Set>RspDat=ADDCHAR($RspDat,8, ,0)</Set>
         <Set>ChkDat=ADDCHAR($ChkDat,8, ,0)</Set>
         <Set>ChkOrd=ADDCHAR($Chkord,4, ,0)</Set>
      </Macro>
      <Macro name="IFssRptFmt2"><!--IFss报表数据域格式 税种-->
         <Set>TaxTNm=ADDCHAR($TaxTNm,60, ,0)</Set>
         <Set>TTPAmt=ADDCHAR(AMTSIMPLEFMT($TTPAmt),15,0,1)</Set>
         <Set>TaxBDt=ADDCHAR($TaxBDt,8, ,0)</Set>
         <Set>TaxEDT=ADDCHAR($TaxEDT,8, ,0)</Set>
      </Macro>

      <Macro name="GetOpBkNo">
         <Set>rgn=SUBSTR($ActNo,1,3)</Set>
         <Exec  func="PUB:ReadRecord" error="IGNORE"><!--根据地区号取开户分行行号-->
            <Arg name="SqlCmd" value="GetOpBkNo" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=94999</Set>
            <Set>AddWord=交易处理失败,取开户分行号失败</Set>
            <Quote name="UpdRspInf"/>
            <Continue/>
         </If>
      </Macro>
      <Macro name="UpdPayTyp">  <!--更新支付方式-->
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdPayTyp"/>
         </Exec>
      </Macro>
      <Macro name="GetBrkNo">
         <If condition="INTCMP(STRLEN($ActNo),1,21)">
            <Set>CrdBin=SUBSTR($ActNo,1,6)</Set>
            <Exec func="PUB:ReadRecord">  <!--根据卡bin取出卡中心号的开始位置和长度-->
               <Arg name="SqlCmd" value="GetCenNo"/>
            </Exec>
            <Set>CenNo=SUBSTR($ActNo,$BgnLoc,$CenLen)</Set>
            <Exec func="PUB:ReadRecord">  <!--根据卡中心号取出卡中心地区号-->
               <Arg name="SqlCmd" value="GetRgnNo"/>
            </Exec>
            <Exec func="PUB:ReadRecord">  <!--根据地区号取得发卡分行号-->
               <Arg name="SqlCmd" value="GetBrNo"/>
            </Exec>
         </If>
         <ElseIf condition="INTCMP(STRLEN($ActNo),3,21)">
            <If condition="SUBSTR($ActNo,4,1)=9">
               <Quote name="GetOpBkNo"/>
            </If>
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="GetOpnBr"/>
            </Exec>
            <If condition="~RetCod=0"/>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
               <Quote name="GetOpBkNo"/>
            </ElseIf>
         </ElseIf>
         <ElseIf condition="INTCMP(STRLEN($ActNo),6,21)">
            <Set>RspCod=24001</Set>
            <Set>AddWord=账号不存在</Set>
            <Quote name="UpdRspInf"/>
         </ElseIf>
      </Macro>
      <Macro name="GetBrkNoSql">
         <DynSentence name="GetCenNo">  <!--根据卡bin取出卡中心号的开始位置和长度-->
            <Sentence>
               select CrdBin,BgnLoc,CenLen from stpbininf where CrdBin='%s'
            </Sentence>
            <Fields>CrdBin|</Fields>
         </DynSentence>
         <DynSentence name="GetRgnNo">  <!--根据卡中心号取出卡中心地区号-->
            <Sentence>
               select CenNo,RgnNo from stpcenrgn where CenNo='%s'
            </Sentence>
            <Fields>CenNo|</Fields>
         </DynSentence>
         <DynSentence name="GetBrNo">  <!--根据地区号取得发卡分行号-->
            <Sentence>
               select RgnNo,BrNo OBrkNo from stpceninf where RgnNo='%s'
            </Sentence>
            <Fields>RgnNo|</Fields>
         </DynSentence>
         <DynSentence name="GetOpnBr">  <!--查询财政零余额账户表取出开户行号-->
            <Sentence>
               select OpnBr OBrkNo from tipfapact where ActNo='%s'
            </Sentence>
            <Fields>ActNo|</Fields>
         </DynSentence>
      </Macro>
      <Macro name="HangSQL">
         <DynSentence name="UpdTxnBok3">
            <Sentence>
               Update tiptxnbok set LogNo='%s',BilSts='L', chksts='1',DActNo='%s',CActNo='%s',CclNo='%s',TxnCId='%s',CclDat='%s',CTckNo='%s' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
            </Sentence>
            <Fields>LogNo|DActNo|CActNo|CclNo|TxnCId|ActDat|TckNo|OrgCod|EntDat|TraNo|</Fields>
         </DynSentence>
         <DynSentence name="GetRBrkNo"><!--由接口中12位清算行支付行号取得其6位行号 作为与人行清算的分行-->
            <Sentence>
               select BrkNo from tipbrkinf where PBnkNo='%s' and RknFlg='1'
            </Sentence>
            <Fields>PBnkNo|</Fields>
         </DynSentence>
      </Macro>
      <Macro name="HangFapAct">
         <Exec func="PUB:GetLogNo"/>  <!--获取交易流水号-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetRBrkNo"/>
         </Exec>
         <Set>RknTyp=2</Set>
         <Set>CcyCod=CNY</Set>
         <Set>TTxnCd=915850</Set>
         <Set>HTxnCd=915850</Set>
         <Set>RecTyp=6</Set>
         <Set>ActSqn=00003</Set>
         <Set>TIATyp=T</Set>
         <Set>ActNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set>
         <Set>CAcNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set>
         <Set>Smr=STRCAT(财政挂账,账号,$ActNo,支付凭证号码,$LogNo)</Set>
         <Exec func="PUB:GetVirtualTeller">
            <Arg name="TxnCnl" value="TIP"/>
            <Arg name="CnlSub" value="$BrkNo"/>
         </Exec>
         <Exec func="PUB:InsertJournal"/>
         <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="HTxnCd" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod=0">  <!--主机挂帐成功-->
            <Set>HTxnSt=C</Set>
            <Set>TxnSts=C</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok3"/>
            </Exec>
            <Exec func="PUB:UpdateJournal"/>
         </If>
         <ElseIf condition="~RetCod&lt;0">     <!--超时或交易未发-->
            <Exec func="PUB:DefaultErrorProc"/> <!--不成功登记自动冲正-->
         </ElseIf>
         <ElseIf condition="~RetCod!=0">   <!--主机挂帐失败-->
            <Set>RecLvl=1</Set>
            <Set>Content=STRCAT(财政零余额账户冲正挂账失败,账号,$ActNo,错误代码,$HRspCd)</Set>
            <Quote name="BusNty"/>
         </ElseIf>
      </Macro>

      <Macro name="Init">
         <Set>BrNo=999001</Set>
         <Exec func="PUB:InitTransaction"/>
      </Macro>
      <!-- add by ly at 20090915 for CQ87568  begin --> 
      <Macro name="MSBrAuChk"> <!--省行代理权限检查SQL-->
         <DynSentence name="SelBrNo1"> <!--获取交易网点所在分行号,上级机构号,以及辖行标志(0-省分行 1-辖行)-->
            <Sentence>
               SELECT OrgBk BrNo1,SupBk SupBk1,CASE WHEN OrgBk=SupBk THEN '0' ELSE '1' END Flag1  FROM cimorgtbl WHERE OrgNo IN (SELECT OrgBk FROM cimorgtbl WHERE OrgNo='%s')
            </Sentence>
            <Fields>NodNo|</Fields>
         </DynSentence>
         <DynSentence name="SelBrNo2"><!--获取被代理机构所在分行号,上级机构号，以及辖行标志(0-省分行 1-辖行)-->
            <Sentence>
               SELECT OrgBk OprBr,SupBk SupBk2,CASE WHEN OrgBk=SupBk THEN '0' ELSE '1' END Flag2  FROM cimorgtbl WHERE OrgNo IN (SELECT OrgBk FROM cimorgtbl WHERE OrgNo='%s')
            </Sentence>
            <Fields>OprNod|</Fields>
         </DynSentence>
      </Macro>
      <Macro name="MCBrAuChk"> <!--省行代理权限检查-->	 
        <Exec func="PUB:ReadRecord" error="IGNORE">
           <Arg name="SqlCmd" value="SelBrNo1" desc=" "/>
        </Exec>
        <If condition="~RetCod!=0">
           <!-- 提示：找不到分行记录，返回错误 -->
           <Set>RspCod=910699</Set>
           <Set>RspMsg=无法查找网点所在分行信息</Set>
           <Return/>
        </If>   
        <Exec func="PUB:ReadRecord" error="IGNORE">
           <Arg name="SqlCmd" value="SelBrNo2" desc=" "/>
        </Exec>
        <If condition="~RetCod!=0">
           <!-- 提示：找不到分行记录，返回错误 -->
           <Set>RspCod=910699</Set>
           <Set>RspMsg=无法查找被代理机构归属分行号以及上级机构信息</Set>
           <Return/>
        </If>
        
        <If condition="IS_NOEQUAL_STRING($BrNo1,$OprBr)">
           <If condition="$Flag1=0"> <!--交易行是省分行-->
              <If condition="$Flag2=0"> <!--被代理机构是省分行-->
                 <Set>RspCod=910699</Set>
                 <Set>RspMsg=不能跨行操作</Set>
                 <Return/>
              </If>
       
              <Else> <!--被代理机构是辖行-->
                 <If condition="IS_NOEQUAL_STRING($SupBk1,$SupBk2)">
                    <Set>RspCod=910699</Set>
                    <Set>RspMsg=辖属关系不存在</Set>
                    <Return/>
                 </If>  
              </Else> 
           </If>
           <Else><!--辖行-->
              <If condition="IS_NOEQUAL_STRING($BrNo1,$OprBr)">
                 <Set>RspCod=910699</Set>
                 <Set>RspMsg=辖行只能处理本行交易</Set>
                 <Return/>
              </If>
           </Else> 
        </If>
      </Macro>
     <!-- add by ly at 20090915 for CQ87568 end -->         
   </Define>

   <!--实时扣税交易-->
   <!--Modified By sundx_BoCom00067299_20090602 修改交易915830，解决财政零余额账户实时扣税后开户网点为空的问题-->
   <Transaction code="915830">
      <Quote name="ChkStsSQL"/>        <!--检查系统状态-->
      <Quote name="ChkArgSQL"/>        <!--检查协议-->
      <Quote name="UpdPrtNodSQL"/>     <!--更新打印网点-->
      <DynSentence name="ChkRvs">
         <Sentence>
            SELECT CnlNo FROM tiprvsbok WHERE OOrgCod='%s' AND OEntDat='%s' AND OTraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdRvsBok">
         <Sentence>
            UPDATE tiprvsbok SET CnlSts='0',CBrkNo='%s' WHERE OOrgCod='%s' AND OEntDat='%s' AND OTraNo='%s'
         </Sentence>
         <Fields>CBrkNo|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="GetOpBkNo">   <!--由地区码取6位分行号 作为出账分行-->
         <Sentence>
            SELECT BrkNo OBrkNo  FROM tiprgnbrk WHERE rgn='%s'
         </Sentence>
         <Fields>rgn|</Fields>
      </DynSentence>
      <DynSentence name="GetRBrkNo">   <!--由接口中12位清算行支付行号取得其6位行号 作为与人行清算的分行-->
         <Sentence>
            SELECT BrkNo RBrkNo,ActSqn  FROM tipbrkinf WHERE PBnkNo='%s' AND RknFlg='1'
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetCrBkNo">   <!--由清算国库的支付行号取得 清算类型 批扣类型 协议检查标志 电子回单标志 关联行号(入账分行)-->
         <Sentence>
            SELECT RknTyp,BatTyp,PChkFg,BCrtFg,BrkNo CBrkNo,RBnkNm FROM tiptrerkn WHERE RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">
         <Sentence>
            UPDATE tiptxnbok SET BilSts='%s',RspSts='%s',HTxnSt='%s',TckNo='%s',HRspCd='%s',ONodNo='%s'
            WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
         </Sentence>
         <Fields>BilSts|RspSts|HTxnSt|TckNo|HRspCd|ONodNo|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdAddWord">
         <Sentence>
            UPDATE tiptxnbok SET AddWord='%s'
            WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
         </Sentence>
         <Fields>AddWord|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="Qryfapact">   <!--检查是否是财政零余额账户-->
         <Sentence>
            SELECT  ActNam BrNam,OpnBr,OpnNod,EleBk,PayCod ,FinAre,ANodNm, CusCod
            FROM tipfapact
            WHERE ActNo='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <DynSentence name="QryStpBinInf"><!--取卡中心号位置-->
         <Sentence>
            SELECT BgnLoc,CenLen FROM stpbininf
            WHERE CrdBin='%s'
         </Sentence>
         <Fields>Bin|</Fields>
      </DynSentence>
      <DynSentence name="GetSubCnl">   <!--取交易卡所在分行号-->
         <Sentence>
            SELECT b.BrNo OBrkNo FROM stpcenrgn a, stpceninf b
            WHERE a.CenNo='%s' AND b.RgnNo=a.RgnNo
         </Sentence>
         <Fields>CenNo|</Fields>
      </DynSentence>
      <DynSentence name="QryCusAgr">
         <Sentence>
            SELECT ActFlg,ActNam,BrkNo OBrkNo,ActSeq,TCusId
            FROM tipcusagr
            WHERE AgrNo='%s' AND ActNo='%s' AND Status='0'
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
        
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Quote name="GetSeq"/>
         <Set>PayMod=0</Set>
         <Set>RspSts=1</Set>           <!--已发送回执-->
         <Set>ReqDat=$WrkDat</Set>
         <Set>RspDat=$WrkDat</Set>
         <Set>TTxnCd=915830</Set>
         <Set>CcyCod=CNY</Set>
         <Set>RecTyp=0</Set>           <!--实时扣税-->
         <Set>Status=0</Set>
         <Set>CrpCod=0000000000</Set>
         <Set>FapFlg=0</Set>           <!--默认非财政账户-->
         <Set>CnlTyp=1</Set>           <!--前置-->
         <!--检查系统状态-->
         <Quote name="ChkStsCTL"/>

         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCrBkNo" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=94999</Set>
            <Set>AddWord=交易处理失败,取国库关联行失败</Set>
            <Return/>
         </If>
         
         <!--查询三方协议表-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="QryCusAgr"/>
         </Exec>
         <If condition="~RetCod=0">
            <If condition="$ActFlg=2">
               <Set>HTxnCd=915910</Set>
               <Set>CnlSub=$OBrkNo</Set>
               <Set>PayTyp=2</Set>     <!--卡号-->
               <Set>DrwTyp=3</Set>     <!--不验密-->
            </If>
            <ElseIf condition="$ActFlg=3">
               <Set>HTxnCd=915910</Set>
               <Set>DrwTyp=3</Set>     <!--不验密-->
               <!--Set>PIDTyp=01</Set-->
               <Set>PayTyp=3</Set>     <!-- 活期存折-->
               <Set>CnlSub=$OBrkNo</Set>
            </ElseIf>
            <ElseIf condition="$ActFlg=4">
               <Set>HTxnCd=915910</Set>
               <Set>DrwTyp=3</Set>      <!--不验密-->
               <!--Set>PIDTyp=01</Set-->
               <Set>PayTyp=4</Set>      <!-- 活期一本通-->
               <Set>CnlSub=$OBrkNo</Set>
            </ElseIf>
            <Else>
               <Exec  func="PUB:ReadRecord" error="IGNORE">      <!--财政余额帐户类型-->
                  <Arg name="SqlCmd" value="Qryfapact" />
               </Exec>
               <If condition="~RetCod=0">
                  <Set>FapFlg=1</Set>
               </If>
               <Else>
                  <Set>HTxnCd=915830</Set>
                  <Set>FapFlg=0</Set>
                  <Set>MsgTyp=N</Set>
                  <Set>RspCod=000000</Set>
               </Else>
               <Set>CnlSub=$OBrkNo</Set>
            </Else>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
            <If condition="STRLEN($ActNo)&gt;21">                <!--帐号位数大于21，非法帐号-->
               <Set>RspCod=24001</Set>
               <Set>AddWord=账号不存在</Set>
               <Return/>
            </If>
            <ElseIf condition="STRLEN($ActNo)&lt;21">            <!--帐号位数小于21，卡号-->
               <Set>Bin=SUBSTR($ActNo,1,6)</Set>
               <Exec  func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="QryStpBinInf" />
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=24001</Set>
                  <Set>AddWord=根据卡bin取出卡中心号的开始位置和长度错误</Set>
                  <Return/>
               </If>
               <Set>CenNo=SUBSTR($ActNo,$BgnLoc,$CenLen)</Set>
               <Exec  func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="GetSubCnl" />
               </Exec>
               <If condition="~RetCod!=0">
                  <Set>RspCod=24001</Set>
                  <Set>AddWord=取发卡分行号失败</Set>
                  <Return/>
               </If>
               <Set>HTxnCd=915910</Set>
               <Set>CnlSub=$OBrkNo</Set>
               <Set>PayTyp=2</Set>                            <!--卡号-->
               <Set>DrwTyp=3</Set>                            <!--不验密-->
            </ElseIf>
            <Else>                                            <!-- 帐号-->
               <If condition="STRCMP(SUBSTR($ActNo,4,1),9)=0"><!--对私账号-->
                  <Set>HTxnCd=915910</Set>
                  <Set>DrwTyp=3</Set>                         <!--不验密-->
                  <!--Set>PIDTyp=01</Set-->
                  <Set>PayTyp=3</Set>                         <!-- 活期存折-->
               </If>
               <Else>
                  <Exec  func="PUB:ReadRecord" error="IGNORE"><!--财政余额帐户类型-->
                     <Arg name="SqlCmd" value="Qryfapact" />
                  </Exec>
                  <If condition="~RetCod=0">
                     <Set>FapFlg=1</Set>
                  </If>
                  <Else>
                     <Set>HTxnCd=915830</Set>
                     <Set>FapFlg=0</Set>
                     <Set>MsgTyp=N</Set>
                     <Set>RspCod=000000</Set>
                  </Else>
               </Else>
               <!--取地区号 开户行号 虚拟柜员 关联行行号和科目序号 清算行行号-->
               <Set>rgn=SUBSTR($ActNo,1,3)</Set>
               <Exec  func="PUB:ReadRecord" error="IGNORE">      <!--根据地区号取开户分行行号-->
                  <Arg name="SqlCmd" value="GetOpBkNo" />
               </Exec>
               <If condition="~RetCod=-2">
                  <Set>RspCod=94999</Set>
                  <Set>AddWord=交易处理失败,取开户分行号失败</Set>
                  <Return/>
               </If>
               <Set>CnlSub=$OBrkNo</Set>
            </Else>
         </ElseIf>
         <Else>
            <Set>RspCod=94999</Set>
            <Set>AddWord=查询三方协议表的时候出错</Set>           
            <Return/>
         </Else>
         
         <Exec func="PUB:GetVirtualTeller"/>
         <Exec  func="PUB:ReadRecord" error="IGNORE">            <!--由接口中12位清算行支付行号取得其6位行号-->
            <Arg name="SqlCmd" value="GetRBrkNo" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=94999</Set>
            <Set>AddWord=交易处理失败,取清算行信息失败</Set>
            <Return/>
         </If>
         
         <!--检查冲正登记簿-->
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkRvs" />
         </Exec>
         <If condition="~RetCod=0">
            <Set>BilSts=3</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Exec func="PUB:InsertRecord">
               <Arg name="TblNam" value="tiptxnbok"/>
            </Exec>
            <Set>RspCod=24020</Set>
            <Return/>
         </If>

         <!--登记人行交易登记簿-->
         <Exec func="PUB:GetLogNo"/>
         <Exec func="PUB:InsertRecord" error="IGNORE">
            <Arg name="TblNam" value="tiptxnbok"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=94999</Set>
            <Set>AddWord=交易处理失败,插入交易登记簿失败</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdAddWord"/>
            </Exec>
            <Return/>
         </If>

         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tipttprec"/>
            <Arg name="GrpNam" value="TaxTypeList3001"/>
            <Arg name="FldLst" value="OrgCod|EntDat|TraNo|"/>
         </Exec>

         <!--检查协议-->
         <Switch expression="$PChkFg">
            <Case value="0"><!--有协议号就检查-->
               <Exec  func="PUB:IsExistNode">
                  <Arg name="FieldName" value="AgrNo"/>
               </Exec>
               <If condition="~RetCod=1">
                  <Quote name="ChkArg"/>
               </If>
               <Else>
                  <Set>PrtNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set><!--税票打印网点设置成关联行账务中心-->
               </Else>
               <Break/>
            </Case>
            <Case value="1">                                       <!--强制检查(征收机关、帐号)-->
               <Exec  func="PUB:IsExistNode">
                  <Arg name="FieldName" value="AgrNo"/>
               </Exec>
               <If condition="~RetCod!=1">                         <!--报文中无协议号节点-->
                  <Set>RspCod=24009</Set>
                  <Set>AddWord=账户未签约</Set>
                  <Set>BilSts=2</Set>
                  <Exec  func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok2" />
                  </Exec>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdAddWord"/>
                  </Exec>
                  <Return/>
               </If>
               <Quote name="ChkArg"/>
               <Break/>
            </Case>
            <Case value="2"><!--不检查-->
               <Set>PrtNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set>   <!--税票打印网点设置成关联行账务中心-->
               <Break/>
            </Case>
            <Default>
               <Set>PrtNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set>   <!--税票打印网点设置成关联行账务中心-->
            </Default>
         </Switch>
         
         <Quote name="UpdPrtNod"/>                                 <!--更新打印网点-->
         <Set>Smr=STRCAT(征收机关,$OrgCod, 税票号,$TaxVID)</Set>
         <Set>BrNo=$CBrkNo</Set>
         <Set>ActNod=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
         <Set>BrkNo=$OBrkNo</Set>                                  <!--赋值开户分行号给交易分行号 用于跟主机核对流水-->

         <If condition="$FapFlg=1">                                <!--财政零余额帐户-->
            <Set>APVchN=$LogNo</Set>
            <Set>BrNo=$OpnBr</Set>
            <Set>PyeAct=$RAccNo</Set>
            <Set>PyeNam=$RAccNm</Set>
            <Set>PyeBk=$RBnkNm</Set>
            <Set>UdwDat=$WrkDat</Set>
            <Set>AthAmt=$TxnAmt</Set>
            <Set>VInTlr=$TlrId</Set>
            <Set>VRgNod=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
            <Set>HSubCd=002</Set>                                  <!-- 001：借零余额户贷26201 002：借零余额户贷22203９?02-->
            <!--Modified by sundx_BoCom00067299_20090602-->
            <Set>ONodNo=$OpnNod</Set>
            <!--Ended by sundx_BoCom00067299_20090602-->
            <!-- BoCom00065517 add by zhb 2009-6-19 start -->
            <Set>StlMod=07</Set>
            <!-- BoCom00065517 end-->
            <Exec func="PUB:CallThirdAcc" error="IGNORE">
               <Arg name="HTxnCd" value="363412" />                <!-- 调用财政系统记账接口-->
               <Arg name="ObjSvr" value="STHDTIP1" />
            </Exec>
            <Switch expression="~RetCod">
               <Case value="0">                                    <!--成功-->
                  <Set>BilSts=1</Set>
                  <Set>HTxnSt=S</Set>
                  <Set>TxnSts=S</Set>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="3">                                    <!--交易失败-->
                  <Set>BilSts=2</Set>
                  <Set>HTxnSt=F</Set>
                  <Set>TxnSts=F</Set>
                  <Set>RspCod=$HRspCd</Set>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok"/>
                  </Exec>
                  <Exec func="PUB:CodeSwitching">
                     <Arg name="DatSrc" value="TIPCSW"></Arg>
                     <Arg name="SourNam" value="RspCod"></Arg>
                     <Arg name="DestNam" value="Result"></Arg>
                     <Arg name="TblNam" value="Cod2Res"></Arg>
                  </Exec>
                  <Exec func="PUB:CodeSwitching">
                     <Arg name="DatSrc" value="TIPCSW"></Arg>
                     <Arg name="SourNam" value="Result"></Arg>
                     <Arg name="DestNam" value="AddWord"></Arg>
                     <Arg name="TblNam" value="Res2Wrd"></Arg>
                  </Exec>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdAddWord"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="-1">                                   <!--返回人行tips系统(使用SetNoResponse)-->
                  <Set>BilSts=2</Set>
                  <Set>RspSts=0</Set>                              <!--未发回执-->
                  <Set>HTxnSt=T</Set>
                  <Set>TxnSts=T</Set>
                  <Set>TckNo=   </Set>
                  <Set>HRspCd=   </Set>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok"/>
                  </Exec>
                  <Exec func="PUB:SetNoResponse"/>
                  <Break/>
               </Case>
               <Default>
                  <Break/>
               </Default>
            </Switch>
            <Return/>
         </If>
         <Else>                                                    <!--非财政余额帐户-->
            <Exec func="PUB:InsertRecord" error="IGNORE">
               <Arg name="TblNam" value="tiptxnjnl"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Set>RspCod=94999</Set>
               <Set>AddWord=交易处理失败,预计流水失败</Set>
               <Set>BilSts=2</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok2" />
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdAddWord"/>
               </Exec>
               <Return/>
            </If>

            <!--预设开户网点,防止主机返回错误是发生数据库操作失败-->
            <Set>ONodNo=$PrtNod</Set>
            <Exec func="PUB:CallHostAcc" error="IGNORE">           <!--上主机扣款-->
               <Arg name="HTxnCd" value="$HTxnCd" />
               <Arg name="ObjSvr" value="SHSTPUB1" />
            </Exec>
            <Switch expression="~RetCod">
               <Case value="0">                                    <!--成功-->
                  <Set>BilSts=1</Set>
                  <Set>HTxnSt=S</Set>
                  <Set>TxnSts=S</Set>
                  <Exec func="PUB:UpdateJournal">
                     <Arg name="ONodNo" value="$ONodNo" />
                  </Exec>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="3">                                    <!--交易失败-->
                  <Set>BilSts=2</Set>
                  <Set>HTxnSt=F</Set>
                  <Set>TxnSts=F</Set>
                  <Set>RspCod=$HRspCd</Set>
                  <Exec func="PUB:UpdateJournal"/>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok"/>
                  </Exec>
                  <Exec func="PUB:CodeSwitching">
                     <Arg name="DatSrc" value="TIPCSW"></Arg>
                     <Arg name="SourNam" value="RspCod"></Arg>
                     <Arg name="DestNam" value="Result"></Arg>
                     <Arg name="TblNam" value="Cod2Res"></Arg>
                  </Exec>
                  <Exec func="PUB:CodeSwitching">
                     <Arg name="DatSrc" value="TIPCSW"></Arg>
                     <Arg name="SourNam" value="Result"></Arg>
                     <Arg name="DestNam" value="AddWord"></Arg>
                     <Arg name="TblNam" value="Res2Wrd"></Arg>
                  </Exec>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdAddWord"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="-1">                                   <!--主机超时-->
                  <Set>BilSts=T</Set>
                  <Set>RspSts=0</Set>                              <!--未发回执-->
                  <Set>HTxnSt=T</Set>
                  <Set>TxnSts=T</Set>
                  <Set>TckNo=   </Set>
                  <Set>HRspCd=   </Set>
                  <Exec func="PUB:UpdateJournal"/>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok"/>
                  </Exec>
                  <Exec func="PUB:SetNoResponse"/>
                  <Break/>
               </Case>
               <Default>
                  <Break/>
               </Default>
            </Switch>
         </Else>
      </FlowCtrl>
   </Transaction>

   <!--冲正-->
   <Transaction code="915839">
      <DynSentence name="GetCBrkNo">
         <Sentence>
            select CBrkNo,PBnkNo from tiptxnbok
            where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnBok">
         <Sentence>
            select TraNo,BilSts,HTxnSt,ActDat OActDt,ChkSts,LogNo,ChkSts,CBrkNo,ActNo,TxnAmt from tiptxnbok
            where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryFapAct"><!--查是否是财政零余额账户-->
         <Sentence>
            select * from tipfapact where ActNo ='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">
         <Sentence>
            Update tiptxnbok Set BilSts='3' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdRvsBok">
         <Sentence>
            Update tiprvsbok Set CnlSts='%s' where OOrgCod='%s' and OEntDat='%s' and OTraNo='%s'
         </Sentence>
         <Fields>CnlSts|OrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnJnl">
         <Sentence>
            select BusTyp,CrpCod,ActNo,TxnAmt,HTxnCd,HLogNo,TckNo,TlrId
            from tiptxnJnl where LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnJnl">
         <Sentence>
            Update tiptxnjnl Set HTxnSt='%s',TxnSts='%s' where LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|TxnSts|LogNo|</Fields>
      </DynSentence>
      <Quote name="HangSQL"/>

      <Attributes>
         <Attribute name="noresponse" value="1"/>
         <Attribute name="integrity" value="2" code="915838" interval="5" timeout="30" maxtimes="15"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>CrpCod=0000000000</Set>
         <Set>OOrgCod=$OrgCod</Set>
         <Set>ReqDat=$ActDat</Set>
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCBrkNo" />
         </Exec>
         <If condition="~RetCod=-2"><!--原交易不存在-->
            <Set>CBrkNo=XXXXXX</Set>
         </If>
         <Set>CnlSts=0</Set><!--登记冲正登记簿（状态为未处理)-->
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tiprvsbok"/>
         </Exec>
         <Exec  func="PUB:ReadRecord" error="IGNORE"><!--取原登记簿信息-->
            <Arg name="SqlCmd" value="QryTxnBok" />
         </Exec>
         <If condition="~RetCod=-2"><!--原交易不存在-->
            <Set>CnlSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Return/>
         </If>
         <If condition="IS_NOEQUAL_STRING($BilSts,0)=0"><!--交易状态为预计（未处理）-->
            <Set>CnlSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Return/>
         </If>
         <If condition="AND(IS_NOEQUAL_STRING($BilSts,1),IS_NOEQUAL_STRING($BilSts,T))"><!--原交易不成功-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
            <Set>CnlSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Return/>
         </If>
         <If condition="$ActDat!=$OActDt"><!--已隔日-->
            <Set>CnlSts=2</Set><!--需要冲账-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Return/>
         </If>
         <If condition="$ChkSts!=0"><!--已对账-->
            <Set>CnlSts=3</Set><!--已对账-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Return/>
         </If>
         <Exec  func="PUB:ReadRecord" error="IGNORE"><!--取原流水-->
            <Arg name="SqlCmd" value="QryTxnJnl" />
         </Exec>
         <Exec  func="PUB:ReadRecord" error="IGNORE"><!--判断是否财政余额帐户类型-->
            <Arg name="SqlCmd" value="QryFapAct" />
         </Exec>
         <If condition="~RetCod=0">  <!--财政零余额帐号-->
            <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
            <Quote name="HangFapAct"/>
            <Set>CnlSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
         </If>
         <ElseIf condition="~RetCod=-2 "><!--非财政零余额帐户-->
            <Set>RspCod=000000</Set>
            <Set>TIATyp=C</Set>       <!--TIATYP为C则按前置流水号抹账，为T按主机的三要素抹账-->
            <Set>HTxnCd=STRCAT(SUBSTR($HTxnCd,1,5),9)</Set>
            <Set>TTxnCd=$HTxnCd</Set>
            <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
            <Exec func="PUB:CallHostOther" error="IGNORE">
               <Arg name="HTxnCd" value="959999" />
               <Arg name="ObjSvr" value="SHSTPUB1" />
            </Exec>
            <If condition="~RetCod=0">      <!--抹账成功-->
               <Set>HTxnSt=C</Set>
               <Set>TxnSts=C</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Set>CnlSts=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRvsBok"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnJnl"/>
               </Exec>
            </If>
            <ElseIf condition="~RetCod&lt;0">     <!--超时或交易未发-->
               <Exec func="PUB:DefaultErrorProc"/> <!--不成功登记自动冲正-->
            </ElseIf>
            <Else>                          <!--主机抹账失败-->
               <Switch expression="$HRspCd">
                  <Case value="AG8001"/>       <!--该前置流水号不存在  -->
                  <Case value="AG8981"/>       <!--该前置流水号不存在  -->
                  <Case value="SC6129"/>       <!--原交易不存在        -->
                  <Case value="SC6034">        <!--原交易已经被抹 认为抹账成功-->
                     <Set>HTxnSt=C</Set>
                     <Set>TxnSts=C</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdTxnBok"/>
                     </Exec>
                     <Set>CnlSts=1</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdRvsBok"/>
                     </Exec>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdTxnJnl"/>
                     </Exec>
                     <Break/>
                  </Case>
               </Switch>
            </Else>
         </ElseIf>
      </FlowCtrl>
   </Transaction>


   <!--自动冲正-->
   <Transaction code="915838">
      <DynSentence name="QryOritxnbok">
         <Sentence>
            SELECT * FROM tiptxnbok WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnJnl">
         <Sentence>
            select BusTyp,CrpCod,ActNo,TxnAmt,HTxnCd,HLogNo,TckNo,TlrId
            from tiptxnJnl where LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="QryOrirvsbok"><!--根据征收机关代码、委托日期、人行交易流水号提取冲正登记簿记录-->
         <Sentence>
            SELECT CnlSts FROM tiprvsbok where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryFapAct"><!--查是否是财政零余额账户-->
         <Sentence>
            select * from tipfapact where ActNo ='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok"><!--OrgCod='%s' and EntDat='%s' and TraNo='%s'-->
         <Sentence>
            Update tiptxnbok Set BilSts='3' where LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdRvsBok">
         <Sentence>
            Update tiprvsbok Set CnlSts='%s' where OOrgCod='%s' and OEntDat='%s' and OTraNo='%s'
         </Sentence>
         <Fields>CnlSts|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnJnl">
         <Sentence>
            Update tiptxnjnl Set HTxnSt='%s',TxnSts='%s' where LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|TxnSts|LogNo|</Fields>
      </DynSentence>

      <Quote name="HangSQL"/>

      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord" error="IGNORE"><!--根据前置流水号LogNo查询交易登记簿tiptxnbok的帐号 -->
            <Arg name="SqlCmd" value="QryOritxnbok" />
         </Exec>
         <If condition="~RetCod=-2">   <!--若查询不到记录，则设置RspCod=000000,交易结束-->
            <Set>RspCod=000000</Set>
            <Return/>
         </If>
         <ElseIf condition="~RetCod&lt;0">
            <Return/>
         </ElseIf>

         <Exec func="PUB:ReadRecord" error="IGNORE"> <!--根据征收机关代码、委托日期、人行交易流水号提取冲正登记簿记录 -->
            <Arg name="SqlCmd" value="QryOrirvsbok" />
         </Exec>
         <If condition="~RetCod=-2">   <!--若查询不到记录，则设置RspCod=000000,交易结束-->
            <Set>RspCod=000000</Set>
            <Return/>
         </If>
         <If condition="$CnlSts!=0">   <!--若状态不是未处理，返回交易成功。（已处理，无须再处理）-->
            <Set>RspCod=000000</Set>
            <Return/>
         </If>
         <If condition="IS_NOEQUAL_STRING($BilSts,1)=0"><!--交易状态为预计（未处理）-->
            <Set>CnlSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Return/>
         </If>
         <If condition="AND(IS_NOEQUAL_STRING($BilSts,1),IS_NOEQUAL_STRING($BilSts,T))"><!--原交易不成功-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
            <Set>CnlSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Return/>
         </If>
         <If condition="$ActDat!=$OActDt"><!--已隔日-->
            <Set>CnlSts=2</Set><!--需要冲账-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Return/>
         </If>
         <If condition="$ChkSts!=0"><!--已对账-->
            <Set>CnlSts=3</Set><!--已对账-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
            <Return/>
         </If>
         <Exec  func="PUB:ReadRecord" error="IGNORE"><!--取原流水-->
            <Arg name="SqlCmd" value="QryTxnJnl" />
         </Exec>
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="QryFapAct" />
         </Exec>
         <If condition="~RetCod=0">  <!--财政零余额帐号-->
            <Quote name="HangFapAct"/>
            <Set>CnlSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRvsBok"/>
            </Exec>
         </If>
         <ElseIf condition="~RetCod=-2 "><!--非财政余额帐户-->
            <Set>TIATyp=C</Set>
            <Set>HTxnCd=STRCAT(SUBSTR($HTxnCd,1,5),9)</Set>
            <Set>TTxnCd=$HTxnCd</Set>
            <Exec func="PUB:CallHostOther" error="IGNORE"><!--上主机系统抹账 -->
               <Arg name="HTxnCd" value="959999" /><!--主机交易码 -->
               <Arg name="ObjSvr" value="SHSTPUB1" />
            </Exec>
            <If condition="~RetCod=0">    <!--抹账成功-->
               <Set>HTxnSt=C</Set>
               <Set>TxnSts=C</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Set>CnlSts=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRvsBok"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnJnl"/>
               </Exec>
               <Set>RspCod=000000</Set>
            </If>
            <Else>                                <!--主机抹账失败-->
               <Switch expression="$HRspCd">
                  <Case value="AG8001"/>     <!--该前置流水号不存在-->
                  <Case value="AG8981"/>     <!--该前置流水号不存在-->
                  <Case value="SC6129"/>     <!--原交易不存在-->
                  <Case value="SC6034">      <!--原交易已经被抹-->
                     <Set>HTxnSt=C</Set>
                     <Set>TxnSts=C</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdTxnBok"/>
                     </Exec>
                     <Set>CnlSts=1</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdRvsBok"/>
                     </Exec>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdTxnJnl"/>
                     </Exec>
                     <Set>RspCod=000000</Set>
                     <Break/>
                  </Case>
                  <Default>
                     <Return/>
                  </Default>
               </Switch>
            </Else>
         </ElseIf>
      </FlowCtrl>
   </Transaction>

   <!--批量扣税-->
   <Transaction code="915801">
      <Quote name="ChkStsSQL"/>
      <DynSentence name="GetCBrkNo">
         <Sentence>
            select BrkNo CBrkNo from tiptrerkn where RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetOpBkNo"><!--由地区码取6位分行号 作为出账分行-->
         <Sentence>
            select brkno OBrkNo from tiprgnbrk where rgn='%s'
         </Sentence>
         <Fields>rgn|</Fields>
      </DynSentence>
      <DynSentence name="GetRBrkNo"><!--由接口中12位清算行支付行号取得其6位行号 作为与人行清算的分行-->
         <Sentence>
            select BrkNo RBrkNo,ActSqn  from tipbrkinf where PBnkNo='%s' and RknFlg='1'
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkAgr"><!--检查协议-->
         <Sentence>
            select brkno,TCusId,ActNam from tipcusagr where agrno='%s' and ActNo='%s' and status='0'
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
      </DynSentence>
      <DynSentence name="GetCrBkNo"><!--取清算类型 批扣类型 协议检查标志 电子回单标志 关联行号-->
         <Sentence>
            select RknTyp,BatTyp,PChkFg,BCrtFg,BrkNo CBrkNo from tiptrerkn where RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">
         <Sentence>
            Update tiptxnbok Set BilSts='%s',HTxnSt='%s',TckNo='%s'
            where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>BilSts|HTxnSt|TckNo|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="SUM">
         <Sentence>
            select count(*) TolCnt,SUM(CAST(TxnAmt as bigint)) TolAmt from tiptxnbok
            where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdStatus"><!--更新批量状态为重新处理-->
         <Sentence>
            update tipbatbok Set Status='2' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkNoSql"/>

      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>CrpCod=0000000000</Set>
         <Set>OMsgNo=$MsgNo</Set><!--原报文编号-->
         <Set>ReqNo=$SPckNo</Set><!--原指令序号为包流水号-->

         <Set>PayMod=1</Set>
         <Set>ReqDat=$WrkDat</Set><!--用人行工作日期-->
         <Set>TTxnCd=915801</Set>
         <Set>CcyCod=CNY</Set>
         <Set>RspDat=$WrkDat</Set><!--用人行工作日期-->

         <Set>RecTyp=1</Set><!--批量扣税-->

         <!--检查系统状态-->
         <Quote name="ChkStsCTL"/>

         <Set>RcvTm=SUBSTR(GETDATETIME(),9,6)</Set>
         <If condition="STRCMP($RcvTm,@BCFG.BegTm)=1"><!--拒收批量包-->
            <If condition="STRCMP(@BCFG.EndTm,$RcvTm)=1">
               <Set>RspCod=94999</Set>
               <Set>AddWord=交易处理失败</Set>
               <Quote name="GetSeq"/><!--取新的MsgId-->
               <Exec func="PUB:CallThirdOther" error="IGNORE">
                  <Arg name="HTxnCd" value="9121X"/>
                  <Arg name="ObjSvr" value="SMQMTIP2"/>
               </Exec>
               <Return/>
            </If>
         </If>
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCrBkNo" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=94999</Set>
            <Set>AddWord=交易处理失败</Set>
            <Quote name="GetSeq"/><!--取新的MsgId-->
            <Exec func="PUB:CallThirdOther" error="IGNORE">
               <Arg name="HTxnCd" value="9121X"/>
               <Arg name="ObjSvr" value="SMQMTIP2"/>
            </Exec>
            <Return/>
         </If>

         <!--取地区号 开户行号 虚拟柜员 关联行行号和科目序号 清算行行号-->
         <Quote name="GetBrkNo"/>
         <!--Exec  func="PUB:ReadRecord" error="IGNORE"--><!--根据收款行支付行号取得关联行号-->
         <!--Arg name="SqlCmd" value="GetCBrkNo" />
         </Exec>
         <If condition="~RetCod=-2">
         <Set>RspCod=94999</Set>
         <Set>AddWord=交易处理失败,取开户分行号失败</Set>
         <Goto>Response</Goto>
         </If-->
         <Set>CnlSub=$OBrkNo</Set>
         <Exec func="PUB:GetVirtualTeller"/>
         <Exec  func="PUB:ReadRecord" error="IGNORE"><!--由接口中12位清算行支付行号取得其6位行号 作为与人行清算的分行-->
            <Arg name="SqlCmd" value="GetRBrkNo" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=94999</Set>
            <Set>AddWord=交易处理失败</Set>
            <Quote name="GetSeq"/><!--取新的MsgId-->
            <Exec func="PUB:CallThirdOther" error="IGNORE">
               <Arg name="HTxnCd" value="9121X"/>
               <Arg name="ObjSvr" value="SMQMTIP2"/>
            </Exec>
            <Return/>
         </If>

         <!--计算回执发送截止日-->
         <Set>ExpDat=$EntDat</Set>
         <Exec func="PUB:GetPubSeqNoCircle"><!--申请响应包号-->
            <Arg name="SeqNam" value="TIP:RPckNo"/>
            <Arg name="SeqCnd" value="RPckNo"/>
            <Arg name="Len" value="8"/>
         </Exec>
         <Set>RPckNo=$SelVal</Set>

         <Exec func="PUB:InsertRecordByGroup">
            <Arg name="TableName" value="tiptxnbok"/>
            <Arg name="GroupName" value="Payment3102"/>
         </Exec>
         <Exec func="PUB:CommitWork"/>
         <Set>ROOT.i=1</Set>
         <While condition="INTCMP($AllNum,5,$ROOT.i)">
            <Exec func="PUB:InsertRecordByGroup">
               <Arg name="TableName" value="tipttprec"/>
               <Arg name="RootName"  value="STRCAT(ROOT.Payment3102_,$ROOT.i)"/>
               <Arg name="GroupName" value="TaxTypeList3102"/>
               <Arg name="FldLst" value="OrgCod|EntDat|TraNo|"/>
            </Exec>
            <If condition="MOD($ROOT.i,100)=0">
               <Exec func="PUB:CommitWork"/>
            </If>
            <Set>i=ADD($ROOT.i,1)</Set>
         </While>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tipbatbok"/>
         </Exec>
         <Exec func="PUB:CommitWork"/>

         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="SUM" />
         </Exec>
         <If condition="OR(INTCMP($TolCnt,4,$AllNum),INTCMP($TolAmt,4,$AllAmt))">
            <Set>RspCod=93007</Set>
            <Set>AddWord=包总分不符</Set>
            <Quote name="GetSeq"/><!--取新的MsgId-->
            <Exec func="PUB:CallThirdOther" error="IGNORE">
               <Arg name="HTxnCd" value="9121X"/>
               <Arg name="ObjSvr" value="SMQMTIP2"/>
            </Exec>
            <Return/>
         </If>
         <Set>RspCod=90000</Set>
         <Set>AddWord=交易成功</Set>
         <Quote name="GetSeq"/><!--取新的MsgId-->
         <Exec func="PUB:CallThirdOther" error="IGNORE">
            <Arg name="HTxnCd" value="9121X"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=000000</Set>
            <Set>MsgTyp=N</Set>
         </If>
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="Payment3102"/>
         </Exec>
         <!--处理该批次的扣款-->
         <Exec func="PUB:CallLocal">
            <Arg name="TxnCod" value="915803"/>
            <Arg name="ObjSvr" value="OFRTTIP1"/>
         </Exec>
      </FlowCtrl>
   </Transaction>


   <!--批量扣税 定时触发-->
   <Transaction code="915802">
      <DynSentence name="QryBatBokDay"><!--日间-->
         <Sentence>
            select OrgCod,EntDat,SPckNo,Status,BatTyp,ExpDat,DskNo,RBnkNo from tipbatbok
            where ExpDat='%s' and Status in ('0','2') for read only
         </Sentence>
         <Fields>ActDat|</Fields>
      </DynSentence>
      <DynSentence name="QryBatBokNigt"><!--夜间-->
         <Sentence>
            select OrgCod,EntDat,SPckNo,Status,BatTyp,ExpDat,DskNo,RBnkNo from tipbatbok
            where Status in ('0','2') and (BatTyp='1'  or (BatTyp='0' and ExpDat='%s' )) for read only
         </Sentence>
         <Fields>ActDat|</Fields>
      </DynSentence>
      <DynSentence name="QryBatBok"><!--日终某固定时点触发-->
         <Sentence>
            select OrgCod,EntDat,SPckNo,Status,BatTyp,ExpDat,DskNo,RBnkNo from tipbatbok
            where Status = '2' and ReqDat='%s'  for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="UpdBatBok">
         <Sentence>
            Update tipbatbok Set status='%s',AddWord='%s' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>Status|AddWord|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">
         <Sentence>
            Update tiptxnbok Set BilSts='%s',AddWord='%s' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>BilSts|AddWord|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="QryWrkDat">
         <Sentence>
            select WorkDt WrkDat from tipsyssts
         </Sentence>
      </DynSentence>
      <Attributes>
         <Attribute name="nodatabase" value="2"/><!--全程数据库连接-->
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>CrpCod=0000000000</Set>
         <Exec func="PUB:Lock">
            <Arg name="RecKey" value="STRCAT($AplCls,$TxnCod)"/>
            <Arg name="TimOut" value="10"/>
         </Exec>
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryWrkDat"/>
         </Exec>
         <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="SqlCmd" value="QryBatBok"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99004</Set>
            <Set>AddWord=系统错误</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>AddWord=数据库错误</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Set>Status=1</Set>
            <Set>AddWord=  </Set>
            <Exec func="PUB:ExecSql"><!--更新批次为正在处理-->
               <Arg name="SqlCmd" value="UpdBatBok"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>
            <Exec func="PUB:CallLocal">
               <Arg name="TxnCod"  value="915803"/>
               <Arg name="ObjSvr"  value="OFRTTIP1"/>
            </Exec>
         </While>
         <Exec func="PUB:CloseCursor"/>
      </FlowCtrl>
   </Transaction>

   <!--批量扣税处理-->
   <!--Modified By sundx_BoCom00067299_20090602 修改交易915803，解决财政零余额账户批量扣税后开户网点为空的问题-->
   <Transaction code="915803" error="GOTO:ErrHandle">
      <Quote name="UpdPrtNodSQL"/><!--更新打印网点-->
      <DynSentence name="QryTxnBok"><!--读取待处理的交易登记簿记录-->
         <Sentence>
            select * from tiptxnbok where OrgCod='%s' and EntDat='%s' and SPckNo='%s' and BilSts in ('0','2')
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="SUM">     <!--统计总笔数总金额-->
         <Sentence>
            select count(*) OrnCnt,SUM(CAST(TxnAmt as bigint)) OrnAmt from tiptxnbok
            where OrgCod='%s' and EntDat='%s' and SPckNo='%s' and BilSts in ('0','2')
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdDskNo"><!--更新批量登记簿-->
         <Sentence>
            update tipbatbok Set DskNo='%s' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>DskNo|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdLogNo"><!--更新前置流水号-->
         <Sentence>
            update tiptxnbok Set LogNo='%s',TCusId='%s' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>LogNo|TCusId|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdRspInf"><!--更新单笔-->
         <Sentence>
            update tiptxnbok Set BilSts='2',HRspCd='%s',AddWord='%s' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>HRspCd|AddWord|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdPayTyp"><!--更新支付方式-->
         <Sentence>
            update tiptxnbok Set PayTyp='%s' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>PayTyp|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdRspInf2"><!--更新整包-->
         <Sentence>
            update tiptxnbok Set BilSts='2',HRspCd='%s',AddWord='%s' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>HRspCd|AddWord|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="QryPChkFg"><!--取协议检查标志-->
         <Sentence>
            select PChkFg from tiptrerkn where RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkAgr">   <!--检查协议-->
         <Sentence>
            select brkno,TCusId,PrtNod from tipcusagr where agrno='%s' and ActNo='%s' and status='0'
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
      </DynSentence>
      <DynSentence name="GetOpBkNo"><!--由地区码取6位分行号 作为出账分行-->
         <Sentence>
            select BrkNo OBrkNo  from tiprgnbrk where rgn='%s'
         </Sentence>
         <Fields>rgn|</Fields>
      </DynSentence>
      <DynSentence name="GetRBrkNo"><!--由接口中12位清算行支付行号取得其6位行号 作为与人行清算的分行-->
         <Sentence>
            select BrkNo RBrkNo,ActSqn,BrkNam from tipbrkinf where PBnkNo='%s' and RknFlg='1'
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdStatus"><!--更新批量状态为重新处理-->
         <Sentence>
            update tipbatbok Set Status='2' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="GetCenNo">  <!--根据卡bin取出卡中心号的开始位置和长度-->
         <Sentence>
            select CrdBin,BgnLoc,CenLen from stpbininf where CrdBin='%s'
         </Sentence>
         <Fields>CrdBin|</Fields>
      </DynSentence>
      <DynSentence name="GetRgnNo">  <!--根据卡中心号取出卡中心地区号-->
         <Sentence>
            select CenNo,RgnNo from stpcenrgn where CenNo='%s'
         </Sentence>
         <Fields>CenNo|</Fields>
      </DynSentence>
      <DynSentence name="GetBrNo">  <!--根据地区号取得发卡分行号-->
         <Sentence>
            select RgnNo,BrNo OBrkNo from stpceninf where RgnNo='%s'
         </Sentence>
         <Fields>RgnNo|</Fields>
      </DynSentence>
      <DynSentence name="GetOpnBr">  <!--查询财政零余额账户表取出开户行号-->
         <Sentence>
            select OpnBr OBrkNo from tipfapact where ActNo='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <DynSentence name="QryCusAgr">
         <Sentence>
            Select ActFlg,ActNam,BrkNo OBrkNo,ActSeq,TCusId
            from tipcusagr
            where AgrNo='%s' and ActNo='%s' and Status='0'
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>CrpCod=0000000000</Set>
         <Set>TTxnCd=915803</Set>
         <Set>RecTyp=1</Set>        <!--批量扣税-->
         <Set>ObjSvr=OFRTTIP1</Set>
         <Set>FTxnCd=915804</Set>   <!--后续交易-->
         <Set>TxnMod=1</Set>        <!-- 需要单笔上送 -->
         <Set>CmtFlg=0</Set>        <!-- 大小通道发送状态 -->
         <Set>CcyCod=CNY</Set>      <!--币种-->
         <Set>TrdTbl=tiptxnjnl</Set><!--流水表名-->
         <Set>UpdFlg=Y</Set>        <!--更新标志-->
         <Set>SumFlg=Y</Set>        <!--汇总标志-->
         <Set>CnlTyp=1</Set>

         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="SUM"/>
         </Exec>
         <Delete>$DskNo</Delete>    <!--当ETF中存在DskNo 申请磁盘编号会出错-->
         <Exec func="PUB:RegisterBatchDiskNo"/>  <!--申请磁盘编号-->
         <Exec  func="PUB:ReadRecord">           <!--取协议检查标志-->
            <Arg name="SqlCmd" value="QryPChkFg"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Return/>
         </If>
         <Exec func="PUB:OpenCursor"> <!--打开游标-->
            <Arg name="SqlCmd" value="QryTxnBok"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Set>AddWord=数据库错误</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>AddWord=数据库错误</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <If condition="$PChkFg=0">   <!--有协议号就检查-->
               <If condition="ISNULL(DELSPACE($AgrNo,all))=0"><!--人行报文中存在协议号-->
                  <Exec  func="PUB:ReadRecord" error="IGNORE">
                     <Arg name="SqlCmd" value="ChkAgr" />
                  </Exec>
                  <If condition="~RetCod=-2">
                     <Set>HRspCd=24009</Set>
                     <Set>AddWord=账户未签约</Set>
                     <Quote name="UpdRspInf"/>
                     <Exec func="PUB:CommitWork"/>
                     <Continue/>
                  </If>
               </If>
               <Else>
                  <Set>PrtNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set><!--税票打印网点设置成关联行账务中心-->
               </Else>
            </If>
            <ElseIf condition="$PChkFg=1">  <!--强制检查-->
               <Exec  func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="ChkAgr" />
               </Exec>
               <If condition="~RetCod=-2">
                  <Set>HRspCd=24009</Set>
                  <Set>AddWord=账户未签约</Set>
                  <Quote name="UpdRspInf"/>
                  <Exec func="PUB:CommitWork"/>
                  <Continue/>
               </If>
            </ElseIf>
            <ElseIf condition="$PChkFg=2">  <!--不检查-->
               <Set>PrtNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set><!--税票打印网点设置成关联行账务中心-->
            </ElseIf>
            <Quote name="UpdPrtNod"/><!--更新打印网点-->
            <!--查询三方协议表-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="QryCusAgr"/>
            </Exec>
            <If condition="~RetCod=0">
               <If condition="$ActFlg=2">
                  <Set>HTxnCd=915910</Set>
                  <Set>TxnObj=SHSTPUB1</Set>
                  <Set>UpdFld=TckNo|ONodNo|</Set>
                  <Set>PayTyp=2</Set><!--卡号-->
                  <Quote name="UpdPayTyp"/>
               </If>
               <ElseIf condition="$ActFlg=3">
                  <Set>TxnObj=SHSTPUB1</Set>
                  <Set>HTxnCd=915910</Set>
                  <Set>UpdFld=TckNo|ONodNo|</Set>
                  <Set>PayTyp=3</Set><!-- 活期存折-->
                  <Quote name="UpdPayTyp"/>
               </ElseIf>
               <ElseIf condition="$ActFlg=4">
                  <Set>TxnObj=SHSTPUB1</Set>
                  <Set>HTxnCd=915910</Set>
                  <Set>UpdFld=TckNo|ONodNo|</Set>
                  <Set>PayTyp=4</Set><!-- 活期一本通-->
                  <Quote name="UpdPayTyp"/>
               </ElseIf>
               <ElseIf condition="$ActFlg=0">
                  <Exec  func="PUB:ReadRecord" error="IGNORE"><!--财政余额帐户类型-->
                     <Arg name="SqlCmd" value="GetOpnBr" />
                  </Exec>
                  <If condition="~RetCod=0">  <!--财政余额帐户-->
                     <Set>TxnObj=OFRTTIP1</Set>
                     <Set>HTxnCd=915812</Set>
                     <!--Modified by sundx_BoCom00067299_20090602-->
                     <Set>UpdFld=TckNo|ONodNo|</Set>
                     <!--Ended by sundx_BoCom00067299_20090602-->
                  </If>
                  <ElseIf condition="~RetCod=-2">
                     <Set>RspCod=000000</Set>
                     <Set>TxnObj=SHSTPUB1</Set>
                     <Set>HTxnCd=915830</Set>
                     <Set>UpdFld=TckNo|ONodNo|</Set>
                  </ElseIf>
               </ElseIf>
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=000000</Set>
               <Set>TCusId= </Set>
               <If condition="INTCMP(STRLEN($ActNo),1,21)">  <!--帐号小于21位-->
                  <Set>CrdBin=SUBSTR($ActNo,1,6)</Set>
                  <Exec func="PUB:ReadRecord">  <!--根据卡bin取出卡中心号的开始位置和长度-->
                     <Arg name="SqlCmd" value="GetCenNo"/>
                  </Exec>
                  <Set>CenNo=SUBSTR($ActNo,$BgnLoc,$CenLen)</Set>
                  <Exec func="PUB:ReadRecord">  <!--根据卡中心号取出卡中心地区号-->
                     <Arg name="SqlCmd" value="GetRgnNo"/>
                  </Exec>
                  <Exec func="PUB:ReadRecord">  <!--根据地区号取得发卡分行号-->
                     <Arg name="SqlCmd" value="GetBrNo"/>
                  </Exec>
                  <Set>PayTyp=2</Set>
                  <Quote name="UpdPayTyp"/>
                  <Set>TxnObj=SHSTPUB1</Set>
                  <Set>HTxnCd=915910</Set>
                  <Set>UpdFld=TckNo|ONodNo|</Set>
               </If>
               <ElseIf condition="INTCMP(STRLEN($ActNo),3,21)">  <!--帐号等于21位-->
                  <If condition="SUBSTR($ActNo,4,1)=9">  <!--如果帐号第4位等于9则为对私帐号-->
                     <Set>PayTyp=3</Set>
                     <Quote name="UpdPayTyp"/>
                     <Set>TxnObj=SHSTPUB1</Set>
                     <Set>HTxnCd=915910</Set>
                     <Set>UpdFld=TckNo|ONodNo|</Set>
                     <Quote name="GetOpBkNo"/>
                  </If>
                  <Else>
                     <Exec func="PUB:ReadRecord" error="IGNORE">  <!--查询是否为财政零余额帐号-->
                        <Arg name="SqlCmd" value="GetOpnBr"/>
                     </Exec>
                     <If condition="~RetCod=0">  <!--帐号为财政零余额帐号-->
                        <Set>TxnObj=OFRTTIP1</Set>
                        <Set>HTxnCd=915812</Set>
                        <!--Modified by sundx_BoCom00067299_20090602-->
                        <Set>UpdFld=TckNo|ONodNo|</Set> 
                        <!--Ended by sundx_BoCom00067299_20090602-->
                     </If>
                     <ElseIf condition="~RetCod=-2">  <!--帐号为对公帐号-->
                        <Set>RspCod=000000</Set>
                        <Set>TxnObj=SHSTPUB1</Set>
                        <Set>HTxnCd=915830</Set>
                        <Set>UpdFld=TckNo|ONodNo|</Set>
                        <Quote name="GetOpBkNo"/>
                     </ElseIf>
                  </Else>
               </ElseIf>
               <ElseIf condition="INTCMP(STRLEN($ActNo),6,21)">  <!--帐号大于21位-->
                  <Set>RspCod=24001</Set>
                  <Set>AddWord=账号不存在</Set>
                  <Quote name="UpdRspInf"/>
                  <Continue/>
               </ElseIf>
            </ElseIf>
            <Set>CnlSub=$OBrkNo</Set>
            <Set>BrNo=$CBrkNo</Set>
            <Set>ActNod=STRCAT(SUBSTR($BrNo,1,3),800)</Set>
            <Set>NodNo=$ActNod</Set>
            <Set>Smr=STRCAT(征收机关,$OrgCod, 税票号,$TaxVID)</Set>
            <Set>BrkNo=$OBrkNo</Set>
            <Exec func="PUB:GetLogNo"/>
            <Exec func="PUB:InsertRecord"><!--新增主机流水-->
               <Arg name="TblNam" value="tiptxnjnl"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdLogNo"/><!--更新账务登记簿中的LogNo-->
            </Exec>
            <Exec func="PUB:CommitWork"/>
         </While>
         <Exec func="PUB:CloseCursor"/>

         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdDskNo"/><!--更新批量包登记簿中的DskNo-->
         </Exec>
         <!--修改本批次为确认状态，启动大小通道发送 -->
         <Exec func="PUB:UpdateBatchStatus" >
            <Arg name="ChkFlg" value="1"/>
         </Exec>
         <Exec func="PUB:DeleteDiskNo"/>
         <Return/>
         <Label>ErrHandle</Label>
         <Exec func="PUB:DeleteDiskNoAndRollback" error="IGNORE"/>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdStatus"/><!--更新批量包登记簿中的状态为重新处理-->
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--Modified By sundx_BoCom00067299_20090602 修改交易915812，解决财政零余额账户批量扣税后开户网点为空的问题-->
   <Transaction code="915812">  <!--财政零余额批量扣税-->
      <DynSentence name="GetOpnBr">  <!--查询财政零余额账户表-->
         <Sentence>
            select ActNo,ActNam,OpnBr,OpnNod,EleBk,PayCod,FinAre,ANodNm,CusCod
            from tipfapact
            where ActNo='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnjnl">
         <Sentence>
            update tiptxnjnl set MstChk='0' where ActNo='%s' and Entdat='%s' and OrgCod='%s' and TraNo='%s'
         </Sentence>
         <Fields>ActNo|Entdat|OrgCod|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnBok2"><!--读取待处理的交易登记簿记录-->
         <Sentence>
            select LogNo OLogNo,RBnkNo,TlrId from tiptxnbok where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryBrkInf">
         <Sentence>
            Select BrkNam BrNam from tipbrkinf where BrkNo='%s'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTreRkn">
         <Sentence>
            Select RBnkNo,RBnkNm,RAccNo,RAccNm from tiptrerkn where RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">
         <Sentence>
            Update tiptxnbok Set BilSts='%s',HTxnSt='%s',TckNo='%s',HRspCd='%s',ONodNo='%s'
            Where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>BilSts|HTxnSt|TckNo|HRspCd|ONodNo|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="GetWorkDt">
         <Sentence>
            Select WorkDt from tipsyssts
         </Sentence>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg  name="SqlCmd" value="GetOpnBr"/>
         </Exec>         
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdTxnjnl"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryTxnBok2"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryBrkInf"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryTreRkn"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetWorkDt"/>
         </Exec>
         <Exec func="PUB:GetLogNo"/>
         <Set>APVchN=$LogNo</Set>
         <Set>CCyCod=CNY</Set>
         <Set>AthAmt=$TxnAmt</Set>
         <Set>VInTlr=$TlrId</Set>
         <Set>VrgNod=$ActNod</Set>
         <Set>HSubCd=002</Set><!-- 001：借零余额户贷26201 002：借零余额户贷22203 国库送002-->
         <Set>UdwDat=$WorkDt</Set>
         <Set>BrNo=$OpnBr</Set>
         <Set>PyeAct=$RAccNo</Set>
         <Set>PyeNam=$RAccNm</Set>
         <Set>PyeBk=$RBnkNm</Set>
         <!--Modified by sundx_BoCom00067299_20090602 取开户网点-->
         <Set>ONodNo=$OpnNod</Set>  
         <!--Modified by sundx_BoCom00067299_20090602 取开户网点-->
         <!-- BoCom00065517 add by zhb 2009-6-19 start -->
         <Set>StlMod=07</Set>
         <!-- BoCom00065517 end-->
         <Exec func="PUB:CallThirdAcc" error="IGNORE">  <!--转发交易到第三方财政-->
            <Arg name="HTxnCd" value="363412"/>
            <Arg name="ObjSvr" value="STHDTIP1"/>
         </Exec>
         <Set>LogNo=$OLogNo</Set>
         <If condition="~RetCod=-1">  <!--交易超时-->
            <Set>MsgTyp=E</Set>
            <Set>RspMsg=交易超时</Set>
            <Set>BilSts=2</Set>
            <Set>RspSts=0</Set>
            <Set>HTxnSt=T</Set>
            <Set>TxnSts=F</Set>
            <Set>TckNo= </Set>
            <Set>HRspCd= </Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
            <Exec func="PUB:UpdateJournal"/>
            <Exec func="PUB:SetNoResponse"/>
         </If>
         <ElseIf condition="~RetCod=0">  <!--记帐成功-->
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
            <Set>BilSts=1</Set>
            <Set>HTxnSt=S</Set>
            <Set>TxnSts=S</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
            <Exec func="PUB:UpdateJournal"/>
         </ElseIf>
         <ElseIf condition="~RetCod=3">  <!--交易失败-->
            <Set>MsgTyp=E</Set>
            <Set>RspMsg=交易失败</Set>
            <Set>RspCod=000000</Set>
            <Set>BilSts=2</Set>
            <Set>HTxnSt=F</Set>
            <Set>TxnSts=F</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
            <Exec func="PUB:UpdateJournal"/>
         </ElseIf>
      </FlowCtrl>
   </Transaction>

   <!--批量扣税 后继处理-->
   <Transaction code="915804" error="PUB:DeleteDiskNo">
      <DynSentence name="UpdateRept">
         <Sentence>
            UPDATE tiptxnjnl Set HTxnSt='S',HRspCd='SC0000'
            WHERE DskNo='%s' AND ActDat='%s' AND HRspCd='SC6128'
         </Sentence>
         <Fields>DskNo|ActDat|</Fields>
      </DynSentence>
      <DynSentence name="QryBatBok">
         <Sentence>
            select OrgCod,EntDat,SPckNo,ExpDat,BatTyp,Status,PrcNum from tipbatbok where DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="QryHRspCd">
         <Sentence>
            select HRspCd RspCod,TraNo from tiptxnbok where OrgCod='%s' and EntDat='%s' and SPckNo='%s' and HRspCd != ' ' for read only
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdBokInf"><!--以LogNo来关联tiptxnjnl表 更新tiptxnbok-->
         <Sentence>
            update tiptxnbok a Set
            (a.TckNo,a.HTxnSt,a.TlrId,a.HRspCd,a.ONodNo) =
            (select TckNo,HTxnSt,TlrId,HRspCd,ONodNo from tiptxnjnl b where a.LogNo=b.LogNo)
            where exists (select c.logno from tiptxnjnl c  where c.LogNo=a.LogNo) and a.OrgCod='%s' and a.EntDat='%s' and a.SPckNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdBilSts1">
         <Sentence>
            update tiptxnbok Set bilsts='1' where OrgCod='%s' and EntDat='%s' and SPckNo='%s' and HTxnSt='S'
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdBilSts2">
         <Sentence>
            update tiptxnbok Set bilsts='2' where OrgCod='%s' and EntDat='%s' and SPckNo='%s' and HTxnSt!='S'
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdBatBok">
         <Sentence>
            update tipbatbok Set status='%s',
            SucNum=cast((cast(SucNum as bigint)+cast('%s' as bigint)) AS CHAR(8)),
            SucAmt=cast((cast(SucAmt as bigint)+cast('%s' as bigint)) AS CHAR(15))
            where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>Status|SucCnt|SucAmt|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdPrcNum">
         <Sentence>
            update tipbatbok Set PrcNum=CAST( (CAST(PrcNum as bigint)+1) as CHAR(1))
            where DskNo='%s'
         </Sentence>
         <Fields>DskNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdAddWord">
         <Sentence>
            Update tiptxnbok Set AddWord='%s'
            where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>AddWord|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:IsRepeatBatch" error="IGNORE"/>
         <If condition="~RetCod=-1">
            <Set>MsgDat=STRCAT(批次号:,$DskNo,已处理完)</Set>
         </If>
         <Else>
            <Return/>
         </Else>
         <Exec func="PUB:ExecSql" error="IGNORE"><!--对返回码为SC6128的记录置HTxnSt为S-->
            <Arg name="SqlCmd"   value="UpdateRept"/>
         </Exec>
         <Exec func="PUB:ExecSql"><!--累加处理次数-->
            <Arg name="SqlCmd" value="UpdPrcNum"/>
         </Exec>
         <Exec func="PUB:CommitWork"/>
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryBatBok"/>
         </Exec>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdBokInf"/>
         </Exec>
         <If condition="~RetCod=-1"><!--系统故障-->
            <Return/>
         </If>
         <Exec func="PUB:CommitWork"/>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdBilSts1"/>
         </Exec>
         <If condition="~RetCod=-1"><!--系统故障-->
            <Return/>
         </If>
         <Exec func="PUB:CommitWork"/>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdBilSts2"/>
         </Exec>
         <If condition="~RetCod=-1"><!--系统故障-->
            <Return/>
         </If>
         <Exec func="PUB:CommitWork"/>

         <!--更新附言-->
         <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="SqlCmd" value="QryHRspCd"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Set>AddWord=数据库错误</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>AddWord=数据库错误</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Exec func="PUB:CodeSwitching">
               <Arg name="DatSrc" value="TIPCSW"></Arg>
               <Arg name="SourNam" value="RspCod"></Arg>
               <Arg name="DestNam" value="Result"></Arg>
               <Arg name="TblNam" value="Cod2Res"></Arg>
            </Exec>
            <Exec func="PUB:CodeSwitching">
               <Arg name="DatSrc" value="TIPCSW"></Arg>
               <Arg name="SourNam" value="Result"></Arg>
               <Arg name="DestNam" value="AddWord"></Arg>
               <Arg name="TblNam" value="Res2Wrd"></Arg>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdAddWord"/>
            </Exec>
         </While>
         <Exec func="PUB:CloseCursor" error="IGNORE"/>
         <Exec func="PUB:CommitWork"/>

         <Exec func="PUB:CancelBatchRedo"/><!--避免因下面的CallLocal超时 而重发本交易-->

         <!--该批次扣税全部成功,使用pubbatinf中的数据判断-->
         <If condition="OR(INTCMP($OrnCnt,3,$SucCnt),INTCMP($PrcNum,3,2))">    <!--全部成功 或者 本次处理为第二次处理-->
            <Set>status=3</Set>                       <!--处理结束-->
            <Exec func="PUB:ExecSql">                 <!--更新批量包状态和成功总笔数总金额-->
               <Arg name="SqlCmd" value="UpdBatBok"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>
            <Delete>$LogNo</Delete>

            <Exec func="PUB:CallLocal">
               <Arg name="TxnCod"  value="915805"/>
               <Arg name="ObjSvr"  value="OFRTTIP4"/>
            </Exec>
         </If>
         <Else>
            <Set>status=2</Set>                        <!--等待重新处理-->
            <Exec func="PUB:ExecSql">                  <!--更新批量包状态和成功总笔数总金额-->
               <Arg name="SqlCmd" value="UpdBatBok"/>
            </Exec>
         </Else>

         <Exec func="PUB:UpdateBatchStatus">
            <Arg name="Status" value="N"/>
         </Exec>
         <Exec func="PUB:DeleteDiskNo"/>
         <Set>RspCod=000000</Set>
         <Return/>

         <!--以下为带回执包截止日的处理流程-->
         <If condition="$ActDat=$ExpDat"><!--本日为回执发送截止日-->
            <Set>status=3</Set><!--处理结束-->
            <Exec func="PUB:ExecSql"><!--更新批量包状态和成功总笔数总金额-->
               <Arg name="SqlCmd" value="UpdBatBok"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>
            <Delete>$LogNo</Delete>
            <Exec func="PUB:CallLocal">
               <Arg name="TxnCod"  value="915805"/>
               <Arg name="ObjSvr"  value="OFRTTIP4"/>
            </Exec>
         </If>
         <Else>                          <!--未到回执截止日-->
            <If condition="INTCMP($OrnCnt,3,$SucCnt)"><!--该批次扣税全部成功,使用pubbatinf中的数据判断-->
               <Set>status=3</Set><!--处理结束-->
               <Exec func="PUB:ExecSql"><!--更新批量包状态和成功总笔数总金额-->
                  <Arg name="SqlCmd" value="UpdBatBok"/>
               </Exec>
               <Exec func="PUB:CommitWork"/>
               <Delete>$LogNo</Delete>
               <Exec func="PUB:CallLocal">
                  <Arg name="TxnCod"  value="915805"/>
                  <Arg name="ObjSvr"  value="OFRTTIP4"/>
               </Exec>
            </If>
            <ElseIf condition="$BatTyp=1"><!--循环扣款-->
               <Set>Status=2</Set><!--等待重新处理-->
               <Exec func="PUB:ExecSql"><!--更新批量包状态和成功总笔数总金额-->
                  <Arg name="SqlCmd" value="UpdBatBok"/>
               </Exec>
            </ElseIf>
            <Else>                      <!--非循环扣款 直接发送回执-->
               <Set>Status=3</Set><!--处理结束-->
               <Exec func="PUB:ExecSql"><!--更新批量包状态和成功总笔数总金额-->
                  <Arg name="SqlCmd" value="UpdBatBok"/>
               </Exec>
               <Exec func="PUB:CommitWork"/>
               <Delete>$LogNo</Delete>
               <Exec func="PUB:CallLocal"><!--发送批扣回执-->
                  <Arg name="TxnCod"  value="915805"/>
                  <Arg name="ObjSvr"  value="OFRTTIP4"/>
               </Exec>
            </Else>
         </Else>
         <Exec func="PUB:UpdateBatchStatus">
            <Arg name="Status" value="N"/>
         </Exec>
         <Exec func="PUB:DeleteDiskNo"/>
         <Set>RspCod=000000</Set>
      </FlowCtrl>
   </Transaction>

   <!--批量扣税回执发送2102-->
   <Transaction code="915805">
      <DynSentence name="QryBatBok">
         <Sentence>
            select PBnkNo,EntDat,SPckNo,RPckNo,ROrgCd,AllNum,AllAmt,SucNum,SucAmt from tipbatbok
            where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnBok">
         <Sentence>
            select TraNo,TxnAmt,TaxVID,ActDat,BilSts,HRspCd RspCod from tiptxnbok
            where OrgCod='%s' and EntDat='%s' and SPckNo='%s' order by TraNo
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdBatBok"><!--更新状态和回执发送日期-->
         <Sentence>
            update tipbatbok Set Status='%s',RspDat='%s' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>Status|WorkDt|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok"><!--更新回执发送日期-->
         <Sentence>
            update tiptxnbok Set RspDat='%s',RspSts='1' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>WorkDt|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok1"><!--更新回执发送日期-->
         <Sentence>
            update tiptxnbok Set RspDat='%s' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>WorkDt|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>

      <DynSentence name="ChkStsSQL">
         <Sentence>
            select WorkDt from tipsyssts
         </Sentence>
      </DynSentence>
      <Attributes>
         <Attribute name="integrity" value="7" code="915805" interval="5" timeout="30" maxtimes="15"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec  func="PUB:IsExistNode">
            <Arg name="FieldName" value="LogNo"/>
         </Exec>
         <If condition="~RetCod=1">
            <Set>RdoFlg=1</Set>
            <Exec func="PUB:LoadFromTDS">
               <Arg name="TxnCod" value="915805"/>
               <Arg name="RecKey" value="$LogNo"/>
            </Exec>
         </If>
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStsSQL"/>
         </Exec>
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryBatBok"/>
         </Exec>
         <Exec  func="PUB:QueryInGroup">
            <Arg name="SqlCmd" value="QryTxnBok"/>
            <Arg name="RecordName" value="BatchReturn2102"/>
         </Exec>


         <Set>RspCod=90000</Set>
         <Quote name="GetSeq"/><!--取新的MsgId-->
         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdTxnBok1"/> <!--更新回执发送日期-->
         </Exec>
         <!--如果回执发送失败 则循环重发回执-->
         <Exec func="PUB:BeginWork"/><!--发送回执失败时 须登记重发-->
         <Exec func="PUB:CallThirdOther" error="IGNORE"><!--2102批量扣税回执-->
            <Arg name="HTxnCd" value="2102"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
         <If condition="~RetCod=0">
            <Set>status=4</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdBatBok"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
         </If>
         <Else>
            <If condition="$RdoFlg!=1">
               <Exec func="PUB:GetLogNo"/>
               <Exec func="PUB:SaveToTDS"><!--保存数据到临时缓冲表-->
                  <Arg name="RecKey" value="$LogNo"/>
                  <Arg name="FldLst" value="OrgCod|EntDat|SPckNo|"/>
               </Exec>
               <Exec func="PUB:CommitWork"/>
               <Exec func="PUB:DefaultErrorProc"/>
            </If>
         </Else>
      </FlowCtrl>
   </Transaction>

   <!--处理  "人行对批扣回执的响应报文" 批量扣税回执确认-->
   <Transaction code="91xxxx">
      <DynSentence name="UpdBatBok"><!--5:回执已确认;6:被止付;7:回执被拒绝-->
         <Sentence>
            update tipbatbok Set Status='%s' where PBnkNo='%s' and EntDat='%s' and RPckNo='%s'
         </Sentence>
         <Fields>Status|OrgCod|EntDat|RPckNo|</Fields>
      </DynSentence>
      <DynSentence name="GetCrBkNo"><!--取关联分行-->
         <Sentence>
            Select BrkNo  from tipbrkinf  where PBnkNo='%s' and RLtFlg='1'
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>RPckNo=$ReqNo</Set><!--回执包包号-->
         <If condition="OR(IS_EQUAL_STRING($Result,90000),IS_EQUAL_STRING($Result,94052))">
            <Set>Status=5</Set>
         </If>
         <Else>
            <Exec  func="PUB:ReadRecord"><!--取关联分行-->
               <Arg name="SqlCmd" value="GetCrBkNo"/>
            </Exec>
            <Set>Status=7</Set>
            <Set>RecLvl=1</Set>
            <Set>Content=STRCAT(批量扣税回执包确认失败 ,付款行号,$OrgCod, 委托日期,$EntDat, 回执包号,$RPckNo)</Set>
            <Quote name="BusNty"/>
         </Else>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdBatBok"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--通用处理结果通知 批扣最后的步骤  当人行检查回执明细错误时 -->
   <Transaction code="919122">
      <DynSentence name="UpdBatBok"><!--5:回执已确认;6:被止付;7:回执被拒绝 8:回执已接受  9:回执接受失败-->
         <Sentence>
            update tipbatbok Set Status='%s' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>Status|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok"><!--更新回执日期-->
         <Sentence>
            update tiptxnbok Set RspDat='%s' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>WrkDat|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="GetSpckNo"><!--取请求包包号-->
         <Sentence>
            select OrgCod,EntDat,SPckNo from tipbatbok where PBnkNo='%s' and EntDat='%s' and RPckNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|RPckNo|</Fields>
      </DynSentence>
      <DynSentence name="GetCrBkNo"><!--取关联分行-->
         <Sentence>
            Select BrkNo  from tipbrkinf  where PBnkNo='%s' and RLtFlg='1'
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="$OMsgNo=2102">    <!--原交易为批扣回执-->
            <Set>RPckNo=$ReqNo</Set>      <!--回执包包号-->
            <Exec  func="PUB:ReadRecord"> <!--取请求包包号-->
               <Arg name="SqlCmd" value="GetSpckNo"/>
            </Exec>
            <If condition="OR(IS_EQUAL_STRING($Result,90000),IS_EQUAL_STRING($Result,94052))"><!--成功-->
               <Set>status=8</Set>
            </If>
            <Else>                        <!--失败-->
               <Set>status=9</Set>
               <Exec  func="PUB:ReadRecord"><!--取关联分行-->
                  <Arg name="SqlCmd" value="GetCrBkNo"/>
               </Exec>
               <!--登记业务提示记录-->
               <Set>RecLvl=1</Set>
               <Set>Content=STRCAT(批量扣税回执包确认失败 ,付款行号,$OrgCod, 委托日期,$EntDat, 回执包号,$RPckNo)</Set>
               <Quote name="BusNty"/>
            </Else>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="UpdBatBok"/>
            </Exec>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
         </If>
      </FlowCtrl>
   </Transaction>

   <!--止付-->
   <Transaction code="915807">
      <DynSentence name="QryTxnBok">
         <Sentence>
            select BilSts,CBrkNo from tiptxnbok where OrgCod='%s' and EntDat='%s' and TraNo='%s' and SPckNo='%s' for read only
         </Sentence>
         <Fields>OrgCod|OEntDat|OTraNo|OPackNo|</Fields>
      </DynSentence>
      <DynSentence name="QryBatBok">
         <Sentence>
            select Status,SucNum,CBrkNo from tipbatbok where OrgCod='%s' and EntDat='%s' and SPckNo='%s' for read only
         </Sentence>
         <Fields>OrgCod|OEntDat|OPackNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdBatBok"><!--更新批量包登记簿的状态为已止付-->
         <Sentence>
            update tipbatbok Set Status='6' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>OrgCod|OEntDat|OPackNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok"><!--单笔止付时 更新账务登记簿-->
         <Sentence>
            update tiptxnbok Set BilSts='4',HRspCd='24020' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok2"><!--整包止付时 更新账务登记簿-->
         <Sentence>
            update tiptxnbok Set BilSts='4',HRspCd='24020' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>OrgCod|OEntDat|OPackNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdStpBok"><!--更新止付登记簿的止付状态-->
         <Sentence>
            update tipstpbok Set StpAsw='%s',AddWord='%s',CBrkNo='%s' where OrgCod='%s' and EntDat='%s' and StopNo='%s'
         </Sentence>
         <Fields>StpAsw|AddWord|CBrkNo|OrgCod|EntDat|StopNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkStsSQL">
         <Sentence>
            select WorkDt from tipsyssts
         </Sentence>
      </DynSentence>
      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec  func="PUB:ReadRecord"><!--取人行工作日期-->
            <Arg name="SqlCmd" value="ChkStsSQL"/>
         </Exec>
         <Set>OMsgNo=$MsgNo</Set><!--原报文编号-->
         <Set>ReqNo=$StopNo</Set><!--原指令序号-->
         <Set>ReqDat=$ActDat</Set>
         <Set>OOrgCod=$OrgCod</Set>
         <Set>AddWord= </Set>
         <Set>CBrkNo=XXXXXX</Set><!--预置XXXXXX-->

         <Exec func="PUB:InsertRecord"><!--登记止付登记簿-->
            <Arg name="TblNam" value="tipstpbok"/>
         </Exec>
         <Set>Result=90000</Set><!--处理结果-->
         <Quote name="GetSeq"/>
         <Exec func="PUB:CallThirdOther"><!--9121通用确认应答-->
            <Arg name="HTxnCd" value="9121X"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
         <If condition="$StopTyp=0"><!--单笔-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="QryTxnBok" />
            </Exec>
            <If condition="~RetCod=-2">
               <Set>StpAsw=3</Set>
               <Set>AddWord=原交易不存在</Set>
            </If>
            <ElseIf condition="$BilSts=1">
               <Set>StpAsw=2</Set>
               <Set>AddWord=原交易已扣款</Set>
            </ElseIf>
            <Else>
               <Set>StpAsw=1</Set>    <!--止付成功-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
            </Else>
         </If>
         <Else><!--整包-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="QryBatBok" />
            </Exec>
            <If condition="~RetCod=-2"><!--未找到原包-->
               <Set>StpAsw=3</Set><!--1止付成功  2止付失败，已扣款    3止付失败，包或交易在途或不存在-->
               <Set>AddWord=原包不存在</Set>
            </If>
            <ElseIf condition="OR(IS_EQUAL_STRING($Status,0),IS_EQUAL_STRING($Status,6))"><!--未处理或被止付-->
               <Set>StpAsw=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdBatBok"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok2"/>
               </Exec>
            </ElseIf>
            <ElseIf condition="$Status=2"><!--等待重新处理-->
               <If condition="INTCMP($SucNum,3,0)=1"><!--无成功记录-->
                  <Set>StpAsw=1</Set><!--止付成功-->
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdBatBok"/>
                  </Exec>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok2"/>
                  </Exec>
               </If>
               <Else>
                  <Set>StpAsw=2</Set>
                  <Set>AddWord=原包已扣款</Set>
               </Else>
            </ElseIf>
            <Else>
               <Set>StpAsw=2</Set>
               <Set>AddWord=原包已扣款</Set>
            </Else>
         </Else>
         <Exec func="PUB:ExecSql">    <!--更新止付登记簿-->
            <Arg name="SqlCmd" value="UpdStpBok"/>
         </Exec>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:CallThirdOther"><!--9121止付应答-->
            <Arg name="HTxnCd" value="2123"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--税票明细对账通知-->
   <!--Modified by xhb_BoCom00031672_20080125_修改SQL语句GetCrBkNo添加TRptTyp(报文种类)和TBusTyp(业务种类)-->
   <!--Modified by sundx_BoCom00052077_20081201_修改为日终对账不自动清算-->
   <!--Modified by sundx_BoCom00057421_20090211_修改为特殊日期当日自动清算-->
   <Transaction code="915850">
      <Quote name="CheckSQL"/>              <!--对账SQL-->
      <Quote name="CheckResultSQL"/>        <!--检查对账结果SQL-->
      <Quote name="2111SQL"/>               <!--发对账回执SQL-->
      <Quote name="ChkRknUpdSQL"/>          <!--对账清算公共更新SQL-->
      <DynSentence name="SUM">              <!--统计一个对账批次的总金额-->
         <Sentence>
            SELECT CAST(SUM(CAST(TxnAmt as bigint)) as CHAR(15)) TolAmt FROM tipchkrec
            WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s' FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="ChkSuc">           <!--检查本账批次是否已对账成功-->
         <Sentence>
            SELECT ChkSts,RPckNm,CPckNm FROM tipchkbok WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s' FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="DelChkBok">        <!--删除对账登记簿记录-->
         <Sentence>
            DELETE FROM tipchkbok WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="DelChkRec">        <!--删除对账记录表记录-->
         <Sentence>
            DELETE FROM tipchkrec WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="ChkOriChkOrd">     <!--检查上一对账批次是否存在-->
         <Sentence>
            SELECT 'Y' YN  FROM TABLE(VALUES(1)) AS anony
            WHERE EXISTS
            ( SELECT 'Y' FROM tipchkbok WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s')
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|OCkOrd|</Fields>
      </DynSentence>
      <DynSentence name="QryBrkInf">        <!--根据清算行支付系统行号查询清算参数-->
         <Sentence>
            SELECT BrkNo,SndAct,ActSqn,SndAct,SndNam,DBrkNo FROM tipbrkinf WHERE PBnkNo='%s' AND RknFlg='1' FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      <!--由清算国库的支付行号取得 收款账号 收款户名  清算类型 批扣类型 协议检查标志 电子回单标志 关联行号(入账分行) -->
      <!--DynSentence name="GetCrBkNo">
      <Sentence>
      SELECT RAccNo RcvNo,RAccNm RcvNam,RknTyp,BatTyp,PChkFg,BCrtFg,BrkNo CBrkNo FROM tiptrerkn WHERE RBnkNo='%s'
      </Sentence>
      <Fields>RBnkNo|</Fields>
      </DynSentence-->
      <!--由清算国库的支付行号取得 收款账号 收款户名  清算类型 批扣类型 协议检查标志 电子回单标志 关联行号(入账分行) 报文种类 业务种类-->
      <DynSentence name="GetCrBkNo">
         <Sentence>
            SELECT RAccNo RcvNo,RAccNm RcvNam,RknTyp,BatTyp,PChkFg,BCrtFg,BrkNo CBrkNo,TRptTyp,TBusTyp FROM tiptrerkn WHERE RBnkNo='%s' FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdDayChk">        <!--更新日间对账 我行多的纪录为未对账-->
         <Sentence>
            UPDATE tiptxnbok SET ChkSts='0' WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s' AND ChkSts='2'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="UpdRPckNm">        <!--更新对账登记簿收到子包总数-->
         <Sentence>
            UPDATE tipchkbok SET RPckNm='%s' WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
         </Sentence>
         <Fields>RPckNm|RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="QryPckSqn">        <!--判断子包是否重复-->
         <Sentence>
            SELECT 'Y' YN FROM TABLE(VALUES(1)) AS anony
            WHERE EXISTS
            (SELECT 'Y' FROM tipchkrec WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s' AND PckSqn='%s')
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|PckSqn|</Fields>
      </DynSentence>
      <DynSentence name="DelChkRc2">        <!--删除对账记录表记录-->
         <Sentence>
            DELETE FROM tipchkrec WHERE RBnkNo='%s' AND PBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s' AND PckSqn='%s'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|PckSqn|</Fields>
      </DynSentence>
      <!--Added by sundx at 20090211 获取清算标志，确定当日日终对账是否需要自动清算-->
      <DynSentence name="SelRknFlg">        <!--获取清算标志-->
         <Sentence>
            SELECT RknFlag FROM tipsyssts
         </Sentence>
         <Fields></Fields>
      </DynSentence>
      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>CrpCod=0000000000</Set>
         <Set>PckTyp=0</Set>                                    <!--对账包-->
         <Set>Smr=STRCAT(税款入库 对账日期,$ChkDat, 对账批次,$ChkOrd, 对账笔数,$AllNum)</Set>
         <If condition="$ChkMod=0">
            <Set>ModNam=日间对账</Set>
         </If>
         <Else>
            <Set>ModNam=日切对账</Set>
         </Else>
         <Exec func="PUB:ReadRecord" error="IGNORE">            <!--根据清算银行行号取清算参数-->
            <Arg name="SqlCmd" value="QryBrkInf" />
         </Exec>
         <If condition="~RetCod!=0">
            <If condition="~RetCod=-2">
               <Set>RspCod=94999</Set>
               <!--Set>AddWord=取清算参数失败</Set-->
               <Set>AddWord=交易处理失败</Set>
               <Quote name="2111"/>                             <!--发对账回执-->
               <Return/>
            </If>
            <Else>                                              <!--其他返回不成功的情况-->
               <Return/>
            </Else>
         </If>
         <Set>RBrkNo=$BrkNo</Set>                               <!--6位清算行号-->
         <Set>RNodNo=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>       <!--6位清算行机构号-->
         <Exec func="PUB:ReadRecord">                           <!--取关联行号 -->
            <Arg name="SqlCmd" value="GetCrBkNo" />
         </Exec>
         <If condition="$OCkOrd!=$ChkOrd">
            <Exec func="PUB:ReadRecord" error="IGNORE">         <!--检查上一对账批次是否存在 -->
               <Arg name="SqlCmd" value="ChkOriChkOrd" />
            </Exec>
            <If condition="~RetCod=-2">
               <Set>SelOrd=$ChkOrd</Set>
               <Set>ChkOrd=$OCkOrd</Set>
               <Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <Set>EntDat=$ChkDat</Set>
               <Exec func="PUB:CallThirdOther">              <!--对账重发申请 上一对账批次-->
                  <Arg name="HTxnCd" value="9112"/>
                  <Arg name="ObjSvr" value="SMQMTIP2"/>
               </Exec>
               <Exec func="PUB:Sleep">
                  <Arg name="SleepTime" value="5"/>
               </Exec>
               <Set>ChkOrd=$SelOrd</Set>
               <Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <Exec func="PUB:CallThirdOther">              <!--对账重发申请 本对账批次-->
                  <Arg name="HTxnCd" value="9112"/>
                  <Arg name="ObjSvr" value="SMQMTIP2"/>
               </Exec>
               <Return/>
            </If>
         </If>
         <!--对账包导入数据库-->
         <If condition="$CPckNm=1">                             <!--未分包-->
            <Exec func="PUB:ReadRecord" error="IGNORE">         <!--检查本对账批次是否存在 -->
               <Arg name="SqlCmd" value="ChkSuc" />
            </Exec>
            <If condition="~RetCod=0">
               <If condition="$ChkSts=1">                       <!--本对帐批次已存在且对帐成功-->
                  <Set>RspCod=90000</Set>
                  <Quote name="2111"/>                          <!--发对账回执-->
                  <Return/>
               </If>
               <Else>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="DelChkBok"/>
                  </Exec>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="DelChkRec"/>
                  </Exec>
               </Else>
            </If>
            <!--核对总金额-->
            <Set>RPckNm=$CPckNm</Set>                           <!--收到包总数等于子包总数-->
            <Exec func="PUB:InsertRecord" >
               <Arg name="TblNam" value="tipchkbok"/>
            </Exec>
            <Exec func="PUB:InsertRecord">
               <Arg name="TblNam" value="tipchkrec"/>
               <Arg name="GrpNam" value="BankCompare3111"/>
               <Arg name="FldLst" value="RBnkNo|PBnkNo|ChkDat|ChkOrd|ChkMod|FTxnTm|PckSqn"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>
            <!--Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="SUM"/>
            </Exec>
            <If condition="$TolAmt!=$AllAmt">
            <Set>RspCod=93007</Set>
            <Set>RspMsg=总金额与包明细不符</Set>
            <登记业务提示表>
            <Goto>Response</Goto>
            </If-->
         </If>
         <Else>                                                 <!--分包-->
            <While>                                             <!--控制同一批次不同分包为串行处理-->
               <Exec func="PUB:Lock" error="IGNORE">
                  <Arg name="RecKey" value="STRCAT(TIP,$PBnkNo,$RBnkNo,$ChkDat,$ChkOrd)"/>
                  <Arg name="TimOut" value="10"/>
               </Exec>
               <If condition="~RetCod=0">
                  <Break/>
               </If>
               <ElseIf condition="~RetCod=-2">
                  <Set>Tim=MUL(5,$PckSqn)</Set>
                  <Exec func="PUB:Sleep">
                     <Arg name="SleepTime" value="$Tim"/>
                  </Exec>
               </ElseIf>
               <Else>
                  <Continue/>
               </Else>
            </While>
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="ChkSuc"/>
            </Exec>
            <If condition="~RetCod=0">
               <If condition="$ChkSts=1">                       <!--本对帐批次已存在且对帐成功-->
                  <Set>RspCod=90000</Set>
                  <Quote name="2111"/>                          <!--发对账回执-->
                  <Return/>
               </If>
               <If condition="IS_EQUAL_STRING($CPckNm,$RPckNm)">
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="DelChkBok"/>
                  </Exec>
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="DelChkRec"/>
                  </Exec>
                  <Set>RPckNm=1</Set>
                  <Exec func="PUB:InsertRecord">
                     <Arg name="TblNam" value="tipchkbok"/>
                  </Exec>
               </If>
               <Else>
                  <Exec func="PUB:ReadRecord" error="IGNORE">
                     <Arg name="SqlCmd" value="QryPckSqn"/>
                  </Exec>
                  <If condition="~RetCod=0">
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd" value="DelChkRc2"/>
                     </Exec>
                  </If>
                  <Else>
                     <Set>RPckNm=ADD($RPckNm,1)</Set>
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd" value="UpdRPckNm"/>
                     </Exec>
                  </Else>
               </Else>
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RPckNm=1</Set>
               <Exec func="PUB:InsertRecord">
                  <Arg name="TblNam" value="tipchkbok"/>
               </Exec>
            </ElseIf>
            <Else>                                              <!--其他返回不成功的情况-->
               <Return/>
            </Else>
            <Exec func="PUB:InsertRecord">                      <!--对账明细-->
               <Arg name="TblNam" value="tipchkrec"/>
               <Arg name="GrpNam" value="BankCompare3111"/>
               <Arg name="FldLst" value="RBnkNo|PBnkNo|ChkDat|ChkOrd|ChkMod|FTxnTm|PckSqn"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>
            <Exec func="PUB:Unlock">
               <Arg name="RecKey" value="STRCAT(TIP,$PBnkNo,$RBnkNo,$ChkDat,$ChkOrd)"/>
               <Arg name="TimOut" value="10"/>
            </Exec>
            <If condition="IS_EQUAL_STRING($RPckNm,$CPckNm)">   <!--最后一包-->
               <Exec func="PUB:ReadRecord">                     <!--统计对账明细的总金额-->
                  <Arg name="SqlCmd" value="SUM"/>
               </Exec>
               <If condition="$TolAmt!=$AllAmt">
                  <Set>RspCod=93007</Set>
                  <Set>AddWord=包总分不符</Set>
                  <Quote name="2111"/>                          <!--发对账回执-->
                  <Return/>
               </If>
            </If>
            <Else>                                              <!--不是最后一包，入库后直接结束交易-->
               <Return/>
            </Else>
         </Else>
         <Quote name="Check"/>                                  <!--对账-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkRslSql1" />
         </Exec>
         <If condition="~RetCod=0">
            <Set>RspCod=24030</Set>
            <!--Set>AddWord=存在人行多或者关键信息不符记录</Set-->
            <Set>AddWord=对账不符</Set>

            <Set>ChkSts=2</Set>
            <Set>RknSts=0</Set>
            <Exec func="PUB:ExecSql" >
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>

            <Set>Content1= </Set>
            <Set>Content2= </Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">         <!--人行多的记录-->
               <Arg name="SqlCmd" value="ChkRslSql3" />
            </Exec>
            <If condition="~RetCod=0">
               <Set>Content1=人行多账 </Set>
            </If>
            <Exec func="PUB:ReadRecord" error="IGNORE">         <!--关键信息不符的记录-->
               <Arg name="SqlCmd" value="ChkRslSql4" />
            </Exec>
            <If condition="~RetCod=0">
               <Set>Content2=关键信息不符</Set>
            </If>
            <Set>RecLvl=2</Set>
            <Set>Content=STRCAT($Content1,$Content2,收款行:,$RBnkNo, 付款行:,$PBnkNo, 对账日期:,$ChkDat, 对账批次:,$ChkOrd, 对账类型:,$ModNam)</Set>
            <Quote name="BusNty"/>                              <!--登记业务提示表-->
            <Quote name="2111"/>                                <!--发对账回执-->
            <Return/>
         </If>
         <If condition="$ChkMod=0">                             <!--日间对账-->
            <Exec func="PUB:ExecSql" error="IGNORE">            <!--更新日间对账 我行多的纪录为未对账-->
               <Arg name="SqlCmd" value="UpdDayChk"/>
            </Exec>
            <Set>RspCod=90000</Set>
            <Set>ChkSts=1</Set>
            <Set>RknSts=0</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Quote name="2111"/>                                <!--发对账回执-->
            <Quote name="Reckon"/>                              <!--按照人行记录清算调用资金汇划交易-->
            <Return/>
         </If>
         <ElseIf condition="$ChkMod=1">                         <!--日切对账-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="ChkRslSql2" />
            </Exec>
            <If condition="~RetCod=0">                          <!--我行多账-->
               <Exec func="PUB:CallLocal" error="IGNORE">       <!--差错自动处理 实时批量扣税多账则自动抹账-->
                  <Arg name="TxnCod" value="915851" />
                  <Arg name="GetFlg" value="1" />
                  <Arg name="ObjSvr" value="OFRTTIP1"/>
               </Exec>
               <Set>TIATyp=T</Set>
               <Exec func="PUB:ReadRecord" error="IGNORE">      <!--检查是否我行多账-->
                  <Arg name="SqlCmd" value="ChkRslSql2" />
               </Exec>
               <If condition="~RetCod=0">                       <!--我行多账-->
                  <Set>RspCod=24030</Set>
                  <!--Set>AddWord=我行多账</Set-->
                  <Set>AddWord=对账不符</Set>
                  <Set>ChkSts=2</Set>
                  <Set>RknSts=0</Set>
                  <Exec func="PUB:ExecSql">                     <!--更新对账登记簿-->
                     <Arg name="SqlCmd" value="UpdChkBok"/>
                  </Exec>
                  <Quote name="2111"/>                          <!--发对账回执-->
               </If>
               <ElseIf condition="~RetCod = -2">                <!--对账相符-->
                  <Set>ChkSts=1</Set>
                  <Set>RknSts=0</Set>
                  <Exec func="PUB:ExecSql">                     <!--更新对账登记簿-->
                     <Arg name="SqlCmd" value="UpdChkBok"/>
                  </Exec>
                  <Set>RspCod=90000</Set>
                  <Quote name="2111"/>                          <!--发对账回执-->
                  <!--Modified by sundx_BoCom00052077_20081201_修改为日终对账不自动清算-->
                  <!--Modified by sundx_BoCom00057421_20090211_修改为特殊日期自动清算-->
                  <Exec func="PUB:ReadRecord">
                     <Arg name="SqlCmd" value="SelRknFlg" />
                  </Exec>
                  <If condition="IS_EQUAL_STRING($RknFlag,1)">
                     <Quote name="Reckon"/>                        <!--资金清算-->
                  </If>
                  <!--Ended by sundx_BoCom00052077_20081201_修改为日终对账不自动清算-->
               </ElseIf>
               <Else>                                           <!--系统故障-->
                  <Return/>
               </Else>
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>ChkSts=1</Set>
               <Set>RknSts=0</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdChkBok"/>
               </Exec>
               <Set>RspCod=90000</Set>
               <Quote name="2111"/>                             <!--发对账回执-->
               <!--Modified by sundx_BoCom00052077_20081201_修改为日终对账不自动清算-->
               <!--Modified by sundx_BoCom00057421_20090211_修改为特殊日期自动清算-->
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="SelRknFlg" />
               </Exec>
               <If condition="IS_EQUAL_STRING($RknFlag,1)">
                  <Quote name="Reckon"/>                        <!--资金清算-->
               </If>
               <!--Ended by sundx_BoCom00052077_20081201_修改为日终对账不自动清算-->
            </ElseIf>
            <Else>                                              <!--系统故障-->
               <Return/>
            </Else>
         </ElseIf>
         <Else>                                                 <!--不存在的对帐模式-->
            <Return/>
         </Else>
      </FlowCtrl>
   </Transaction>

   <!--对账回执确认-->
   <Transaction code="915809">
      <DynSentence name="QryChkInf"><!--根据报文参考号取对账信息-->
         <Sentence>
            select  *  from tipchkbok where MsgRef='%s'
         </Sentence>
         <Fields>MsgRef|</Fields>
      </DynSentence>
      <Quote name="2111SQL"/><!--发对账回执SQL-->
      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="$Result!=90000"><!--对账回执确认失败-->
            <If condition="$RspNum!=@BCFG.RspNum">
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="QryChkInf"/>
               </Exec>
               <If condition="$ChkSts=1"><!--对账成功-->
                  <Set>RspCod=90000</Set>
               </If>
               <Else>                    <!--对账失败-->
                  <Set>RspCod=94057</Set>
                  <Set>AddWord=核对不符</Set>
               </Else>
               <Quote name="2111"/><!--发对账回执-->
            </If>
            <Else>
               <!--登记-->
            </Else>
         </If>
      </FlowCtrl>
   </Transaction>



   <!--人工重新发起对账-->
   <Transaction code="915852">
      <Quote name="CheckSQL"/>          <!--对账SQL-->
      <Quote name="CheckResultSQL"/>    <!--检查对账结果SQL-->
      <Quote name="ChkRknUpdSQL"/>      <!--对账清算公共更新SQL-->
      <Quote name="2111SQL"/>           <!--发对账回执SQL-->
      <DynSentence name="UpdChkSts1">   <!--更新为未对账-->
         <Sentence>
            update tiptxnbok Set ChkSts='0' where RBnkNo='%s' and PBnkNo='%s' and ChkDat='%s' and ChkOrd='%s'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="UpdChkSts2">   <!--更新为未对账-->
         <Sentence>
            update tipchkrec Set ChkSts='0' where RBnkNo='%s' and PBnkNo='%s' and ChkDat='%s' and ChkOrd='%s'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="GetChkMod">    <!--取原对账类型 对账状态-->
         <Sentence>
            select ChkMod,ChkSts from tipchkbok where RBnkNo='%s' and PBnkNo='%s' and ChkDat='%s' and ChkOrd='%s'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="SUBSTR($NodNo,4,3)!=800">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心柜员</Set>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetChkMod" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原对账信息不存在</Set>
            <Return/>
         </If>
         <If condition="$ChkSts=1">
            <Quote name="GetSeq"/>
            <Set>MsgRef=$MsgId</Set>
            <Exec func="PUB:CallThirdOther" error="IGNORE"><!--明细对账回执-->
               <Arg name="HTxnCd" value="2111"/>
               <Arg name="ObjSvr" value="SMQMTIP2"/>
            </Exec>
            <If condition="~RetCod=0">
               <Exec  func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdMsgRef" />
               </Exec>
               <Set>RspCod=000000</Set>
               <Set>MsgTyp=N</Set>
               <Return/>
            </If>
            <Else>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=对账成功，发送对账回执失败</Set>
               <Return/>
            </Else>
         </If>
         <Exec func="PUB:AddAuthReason" > <!--添加授权原因 -->
            <Arg name="AthCod" value="30" />
            <Arg name="AthMsg" value="FA0002" />
         </Exec>
         <Exec  func="PUB:CheckLocalAuth" > <!--授权检查-->
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdChkSts1"/>
         </Exec>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdChkSts2"/>
         </Exec>
         <Quote name="Check"/><!--对账-->

         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkRslSql1" />
         </Exec>
         <!--存在人行多或者关键信息不符记录-->
         <If condition="~RetCod=0">
            <Set>ChkSts=2</Set>
            <Set>RknSts=0</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Exec func="PUB:ReadRecord" error="IGNORE"><!--人行多的记录-->
               <Arg name="SqlCmd" value="ChkRslSql3" />
            </Exec>
            <If condition="~RetCod=0">
               <!--Set>RspCod=910699</Set-->
               <Set>RspCod=24030</Set>
               <Set>AddWord=对账不符</Set>
               <Set>RspMsg=人行多账</Set>
            </If>
            <Exec func="PUB:ReadRecord" error="IGNORE"><!--关键信息不符的记录-->
               <Arg name="SqlCmd" value="ChkRslSql4" />
            </Exec>
            <If condition="~RetCod=0">
               <!--Set>RspCod=910699</Set-->
               <Set>RspCod=24030</Set>
               <Set>AddWord=对账不符</Set>
               <Set>RspMsg=关键信息不符</Set>
            </If>
            <Quote name="2111"/>                          <!--发对账回执-->
            <Return/>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
         </ElseIf>
         <Exec func="PUB:ReadRecord" error="IGNORE"><!--我行是否多账-->
            <Arg name="SqlCmd" value="ChkRslSql2" />
         </Exec>
         <If condition="~RetCod=0">
            <If condition="$ChkMod=1">               <!--日切-->
               <!--Set>RspCod=910699</Set-->
               <Set>RspCod=24030</Set>
               <Set>AddWord=对账不符</Set>
               <Set>RspMsg=我行多账</Set>
               <Set>ChkSts=2</Set>
               <Set>RknSts=0</Set>
               <Exec func="PUB:ExecSql">  <!--更新对账登记簿-->
                  <Arg name="SqlCmd" value="UpdChkBok"/>
               </Exec>
            </If>
            <ElseIf condition="$ChkMod=0">   <!--日间-->
               <Set>ChkSts=1</Set>
               <Set>RknSts=0</Set>
               <Exec func="PUB:ExecSql">  <!--更新对账登记簿-->
                  <Arg name="SqlCmd" value="UpdChkBok"/>
               </Exec>
               <Set>RspCod=000000</Set>
            </ElseIf>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>ChkSts=1</Set>
            <Set>RknSts=0</Set>
            <Exec func="PUB:ExecSql">  <!--更新对账登记簿-->
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Set>RspCod=000000</Set>
         </ElseIf>
         <Quote name="2111"/>                          <!--发对账回执-->
      </FlowCtrl>
   </Transaction>

   <!--人工重新发起清算-->
   <!--Modified by zhq_BoCom00031672_20080310_修改SQL语句GetCrBkNo添加TRptTyp(报文种类)和TBusTyp(业务种类)-->
   <Transaction code="915853">
      <DynSentence name="GetOriLogNo"><!--取清算LogNo,对账状态-->
         <Sentence>
            SELECT LogNo OLogNo,ChkSts,RknSts,AllAmt,AllNum FROM tipchkbok WHERE PBnkNo='%s' and RBnkNo='%s' and ChkDat='%s' and ChkOrd='%s'
         </Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="QryOriJnl"><!--挂账清算时，查询原挂账流水-->
         <Sentence>
            SELECT * FROM tiptxnjnl WHERE LogNo='%s'
         </Sentence>
         <Fields>OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="QryBrkInf"><!--根据付款清算行号取清算参数-->
         <Sentence>
            SELECT BrkNo,SndAct,ActSqn,SndAct,SndNam,DBrkNo FROM tipbrkinf WHERE PBnkNo='%s' and RknFlg='1'
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      <!--DynSentence name="GetCrBkNo"--> <!--由清算国库的支付行号取得 收款账号 收款户名  清算类型 批扣类型 协议检查标志 电子回单标志 关联行号(入账分行)-->
      <!--Sentence>
      select RAccNo RcvNo,RAccNm RcvNam,RknTyp,BatTyp,PChkFg,BCrtFg,BrkNo CBrkNo from tiptrerkn where RBnkNo='%s'
      </Sentence> <Fields>RBnkNo|</Fields>
      </DynSentence-->
      <!--由清算国库的支付行号取得 收款账号 收款户名  清算类型 批扣类型 协议检查标志 电子回单标志 关联行号(入账分行) 报文种类 业务种类-->
      <DynSentence name="GetCrBkNo">
         <Sentence>
            SELECT RAccNo RcvNo,RAccNm RcvNam,RknTyp,BatTyp,PChkFg,BCrtFg,BrkNo CBrkNo,TRptTyp,TBusTyp FROM tiptrerkn WHERE RBnkNo='%s' FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <Quote name="ChkRknUpdSQL"/><!--对账清算公共更新SQL-->
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>CrpCod=000000</Set>
         <If condition="SUBSTR($NodNo,4,3)!=800">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心柜员</Set>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetOriLogNo" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原清算信息不存在</Set>
            <Return/>
         </If>
         <If condition="$ChkSts!=1">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=对账不成功，不能清算</Set>
            <Return/>
         </If>
         <If condition="$RknSts=1">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=已经清算成功,不能重复清算</Set>
            <Return/>
         </If>
         <Set>QryDat=SUBSTR($OLogNo,1,8)</Set>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="QryBrkInf" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=取不到上线行信息</Set>
            <Set>ChkSts=1</Set>
            <Set>RknSts=2</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCrBkNo" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=取不到清算国库信息</Set>
            <Set>ChkSts=1</Set>
            <Set>RknSts=2</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Return/>
         </If>
         <!-- 添加授权原因   -->
         <Exec func="PUB:AddAuthReason" >
            <Arg name="AthCod" value="30" />
            <Arg name="AthMsg" value="FA0002" />
         </Exec>
         <!--  授权检查  -->
         <Exec  func="PUB:CheckLocalAuth">
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>

         <Set>TIATyp=T</Set>
         <Set>AthLvl=00</Set>
         <Set>Sup1Id=       </Set>
         <Set>Sup2Id=       </Set>
         <Set>Sup1Pw=      </Set>
         <Set>Sup2Pw=      </Set>
         <Set>Sup1Dv=0</Set>
         <Set>Sup1Dv=0</Set>
         <Set>AthTbl=      </Set>

         <Set>CnlSub=$BrkNo</Set>
         <Exec func="PUB:GetVirtualTeller"/>
         <If condition="INTCMP($AllAmt,3,0)=1"><!--清算金额为零-->
            <Set>RspCod=90000</Set>
            <Set>ChkSts=1</Set>
            <Set>RknSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Return/>
         </If>
         <If condition="$RknTyp=0"><!--大额支付-->
            <Set>BrkNo=$DBrkNo</Set>
            <Exec func="PUB:CodeSwitching">
               <Arg name="DatSrc" value="TIPCSW"></Arg>
               <Arg name="SourNam" value="BrkNo"></Arg>
               <Arg name="DestNam" value="SRN"></Arg>
               <Arg name="TblNam" value="Cod2SRN"></Arg>
            </Exec>
            <Set>@MSG.SRN=$SRN</Set>
            <Set>OBusTy=$BusTyp</Set>
            <Set>LogNo=$OLogNo</Set>
            <Set>ActDat=STRCAT(20,SUBSTR($LogNo,1,6))</Set>
            <Delete>$TrmNo</Delete>
            <!--Modified by zhq_BoCom00031672_20080307(取清算国库表中的业务种类和报文种类来登记大额支付信息)-->
            <!--Set>PMBTyp=12</Set>
            <Set>CMTCod=CMT103</Set-->
            <Set>PMBTyp=$TBusTyp</Set>
            <Set>CMTCod=$TRptTyp</Set>
            <Set>SOpnBk=$PBnkNo</Set>
            <Set>ROpnBk=$RBnkNo</Set>
            <Exec func="PUB:CallLocal"><!-- error="IGNORE"查询支付系统原清算流水是否成功-->
               <Arg name="TxnCod" value="359230" />
               <Arg name="ObjSvr" value="OFRTPMS1"/>
            </Exec>
            <If condition="~RetCod=0">
               <If condition="AND(IS_NOEQUAL_STRING($BilSts,0),IS_NOEQUAL_STRING($BilSts,1))"><!-- 0和1为失败 其他都是成功-->
                  <!--If condition="$BilSts!=0"--><!-- 0和1为失败 其他都是成功-->
                  <!--If condition="$BilSts!=1"-->
                  <Set>ChkSts=1</Set>
                  <Set>RknSts=1</Set>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdChkBok"/>
                  </Exec>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdBusLog"/>
                  </Exec>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok"/>
                  </Exec>
                  <Set>RspCod=000000</Set>
                  <Return/>
                  <!--/If-->
               </If>
            </If>
            <Set>TTxnCd=915853</Set>

            <Set>TxnDat=$ActDat</Set>
            <Set>BilDat=$ActDat</Set>
            <Set>CcyCod=CNY</Set>
            <Set>TxnAmt=$AllAmt</Set>
            <Set>Smr=STRCAT(税款入库 对账日期,$ChkDat, 对账批次,$ChkOrd, 对账笔数,$AllNum)</Set>
            <Set>RBkNo=$RBnkNo</Set>
            <Set>RcvAct=$RcvNo</Set>
            <Set>RpdFlg=1</Set><!--普通-->
            <Set>PayRet=0</Set><!--汇路标识-->
            <Set>NodNo=STRCAT(SUBSTR($DBrkNo,1,3),800)</Set>

            <!--主机接口相关-->
            <Set>HTxnCd=915850</Set>
            <Set>RknTyp=1</Set>
            <Set>ActNod=STRCAT(SUBSTR($DBrkNo,1,3),800)</Set><!--清算行部门号-->
            <Set>CAcNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set><!--关联行部门号-->

            <Exec func="PUB:GetLogNo"/>
            <Set>LogNo=STRCAT(SUBSTR($LogNo,1,8),A,SUBSTR($LogNo,10,5))</Set><!--防止总行前置与分行前置LogNo冲突-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdLogNo"/>
            </Exec>
            <Exec func="PUB:CallLocal" error="IGNORE">
               <Arg name="TxnCod" value="359220" />
               <Arg name="ObjSvr" value="OFRTPMS1"/>
            </Exec>
            <Delete>@MSG.SRN</Delete>
            <If condition="~RetCod&lt;0"><!--超时或者发送失败-->
               <Set>ChkSts=1</Set>
               <Set>RknSts=2</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=调用支付系统清算失败</Set>
            </If>
            <ElseIf condition="~RetCod=3"><!--支付系统返回失败-->
               <Set>ChkSts=1</Set>
               <Set>RknSts=2</Set>
            </ElseIf>
            <Else>                        <!--成功-->
               <Set>ChkSts=1</Set>
               <Set>RknSts=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdBusLog"/>
               </Exec>
            </Else>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
         </If>
         <ElseIf condition="$RknTyp=2"><!--挂账-->
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="QryOriJnl" />
            </Exec>
            <If condition="~RetCod=0">
               <If condition="$HTxnSt=T">
                  <Exec  func="PUB:GetLogNo" />
                  <Exec func="PUB:CallHostOther">
                     <Arg name="TxnCod" value="458980" />
                     <Arg name="ObjSvr" value="SHSTPUB1"/>
                  </Exec>
                  <If condition="~RetCod=0">
                     <If condition="IS_NOEQUAL_STRING($CrcSts,Y)"> <!--原记账状态正常 -->
                        <!--已经清算成功-->
                        <Set>ChkSts=1</Set>
                        <Set>RknSts=1</Set>
                        <Set>RspCod=000000</Set>
                        <Set>TckNo=$OTckNo</Set>
                        <Set>DActNo= </Set>
                        <Set>CActNo= </Set>
                        <Set>CclNo= </Set>
                        <Set>TxnCID= </Set>
                        <Exec func="PUB:ExecSql">
                           <Arg name="SqlCmd" value="UpdChkBok"/>
                        </Exec>
                        <Exec func="PUB:ExecSql">
                           <Arg name="SqlCmd" value="UpdTckNo"/>
                        </Exec>
                        <Exec func="PUB:ExecSql">
                           <Arg name="SqlCmd" value="UpdTxnBok"/>
                        </Exec>
                        <Return/>
                     </If>
                  </If>
               </If>
            </If>
            <Set>TTxnCd=915853</Set>
            <Set>CcyCod=CNY</Set>
            <Set>TxnAmt=$AllAmt</Set>
            <Set>HTxnCd=915850</Set>
            <Set>RecTyp=3</Set>
            <Set>RknTyp=0</Set>
            <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
            <Set>CAcNod=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set>
            <Set>Smr=STRCAT(对账日期,$ChkDat, 对账批次,$ChkOrd, 对账笔数,$AllNum)</Set>
            <Exec func="PUB:GetLogNo"/>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdLogNo"/><!--更新对账登记簿LogNo-->
            </Exec>
            <Exec func="PUB:InsertJournal" />
            <Exec func="PUB:CallHostAcc" error="IGNORE">
               <Arg name="HTxnCd" value="915850" />
               <Arg name="ObjSvr" value="SHSTPUB1" />
            </Exec>
            <If condition="~RetCod=-9">  <!--需要授权-->
               <Return/>
            </If>
            <ElseIf condition="~RetCod&lt;0"><!--发送主机失败或者超时-->
               <Set>ChkSts=1</Set>
               <Set>RknSts=2</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=通过挂账方式清算失败</Set>
            </ElseIf>
            <ElseIf condition="~RetCod=3"><!--主机返回失败-->
               <Set>ChkSts=1</Set>
               <Set>RknSts=2</Set>
            </ElseIf>
            <Else>                     <!--成功-->
               <Set>ChkSts=1</Set>
               <Set>RknSts=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTckNo"/>
               </Exec>
            </Else>
            <Exec func="PUB:UpdateJournal"/>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
         </ElseIf>
         <ElseIf condition="$RknTyp=1"><!--小额支付-->
            <Return/>
         </ElseIf>
         <Else>
            <Return/>
         </Else>
      </FlowCtrl>
   </Transaction>

   <!--状态变更通知-->
   <Transaction code="915201">
      <DynSentence name="GetPrevDt"><!--保存当前人行工作日为上个人行工作日-->
         <Sentence>
            select WorkDt PrevDt from tipsyssts  where Status='0'
         </Sentence>
      </DynSentence>
      <DynSentence name="UpdPrevDt"><!--更新人行上个工作日-->
         <Sentence>
            update tipsyssts Set PrevDt='%s' where Status='0'
         </Sentence>
         <Fields>PrevDt|</Fields>
      </DynSentence>
      <DynSentence name="UpdSts">
         <Sentence>
            update tipsyssts Set WorkDt='%s',Status='%s' where Status!='%s'
         </Sentence>
         <Fields>WrkDat|SysSts|SysSts|</Fields>
      </DynSentence>
      <DynSentence name="Qry1"><!--征收机关-->
         <Sentence>
            select * from tiporgupd where EffDat='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del1"><!--征收机关-->
         <Sentence>
            delete from tiporginf where OrgCod='%s' and EffDat='%s'
         </Sentence>
         <Fields>OrgCod|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Qry2"><!--节点-->
         <Sentence>
            select * from tipnodupd where EffDat='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del2"><!--节点-->
         <Sentence>
            delete from tipnodinf where NodCod='%s' and EffDat='%s'
         </Sentence>
         <Fields>NodCod|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Qry3"><!--国库-->
         <Sentence>
            select * from tiptreupd where EffDat='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del3"><!--国库-->
         <Sentence>
            delete from tiptreinf where TreCod='%s' and EffDat='%s'
         </Sentence>
         <Fields>TreCod|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Qry4"><!--税种-->
         <Sentence>
            select * from tiptypupd where EffDat='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del4"><!--税种-->
         <Sentence>
            delete from tiptaxtyp where TaxTCd='%s' and EffDat='%s'
         </Sentence>
         <Fields>TaxTCd|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Qry5"><!--税目-->
         <Sentence>
            select * from tipsbjupd where EffDat='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del5"><!--税目-->
         <Sentence>
            delete from tiptaxsbj where TaxSbCd='%s' and EffDat='%s'
         </Sentence>
         <Fields>TaxSbCd|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="sql1"><!--征收机关-->
         <Sentence>
            OrgCod='%s'
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <DynSentence name="sql2"><!--节点-->
         <Sentence>
            NodCod='%s'
         </Sentence>
         <Fields>NodCod|</Fields>
      </DynSentence>
      <DynSentence name="sql3"><!--国库-->
         <Sentence>
            TreCod='%s'
         </Sentence>
         <Fields>TreCod|</Fields>
      </DynSentence>
      <DynSentence name="sql4"><!--税种-->
         <Sentence>
            TaxTCd='%s'
         </Sentence>
         <Fields>TaxTCd|</Fields>
      </DynSentence>
      <DynSentence name="sql5"><!--税目-->
         <Sentence>
            TaxSbCd='%s'
         </Sentence>
         <Fields>TaxSbCd|</Fields>
      </DynSentence>
      <DynSentence name="Delete1">
         <Sentence>
            delete from tiporgupd where EffDat='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Delete2">
         <Sentence>
            delete from tipnodupd where EffDat='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Delete3">
         <Sentence>
            delete from tiptreupd where EffDat='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Delete4">
         <Sentence>
            delete from tiptypupd where EffDat='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Delete5">
         <Sentence>
            delete from tipsbjupd where EffDat='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="$SysSts=1"><!--0:日切结束;1:日切开始-->
            <Exec  func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="GetPrevDt" />
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdPrevDt"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdSts"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>

            <!--触发公共数据更新，使当日生效的数据生效-->
            <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
               <Arg name="SqlCmd" value="Qry1"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Return/>
            </If>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE"/>
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <ElseIf condition="~RetCod=-1">
                  <Set>RspCod=99003</Set>
                  <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </ElseIf>
               <Switch expression="$OprSgn">
                  <Case value="1">       <!--新增 -->
                     <Exec func="PUB:InsertRecord" error="IGNORE">
                        <Arg name="TblNam" value="tiporginf"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="2">       <!--修改 -->
                     <Exec func="PUB:UpdateRecord" error="IGNORE">
                        <Arg name="TblNam" value="tiporginf"/>
                        <Arg name="CndSts" value="sql1"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="3">       <!--注销 -->
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd" value="Del1"/>
                     </Exec>
                     <Break/>
                  </Case>
               </Switch>
            </While>
            <Exec func="PUB:CloseCursor"/>
            <Exec func="PUB:CommitWork"/>
            <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
               <Arg name="SqlCmd" value="Qry2"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Return/>
            </If>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE"/>
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <ElseIf condition="~RetCod=-1">
                  <Set>RspCod=99003</Set>
                  <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </ElseIf>
               <Switch expression="$OprSgn">
                  <Case value="1">       <!--新增 -->
                     <Exec func="PUB:InsertRecord" error="IGNORE">
                        <Arg name="TblNam" value="tipnodinf"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="2">       <!--修改 -->
                     <Exec func="PUB:UpdateRecord" error="IGNORE">
                        <Arg name="TblNam" value="tipnodinf"/>
                        <Arg name="CndSts" value="sql2"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="3">       <!--注销 -->
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd" value="Del2"/>
                     </Exec>
                     <Break/>
                  </Case>
               </Switch>
            </While>
            <Exec func="PUB:CloseCursor"/>
            <Exec func="PUB:CommitWork"/>
            <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
               <Arg name="SqlCmd" value="Qry3"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Return/>
            </If>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE"/>
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <ElseIf condition="~RetCod=-1">
                  <Set>RspCod=99003</Set>
                  <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </ElseIf>
               <Switch expression="$OprSgn">
                  <Case value="1">       <!--新增 -->
                     <Exec func="PUB:InsertRecord" error="IGNORE">
                        <Arg name="TblNam" value="tiptreinf"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="2">       <!--修改 -->
                     <Exec func="PUB:UpdateRecord" error="IGNORE">
                        <Arg name="TblNam" value="tiptreinf"/>
                        <Arg name="CndSts" value="sql3"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="3">       <!--注销 -->
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd" value="Del3"/>
                     </Exec>
                     <Break/>
                  </Case>
               </Switch>
            </While>
            <Exec func="PUB:CloseCursor"/>
            <Exec func="PUB:CommitWork"/>
            <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
               <Arg name="SqlCmd" value="Qry4"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Return/>
            </If>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE"/>
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <ElseIf condition="~RetCod=-1">
                  <Set>RspCod=99003</Set>
                  <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </ElseIf>
               <Switch expression="$OprSgn">
                  <Case value="1">       <!--新增 -->
                     <Exec func="PUB:InsertRecord" error="IGNORE">
                        <Arg name="TblNam" value="tiptaxtyp"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="2">       <!--修改 -->
                     <Exec func="PUB:UpdateRecord" error="IGNORE">
                        <Arg name="TblNam" value="tiptaxtyp"/>
                        <Arg name="CndSts" value="sql4"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="3">       <!--注销 -->
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd" value="Del4"/>
                     </Exec>
                     <Break/>
                  </Case>
               </Switch>
            </While>
            <Exec func="PUB:CloseCursor"/>
            <Exec func="PUB:CommitWork"/>
            <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
               <Arg name="SqlCmd" value="Qry5"/>
            </Exec>
            <If condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Return/>
            </If>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE"/>
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <ElseIf condition="~RetCod=-1">
                  <Set>RspCod=99003</Set>
                  <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </ElseIf>
               <Switch expression="$OprSgn">
                  <Case value="1">       <!--新增 -->
                     <Exec func="PUB:InsertRecord" error="IGNORE">
                        <Arg name="TblNam" value="tiptaxsbj"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="2">       <!--修改 -->
                     <Exec func="PUB:UpdateRecord" error="IGNORE">
                        <Arg name="TblNam" value="tiptaxsbj"/>
                        <Arg name="CndSts" value="sql5"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Case value="3">       <!--注销 -->
                     <Exec func="PUB:ExecSql" error="IGNORE">
                        <Arg name="SqlCmd" value="Del5"/>
                     </Exec>
                     <Break/>
                  </Case>
               </Switch>
            </While>
            <Exec func="PUB:CloseCursor"/>
            <Exec func="PUB:CommitWork"/>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="Delete1"/>
            </Exec>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="Delete2"/>
            </Exec>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="Delete3"/>
            </Exec>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="Delete4"/>
            </Exec>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="Delete5"/>
            </Exec>
         </If>
         <ElseIf condition="$SysSts=0"> <!--日切结束-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdSts"/>
            </Exec>
            <Exec func="PUB:CallLocal"  error="IGNORE">
               <Arg name="TxnCod"  value="915202"/>
               <Arg name="ObjSvr"  value="OFRTTIP1"/>
            </Exec>
         </ElseIf>
      </FlowCtrl>
   </Transaction>



   <!--人工重发批扣回执包-->
   <Transaction code="915854">
      <DynSentence name="QryBatBok"><!--查询批量包登记簿-->
         <Sentence>
            select PBnkNo,EntDat,SPckNo,RPckNo,ROrgCd,AllNum,AllAmt,SucNum,SucAmt,Status,ReqDat from tipbatbok where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnBok"><!--查询人行账务登记簿-->
         <Sentence>
            select TraNo,TxnAmt,TaxVID,ActDat,BilSts,HRspCd RspCod from tiptxnbok
            where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdBatBok"><!--更新状态和回执发送日期-->
         <Sentence>
            update tipbatbok Set Status='%s',RspDat='%s' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>Status|WorkDt|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok"><!--更新回执发送日期-->
         <Sentence>
            update tiptxnbok Set RspDat='%s',ChkSts='0' where OrgCod='%s' and EntDat='%s' and SPckNo='%s'
         </Sentence>
         <Fields>WorkDt|OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkStsSQL">
         <Sentence>
            select WorkDt from tipsyssts
         </Sentence>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStsSQL"/>
         </Exec>
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="QryBatBok" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原批量扣税包不存在</Set>
            <Return/>
         </If>
         <If condition="IS_NOEQUAL_STRING($WorkDt,$ReqDat)">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=批量包已跨天，禁止回复</Set>
            <Return/>
         </If>
         <If condition="$Status=5">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=人行已确认原批量扣税回执包</Set>
            <Return/>
         </If>
         <If condition="$Status=6">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=该批量包已被止付</Set>
            <Return/>
         </If>
         <Exec func="PUB:AddAuthReason" > <!--添加授权原因 -->
            <Arg name="AthCod" value="30" />
            <Arg name="AthMsg" value="FA0002" />
         </Exec>
         <Exec  func="PUB:CheckLocalAuth" > <!--授权检查-->
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>
         <Exec  func="PUB:QueryInGroup">
            <Arg name="SqlCmd" value="QryTxnBok"/>
            <Arg name="RecordName" value="BatchReturn2102"/>
         </Exec>
         <Set>Status=4</Set>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdBatBok"/>
         </Exec>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdTxnBok"/>
         </Exec>
         <Set>RspCod=90000</Set>
         <Quote name="GetSeq"/><!--取新的MsgId-->
         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:CallThirdOther"><!--2102批量扣税回执-->
            <Arg name="HTxnCd" value="2102"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--人工重发银行端缴款回执-->
   <Transaction code="915855">
      <DynSentence name="QryTxnBok">
         <Sentence>
            select * from tiptxnbok where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">
         <Sentence>
            update tiptxnbok Set RspDat='%s',ChkSts='0' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>WorkDt|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkStsSQL">
         <Sentence>
            select WorkDt from tipsyssts
         </Sentence>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:AddAuthReason" > <!--添加授权原因 -->
            <Arg name="AthCod" value="30" />
            <Arg name="AthMsg" value="FA0002" />
         </Exec>
         <Exec  func="PUB:CheckLocalAuth" > <!--授权检查-->
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStsSQL"/>
         </Exec>
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="QryTxnBok" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原银行端缴税记录不存在</Set>
            <Return/>
         </If>
         <If condition="$BilSts=1"><!--成功-->
            <Set>RspCod=000000</Set>
            <Set>RspMsg=交易成功</Set>
         </If>
         <Else>                    <!--失败-->
            <Set>RspCod=94999</Set>
         </Else>
         <Quote name="GetSeq"/><!--取新的MsgId-->
         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:CallThirdOther">
            <Arg name="TxnCod"  value="2108"/>
            <Arg name="ObjSvr"  value="MMQMTIP1"/> <!-- modified by ly 20090729 CQ76186 -->
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--公共数据更新-->
   <Transaction code="915203">
      <DynSentence name="QryTxnBok">
         <Sentence>
            select * from tiptxnbok where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">
         <Sentence>
            update tiptxnbok Set RspDat='%s',ChkSts='0' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>WorkDt|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkStsSQL">
         <Sentence>
            select WorkDt from tipsyssts
         </Sentence>
      </DynSentence>
      <DynSentence name="Qry1"><!--征收机关-->
         <Sentence>
            select * from tiporgupd where EffDat&lt;='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del1"><!--征收机关-->
         <Sentence>
            delete from tiporginf where OrgCod='%s' and EffDat&lt;='%s'
         </Sentence>
         <Fields>OrgCod|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Qry2"><!--节点-->
         <Sentence>
            select * from tipnodupd where EffDat&lt;='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del2"><!--节点-->
         <Sentence>
            delete from tipnodinf where NodCod='%s' and EffDat&lt;='%s'
         </Sentence>
         <Fields>NodCod|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Qry3"><!--国库-->
         <Sentence>
            select * from tiptreupd where EffDat&lt;='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del3"><!--国库-->
         <Sentence>
            delete from tiptreinf where TreCod='%s' and EffDat&lt;='%s'
         </Sentence>
         <Fields>TreCod|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Qry4"><!--税种-->
         <Sentence>
            select * from tiptypupd where EffDat&lt;='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del4"><!--税种-->
         <Sentence>
            delete from tiptaxtyp where TaxTCd='%s' and EffDat&lt;='%s'
         </Sentence>
         <Fields>TaxTCd|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Qry5"><!--税目-->
         <Sentence>
            select * from tipsbjupd where EffDat&lt;='%s' for read only
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Del5"><!--税目-->
         <Sentence>
            delete from tiptaxsbj where TaxSbCd='%s' and EffDat&lt;='%s'
         </Sentence>
         <Fields>TaxSbCd|WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="sql1"><!--征收机关-->
         <Sentence>
            OrgCod='%s'
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <DynSentence name="sql2"><!--节点-->
         <Sentence>
            NodCod='%s'
         </Sentence>
         <Fields>NodCod|</Fields>
      </DynSentence>
      <DynSentence name="sql3"><!--国库-->
         <Sentence>
            TreCod='%s'
         </Sentence>
         <Fields>TreCod|</Fields>
      </DynSentence>
      <DynSentence name="sql4"><!--税种-->
         <Sentence>
            TaxTCd='%s' AND OrgTyp='%s'
         </Sentence>
         <Fields>TaxTCd|OrgTyp|</Fields>
      </DynSentence>
      <DynSentence name="sql5"><!--税目-->
         <Sentence>
            TaxSbCd='%s' AND OrgTyp='%s'
         </Sentence>
         <Fields>TaxSbCd|OrgTyp|</Fields>
      </DynSentence>
      <DynSentence name="Delete1">
         <Sentence>
            delete from tiporgupd where EffDat&lt;='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Delete2">
         <Sentence>
            delete from tipnodupd where EffDat&lt;='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Delete3">
         <Sentence>
            delete from tiptreupd where EffDat&lt;='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Delete4">
         <Sentence>
            delete from tiptypupd where EffDat&lt;='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <DynSentence name="Delete5">
         <Sentence>
            delete from tipsbjupd where EffDat&lt;='%s'
         </Sentence>
         <Fields>WrkDat|</Fields>
      </DynSentence>
      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tiporgupd"/>
            <Arg name="GrpNam" value="TaxCodeInfo101"/>
            <Arg name="FldLst" value="UpdBat|"/>
         </Exec>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tipnodupd"/>
            <Arg name="GrpNam" value="NodeCodeInfo103"/>
            <Arg name="FldLst" value="UpdBat|"/>
         </Exec>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tiptreupd"/>
            <Arg name="GrpNam" value="TreCodeInfo104"/>
            <Arg name="FldLst" value="UpdBat|"/>
         </Exec>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tiptypupd"/>
            <Arg name="GrpNam" value="TaxTypeCode108"/>
            <Arg name="FldLst" value="UpdBat|"/>
         </Exec>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tipsbjupd"/>
            <Arg name="GrpNam" value="TaxSubjectCode109"/>
            <Arg name="FldLst" value="UpdBat|"/>
         </Exec>
         <Exec func="PUB:CommitWork"/>
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="TaxCodeInfo101"/>
         </Exec>
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="BankCodeInfo102"/>
         </Exec>
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="NodeCodeInfo103"/>
         </Exec>
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="TreCodeInfo104"/>
         </Exec>
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="TaxTypeCode108"/>
         </Exec>
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="TaxSubjectCode109"/>
         </Exec>
         <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
            <Arg name="SqlCmd" value="Qry1"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Switch expression="$OprSgn">
               <Case value="1">       <!--新增 -->
                  <Exec func="PUB:InsertRecord" error="IGNORE">
                     <Arg name="TblNam" value="tiporginf"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="2">       <!--修改 -->
                  <Exec func="PUB:UpdateRecord" error="IGNORE">
                     <Arg name="TblNam" value="tiporginf"/>
                     <Arg name="CndSts" value="sql1"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="3">       <!--注销 -->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="Del1"/>
                  </Exec>
                  <Break/>
               </Case>
            </Switch>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <Exec func="PUB:CommitWork"/>
         <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
            <Arg name="SqlCmd" value="Qry2"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Switch expression="$OprSgn">
               <Case value="1">       <!--新增 -->
                  <Exec func="PUB:InsertRecord" error="IGNORE">
                     <Arg name="TblNam" value="tipnodinf"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="2">       <!--修改 -->
                  <Exec func="PUB:UpdateRecord" error="IGNORE">
                     <Arg name="TblNam" value="tipnodinf"/>
                     <Arg name="CndSts" value="sql2"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="3">       <!--注销 -->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="Del2"/>
                  </Exec>
                  <Break/>
               </Case>
            </Switch>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <Exec func="PUB:CommitWork"/>
         <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
            <Arg name="SqlCmd" value="Qry3"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Switch expression="$OprSgn">
               <Case value="1">       <!--新增 -->
                  <Exec func="PUB:InsertRecord" error="IGNORE">
                     <Arg name="TblNam" value="tiptreinf"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="2">       <!--修改 -->
                  <Exec func="PUB:UpdateRecord" error="IGNORE">
                     <Arg name="TblNam" value="tiptreinf"/>
                     <Arg name="CndSts" value="sql3"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="3">       <!--注销 -->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="Del3"/>
                  </Exec>
                  <Break/>
               </Case>
            </Switch>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <Exec func="PUB:CommitWork"/>
         <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
            <Arg name="SqlCmd" value="Qry4"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Switch expression="$OprSgn">
               <Case value="1">       <!--新增 -->
                  <Exec func="PUB:InsertRecord" error="IGNORE">
                     <Arg name="TblNam" value="tiptaxtyp"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="2">       <!--修改 -->
                  <Exec func="PUB:UpdateRecord" error="IGNORE">
                     <Arg name="TblNam" value="tiptaxtyp"/>
                     <Arg name="CndSts" value="sql4"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="3">       <!--注销 -->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="Del4"/>
                  </Exec>
                  <Break/>
               </Case>
            </Switch>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <Exec func="PUB:CommitWork"/>
         <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
            <Arg name="SqlCmd" value="Qry5"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Switch expression="$OprSgn">
               <Case value="1">       <!--新增 -->
                  <Exec func="PUB:InsertRecord" error="IGNORE">
                     <Arg name="TblNam" value="tiptaxsbj"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="2">       <!--修改 -->
                  <Exec func="PUB:UpdateRecord" error="IGNORE">
                     <Arg name="TblNam" value="tiptaxsbj"/>
                     <Arg name="CndSts" value="sql5"/>
                  </Exec>
                  <Break/>
               </Case>
               <Case value="3">       <!--注销 -->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                     <Arg name="SqlCmd" value="Del5"/>
                  </Exec>
                  <Break/>
               </Case>
            </Switch>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <Exec func="PUB:CommitWork"/>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delete1"/>
         </Exec>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delete2"/>
         </Exec>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delete3"/>
         </Exec>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delete4"/>
         </Exec>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="Delete5"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--财税库上日业务检查-->
   <Transaction code="915200">
      <DynSentence name="GetPrevDt"><!--取人行上个工作日期-->
         <Sentence>
            select PrevDt from tipsyssts
         </Sentence>
      </DynSentence>
      <DynSentence name="SUM"><!--统计总笔数 上日对账失败或者清算失败-->
         <Sentence>
            select count(*) ErrNum from tipchkbok where CBrkNo='%s' and ChkDat='%s' and (ChkSts = '2' or RknSts = '2')
         </Sentence>
         <Fields>BrNo|PrevDt|</Fields>
      </DynSentence>

      <DynSentence name="QryChkBok"><!--上日对账失败或者清算失败-->
         <Sentence>
            select * from tipchkbok where CBrkNo='%s' and ChkDat='%s' and (ChkSts = '2' or RknSts = '2')
         </Sentence>
         <Fields>BrNo|PrevDt|</Fields>
      </DynSentence>

      <DynSentence name="SUM2"><!--上日未对账的记录总数-->
         <Sentence>
            select count(*) NChkNm from tiptxnbok where CBrkNo='%s' and BilSts='1' and ChkSts='0' and RspDat='%s'
         </Sentence>
         <Fields>BrNo|PrevDt|</Fields>
      </DynSentence>

      <!--以下SQL用于生成差错清单-->
      <DynSentence name="Query1"><!--对账清算失败-->
         <Sentence>
            select * from tipchkbok where CBrkNo='%s' and ChkDat='%s' and (ChkSts='2' or RknSts='2')
         </Sentence>
         <Fields>BrNo|PrevDt|</Fields>
      </DynSentence>
      <DynSentence name="Query2"><!--清算失败-->
         <Sentence>
            select * from tipchkbok where CBrkNo='%s' and ChkDat='%s' and ChkSts='1' and RknSts = '2'
         </Sentence>
         <Fields>BrNo|PrevDt|</Fields>
      </DynSentence>
      <DynSentence name="Query3"><!--与主机核对余额不符-->
         <Sentence>
            select CurBal,BokBal,ChkSts ChkBal,RecDat from tipsbjbal where BrkNo='%s' AND RecDat='%s' AND ChkSts='2'
         </Sentence>
         <Fields>BrNo|PrevDt|</Fields>
      </DynSentence>
      <DynSentence name="Query4"><!--上日未对账-->
         <Sentence>
            select * from tiptxnbok where CBrkNo='%s' and rspdat='%s' and bilsts='1' and chksts='0'
         </Sentence>
         <Fields>BrNo|PrevDt|</Fields>
      </DynSentence>
      <DynSentence name="Query5"><!--财政零余额挂账-->
         <Sentence>
            select * from tiptxnbok where  CBrkNo='%s' and bilsts='L' and Actdat='%s'
         </Sentence>
         <Fields>BrNo|PrevDt|</Fields>
      </DynSentence>

      <DynSentence name="WriteTitle"><!--标题-->
         <Sentence>%s\n</Sentence>
         <Fields>Title|</Fields>
      </DynSentence>
      <DynSentence name="Write1"><!--对账清算失败-->
         <Sentence>%s            %s         %s         %s           %s       %s         %s     %s     %s\n</Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|CChkMod|AllNum|AllAmt1|CChkSts|CRknSts|</Fields>
      </DynSentence>
      <DynSentence name="Write2"><!--清算失败-->
         <Sentence>%s            %s         %s         %s           %s         %s\n</Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|ChkOrd|AllNum|AllAmt|</Fields>
      </DynSentence>
      <DynSentence name="Write3"><!--与主机核对余额不符-->
         <Sentence>%s      %s          %s               %s\n\n</Sentence>
         <Fields>BrNo|RecDat|CurBal|BokBal|</Fields>
      </DynSentence>
      <DynSentence name="Write4"><!--上日未对账-->
         <Sentence>%s      %s      %s     %s      %s      %s     %s%s     %s     %s    %s\n</Sentence>
         <Fields>RBnkNo|PBnkNo|ReqDat|OrgCod|EntDat|TraNo|CPayMod|ActNo|TxnAmt|ActDat|TckNo|</Fields>
      </DynSentence>
      <DynSentence name="Write5"><!--财政挂账-->
         <Sentence>%s %s%s      %s       %s    %s              %s             %s         %s    %s    \n</Sentence>
         <Fields>ActNo|ActNam|DActNo|CclNo|TxnAmt|CTckNo|TraNo|ActDat|TckNo|LogNo|</Fields>
      </DynSentence>
      <DynSentence name="Write6"><!--打印柜员 打印日期-->
         <Sentence>%s\n</Sentence>
         <Fields>PrtInf|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>     <!--根据网点号取分行号-->
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>OTlrId=$TlrId</Set>
         <Set>PrtDat=$ActDat</Set>
         <Set>DesNod=$NodNo</Set>
         <If condition="SUBSTR($NodNo,4,3)!=800">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心柜员</Set>
            <Return/>
         </If>
         <!--根据网点号取行号(6位)-->
         <Quote name="GetBrkCTL"/>
         <!-- add by ly at 20090915 for CQ87568 begin -->
         <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
            <Set>OprNod=$OprBr</Set>
            <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
            <Set>BrNo=$OprBr</Set>
         </If> 
         <!-- add by ly at 20090915 for CQ87568 end -->   
                
         <Exec func="PUB:ReadRecord">    <!--取人行上个工作日期-->
            <Arg name="SqlCmd" value="GetPrevDt"/>
         </Exec>
         <!--产生非会计流水-->
         <Exec  func="PUB:GetLogNo"/>
         <Set>Time=GETDATETIME(HHMISS)</Set>
         <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,时间:,$Time,交易柜员:,$TlrId,备注:财税库行上日业务检查)</Set>
         <Exec func="PUB:CallHostOther">
            <Arg name="TxnCod" value="915880" />
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>
         <Set>RspCod=000000</Set>
         <Set>ChkFlg=0</Set>
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="SUM"/>
         </Exec>
         <If condition="$ErrNum!=0">         <!--对账或清算失败-->
            <Set>ChkFlg=1</Set>
         </If>
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="SUM2"/>
         </Exec>
         <If condition="$NChkNm!=0">       <!--存在隔日未对账-->
            <Set>ChkFlg=1</Set>
         </If>
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="Query3"/>
         </Exec>
         <If condition="~RetCod=0">       <!--与主机核对余额失败-->
            <Set>ChkFlg=1</Set>
         </If>
         <Else>
            <Set>ChkBal=1</Set>
            <Set>RspCod=000000</Set>
            <Set>MsgTyp=N</Set>
         </Else>

         <!--生成差错清单-->
         <Set>FTxnTm=GETDATETIME()</Set>
         <Set>FilNam=STRCAT(ERRRPT,.,$BrNo,.,$TlrId,.,$FTxnTm)</Set> <!-- modified by ly 20090915 CQ87568 -->
         <Set>Title=STRCAT(                   上日财税库行业务检查,              会计日期 ,$ActDat)</Set>
         <Exec func="PUB:WriteFile">
            <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="PRNFMT" value="WriteTitle"/>
         </Exec>
         <!--对账差错的记录-->
         <Set>Count=0</Set>
         <Exec func="PUB:OpenCursor">
            <Arg name="SqlCmd" value="Query1"/>
         </Exec>
         <Set>Title=对账差错：</Set>
         <Exec func="PUB:WriteFile">
            <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="PRNFMT" value="WriteTitle"/>
         </Exec>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <If condition="$Count=0">
                  <Set>Title=无对账差错记录\\n</Set>
                  <Exec func="PUB:WriteFile">
                     <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                     <Arg name="OpenMode" value="a+"/>
                     <Arg name="PRNFMT" value="WriteTitle"/>
                  </Exec>
               </If>
               <Else>
                  <Set>Title= </Set>
                  <Exec func="PUB:WriteFile">
                     <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                     <Arg name="OpenMode" value="a+"/>
                     <Arg name="PRNFMT" value="WriteTitle"/>
                  </Exec>
               </Else>
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <If condition="$Count=0">
               <Set>title=STRCAT(收款行支付行号        ,付款行支付行号        ,对账日期        ,对账批次        ,对账类型    ,总笔数        ,总金额      ,核对状态   ,清算状态   )</Set>
               <Exec func="PUB:WriteFile">
                  <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                  <Arg name="OpenMode" value="a+"/>
                  <Arg name="PRNFMT" value="WriteTitle"/>
               </Exec>
            </If>
            <Set>AllAmt1=AMTSIMPLEFMT($AllAmt)</Set>
            <Exec func="PUB:CodeSwitching">
               <Arg name="DatSrc" value="TIPCSW"></Arg>
               <Arg name="SourNam" value="ChkMod"></Arg>
               <Arg name="DestNam" value="CChkMod"></Arg>
               <Arg name="TblNam" value="ChkModTrans"></Arg>
            </Exec>
            <Exec func="PUB:CodeSwitching">
               <Arg name="DatSrc" value="TIPCSW"></Arg>
               <Arg name="SourNam" value="ChkSts"></Arg>
               <Arg name="DestNam" value="CChkSts"></Arg>
               <Arg name="TblNam" value="ChkStsTrans"></Arg>
            </Exec>
            <Exec func="PUB:CodeSwitching">
               <Arg name="DatSrc" value="TIPCSW"></Arg>
               <Arg name="SourNam" value="RknSts"></Arg>
               <Arg name="DestNam" value="CRknSts"></Arg>
               <Arg name="TblNam" value="RknStsTrans"></Arg>
            </Exec>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a+"/>
               <Arg name="PRNFMT" value="Write1"/>
            </Exec>
            <Set>Count=ADD($Count,1)</Set>
         </While>
         <Exec func="PUB:CloseCursor"/>

         <!--余额核对失败的记录-->
         <Set>title=账卡不平清单</Set>
         <Exec func="PUB:WriteFile">
            <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="PRNFMT" value="WriteTitle"/>
         </Exec>
         <Exec  func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="Query3"/>
         </Exec>
         <If condition="~RetCod=0">
            <Set>title=付款行      会计日期        主机22203余额       登记簿未清算余额</Set>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a+"/>
               <Arg name="PRNFMT" value="WriteTitle"/>
            </Exec>
            <Set>CurBal=AMTSIMPLEFMT($CurBal)</Set>
            <Set>BokBal=AMTSIMPLEFMT($BokBal)</Set>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a+"/>
               <Arg name="PRNFMT" value="Write3"/>
            </Exec>
         </If>
         <ElseIf condition="~RetCod=-2">
            <Set>title=无账卡不平记录\\n</Set>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a+"/>
               <Arg name="PRNFMT" value="WriteTitle"/>
            </Exec>
         </ElseIf>

         <!--上日未对账的记录-->
         <Set>Count=0</Set>
         <Exec func="PUB:OpenCursor">
            <Arg name="SqlCmd" value="Query4"/>
         </Exec>
         <Set>title=未对账记录</Set>
         <Exec func="PUB:WriteFile">
            <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="PRNFMT" value="WriteTitle"/>
         </Exec>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <If condition="$Count=0">
                  <Set>Title=无未对账记录\\n</Set>
                  <Exec func="PUB:WriteFile">
                     <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                     <Arg name="OpenMode" value="a+"/>
                     <Arg name="PRNFMT" value="WriteTitle"/>
                  </Exec>
               </If>
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <If condition="$Count=0">
               <Set>title=收款行               付款行       人行请求日期    征收机关        委托日期     交易流水号    纳税类型        账号                 金额      会计日期   会计流水号</Set>
               <Exec func="PUB:WriteFile">
                  <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                  <Arg name="OpenMode" value="a+"/>
                  <Arg name="PRNFMT" value="WriteTitle"/>
               </Exec>
            </If>
            <Set>TxnAmt=AMTSIMPLEFMT($TxnAmt)</Set>
            <Exec func="PUB:CodeSwitching">
               <Arg name="DatSrc" value="TIPCSW"></Arg>
               <Arg name="SourNam" value="PayMod"></Arg>
               <Arg name="DestNam" value="CPayMod"></Arg>
               <Arg name="TblNam" value="PayModTrans"></Arg>
            </Exec>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a+"/>
               <Arg name="PRNFMT" value="Write4"/>
            </Exec>
            <Set>Count=ADD($Count,1)</Set>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <!--财政零余额挂账的记录-->
         <Set>Count=0</Set>
         <Exec func="PUB:OpenCursor">
            <Arg name="SqlCmd" value="Query5"/>
         </Exec>
         <Set>title=财政零余额挂账记录</Set>
         <Exec func="PUB:WriteFile">
            <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="PRNFMT" value="WriteTitle"/>
         </Exec>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <If condition="$Count=0">
                  <Set>Title=无财政零余额挂账记录\\n</Set>
                  <Exec func="PUB:WriteFile">
                     <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                     <Arg name="OpenMode" value="a+"/>
                     <Arg name="PRNFMT" value="WriteTitle"/>
                  </Exec>
               </If>
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <If condition="$Count=0">
               <Set>title=帐号                     户名                                                          挂帐帐号                销帐号           金额      挂帐流水           交易人行流水号         原委托会计日期   交易会计流水号  授权登记凭证号</Set>
               <Exec func="PUB:WriteFile">
                  <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                  <Arg name="OpenMode" value="a+"/>
                  <Arg name="PRNFMT" value="WriteTitle"/>
               </Exec>
            </If>
            <Set>TxnAmt=AMTSIMPLEFMT($TxnAmt)</Set>
            <Exec func="PUB:CodeSwitching">
               <Arg name="DatSrc" value="TIPCSW"></Arg>
               <Arg name="SourNam" value="PayMod"></Arg>
               <Arg name="DestNam" value="CPayMod"></Arg>
               <Arg name="TblNam" value="PayModTrans"></Arg>
            </Exec>
            <Set>ActNam=ADDCHAR($ActNam,60, ,0)</Set>
            <Exec func="PUB:WriteFile">
               <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
               <Arg name="OpenMode" value="a+"/>
               <Arg name="PRNFMT" value="Write5"/>
            </Exec>
            <Set>Count=ADD($Count,1)</Set>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <Set>PrtInf=STRCAT(                                                                     打印柜员:,$OTlrId,   打印日期:,$PrtDat)</Set>
         <Exec func="PUB:WriteFile">
            <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
            <Arg name="OpenMode" value="a+"/>
            <Arg name="PRNFMT" value="Write6"/>
         </Exec>
         <!--end 生成差错清单-->


         <!--将差错清单文件下传网点-->
         <Set>MsgSmr=STRCAT($DesNod,上日财税库业务检查差错清单)</Set>
         <Exec func="PUB:SendFileToOther">
            <Arg name="MsgTyp" value="4"/>
            <Arg name="ObjNod" value="$BrkNo"/> <!-- modified by ly 20090915 CQ87568 -->
            <Arg name="BusTyp" value="CM"/>
            <Arg name="AplCod" value="999999"/>
            <Arg name="FilNam" value="$FilNam"/>
            <Arg name="Summary" value="$MsgSmr"/>
            <Arg name="ObjTlr" value="$OTlrId"/>
         </Exec>
         <Set>RspCod=000000</Set>
         <!--
         <Exec func="PUB:SendFileToOther">
         <Arg name="MsgTyp" value="3"/>
         <Arg name="ObjNod" value="$BrkNo"/>
         <Arg name="BusTyp" value="EB"/>
         <Arg name="AplCod" value="910000"/>
         <Arg name="FilNam" value="$FilNam"/>
         <Arg name="Summary" value="$MsgSmr"/>
         <Arg name="ObjTlr" value="$TlrId"/>
         </Exec>
         <Exec func="PUB:CodeSwitching">
         <Arg name="DatSrc" value="TIPCSW"/>
         <Arg name="SourNam" value="BrkNo"/>
         <Arg name="DestNam" value="SRN"/>
         <Arg name="TblNam" value="Cod2SRN"/>
         </Exec>
         <Set>@MSG.SRN=$SRN</Set>
         <Exec func="PUB:CallLocal">
         <Arg name="TxnCod" value="910290" />
         <Arg name="ObjSvr" value="OFRTTIP5"/>
         </Exec>
         <Delete>@MSG.SRN</Delete>
         <Set>RspCod=000000</Set>
         -->
      </FlowCtrl>
   </Transaction>

   <!--对账差错明细查询-->
   <Transaction code="918745">
      <DynSentence name="GetWrkDat"><!--取人行工作日期-->
         <Sentence>
            select WorkDt WrkDat from tipsyssts
         </Sentence>
      </DynSentence>
      <DynSentence name="GetPBnkNo"><!--取支付系统行号-->
         <Sentence>
            select PBnkNo from tipbrkinf where BrkNo='%s'
         </Sentence>
         <Fields>BrNo|</Fields>
      </DynSentence>
      <DynSentence name="Qry"><!--1人行多    2我行多    3关键信息不符-->  <!--   4隔日未对账-->
         <Sentence>
            select '2' ErrTyp,RBnkNo,PBnkNo,ChkDat,ChkOrd,OrgCod,EntDat,TraNo,PayMod,PayTyp,ActNo,TxnAmt,CBrkNo,RBrkNo,ActDat,TckNo,TaxVID,AgrNo from tiptxnbok where ChkSts='2' and ChkDat='%s' and (CBrkNo='%s' or RBrkNo='%s') and bilsts='1' and (ChkOrd='%s' or '%s'='    ')
            union
            select '1' ErrTyp,RBnkNo,PBnkNo,ChkDat,ChkOrd,OrgCod,EntDat,TraNo,' ' PayMod,' ' PayTyp,ActNo,TxnAmt,' ' CBrkNo,' ' RBrkNo,' ' ActDat,' ' TckNo,' ' TaxVID,' ' AgrNo from tipchkrec where ChkSts='2' and ChkDat='%s' and PBnkNo='%s' and (ChkOrd='%s' or '%s'='    ')
            union
            select '3' ErrTyp,RBnkNo,PBnkNo,ChkDat,ChkOrd,OrgCod,EntDat,TraNo,PayMod,PayTyp,ActNo,TxnAmt,CBrkNo,RBrkNo,ActDat,TckNo,TaxVID,AgrNo from tiptxnbok where ChkSts='3' and ChkDat='%s' and (CBrkNo='%s' or RBrkNo='%s') and bilsts='1' and (ChkOrd='%s' or '%s'='    ')
            <!--        union
            select '4' ErrTyp,RBnkNo,PBnkNo,RspDat,ChkOrd,OrgCod,EntDat,TraNo,PayMod,PayTyp,ActNo,TxnAmt,CBrkNo,RBrkNo,ActDat,TckNo,TaxVID,AgrNo from tiptxnbok where ChkSts='0' and RspDat &lt; '%s' and (CBrkNo='%s' or RBrkNo='%s') and bilsts='1' -->
         </Sentence>
         <Fields>ChkDat|BrNo|BrNo|ChkOrd|ChkOrd|ChkDat|PBnkNo|ChkOrd|ChkOrd|ChkDat|BrNo|BrNo|ChkOrd|ChkOrd|</Fields>
      </DynSentence>
      <!--Quote name="GetBrkSQL"/--><!-- delete by ly 20090915 CQ87568-->
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="SUBSTR($NodNo,4,3)!=800">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心柜员</Set>
            <Return/>
         </If>
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetWrkDat"/>
         </Exec>
         <!--根据网点号取行号(6位)-->
         <!--Quote name="GetBrkCTL"/--><!-- delete by ly 20090915 CQ87568-->
         <!-- add by ly at 20090915 for CQ87568 begin -->
         <If condition="IS_NOEQUAL_STRING($TIATyp,P)">
           <Set>OprNod=$OprBr</Set>
           <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
           <Set>BrNo=$OprBr</Set>
         </If>  
         <!-- add by ly at 20090915 for CQ87568 end -->         
         <!--根据行号(6位)取支付系统行号(12)-->
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>
         <!--查询对账差错记录-->
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd" value="Qry"/>
         </Exec>
         <If condition="$RspCod=000000">
            <Set>MsgTyp=N</Set>
         </If>
      </FlowCtrl>
   </Transaction>

   <!--人行交易清单打印-->
   <Transaction code="918805">
      <DynSentence name="GetPBnkNo"><!--取支付系统行号-->
         <Sentence>
            select PBnkNo,BrkNam from tipbrkinf where BrkNo='%s'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>
      <Quote name="MSBrAuChk"/><!-- add by ly 20090915 CQ87568 -->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="SUBSTR($NodNo,4,3)!=800">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心柜员</Set>
            <Return/>
         </If>
         <!--根据网点号取行号(6位)-->
         <Quote name="GetBrkCTL"/>
         <!-- add by ly at 20090915 for CQ87568 begin -->
         <Set>OprNod=$OprBr</Set>
         <Quote name="MCBrAuChk"/><!--省行代理权限检查 -->
         <Set>BrkNo=$OprBr</Set>
         <!-- add by ly at 20090915 for CQ87568 end -->  
                
         <!--根据行号(6位)取支付系统行号(12)-->
         <Exec  func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>
         <Exec func="PUB:GenerateReport">
            <Arg name="ObjFil" value="STRCAT($TSDir,$QryDat,$NodNo,TxnLst.txt)"/>
            <Arg name="FmtFil" value="etc/TXNLST_RPT.XML"/>
         </Exec>
         <Set>FilNam=STRCAT($QryDat,$NodNo,TxnLst.txt)</Set>
         <Set>MsgSmr=STRCAT($NodNo,人行交易清单打印)</Set>
         <Exec func="PUB:SendFileToOther">
            <Arg name="MsgTyp" value="4"/>
            <Arg name="ObjNod" value="$BrNo"/><!-- add by ly 20090915 CQ87568 -->
            <Arg name="BusTyp" value="CM"/>
            <Arg name="AplCod" value="999999"/>
            <Arg name="FilNam" value="$FilNam"/>
            <Arg name="Summary" value="$MsgSmr"/>
            <Arg name="ObjTlr" value="$TlrId"/>
         </Exec>
         <!--
         <Exec func="PUB:SendFileToOther">
         <Arg name="MsgTyp" value="3"/>
         <Arg name="ObjNod" value="$BrkNo"/>
         <Arg name="BusTyp" value="EB"/>
         <Arg name="AplCod" value="910000"/>
         <Arg name="FilNam" value="$FilNam"/>
         <Arg name="Summary" value="$MsgSmr"/>
         <Arg name="ObjTlr" value="$TlrId"/>
         </Exec>
         <Exec func="PUB:CodeSwitching">
         <Arg name="DatSrc" value="TIPCSW"></Arg>
         <Arg name="SourNam" value="BrkNo"></Arg>
         <Arg name="DestNam" value="SRN"></Arg>
         <Arg name="TblNam" value="Cod2SRN"></Arg>
         </Exec>
         <Set>@MSG.SRN=$SRN</Set>
         <Exec func="PUB:CallLocal">
         <Arg name="TxnCod" value="910290" />
         <Arg name="ObjSvr" value="OFRTTIP5"/>
         </Exec>
         <Delete>@MSG.SRN</Delete>
         -->
      </FlowCtrl>
   </Transaction>

   <!--Modified By zhq_BoCom00038409_20080513-->
   <!--Modified By zhq_BoCom00041319_20080707-->
   <!--Modified By zhq_BoCom00047053_20080918-->
   <!--Modified By sundx_BoCom00061739_20090330-->
   <Transaction code="915856">                              <!--日终批量对账-->
      <DynSentence name="ClrJnl">                           <!--清主机流水-->
         <Sentence>
            DELETE FROM tiphstjnl WHERE ActDat='%s'
         </Sentence>
         <Fields>ROOT.SelDat|</Fields>
      </DynSentence>

      <DynSentence name="DelRknJnl">                        <!--删除支付清算的主机流水-->
         <Sentence>
            DELETE FROM tiphstjnl WHERE logno LIKE '%A%'
         </Sentence>
      </DynSentence>

      <DynSentence name="ClrSbjBal">                        <!--清当日余额文件-->
         <Sentence>
            DELETE FROM tipsbjbal WHERE RecDat='%s'
         </Sentence>
         <Fields>ROOT.SelDat|</Fields>
      </DynSentence>

      <DynSentence name="UpdJnlHLsChk">                     <!--更新前置流水对账状态为未对账-->
         <Sentence>
            UPDATE tiptxnjnl SET HLsChk='0' WHERE ActDat='%s'
         </Sentence>
         <Fields>ROOT.SelDat|</Fields>
      </DynSentence>

      <DynSentence name="SUM">                              <!--主机批处理前未清算的金额  主机批处理后清算的当日发生交易金额-->
         <Sentence>
            SELECT COALESCE(SUM(CAST(TxnAmt AS BIGINT)),0) TolAmt
            FROM tiptxnbok
            WHERE CBrkNo='%s' AND BilSts='1' AND ( (RknSts IN ('0','2') AND  '%s' >= ActDat) OR (RknSts='1'  AND '%s' >= ActDat  AND RknDat > '%s') )
         </Sentence>
         <Fields>BrkNo|SelDat|SelDat|SelDat|</Fields>
      </DynSentence>

      <DynSentence name="GetAllAmt">                        <!--取主机余额-->
         <Sentence>
            SELECT CurBal AllAmt FROM tipsbjbal WHERE BrkNo='%s' AND RecDat='%s'
         </Sentence>
         <Fields>BrkNo|SelDat|</Fields>
      </DynSentence>

      <DynSentence name="UpdChkSts">                        <!--更新余额核对状态-->
         <Sentence>
            UPDATE tipsbjbal SET ChkSts='%s',BokBal='%s' WHERE BrkNo='%s' AND RecDat='%s'
         </Sentence>
         <Fields>ChkSts|TolAmt|BrkNo|SelDat|</Fields>
      </DynSentence>

      <DynSentence name="QryBrkNo">                         <!--遍历所有上线分行-->
         <Sentence>
            SELECT BrkNo FROM tipbrkinf
         </Sentence>
      </DynSentence>

      <DynSentence name="QryCBrkNo">                        <!--遍历所有关联行-->
         <Sentence>
            SELECT BrkNo FROM tipbrkinf WHERE RLtFlg='1'
         </Sentence>
      </DynSentence>

      <DynSentence name="QryTxnBok1">                       <!--读取 已清算记录-->
         <Sentence>
            SELECT * FROM tiptxnbok
            WHERE BilSts='1' AND RknSts='1' AND RknDat='%s' AND  (OBrkNo='%s' OR CBrkNo='%s' OR RBrkNo='%s') ORDER BY ActDat,TckNo
         </Sentence>
         <Fields>SelDat|BrkNo|BrkNo|BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="QryTxnBok2">                       <!--读取 未清算记录-->
         <Sentence>
            SELECT * FROM tiptxnbok
            WHERE BilSts='1' AND RknSts IN ('0','2') AND ActDat='%s' AND (OBrkNo='%s' OR CBrkNo='%s' OR RBrkNo='%s')  ORDER BY ActDat,TckNo
         </Sentence>
         <Fields>SelDat|BrkNo|BrkNo|BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="QryTtpRec">                        <!--读取 税种明细-->
         <Sentence>
            SELECT TaxTNm,TTPAmt,TaxBDt,TaxEDT,LmtDat FROM tipttprec WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>

      <DynSentence name="Head">                             <!--写行首 已清算-->
         <Sentence>ICD002  %s%sCNY</Sentence>
         <Fields>BrkNo|NodNo|</Fields>
      </DynSentence>

      <DynSentence name="Head3">                            <!--写行首 未清算-->
         <Sentence>ICD003  %s%sCNY</Sentence>
         <Fields>BrkNo|NodNo|</Fields>
      </DynSentence>

      <DynSentence name="Head2">                            <!--写行首 差错-->
         <Sentence>ICD004|%s|%s|CNY|</Sentence>
         <Fields>BrkNo|NodNo|</Fields>
      </DynSentence>

      <DynSentence name="TxnBok1">                          <!--写文件 已清算记录-->
         <Sentence>01%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n</Sentence>
         <Fields>OBrkNo|ActDat|TckNo|CBrkNo|OrgCod|EntDat|TraNo|SPckNo|CPayMod|CPayTyp|CBilSts|CRspSts|CChkSts|ChkDat|ChkOrd|RspDat|RBnkNo|RAccNo|ActNo|TxnAmt|RBrkNo|TaxVID|TCusID|TCusNm|AddWord|</Fields>
      </DynSentence>

      <DynSentence name="TxnBok2">                          <!--写文件 未清算记录-->
         <Sentence>01%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n</Sentence>
         <Fields>OBrkNo|ActDat|TckNo|CBrkNo|OrgCod|EntDat|TraNo|SPckNo|CPayMod|CPayTyp|CBilSts|CRspSts|RspDat|RBnkNo|RAccNo|ActNo|VchTyp|VchNo|TxnAmt|RBrkNo|TaxVID|TCusID|TCusNm|AddWord|</Fields>
      </DynSentence>

      <DynSentence name="TtpRec">                           <!--写文件 税种明细-->
         <Sentence>02%s%s%s%s%s\n</Sentence>
         <Fields>TaxTNm|TTPAmt|TaxBDt|TaxEDT|LmtDat|</Fields>
      </DynSentence>

      <DynSentence name="sql1">                             <!--对平-->
         <Sentence>
            UPDATE tiptxnjnl SET HLsChk='1'
            WHERE LogNo IN (SELECT tip.LogNo FROM tiphstjnl hst,tiptxnjnl tip WHERE hst.LogNo=tip.LogNo AND tip.HTxnSt='S') AND ActDat='%s'
         </Sentence>
         <Fields>ROOT.SelDat|</Fields>
      </DynSentence>

      <DynSentence name="sql2">                             <!--对平-->
         <Sentence>
            UPDATE tiphstjnl SET ChkFlg='1'
            WHERE LogNo IN (SELECT tip.LogNo FROM tiphstjnl hst,tiptxnjnl tip WHERE hst.LogNo=tip.LogNo AND tip.HTxnSt='S') AND ActDat='%s'
         </Sentence>
         <Fields>ROOT.SelDat|</Fields>
      </DynSentence>

      <DynSentence name="sql3">                             <!--前置多-->
         <Sentence>
            UPDATE tiptxnjnl SET HLsChk='2' WHERE  ActDat='%s' AND HLsChk='0' AND HTxnSt='S'
         </Sentence>
         <Fields>ROOT.SelDat|</Fields>
      </DynSentence>

      <DynSentence name="sql4">                             <!--主机多-->
         <Sentence>
            UPDATE tiphstjnl SET ChkFlg='2' WHERE  ActDat='%s' AND ChkFlg='0'
         </Sentence>
         <Fields>ROOT.SelDat|</Fields>
      </DynSentence>

      <DynSentence name="jnlrpt">                           <!--前置多账清单-->
         <Sentence>
            SELECT '财税库行' BusNam,CrpCod,NodNo,TckNo,LogNo,ActNo,TxnAmt,HLsChk ChkFlg
            FROM tiptxnjnl
            WHERE ActDat='%s' AND HLsChk='2' AND BrkNo='%s'
         </Sentence>
         <Fields>ROOT.SelDat|BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="hstrpt">                           <!--主机多账清单-->
         <Sentence>
            SELECT '财税库行' BusNam,CrpCod,NodNo,TckNo,LogNo,ActNo,TxnAmt,ChkFlg
            FROM tiphstjnl
            WHERE ActDat='%s' AND ChkFlg='2' AND BrkNo='%s'
         </Sentence>
         <Fields>ROOT.SelDat|BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="ChkErrRec">                        <!--对账 写文件-->
         <Sentence>01|%s|%s|%s|%s|%s|%s|%s|\n</Sentence>
         <Fields>BusNam|CrpCod|LogNo|TckNo|ActNo|TxnAmt|ChkFlg|</Fields>
      </DynSentence>

      <DynSentence name="ImHstRec">                           <!--保存历史记录-->
         <Sentence>
            INSERT INTO tipcnthst
            SELECT a.BrNo,'%s',a.LstYCnt,CAST(COALESCE(b.MthTol,0) AS CHAR(10)) MthTol
            FROM (SELECT BrNo,LstYCnt FROM tipcnthst WHERE HstDat='%s' ) a 
                 LEFT OUTER JOIN  
                 (SELECT BrkNo,COUNT(*) MthTol FROM tipcusagr WHERE Status='0' AND VrySts='1'  GROUP BY BrkNo ) b 
                 ON  a.BrNo = b.BrkNo
         </Sentence>
         <Fields>HstDat|LstDat|</Fields>
      </DynSentence>
      
      <DynSentence name="SelTxnBok">
         <Sentence>
            SELECT  * FROM tiptxnbok WHERE ActDat between '%s' and '%s'
         </Sentence>
         <Fields>BegDat|PrvDat|</Fields>
      </DynSentence>
                  
      <FlowCtrl>
         <Quote name="Init"/>
         <!--取文件-->
         <Set>SelDat=SUBSTR($BalFil,10,8)</Set>
         <Set>JnlFil=STRCAT(AGQGK999_,$SelDat,.dat)</Set>
         <Set>ObjDir=STRCAT(D1/TIP/,$SelDat)</Set>
         <Set>LclDir=dat/filesvr</Set>
         <Set>ObjFil=$JnlFil</Set>
         <!--ChDate在生成缴税通报表时使用-->
         <!--Set>ChDate=CALCDATE($SelDat,-,d,1)</Set-->
         <Set>ChDate=$SelDat</Set>
         <Set>RelDat=$ActDat</Set><!--保存ActDat-->

         <!--Modified By zhq_BoCom00038409_20080513-->
         <!--Exec func="PUB:FtpGet" error="IGNORE">
         <Arg name="FtpCfg" value="FtpGetIFSS"/>
         </Exec-->
         <System command="TipFetchFile.sh" error="IGNORE">         <!--获取文件-->
            <Arg name="SrcFile" value="STRCAT(/app/ade/data/,$ObjDir,/,$ObjFil)"></Arg>
            <Arg name="ObjFile" value="STRCAT(GETENV(WORKDIR),/,$LclDir,/,$ObjFil)"></Arg>
         </System>
         <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspMsg=从IFSS取文件失败</Set>
            <Exec func="PUB:PutResponse"/>
            <Return/>
         </If>

         <!--Modified By zhq_BoCom00038409_20080513-->
         <!--Exec func="PUB:FtpGet" error="IGNORE">
         <Arg name="FtpCfg" value="FtpGetIFSS"/>
         </Exec-->
         <Set>ObjFil=$BalFil</Set>
         <System command="TipFetchFile.sh" error="IGNORE">         <!--获取文件-->
            <Arg name="SrcFile" value="STRCAT(/app/ade/data/,$ObjDir,/,$ObjFil)"></Arg>
            <Arg name="ObjFile" value="STRCAT(GETENV(WORKDIR),/,$LclDir,/,$ObjFil)"></Arg>
         </System>
         <If condition="~RetCod!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspMsg=从IFSS取文件失败</Set>
            <Exec func="PUB:PutResponse"/>
            <Return/>
         </If>

         <Set>MsgTyp=N</Set>
         <Set>RspCod=000000</Set>
         <Exec func="PUB:PutResponse"/>
         <Exec func="PUB:IsValidFile">
            <Arg name="FileName" value="STRCAT(dat/filesvr/,$BalFil)"/>
         </Exec>
         <If condition="INTCMP($FilByt,3,0)">               <!--空文件-->
            <Goto>CheckHostJnl</Goto>
         </If>

         <!--核对2223科目余额-->
         <Set>BalFil=STRCAT(GETENV(WORKDIR),/dat/filesvr/,$BalFil)</Set>
         <Set>RecDat=$SelDat</Set>
         <Exec  func="PUB:ExecSql" error="IGNORE">          <!--清空余额表当日记录-->
            <Arg name="SqlCmd" value="ClrSbjBal"/>
         </Exec>
         <Exec func="PUB:CommitWork"/>
         <Exec func="PUB:ImportToDB">                       <!--导入数据库-->
            <Arg name="FormatName" value="BalFmt"/>
            <Arg name="FileName"   value="$BalFil"/>
            <Arg name="TableName"  value="tipsbjbal"/>
            <Arg name="ApplyLogNoFlag" value="0"/>
         </Exec>

         <Exec func="PUB:OpenCursor" error="IGNORE">        <!--遍历所有关联行-->
            <Arg name="SqlCmd" value="QryCBrkNo"/>
         </Exec>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod!=0">
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <ElseIf condition="~RetCod=-1">
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </ElseIf>
               <Else>
                  <Return/>
               </Else>
            </If>

            <Exec  func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="SUM"/>
            </Exec>

            <Exec  func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="GetAllAmt"/>
            </Exec>
            <If condition="~RetCod=-2">
               <Set>MsgTyp=N</Set>
               <Set>RspCod=000000</Set>
               <Continue/>
            </If>
            <If condition="INTCMP($AllAmt,3,$TolAmt)=0">    <!--核对金额不符，登记业务提示表-->
               <Set>ChkSts=2</Set>
               <Set>RecLvl=2</Set>
               <Set>Content=与主机核对内部账户余额不符</Set>
               <Quote name="BusNty"/>
            </If>
            <Else>
               <Set>ChkSts=1</Set>
            </Else>

            <Exec  func="PUB:ExecSql" error="IGNORE">       <!--更新余额核对状态-->
               <Arg name="SqlCmd" value="UpdChkSts"/>
            </Exec>
         </While>
         <Exec func="PUB:CloseCursor"/>

         <!--end  核对2223科目余额-->

         <!--与主机核对流水-->
         <Label>CheckHostJnl</Label>
         <Exec func="PUB:IsValidFile">
            <Arg name="FileName" value="STRCAT(dat/filesvr/,$JnlFil)"/>
         </Exec>
         <If condition="INTCMP($FilByt,3,0)=0">             <!--非空文件-->
            <Exec  func="PUB:ExecSql" error="IGNORE">       <!--清空主机当日流水-->
               <Arg name="SqlCmd" value="ClrJnl"/>
            </Exec>
            <Set>JnlFil=STRCAT(dat/filesvr/,$JnlFil)</Set>
            <Exec func="PUB:ImportToDB">
               <Arg name="FormatName" value="HstChkFil"/>
               <Arg name="FileName" value="$JnlFil"/>
               <Arg name="TableName" value="tiphstjnl"/>
               <Arg name="ApplyLogNoFlag" value="0"/>
            </Exec>
            <Exec  func="PUB:ExecSql" error="IGNORE">       <!--删除支付清算主机流水-->
               <Arg name="SqlCmd" value="DelRknJnl"/>
            </Exec>
            <Exec func="PUB:CommitWork"/>
         </If>

         <Set>UpdNum=1</Set>
         <While condition="$UpdNum&lt;5">
            <Set>UpdCmd=STRCAT(sql,$UpdNum)</Set>
            <Exec  func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="$UpdCmd"/>
            </Exec>
            <If condition="~RetCod!=0">
               <If condition="~RetCod=-2">
                  <Set>MsgTyp=N</Set>
                  <Set>RspCod=000000</Set>
               </If>
               <Else>
                  <Return/>
               </Else>
            </If>
            <Set>UpdNum=ADD($UpdNum,1)</Set>
         </While>
         <Exec func="PUB:CommitWork"/>
         <!--end 与主机核对流水-->

         <!--生成IFSS报表-->
         <Exec func="PUB:OpenCursor" error="IGNORE">        <!--遍历所有上线分行-->
            <Arg name="SqlCmd" value="QryBrkNo"/>
            <Arg name="CursorName" value="CURSOR_1"/>
         </Exec>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE">
               <Arg name="CursorName" value="CURSOR_1"/>
            </Exec>
            <If condition="~RetCod!=0">
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <ElseIf condition="~RetCod=-1">
                  <Exec func="PUB:CloseCursor">
                     <Arg name="CursorName" value="CURSOR_1"/>
                  </Exec>
                  <Return/>
               </ElseIf>
               <Else>
                  <Return/>
               </Else>
            </If>

            <!--生成缴税通报表开始-->
            <If condition="ISMONTHEND($ChDate)">
               <Set>StaDat=LEFTSTR($ChDate,6)</Set>
               <Set>Year=LEFTSTR($ChDate,4)</Set>
               <Set>ONodNo=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>

               <!--交通银行缴税通签约对公客户信息明细表-->
               <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,RD_ICM004)</Set>
               <Exec func="PUB:GenerateReport" error="IGNORE">
                  <Arg name="RptName" value="$FilName"/>
                  <Arg name="RptFile" value="STRCAT(etc/,TIP12_RPT.XML)"/>
                  <Arg name="Year"    value="$Year"/>
                  <Arg name="BrkNo"   value="$BrkNo"/>
                  <Arg name="ONodNo"  value="$ONodNo"/>
               </Exec>

            </If>
            <!--生成缴税通报表结束-->
            
            
            <!--以下生成已清算分行Ifss报表数据-->
            <Set>FilNam1=STRCAT(GETENV(WORKDIR),/,$IFSDir,RD_ICD002)</Set>
            <System command="" error="IGNORE">
               <Arg name="ObjFil" value="STRCAT(&gt;,$FilNam1)"/>
            </System>

            <Exec func="PUB:OpenCursor" error="IGNORE">     <!--读取 已清算记录-->
               <Arg name="SqlCmd" value="QryTxnBok1"/>
               <Arg name="CursorName" value="CURSOR_2"/>
            </Exec>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE">
                  <Arg name="CursorName" value="CURSOR_2"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <If condition="~RetCod=100">
                     <Break/>
                  </If>
                  <ElseIf condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_2"/>
                     </Exec>
                     <Return/>
                  </ElseIf>
                  <Else>
                     <Return/>
                  </Else>
               </If>

               <Set>NodNo=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
 
               <Exec func="PUB:WriteFile">                  <!--写 行首-->
                  <Arg name="FileName" value="$FilNam1"/>
                  <Arg name="Mode" value="a+"/>
                  <Arg name="PRNFMT" value="Head"/>
               </Exec>

               <!--数据域格式加工-->
               <Quote name="IFssRptFmt"/>
               <Exec func="PUB:WriteFile">                  <!--已清算记录 写文件-->
                  <Arg name="FileName" value="$FilNam1"/>
                  <Arg name="Mode" value="a+"/>
                  <Arg name="PRNFMT" value="TxnBok1"/>
               </Exec>

               <Exec func="PUB:OpenCursor" error="IGNORE">  <!--读取 税种明细-->
                  <Arg name="SqlCmd" value="QryTtpRec"/>
                  <Arg name="CursorName" value="CURSOR_3"/>
               </Exec>
               <While>
                  <Exec func="PUB:FetchCursor" error="IGNORE">
                     <Arg name="CursorName" value="CURSOR_3"/>
                  </Exec>
                  <If condition="~RetCod!=0">
                     <If condition="~RetCod=100">
                        <Break/>
                     </If>
                     <ElseIf condition="~RetCod=-1">
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_3"/>
                        </Exec>
                        <Return/>
                     </ElseIf>
                     <Else>
                        <Return/>
                     </Else>
                  </If>

                  <Quote name="IFssRptFmt2"/>
                  <Exec func="PUB:WriteFile">               <!--写 行首-->
                     <Arg name="FileName" value="$FilNam1"/>
                     <Arg name="Mode" value="a+"/>
                     <Arg name="PRNFMT" value="Head"/>
                  </Exec>

                  <Set>LmtDat=ADDCHAR($LmtDat,8, ,0)</Set>
                  <Exec func="PUB:WriteFile">               <!--税种明细 写文件-->
                     <Arg name="FileName" value="$FilNam1"/>
                     <Arg name="Mode" value="a+"/>
                     <Arg name="PRNFMT" value="TtpRec"/>
                  </Exec>
               </While>
               <Exec func="PUB:CloseCursor">
                  <Arg name="CursorName" value="CURSOR_3"/>
               </Exec>
            </While>
            <Exec func="PUB:CloseCursor">
               <Arg name="CursorName" value="CURSOR_2"/>
            </Exec>
            <!--end  生成已清算分行Ifss报表数据-->

            <!--以下生成未清算分行Ifss报表数据-->
            <Set>FilNam0=STRCAT(GETENV(WORKDIR),/,$IFSDir,RD_ICD003)</Set>
            <System command="" error="IGNORE">
               <Arg name="ObjFil" value="STRCAT(&gt;,$FilNam0)"/>
            </System>
            <Exec func="PUB:OpenCursor" error="IGNORE">     <!--读取 未清算记录-->
               <Arg name="SqlCmd" value="QryTxnBok2"/>
               <Arg name="CursorName" value="CURSOR_2"/>
            </Exec>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE">
                  <Arg name="CursorName" value="CURSOR_2"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <If condition="~RetCod=100">
                     <Break/>
                  </If>
                  <ElseIf condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_2"/>
                     </Exec>
                     <Return/>
                  </ElseIf>
                  <Else>
                     <Return/>
                  </Else>
               </If>

               <Set>NodNo=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
               <Exec func="PUB:WriteFile">                  <!--写 行首-->
                  <Arg name="FileName" value="$FilNam0"/>
                  <Arg name="Mode" value="a+"/>
                  <Arg name="PRNFMT" value="Head3"/>
               </Exec>
               <!--数据域格式加工-->
               <Quote name="IFssRptFmt"/>
               <Exec func="PUB:WriteFile">                  <!--未清算记录 写文件-->
                  <Arg name="FileName" value="$FilNam0"/>
                  <Arg name="Mode" value="a+"/>
                  <Arg name="PRNFMT" value="TxnBok2"/>
               </Exec>

               <Exec func="PUB:OpenCursor" error="IGNORE">  <!--读取 税种明细-->
                  <Arg name="SqlCmd" value="QryTtpRec"/>
                  <Arg name="CursorName" value="CURSOR_3"/>
               </Exec>
               <While>
                  <Exec func="PUB:FetchCursor" error="IGNORE">
                     <Arg name="CursorName" value="CURSOR_3"/>
                  </Exec>
                  <If condition="~RetCod!=0">
                     <If condition="~RetCod=100">
                        <Break/>
                     </If>
                     <ElseIf condition="~RetCod=-1">
                        <Exec func="PUB:CloseCursor">
                           <Arg name="CursorName" value="CURSOR_3"/>
                        </Exec>
                        <Return/>
                     </ElseIf>
                     <Else>
                        <Return/>
                     </Else>
                  </If>

                  <Quote name="IFssRptFmt2"/>
                  <Exec func="PUB:WriteFile">               <!--写 行首-->
                     <Arg name="FileName" value="$FilNam0"/>
                     <Arg name="Mode" value="a+"/>
                     <Arg name="PRNFMT" value="Head3"/>
                  </Exec>

                  <Set>LmtDat=ADDCHAR($LmtDat,8, ,0)</Set>
                  <Exec func="PUB:WriteFile">               <!--税种明细 写文件-->
                     <Arg name="FileName" value="$FilNam0"/>
                     <Arg name="Mode" value="a+"/>
                     <Arg name="PRNFMT" value="TtpRec"/>
                  </Exec>
               </While>
               <Exec func="PUB:CloseCursor">
                  <Arg name="CursorName" value="CURSOR_3"/>
               </Exec>
            </While>
            <Exec func="PUB:CloseCursor">
               <Arg name="CursorName" value="CURSOR_2"/>
            </Exec>
            <!--end 生成未清算分行Ifss报表数据-->

            <!--生成对账差错数据-->
            <Set>Fil2=STRCAT(GETENV(WORKDIR),/,$IFSDir,RD_ICD004)</Set><!--主机多-->
            <System command="" error="IGNORE">
               <Arg name="ObjFil" value="STRCAT(&gt;,$Fil2)"/>
            </System>

            <Exec func="PUB:OpenCursor" error="IGNORE">
               <Arg name="SqlCmd" value="hstrpt"/>
               <Arg name="CursorName" value="CURSOR_3"/>
            </Exec>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE">
                  <Arg name="CursorName" value="CURSOR_3"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <If condition="~RetCod=100">
                     <Break/>
                  </If>
                  <ElseIf condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_3"/>
                     </Exec>
                     <Return/>
                  </ElseIf>
                  <Else>
                     <Return/>
                  </Else>
               </If>

               <Set>TxnAmt=ADDCHAR(AMTSIMPLEFMT($TxnAmt),15,0,1)</Set>
               <Exec func="PUB:WriteFile">                  <!--写 行首-->
                  <Arg name="FileName" value="$Fil2"/>
                  <Arg name="Mode" value="a+"/>
                  <Arg name="PRNFMT" value="Head2"/>
               </Exec>
               <Exec func="PUB:WriteFile">                  <!--写文件 主机多-->
                  <Arg name="FileName" value="$Fil2"/>
                  <Arg name="Mode" value="a+"/>
                  <Arg name="PRNFMT" value="ChkErrRec"/>
               </Exec>
            </While>
            <Exec func="PUB:CloseCursor">
               <Arg name="CursorName" value="CURSOR_3"/>
            </Exec>

            <Set>Fil1=STRCAT(GETENV(WORKDIR),/,$IFSDir,TIPS,$BrkNo,$SelDat,FrtMore)</Set>  <!--前置多-->
            <System command="" error="IGNORE">
               <Arg name="ObjFil" value="STRCAT(&gt;,$Fil1)"/>
            </System>

            <Exec func="PUB:OpenCursor" error="IGNORE">
               <Arg name="SqlCmd" value="jnlrpt"/>
               <Arg name="CursorName" value="CURSOR_3"/>
            </Exec>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE">
                  <Arg name="CursorName" value="CURSOR_3"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <If condition="~RetCod=100">
                     <Break/>
                  </If>
                  <ElseIf condition="~RetCod=-1">
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_3"/>
                     </Exec>
                     <Return/>
                  </ElseIf>
                  <Else>
                     <Return/>
                  </Else>
               </If>

               <Set>TxnAmt=ADDCHAR(AMTSIMPLEFMT($TxnAmt),15,0,1)</Set>
               <Exec func="PUB:WriteFile">                  <!--写 行首-->
                  <Arg name="FileName" value="$Fil1"/>
                  <Arg name="Mode" value="a+"/>
                  <Arg name="PRNFMT" value="Head2"/>
               </Exec>
               <Exec func="PUB:WriteFile">                  <!--写文件 前置多-->
                  <Arg name="FileName" value="$Fil1"/>
                  <Arg name="Mode" value="a+"/>
                  <Arg name="PRNFMT" value="ChkErrRec"/>
               </Exec>
            </While>
            <Exec func="PUB:CloseCursor">
               <Arg name="CursorName" value="CURSOR_3"/>
            </Exec>

            <!--合并两个差错文件为一个对账差错文件-->
            <System command="cat" error="IGNORE">
               <Arg name="SrcFile" value="$Fil1"/>
               <Arg name="cat"     value="&gt;&gt;"/>
               <Arg name="ObjFil"  value="$Fil2"/>
            </System>

            <!--Exec func="PUB:AppendFileList" error="IGNORE"><未清算>
            <Arg name="FilNam" value="$FilNam0"/>
            </Exec>
            <Exec func="PUB:AppendFileList" error="IGNORE"><已清算>
            <Arg name="FilNam" value="$FilNam1"/>
            </Exec>
            <Exec func="PUB:AppendFileList" error="IGNORE"><对账差错>
            <Arg name="FilNam" value="$Fil2"/>
            </Exec>
            <System command="tar" error="IGNORE">
            <Arg name="Arg1" value="cvf"/>
            <Arg name="Arg2" value="STRCAT(IBSX_TIPS_,$SelDat,_,$BrkNo,tar)"/>
            <Arg name="Arg3" value="STRCAT($FilNam0, ,$FilNam1, ,$Fil2)"/>
            </System-->
            <System command="TipTar.sh" error="IGNORE">
               <Arg name="Arg1" value="$SelDat"/>
               <Arg name="Arg2" value="$BrkNo"/>
            </System>
            <!--Exec func="PUB:AppendFileList">
            <Arg name="FilNam" value="STRCAT(GETENV(WORKDIR),/dat/filesvr/,IBSX_TIPS_,$SelDat,_,$BrkNo,.tar.Z)"/>
            </Exec-->
            <!--一个分行处理结束 循环处理下个分行-->
         </While>

         <Exec func="PUB:CloseCursor">
            <Arg name="CursorName" value="CURSOR_1"/>
         </Exec>
         <!--end 生成IFSS报表-->

         <!--生成缴税通报表开始-->
         <If condition="ISMONTHEND($ChDate)">
            <Set>LstDat=LEFTSTR(CALCDATE($ChDate,-,m,1),6)</Set>
            <Set>StaDat=LEFTSTR($ChDate,6)</Set>
            <Set>Year=LEFTSTR($ChDate,4)</Set>
            <Set>BrkNo=315999</Set>
            <Set>ONodNo=315800</Set>
            <Set>HstDat=LEFTSTR($ChDate,6)</Set>
            <Set>BeDate=STRCAT($Year,0101)</Set>
            <Set>EdDate=$ChDate</Set>

                             
            <!--交通银行缴税通签约对公客户情况统计月报-->
            <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,RD_ICM001)</Set>
            <Exec func="PUB:GenerateReport" error="IGNORE">
               <Arg name="RptName" value="$FilName"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP09_RPT.XML)"/>
               <!--Arg name="StaDat"  value="$StaDat"/-->
               <Arg name="LstDat"  value="$LstDat"/>
               <Arg name="BrkNo"   value="$BrkNo"/>
               <Arg name="ONodNo"  value="$ONodNo"/>
            </Exec>

            <!--保存本月的记录数到历史表中-->
            <Exec  func="PUB:ExecSql" error="IGNORE">  
               <Arg name="SqlCmd" value="ImHstRec"/>
            </Exec> 

            <!--交通银行缴税通业务量统计月报-->
            <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,RD_ICM002)</Set>
            <Exec func="PUB:GenerateReport" error="IGNORE">
               <Arg name="RptName" value="$FilName"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP10_RPT.XML)"/>
               <Arg name="StaDat"  value="$StaDat"/>
               <!--Arg name="Year"    value="$Year"/-->
               <Arg name="BeDate"  value="$BeDate"/>
               <Arg name="EdDate"  value="$EdDate"/>
               <Arg name="LstDat"  value="$LstDat"/>
               <Arg name="BrkNo"   value="$BrkNo"/>
               <Arg name="ONodNo"  value="$ONodNo"/>
            </Exec>

            <!--交通银行缴税通签约对公大客户信息汇总表-->
            <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,RD_ICM003)</Set>
            <Exec func="PUB:GenerateReport" error="IGNORE">
               <Arg name="RptName" value="$FilName"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP11_RPT.XML)"/>
               <Arg name="Year"    value="$Year"/>
               <Arg name="ChDate"  value="$ChDate"/>
               <Arg name="BrkNo"   value="$BrkNo"/>
               <Arg name="ONodNo"  value="$ONodNo"/>
            </Exec>

            <System command="TipTar.sh" error="IGNORE">
               <Arg name="Arg1" value="$SelDat"/>
               <Arg name="Arg2" value="$BrkNo"/>
            </System>

         </If>
         
         <!--Added By zhq_BoCom00047053_20080903--> 
         <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,TIPS_,$SelDat,_JST01)</Set>
         <Exec func="PUB:GenerateReport" error="IGNORE">
            <Arg name="RptName" value="$FilName"/>
            <Arg name="RptFile" value="STRCAT(etc/,TIP13_RPT.XML)"/>
         </Exec> 
 
         <If condition="ISMONTHEND($ChDate)">
            <Set>HstDat=LEFTSTR($ChDate,6)</Set>
            <Set>LstDat=LEFTSTR(CALCDATE($ChDate,-,m,1),6)</Set>
            <Set>Year=LEFTSTR($ChDate,4)</Set>
            <Set>BeDate=STRCAT($Year,0101)</Set>
            <Set>EdDate=$ChDate</Set>
            <Set>StaDat=LEFTSTR($ChDate,6)</Set>
            
            <!--交通银行缴税通对公业务量统计月报-->
            <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,TIPS_,$SelDat,_JST02)</Set>
            <Exec func="PUB:GenerateReport" error="IGNORE">
               <Arg name="RptName" value="$FilName"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP14_RPT.XML)"/>
               <Arg name="StaDat"  value="$StaDat"/>
               <Arg name="BeDate"  value="$BeDate"/>
               <Arg name="EdDate"  value="$EdDate"/>
               <Arg name="LstDat"  value="$LstDat"/>
            </Exec>            

            <!--交通银行缴税通对私业务量统计月报-->
            <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,TIPS_,$SelDat,_JST03)</Set>
            <Exec func="PUB:GenerateReport" error="IGNORE">
               <Arg name="RptName" value="$FilName"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP15_RPT.XML)"/>
               <Arg name="StaDat"  value="$StaDat"/>
               <Arg name="BeDate"  value="$BeDate"/>
               <Arg name="EdDate"  value="$EdDate"/>
               <Arg name="LstDat"  value="$LstDat"/>
            </Exec>
            
            <!--交通银行缴税通签约对公大客户信息汇总表-->
            <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,TIPS_,$SelDat,_JST04)</Set>
            <Exec func="PUB:GenerateReport" error="IGNORE">
               <Arg name="RptName" value="$FilName"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP16_RPT.XML)"/>
               <Arg name="BeDate"  value="$BeDate"/>
               <Arg name="EdDate"  value="$EdDate"/>
            </Exec>            

            <!--交通银行缴税通签约客户信息明细表-->
            <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,TIPS_,$SelDat,_JST05)</Set>
            <Exec func="PUB:GenerateReport" error="IGNORE">
               <Arg name="RptName" value="$FilName"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP17_RPT.XML)"/>
               <Arg name="BeDate"  value="$BeDate"/>
               <Arg name="EdDate"  value="$EdDate"/>
            </Exec>            

            <!--全国上线征收机关统计表-->
            <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,TIPS_,$SelDat,_JST06)</Set>
            <Exec func="PUB:GenerateReport" error="IGNORE">
               <Arg name="RptName" value="$FilName"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP18_RPT.XML)"/>
               <Arg name="EdDate"  value="$EdDate"/>
            </Exec> 

            <!--与我行联网的征收机关统计表-->
            <Set>FilName=STRCAT(GETENV(WORKDIR),/,$IFSDir,TIPS_,$SelDat,_JST07)</Set>
            <Exec func="PUB:GenerateReport" error="IGNORE">
               <Arg name="RptName" value="$FilName"/>
               <Arg name="RptFile" value="STRCAT(etc/,TIP19_RPT.XML)"/>
               <Arg name="EdDate"  value="$EdDate"/>
            </Exec>          
         </If>  
   
         <!--导出tiptxnbok表数据生成文件-->
         <Set>FileName=STRCAT(GETENV(WORKDIR),/,$IFSDir,txnjst.del)</Set>
         <Set>PrvDat=$RelDat</Set> <!--Modified by sundx at 20090602 解决生产上晚两天送数据的问题-->
         <Set>BegDat=CALCDATE($RelDat,-,d,30)</Set>
         <Exec func="PUB:ExportFromDB" desc="生成下载的对账文件" >
            <Arg name="FormatName" value="EXPTIP"/>
            <Arg name="FileName" value="$FileName"/>
            <Arg name="TableName" value="tiptxnbok"/>
            <Arg name="SqlName" value="SelTxnBok"/>
         </Exec>
         
         <System command="TipTar.sh" error="IGNORE">
            <Arg name="Arg1" value="$SelDat"/>
         </System>
                    
         <System command="TipPutSvrFile.sh" error="IGNORE">         <!--上传文件-->
           <Arg name="LstFil" value="STRCAT(TIPS_JST_,$SelDat,.list)"></Arg>
           <Arg name="RptDat" value="$SelDat"></Arg>
           <Arg name="Flag"   value="1"></Arg>
         </System> 
                        
         <!--Modified By zhq_BoCom00034809_200580513-->
         <!--System command="TipPutSvrFtpFile.sh" error="IGNORE"--> <!--上传文件-->
         <!--Arg name="LstFil" value="STRCAT(TIPS_,$SelDat,.list)"></Arg>
         <Arg name="RptDat" value="$SelDat"></Arg>
         </System-->
         <System command="TipPutSvrFile.sh" error="IGNORE">         <!--上传文件-->
            <Arg name="LstFil" value="STRCAT(TIPS_,$SelDat,.list)"></Arg>
            <Arg name="RptDat" value="$SelDat"></Arg>
            <Arg name="Flag"   value="0"></Arg>
         </System>

         <System command="TipPutSvrFile.sh" error="IGNORE">         <!--上传txnjst.del文件-->
            <Arg name="LstFil" value="STRCAT(txnjst_,$PrvDat,.list)"></Arg>
            <Arg name="RptDat" value="$PrvDat"></Arg>
            <Arg name="Flag"   value="2"></Arg>
         </System>
      </FlowCtrl>
   </Transaction>

   <!--Modified By zhq_BoCom00045601_20080818-->
   <!--Modified By zhq_BoCom00050337_20081017-->
   <!--日切对账差错自动处理-->
   <Transaction code="915851">
      <!--Modified By zhq_BoCom00045601_20080818_由于实时抹帐和批量抹帐采用同样的逻辑处理，因此将他们的逻辑处理合并-->
      <!--检查系统交易登记簿中是否存在实时扣税的、交易状态为成功的、核对状态为核对失败人行少的、指定付款行、指定收款行的交易记录-->
      <!--DynSentence name="Online">
      <Sentence>
      SELECT RspDat,OrgCod,EntDat,TraNo,CBrkNo,TCusId
      FROM tiptxnbok
      WHERE (PayMod='0' AND BilSts='1' AND ChkSts='2' AND PBnkNo='%s' AND RBnkNo='%s' AND RspDat='%s') OR (PayMod='0' AND HTxnSt='T' AND Chksts='0' AND PBnkNo='%s' AND RBnkNo='%s' AND ActDat='%s')
      </Sentence>
      <Fields>PBnkNo|RBnkNo|ChkDat|PBnkNo|RBnkNo|ChkDat|</Fields>
      </DynSentence-->
      <!--Modified By zhq_BoCom00050337_20081017-->
      <!--DynSentence name="Online">
         <Sentence>
            SELECT RspDat,OrgCod,EntDat,TraNo,CBrkNo,TCusId,PayMod
            FROM tiptxnbok
            WHERE (PayMod &lt; '2' AND BilSts='1' AND ChkSts='2' AND PBnkNo='%s' AND RBnkNo='%s' AND RspDat='%s') OR (PayMod &lt; '2' AND HTxnSt='T' AND Chksts='0' AND PBnkNo='%s' AND RBnkNo='%s' AND ActDat='%s')
            FOR READ ONLY
         </Sentence>
      </DynSentence-->
      
      
      <DynSentence name="Online">
         <Sentence>
            SELECT RspDat,OrgCod,EntDat,TraNo,CBrkNo,TCusId,PayMod
            FROM tiptxnbok
            WHERE (PayMod &lt; '2' AND BilSts='1' AND ChkSts='2' AND PBnkNo='%s' AND RBnkNo='%s' AND RspDat='%s') OR (PayMod &lt; '2' AND HTxnSt='T' AND Chksts='0' AND PBnkNo='%s' AND RBnkNo='%s' AND ActDat='%s')
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|PBnkNo|RBnkNo|ChkDat|</Fields>
      </DynSentence>

      <DynSentence name="BnkSnd">
         <Sentence>
            SELECT RspDat, OrgCod,EntDat,TraNo,CBrkNo
            FROM tiptxnbok
            WHERE PayMod='2' AND BilSts='1' AND ChkSts='2' AND PBnkNo='%s' AND RBnkNo='%s' AND RspDat='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|</Fields>
      </DynSentence>

      <DynSentence name="QryFapAct">     <!--查是否是财政零余额账户-->
         <Sentence>
            SELECT * FROM tipfapact WHERE ActNo ='%s' FOR READ ONLY
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>

      <DynSentence name="Bat">
         <Sentence>
            SELECT RspDat,OrgCod,EntDat,TraNo,CBrkNo
            FROM tiptxnbok
            WHERE (PayMod='1' AND BilSts='1' AND ChkSts='2' AND PBnkNo='%s' AND RBnkNo='%s' AND RspDat='%s') OR (PayMod='1' AND HTxnSt='T' AND ChkSts='0' AND PBnkNo='%s' AND RBnkNo='%s' AND ActDat='%s')
         </Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|PBnkNo|RBnkNo|ChkDat|</Fields>
      </DynSentence>

      <DynSentence name="UpdTxnBok">     <!--冲正成功时，更新对账标示为成功-->
         <Sentence>
            UPDATE tiptxnbok SET BilSts='C',ChkSts='1' WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdTxnBok1">    <!--原交易不成功时，更新为失败-->
         <Sentence>
            UPDATE tiptxnbok SET BilSts='2' WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>

      <DynSentence name="QryTxnBok">
         <Sentence>
            SELECT TraNo,BilSts,HTxnSt,ActDat OActDt,ChkSts,LogNo,ChkSts,CBrkNo,ActNo,TxnAmt
            FROM tiptxnbok
            WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>

      <DynSentence name="QryTxnJnl">
         <Sentence>
            SELECT TTxnCd,BusTyp,CrpCod,ActNo,TxnAmt,HTxnCd,HLogNo,TckNo,TlrId,BrNo SBrNo,TrmNo
            FROM tiptxnJnl
            WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>

      <DynSentence name="QryTxnRec">
         <Sentence>
            SELECT OrgCod,EntDat,TraNo,BilSts,ChkSts,ActNo,TxnAmt,PayTyp,ActSqn,CBrkNo
            FROM tiptxnbok
            WHERE PayMod &lt; '2' and BilSts='1' and ChkSts='2' and PBnkNo='%s' and RBnkNo='%s' and RspDat='%s' and ActDat &lt; '%s' AND PayTyp !='0'
         </Sentence>
         <Fields>PBnkNo|RBnkNo|ChkDat|ActDat|</Fields>
      </DynSentence>

      <DynSentence name="UpdTxnBok2">   <!--更新账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET BilSts='%s',LogNo='%s'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>BilSts|LogNo|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>

      <Quote name="HangSQL"/>

      <Attributes>
         <Attribute name="nodatabase" value="2"/><!--全程数据库连接-->
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--实时扣税系统长款处理-->
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="BANKTAXTYPELIST3111"/>
         </Exec>
         <Exec func="PUB:DeleteGroup">
            <Arg name="GroupName" value="BANKCOMPARE3111"/>
         </Exec>

         <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="SqlCmd" value="Online"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Set>AddWord=数据库错误</Set>
            <Exec func="PUB:CloseCursor"/>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition ="~RetCod !=0">
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <Else>
                  <Set>RspCod=99003</Set>
                  <Set>AddWord=数据库错误</Set>
                  <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </Else>
            </If>

            <Exec  func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="QryTxnBok" />
            </Exec>

            <Exec  func="PUB:ReadRecord" error="IGNORE">     <!--财政余额帐户类型-->
               <Arg name="SqlCmd" value="QryFapAct" />
            </Exec>
            <If condition="~RetCod=0">                       <!--财政零余额帐户-->
               <Quote name="HangFapAct"/>
            </If>
            <ElseIf condition="~RetCod=-2 ">                 <!--不是财政余额帐户-->
               <If condition="IS_EQUAL_STRING($OActDt,$ActDat)">
				   <Exec  func="PUB:ReadRecord" error="IGNORE">  <!--取原流水-->
					  <Arg name="SqlCmd" value="QryTxnJnl" />
				   </Exec>
				   <If condition="~RetCod=-2">
					  <Continue/>
				   </If>
				   <Set>TIATyp=C</Set>
				   <Set>HTxnCd=STRCAT(SUBSTR($HTxnCd,1,5),9)</Set>
				   <Set>TTxnCd=$HTxnCd</Set>
				   <Exec func="PUB:CallHostOther" error="IGNORE">
					  <Arg name="HTxnCd" value="959999" />
					  <Arg name="ObjSvr" value="SHSTPUB1" />
				   </Exec>
				   <If condition="~RetCod!=0">
					  <If condition="OR(IS_EQUAL_STRING($HRspCd,SC6129),IS_EQUAL_STRING($HRspCd,SC6034),IS_EQUAL_STRING($HRspCd,AG8001),IS_EQUAL_STRING($HRspCd,AG8981))">
						 <Exec func="PUB:ExecSql">
							<Arg name="SqlCmd" value="UpdTxnBok1"/>
						 </Exec>
					  </If>
					  <Else>
						 <Set>BrkNo=$CBrkNo</Set>
						 <Set>RecLvl=1</Set>
						 <If condition="IS_EQUAL_STRING($PayMod,0)">
							<Set>Content=STRCAT(实时扣税日终差错自动处理  冲正失败,  征收机关代码,$OrgCod, 委托日期,$EntDat, 交易流水号,$TraNo)</Set>
						 </If>
						 <Else>
							<Set>Content=STRCAT(批量扣税日终差错自动处理  冲正失败,  征收机关代码,$OrgCod, 委托日期,$EntDat, 交易流水号,$TraNo)</Set>
						 </Else>
						 <Quote name="BusNty"/>
					  </Else>
					  <Continue/>
				   </If>
				   <Exec func="PUB:ExecSql">
					  <Arg name="SqlCmd" value="UpdTxnBok"/>
				   </Exec>
               </If>
               <Else>
                  <Continue/>
               </Else>
            </ElseIf>
            <Else>
               <Set>RspCod=99003</Set>
               <Set>AddWord=数据库错误</Set>
               <Return/>
            </Else>
         </While>
         <Exec func="PUB:CloseCursor"/>

         <!--处理行内多账的银行端缴款-->
         <!--银行缴款长款处理： 登记业务提示记录；-->
         <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="SqlCmd" value="BnkSnd"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Set>AddWord=数据库错误</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>AddWord=数据库错误</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <If condition="$RspDat=$ChkDat">
               <Set>BrkNo=$CBrkNo</Set>
               <Set>RecLvl=1</Set>
               <Set>Content=STRCAT(银行端缴款需重发扣税回执给人行, 征收机关代码,$OrgCod, 委托日期,$EntDat, 交易流水号,$TraNo)</Set>
               <Quote name="BusNty"/>
            </If>
         </While>
         <Exec func="PUB:CloseCursor"/>

         <!--Modified By zhq_BoCom00045601_20080818_批量扣税的抹帐处理被合并到实时扣税逻辑中一同处理-->
         <!--处理行内多账的批量扣税-->
         <!--Exec func="PUB:OpenCursor" error="IGNORE">
         <Arg name="SqlCmd" value="Bat"/>
         </Exec>
         <If condition="~RetCod=-1">
         <Set>RspCod=99003</Set>
         <Set>AddWord=数据库错误</Set>
         <Return/>
         </If>
         <While>
         <Exec func="PUB:FetchCursor" error="IGNORE"/>
         <If condition="~RetCod=100">
         <Break/>
         </If>
         <ElseIf condition="~RetCod=-1">
         <Set>RspCod=99003</Set>
         <Set>AddWord=数据库错误</Set>
         <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
         <Exec func="PUB:CloseCursor"/>
         <Return/>
         </ElseIf-->
         <!--循环上送主机抹账-->
         <!--Exec  func="PUB:ReadRecord" error="IGNORE">
         <Arg name="SqlCmd" value="QryTxnBok" />
         </Exec>
         <Exec  func="PUB:ReadRecord" error="IGNORE"--><!--财政余额帐户类型-->
         <!--Arg name="SqlCmd" value="QryFapAct" />
         </Exec>
         <If condition="~RetCod=0">
         <Quote name="HangFapAct"/>
         </If>
         <ElseIf condition="~RetCod=-2 "--><!--不是财政余额帐户-->
         <!--Exec  func="PUB:ReadRecord" error="IGNORE"--><!--取原流水-->
         <!--Arg name="SqlCmd" value="QryTxnJnl" />
         </Exec>
         <Set>TIATyp=C</Set>
         <Set>HTxnCd=STRCAT(SUBSTR($HTxnCd,1,5),9)</Set>
         <Set>TTxnCd=$HTxnCd</Set>
         <Exec func="PUB:CallHostOther" error="IGNORE">
         <Arg name="HTxnCd" value="959999" />
         <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>
         <If condition="~RetCod!=0">
         <If condition="OR(IS_EQUAL_STRING($HRspCd,SC6129),IS_EQUAL_STRING($HRspCd,SC6034),IS_EQUAL_STRING($HRspCd,AG8001),IS_EQUAL_STRING($HRspCd,AG8981))">
         <Exec func="PUB:ExecSql">
         <Arg name="SqlCmd" value="UpdTxnBok1"/>
         </Exec>
         </If>
         <Else>
         <Set>BrkNo=$CBrkNo</Set>
         <Set>RecLvl=1</Set>
         <Set>Content=STRCAT(批量扣税日终差错自动处理   冲正失败,  征收机关代码,$OrgCod, 委托日期,$EntDat, 交易流水号,$TraNo)</Set>
         <Quote name="BusNty"/>
         </Else>
         <Continue/>
         </If>
         <Exec func="PUB:ExecSql">
         <Arg name="SqlCmd" value="UpdTxnBok"/>
         </Exec>
         </ElseIf>
         </While>
         <Exec func="PUB:CloseCursor"/-->

         <!--自动冲帐-->
         <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="SqlCmd" value="QryTxnRec"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Set>AddWord=数据库错误</Set>
            <Return/>
         </If>
          
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition ="~RetCod !=0">
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <Else>
                  <Set>RspCod=99003</Set>
                  <Set>AddWord=数据库错误</Set>
                  <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </Else>
            </If>

            <Exec  func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="QryTxnBok" />
            </Exec>

            <Exec  func="PUB:ReadRecord" error="IGNORE">        <!--财政余额帐户类型-->
               <Arg name="SqlCmd" value="QryFapAct" />
            </Exec>
            <If condition="~RetCod !=-2">
               <If condition="~RetCod=0">                       <!--财政零余额帐户-->
                  <Quote name="HangFapAct"/>
               </If>
               <Else>
                  <Set>RspCod=99003</Set>
                  <Set>AddWord=数据库错误</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </Else>
            </If>
            <Else>
               <Exec  func="PUB:ReadRecord" error="IGNORE">  <!--取原流水-->
                  <Arg name="SqlCmd" value="QryTxnJnl" />
               </Exec>
               <If condition="~RetCod=-2">
                  <Continue/>
               </If>
               
               <!--登记主机流水表-->
               <Exec func="PUB:GetLogNo"/>
               <Set>TIATyp=T</Set>    <!--Added by sundx at 20081112 for cq50337-->
               <Set>HTxnCd=915890</Set>
               <Set>TTxnCd=915890</Set>
               <Set>FTxnTm=GETDATETIME()</Set>
               <Set>FRspCd=000000</Set>
               <Set>CcyCod=CNY</Set>
               <Set>ItgTyp=1</Set>
               <Set>TxnAtr= </Set>
               <Set>MstChk=1</Set>
               <Set>RecTyp=4</Set>
               <Exec func="PUB:InsertJournal"/>

               <!--向主机提交冲账交易-->
               <Set>ActNod=STRCAT(SUBSTR($SBrNo,1,3),800)</Set>
               <Set>Smr=财税关库行核对错账</Set>
               <Exec func="PUB:CallHostAcc" error="IGNORE">   <!--主机冲账-->
                  <Arg name="HTxnCd" value="$HTxnCd"/>         
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
               </Exec>
               <Set>BrkNo=$CBrkNo</Set>
               <Set>RecLvl=1</Set>
               <Set>Content=STRCAT(自动冲帐失败,|征收机关代码:,$OrgCod,|委托日期:,$EntDat,|交易流水号:,$TraNo,|帐号:,$ActNo,|交易金额:,$TxnAmt)</Set>
               <Switch expression="~RetCod">
                  <Case value="-10">                       <!--未发送-->
                     <Exec func="PUB:UpdateJournalHost">
                        <Arg name="TxnSts" value="X"/>
                     </Exec>
                     <Quote name="BusNty"/>
                     <Break/>
                  </Case>
                  <Case value="-2">                        <!--系统错误-->
                     <Exec func="PUB:UpdateJournalHost">
                        <Arg name="TxnSts" value="X"/>
                     </Exec>
                     <Quote name="BusNty"/>
                     <Break/>
                  </Case>
                  <Case value="-1">                        <!--交易超时-->
                     <Exec func="PUB:UpdateJournalHost">
                        <Arg name="TxnSts" value="T"/>
                     </Exec>
                     <Set>BilSts=T</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdTxnBok2"/>
                     </Exec>
                     <Quote name="BusNty"/>
                     <Break/>
                  </Case>
                  <Case value="-9">                        <!--交易需要授权-->
                     <Quote name="BusNty"/>
                     <Break/>
                  </Case>
                  <Case value="3">                         <!--交易失败-->
                     <Exec func="PUB:UpdateJournalHost">
                        <Arg name="TxnSts" value="F"/>
                     </Exec>
                     <Quote name="BusNty"/>
                     <Break/>
                  </Case>
                  <Case value="0">                         <!--交易成功-->
                     <Exec func="PUB:UpdateJournalHost">
                        <Arg name="TxnSts" value="S"/>
                     </Exec>
                     <Set>BilSts=6</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdTxnBok2"/>
                     </Exec>
                     <Break/>
                  </Case>
                  <Default>                                <!--其他情况-->
                     <Exec func="PUB:UpdateJournalHost">
                        <Arg name="TxnSts" value="F"/>
                     </Exec>
                     <Quote name="BusNty"/>
                     <Break/>
                  </Default>
               </Switch>
            </Else>
         </While>
         <Exec func="PUB:CloseCursor"/>
         
      </FlowCtrl>
   </Transaction>

   <!--日切启动-->
   <Transaction code="915202">
      <DynSentence name="QryCrcRec">
         <Sentence>
            select * from tiprvsbok where CnlSts='0'
         </Sentence>
      </DynSentence>
      <DynSentence name="QryTxnBok">
         <Sentence>
            select TraNo,BilSts,HTxnSt,ActDat OActDt,ChkSts,LogNo,ChkSts,CBrkNo,ActNo,TxnAmt from tiptxnbok
            where OrgCod='%s' and EntDat='%s' and TraNo='%s' and BilSts='1'
         </Sentence>
         <Fields>OOrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryFapAct"><!--判断是否为财政零余额帐户-->
         <Sentence>
            select * from tipfapact where ActNo ='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdCBrkNo">
         <Sentence>
            Update tiprvsbok Set CBrkNo='%s' where OOrgCod='%s' and OEntDat='%s' and OTraNo='%s'
         </Sentence>
         <Fields>CBrkNo|OOrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnJnl">
         <Sentence>
            select TTxnCd,BusTyp,CrpCod,ActNo,TxnAmt,HTxnCd,HLogNo,TckNo,TlrId from tiptxnJnl where LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">
         <Sentence>
            Update tiptxnbok Set BilSts='3' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OOrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdRvsBok">
         <Sentence>
            Update tiprvsbok Set CnlSts='%s' where OOrgCod='%s' and OEntDat='%s' and OTraNo='%s'
         </Sentence>
         <Fields>CnlSts|OOrgCod|OEntDat|OTraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnJnl">
         <Sentence>
            Update tiptxnjnl Set HTxnSt='%s',TxnSts='%s' where LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|TxnSts|LogNo|</Fields>
      </DynSentence>
      <DynSentence name="QryRspRec">
         <Sentence>
            select * from tiptxnbok where BilSts='1' and RspSts='0' and PayMod='2'
         </Sentence>
         <!--Fields>WrkDat|Status|</Fields-->
      </DynSentence>
      <DynSentence name="UpdRspSts">
         <Sentence>
            Update tiptxnbok Set RspSts='1' where OrgCod='%s' and EntDat='%s' and TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>

      <Quote name="HangSQL"/>

      <Attributes>
         <Attribute name="nodatabase" value="2"/><!--全程数据库连接-->
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--冲正处理-->
         <Exec func="PUB:OpenCursor" error="IGNORE"> <!--打开游标-->
            <Arg name="SqlCmd" value="QryCrcRec"/> <!--检查人行冲正登记簿中是否未处理的冲正登记簿记录-->
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Set>AddWord=数据库错误</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>AddWord=数据库错误</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Exec  func="PUB:ReadRecord" error="IGNORE"><!--按照征收机关代码、委托日期、交易流水号检索人行帐务交易登记簿记录是否存在-->
               <Arg name="SqlCmd" value="QryTxnBok" />
            </Exec>
            <If condition="~RetCod=-2">
               <Set>CnlSts=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRvsBok"/><!--不存在，修改冲正登记簿记录状态为无须抹账-->
               </Exec>
               <Continue/>
            </If>
            <!--///////检查记录状态，若记录状态不是交易成功，修改冲账登记簿状态为：冲正成功/////////////-->
            <If condition="$BilSts!=1">
               <Set>CnlSts=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRvsBok"/>
               </Exec>
               <Continue/>
            </If>
            <If condition="$ActDat!=$OActDt"><!--已隔日-->
               <Set>CnlSts=2</Set><!--需要冲账-->
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRvsBok"/>
               </Exec>
               <Return/>
            </If>
            <Set>BrkNo=$CBrkNo</Set>
            <Set>RecLvl=1</Set>
            <Set>Content=STRCAT(日切启动 未处理实时扣税冲正处理 会计日期已隔天,  征收机关代码,$OrgCod, 委托日期,$EntDat, 交易流水号,$TraNo)</Set>
            <Quote name="BusNty"/>    <!--登记业务提示记录表-->

            <Exec func="PUB:ExecSql">  <!--更新冲正登记簿的关联行号-->
               <Arg name="SqlCmd" value="UpdCBrkNo"/>
            </Exec>
            <Exec  func="PUB:ReadRecord" error="IGNORE"><!--查询是否财政零余额帐户类型-->
               <Arg name="SqlCmd" value="QryFapAct" />
            </Exec>
            <If condition="~RetCod=0">  <!--财政零余额帐户-->
               <Quote name="HangFapAct"/>
            </If>
            <ElseIf condition="~RetCod=-2 "><!--不是财政余额帐户-->
               <Exec  func="PUB:ReadRecord" error="IGNORE"><!--取原流水-->
                  <Arg name="SqlCmd" value="QryTxnJnl" />
               </Exec>
               <Set>TIATyp=C</Set>       <!--TIATYP为C则按前置流水号抹账，为T按主机的三要素抹账-->
               <Set>HTxnCd=STRCAT(SUBSTR($HTxnCd,1,5),9)</Set>
               <Set>TTxnCd=$HTxnCd</Set>
               <Exec func="PUB:CallHostOther" error="IGNORE">
                  <Arg name="HTxnCd" value="959999" />
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               <If condition="~RetCod=0">      <!--抹账成功-->
                  <Set>HTxnSt=C</Set>
                  <Set>TxnSts=C</Set>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnBok"/>
                  </Exec>
                  <Set>CnlSts=1</Set>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdRvsBok"/>
                  </Exec>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnJnl"/>
                  </Exec>
               </If>
               <ElseIf condition="~RetCod=3">
                  <Switch expression="$HRspCd">
                     <Case value="AG8001"/>       <!--该前置流水号不存在  -->
                     <Case value="AG8981"/>       <!--该前置流水号不存在  -->
                     <Case value="SC6129"/>       <!--原交易不存在        -->
                     <Case value="SC6034">        <!--原交易已经被抹 认为抹账成功-->
                        <Set>HTxnSt=C</Set>
                        <Set>TxnSts=C</Set>
                        <Exec func="PUB:ExecSql">
                           <Arg name="SqlCmd" value="UpdTxnBok"/>
                        </Exec>
                        <Set>CnlSts=1</Set>
                        <Exec func="PUB:ExecSql">
                           <Arg name="SqlCmd" value="UpdRvsBok"/>
                        </Exec>
                        <Exec func="PUB:ExecSql">
                           <Arg name="SqlCmd" value="UpdTxnJnl"/>
                        </Exec>
                        <Break/>
                     </Case>
                  </Switch>
               </ElseIf>
               <Else>
                  <!--抹账失败或超时，登记业务提示记录-->
                  <Set>RecNo=00000000</Set>
                  <Set>RecTim=$FTxnTm</Set>
                  <Set>BrkNo=331999</Set>
                  <Set>Content=冲正失败</Set>
                  <Set>RecLvl=2</Set>
                  <Exec func="PUB:InsertRecord">
                     <Arg name="TblNam" value="tipbusnty"/>
                  </Exec>
               </Else>
            </ElseIf>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <!--发送回执失败的银行端扣税处理-->
         <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="SqlCmd" value="QryRspRec"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Set>AddWord=数据库错误</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>AddWord=数据库错误</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Quote name="GetSeq"/>
            <Set>MsgRef=$MsgId</Set>

            <Exec func="PUB:CallThirdOther">
               <Arg name="HTxnCd" value="2108"/>
               <Arg name="ObjSvr" value="MMQMTIP1"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
            </Exec>
         </While>
         <Exec func="PUB:CloseCursor"/>
         <!--回执未确认的批扣记录处理-->

         <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="SqlCmd" value="QryRspRec"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Set>AddWord=数据库错误</Set>
            <Return/>
         </If>
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Set>RspCod=99003</Set>
               <Set>AddWord=数据库错误</Set>
               <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
               <Exec func="PUB:CloseCursor"/>
               <Return/>
            </ElseIf>
            <Quote name="GetSeq"/>
            <Set>MsgRef=$MsgId</Set>

            <Exec func="PUB:CallThirdOther">
               <Arg name="HTxnCd" value="9003"/>
               <Arg name="ObjSvr" value="MMQMTIP1"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
            </Exec>
         </While>
         <Exec func="PUB:CloseCursor"/>
      </FlowCtrl>
   </Transaction>
   <!--Added by sundx at 20081201 for cq52077 批量触发 定时自动清算-->
   <!--Added by zhangy at 20090210 for cq59401 查询大额支付是否为工作日-->
   <Transaction code="915842">
      <DynSentence name="QryWrkDat"> <!--查找人行上一工作日期-->
         <Sentence>
            SELECT PrevDt FROM　tipsyssts
         </Sentence>
      </DynSentence>
      <DynSentence name="QryChkInf"> <!--查找上一日日切对账平未清算的收付款行号、对账日期、对账批次-->
         <Sentence>
            SELECT RBnkNo,PBnkNo,ChkDat,ChkOrd,ChkSts,RknSts,AllAmt,AllNum FROM　tipchkbok WHERE ChkDat='%s' AND ChkMod='1' AND ChkSts='1' and RknSts='0' FOR READ ONLY
         </Sentence>
         <Fields>PrevDt</Fields>
      </DynSentence>
      <DynSentence name="UpdChkBok"><!--更新对账登记簿中的对账状态 清算状态-->
         <Sentence>
            UPDATE tipchkbok SET ChkSts='%s',RknSts='%s' WHERE PBnkNo='%s' AND RBnkNo='%s' AND ChkDat='%s' AND ChkOrd='%s'
         </Sentence>
         <Fields>ChkSts|RknSts|PBnkNo|RBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>      
      <Attributes>
         <Attribute name="nodatabase" value="2"/>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--CQ59401 调用总行营业部352950查询大额支付工作日期-->        
         <Set>BrkNo=310999</Set> <!--Modified by sundx 原315999网络不通，故调用310999接口-->
         <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"></Arg>
            <Arg name="SourNam" value="BrkNo"></Arg>
            <Arg name="DestNam" value="SRN"></Arg>
            <Arg name="TblNam" value="Cod2SRN"></Arg>
         </Exec>
         <Set>@MSG.SRN=$SRN</Set>         
         <Exec func="PUB:CallLocal" error="IGNORE">
            <Arg name="TxnCod" value="352950" />
            <Arg name="ObjSvr" value="OFRTPMS2"/>
         </Exec>
         <Delete>@MSG.SRN</Delete>
         <If condition="IS_NOEQUAL_STRING($Tactdt,$ActDat)">
            <Set>RspCod=91699</Set>
            <Set>RspMsg=非大额支付工作日</Set>
            <Return/>
         </If>                   
         <Set>CrpCod=000000</Set>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="QryWrkDat" />
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=91699</Set>
            <Set>RspMsg=取前一日人行工作日期失败</Set>
            <Return/>
         </If>  
         <Exec func="PUB:OpenCursor" error="IGNORE">
            <Arg name="SqlCmd" value="QryChkInf"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Set>RspCod=99003</Set>
            <Set>AddWord=数据库错误</Set>
            <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>           
            <Return/>
         </If>       
         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/>
            <If condition ="~RetCod !=0">
               <If condition="~RetCod=100">
                  <Break/>
               </If>
               <Else>
                  <Set>RspCod=99003</Set>
                  <Set>AddWord=数据库错误</Set>
                  <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
                  <Exec func="PUB:CloseCursor"/>
                  <Return/>
               </Else>
            </If>
            <If condition="INTCMP($AllAmt,3,0)=1"><!--清算金额为零-->
               <Set>RspCod=90000</Set>
               <Set>ChkSts=1</Set>
               <Set>RknSts=1</Set>
               <Exec func="PUB:ExecSql" error="IGNORE">
                  <Arg name="SqlCmd" value="UpdChkBok"/>
               </Exec>
               <Continue/>
            </If>                        
            <Exec func="PUB:CallLocal" error="IGNORE">
               <Arg name="TxnCod"  value="915843"/>
               <Arg name="ObjSvr"  value="OFRTTIP4"/>
               <Arg name="GetFlg"  value="1"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Continue/>
            </If>
         </While>
         <Exec func="PUB:CloseCursor"/>
      </FlowCtrl>
   </Transaction>
   <!--Added by sundx at 20081205 for cq52077 自动清算处理-->
   <Transaction code="915843">
      <DynSentence name="QryBrkInf"><!--根据付款清算行号取清算参数-->
         <Sentence>
            SELECT BrkNo,SndAct,ActSqn,SndAct,SndNam,DBrkNo FROM tipbrkinf WHERE PBnkNo='%s' and RknFlg='1'
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetCrBkNo"><!--由清算国库的支付行号取得 清算类型 批扣类型 协议检查标志 电子回单标志 关联行号(入账分行)-->
         <Sentence>
            SELECT RAccNo RcvNo,RAccNm RcvNam,RknTyp,BatTyp,PChkFg,BCrtFg,BrkNo CBrkNo,TRptTyp,TBusTyp FROM tiptrerkn WHERE RBnkNo='%s' 
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <Quote name="ChkRknUpdSQL"/>          <!--对账清算公共更新SQL-->      
      <Attributes>
         <Attribute name="nodatabase" value="2"/>
      </Attributes>
      <FlowCtrl>        
         <Quote name="Init"/> 
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="QryBrkInf" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=取不到上线行信息</Set>
            <Set>ChkSts=1</Set>
            <Set>RknSts=2</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetCrBkNo" />
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=取不到清算国库信息</Set>
            <Set>ChkSts=1</Set>
            <Set>RknSts=2</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdChkBok"/>
            </Exec>
            <Return/>            
         </If>
               
         <Set>CnlSub=$BrkNo</Set>
         <Exec func="PUB:GetVirtualTeller"/>
         <Set>Smr=STRCAT(税款入库 对账日期,$ChkDat, 对账批次,$ChkOrd, 对账笔数,$AllNum)</Set>
         <If condition="$RknTyp=0"><!--大额支付-->
            <Quote name="Pms"/>
         </If>
         <ElseIf condition="$RknTyp=2"><!--挂账-->
            <Delete>$CclNo</Delete>
            <Quote name="HangAcc"/>
         </ElseIf>
         <ElseIf condition="$RknTyp=1"><!--小额支付-->
            <Return/>
         </ElseIf>
         <Exec func="PUB:CommitWork"/>
      </FlowCtrl>
   </Transaction>

</Application>
