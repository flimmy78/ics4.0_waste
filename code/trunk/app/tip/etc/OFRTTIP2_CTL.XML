<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="TIP" code="037">
   <!--
   Modified by zhq_BoCom00031148_20080128_915132(验证结果查询)和915110(记录验证结果)
   Modified by xiehongbo_BoCom00031149_20080317_915170(增加打印税票的查询条件)
   Modified by zhq_BoCom00035572_20080402_915195_解决首打无法正常打印税单
   Modified By zhq_BoCom00032769_20080407_915810_增加内部帐户转帐功能
   Modified by zhq_BoCom00036694_20080415_915170_增加对多种税票的排序
   Added By Zhq_BoCom00032769_20080430_918719(查询内部账户名称)
   Modified By Zhq_BoCom00041319_20080707_(915110,918830)(当签订三方协议的时间和验证的时间不相同时,会导致在打印缴税通报表时统计数据不全。
   Modified By Zy_BoCom00043457_20080729_(915120,915190)(解约时更新验证状态为失败)
   Modified By Zhq_BoCom00044952_20080731_(915120,915190)(删除三方协议后,重新设置请求类型(TIATyp＝T)和授权级别(AthLvl＝00))
   Modified By Zhq_BoCom00043458_20080801_
      915170:由于交易915170和915175画面合并，因此不再判断是重打还是首打，同时将原来打印在电子缴税付款凭证上的清算国库名称改为具体国库名称，并打印打印次数。
      915195:由于交易915195和915196画面合并，因此不再判断是重打还是首打，同时将原来打印在电子缴税付款凭证上的清算国库名称改为具体国库名称，并打印打印次数。
      915827:将原来打印的'收款国库(银行)名称'的内容由收款人帐户名称改为具体的国库名称。
      915810:根据第三方返回的国库代码查询国库名称。
      915920:根据国库代码获取国库名称。
      915910:根据国库代码获取国库名称。
      915187:将查询清算行名称改为查询具体的国库名称。
   Modified By zhq_BoCom00045601_20080820_915899_添加自动冲帐对应的抹帐交易
   Modified By zhq_BoCom00047053_20080902
      915120_三方协议签约时,置验证日期为空,保存签约日期
      915190_三方协议签约时,置验证日期为空,保存签约日期
      915110_当三方协议被验证成功的时候,更新验证日期
      918830_当三方协议被验证成功的时候,更新验证日期
   Modified By zhq_BoCom00050337_20081017_
      同BoCom00043458(将原来获取国库名称的字段由TreNam改为RaccNm)
      915110_当验证已经验证成功的协议的时候，返回验证成功。
   Modified By zy_BoCom00054579_20081212
   	  修改915110，验证账户合法性时，SC6002 返回电子柜员不存在
   Modified by sundx at 20090105 for cq46255，43458新增对私税票打印查询交易915199
   Modified by sundx at 20090330 for cq61739,修改915110交易，以“征收机关代码”和“协议编号”组合作为第一校验字段
   Modified by sundx at 20090414 for cq64047,修改915910，915920，918716交易，使单位卡也能完成缴税功能
   Modified by sundx at 20090510 for cq64047,修改915910，915920，918716交易，使单位准贷记卡不能完成缴税功能
   Modified by sundx at 20090518 for cq67956,新增915161，915162交易，新增国库财政支出转发交易
   Modified by liuyong at 20090618 for cq73472,修改915820，915810交易，修改国库财政余额交易，增加判断条件，如果不是蕴通账户，直接返回
   modified by sundx at 20090715 for cq76417 修改915110交易，国库v2.1 财政收入业务错误码细分
   Modified by ly at 20090715 for cq73476 修改915920,915190交易,对非正常状态下的单位借记卡进行缴税时，交易应拒绝.不允许单位准贷记卡以及非第一单位借记卡签约
   modified by sundx at 20090710 for cq76186 修改915840,915847,915849,915860,915867,915869,915950,915957
   Modified by zhb at 2009-7-24 for cq67554 缴税通 新增交易缴税通历史查询多笔915813 明细195814 ，导出TIPS基础数据给网银915815     
   Modified by sundx at 20090929 for cq84414 修改交易915170，新增前台打印方式
	  -->
   <BusDefDeclare>
      <Busdef name="SrcNod" value="601100000010"></Busdef>
      <Busdef name="DstNod" value="100000000000"></Busdef>
   </BusDefDeclare>

   <LibDeclare>
      <Library name="BEP9" value="dll/bep9.so"/>
      <Library name="TIP" value="dll/tip.so"/>
      <Library name="TIPQRY" value="dll/tipquery.so"/>
   </LibDeclare>

   <ConfigDeclare>
      <Config name="TIPCSW"          value="etc/TIP_CSW.XML"/>
   </ConfigDeclare>

   <TableDeclare>
      <Table name="tipsyssts"   value="tipsyssts"/> <!--国库系统状态表-->
      <Table name="tipnodinf"   value="tipnodinf"/> <!--国库节点表-->
      <Table name="tiptreinf"   value="tiptreinf"/> <!--国库信息表-->
      <Table name="tiporginf"   value="tiporginf"/> <!--国库征收机关表-->
      <Table name="tiprgnbrk"   value="tiprgnbrk"/> <!--国库地区代码分行对照表-->
      <Table name="tiptrerkn"   value="tiptrerkn"/> <!--国库清算行-->
      <Table name="tipbrkinf"   value="tipbrkinf"/> <!--国库已上线分行表-->
      <Table name="tipcusagr"   value="tipcusagr"/> <!--国库纳税人三方协议表-->
      <Table name="tiptxnbok"   value="tiptxnbok"/> <!--国库人行帐务交易登记簿-->
      <Table name="tiptxnjnl"   value="tiptxnjnl"/> <!--国库主机交易流水表-->
      <Table name="tipttprec"   value="tipttprec"/> <!--国库税种明细表-->
      <Table name="tiptaxrec"   value="tiptaxrec"/> <!--国库税目明细表-->
      <Table name="tipbatbok"   value="tipbatbok"/> <!--国库人行批量交易包登记簿-->
      <Table name="tiprvsbok"   value="tiprvsbok"/> <!--国库人行冲正交易登记簿-->
      <Table name="tipstpbok"   value="tipstpbok"/> <!--国库人行止付交易登记簿-->
      <Table name="tipchkbok"   value="tipchkbok"/> <!--国库人行对账包登记簿-->
      <Table name="tippkgrec"   value="tippkgrec"/> <!--国库人行子包明细表-->
      <Table name="tipchkrec"   value="tipchkrec"/> <!--国库人行对账明细表-->
      <Table name="tipfmgrec"   value="tipfmgrec"/> <!--国库自由报文明细表-->
      <Table name="tipsbjbal"   value="tipsbjbal"/> <!--国库主机科目余额临时表-->
      <Table name="tipbusnty"   value="tipbusnty"/> <!--国库业务提示记录表-->
      <Table name="tipbatchk"   value="tipbatchk"/> <!--国库人行批量包对账表-->
      <Table name="tiptaxtyp"   value="tiptaxtyp"/> <!--国库税种表-->
      <Table name="tiptaxsbj"   value="tiptaxsbj"/> <!--国库税目表-->
      <Table name="tipfapact"   value="tipfapact"/> <!--财政零余额账户表-->
      <Table name="tipvryjnl"   value="tipvryjnl"/> <!--协议验证结果表-->
   </TableDeclare>

   <Define>
      <Macro name="GetBrkSQL">  <!--根据地区号取分行号SQL语句-->
         <DynSentence name="GetBrkNo">   <!--根据地区号取分行号-->
            <Sentence>
               SELECT BrkNo
               FROM tiprgnbrk
               WHERE Rgn='%s'
               FOR READ ONLY
            </Sentence>
            <Fields>Rgn|</Fields>
         </DynSentence>
      </Macro>


      <Macro name="GetBrkCTL">  <!--根据网点号取分行号-->
         <Set>Rgn=SUBSTR($NodNo,1,3)</Set>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkNo"/>
         </Exec>
         <Set>BrNo=$BrkNo</Set>
      </Macro>


      <Macro name="ChkOrgNodSQL">  <!--根据征收机关代码检查征收机关和对应节点状态的SQL语句-->
         <DynSentence name="ChkOrgCod">   <!--检查征收机关代码-->
            <Sentence>
               SELECT EffDat,NodCod
               FROM tiporginf
               WHERE OrgCod='%s'
               FOR READ ONLY
            </Sentence>
            <Fields>OrgCod|</Fields>
         </DynSentence>
         <DynSentence name="ChkNodCod">   <!--检查征收机关对应的节点代码-->
            <Sentence>
               SELECT Status,EffDat
               FROM tipnodinf
               WHERE NodCod='%s'
               AND NodTyp='1'
               FOR READ ONLY
            </Sentence>
            <Fields>NodCod|</Fields>
         </DynSentence>
      </Macro>


      <Macro name="ChkOrgNodCTL">  <!--根据征收机关代码检查征收机关和对应节点状态的流程-->
         <Exec func="PUB:ReadRecord" error="IGNORE">   <!--检查征收机关-->
            <Arg name="SqlCmd" value="ChkOrgCod"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910212</Set>
            <Return/>
         </If>
         <ElseIf condition="~RetCod=0">
            <If condition="INTCMP($ActDat,1,$EffDat)">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910611</Set>
               <Return/>
            </If>
         </ElseIf>
         <Else>
            <Return/>
         </Else>
         <Exec func="PUB:ReadRecord" error="IGNORE">   <!--检查节点状态-->
            <Arg name="SqlCmd" value="ChkNodCod"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910214</Set>
            <Return/>
         </If>
         <ElseIf condition="~RetCod=0">
            <If condition="INTCMP($ActDat,1,$EffDat)">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910215</Set>
               <Return/>
            </If>
         </ElseIf>
         <Else>
            <Return/>
         </Else>
      </Macro>


      <Macro name="ChkNodNo">  <!--检查网点是否国库关联行帐务中心-->
         <If condition="IS_NOEQUAL_STRING(STRCAT(SUBSTR($BrkNo,1,3),800),$NodNo)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心，拒绝交易</Set>
            <Return/>
         </If>
      </Macro>


      <Macro name="GetSeq"><!--取序号-->
         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="TIP:MsgId"/>
            <Arg name="SeqCnd" value="MsgId"/>
            <Arg name="Len" value="10"/>
         </Exec>
         <Set>MsgId=STRCAT(0000000000,$SelVal)</Set>
      </Macro>


      <Macro name="BusNty"><!--登记业务提示表-->
         <Set>RecTim=GETDATETIME(HHMISS)</Set>
         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="tipbusnty:RecNo"/>
            <Arg name="SeqCnd" value="RecNo"/>
            <Arg name="Len" value="8"/>
         </Exec>
         <Set>RecNo=$SelVal</Set>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tipbusnty"/>
         </Exec>
      </Macro>

      <Macro name="Init">
         <Set>BrNo=999001</Set>
         <Exec func="PUB:InitTransaction"/>
      </Macro>

      <!--Macro name="ChkTipSts">
      <Exec func="PUB:ReadRecord" error="IGNORE">
      <Arg name="SqlCmd" value="$Sentence"/>
      </Exec>
      <If condition="~RetCod!=0">
      <If condition="~RetCod=-2">
      <Set>RspCod=$RCode</Set>
      <Set>MsgTyp=E</Set>
      <Set>RspMsg=$RetMsg</Set>
      <Return/>
      </If>
      <Else>
      <Set>RspCod=478706</Set>
      <Set>MsgTyp=E</Set>
      <Set>RspMsg=系统错误</Set>
      <Return/>
      </Else>
      </If>
      </Macro-->

      <Macro name="InsTipSts" > <!--记录验证结果-->
         <Set>VryInfo=STRCAT($VrySts,:,$RspMsg)</Set>
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="InsVrySts"/>
         </Exec>
      </Macro>

      <!--获取国库名称--> 
      <!--Macro name="GetTreNamSql" >  
         <DynSentence name="GetTreNam">
            <Sentence>
               SELECT TreNam RaccNm FROM tiptreinf WHERE TreCod='%s' FOR READ ONLY
            </Sentence>
            <Fields>TreCod|</Fields>
         </DynSentence>
      </Macro-->

      <!--Macro name="FetchTreNam" >
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTreNam"/>
         </Exec>
      </Macro-->
   </Define>



   <Transaction code="915811" desc="银行申报查询">
      <DynSentence name="ChkStatus">   <!--检查系统状态-->
         <Sentence>
            SELECT Status,WorkDt WrkDat
            FROM tipsyssts
            FOR READ ONLY
         </Sentence>
         <Fields></Fields>
      </DynSentence>
      <DynSentence name="GetPBnkNo">   <!--查询付款行号-->
         <Sentence>
            SELECT PBnkNo
            FROM tipbrkinf
            WHERE BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <Quote name="ChkOrgNodSQL"/>  <!--根据征收机关代码检查征收机关和对应节点状态的SQL语句-->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查系统状态-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStatus"/>
         </Exec>
         <If condition="AND(IS_NOEQUAL_STRING($Status,0),IS_NOEQUAL_STRING($Status,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910601</Set>
            <Return/>
         </If>

         <Quote name="ChkOrgNodCTL"/>  <!--根据征收机关代码检查征收机关和对应节点状态的流程-->
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->

         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>

         <!--银行申报查询请求-->
         <Set>BrNo=$SBrNo</Set>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Set>TxnTm=GETDATETIME(HHMISS)</Set><!--解决业务受理通知书打印时间为0的问题-->

         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="TIPQryNo"/>
            <Arg name="Len" value="8"/>
         </Exec>
         <Set>QryNo=$SelVal</Set>

         <Exec func="PUB:CallThirdOther">
            <Arg name="HTxnCd" value="2091"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="$TRspCd=999999">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>
         <If condition="$Result!=90000">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910612</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>

         <Set>TTpCnt=1</Set>
         <While condition="INTCMP($TTpCnt,2,$TTpNm)">
            <Exec func="PUB:GetValue">
               <Arg name="SourName"  value="STRCAT(ROOT.TaxTypLst1009_,$TTpCnt,.DtlNum)"/>
               <Arg name="DestName"  value="ROOT.RDtlNum"/>
            </Exec>

            <Set>SbjCnt=1</Set>
            <While condition="INTCMP($SbjCnt,2,$RDtlNum)">
               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.TaxTypLst1009_,$TTpCnt,.TaxSbjLst1009_,$SbjCnt,.FTxAmt)"/>
                  <Arg name="DestName"  value="ROOT.RFTxAmt"/>
               </Exec>

               <Set>RFTxAmt=$RFTxAmt</Set>
               <Set>RTTpAmt=ADD($RTTpAmt,$RFTxAmt)</Set>

               <If condition="IS_EQUAL_INT($SbjCnt,$RDtlNum)">
                  <Set>RTTpAmt=ADDCHAR(DELBOTHSPACE(DELCHAR($RTTpAmt,46)),15,0,1)</Set>
                  <Exec func="PUB:SetValue">
                     <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1009_,$TTpCnt,.TTpAmt)"/>
                     <Arg name="FieldValue" value="$RTTpAmt"/>
                  </Exec>
               </If>

               <Set>SbjCnt=ADD($SbjCnt,1)</Set>
            </While>

            <Set>RTTpAmt=0</Set>
            <Set>TTpCnt=ADD($TTpCnt,1)</Set>
         </While>
      </FlowCtrl>
   </Transaction>


   <!--Modified By zhq_BoCom00032769_20080407-->
   <!--Modified By zhq_BoCom00043458_20080804-->
   <Transaction code="915810" desc="银行申报">

      <DynSentence name="ChkStatus">              <!--检查系统状态-->
         <Sentence>
            SELECT Status,WorkDt WrkDat
            FROM tipsyssts
            FOR READ ONLY
         </Sentence>
         <Fields></Fields>
      </DynSentence>

      <!--DynSentence name="ChkOrgCod"-->         <!--检查征收机关是否已存在-->
      <!--Sentence>
      SELECT EffDat
      FROM tiporginf
      WHERE OrgCod='%s'
      </Sentence>
      <Fields>OrgCod|</Fields>
      </DynSentence-->
      <DynSentence name="GetPBnkNo">              <!--查询清算行支付系统行号-->
         <Sentence>
            SELECT PBnkNo,BrkNam BrkNm
            FROM tipbrkinf
            WHERE BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetOrgNam">              <!--查询征收机关名称-->
         <Sentence>
            SELECT OrgNam
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="GetBrkNam">              <!--查询付款人开户行名称-->
         <Sentence>
            SELECT OrgNam BrkNam
            FROM cimorgtbl
            WHERE OrgNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>ONodNo|</Fields>
      </DynSentence>

      <DynSentence name="ChkTaxVID">              <!--检查税票号是否已缴纳过-->
         <Sentence>
            SELECT OrgCod
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND TaxVID='%s'
            AND BilSts IN ('1','9')
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|TaxVID|</Fields>
      </DynSentence>

      <DynSentence name="GetCBrkNo">              <!--查询关联分行号-->
         <Sentence>
            SELECT BrkNo CBrkNo
            FROM tiptrerkn
            WHERE RBnkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetRBrkNo">              <!--查询清算行行号和暂收科目顺序号-->
         <Sentence>
            SELECT BrkNo RBrkNo,ActSqn
            FROM tipbrkinf
            WHERE PBnkNo='%s'
            AND RknFlg='1'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdTxnBok">              <!--根据前置流水号更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='%s',BilSts='%s',TckNo='%s',AddWord='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|BilSts|TckNo|AddWord|LogNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdRspSts">              <!--根据前置流水号更新人行账务登记薄中的回执状态-->
         <Sentence>
            UPDATE tiptxnbok
            SET RspSts='%s',RspDat='%s',RspNum='1'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>RspSts|WrkDat|LogNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdPrtNum">              <!--更新打印次数 首次打印-->
         <Sentence>
            UPDATE tiptxnbok
            SET PrtNum='1'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>

      <!--Quote name="GetTreNamSql"/-->                <!--获取国库名称-->
      <Quote name="GetBrkSQL"/>                   <!--根据网点号取分行号-->
      <Quote name="ChkOrgNodSQL"/>                <!--根据征收机关代码检查征收机关和对应节点状态的SQL语句-->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="ISNULL($TaxNum)=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=课税数量不能为空</Set>
            <Return/>
         </If>

         <Exec func="PUB:ReadRecord">             <!--检查系统状态-->
            <Arg name="SqlCmd" value="ChkStatus"/>
         </Exec>
         <If condition="AND(IS_NOEQUAL_STRING($Status,0),IS_NOEQUAL_STRING($Status,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910601</Set>
            <Return/>
         </If>

         <!--检查征收机关是否有效-->
         <!--Exec func="PUB:ReadRecord" error="IGNORE">
         <Arg name="SqlCmd" value="ChkOrgCod"/>
         </Exec>
         <If condition="~RetCod=-2">
         <Set>RspCod=910212</Set>
         <Return/>
         </If>
         <ElseIf condition="~RetCod=0">
         <If condition="INTCMP($ActDat,1,$EffDat)">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910611</Set>
         <Return/>
         </If>
         </ElseIf>
         <Else>
         <Return/>
         </Else-->
         <Quote name="ChkOrgNodCTL"/>             <!--根据征收机关代码检查征收机关和对应节点状态的流程-->
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>                <!--根据网点号取分行号-->
         <Set>BrNo=$SBrNo</Set>

         <!--查询清算行支付系统行号-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>
         <!--If condition="INTCMP($ActDat,1,$EffDat)">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910699</Set>
         <Set>RspMsg=未到生效日期</Set>
         <Return/>
         </If-->
         <If condition="$PayTyp=1">               <!--检查CD帐户状态和余额-->
            <Set>TTxnCd=109000</Set>
            <Exec func="PUB:CallHostOther">       <!--上主机CD账户信息查询-->
               <Arg name="HTxnCd" value="109000" />
               <Arg name="ObjSvr" value="SHSTPUB1" />
            </Exec>
            <If condition="$MsgTyp!=N">
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号验证失败</Set>
               <Return/>
            </If>
            <Else>
               <If condition="$ActSts=T">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=账号为销户计息</Set>
                  <Return/>
               </If>
               <ElseIf condition="$ActSts=C">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=账号为销户</Set>
                  <Return/>
               </ElseIf>
               <ElseIf condition="$ActSts=I">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=账号为不动户</Set>
                  <Return/>
               </ElseIf>
               <Else>
                  <If condition="SUBSTR($AStsW,2,1)=1">
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=账号暂封状态</Set>
                     <Return/>
                  </If>
                  <If condition="SUBSTR($AStsW,3,1)=1">
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=账号冻结状态</Set>
                     <Return/>
                  </If>
                  <!--Modified by liuyong at 20090618 for cq73472,增加判断条件，如果不是蕴通账户，直接返回-->
                  <If condition="INTCMP($AvaBal,1,$TxnAmt)">
                     <If condition="AND(IS_EQUAL_STRING(SUBSTR($AStsW,17,1),0),IS_EQUAL_STRING(SUBSTR($AStsW,18,1),0))"> <!--非蕴通账户-->
                        <Set>MsgTyp=E</Set>
                        <Set>RspCod=910616</Set>
                        <Set>RspMsg=帐户可用余额不足</Set>
                        <Return/>
                     </If>
                  </If>
                  <!--Ended by liuyong at 20090618 for cq73472,增加判断条件，如果不是蕴通账户，直接返回-->
               </Else>
            </Else>

            <Set>ONodNo=$OpnNod</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="GetBrkNam"/>
            </Exec>
            <If condition="~RetCod=-2">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=取不到付款人开户银行名称</Set>
               <Return/>
            </If>
            <Set>BrkNam=STRCAT($BrkNm,$BrkNam)</Set>
            <Set>BrkNam=ADDCHAR($BrkNam,60, ,0)</Set>
         </If>
         <ElseIf condition="$PayTyp=0">
            <Set>ONodNo=$NodNo</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="GetBrkNam"/>
            </Exec>
            <If condition="~RetCod=-2">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=取不到付款人开户银行名称</Set>
               <Return/>
            </If>
         </ElseIf>

         <!--Added By zhq_BoCom00032769_20080403_添加内部账户转帐-->
         <ElseIf condition="$PayTyp=2">
            <Exec func="PUB:GetLogNo"/>
            <Set>ITM=SUBSTR($ActNo,9,5)</Set>
            <Set>SEQ=SUBSTR($ActNo,14,5)</Set>
            <If condition="OR(IS_NOEQUAL_STRING($ITM,26201),IS_NOEQUAL_STRING($SEQ,00006))"> <!--只允许输入26201-00006分户-->
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=此交易只支持26201-00006内部账户</Set>
               <Return/>
            </If>
            <!--由于内部账户在打印界面上没有显示,所以将内部账户归集到CD账户-->
            <Set>PayTyp=1</Set>
            <Exec func="PUB:CallHostOther" error="IGNORE">
               <Arg name="HTxnCd" value="098065"/>
               <Arg name="ObjSvr" value="SHSTPUB1"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=验证内部帐号状态出错</Set>
               <Return/>
            </If>
            <Else>
               <If condition="IS_NOEQUAL_STRING($RspRst,Y)">
                  <If condition="IS_EQUAL_STRING($RspRst,T)">
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=内部账户状态暂封</Set>
                     <Return/>
                  </If>
                  <ElseIf condition="IS_EQUAL_STRING($RspRst,N)">
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=内部账户状态已关闭</Set>
                     <Return/>
                  </ElseIf>
                  <Else>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=内部帐号状态出错</Set>
                     <Return/>
                  </Else>
               </If>
            </Else>

            <Set>ONodNo=SUBSTR($ActNo,1,6)</Set>
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="GetBrkNam"/>
            </Exec>
            <If condition="~RetCod=-2">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=取不到付款人开户银行名称</Set>
               <Return/>
            </If>
            <Set>BrkNam=STRCAT($BrkNm,$BrkNam)</Set>
            <Set>BrkNam=ADDCHAR($BrkNam,60, ,0)</Set>
         </ElseIf>
         <Else>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=错误的支付方式</Set>
            <Return/>
         </Else>

         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetOrgNam"/>
         </Exec>

         <!--银行申报请求-->
         <Set>OTxnAmt=$TxnAmt</Set>
         <Quote name="GetSeq"/>
         <!--need to add-->
         <Set>MsgRef=$MsgId</Set>

         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="TIPLvyNo"/>
            <Arg name="Len" value="8"/>
         </Exec>
         <Set>LevyNo=$SelVal</Set>

         <Exec func="PUB:CallThirdOther">
            <Arg name="HTxnCd" value="2090"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="$TRspCd=999999">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>
         <If condition="$Result!=90000">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910612</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>

         <!--根据国库代码查询国库名称-->
         <!--Quote name="FetchTreNam"/-->

         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkTaxVID"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </If>
         <ElseIf condition="~RetCod=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=STRCAT(税票号,$TaxVID,已缴纳成功)</Set>
            <Return/>
         </ElseIf>
         <Else>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=验证税票号时出错</Set>
            <Return/>
         </Else>

         <If condition="IS_NOEQUAL_STRING($OTxnAmt,$TxnAmt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=申报金额与人行确认金额不符，交易拒绝</Set>
            <Return/>
         </If>
         <Set>BokNum=STRCAT($EntDat,$TraNo)</Set>
         <Set>PayMod=2</Set>                      <!--银行缴款-->
         <Set>FTxnTm=GETDATETIME()</Set>
         <Set>ReqDat=$WrkDat</Set>
         <Set>OBrkNo=$BrkNo</Set>

         <Exec func="PUB:ReadRecord">             <!--查询关联分行号-->
            <Arg name="SqlCmd" value="GetCBrkNo"/>
         </Exec>

         <Exec func="PUB:ReadRecord">             <!--查询清算行行号和暂收科目顺序号-->
            <Arg name="SqlCmd" value="GetRBrkNo"/>
         </Exec>

         <Exec func="PUB:GetLogNo"/>

         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tiptxnbok"/>
         </Exec>
         <If condition="$PayTyp=0">
            <Set>HTxnCd=915810</Set>
            <Set>TTxnCd=$FeCod</Set>              <!--为解决 记账凭证打印出的交易码交易名称有误-->
         </If>
         <Else>
            <Set>HTxnCd=915870</Set>
            <Set>TTxnCd=$HTxnCd</Set>             <!--为解决 记账凭证打印出的交易码交易名称有误-->
         </Else>

         <Set>CcyCod=CNY</Set>
         <Set>ItgTyp=1</Set>
         <Set>TxnAtr= </Set>
         <Set>MstChk=1</Set>
         <Set>RecTyp=2</Set>
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>                <!--根据网点号取分行号-->
         <Exec func="PUB:InsertJournal"/>         <!--预计流水-->
         <Set>i=1</Set>
         <While condition="INTCMP($TTpNm,5,$i)">
            <Exec func="PUB:InsertRecordByGroup">
               <Arg name="TableName" value="tipttprec"/>
               <Arg name="GroupName" value="TaxTypLst1008"/>
               <Arg name="RecordNo"  value="$i"/>
            </Exec>
            <Exec func="PUB:InsertRecordByGroup">
               <Arg name="TableName" value="tiptaxrec"/>
               <Arg name="RootName"  value="STRCAT(ROOT.TaxTypLst1008_,$i)"/>
               <Arg name="GroupName" value="TaxSbjLst1008"/>
               <Arg name="FldLst" value="OrgCod|EntDat|TraNo|"/>
            </Exec>
            <Set>i=ADD($i,1)</Set>
         </While>

         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>

         <!--主机单笔缴费-->
         <Exec func="PUB:CallHostAcc" error="IGNORE">
            <Arg name="HTxnCd" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <Switch expression="~RetCod">
            <Case value="-10">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=向主机发送交易失败</Set>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Set>BrNo=$SBrNo</Set>
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99004</Set>
               <Set>RspMsg=系统交易失败</Set>

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=主机交易系统错误</Set>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Set>BrNo=$SBrNo</Set>
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99004</Set>
               <Set>RspMsg=系统交易失败</Set>

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="T"/>
               </Exec>
               <Set>BilSts=T</Set>
               <Set>AddWord=系统运行超时</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Set>BrNo=$SBrNo</Set>
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99002</Set>
               <Set>RspMsg=系统通信异常</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请抹账</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=STRCAT(主机交易拒绝错误码,$HRspCd)</Set>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Set>BrNo=$SBrNo</Set>
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=$HRspCd</Set>

               <Exec func="PUB:CodeSwitching">
                  <Arg name="DatSrc" value="TIPCSW"></Arg>
                  <Arg name="SourNam" value="RspCod"></Arg>
                  <Arg name="DestNam" value="Result"></Arg>
                  <Arg name="TblNam" value="Cod2Res"></Arg>
               </Exec>

               <Exec func="PUB:CodeSwitching">
                  <Arg name="DatSrc" value="TIPCSW"></Arg>
                  <Arg name="SourNam" value="Result"></Arg>
                  <Arg name="DestNam" value="AddWord"></Arg>
                  <Arg name="TblNam" value="Res2Wrd"></Arg>
               </Exec>

               <Set>RspMsg=$AddWord</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <If condition="$MsgTyp!=N">        <!--授权-->
                  <Return/>
               </If>
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="S"/>
               </Exec>

               <Set>BilSts=1</Set>
               <Set>AddWord=交易成功</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

             <!-- BoCom00067554 modified by zhb 2009-7-24 start -->
             <!-- 网银不更新税票打印次数 -->
               <If condition="$CnlTyp!=1">
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdPrtNum"/>
                  </Exec>
               </If>
             <!-- BoCom00067554 end -->

               <!--银行申报扣税回执-->
               <Set>RspMsg=交易成功</Set>
               <Exec func="PUB:PutResponse"/>
               <Set>BrNo=$SBrNo</Set>
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Return/>
            </Case>
            <Default>
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=主机交易错误</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Set>BrNo=$SBrNo</Set>
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99090</Set>
               <Set>RspMsg=系统交易失败</Set>

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知主机错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>

         <!--银行申报扣税回执-->
         <!--Exec func="PUB:ExecSql">
         <Arg name="SqlCmd" value="UpdRspDat"/>
         </Exec>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:CallThirdOther">
         <Arg name="TxnCod"  value="2108"/>
         <Arg name="ObjSvr"  value="SMQMTIP2"/>
         </Exec>

         <Set>RspSts=1</Set>
         <Exec func="PUB:ExecSql">
         <Arg name="SqlCmd" value="UpdRspSts"/>
         </Exec-->
      </FlowCtrl>
   </Transaction>


   <Transaction code="915820" desc="未申报银行端缴款记帐">
      <DynSentence name="ChkStatus">   <!--检查系统状态-->
         <Sentence>
            SELECT Status,WorkDt WrkDat
            FROM tipsyssts
            FOR READ ONLY
         </Sentence>
         <Fields></Fields>
      </DynSentence>
      <!--DynSentence name="ChkOrgCod"-->   <!--检查征收机关是否已存在-->
      <!--Sentence>
      SELECT EffDat
      FROM tiporginf
      WHERE OrgCod='%s'
      </Sentence>
      <Fields>OrgCod|</Fields>
      </DynSentence-->
      <DynSentence name="GetPBnkNo">   <!--查询清算行支付系统行号-->
         <Sentence>
            SELECT PBnkNo
            FROM tipbrkinf
            WHERE BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetBrkNam">   <!--查询付款人开户行名称-->
         <Sentence>
            SELECT OrgNam BrkNam
            FROM cimorgtbl
            WHERE OrgNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>ONodNo|</Fields>
      </DynSentence>
      <DynSentence name="ChkTaxVID">   <!--检查税票号是否已缴纳过-->
         <Sentence>
            SELECT OrgCod
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND TaxVID='%s'
            AND BilSts IN ('1','9')
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|TaxVID|</Fields>
      </DynSentence>
      <DynSentence name="GetCBrkNo">   <!--查询关联分行号-->
         <Sentence>
            SELECT BrkNo CBrkNo
            FROM tiptrerkn
            WHERE RBnkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetRBrkNo">   <!--查询清算行行号和暂收科目顺序号-->
         <Sentence>
            SELECT BrkNo RBrkNo,ActSqn
            FROM tipbrkinf
            WHERE PBnkNo='%s'
            AND RknFlg='1'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">   <!--根据前置流水号更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='%s',BilSts='%s',TckNo='%s',AddWord='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|BilSts|TckNo|AddWord|LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdRspSts">   <!--根据前置流水号更新人行账务登记薄中的回执状态-->
         <Sentence>
            UPDATE tiptxnbok
            SET RspSts='%s',RspDat='%s',RspNum='1'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>RspSts|WrkDat|LogNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <Quote name="ChkOrgNodSQL"/>  <!--根据征收机关代码检查征收机关和对应节点状态的SQL语句-->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="ISNULL($TaxNum)=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=课税数量不能为空</Set>
            <Return/>
         </If>
         <!--检查系统状态-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStatus"/>
         </Exec>
         <If condition="AND(IS_NOEQUAL_STRING($Status,0),IS_NOEQUAL_STRING($Status,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910601</Set>
            <Return/>
         </If>

         <!--检查征收机关是否有效-->
         <!--Exec func="PUB:ReadRecord" error="IGNORE">
         <Arg name="SqlCmd" value="ChkOrgCod"/>
         </Exec>
         <If condition="~RetCod=-2">
         <Set>RspCod=910212</Set>
         <Return/>
         </If>
         <ElseIf condition="~RetCod=0">
         <If condition="INTCMP($ActDat,1,$EffDat)">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910611</Set>
         <Return/>
         </If>
         </ElseIf>
         <Else>
         <Return/>
         </Else-->

         <Quote name="ChkOrgNodCTL"/>  <!--根据征收机关代码检查征收机关和对应节点状态的流程-->
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->
         <Set>BrNo=$SBrNo</Set>

         <!--查询清算行支付系统行号-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>
         <!--If condition="INTCMP($ActDat,1,$EffDat)">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910699</Set>
         <Set>RspMsg=未到生效日期</Set>
         <Return/>
         </If-->


         <!--检查CD帐户状态和余额-->
         <If condition="$PayTyp=1">
            <Set>TTxnCd=109000</Set>
            <Exec func="PUB:CallHostOther"> <!--上主机CD账户信息查询-->
               <Arg name="HTxnCd" value="109000" />
               <Arg name="ObjSvr" value="SHSTPUB1" />
            </Exec>
            <If condition="$MsgTyp!=N">
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号验证失败</Set>
               <Return/>
            </If>
            <ElseIf condition="$ActSts=T">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号为销户计息</Set>
               <Return/>
            </ElseIf>
            <ElseIf condition="$ActSts=C">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号为销户</Set>
               <Return/>
            </ElseIf>
            <ElseIf condition="$ActSts=I">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号为不动户</Set>
               <Return/>
            </ElseIf>
            <ElseIf condition="SUBSTR($AStsW,2,1)=1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号暂封状态</Set>
               <Return/>
            </ElseIf>
            <ElseIf condition="SUBSTR($AStsW,3,1)=1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号冻结状态</Set>
               <Return/>
            </ElseIf>
            <!--Modified by liuyong at 20090618 for cq73472,增加判断条件，如果不是蕴通账户，直接返回-->
            <ElseIf condition="INTCMP($AvaBal,1,$TxnAmt)"><!--余额不足-->
               <If condition="AND(IS_EQUAL_STRING(SUBSTR($AStsW,17,1),0),IS_EQUAL_STRING(SUBSTR($AStsW,18,1),0))"><!--非蕴通账户-->
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910616</Set>
                  <Set>RspMsg=帐户可用余额不足</Set>
                  <Return/>
               </If>
             <!--Ended by liuyong at 20090618 for cq73472,增加判断条件，如果不是蕴通账户，直接返回-->
            </ElseIf>
            <Set>ONodNo=$OpnNod</Set>
         </If>
         <ElseIf condition="$PayTyp=0">
            <Set>ONodNo=$NodNo</Set>
         </ElseIf>

         <!--检查申报状态-->
         <If condition="$LvySts!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910617</Set>
            <Set>RspMsg=申报状态不是未申报，交易拒绝</Set>
            <Return/>
         </If>


         <!--银行申报请求-->
         <Set>OTxnAmt=$TxnAmt</Set>

         <Quote name="GetSeq"/>
         <!--need to add-->
         <Set>MsgRef=$MsgId</Set>

         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="TIPLvyNo"/>
            <Arg name="Len" value="8"/>
         </Exec>
         <Set>LevyNo=$SelVal</Set>

         <Exec func="PUB:CallThirdOther">
            <Arg name="HTxnCd" value="2090"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="$TRspCd=999999">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>
         <If condition="$Result!=90000">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910612</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>

         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkTaxVID"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </If>
         <ElseIf condition="~RetCod=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=STRCAT(税票号,$TaxVID,已缴纳成功)</Set>
            <Return/>
         </ElseIf>
         <Else>
            <Return/>
         </Else>

         <If condition="IS_NOEQUAL_STRING($OTxnAmt,$TxnAmt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=申报金额与人行确认金额不符，交易拒绝</Set>
            <Return/>
         </If>

         <!--银行缴款-->
         <Set>PayMod=2</Set>
         <Set>FTxnTm=GETDATETIME()</Set>
         <Set>ReqDat=$WrkDat</Set>
         <Set>OBrkNo=$BrkNo</Set>
         <Exec func="PUB:ReadRecord">   <!--查询关联分行号-->
            <Arg name="SqlCmd" value="GetCBrkNo"/>
         </Exec>
         <Exec func="PUB:ReadRecord">   <!--查询清算行行号和暂收科目顺序号-->
            <Arg name="SqlCmd" value="GetRBrkNo"/>
         </Exec>
         <Exec func="PUB:GetLogNo"/>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tiptxnbok"/>
         </Exec>


         <Set>HTxnCd=915820</Set>
         <Set>TTxnCd=$HTxnCd</Set>
         <Set>CcyCod=CNY</Set>
         <Set>ItgTyp=1</Set>
         <Set>TxnAtr= </Set>
         <Set>MstChk=1</Set>
         <Set>RecTyp=2</Set>
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->
         <Exec func="PUB:InsertJournal"/> <!--预计流水-->

         <Set>i=1</Set>
         <While condition="INTCMP($TTpNm,5,$i)">
            <Exec func="PUB:InsertRecordByGroup">
               <Arg name="TableName" value="tipttprec"/>
               <Arg name="GroupName" value="TaxTypLst1008"/>
               <Arg name="RecordNo"  value="$i"/>
            </Exec>

            <Exec func="PUB:InsertRecordByGroup">
               <Arg name="TableName" value="tiptaxrec"/>
               <Arg name="RootName"  value="STRCAT(ROOT.TaxTypLst1008_,$i)"/>
               <Arg name="GroupName" value="TaxSbjLst1008"/>
               <Arg name="FldLst" value="OrgCod|EntDat|TraNo|"/>
            </Exec>
            <Set>i=ADD($i,1)</Set>
         </While>

         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE">   <!--主机单笔缴费-->
            <Arg name="HTxnCd" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

         <Switch expression="~RetCod">
            <Case value="-10">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=向主机发送交易失败</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99004</Set>
               <Set>RspMsg=系统交易失败</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>

               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=主机交易系统错误</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99004</Set>
               <Set>RspMsg=系统交易失败</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>

               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="T"/>
               </Exec>
               <Set>BilSts=T</Set>
               <Set>AddWord=系统运行超时</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99002</Set>
               <Set>RspMsg=系统通讯异常</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>

               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请抹账</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=STRCAT(主机交易拒绝错误码,$HRspCd)</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=$HRspCd</Set>
               <Exec func="PUB:CodeSwitching">
                  <Arg name="DatSrc" value="TIPCSW"></Arg>
                  <Arg name="SourNam" value="RspCod"></Arg>
                  <Arg name="DestNam" value="Result"></Arg>
                  <Arg name="TblNam" value="Cod2Res"></Arg>
               </Exec>
               <Exec func="PUB:CodeSwitching">
                  <Arg name="DatSrc" value="TIPCSW"></Arg>
                  <Arg name="SourNam" value="Result"></Arg>
                  <Arg name="DestNam" value="AddWord"></Arg>
                  <Arg name="TblNam" value="Res2Wrd"></Arg>
               </Exec>
               <Set>RspMsg=$AddWord</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>

               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="S"/>
               </Exec>
               <Set>BilSts=9</Set>
               <Set>AddWord=未申报记帐成功，待复核</Set>
               <Set>WrkDat= </Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <Return/>
            </Case>
            <Default>
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>

               <Set>BilSts=2</Set>
               <Set>AddWord=主机交易错误</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99090</Set>
               <Set>RspMsg=系统交易失败</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>

               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知主机错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>

   <!--Modified By zhq_BoCom00043458_20080807-->
   <Transaction code="915827" desc="未申报银行端转帐缴款复核">
      <DynSentence name="ChkStatus">   <!--检查系统状态-->
         <Sentence>
            SELECT Status,WorkDt WrkDat
            FROM tipsyssts
            FOR READ ONLY
         </Sentence>
         <Fields></Fields>
      </DynSentence>

      <DynSentence name="ChkTxnInf">   <!--检查原交易信息-->
         <!--Modified By zhq_BoCom00043458_20080807_取出TreCod以备查询国库名称,同时不再将收款人帐户名称(RaccNm)作为收款国库(银行)名称打印-->
         <!--Sentence>
         SELECT TlrId OTlrId,ActNo OActNo,TxnAmt OTxnAmt,TCusId OTCusId,LogNo OLogNo,TckNo OTckNo,LevyNo,TCusNm,TBlDt,CrpCod,BdgTyp,TrmSgn,CrpTyp,PVSign,TTpNm,TaxVID,BilDat,PayPsw,ONodNo,EntDat,TraNo,RaccNm
         FROM tiptxnbok
         WHERE OrgCod='%s'
         AND EntDat='%s'
         AND TraNo='%s'
         AND BilSts='9'
         FOR READ ONLY
         </Sentence-->

         <Sentence>
            SELECT TlrId OTlrId,ActNo OActNo,TxnAmt OTxnAmt,TCusId OTCusId,LogNo OLogNo,TckNo OTckNo,LevyNo,TCusNm,TBlDt,CrpCod,BdgTyp,TrmSgn,CrpTyp,PVSign,TTpNm,TaxVID,BilDat,PayPsw,ONodNo,EntDat,TraNo,RaccNm
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            AND BilSts='9'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      
      <DynSentence name="GetBrkNam">   <!--查询付款人开户行名称-->
         <Sentence>
            SELECT OrgNam BrkNam
            FROM cimorgtbl
            WHERE OrgNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>ONodNo|</Fields>
      </DynSentence>

      <DynSentence name="GetTxnInf">   <!--检查原交易信息-->
         <Sentence>
            SELECT HLogNo OHLogNo,TTxnCd OTTxnCd
            FROM tiptxnjnl
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OLogNo|</Fields>
      </DynSentence>

      <DynSentence name="GetPBnkNo">   <!--查询清算行支付系统行号-->
         <Sentence>
            SELECT PBnkNo,BrkNam BrkNm
            FROM tipbrkinf
            WHERE BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetActSqn">   <!--查询暂收科目顺序号-->
         <Sentence>
            SELECT ActSqn
            FROM tipbrkinf
            WHERE PBnkNo='%s'
            AND RknFlg='1'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetOrgNam">   <!--查询征收机关名称-->
         <Sentence>
            SELECT OrgNam
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="UpdTxnBok">   <!--根据前置流水号更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='%s',BilSts='%s',AddWord='复核成功'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|BilSts|OLogNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdRspSts">   <!--根据前置流水号更新人行账务登记薄中的回执状态-->
         <Sentence>
            UPDATE tiptxnbok
            SET RspSts='%s',RspDat='%s',RspNum='1'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>RspSts|WrkDat|OLogNo|</Fields>
      </DynSentence>

      <DynSentence name="QryTtpRec">   <!--查询税种记录明细-->
         <Sentence>
            SELECT *
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            ORDER BY ProjId
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>

      <DynSentence name="QryTaxRec">   <!--查询税目记录明细-->
         <Sentence>
            SELECT *
            FROM tiptaxrec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            AND ProjId='%s'
            ORDER BY DtlNo
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|RProjId|</Fields>
      </DynSentence>

      <DynSentence name="UpdPrtNum">
         <Sentence>
            UPDATE tiptxnbok SET PrtNum='1' WHERE LogNo='%s'
         </Sentence>
         <Fields>OLogNo|</Fields>
      </DynSentence>

      <Quote name="GetBrkSQL"/>     <!--根据网点号取分行号-->
      <Quote name="ChkOrgNodSQL"/>  <!--根据征收机关代码检查征收机关和对应节点状态的SQL语句-->
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetOrgNam"/>
         </Exec>
         <!--检查系统状态-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStatus"/>
         </Exec>
         <If condition="AND(IS_NOEQUAL_STRING($Status,0),IS_NOEQUAL_STRING($Status,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910601</Set>
            <Return/>
         </If>

         <Quote name="ChkOrgNodCTL"/>  <!--根据征收机关代码检查征收机关和对应节点状态的流程-->

         <!--查询原交易信息-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkTxnInf"/>
         </Exec>

         

         <Set>BokNum=STRCAT($EntDat,$TraNo)</Set>
         <!--根据开户机构号查询机构名称 用于付款凭证打印-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetBrkNam"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=取不到付款人开户银行名称</Set>
            <Return/>
         </If>

         <!--检查复核柜员是否原柜员-->
         <If condition="IS_EQUAL_STRING($TlrId,$OTlrId)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910614</Set>
            <Return/>
         </If>

         <!--检查复核要素-->
         <If condition="OR(IS_NOEQUAL_STRING($ActNo,$OActNo),IS_NOEQUAL_STRING($TxnAmt,$OTxnAmt),IS_NOEQUAL_STRING($TCusId,$OTCusId))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910615</Set>
            <Return/>
         </If>

         <!--上主机进行复核-->
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->
         <Exec func="PUB:ReadRecord">   <!--查询清算行支付系统行号-->
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>
         <!--If condition="INTCMP($ActDat,1,$EffDat)">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910699</Set>
         <Set>RspMsg=未到生效日期</Set>
         <Return/>
         </If-->
         <Exec func="PUB:ReadRecord">   <!--查询暂收科目顺序号-->
            <Arg name="SqlCmd" value="GetActSqn"/>
         </Exec>
         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <Exec func="PUB:ReadRecord">   <!--查询原交易信息-->
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>
         <Exec func="PUB:GetLogNo"/>
         <Exec func="PUB:CallHostOther" error="IGNORE">   <!--主机单笔缴费-->
            <Arg name="HTxnCd" value="915827"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

         <Switch expression="~RetCod">
            <Case value="-10">
               <!--Exec func="PUB:UpdateJournalHost">
               <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec-->

               <!--银行申报扣税回执-->
               <!--Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <Set>RspCod=94999</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Exec func="PUB:CallThirdOther">
               <Arg name="TxnCod"  value="2108"/>
               <Arg name="ObjSvr"  value="SMQMTIP2"/>
               </Exec>

               <Set>RspSts=1</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec-->

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <!--Exec func="PUB:UpdateJournalHost">
               <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec-->

               <!--银行申报扣税回执-->
               <!--Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <Set>RspCod=94999</Set>
               <Set>RspMsg=系统错误</Set>
               <Exec func="PUB:CallThirdOther">
               <Arg name="TxnCod"  value="2108"/>
               <Arg name="ObjSvr"  value="SMQMTIP2"/>
               </Exec>

               <Set>RspSts=1</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec-->

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <!--Exec func="PUB:UpdateJournalHost">
               <Arg name="TxnSts" value="T"/>
               </Exec>
               <Set>BilSts=T</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec-->

               <!--银行申报扣税回执-->
               <!--Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <Set>RspCod=94999</Set>
               <Set>RspMsg=系统运行超时</Set>
               <Exec func="PUB:CallThirdOther">
               <Arg name="TxnCod"  value="2108"/>
               <Arg name="ObjSvr"  value="SMQMTIP2"/>
               </Exec>

               <Set>RspSts=1</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec-->

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请抹账</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <!--Exec func="PUB:UpdateJournalHost">
               <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec-->

               <!--银行申报扣税回执-->
               <!--Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <Set>RspCod=$HRspCd</Set>
               <Set>RspMsg=主机交易失败</Set>
               <Exec func="PUB:CallThirdOther">
               <Arg name="TxnCod"  value="2108"/>
               <Arg name="ObjSvr"  value="SMQMTIP2"/>
               </Exec>

               <Set>RspSts=1</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec-->

               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Set>BrkNam=STRCAT($BrkNm,$BrkNam)</Set>
               <Set>BrkNam=ADDCHAR($BrkNam,60, ,0)</Set>
               <!--Exec func="PUB:UpdateJournalHost">
               <Arg name="TxnSts" value="S"/>
               </Exec-->
               <Set>BilSts=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdPrtNum"/>
               </Exec>

               <Break/>
            </Case>
            <Default>
               <!--Exec func="PUB:UpdateJournalHost">
               <Arg name="TxnSts" value="F"/>
               </Exec>

               <Set>BilSts=2</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec-->

               <!--银行申报扣税回执-->
               <!--Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <Set>RspCod=94999</Set>
               <Set>RspMsg=主机交易错误</Set>
               <Exec func="PUB:CallThirdOther">
               <Arg name="TxnCod"  value="2108"/>
               <Arg name="ObjSvr"  value="SMQMTIP2"/>
               </Exec>

               <Set>RspSts=1</Set>
               <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec-->

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知主机错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>

         <Set>BrNo=$SBrNo</Set>

         <!--查询税种税目信息并返回前端-->
         <Exec func="PUB:QueryInGroup">
            <Arg name="SqlCmd" value="QryTtpRec"/>
            <Arg name="RecordName" value="TaxTypLst1008"/>
         </Exec>

         <Set>TTpCnt=1</Set>
         <While condition="INTCMP($TTpCnt,2,$TTpNm)">
            <Exec func="PUB:GetValue">
               <Arg name="SourName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.ProjId)"/>
               <Arg name="DestName"  value="ROOT.RProjId"/>
            </Exec>
            <Exec func="PUB:GetValue">
               <Arg name="SourName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.DtlNum)"/>
               <Arg name="DestName"  value="ROOT.RDtlNum"/>
            </Exec>

            <Exec func="PUB:QueryInGroup">
               <Arg name="SqlCmd" value="QryTaxRec"/>
            </Exec>

            <Set>SbjCnt=1</Set>
            <While condition="INTCMP($SbjCnt,2,$RDtlNum)">
               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.ROOT_,$SbjCnt,.DtlNo)"/>
                  <Arg name="DestName"  value="ROOT.RDtlNo"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.TaxSbjLst1008_,$SbjCnt,.DtlNo)"/>
                  <Arg name="FieldValue" value="$RDtlNo"/>
               </Exec>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.ROOT_,$SbjCnt,.TaxSbCd)"/>
                  <Arg name="DestName"  value="ROOT.RTaxSbCd"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.TaxSbjLst1008_,$SbjCnt,.TaxSbCd)"/>
                  <Arg name="FieldValue" value="$RTaxSbCd"/>
               </Exec>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.ROOT_,$SbjCnt,.TaxSbNm)"/>
                  <Arg name="DestName"  value="ROOT.RTaxSbNm"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.TaxSbjLst1008_,$SbjCnt,.TaxSbNm)"/>
                  <Arg name="FieldValue" value="$RTaxSbNm"/>
               </Exec>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.ROOT_,$SbjCnt,.TaxNum)"/>
                  <Arg name="DestName"  value="ROOT.RTaxNum"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.TaxSbjLst1008_,$SbjCnt,.TaxNum)"/>
                  <Arg name="FieldValue" value="$RTaxNum"/>
               </Exec>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.ROOT_,$SbjCnt,.TaxAmt)"/>
                  <Arg name="DestName"  value="ROOT.RTaxAmt"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.TaxSbjLst1008_,$SbjCnt,.TaxAmt)"/>
                  <Arg name="FieldValue" value="$RTaxAmt"/>
               </Exec>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.ROOT_,$SbjCnt,.TaxRat)"/>
                  <Arg name="DestName"  value="ROOT.RTaxRat"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.TaxSbjLst1008_,$SbjCnt,.TaxRat)"/>
                  <Arg name="FieldValue" value="$RTaxRat"/>
               </Exec>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.ROOT_,$SbjCnt,.ETxAmt)"/>
                  <Arg name="DestName"  value="ROOT.RETxAmt"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.TaxSbjLst1008_,$SbjCnt,.ETxAmt)"/>
                  <Arg name="FieldValue" value="$RETxAmt"/>
               </Exec>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.ROOT_,$SbjCnt,.DTxAmt)"/>
                  <Arg name="DestName"  value="ROOT.RDTxAmt"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.TaxSbjLst1008_,$SbjCnt,.DTxAmt)"/>
                  <Arg name="FieldValue" value="$RDTxAmt"/>
               </Exec>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.ROOT_,$SbjCnt,.FTxAmt)"/>
                  <Arg name="DestName"  value="ROOT.RFTxAmt"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxTypLst1008_,$TTpCnt,.TaxSbjLst1008_,$SbjCnt,.FTxAmt)"/>
                  <Arg name="FieldValue" value="$RFTxAmt"/>
               </Exec>

               <Set>SbjCnt=ADD($SbjCnt,1)</Set>
            </While>

            <Exec func="PUB:DeleteGroup">
               <Arg name="GroupName" value="ROOT"/>
            </Exec>

            <Set>TTpCnt=ADD($TTpCnt,1)</Set>
         </While>
         <!--交易成功必须从数据库中获取到数据后才能返回-->
         <Exec func="PUB:PutResponse"/>
         <!--银行申报扣税回执-->
         <Quote name="GetSeq"/>
         <!--need to add-->
         <Set>MsgRef=$MsgId</Set>
         <Set>RspCod=90000</Set>
         <Set>RspMsg=交易成功</Set>
         <Exec func="PUB:CallThirdOther">
            <Arg name="TxnCod"  value="2108"/>
            <Arg name="ObjSvr"  value="MMQMTIP1"/>
         </Exec>

         <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
            <Set>RspSts=1</Set>
         </If>
         <Else>
            <Set>RspSts=2</Set>
         </Else>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdRspSts"/>
         </Exec>
      </FlowCtrl>
   </Transaction>


   <Transaction code="915822" desc="未申报银行端转帐缴款待复核交易查询">
      <DynSentence name="GetTxnInf">   <!--查询待复核转账交易-->
         <Sentence>
            SELECT ActNo,OrgCod,EntDat,TraNo,TCusId,VchTyp,VchNo,TxnAmt
            FROM tiptxnbok
            WHERE ActDat='%s'
            AND TlrId='%s'
            AND BilSts='9'
            FOR READ ONLY
         </Sentence>
         <Fields>ActDat|ChkTlr|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>
      </FlowCtrl>
   </Transaction>


   <Transaction code="915825" desc="银行申报抹账查询">
      <DynSentence name="ChkStatus">   <!--检查系统状态-->
         <Sentence>
            SELECT Status
            FROM tipsyssts
            FOR READ ONLY
         </Sentence>
         <Fields></Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf">   <!--根据会计流水号查询记录状态和回执状态-->
         <Sentence>
            SELECT HTxnSt,RspSts,LogNo,OrgCod,EntDat,TraNo,TCusId,TxnAmt,PayTyp,ActNo
            FROM tiptxnbok
            WHERE TckNo='%s'
            AND ActDat='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TckNo|ActDat|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf1">
         <Sentence>
            SELECT HTxnSt,RspSts,LogNo,OrgCod,EntDat,TraNo,TCusId,TxnAmt,PayTyp,ActNo
            FROM tiptxnbok
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnJnl">   <!--更新主机流水信息-->
         <Sentence>
            UPDATE tiptxnjnl
            SET HTxnSt='%s',TckNo='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|OTckNo|OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">   <!--更新人行账务登记薄信息-->
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='%s',TckNo='%s',BilSts='1'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|OTckNo|OLogNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查系统状态-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStatus"/>
         </Exec>
         <If condition="AND(IS_NOEQUAL_STRING($Status,0),IS_NOEQUAL_STRING($Status,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910601</Set>
            <Return/>
         </If>

         <!--授权检查-->
         <Exec func="PUB:AddAuthReason" >
            <Arg name="AthCod" value="30" />
            <Arg name="AthMsg" value="915825" />
         </Exec>
         <Exec  func="PUB:CheckLocalAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>

         <!--根据会计流水号查询记录状态和回执状态-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <ElseIf condition="~RetCod=0">
            <If condition="OR(IS_EQUAL_STRING($HTxnSt,F),IS_EQUAL_STRING($HTxnSt,C),IS_EQUAL_STRING($HTxnSt,X),IS_EQUAL_STRING($HTxnSt,D),IS_EQUAL_STRING($HTxnSt,E))">
               <Set>RspCod=910602</Set>
               <Return/>
            </If>
            <ElseIf condition="$HTxnSt=S">
               <If condition="$RspSts=1">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910603</Set>
                  <Return/>
               </If>
               <Else>
                  <Return/>
               </Else>
            </ElseIf>
            <ElseIf condition="$HTxnSt=T">
               <Goto>HOLD</Goto>
            </ElseIf>
         </ElseIf>
         <Else>
            <Goto>HOLD</Goto>
         </Else>
         <Label>HOLD</Label>
         <Set>OTckNo=$TckNo</Set>
         <Exec func="PUB:CallHostOther">
            <Arg name="HTxnCd" value="458970"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="AND(IS_NOEQUAL_STRING(~RetCod,0),IS_NOEQUAL_STRING(~RetCod,3))">
            <Return/>
         </If>
         <If condition="$MsgTyp!=N">
            <Switch expression="$HRspCd">
               <Case value="AG8001"/>
               <Case value="AG8981"/>
               <Case value="SC6129">
                  <Set>HTxnSt=F</Set>
                  <Break/>
               </Case>
               <Case value="SC6034">
                  <Set>HTxnSt=C</Set>
                  <Break/>
               </Case>
               <Default>
                  <Continue/>
               </Default>
            </Switch>
         </If>
         <Else>
            <If condition="$CrcSts!=Y">
               <Set>HTxnSt=S</Set>
            </If>
            <Else>
               <Set>HTxnSt=C</Set>
            </Else>
         </Else>
         <If conditon="$HTxnSt=S">
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnJnl"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdTxnBok"/>
            </Exec>
            <Set>LogNo=$OLogNo</Set>
         </If>
         <Else>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910602</Set>
            <Return/>
         </Else>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTxnInf1"/>
         </Exec>
      </FlowCtrl>
   </Transaction>



   <Transaction code="915829" desc="银行申报抹账">
      <DynSentence name="ChkStatus">   <!--检查系统状态-->
         <Sentence>
            SELECT Status,WorkDt WrkDat
            FROM tipsyssts
            FOR READ ONLY
         </Sentence>
         <Fields></Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf1">   <!--根据前置流水号在人行账务登记薄查询主机交易状态和原交易柜员-->
         <Sentence>
            SELECT HTxnSt,TlrId OTlrId,RspSts,PBnkNo,TaxVID,OrgCod,EntDat,TraNo
            FROM tiptxnbok
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf2">   <!--根据前置流水号在主机流水表查询原主机交易码和原前置交易码-->
         <Sentence>
            SELECT HTxnCd,TTxnCd
            FROM tiptxnjnl
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdHTxnSt1">   <!--根据前置流水号更新人行账务登记薄中的主机交易状态和交易状态为已冲正-->
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='C',BilSts='C',RspDat='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>WrkDat|LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdHTxnSt2">   <!--根据前置流水号更新主机流水表中的主机交易状态为已冲正-->
         <Sentence>
            UPDATE tiptxnjnl
            SET HTxnSt='C',TxnSts='C'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdRspSts">   <!--根据前置流水号更新人行账务登记薄中的回执状态-->
         <Sentence>
            UPDATE tiptxnbok
            SET RspSts='%s',RspDat='%s',RspNum='1'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>RspSts|WrkDat|LogNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查系统状态-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStatus"/>
         </Exec>
         <If condition="AND(IS_NOEQUAL_STRING($Status,0),IS_NOEQUAL_STRING($Status,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910601</Set>
            <Return/>
         </If>

         <!--检查主机交易状态、原交易柜员、回执状态-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTxnInf1"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <ElseIf condition="OR(IS_EQUAL_STRING($HTxnSt,F),IS_EQUAL_STRING($HTxnSt,C),IS_EQUAL_STRING($HTxnSt,X),IS_EQUAL_STRING($HTxnSt,D),IS_EQUAL_STRING($HTxnSt,E))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910602</Set>
            <Return/>
         </ElseIf>
         <ElseIf condition="$HTxnSt=S">
            <If condition="IS_NOEQUAL_STRING($TlrId,$OTlrId)">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910604</Set>
               <Return/>
            </If>
            <If condition="$RspSts=1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910603</Set>
               <Return/>
            </If>
         </ElseIf>

         <!--根据前置流水号在主机流水表中查询原主机交易码和原前置交易码-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTxnInf2"/>
         </Exec>
         <Set>HTxnCd=STRCAT(SUBSTR($HTxnCd,1,5),9)</Set>
         <Set>TTxnCd=STRCAT(SUBSTR($TTxnCd,1,5),9)</Set>
         <Set>TIATyp=C</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
            <Arg name="HTxnCd" value="959999"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod=-1"><!--主机超时-->
            <Set>RspCod=910605</Set>
            <Set>RspMsg=主机抹账超时,请继续抹账</Set>
            <Return/>
         </If>
         <ElseIf condition="OR(IS_EQUAL_STRING(~RetCod,-10),IS_EQUAL_STRING(~RetCod,-2))"><!--未发送或系统错误-->
            <Set>RspCod=910606</Set>
            <Set>RspMsg=主机抹账失败,请继续抹账</Set>
            <Return/>
         </ElseIf>
         <ElseIf condition="~RetCod=3"> <!--抹账失败-->
            <If condition="OR(IS_EQUAL_STRING($HRspCd,AG8001),IS_EQUAL_STRING($HRspCd,AG8981),IS_EQUAL_STRING($HRspCd,SC6129),IS_EQUAL_STRING($HRspCd,SC6034))"> <!--认为抹账成功-->
               <Set>HTxnSt=C</Set>
               <Set>TxnSts=C</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdHTxnSt1"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdHTxnSt2"/>
               </Exec>
               <Set>RspCod=000000</Set><!--如果主机流水不存在,或者原交易已被抹  返回前端成功 以便前端恢复票面-->
            </If>

            <!--银行申报扣税回执-->
            <Quote name="GetSeq"/>
            <!--need to add-->
            <Set>MsgRef=$MsgId</Set>
            <Set>RspCod=24020</Set>
            <Set>RspMsg=业务已作废</Set>
            <Exec func="PUB:CallThirdOther">
               <Arg name="TxnCod"  value="2108"/>
               <Arg name="ObjSvr"  value="MMQMTIP1"/>
            </Exec>

            <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
               <Set>RspSts=1</Set>
            </If>
            <Else>
               <Set>RspSts=2</Set>
            </Else>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
            </Exec>
            <Return/>
         </ElseIf>
         <ElseIf condition="~RetCod=0"> <!--成功-->
            <Set>HTxnSt=C</Set>
            <Set>TxnSts=C</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdHTxnSt1"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdHTxnSt2"/>
            </Exec>

            <!--银行申报扣税回执-->
            <Quote name="GetSeq"/>
            <!--need to add-->
            <Set>MsgRef=$MsgId</Set>
            <Set>RspCod=24020</Set>
            <Set>RspMsg=业务已作废</Set>
            <Exec func="PUB:CallThirdOther">
               <Arg name="TxnCod"  value="2108"/>
               <Arg name="ObjSvr"  value="MMQMTIP1"/>
            </Exec>

            <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
               <Set>RspSts=1</Set>
            </If>
            <Else>
               <Set>RspSts=2</Set>
            </Else>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
            </Exec>
         </ElseIf>
      </FlowCtrl>
   </Transaction>

   <!--Modified By zhq_BoCom00044952_20080731-->
   <!--Modified By zhq_BoCom00047053_20080902-->
   <Transaction code="915120" desc="三方协议维护">
      <DynSentence name="ChkOrgCod">   <!--检查征收机关是否已存在-->
         <Sentence>
            SELECT EffDat
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      
      <DynSentence name="ChkAgrNo">   <!--检查协议编号是否已存在且有效-->
         <Sentence>
            SELECT Status,NodNo AS RegNo
            FROM tipcusagr
            WHERE AgrNo='%s' AND ActNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
      </DynSentence>
      
      <DynSentence name="ChkTCusId">   <!--检查纳税人代码是否已签约-->
         <Sentence>
            SELECT TCusId,Status OStatus
            FROM tipcusagr
            WHERE TCusId='%s' AND OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TCusId|OrgCod|</Fields>
      </DynSentence>
      
      <DynSentence name="DelAgrRec">   <!--删除协议记录-->
         <Sentence>
            DELETE
            FROM tipcusagr
            WHERE AgrNo='%s' AND ActNo='%s'
            AND Status='1'
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
      </DynSentence>
      
      <DynSentence name="UpdAgrInf">   <!--更新协议信息-->
         <Sentence>
            TCusId='%s' AND OrgCod='%s'
         </Sentence>
         <Fields>TCusId|OrgCod|</Fields>
      </DynSentence>
      
      <DynSentence name="UpdCusAgr">   <!--按照协议编号更新协议信息-->
         <Sentence>
            AgrNo='%s' AND ActNo='%s'
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
      </DynSentence>
      
      <DynSentence name="ChkAgrInf">   <!--根据征收机关号和纳税人代码检查协议是否存在-->
         <Sentence>
            SELECT *
            FROM tipcusagr
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND BrkNo='%s'
            AND Status='0'
            FOR READ ONLY
         </Sentence>
         <Fields>TCusId|OrgCod|BrkNo|</Fields>
      </DynSentence>
      
      <DynSentence name="DelAgrInf">   <!--将协议置为无效-->
         <!--Modified By zhq_BoCom00047053_20080904-->
         <!--Sentence>
            UPDATE tipcusagr
            SET Status='1',VrySts='2'
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND BrkNo='%s'
         </Sentence>
         <Fields>TCusId|OrgCod|BrkNo|</Fields-->
         
         <Sentence>
            UPDATE tipcusagr
            SET Status='1',VrySts='2',CnlDat='%s'
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND BrkNo='%s'
         </Sentence>
         <Fields>CnlDat|TCusId|OrgCod|BrkNo|</Fields>
      </DynSentence>
      <!--Modified by sundx at 20090805 for cq76186，去掉BrkNo-->
      <DynSentence name="GetAgrInf">   <!--查询协议信息-->
         <Sentence>
            SELECT *
            FROM tipcusagr
            WHERE TCusId='%s'
            AND OrgCod='%s'            
            FOR READ ONLY
         </Sentence>
         <Fields>TCusId|OrgCod|</Fields>
      </DynSentence>
      <!--Modified by sundx at 20090805 for cq76186，去掉BrkNo,查找省行以及下属行协议-->
      <DynSentence name="GetAgrInf2">   <!--三方协议模糊查询-->
         <Sentence>
            SELECT *
            FROM tipcusagr
            WHERE (OrgCod='%s' OR '%s'='A')
            AND (TCusId='%s' OR '%s'='B')
            AND (AgrNo='%s' OR '%s'='C')
            AND (ActNo='%s' OR '%s'='D')
            AND (ONodNo='%s' OR '%s'='E')
            AND (VrySts='%s' OR '%s'='F')
            AND (BrkNo IN (SELECT OrgNo FROM cimorgtbl WHERE SupBk='%s') OR BrkNo='%s')
            ORDER BY AgrNo
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|OrgCod|TCusId|TCusId|AgrNo|AgrNo|ActNo|ActNo|ONodNo|ONodNo|VrySts|VrySts|BrkNo|BrkNo|</Fields>
      </DynSentence>
      
      <DynSentence name="GetWorkDt">
         <Sentence>
            SELECT WorkDt FROM tipsyssts
         </Sentence>
      </DynSentence>
      
      <DynSentence name="GetPBnkNo">   <!--查询付款行号-->
         <Sentence>
            SELECT PBnkNo
            FROM tipbrkinf
            WHERE BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      
      <DynSentence name="ChkAgrNo2">   <!--检查协议编号是否已存在且有效-->
         <Sentence>
            SELECT Status
            FROM tipcusagr
            WHERE AgrNo='%s' and OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>AgrNo|OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="DelThdPro"><!--删除协议-->
         <Sentence>
            DELETE FROM tipcusagr WHERE AgrNo='%s' AND OrgCod='%s' AND (VrySts='0' OR VrySts='2')
         </Sentence>
         <Fields>AgrNo|OrgCod|</Fields>
      </DynSentence>
      
      <DynSentence name="ChkStaSts"><!--检查协议状态-->
         <Sentence>
            SELECT  * FROM tipcusagr WHERE AgrNo='%s' AND OrgCod='%s'
         </Sentence>
         <Fields>AgrNo|OrgCod|</Fields>
      </DynSentence>
      
      <DynSentence name="ChkVrySts"><!--检查验证状态-->
         <Sentence>
            SELECT  * FROM tipcusagr WHERE AgrNo='%s' AND OrgCod='%s' AND (VrySts='0' OR VrySts='2')
         </Sentence>
         <Fields>AgrNo|OrgCod|</Fields>
      </DynSentence>

      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="$OprTyp!=5">
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="ChkOrgCod"/>
            </Exec>
            <If condition="~RetCod=-2">
               <Set>RspCod=910212</Set>
               <Return/>
            </If>
            <ElseIf condition="~RetCod=0">
               <If condition="INTCMP($ActDat,1,$EffDat)">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910611</Set>
                  <Return/>
               </If>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
            <!--Set>RecTm=GETDATETIME()</Set-->
         </If>

         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->
         <Set>BrNo=$SBrNo</Set>

         <Switch expression="$OprTyp">
            <Case value="1">  <!--增加协议-->
               <!--授权检查-->
               <!--Exec func="PUB:AddAuthReason" >
               <Arg name="AthCod" value="30" />
               <Arg name="AthMsg" value="915120" />
               </Exec>
               <Exec  func="PUB:CheckLocalAuth" >
               <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec-->
               
               <Exec func="PUB:ReadRecord" error="IGNORE">  <!--检查协议编号是否已存在-->
                  <Arg name="SqlCmd" value="ChkAgrNo"/>
               </Exec>
               <If condition="~RetCod=-1">
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$Status=1">
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="DelAgrRec"/>
                     </Exec>
                  </If>
                  <Else>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910204</Set>
                     <Return/>
                  </Else>
               </ElseIf>
               <Else>
                  <Set>RspCod=000000</Set>
               </Else>
 
               <Exec func="PUB:ReadRecord" error="IGNORE">  
                  <Arg name="SqlCmd" value="ChkAgrNo2"/>
               </Exec>
               <If condition="~RetCod=-1">
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$Status=1">
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="DelThdPro"/>
                     </Exec>
                  </If>
                  <Else>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910204</Set>
                     <Set>RspMsg=该协议已经存在，交易拒绝</Set>
                     <Return/>
                  </Else>
               </ElseIf>
               <Else>
                  <Set>RspCod=000000</Set>
               </Else>

               <Exec func="PUB:ReadRecord" error="IGNORE">  <!--检查纳税人代码是否已签约-->
                  <Arg name="SqlCmd" value="ChkTCusId"/>
               </Exec>
               <If condition="~RetCod=-1">
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$OStatus=1">
                     <Set>Status=0</Set>                     
                     <!--重新签约的时候,重新记录签约日期,并置验证日期为空-->
                     <Set>SgnDat=STRCAT($ActDat,GETDATETIME(HHMISS))</Set>
                     <Set>RecTm= </Set>                   
                     <Exec func="PUB:UpdateRecord">
                        <Arg name="TblNam" value="tipcusagr"/>
                        <Arg name="CndSts" value="UpdAgrInf"/>
                     </Exec>
                     <Set>VrySts=0</Set>
                     <Return/>
                  </If>
                  <Else>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910205</Set>
                     <Set>RspMsg=纳税人编码已签约</Set>
                     <Return/>
                  </Else>
               </ElseIf>
               <Else>
                  <Set>RspCod=000000</Set>
               </Else>

               <Set>Status=0</Set>
               <Set>VrySts=0</Set>
               <Set>RecTm= </Set>
               <!--Set>ActNam=$TCusNm</Set-->
               <Set>SgnDat=STRCAT($ActDat,GETDATETIME(HHMISS))</Set>
               <Exec func="PUB:InsertRecord">
                  <Arg name="TblNam" value="tipcusagr"/>
               </Exec>
 
               <Goto>Call915880</Goto>
               <Break/>
            </Case>
            <Case value="2">  <!--修改协议-->
               <!--授权检查  BoCom00030174-->
               <Exec func="PUB:AddAuthReason" >
                  <Arg name="AthCod" value="40" />
                  <Arg name="AthMsg" value="915120" />
               </Exec>

               <Exec  func="PUB:CheckLocalAuth" >
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
 
               <Exec func="PUB:ReadRecord">  <!--检查协议编号是否已存在-->
                  <Arg name="SqlCmd" value="ChkAgrNo"/>
               </Exec>
 
               <Exec func="PUB:UpdateRecord">  <!--修改协议-->
                  <Arg name="TblNam" value="tipcusagr"/>
                  <Arg name="CndSts" value="UpdCusAgr"/>
               </Exec>
               <Set>RecTm=STRCAT($ActDat,GETDATETIME(HHMISS))</Set>
               <Goto>Call915880</Goto>
               <Break/>
            </Case>
            <Case value="3">  <!--协议解约-->
               <!--授权检查-->
               <!--Exec func="PUB:AddAuthReason" >
               <Arg name="AthCod" value="30" />
               <Arg name="AthMsg" value="915120" />
               </Exec>
               <Exec  func="PUB:CheckLocalAuth" >
               <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec-->

               <Exec func="PUB:ReadRecord" error="IGNORE">  <!--检查协议是否已存在-->
                  <Arg name="SqlCmd" value="ChkAgrInf"/>
               </Exec>
               <If condition="~RetCod=-2">
                  <Set>RspCod=910213</Set>
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$ActFlg!=0">
                     <Set>RspMsg=非对公账户不得解约</Set>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910226</Set>
                     <Return/>
                  </If>
               </ElseIf>
               <Else>
                  <Return/>
               </Else>

               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetPBnkNo"/>
               </Exec>

               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetWorkDt"/>
               </Exec>

               <Set>EntDat=$WorkDt</Set>
               <!--向人行发送协议验证请求-->
               <Exec func="PUB:GetPubSeqNoCircle">
                  <Arg name="SeqNam" value="TIP:VCSeq"/>
                  <Arg name="SeqCnd" value="VCSeq"/>
                  <Arg name="Len" value="8"/>
               </Exec>

               <Set>VCSeq=$SelVal</Set>
               <Set>SOrgCd=$PBnkNo</Set><!--发起机构代码-->
               <Set>EntDat=$WorkDt</Set><!--委托日期-->
               <Set>VCFlag=1</Set><!--验证撤销标志-->
               <Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <!--zy for test-->
               <!--Exec func="PUB:CallThirdOther" error="IGNORE">
               <Arg name="HTxnCd" value="918830"/>
               <Arg name="ObjSvr" value="MMQMTIP1"/>
               </Exec>
               <If condition="~RetCod=3">
               <Set>RspCod=910699</Set>
               <Set>RspMsg=$AddWord</Set>
               <Return/>
               </If-->
               <Set>RspCod=000000</Set>
               <Set>MsgTyp=N</Set>
               <Set>CnlDat=STRCAT($ActDat,GETDATETIME(HHMISS))</Set>
               <Exec func="PUB:ExecSql">  <!--将协议解约-->
                  <Arg name="SqlCmd" value="DelAgrInf"/>
               </Exec>
               <Set>Status=1</Set>
               <Goto>Call915880</Goto>
               <Break/>
            </Case>
            <Case value="4">  <!--查询协议-->
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetAgrInf"/>
               </Exec>
               <Return/>
            </Case>
            <Case value="5">  <!--三方协议模糊查询-->
               <If condition="ISNULL($OrgCod)">
                  <Set>OrgCod=A</Set>
               </If>
               <If condition="ISNULL($TCusId)">
                  <Set>TCusId=B</Set>
               </If>
               <If condition="ISNULL($AgrNo)">
                  <Set>AgrNo=C</Set>
               </If>
               <If condition="ISNULL($ActNo)">
                  <Set>ActNo=D</Set>
               </If>
               <If condition="ISNULL($ONodNo)">
                  <Set>ONodNo=E</Set>
               </If>
               <If condition="ISNULL($VrySts)">
                  <Set>VrySts=F</Set>
               </If>
 
               <Exec func="PUB:MultiQuery">
                  <Arg name="SqlCmd" value="GetAgrInf2"/>
               </Exec>
               <Return/>
            </Case>
            <Case value="6">  <!--删除三方协议-->
               <!--授权检查-->
               <Exec func="PUB:AddAuthReason">
                  <Arg name="AthCod" value="50" />
                  <Arg name="AthMsg" value="915120" />
               </Exec>
 
               <Exec  func="PUB:CheckLocalAuth" >
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>

               <Set>OTlrId=$TlrId</Set>
               <!--状态为未验证、验证失败才能删除-->
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="ChkStaSts"/>
               </Exec>
               <Set>TlrId=$OTlrId</Set>
               <If condition="~RetCod=-2">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910213</Set>
                  <Set>RspMsg=该协议不存在</Set>
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$VrySts=1">
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=该协议已验证通过，不允许删除</Set>
                     <Return/>
                  </If>
                  <Else>
                     <If condition ="$Status=1">
                        <Set>MsgTyp=E</Set>
                        <Set>RspCod=910699</Set>
                        <Set>RspMsg=该协议已经无效，无须删除</Set>
                        <Return/>                     
                     </If>
                  </Else>
               </ElseIf>
               <Else>
                  <Return/>
               </Else>
  
               <Exec func="PUB:ExecSql" error="IGNORE"><!--删除第三方协议-->
                  <Arg name="SqlCmd" value="DelThdPro"/>
               </Exec>
               <Goto>Call915880</Goto>
            </Case>
            <Default>
               <Return/>
            </Default>
         </Switch>
 
         <Label>Call915880</Label>
         <!--重新设置请求类型和授权级别-->
         <Set>TIATyp=T</Set>
         <Set>AthLvl=00</Set>
         <!--产生非会计流水-->
         <Exec  func="PUB:GetLogNo"/>
         <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,交易柜员:,$TlrId)</Set>
         <Exec func="PUB:CallHostOther">
            <Arg name="TxnCod" value="915880" />
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>
         <Set>RspCod=000000</Set>

      </FlowCtrl>
   </Transaction>


   <!--Modified By zhq_BoCom00031148_20080128_记录验证结果-->
   <!--Modified By zhq_BoCom00041319_20080707-->
   <!--Modified By zhq_BoCom00047053_20080902-->
   <!--Modified By zhq_BoCom00050337_20081017-->
   <!--Modified by sundx at 20090330 for cq61739 -->
   <!--modified by sundx at 20090715 for cq76417 国库v2.1-->
   <Transaction code="915110" desc="人行验证协议">
      <DynSentence name="ChkAgrInf">   <!--根据征收机关号、编号检查协议是否存在-->
         <Sentence>
            SELECT ActNo AcNo ,ActFlg,ActSeq AS ActSqn,ActNam,BrkNo 
            FROM tipcusagr 
            WHERE OrgCod='%s' AND AgrNo='%s' AND Status='0' 
            FOR UPDATE
         </Sentence>
         <Fields>OrgCod|AgrNo|</Fields>
      </DynSentence>
      
      <DynSentence name="GetBrkNo">   <!--根据清算行行号查询分行号-->
         <Sentence>
            SELECT BrkNo FROM tipbrkinf WHERE PBnkNo='%s'  AND RknFlg='1' FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      
      <DynSentence name="UpdVrySts">   <!--当验证不成功的时候，根据验证结果更新验证状态和验证附言-->
         <Sentence>
            UPDATE tipcusagr SET VrySts='%s',AddWord='%s'  WHERE TCusId='%s'  AND OrgCod='%s'  AND AgrNo='%s'  AND Status='0'
         </Sentence>
         <Fields>VrySts|RspMsg|TCusId|OrgCod|AgrNo|</Fields>
      </DynSentence>
      
      <!--Added By zhq_BoCom00041319_20080707-->
      <DynSentence name="UpdVryRec">   <!--当验证成功的时候，根据验证结果更新验证状态,验证附言和登记时间-->
         <!--Modified By zhq_BoCom00047053_20080902-->
         <!--Sentence>
            UPDATE tipcusagr SET VrySts='%s',AddWord='%s',RecTm='%s'  WHERE TCusId='%s'  AND OrgCod='%s'  AND AgrNo='%s'  AND Status='0'
         </Sentence>
         <Fields>VrySts|RspMsg|RecTm|TCusId|OrgCod|AgrNo|</Fields-->
         
         <Sentence>
            UPDATE tipcusagr 
            SET VrySts='%s',AddWord='%s',RecTm='%s'  
            WHERE TCusId='%s'  AND OrgCod='%s'  AND AgrNo='%s'  AND Status='0' AND VrySts !='1'
         </Sentence>
         <Fields>VrySts|RspMsg|RecTm|TCusId|OrgCod|AgrNo|</Fields>
      </DynSentence>

      <DynSentence name="InsVrySts">   <!--记录验证结果-->
         <Sentence>
            INSERT INTO tipvryjnl VALUES('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')
         </Sentence>
         <Fields>WrkDat|FTxnTm|MsgId|OrgCod|TCusId|AgrNo|PBnkNo|ActNo|ActNam|POBkCd|VryInfo|</Fields>
      </DynSentence>

      <FlowCtrl>
         <Quote name="Init"/>
         <Set>OOrgCd=$SOrgCd</Set>
         <Set>OEntDt=$EntDat</Set>
         <Set>OVCSeq=$VCSeq</Set>
         <Set>FTxnTm=GETDATETIME()</Set>
         <Set>RecTm=STRCAT($ActDat,GETDATETIME(HHMISS))</Set>
         
         <!--检查前置三方协议有效性-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkAgrInf"/>
         </Exec>
         <If condition="~RetCod!=0">
            <If condition="~RetCod=-1">
               <Set>RspMsg=数据库操作错误</Set>
               <Return/>
            </If>
            <ElseIf condition="~RetCod=-2">
               <Set>RspCod=910213</Set>
               <Set>RspMsg=征收机关代码或协议编号不存在</Set>
               <Set>VrySts=2</Set>
               <Quote name="InsTipSts"/><!--记录验证结果-->
               <If condition="~RetCod!=0"> <!--防止由于SQL语句出错而覆盖RspCod和RspMsg-->
                  <Set>RspCod=910213</Set>
                  <Set>RspMsg=征收机关代码或协议编号不存在</Set>
               </If>
               <Return/>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
         </If>
         
         <If condition="IS_NOEQUAL_STRING($ActNo,$AcNo)">
            <Set>RspCod=910218</Set>
            <Set>RspMsg=验证失败，银行账号不一致</Set>
            <Set>VrySts=2</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="UpdVrySts"/>
            </Exec>
            <Quote name="InsTipSts"/><!--记录验证结果-->
            <If condition="~RetCod!=0"> <!--防止由于SQL语句出错而覆盖RspCod和RspMsg-->
               <Set>RspCod=910218</Set>
               <Set>RspMsg=验证失败，银行账号不一致</Set>
            </If>
            <Return/>
         </If>

         <!--Modified by sundx at 20090715 for cq76417 国库2.1错误码细分 付款行号不存在-->
         <!--收款人帐号合法性检查-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetBrkNo"/>
         </Exec>
         <If condition="~RetCod=-2">
         	  <Set>RspCod=910214</Set>
            <Set>RspMsg=验证失败，付款行行号不存在或错误</Set>
            <Set>VrySts=2</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="UpdVrySts"/>
            </Exec>
            <Quote name="InsTipSts"/><!--记录验证结果-->
            <If condition="~RetCod!=0"> <!--防止由于SQL语句出错而覆盖RspCod和RspMsg-->
               <Set>RspCod=910214</Set>
               <Set>RspMsg=验证失败，付款行行号不存在或错误</Set>
            </If>
            <Return/>
         </If>
         <ElseIf condition="~RetCod!=0">
         	  <Set>RspCod=910699</Set>
            <Set>RspMsg=数据库错误</Set>
            <Return/>
         </ElseIf>
                  	  
         <Exec func="PUB:GetVirtualTeller">
            <Arg name="TxnCnl" value="TIP"/>
            <Arg name="CnlSub" value="$BrkNo"/>
         </Exec>
         <If condition="$ActFlg=0"><!--对公-->
            <Set>TTxnCd=109000</Set>
            <Set>OActNo=$ActNo</Set>
            <Set>OActNam=$ActNam</Set>
            <Exec func="PUB:CallHostOther"> <!--上主机CD账户信息查询-->
               <Arg name="HTxnCd" value="109000" />  <!--主机交易码 -->
               <Arg name="ObjSvr" value="SHSTPUB1" /><!--主机目标服务器 -->
            </Exec>
            <If condition="$MsgTyp!=N">
                <If condition="IS_EQUAL_STRING($HRspCd,SC6002)">       <!--Added By zy_BoCom00054579_20081212-->
					<Set>RspCod=910699</Set>
                	<Set>RspMsg=电子柜员不存在</Set>
               		<Set>VrySts=2</Set>                	            		
            	</If>
            	<Else>
               		<Set>RspCod=910699</Set>
               		<Set>RspMsg=账号验证失败</Set>
               		<Set>VrySts=2</Set>
               	</Else>
            </If>
            <Else>
               <If condition="$ActSts=T">
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=账号为销户计息</Set>
                  <Set>VrySts=2</Set>
               </If>
               <ElseIf condition="$ActSts=C">
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=账号为销户</Set>
                  <Set>VrySts=2</Set>
               </ElseIf>
               <ElseIf condition="$ActSts=I">
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=账号为不动户</Set>
                  <Set>VrySts=2</Set>
               </ElseIf>
               <Else>
                  <If condition="SUBSTR($AStsW,2,1)=1">
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=账号暂封状态</Set>
                     <Set>VrySts=2</Set>
                  </If>
                  <ElseIf condition="SUBSTR($AStsW,3,1)=1">
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=账号冻结状态</Set>
                     <Set>VrySts=2</Set>
                  </ElseIf>
                  <!--协议验证不比较户名yjd,20060114
                  <ElseIf condition="IS_NOEQUAL_STRING($ActNam,$OActNam)">
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=户名验证失败</Set>
                  <Set>VrySts=2</Set>
                  </ElseIf>
                  -->
                  <Else>
                     <Set>RspMsg=验证成功</Set>
                     <Set>VrySts=1</Set>
                  </Else>
               </Else>
            </Else>
         </If>
         <Else><!--对私-->
            <Set>CcyCod=CNY</Set>
            <If condition="$ActFlg=2">
               <Set>ActTyp=4</Set>
            </If>
            <ElseIf condition="$ActFlg=3">
               <Set>ActTyp=2</Set>
            </ElseIf>
            <ElseIf condition="$ActFlg=4">
               <Set>ActTyp=1</Set>
            </ElseIf>
            <Else>  <!--账卡标志(ActFlg)不属于0,2,3,4中的任一种-->
               <Set>RspMsg=账卡标志不在设定范围内</Set>
               <Return/>
            </Else>
            
            <Set>TTxnCd=476520</Set>
            <Exec func="PUB:CallHostOther">
               <Arg name="HTxnCd" value="476520" />  <!--主机交易码 -->
               <Arg name="ObjSvr" value="SHSTPUB1" /><!--主机目标服务器 -->
            </Exec>
            <If condition="$MsgTyp!=N">
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号验证失败</Set>
               <Set>VrySts=2</Set>
            </If>
            <Else>
               <If condition="$ActSts=0">
                  <Set>RspMsg=验证成功</Set>
                  <Set>VrySts=1</Set>
               </If>
               <Else>
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=账户状态不正常</Set>
                  <Set>VrySts=2</Set>
               </Else>
            </Else>
         </Else>
         
         <Set>RspCod1=$RspCod</Set>
         <Set>RspMsg1=$RspMsg</Set>
         <!--如果验证成功同时还需要更新登记时间为验证的时间-->
         <If condition="IS_EQUAL_STRING($VrySts,1)">
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="UpdVryRec"/>
            </Exec>
         </If>
         <Else>
            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="UpdVrySts"/>
            </Exec>
         </Else>
         <!--Modified by zhq_BoCom00050337_20081017-->
         <If condition="~RetCod!=0"><!--防止由于SQL语句出错而覆盖RspCod和RspMsg-->
            <Set>RspCod=$RspCod1</Set>
            <Set>RspMsg=$RspMsg1</Set>
         </If>
         
         <Quote name="InsTipSts"/> <!--记录验证结果-->
         <Quote name="GetSeq"/> <!--此处的MsgId已经被更改-->
      </FlowCtrl>
   </Transaction>

   <!--Modified By zhq_BoCom00041319_20080707-->
   <!--Modified By zhq_BoCom00047053_20080902-->
   <Transaction code="918830" desc="向税务发起协议验证">
      <DynSentence name="ChkAgrInf">   <!--根据征收机关号、纳税人代码检查协议是否存在-->
         <Sentence>
            SELECT *
            FROM tipcusagr
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND Status='0'
            FOR READ ONLY
         </Sentence>
         <Fields>TCusId|OrgCod|</Fields>
      </DynSentence>
      
      <DynSentence name="GetPBnkNo">   <!--查询付款行号-->
         <Sentence>
            SELECT PBnkNo
            FROM tipbrkinf
            WHERE BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      
      <DynSentence name="GetWorkDt">
         <Sentence>
            SELECT WorkDt FROM  tipsyssts
         </Sentence>
      </DynSentence>
      
      <DynSentence name="UpdVrySts">  <!--当验证失败时,根据验证结果更新协议验证状态和验证附言-->
         <Sentence>
            UPDATE tipcusagr
            SET VrySts='%s',AddWord='%s'
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND Status='0'
         </Sentence>
         <Fields>VrySts|AddWord|TCusId|OrgCod|</Fields>
      </DynSentence>
      
      <!--Added By zhq_BoCom00041319_20080707-->
      <DynSentence name="UpdVryRec">  <!--当验证成功时,根据验证结果更新协议验证状态,验证附言和登记时间-->
         <!--Modified By zhq_BoCom00047053_20080902-->
         <!--Sentence>
            UPDATE tipcusagr
            SET VrySts='%s',AddWord='%s',RecTm='%s'
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND Status='0'
         </Sentence>
         <Fields>VrySts|AddWord|RecTm|TCusId|OrgCod|</Fields-->
         
         <Sentence>
            UPDATE tipcusagr
            SET VrySts='%s',AddWord='%s',RecTm='%s'
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND Status='0' AND VrySts !='1'
         </Sentence>
         <Fields>VrySts|AddWord|RecTm|TCusId|OrgCod|</Fields>         
      </DynSentence>


      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查前置协议是否存在-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkAgrInf"/>
         </Exec>

         <!--查询付款行行号-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>

         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetWorkDt"/>
         </Exec>

         <!--向人行发送协议验证请求-->
         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="TIP:VCSeq"/>
            <Arg name="SeqCnd" value="VCSeq"/>
            <Arg name="Len" value="8"/>
         </Exec>

         <Set>VCSeq=$SelVal</Set>
         <Set>SOrgCd=$PBnkNo</Set>
         <Set>EntDat=$WorkDt</Set>
         <Set>VCFlag=0</Set>
         <Set>RecTm=STRCAT($ActDat,GETDATETIME(HHMISS))</Set>
         <Quote name="GetSeq"/>
         <Set>MsgRef=$MsgId</Set>
 
         <Exec func="PUB:CallThirdOther">
            <Arg name="HTxnCod" value="918830"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="~RetCod=3">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=$AddWord</Set>
         </If>
         <Else>
            <If condition="$Result=0">
               <Set>VrySts=1</Set>
            </If>
            <Else>
               <Set>VrySts=2</Set>
            </Else>
         </Else>
         
         <Exec func="PUB:IsExistNode" error="IGNORE">
            <Arg name="FieldName" value="AddWord"/>
         </Exec>
         <If condition="~RetCod=0">
            <Set>AddWord=  </Set>
         </If>

         <If condition="IS_EQUAL_STRING($VrySts,1)">   <!--当验证成功时,根据验证结果更新协议验证状态,验证附言和登记时间-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdVryRec"/>
            </Exec>
         </If>
         <Else>                                        <!--当验证失败时,根据验证结果更新协议验证状态和验证附言-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdVrySts"/>
            </Exec>
         </Else>
 
      </FlowCtrl>
   </Transaction>


   <Transaction code="915841" desc="差错处理嵌套查询">
      <DynSentence name="GetTxnInf">   <!--查询登记薄记录信息-->
         <Sentence>
            SELECT ActDat,ActNo,TxnAmt,PayMod,PayTyp,BilSts,ChkSts,RknSts,TTpNm
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="GetTtpRec">   <!--查询税种信息-->
         <Sentence>
            SELECT TaxTNm,TaxTyp,TTpAmt,TaxBDt,TaxEDt
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--授权检查-->
         <Exec func="PUB:AddAuthReason" >
            <Arg name="AthCod" value="50" />
            <Arg name="AthMsg" value="915841" />
         </Exec>
         <Exec  func="PUB:CheckLocalAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>


         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>
         <Exec func="PUB:QueryInGroup">
            <Arg name="SqlCmd" value="GetTtpRec"/>
            <Arg name="RecordName" value="TtpRec"/>
         </Exec>
      </FlowCtrl>
   </Transaction>



   <Transaction code="915849" desc="差错处理人工抹账">
      <DynSentence name="GetTxnInf">   <!--查询登记薄记录信息-->  <!-- modified by lyj 20090729 CQ76186 -->
         <Sentence>
            SELECT BilSts,ChkSts,HTxnSt,ActDat OActDt,TlrId OTlrId,LogNo,PayMod,CBrkNo BrkNo
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf2">   <!--根据前置流水号在主机流水表查询原主机交易码和原前置交易码-->
         <Sentence>
            SELECT HTxnCd,TTxnCd
            FROM tiptxnjnl
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdHTxnSt1">   <!--根据前置流水号更新人行账务登记薄中的主机交易状态和交易状态为已冲正-->
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='C',BilSts='C'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdHTxnSt2">   <!--根据前置流水号更新主机流水表中的主机交易状态为已冲正-->
         <Sentence>
            UPDATE tiptxnjnl
            SET HTxnSt='C',TxnSts='C'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查流水是否存在-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>

        <!--Modified by sundx at 20090710 for cq76186-->
         <Set>BrNo=$BrkNo</Set>          <!--取国库关联行为记账分行号-->
         <!--Quote name="GetBrkCTL"/-->  <!--根据网点号取分行号-->

         <!--Quote name="ChkNodNo"/-->  <!--检查网点是否国库关联行的账务中心-->
         
         <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心，拒绝交易</Set>
            <Return/>
         </If>
         <!--Modified by sundx at 20090710 for cq76186-->

         <!--检查原交易缴款模式-->
         <If condition="AND(IS_NOEQUAL_STRING($PayMod,0),IS_NOEQUAL_STRING($PayMod,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非人行发起的交易，不能用该交易抹账</Set>
            <Return/>
         </If>

         <!--检查核对状态-->
         <If condition="AND(IS_EQUAL_STRING($BilSts,1),OR(IS_EQUAL_STRING($ChkSts,0),IS_EQUAL_STRING($ChkSts,1)))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=该交易未核对或已核对成功，不能抹账</Set>
            <Return/>
         </If>

         <!--检查主机交易状态-->
         <If condition="AND(IS_NOEQUAL_STRING($HTxnSt,S),IS_NOEQUAL_STRING($HTxnSt,U),IS_NOEQUAL_STRING($HTxnSt,T))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=主机交易失败或原交易已抹账，无须抹账</Set>
            <Return/>
         </If>

         <!--检查原交易会计日期-->
         <If condition="IS_NOEQUAL_STRING($ActDat,$OActDt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910607</Set>
            <Set>RspMsg=原交易非当天账务，不能抹账</Set>
            <Return/>
         </If>

         <!--检查柜员-->
         <!--If condition="$TlrId!=$OTlrId">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910608</Set>
         <Set>RspMsg=非原交易柜员，不能抹账</Set>
         <Return/>
         </If-->

         <!--根据前置流水号在主机流水表中查询原主机交易码和原前置交易码-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTxnInf2"/>
         </Exec>
         <Set>TlrId=$OTlrId</Set>
         <Set>HTxnCd=STRCAT(SUBSTR($HTxnCd,1,5),9)</Set>
         <Set>TTxnCd=STRCAT(SUBSTR($TTxnCd,1,5),9)</Set>
         <Set>TIATyp=C</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
            <Arg name="HTxnCd" value="959999"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod=-1"><!--主机超时-->
            <Set>RspCod=910605</Set>
            <Set>RspMsg=主机抹账超时,请继续抹账</Set>
            <Return/>
         </If>
         <ElseIf condition="OR(IS_EQUAL_STRING(~RetCod,-10),IS_EQUAL_STRING(~RetCod,-2))"><!--未发送或系统错误-->
            <Set>RspCod=910606</Set>
            <Set>RspMsg=主机抹账失败,请继续抹账</Set>
            <Return/>
         </ElseIf>
         <ElseIf condition="~RetCod=3"> <!--抹账失败-->
            <If condition="OR(IS_EQUAL_STRING($HRspCd,AG8001),IS_EQUAL_STRING($HRspCd,AG8981),IS_EQUAL_STRING($HRspCd,SC6129),IS_EQUAL_STRING($HRspCd,SC6034))"> <!--认为抹账成功-->
               <Set>HTxnSt=C</Set>
               <Set>TxnSts=C</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdHTxnSt1"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdHTxnSt2"/>
               </Exec>
               <Set>MsgTyp=N</Set>
               <Set>RspCod=000000</Set><!--如果主机流水不存在,或者原交易已被抹  返回前端成功 以便前端恢复票面-->
            </If>
            <Else>
               <Return/>
            </Else>
         </ElseIf>
         <ElseIf condition="~RetCod=0"> <!--成功-->
            <Set>HTxnSt=C</Set>
            <Set>TxnSts=C</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdHTxnSt1"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdHTxnSt2"/>
            </Exec>
         </ElseIf>
      </FlowCtrl>
   </Transaction>



   <Transaction code="915840" desc="差错处理人工冲账">
      <DynSentence name="GetTxnInf">   <!--查询登记薄记录信息-->
         <Sentence>
            SELECT BilSts,ChkSts,ActDat OActDt,ActNo OActNo,TxnAmt OTxnAt,PayTyp,ActSqn,CBrkNo BrkNo
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">   <!--更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET BilSts='%s',LogNo='%s'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>BilSts|LogNo|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查流水是否存在-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>

         <!--Modified by sundx at 20090710 for cq76186-->
         <Set>BrNo=$BrkNo</Set>          <!--取国库关联行为记账分行号-->
         <!--Quote name="GetBrkCTL"/-->  <!--根据网点号取分行号-->

         <!--Quote name="ChkNodNo"/-->  <!--检查网点是否国库关联行的账务中心-->
         
         <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心，拒绝交易</Set>
            <Return/>
         </If>
         <!--Modified by sundx at 20090710 for cq76186-->

         <!--检查交易状态-->
         <If condition="$BilSts!=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原交易不成功，不能冲账</Set>
            <Return/>
         </If>

         <!--检查核对标志-->
         <If condition="OR(IS_EQUAL_STRING($ChkSts,0),IS_EQUAL_STRING($ChkSts,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=该交易未核对或已核对成功，不能冲账</Set>
            <Return/>
         </If>

         <!--检查原交易会计日期-->
         <If condition="IS_EQUAL_STRING($ActDat,$OActDt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910609</Set>
            <Set>RspMsg=原交易为当天账务，不能冲账</Set>
            <Return/>
         </If>

         <!--检查缴款模式和缴款类型-->
         <If condition="$PayTyp=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原交易为柜台现金交易，不能冲账</Set>
            <Return/>
         </If>

         <!--检查账号是否一致-->
         <If condition="IS_NOEQUAL_STRING($ActNo,$OActNo)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=账号与原交易账号不一致</Set>
            <Return/>
         </If>

         <!--检查金额是否一致-->
         <If condition="IS_NOEQUAL_STRING($TxnAmt,$OTxnAt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=金额与原交易金额不一致</Set>
            <Return/>
         </If>

         <!--登记主机流水表-->
         <Exec func="PUB:GetLogNo"/>
         <Set>HTxnCd=915840</Set>
         <Set>FTxnTm=GETDATETIME()</Set>
         <Set>FRspCd=000000</Set>
         <Set>CcyCod=CNY</Set>
         <Set>ItgTyp=1</Set>
         <Set>TxnAtr= </Set>
         <Set>MstChk=1</Set>
         <Set>RecTyp=4</Set>
         <Exec func="PUB:InsertJournal"/>

         <!--向主机提交冲账交易-->
         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <Set>Smr=财税关库行核对错账</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE">   <!--主机冲账-->
            <Arg name="HTxnCd" value="915840"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

         <Switch expression="~RetCod">
            <Case value="-10">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="T"/>
               </Exec>
               <Set>BilSts=T</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请抹账</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="S"/>
               </Exec>
               <Set>BilSts=5</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知主机错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>



   <Transaction code="915847" desc="差错处理人工冲账复核">
      <DynSentence name="GetTxnInf">   <!--查询登记薄记录信息-->
         <Sentence>
            SELECT BilSts,ActNo OActNo,TxnAmt OTxnAt,LogNo OLogNo,ActSqn,ActNam,CBrkNo BrkNo
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf2">   <!--查询主机流水表信息-->
         <Sentence>
            SELECT HLogNo OHLogNo,TTxnCd OTTxnCd,TckNo OTckNo
            FROM tiptxnjnl
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnJnl">   <!--更新主机交易流水-->
         <Sentence>
            UPDATE tiptxnjnl
            SET Status='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>Status|OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">   <!--更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET BilSts='%s'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>BilSts|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查流水是否存在-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>

         <!--Modified by sundx at 20090710 for cq76186-->
         <Set>BrNo=$BrkNo</Set>          <!--取国库关联行为记账分行号-->
         <!--Quote name="GetBrkCTL"/-->  <!--根据网点号取分行号-->

         <!--Quote name="ChkNodNo"/-->  <!--检查网点是否国库关联行的账务中心-->
         
         <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心，拒绝交易</Set>
            <Return/>
         </If>
         <!--Modified by sundx at 20090710 for cq76186-->

         <!--检查账号是否一致-->
         <If condition="IS_NOEQUAL_STRING($ActNo,$OActNo)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=账号与原交易账号不一致</Set>
            <Return/>
         </If>

         <!--检查金额是否一致-->
         <If condition="IS_NOEQUAL_STRING($TxnAmt,$OTxnAt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=金额与原交易金额不一致</Set>
            <Return/>
         </If>

         <!--检查交易状态-->
         <If condition="$BilSts!=5">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原交易非冲账待复核状态，不能进行复核</Set>
            <Return/>
         </If>

         <!--向主机提交冲账复核交易-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf2"/>
         </Exec>
         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <Set>Smr=财税关库行核对错账</Set>
         <Exec func="PUB:GetLogNo"/>
         <Exec func="PUB:CallHostOther" error="IGNORE">   <!--主机冲账复核-->
            <Arg name="HTxnCd" value="915847"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

         <Switch expression="~RetCod">
            <Case value="-10">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请查询</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Set>Status=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnJnl"/>
               </Exec>
               <Set>BilSts=6</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>



   <Transaction code="915860" desc="差错处理人工挂帐">
      <DynSentence name="GetTxnInf">   <!--查询登记薄记录信息-->
         <Sentence>
            SELECT BilSts,ChkSts,ActDat OActDt,TxnAmt OTxnAt,ActSqn DAcSqn,ActNo,CBrkNo BrkNo
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">   <!--更新人行账务登记薄  新增需更新的挂账类型字段-->
         <Sentence>
            UPDATE tiptxnbok
            SET BilSts='%s',LogNo='%s',CclTyp='%s'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>BilSts|LogNo|CclTyp|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查流水是否存在-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>

         <!--Modified by sundx at 20090710 for cq76186-->
         
         <!--Quote name="GetBrkCTL"/-->  <!--根据网点号取分行号-->

         <!--Quote name="ChkNodNo"/-->  <!--检查网点是否国库关联行的账务中心-->
         
         <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心，拒绝交易</Set>
            <Return/>
         </If>
         <!--Modified by sundx at 20090710 for cq76186-->

         <!--检查交易状态-->
         <If condition="$BilSts!=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原交易不成功，不能挂账</Set>
            <Return/>
         </If>

         <!--检查核对标志-->
         <If condition="OR(IS_EQUAL_STRING($ChkSts,0),IS_EQUAL_STRING($ChkSts,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=该交易未核对或已核对成功，不能挂账</Set>
            <Return/>
         </If>

         <!--检查原交易会计日期-->
         <!--If condition="IS_EQUAL_STRING($ActDat,$OActDt)">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910610</Set>
         <Set>RspMsg=原交易为当天账务，不能挂账</Set>
         <Return/>
         </If-->

         <!--检查金额是否一致-->
         <If condition="IS_NOEQUAL_STRING($TxnAmt,$OTxnAt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=金额与原交易金额不一致</Set>
            <Return/>
         </If>

         <!--登记主机流水表-->
         <Exec func="PUB:GetLogNo"/>
         <Set>HTxnCd=915860</Set>
         <Set>FTxnTm=GETDATETIME()</Set>
         <Set>FRspCd=000000</Set>
         <Set>CcyCod=CNY</Set>
         <Set>ItgTyp=1</Set>
         <Set>TxnAtr= </Set>
         <Set>MstChk=1</Set>
         <Set>RecTyp=5</Set>
         <Exec func="PUB:InsertJournal"/>
         <!--Modified by sundx at 20090710 for  cq76186-->
         <Set>NodNo=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <!--Ended by sundx at 20090710 for  cq76186-->
         <!--向主机提交挂账交易-->
         <Set>Smr=财税关库行核对错账</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE">   <!--主机挂账-->
            <Arg name="HTxnCd" value="915860"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

         <Switch expression="~RetCod">
            <Case value="-10">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="T"/>
               </Exec>
               <Set>BilSts=T</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请抹账</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="S"/>
               </Exec>
               <Set>BilSts=7</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知主机错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>



   <Transaction code="915867" desc="差错处理人工挂帐复核">
      <DynSentence name="GetTxnInf">   <!--查询登记薄记录信息 新增挂账类型CclTyp-->
         <Sentence>
            SELECT BilSts,TxnAmt OTxnAt,LogNo OLogNo,ActSqn DAcSqn,CclTyp OClTyp,CBrkNo BrkNo
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf2">   <!--查询主机流水表信息-->
         <Sentence>
            SELECT HLogNo OHLogNo,TTxnCd OTTxnCd,TckNo OTckNo
            FROM tiptxnjnl
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnJnl">   <!--更新主机交易流水-->
         <Sentence>
            UPDATE tiptxnjnl
            SET Status='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>Status|OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">   <!--更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET BilSts='%s'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>BilSts|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查流水是否存在-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>

         <!--Modified by sundx at 20090710 for cq76186-->
         <Set>BrNo=$BrkNo</Set>          <!--取国库关联行为记账分行号-->
         <!--Quote name="GetBrkCTL"/-->  <!--根据网点号取分行号-->

         <!--Quote name="ChkNodNo"/-->  <!--检查网点是否国库关联行的账务中心-->
         
         <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心，拒绝交易</Set>
            <Return/>
         </If>
         <!--Modified by sundx at 20090710 for cq76186-->

         <!--检查金额是否一致-->
         <If condition="IS_NOEQUAL_STRING($TxnAmt,$OTxnAt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=金额与原交易金额不一致</Set>
            <Return/>
         </If>

         <!--检查挂账类型是否一致-->
         <If condition="IS_NOEQUAL_STRING($CclTyp,$OClTyp)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=挂账类型不一致</Set>
            <Return/>
         </If>

         <!--检查交易状态-->
         <If condition="$BilSts!=7">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原交易非挂账待复核状态，不能进行复核</Set>
            <Return/>
         </If>
         
         <!--Modified by sundx at 20090710 for  cq76186-->
         <Set>NodNo=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <!--Ended by sundx at 20090710 for  cq76186-->

         <!--向主机提交挂账复核交易-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf2"/>
         </Exec>
         <Exec func="PUB:GetLogNo"/>
         <Set>Smr=财税关库行核对错账</Set>
         <Exec func="PUB:CallHostOther" error="IGNORE">   <!--主机挂账复核-->
            <Arg name="HTxnCd" value="915867"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

         <Switch expression="~RetCod">
            <Case value="-10">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请查询</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Set>Status=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnJnl"/>
               </Exec>
               <Set>BilSts=8</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>



   <Transaction code="915865" desc="冲账挂帐差错处理抹账查询">
      <DynSentence name="GetTxnInf">   <!--根据会计流水号查询记录状态和交易流水号-->
         <Sentence>
            SELECT HTxnSt,LogNo,TraNo,OrgCod,EntDat,TxnAmt,RecTyp
            FROM tiptxnjnl
            WHERE TckNo='%s'
            AND ActDat='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TckNo|ActDat|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf2">   <!--根据会计流水号查询记录状态和交易流水号-->
         <Sentence>
            SELECT BilSts,ChkSts,RknSts,PayMod,PayTyp,ActNo
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnJnl">   <!--更新主机流水信息-->
         <Sentence>
            UPDATE tiptxnjnl
            SET HTxnSt='%s',TckNo='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|OTckNo|OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">   <!--更新人行账务登记薄信息-->
         <Sentence>
            UPDATE tiptxnbok
            SET BilSts='%s',LogNo='%s'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>BilSts|OLogNo|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--授权检查-->
         <Exec func="PUB:AddAuthReason" >
            <Arg name="AthCod" value="50" />
            <Arg name="AthMsg" value="915869" />
         </Exec>
         <Exec  func="PUB:CheckLocalAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>
         <!--根据会计流水号查询交易状态和交易流水号-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <ElseIf condition="OR(IS_EQUAL_STRING($HTxnSt,F),IS_EQUAL_STRING($HTxnSt,C),IS_EQUAL_STRING($HTxnSt,X),IS_EQUAL_STRING($HTxnSt,D),IS_EQUAL_STRING($HTxnSt,E))">
            <Set>RspCod=910602</Set>
            <Return/>
         </ElseIf>
         <ElseIf condition="$HTxnSt=S">
            <If condition="AND(IS_NOEQUAL_STRING($RecTyp,4),IS_NOEQUAL_STRING($RecTyp,5))">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=非冲账或挂账状态,不能做冲账挂账抹账</Set>
            </If>
            <Exec func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="GetTxnInf2"/>
            </Exec>
            <!--If condition="AND(IS_NOEQUAL_STRING($BilSts,5),IS_NOEQUAL_STRING($BilSts,6),IS_NOEQUAL_STRING($BilSts,7),IS_NOEQUAL_STRING($BilSts,8))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非冲账或挂账状态,不能做冲账挂账抹账</Set>
            <Return/>
            </If-->
            <Return/>
         </ElseIf>
         <Else>
            <Set>OTckNo=$TckNo</Set>
            <Exec func="PUB:CallHostOther">
               <Arg name="HTxnCd" value="458970"/>
               <Arg name="ObjSvr" value="SHSTPUB1"/>
            </Exec>
            <If condition="AND(IS_NOEQUAL_STRING(~RetCod,0),IS_NOEQUAL_STRING(~RetCod,3))">
               <Return/>
            </If>
            <If condition="$MsgTyp!=N">
               <Switch expression="$HRspCd">
                  <Case value="AG8001"/>
                  <Case value="AG8981"/>
                  <Case value="SC6129">
                     <Set>HTxnSt=F</Set>
                     <Break/>
                  </Case>
                  <Case value="SC6034">
                     <Set>HTxnSt=C</Set>
                     <Break/>
                  </Case>
                  <Default>
                     <Continue/>
                  </Default>
               </Switch>
            </If>
            <Else>
               <If condition="$CrcSts!=Y">
                  <Set>HTxnSt=S</Set>
               </If>
               <Else>
                  <Set>HTxnSt=C</Set>
                  <Exec func="PUB:ExecSql">
                     <Arg name="SqlCmd" value="UpdTxnJnl"/>
                  </Exec>
               </Else>
            </Else>
            <If conditon="$HTxnSt=S">
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnJnl"/>
               </Exec>
               <Switch expression="$RecTyp">
                  <Case value="4">
                     <Set>BilSts=5</Set>
                     <Break/>
                  </Case>
                  <Case value="5">
                     <Set>BilSts=7</Set>
                     <Break/>
                  </Case>
                  <Default>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=非冲账或挂账状态,不能做冲账挂账抹账</Set>
                  </Default>
               </Switch>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Set>LogNo=OLogNo</Set>
            </If>
            <Else>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910602</Set>
               <Set>RspMsg=无须抹账</Set>
               <Return/>
            </Else>
         </Else>
      </FlowCtrl>
   </Transaction>



   <Transaction code="915869" desc="冲账挂帐差错处理抹账">
      <DynSentence name="GetTxnInf1">   <!--根据前置流水号在主机流水表查询原交易信息-->
         <Sentence>
            SELECT HTxnSt,TlrId OTlrId,HTxnCd,TTxnCd,TckNo OTckNo,HLogNo OHLogNo,TTxnCd OTTxnCd
            FROM tiptxnjnl
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf2">   <!--根据前置流水号在人行账务登记薄查询记录状态-->
         <Sentence>
            SELECT RspSts,ChkSts,OrgCod,EntDat,TraNo
            FROM tiptxnbok
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="GetOLogNo">   <!--抹账成功，查询原正交易流水号-->
         <Sentence>
            SELECT LogNo OLogNo
            FROM tiptxnjnl
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            AND HTxnSt='S'
            AND (RecTyp IN ('0','1','2'))
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdHTxnSt1">   <!--根据前置流水号更新人行账务登记薄中的主机交易状态和交易状态为已冲正-->
         <Sentence>
            UPDATE tiptxnbok
            SET BilSts='1',LogNo='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>OLogNo|LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdHTxnSt2">   <!--根据前置流水号更新主机流水表中的主机交易状态为已冲正-->
         <Sentence>
            UPDATE tiptxnjnl
            SET HTxnSt='C',TxnSts='C'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->

         <Quote name="ChkNodNo"/>  <!--检查网点是否国库关联行的账务中心-->

         <!--检查主机交易状态、原交易柜员、回执状态-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTxnInf1"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <ElseIf condition="OR(IS_EQUAL_STRING($HTxnSt,F),IS_EQUAL_STRING($HTxnSt,C),IS_EQUAL_STRING($HTxnSt,X),IS_EQUAL_STRING($HTxnSt,D),IS_EQUAL_STRING($HTxnSt,E))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910602</Set>
            <Return/>
         </ElseIf>
         <ElseIf condition="$HTxnSt=S">
            <If condition="$TlrId!=$OTlrId">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910604</Set>
               <Return/>
            </If>
            <Exec func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="GetTxnInf2"/>
            </Exec>
            <!--
            <If condition="$RspSts=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910603</Set>
            <Return/>
            </If>
            -->
            <If condition="$ChkSts=1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910618</Set>
               <Set>RspMsg=已对账成功，不能抹账</Set>
               <Return/>
            </If>
         </ElseIf>


         <!--根据前置流水号在主机流水表中查询原主机交易码和原前置交易码-->
         <Set>HTxnCd=STRCAT(SUBSTR($HTxnCd,1,5),9)</Set>
         <Set>TTxnCd=$HTxnCd</Set>
         <!--Set>TTxnCd=STRCAT(SUBSTR($TTxnCd,1,5),9)</Set-->
         <Set>TIATyp=C</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
            <Arg name="HTxnCd" value="959999"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod=-1"><!--主机超时-->
            <Set>RspCod=910605</Set>
            <Set>RspMsg=主机抹账超时,请继续抹账</Set>
            <Return/>
         </If>
         <ElseIf condition="OR(IS_EQUAL_STRING(~RetCod,-10),IS_EQUAL_STRING(~RetCod,-2))"><!--未发送或系统错误-->
            <Set>RspCod=910606</Set>
            <Set>RspMsg=主机抹账失败,请继续抹账</Set>
            <Return/>
         </ElseIf>
         <ElseIf condition="~RetCod=3"> <!--抹账失败-->
            <If condition="OR(IS_EQUAL_STRING($HRspCd,AG8001),IS_EQUAL_STRING($HRspCd,AG8981),IS_EQUAL_STRING($HRspCd,SC6129),IS_EQUAL_STRING($HRspCd,SC6034))"> <!--认为抹账成功-->
               <Set>HTxnSt=C</Set>
               <Set>TxnSts=C</Set>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetOLogNo"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdHTxnSt1"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdHTxnSt2"/>
               </Exec>
               <Set>MsgTyp=N</Set>
               <Set>RspCod=000000</Set>
            </If>
            <Else>
               <Return/>
            </Else>
         </ElseIf>
         <ElseIf condition="~RetCod=0"> <!--成功-->
            <Set>HTxnSt=C</Set>
            <Set>TxnSts=C</Set>
            <Exec func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="GetOLogNo"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdHTxnSt1"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdHTxnSt2"/>
            </Exec>
         </ElseIf>
      </FlowCtrl>
   </Transaction>


   <Transaction code="918711" desc="查询征收机关信息">
      <DynSentence name="GetEffDat">   <!--查询征收机关生效日期-->
         <Sentence>
            SELECT OrgNam,EffDat
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetEffDat"/>
         </Exec>

         <!--检查是否已到生效日期-->
         <If condition="INTCMP($ActDat,1,$EffDat)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910611</Set>
            <Set>RspMsg=未到生效日期，征收机关暂不可用</Set>
         </If>
      </FlowCtrl>
   </Transaction>


   <Transaction code="918712" desc="查询国库信息">
      <DynSentence name="GetEffDat">   <!--查询国库生效日期-->
         <Sentence>
            SELECT TreNam,EffDat
            FROM tiptreinf
            WHERE TreCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TreCod|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetEffDat"/>
         </Exec>

         <!--检查是否已到生效日期-->
         <If condition="INTCMP($ActDat,1,$EffDat)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910218</Set>
            <Set>RspMsg=未到生效日期，国库暂不可用</Set>
         </If>
      </FlowCtrl>
   </Transaction>


   <Transaction code="918713" desc="查询税种信息">
      <DynSentence name="GetOrgTyp">   <!--查询征收机关类型和生效日期-->
         <Sentence>
            SELECT OrgTyp,EffDat
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <DynSentence name="GetTaxTNm">   <!--查询税种名称-->
         <Sentence>
            SELECT TaxTNm,EffDat
            FROM tiptaxtyp
            WHERE TaxTCd='%s'
            AND OrgTyp='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TaxTCd|OrgTyp|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetOrgTyp"/>
         </Exec>

         <!--检查是否已到生效日期-->
         <If condition="INTCMP($ActDat,1,$EffDat)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910611</Set>
            <Set>RspMsg=未到生效日期，征收机关暂不可用</Set>
         </If>

         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTaxTNm"/>
         </Exec>

         <!--检查是否已到生效日期-->
         <If condition="INTCMP($ActDat,1,$EffDat)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=未到生效日期，税种暂不可用</Set>
         </If>
      </FlowCtrl>
   </Transaction>


   <Transaction code="918714" desc="查询税目信息">
      <DynSentence name="GetOrgTyp">   <!--查询征收机关类型和生效日期-->
         <Sentence>
            SELECT OrgTyp,EffDat
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <DynSentence name="GetTaxSbNm">   <!--查询税目名称-->
         <Sentence>
            SELECT TaxSbNm,EffDat
            FROM tiptaxsbj
            WHERE TaxSbCd='%s'
            AND OrgTyp='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TaxSbCd|OrgTyp|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>TxnTm=GETDATETIME(HHMISS)</Set><!--解决业务受理通知书打印时间为0的问题-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetOrgTyp"/>
         </Exec>

         <!--检查是否已到生效日期-->
         <If condition="INTCMP($ActDat,1,$EffDat)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910611</Set>
            <Set>RspMsg=未到生效日期，征收机关暂不可用</Set>
         </If>

         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTaxSbNm"/>
         </Exec>

         <!--检查是否已到生效日期-->
         <If condition="INTCMP($ActDat,1,$EffDat)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=未到生效日期，税目暂不可用</Set>
         </If>
      </FlowCtrl>
   </Transaction>


   <Transaction code="918715" desc="嵌套查询账户名称">
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>TTxnCd=109000</Set>
         <Exec func="PUB:CallHostOther"> <!--上主机CD账户信息查询-->
            <Arg name="HTxnCd" value="109000" />  <!--主机交易码 -->
            <Arg name="ObjSvr" value="SHSTPUB1" /><!--主机目标服务器 -->
         </Exec>
         <If condition="$MsgTyp=E">
            <Set>RspCod=$HRspCd</Set>
            <Return/>
         </If>
         <ElseIf condition="$MsgTyp=N">
            <If condition="$ActSts=T">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号为销户计息</Set>
            </If>
            <ElseIf condition="$ActSts=C">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号为销户</Set>
            </ElseIf>
            <ElseIf condition="$ActSts=I">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号为不动户</Set>
            </ElseIf>
            <ElseIf condition="SUBSTR($AStsW,2,1)=1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号暂封状态</Set>
            </ElseIf>
            <ElseIf condition="SUBSTR($AStsW,3,1)=1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=账号冻结状态</Set>
            </ElseIf>
         </ElseIf>
      </FlowCtrl>
   </Transaction>

   <!--Added By zhq_20080430_BoCom00036729_查询内部账户名称-->
   <Transaction code="918719" desc="嵌套查询内部账户名称">
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>TTxnCd=098065</Set>
         <Set>ITM=SUBSTR($ActNo,9,5)</Set>
         <Set>SEQ=SUBSTR($ActNo,14,5)</Set>

         <Exec func="PUB:CallHostOther">          <!--上主机查询内部账户信息-->
            <Arg name="HTxnCd" value="098065" />  <!--主机交易码 -->
            <Arg name="ObjSvr" value="SHSTPUB1" /><!--主机目标服务器 -->
         </Exec>
         <If condition="$MsgTyp!=N">
            <Set>RspCod=$HRspCd</Set>
            <Return/>
         </If>
         <Else>
            <If condition="IS_NOEQUAL_STRING($RspRst,Y)">
               <If condition="IS_EQUAL_STRING($RspRst,T)">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=内部账户状态暂封</Set>
                  <Return/>
               </If>
               <ElseIf condition="IS_EQUAL_STRING($RspRst,N)">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=内部账户状态已关闭</Set>
                  <Return/>
               </ElseIf>
               <Else>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=内部帐号状态出错</Set>
                  <Return/>
               </Else>
            </If>
         </Else>
      </FlowCtrl>
   </Transaction>

   <Transaction code="915857" desc="银行端缴款核对">
      <DynSentence name="GetBilSts">   <!--查询人行账务登记薄中的记录状态-->
         <Sentence>
            SELECT BilSts,ActDat,AddWord,RspSts
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>ROOT.OrgCod|ROOT.EntDat|ROOT.TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdRspSts">   <!--更新人行账务登记薄中的回执状态-->
         <Sentence>
            UPDATE tiptxnbok
            SET RspSts='%s',RspDat='%s'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>RspSts|WrkDat|ROOT.OrgCod|ROOT.EntDat|ROOT.TraNo|</Fields>
      </DynSentence>
      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查本包明细数是否为0-->
         <If condition="INTCMP($CrPkNm,4,0)">
            <Set>Cnt=1</Set>
            <While condition="INTCMP($Cnt,2,$CrPkNm)">
               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.BnkCmp3113_,$Cnt,.OrgCod)"/>
                  <Arg name="DestName"  value="ROOT.OrgCod"/>
               </Exec>
               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.BnkCmp3113_,$Cnt,.EntDat)"/>
                  <Arg name="DestName"  value="ROOT.EntDat"/>
               </Exec>
               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.BnkCmp3113_,$Cnt,.TraNo)"/>
                  <Arg name="DestName"  value="ROOT.TraNo"/>
               </Exec>
               <Exec func="PUB:GetValue">
                  <Arg name="SourName"  value="STRCAT(ROOT.BnkCmp3113_,$Cnt,.TaxVID)"/>
                  <Arg name="DestName"  value="ROOT.TaxVID"/>
               </Exec>

               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="GetBilSts"/>
               </Exec>

               <If condition="~RetCod=-2">
                  <Quote name="GetSeq"/>
                  <Set>MsgRef=$MsgId</Set>
                  <Set>SrcNod=601100000010</Set>
                  <Set>DstNod=100000000000</Set>
                  <Set>RspCod=24030</Set>
                  <Set>AddWord=银行没有该缴税信息</Set>
                  <Exec func="PUB:CallThirdOther" error="IGNORE">
                     <Arg name="TxnCod"  value="2108"/>
                     <Arg name="ObjSvr"  value="MMQMTIP1"/>
                  </Exec>
               </If>

               <ElseIf condition="~RetCod=0">
                  <If condition="$BilSts=1">
                     <Quote name="GetSeq"/>
                     <Set>MsgRef=$MsgId</Set>
                     <Set>SrcNod=601100000010</Set>
                     <Set>DstNod=100000000000</Set>
                     <Exec func="PUB:CallThirdOther" error="IGNORE">
                        <Arg name="TxnCod"  value="2108"/>
                        <Arg name="ObjSvr"  value="MMQMTIP1"/>
                     </Exec>

                     <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                        <Set>RspSts=1</Set>
                     </If>
                     <Else>
                        <Set>RspSts=2</Set>
                     </Else>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdRspSts"/>
                     </Exec>
                  </If>

                  <ElseIf condition="AND(IS_NOEQUAL_STRING($BilSts,0),IS_NOEQUAL_STRING($BilSts,9))">
                     <Quote name="GetSeq"/>
                     <Set>MsgRef=$MsgId</Set>
                     <Set>SrcNod=601100000010</Set>
                     <Set>DstNod=100000000000</Set>
                     <Set>RspCod=24020</Set>
                     <Exec func="PUB:CallThirdOther" error="IGNORE">
                        <Arg name="TxnCod"  value="2108"/>
                        <Arg name="ObjSvr"  value="MMQMTIP1"/>
                     </Exec>

                     <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                        <Set>RspSts=1</Set>
                     </If>
                     <Else>
                        <Set>RspSts=2</Set>
                     </Else>
                     <Set>RspNum=ADD($RspNum,1)</Set>
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="UpdRspSts"/>
                     </Exec>
                  </ElseIf>
               </ElseIf>

               <Set>Cnt=ADD($Cnt,1)</Set>
            </While>
         </If>
      </FlowCtrl>
   </Transaction>


   <Transaction code="915858" desc="明细包核对">
      <DynSentence name="SndBatBok1">
         <Sentence>
            Update tipbatbok
            SET SChkSt='1'
            WHERE (OrgCod,EntDat,SPckNo) IN
            (SELECT bok.OrgCod,bok.EntDat,bok.SPckNo
            FROM tipbatbok bok,tipbatchk chk
            WHERE bok.OrgCod=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.SPckNo=chk.OPckNo
            AND bok.PBnkNo=chk.PBnkNo
            AND bok.WrkDat=chk.ChkDat
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='1'
            )
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>
      <DynSentence name="SndBatBok2">
         <Sentence>
            Update tipbatbok
            SET SChkSt='2'
            WHERE (OrgCod,EntDat,SPckNo) NOT IN
            (SELECT bok.OrgCod,bok.EntDat,bok.SPckNo
            FROM tipbatbok bok,tipbatchk chk
            WHERE bok.OrgCod=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.SPckNo=chk.OPckNo
            AND bok.PBnkNo=chk.PBnkNo
            AND bok.WrkDat=chk.ChkDat
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='1'
            )
            AND PBnkNo='%s'
            AND WrkDat='%s'
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|PBnkNo|ChkDat|</Fields>
      </DynSentence>
      <DynSentence name="SndBatChk1">
         <Sentence>
            Update tipbatchk
            SET ChkSts='1'
            WHERE (PBnkNo,ChkDat,PackNo,OOrgCd,OEntDt,OPckNo,OPckTp) IN
            (SELECT chk.PBnkNo,chk.ChkDat,chk.PackNo,chk.OOrgCd,chk.OEntDt,chk.OPckNo,chk.OPckTp
            FROM tipbatbok bok,tipbatchk chk
            WHERE bok.OrgCod=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.SPckNo=chk.OPckNo
            AND bok.PBnkNo=chk.PBnkNo
            AND bok.WrkDat=chk.ChkDat
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='1'
            )
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>
      <DynSentence name="SndBatChk2">
         <Sentence>
            Update tipbatchk
            SET ChkSts='2'
            WHERE (PBnkNo,ChkDat,PackNo,OOrgCd,OEntDt,OPckNo,OPckTp) NOT IN
            (SELECT chk.PBnkNo,chk.ChkDat,chk.PackNo,chk.OOrgCd,chk.OEntDt,chk.OPckNo,chk.OPckTp
            FROM tipbatbok bok,tipbatchk chk
            WHERE bok.OrgCod=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.SPckNo=chk.OPckNo
            AND bok.PBnkNo=chk.PBnkNo
            AND bok.WrkDat=chk.ChkDat
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='1'
            )
            AND PBnkNo='%s'
            AND ChkDat='%s'
            AND PackNo='%s'
            AND OPckTp='1'
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>

      <DynSentence name="RcvBatBok1">
         <Sentence>
            Update tipbatbok
            SET RChkSt='1'
            WHERE (OrgCod,EntDat,SPckNo) IN
            (SELECT bok.OrgCod,bok.EntDat,bok.SPckNo
            FROM tipbatbok bok,tipbatchk chk
            WHERE bok.PBnkNo=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.RPckNo=chk.OPckNo
            AND bok.PBnkNo=chk.PBnkNo
            AND bok.RspDat=chk.ChkDat
            AND bok.Status='5'
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='2'
            )
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>
      <DynSentence name="RcvBatBok2">
         <Sentence>
            Update tipbatbok
            SET RChkSt='2'
            WHERE (OrgCod,EntDat,SPckNo) NOT IN
            (SELECT bok.OrgCod,bok.EntDat,bok.SPckNo
            FROM tipbatbok bok,tipbatchk chk
            WHERE bok.PBnkNo=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.RPckNo=chk.OPckNo
            AND bok.PBnkNo=chk.PBnkNo
            AND bok.RspDat=chk.ChkDat
            AND bok.Status='5'
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='2'
            )
            AND PBnkNo='%s'
            AND RspDat='%s'
            AND (Status IN ('4','5'))
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|PBnkNo|ChkDat|</Fields>
      </DynSentence>
      <DynSentence name="RcvBatChk1">
         <Sentence>
            Update tipbatchk
            SET ChkSts='1'
            WHERE (PBnkNo,ChkDat,PackNo,OOrgCd,OEntDt,OPckNo,OPckTp) IN
            (SELECT chk.PBnkNo,chk.ChkDat,chk.PackNo,chk.OOrgCd,chk.OEntDt,chk.OPckNo,chk.OPckTp
            FROM tipbatbok bok,tipbatchk chk
            WHERE bok.PBnkNo=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.RPckNo=chk.OPckNo
            AND bok.PBnkNo=chk.PBnkNo
            AND bok.RspDat=chk.ChkDat
            AND bok.Status='5'
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='2'
            )
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>
      <DynSentence name="RcvBatChk2">
         <Sentence>
            Update tipbatchk
            SET ChkSts='2'
            WHERE (PBnkNo,ChkDat,PackNo,OOrgCd,OEntDt,OPckNo,OPckTp) NOT IN
            (SELECT chk.PBnkNo,chk.ChkDat,chk.PackNo,chk.OOrgCd,chk.OEntDt,chk.OPckNo,chk.OPckTp
            FROM tipbatbok bok,tipbatchk chk
            WHERE bok.PBnkNo=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.RPckNo=chk.OPckNo
            AND bok.PBnkNo=chk.PBnkNo
            AND bok.RspDat=chk.ChkDat
            AND bok.Status='5'
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='2'
            )
            AND PBnkNo='%s'
            AND ChkDat='%s'
            AND PackNo='%s'
            AND OPckTp='2'
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>

      <DynSentence name="StpBatBok1">
         <Sentence>
            Update tipstpbok
            SET ChkSts='1'
            WHERE (OrgCod,EntDat,StopNo) IN
            (SELECT bok.OrgCod,bok.EntDat,bok.StopNo
            FROM tipstpbok bok,tipbatchk chk
            WHERE bok.OrgCod=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.StopNo=chk.OPckNo
            AND bok.RspDat=chk.ChkDat
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='3'
            )
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>
      <DynSentence name="StpBatBok2">
         <Sentence>
            Update tipstpbok
            SET ChkSts='2'
            WHERE (OrgCod,EntDat,StopNo) NOT IN
            (SELECT bok.OrgCod,bok.EntDat,bok.StopNo
            FROM tipstpbok bok,tipbatchk chk
            WHERE bok.OrgCod=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.StopNo=chk.OPckNo
            AND bok.RspDat=chk.ChkDat
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='3'
            )
            AND RspDat='%s'
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|ChkDat|</Fields>
      </DynSentence>
      <DynSentence name="StpBatChk1">
         <Sentence>
            Update tipbatchk
            SET ChkSts='1'
            WHERE (PBnkNo,ChkDat,PackNo,OOrgCd,OEntDt,OPckNo,OPckTp) IN
            (SELECT chk.PBnkNo,chk.ChkDat,chk.PackNo,chk.OOrgCd,chk.OEntDt,chk.OPckNo,chk.OPckTp
            FROM tipstpbok bok,tipbatchk chk
            WHERE bok.OrgCod=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.StopNo=chk.OPckNo
            AND bok.RspDat=chk.ChkDat
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='3'
            )
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>
      <DynSentence name="StpBatChk2">
         <Sentence>
            Update tipbatchk
            SET ChkSts='2'
            WHERE (PBnkNo,ChkDat,PackNo,OOrgCd,OEntDt,OPckNo,OPckTp) NOT IN
            (SELECT chk.PBnkNo,chk.ChkDat,chk.PackNo,chk.OOrgCd,chk.OEntDt,chk.OPckNo,chk.OPckTp
            FROM tipstpbok bok,tipbatchk chk
            WHERE bok.OrgCod=chk.OOrgCd
            AND bok.EntDat=chk.OEntDt
            AND bok.StopNo=chk.OPckNo
            AND bok.RspDat=chk.ChkDat
            AND chk.PBnkNo='%s'
            AND chk.ChkDat='%s'
            AND chk.PackNo='%s'
            AND chk.OPckTp='3'
            )
            AND PBnkNo='%s'
            AND ChkDat='%s'
            AND PackNo='%s'
            AND OPckTp='3'
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>

      <DynSentence name="SndBokRec2">   <!--发送包银行多-->
         <Sentence>
            SELECT WrkDat,OrgCod,EntDat,SPckNo
            FROM tipbatbok
            WHERE PBnkNo='%s'
            AND WrkDat='%s'
            AND SChkSt='2'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|ChkDat|</Fields>
      </DynSentence>

      <DynSentence name="SndChkRec2">   <!--发送包人行多-->
         <Sentence>
            SELECT PBnkNo,OOrgCd,OEntDt,OPckNo
            FROM tipbatchk
            WHERE PBnkNo='%s'
            AND ChkDat='%s'
            AND PackNo='%s'
            AND OPckTp='1'
            AND ChkSts='2'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>

      <DynSentence name="RcvBokRec2">   <!--接收包银行多-->
         <Sentence>
            SELECT WrkDat,OrgCod,EntDat,RPckNo,SPckNo,AllNum,AllAmt,SucNum,SucAmt
            FROM tipbatbok
            WHERE PBnkNo='%s'
            AND RspDat='%s'
            AND (Status IN ('4','5'))
            AND RChkSt='2'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|ChkDat|</Fields>
      </DynSentence>

      <DynSentence name="QryTxnBok">   <!--查询包交易明细-->
         <Sentence>
            SELECT TraNo,TxnAmt,TaxVID,ActDat,BilSts,HRspCd RspCod
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND SPckNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|SPckNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdStatus1">   <!--更新批量包状态-->
         <Sentence>
            UPDATE tipbatbok
            SET Status='5'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND SPckNo='%s'
         </Sentence>
         <Fields>ROOT.OrgCod|ROOT.EntDat|ROOT.SPckNo|</Fields>
      </DynSentence>

      <DynSentence name="RcvChkRec2">   <!--接收包人行多-->
         <Sentence>
            SELECT PBnkNo,OOrgCd,OEntDt,OPckNo
            FROM tipbatchk
            WHERE PBnkNo='%s'
            AND ChkDat='%s'
            AND PackNo='%s'
            AND OPckTp='2'
            AND ChkSts='2'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdStatus2">   <!--更新批量包状态-->
         <Sentence>
            UPDATE tipbatbok
            SET Status='5'
            WHERE PBnkNo='%s'
            AND EntDat='%s'
            AND RPckNo='%s'
            AND RspDat='%s'
         </Sentence>
         <Fields>ROOT.OOrgCd|ROOT.OEntDt|ROOT.OPckNo|ChkDat|</Fields>
      </DynSentence>

      <DynSentence name="StpBokRec2">   <!--止付包银行多-->
         <Sentence>
            SELECT OrgCod,EntDat,StopNo,StopTyp,OEntDat,OPackNo,OTraNo,StpAsw,AddWord
            FROM tipstpbok
            WHERE RspDat='%s'
            AND ChkSts='2'
            FOR READ ONLY
         </Sentence>
         <Fields>ChkDat|</Fields>
      </DynSentence>

      <DynSentence name="StpChkRec2">   <!--止付包人行多-->
         <Sentence>
            SELECT PBnkNo,OOrgCd,OEntDt,OPckNo
            FROM tipbatchk
            WHERE PBnkNo='%s'
            AND ChkDat='%s'
            AND PackNo='%s'
            AND OPckTp='3'
            AND ChkSts='2'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|ChkDat|PackNo|</Fields>
      </DynSentence>

      <DynSentence name="GetBrkNo">   <!--查询分行号-->
         <Sentence>
            SELECT BrkNo
            FROM tipbrkinf
            WHERE PBnkNo='%s'
            AND RknFlg='1'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>


      <Attributes>
         <Attribute name="noresponse" value="1"/>
         <Attribute name="nodatabase" value="2"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <!--将节点导入人行批量包对帐表-->
         <Exec func="PUB:InsertRecordByGroup">
            <Arg name="TableName" value="tipbatchk"/>
            <Arg name="GroupName" value="BnkCmp3112"/>
            <Arg name="FldLst" value="PBnkNo|ChkDat|PackNo|ChkMod|"/>
         </Exec>
         <Exec func="PUB:CommitWork"/>

         <!--发送包核对-->
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="SndBatBok1"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="SndBatBok2"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="SndBatChk1"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="SndBatChk2"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <!--接收包核对-->
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="RcvBatBok1"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="RcvBatBok2"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="RcvBatChk1"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="RcvBatChk2"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <!--止付包核对-->
         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="StpBatBok1"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="StpBatBok2"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="StpBatChk1"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="StpBatChk2"/>
         </Exec>
         <If condition="~RetCod=-1">
            <Return/>
         </If>
         <Else>
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </Else>

         <Exec func="PUB:CommitWork"/>

         <Exec func="PUB:ReadRecord">   <!--获取分行号-->
            <Arg name="SqlCmd" value="GetBrkNo"/>
         </Exec>

         <!--发送包核对差错处理-->
         <Exec func="PUB:OpenCursor">   <!--发送包银行多-->
            <Arg name="SqlCmd" value="SndBokRec2"/>
         </Exec>

         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Return/>
            </ElseIf>

            <Set>Content=STRCAT(发送包银行多|,人行对账日期:,$ROOT.WrkDat,|,征收机关:,$ROOT.OrgCod,|,委托日期:,$ROOT.EntDat,|,发送包流水号:,$ROOT.SPckNo,|)</Set>
            <Set>RecLvl=2</Set>
            <Quote name="BusNty"/>
         </While>
         <Exec func="PUB:CloseCursor"/>


         <Exec func="PUB:OpenCursor">   <!--发送包人行多-->
            <Arg name="SqlCmd" value="SndChkRec2"/>
         </Exec>

         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Return/>
            </ElseIf>

            <Set>OrgCod=$OOrgCd</Set>
            <Set>EntDat=$WrkDat</Set>
            <Set>OMsgNo=3102</Set>
            <Quote name="GetSeq"/>
            <Set>MsgRef=$MsgId</Set>
            <Exec func="PUB:CallThirdOther">   <!--包明细重发请求-->
               <Arg name="TxnCod"  value="9111"/>
               <Arg name="ObjSvr"  value="SMQMTIP2"/>
            </Exec>
         </While>
         <Exec func="PUB:CloseCursor"/>


         <!--接收包核对差错处理-->
         <Exec func="PUB:OpenCursor">   <!--接收包银行多-->
            <Arg name="SqlCmd" value="RcvBokRec2"/>
         </Exec>

         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Return/>
            </ElseIf>

            <!--发送报文预定义字段-->
            <Exec  func="PUB:QueryInGroup">
               <Arg name="SqlCmd" value="QryTxnBok"/>
               <Arg name="RecordName" value="BatchReturn2102"/>
            </Exec>
            <Set>RspCod=90000</Set>
            <Quote name="GetSeq"/>
            <Set>MsgRef=$MsgId</Set>
            <Exec func="PUB:CallThirdOther">   <!--包明细重发请求-->
               <Arg name="TxnCod"  value="2102"/>
               <Arg name="ObjSvr"  value="SMQMTIP2"/>
            </Exec>
            <If condition="$TRspCd=000000">
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdStatus1"/>
               </Exec>
            </If>
         </While>
         <Exec func="PUB:CloseCursor"/>


         <Exec func="PUB:OpenCursor">   <!--接收包人行多-->
            <Arg name="SqlCmd" value="RcvChkRec2"/>
         </Exec>

         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Return/>
            </ElseIf>

            <Exec func="PUB:ExecSql" error="IGNORE">
               <Arg name="SqlCmd" value="UpdStatus2"/>
            </Exec>
            <If condition="~RetCod=-2">
               <Set>Content=STRCAT(接收包人行多，并且在银行没有对应的接收包|,人行对账日期:,$ROOT.WrkDat,|,征收机关:,$ROOT.OOrgCd,|,委托日期:,$ROOT.OEntDt,|,接收包流水号:,$ROOT.OPckNo,|)</Set>
               <Set>RecLvl=2</Set>
               <Quote name="BusNty"/>
            </If>
         </While>
         <Exec func="PUB:CloseCursor"/>


         <!--止付包核对差错处理-->
         <Exec func="PUB:OpenCursor">   <!--止付包银行多-->
            <Arg name="SqlCmd" value="StpBokRec2"/>
         </Exec>

         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Return/>
            </ElseIf>

            <!--发送报文预定义字段-->
            <Quote name="GetSeq"/>
            <Set>MsgRef=$MsgId</Set>
            <Exec func="PUB:CallThirdOther">   <!--包明细重发请求-->
               <Arg name="TxnCod"  value="2123"/>
               <Arg name="ObjSvr"  value="SMQMTIP2"/>
            </Exec>
         </While>
         <Exec func="PUB:CloseCursor"/>


         <Exec func="PUB:OpenCursor">   <!--止付包人行多-->
            <Arg name="SqlCmd" value="StpChkRec2"/>
         </Exec>

         <While>
            <Exec func="PUB:FetchCursor" error="IGNORE"/><!--取下一笔记录关闭游标-->
            <If condition="~RetCod=100">
               <Break/>
            </If>
            <ElseIf condition="~RetCod=-1">
               <Return/>
            </ElseIf>

            <Set>Content=STRCAT(止付包人行多|,人行对账日期:,$ROOT.WrkDat,|,征收机关:,$ROOT.OOrgCd,|,委托日期:,$ROOT.OEntDt,|,止付申请序号:,$ROOT.OPckNo,|)</Set>
            <Set>RecLvl=2</Set>
            <Quote name="BusNty"/>
         </While>
         <Exec func="PUB:CloseCursor"/>
      </FlowCtrl>
   </Transaction>


   <Transaction code="915808" desc="银行端缴款回执确认">
      <DynSentence name="GetMsgRef">   <!--根据报文参考号查询原缴税记录信息-->
         <Sentence>
            SELECT PBnkNo,TaxVID,OrgCod,EntDat,TraNo,ActDat,BilSts,AddWord,RspNum
            FROM tiptxnbok
            WHERE MsgRef='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>MsgRef|</Fields>
      </DynSentence>
      <DynSentence name="UpdRspSts">   <!--根据报文参考号更新人行账务登记薄中的回执状态和新报文参考号-->
         <Sentence>
            UPDATE tiptxnbok
            SET RspSts='%s',MsgRef='%s',RspNum=cast(cast(RspNum as smallint)+1 as char(1))
            WHERE MsgRef='%s'
         </Sentence>
         <Fields>RspSts|MsgRef|OMsgRef|</Fields>
      </DynSentence>
      <Attributes>
         <Attribute name="noresponse" value="1"/>
      </Attributes>
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="$Result=90000">
            <Return/>
         </If>
         <Else>
            <Set>RspLmt=@BCFG.TipRspLmt</Set>

            <Set>OAddWord=$AddWord</Set>

            <Exec func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="GetMsgRef"/>
            </Exec>

            <If condition="INTCMP($RspNum,5,$RspLmt)">
               <Set>Content=STRCAT(银行端缴款回执――银行端缴款回执确认错误|征收机关代码:,$OrgCod,|委托日期:,$EntDat,|人行交易流水号:,$TraNo,|失败原因:人行响应,$OAddWord,|)</Set>
               <Set>RecLvl=2</Set>
               <Quote name="BusNty"/>
               <Return/>
            </If>

            <If condition="$BilSts=1">
               <Set>RspCod=000000</Set>
            </If>
            <Else>
               <Set>RspCod=24020</Set>
            </Else>

            <Quote name="GetSeq"/>
            <Set>OMsgRef=$MsgRef</Set>
            <Set>MsgRef=$MsgId</Set>
            <Set>SrcNod=601100000010</Set>
            <Set>DstNod=100000000000</Set>

            <Exec func="PUB:CallThirdOther">
               <Arg name="TxnCod"  value="2108"/>
               <Arg name="ObjSvr"  value="MMQMTIP1"/>
            </Exec>

            <Set>RspSts=1</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdRspSts"/>
            </Exec>
         </Else>
      </FlowCtrl>
   </Transaction>


   <Transaction code="918840" desc="挂帐清算凭证打印">
      <DynSentence name="ChkChkBok">   <!--检查对账登记薄中的记录-->
         <Sentence>
            SELECT RknTyp,RknSts,cast(cast(PrtNum as smallint)+1 as char(2)) PrtNum,TckNo,AllAmt,SUBSTR(TckNo,1,7) ETlrId,RknDat,RBrkNo,CclNo,CActNo,DActNo,TxnCID,AllNum
            FROM tipchkbok
            WHERE RBnkNo='%s'
            AND PBnkNo='%s'
            AND ChkDat='%s'
            AND ChkOrd='%s'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <DynSentence name="GetTreInf">   <!--根据清算行行号取收款人账号和户名-->
         <Sentence>
            SELECT RAccNo,RAccNm
            FROM tiptrerkn
            WHERE RBnkNo='%s'
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetBrkInf">   <!--根据清算银行支付行号取付款人账号和户名-->
         <Sentence>
            SELECT SndAct,SndNam
            FROM tipbrkinf
            WHERE PBnkNo='%s'
            AND RknFlg='1'
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdPrtNum">   <!--打印次数加一-->
         <Sentence>
            UPDATE tipchkbok
            SET PrtNum=cast(cast(PrtNum as smallint)+1 as char(2))
            WHERE RBnkNo='%s'
            AND PBnkNo='%s'
            AND ChkDat='%s'
            AND ChkOrd='%s'
         </Sentence>
         <Fields>RBnkNo|PBnkNo|ChkDat|ChkOrd|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查对账登记薄中的记录-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkChkBok"/>
         </Exec>
         <If condition="$RknTyp!=2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910226</Set>
            <Set>RspMsg=非挂账清算，交易拒绝</Set>
            <Return/>
         </If>
         <If condition="$RknSts!=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910227</Set>
            <Set>RspMsg=清算不成功，交易拒绝</Set>
            <Return/>
         </If>

         <!--根据清算行行号取收款人账号和户名-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTreInf"/>
         </Exec>

         <!--根据清算银行支付行号取付款人账号和户名-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkInf"/>
         </Exec>

         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->

         <Set>RNodNo=STRCAT(SUBSTR($RBrkNo,1,3),800)</Set>

         <Set>Smr=STRCAT(税款入库 对账日期:,$ChkDat, 对账批次:,$ChkOrd, 对账笔数:,$AllNum)</Set>

         <!--打印次数加一-->
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdPrtNum"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--Modified by xiehongbo_BoCom00031149_20080317-->
   <!--Modified by zhq_BoCom00036694_20080415-->
   <!--Modified by zhq_BoCom00043458_20080801-->
   <!--Modified by sundx at 20090929 for cq84414 修改交易915170，新增前台打印方式-->
   <Transaction code="915170" desc="打印税票">
      <!--在以下3条非重打税票的动态语句的查询条件中添加对ActNo/OrgCod/TCusId可输入项的匹配， BoCom00031149 解宏波 20080317-->
      <DynSentence name="count1">                <!--统计笔数  非重打税票  开始/截止会计流水号(BTckNo/ETckNo)未上送-->
         <!--Modified by zhq_BoCom00043458_20080801_由于交易画面合并，所以不再区分是首打还是补打-->
         <!--Sentence>
         SELECT  COUNT(*) NUMB
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
         AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT)=0
         FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields-->

         <Sentence>
            SELECT  COUNT(*) NUMB
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND PrtNod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>

      </DynSentence>
      <DynSentence name="UpdPrtNum1">            <!--更新打印次数 非重打税票  开始/截止会计流水号(BTckNo/ETckNo)未上送-->
         <!--Modified by zhq_BoCom00043458_20080801_由于交易画面合并，所以不再区分是首打还是补打-->
         <!--Sentence>
         UPDATE tiptxnbok
         SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
         AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT)=0
         </Sentence>
         <Fields>BChkDt|EChkDt|ANBak|ANBak|OCBak|OCBak|TCIBak|TCIBak|NodNo|</Fields-->

         <Sentence>
            UPDATE tiptxnbok
            SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND PrtNod='%s'
         </Sentence>
         <Fields>BChkDt|EChkDt|ANBak|ANBak|OCBak|OCBak|TCIBak|TCIBak|NodNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnBok">             <!--查询本网点交易登记薄 非重打税票  开始/截止会计流水号(BTckNo/ETckNo)未上送-->
         <!--Modified by zhq_BoCom00036694_20080415_按照帐号(ActNo)和会计日期(ActDat)排序-->
         <!--Sentence>
         SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
         AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT)=0
         FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields-->
         
         <!--Modified by zhq_BoCom00043458_20080801_由于交易画面合并，所以不再区分是首打还是补打-->
         <!--Sentence>
         SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
         AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT)=0
         ORDER BY ActNo,ActDat
         FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields-->
         <Sentence>
            SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,RAccNm,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND PrtNod='%s'
            ORDER BY ActNo,ActDat
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>
      </DynSentence>

      <!--添加以下3条动态SQL语句： HaveTckNoCount，UpdPrtNumHaveTckNo，QryTxnBokHaveTckNo BoCom00031149 解宏波 20080317 -->
      <DynSentence name="HaveTckNoCount">        <!--统计记录个数 非重打税票  开始/截止会计流水号(BTckNo/ETckNo)已上送-->
         <!--Modified by zhq_BoCom00043458_20080801_由于交易画面合并，所以不再区分是首打还是补打-->
         <!--Sentence>
         SELECT  COUNT(*) NUMB
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (TckNo  BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT)=0
         FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields-->

         <Sentence>
            SELECT  COUNT(*) NUMB
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (TckNo  BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdPrtNumHaveTckNo">    <!--更新打印次数 非重打税票 开始/截止会计流水号(BTckNo/ETckNo)已上送-->
         <!--Modified by zhq_BoCom00043458_20080801_由于交易画面合并，所以不再区分是首打还是补打-->
         <!--Sentence>
         UPDATE tiptxnbok
         SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (TckNo  BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
         AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT)=0
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ANBak|ANBak|OCBak|OCBak|TCIBak|TCIBak|NodNo|</Fields-->

         <Sentence>
            UPDATE tiptxnbok
            SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (TckNo  BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND PrtNod='%s'
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ANBak|ANBak|OCBak|OCBak|TCIBak|TCIBak|NodNo|</Fields>

      </DynSentence>
      <DynSentence name="QryTxnBokHaveTckNo">    <!--查询本网点交易登记薄 非重打税票  开始/截止会计流水号(BTckNo/ETckNo)已上送-->
         <!--Modified by zhq_BoCom00036694_20080415_按照帐号(ActNo)和会计日期(ActDat)排序-->
         <!--Sentence>
         SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (TckNo  BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
         AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT)=0
         FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields-->

         <!--Modified by zhq_BoCom00043458_20080801_由于交易画面合并，所以不再区分是首打还是补打-->
         <!--Sentence>
         SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (TckNo  BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
         AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT)=0
         ORDER BY ActNo,ActDat
         FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields-->

         <Sentence>
            SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,RAccNm,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (TckNo  BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND PrtNod='%s'
            ORDER BY ActNo,ActDat
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>

      </DynSentence>

      <!--Marked By zhq_BoCom00043458_20080829--> 
      <!--DynSentence name="count2"-->                <!-- 统计笔数  重打税票  开始/截止会计流水号（BTckNo/ETckNo）已上送-->
         <!--Sentence>
            SELECT  COUNT(*) NUMB
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (TckNo  BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
            AND CAST(PrtNum AS SMALLINT) &gt; 0
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>
      </DynSentence-->
      
      <!--Marked By zhq_BoCom00043458_20080829-->
      <!--DynSentence name="UpdPrtNum2"-->            <!--更新打印次数 重打税票  开始/截止会计流水号（BTckNo/ETckNo）已上送-->
         <!--Sentence>
            UPDATE tiptxnbok
            SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (TckNo  BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
            AND CAST(PrtNum AS SMALLINT) &gt; 0
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ANBak|ANBak|OCBak|OCBak|TCIBak|TCIBak|NodNo|</Fields>
      </DynSentence-->
      
      <!--Marked By zhq_BoCom00043458_20080829-->
      <!--DynSentence name="count4"-->                <!--统计笔数  重打税票  开始/截止会计流水号（BTckNo/ETckNo）未上送-->
         <!--Sentence>
            SELECT COUNT(*) NUMB
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            ANd PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
            AND CAST(PrtNum AS SMALLINT) &gt; 0
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>
      </DynSentence-->
      
      <!--Marked By zhq_BoCom00043458_20080829-->
      <!--DynSentence name="UpdPrtNum4"-->            <!--更新打印次数 重打税票  开始/截止会计流水号（BTckNo/ETckNo）未上送-->
         <!--Sentence>
            UPDATE tiptxnbok
            SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
            AND CAST(PrtNum AS SMALLINT) &gt; 0
         </Sentence>
         <Fields>BChkDt|EChkDt|ANBak|ANBak|OCBak|OCBak|TCIBak|TCIBak|NodNo|</Fields>
      </DynSentence-->
 
      <!--Marked By zhq_BoCom00043458_20080829--> 
      <!--DynSentence name="QryTxnBok2"-->            <!--查询本网点交易登记薄 重打税票  开始/截止会计流水号（BTckNo/ETckNo）已上送-->
         <!--Sentence>
         SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (TckNo  BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT) &gt; 0
         FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields-->

         <!--Modified by zhq_BoCom00036694_20080415_按照帐号(ActNo)和会计日期(ActDat)排序-->
         <!--Sentence>
            SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (TckNo  BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
            AND CAST(PrtNum AS SMALLINT) &gt; 0
            ORDER BY ActNo,ActDat
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|BTckNo|ETckNo|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>

      </DynSentence-->
      <!--Marked By zhq_BoCom00043458_20080829-->
      <!--DynSentence name="QryTxnBokNoTckNo"-->      <!--查询本网点交易登记薄 重打税票  开始/截止会计流水号（BTckNo/ETckNo）未上送-->
         <!--Modified by zhq_BoCom00036694_20080415_按照帐号(ActNo)和会计日期(ActDat)排序-->
         <!--Sentence>
         SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND PayTyp='1'
         AND BilSts='1'
         AND ChkSts='1'
         AND (ChkDat BETWEEN '%s' AND '%s')
         AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
         AND CAST(PrtNum AS SMALLINT) &gt; 0
         FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields-->
         
         
         <!--Sentence>
            SELECT ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='') AND PrtNod='%s'
            AND CAST(PrtNum AS SMALLINT) &gt; 0
            ORDER BY ActNo,ActDat
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>

      </DynSentence-->
      <DynSentence name="count3">                <!--统计税种条数-->
         <Sentence>
            SELECT COUNT(*) NUMBE
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="count5">                <!--统计税种条数 换页打印-->
         <Sentence>
            SELECT COUNT(*) NUMBE
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            AND (CAST(ProjId AS SMALLINT) BETWEEN CAST('%s' AS SMALLINT) AND CAST('%s' AS SMALLINT))
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|BePjId|EdPjId|</Fields>
      </DynSentence>
      <DynSentence name="QryTtpRec">             <!--查询税种信息 仅取5笔税种-->
         <Sentence>
            SELECT TaxTNm,TaxBDt,TaxEDt,TTpAmt
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            fetch first 14 rows only
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTtpRec2">            <!--查询税种信息 税种笔数超过5笔 取全部税种-->
         <Sentence>
            SELECT TaxTNm,TaxBDt,TaxEDt,TTpAmt
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTtpRec3">            <!--查询税种信息-->
         <Sentence>
            SELECT TaxTNm,TaxBDt,TaxEDt,TTpAmt
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            AND (CAST(ProjId AS SMALLINT) BETWEEN CAST('%s' AS SMALLINT) AND CAST('%s' AS SMALLINT))
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|BePjId|EdPjId|</Fields>
      </DynSentence>
      <DynSentence name="GetOrgNam">             <!--查询征收机关名称-->
         <Sentence>
            SELECT OrgNam
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <!--由于实时扣税的时候没有国库代码，所以不再到tiptreinf中查询国库名称，改用字段RaccNm-->
      <DynSentence name="GetRBnkNm">             <!--查询收款国库（银行）名称-->
         <!--Modified By zhq_BoCom00043458_20080801_将原来打印的清算行名称的地方改为打印收款国库（银行）名称-->
         <!--Sentence>
         SELECT RBnkNm
         FROM tiptrerkn
         WHERE RBnkNo='%s'
         FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|</Fields-->

         <Sentence>
            SELECT TreNam
            FROM tiptreinf
            WHERE TreCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TreCod|</Fields>
      </DynSentence>
      <DynSentence name="GetPOBkNm">             <!--查询付款人开户银行名称-->
         <Sentence>
            SELECT OrgNam BrkNam FROM cimorgtbl WHERE OrgNo='%s' FOR READ ONLY
         </Sentence>
         <Fields>ONodNo|</Fields>
      </DynSentence>
      <DynSentence name="GetBrkNm">              <!--查询分行名称-->
         <Sentence>
            SELECT BrkNam BrkNm FROM tipbrkinf WHERE BrkNo='%s' FOR READ ONLY
         </Sentence>
         <Fields>OBrkNo|</Fields>
      </DynSentence>

      <Quote name="GetBrkSQL"/>                  <!--根据网点号取分行号-->

      <DynSentence name="WriteHead0">
         <Sentence>\n\n\n                                %s </Sentence>
         <Fields>BrkNm|</Fields>
      </DynSentence>

      <DynSentence name="WriteHead">             <!--写表头-->
         <!--                                                                                         付款名称       账号                      机关名                付行收行               书号                           小金额     大金额-->

         <!--Modified By zhq_BoCom00043458_20080801_将原来打印的清算行名称的地方改为打印收款国库（银行）名称-->
         <!--Sentence>\n\n                    %s    %s    %s   \n\n\n                                 %s   \n                  %s   \n                   %s                        %s   \n                       %s     %s   \n                         %s                                        %s \n                         %s                                     %s\n\n</Sentence>
         <Fields>Year|Month|Day|TCsNam|ActNam|ActNo|OrgNam|BrkNam|RBnkNm|TxnAmt|BokNum|CapAmt|TaxVID|</Fields-->

         <Sentence>\n\n                    %s    %s    %s   \n\n\n                                 %s   \n                  %s   \n                   %s                        %s   \n                       %s     %s   \n                         %s                                        %s \n                         %s                                     %s\n\n</Sentence>
         <Fields>Year|Month|Day|TCsNam|ActNam|ActNo|OrgNam|BrkNam|RAccNm|TxnAmt|BokNum|CapAmt|TaxVID|</Fields>
      </DynSentence>

      <DynSentence name="WriteTTP">              <!--写税种-->
         <Sentence>\n          %s        %s-%s                %s</Sentence>
         <Fields>TaxTNm|TaxBDt|TaxEDt|TTpAmt|</Fields>
      </DynSentence>

      <DynSentence name="WriteTurn">             <!--写空行-->
         <Sentence>\n</Sentence>
         <!--Fields>TaxTNm|</Fields-->
      </DynSentence>

      <DynSentence name="WriteTail">             <!--写表尾-->
         <Sentence>\n\n           %s    %s                                           %s\n\n                  %s                                                      %s\n\n\n%s</Sentence>
         <Fields>PrtNmb|ChnPag|PrtTim|TckNo|OTlrId|ChgPag|</Fields>
      </DynSentence>
      <!--Added by sundx at 20090929 for cq84414 修改交易915170，新增前台打印方式-->
      <DynSentence name="countq1">                <!--前台打印方式,统计笔数，起始以及截止前置流水号 -->
         <Sentence>
            SELECT  COUNT(*) NUMB,MIN(LogNo) BLogNo,MAX(LogNo) ELogNo
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND PrtNod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>
      </DynSentence>
      <DynSentence name="countq2">                <!--前台打印方式,统计笔数，起始以及截止前置流水号 -->
         <Sentence>
            SELECT  COUNT(*) NUMB,MAX(LogNo) ELogNo
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND LogNo &gt; '%s' AND LogNo &lt;='%s'
            AND PrtNod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|BLogNo|ELogNo|NodNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnBokQ">             <!--前台打印方式,查询本网点交易登记薄 -->
         <Sentence>
            SELECT LogNo,ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,RAccNm,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND PrtNod='%s'
            ORDER BY LogNo,ActNo,ActDat
            FETCH FIRST 1 ROWS ONLY
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|NodNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnBokQL">             <!--前台打印方式,查询本网点交易登记薄,有起始以及截止前置流水号 -->
         <Sentence>
            SELECT LogNo,ActDat,ActNo,TCusId,TCusNm,ActNam,POBkNo,OrgCod,EntDat,RAccNm,TxnAmt,TraNo,TckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND LogNo &gt; '%s' AND LogNo &lt;='%s'
            AND PrtNod='%s'
            ORDER BY LogNo,ActNo,ActDat
            FETCH FIRST 1 ROWS ONLY
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|BLogNo|ELogNo|NodNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdPrtNumq">            <!--前台打印，更新打印次数 -->
         <Sentence>
            UPDATE tiptxnbok
            SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
            WHERE PayMod IN ('0','1')
            AND PayTyp='1'
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND (ActNo='%s' OR '%s'='') AND (OrgCod='%s' OR '%s'='') AND (TCusId='%s' OR '%s'='')
            AND LogNo='%s'
            AND PrtNod='%s'
         </Sentence>
         <Fields>BChkDt|EChkDt|ActNo|ActNo|OrgCod|OrgCod|TCusId|TCusId|LogNo|NodNo|</Fields>
      </DynSentence>
      <!--Ended by sundx at 20090929 for cq84414 修改交易915170，新增前台打印方式-->
      <FlowCtrl>
         <Quote name="Init"/>
         <Quote name="GetBrkCTL"/>               <!--根据网点号取分行号-->
         <If condition="PrtTyp=2">               <!--后台打印-->
            <!--备份外部传入的输入数据，防止在中间处理的过程中将输入数据覆盖导致处理异常BoCom00031149 解宏波 20080317-->
            <Set>ANBak=$ActNo</Set>                 <!--备份帐号-->
            <Set>OCBak=$OrgCod</Set>                <!--备份机构号-->
            <Set>TCIBak=$TCusId</Set>               <!--备份纳税人代码-->
            <Set>FTxnTm=GETDATETIME()</Set>
            <Set>FilNam=STRCAT(TAXRPT,$BrkNo,$TlrId,$FTxnTm)</Set>
            <Set>PrtCnt=1</Set>
            <!--Modified By zhq_BoCom00043458_20080801_由于交易画面合并，所以不再区分是首打还是补打-->
            <!--If condition="$RptFlg=1"-->              <!--判断是否重打税票-->
            <!--授权-->
            <!--
            <Exec func="PUB:AddAuthReason" >
            <Arg name="AthCod" value="40" />
            <Arg name="AthMsg" value="915825" />
            </Exec>
            <Exec  func="PUB:CheckLocalAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1" />
            </Exec>
            -->
            
            <!--If condition="AND(ISNULL($BTckNo),ISNULL($ETckNo))">
            <Set>SqlNam=QryTxnBokNoTckNo</Set>
            <Set>UpdSql=UpdPrtNum4</Set>
            <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="count4"/>
            </Exec>
            </If-->
            <!--开始/截至会计流水号要么都输入，要么都不输入，只输入一个的时候返回输入错误-->
            <!--ElseIf condition="OR(ISNULL($BTckNo),ISNULL($ETckNo))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=会计流水号输入错误</Set>
            <Return/>
            </ElseIf>
            <Else>
            <Set>SqlNam=QryTxnBok2</Set>
            <Set>UpdSql=UpdPrtNum2</Set>
            <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="count2"/>
            </Exec>
            </Else>
            </If>
            <Else-->
            <!--新增查询条件开始/截止流水号后，需要根据开始/截止流水号是否输入做不同的处理BoCom00031149 解宏波 20080317 -->
            <!--开始/截至会计流水号都没有输入  非重打税票-->
            <If condition="AND(ISNULL($BTckNo),ISNULL($ETckNo))">
               <Set>SqlNam=QryTxnBok</Set>
               <Set>UpdSql=UpdPrtNum1</Set>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="count1"/>
               </Exec>
            </If>
            <!--开始/截至会计流水号要么都输入，要么都不输入，只输入一个的时候返回输入错误-->
            <ElseIf condition="OR(ISNULL($BTckNo),ISNULL($ETckNo))">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=会计流水号输入错误</Set>
               <Return/>
            </ElseIf>
            <Else>
               <Set>SqlNam=QryTxnBokHaveTckNo</Set>
               <Set>UpdSql=UpdPrtNumHaveTckNo</Set>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="HaveTckNoCount"/>
               </Exec>
            </Else>
            <!--/Else-->
            <If condition="$NUMB=0">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=没有要打印的税票</Set>
               <Return/>
            </If>
            <!--Set>NextPg=1</Set-->
            <Exec func="PUB:OpenCursor">
               <Arg name="SqlCmd" value="$SqlNam"/>
               <Arg name="CursorName" value="CURSOR_1"/>
            </Exec>
            <While>
               <Exec func="PUB:FetchCursor" error="IGNORE">
                  <Arg name="CursorName" value="CURSOR_1"/>
               </Exec>
               <If condition="~RetCod!=0">
                  <If condition="~RetCod=100">
                     <Break/>
                  </If>
                  <Else>
                     <Exec func="PUB:CloseCursor">
                        <Arg name="CursorName" value="CURSOR_1"/>
                     </Exec>
                     <Return/>
                  </Else>
               </If>
               <Set>Year=SUBSTR($ActDat,1,4)</Set>
               <Set>Month=SUBSTR($ActDat,5,2)</Set>
               <Set>day=SUBSTR($ActDat,7,2)</Set>
               <Set>TCsNam=STRCAT(DELBOTHSPACE($TCusNm),$TCusId)</Set>
               <Set>BokNum=STRCAT($EntDat,$TraNo)</Set>
               <Set>CapAmt=AMTTOCAP($TxnAmt)</Set>
               <Set>TxnAmt=AMTSIMPLEFMT($TxnAmt)</Set>
               <Set>PrtNum=ADD($PrtNum,1)</Set>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetOrgNam"/>
               </Exec>
               <!--Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetRBnkNm"/>
               </Exec-->
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetPOBkNm"/>
               </Exec>
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetBrkNm"/>
               </Exec>
               <Set>BrkNam=STRCAT($BrkNm,$BrkNam)</Set>
               <Set>BrkNam=ADDCHAR($BrkNam,44, ,0)</Set>
            
               <!--计算税种总笔数-->
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="count3"/>
               </Exec>
               <!--处理超过14笔的情况 换页打印-->
               <Set>PagNum=DIV($NUMBE,14)</Set>
               <If condition="MOD($NUMBE,14)!=0">
                  <Set>PagNum=ADD($PagNum,1)</Set>
               </If>
               <Set>PagNo=0</Set>
               <While condition="INTCMP($PagNo,1,$PagNum)">   <!--$PagNo<$PagNum-->
                  <If condition="$PagNo!=0">
                     <Set>TxnAmt=  </Set>
                     <Set>CapAmt=  </Set>
                  </If>
                  <!--If condition="IS_EQUAL_INT(MOD($NextPg,11),0)=0">
                  <Exec func="PUB:WriteFile">
                  <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                  <Arg name="OpenMode" value="a+"/>
                  <Arg name="PRNFMT" value="WriteTurn"/>
                  </Exec>
                  </If-->
                  <Exec func="PUB:WriteFile">
                     <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                     <Arg name="OpenMode" value="a+"/>
                     <Arg name="PRNFMT" value="WriteHead0"/>
                  </Exec>
                  <Exec func="PUB:WriteFile">
                     <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                     <Arg name="OpenMode" value="a+"/>
                     <Arg name="PRNFMT" value="WriteHead"/>
                  </Exec>
            
                  <!--处理超过5笔的情况 重打时打印出所有税种  非重打仅打印出5条税种-->
                  <!--If condition="INTCMP($NUMBE,6,5)=1">
                  <If condition="$RptFlg=1">
                  <Set>QryNam=QryTtpRec2</Set>
                  </If>
                  </If>
                  <Else>
                  <Set>QryNam=QryTtpRec</Set>
                  </Else-->
            
                  <!--写税种信息-->
                  <Set>BePjId=ADD(MUL($PagNo,14),0)</Set>     <!--起始序号-->
                  <Set>EdPjId=ADD($BePjId,13)</Set>           <!--终止序号-->
                  <Exec func="PUB:OpenCursor">
                     <Arg name="SqlCmd" value="QryTtpRec3"/>
                     <Arg name="CursorName" value="CURSOR_2"/>
                  </Exec>
                  <While>
                     <Exec func="PUB:FetchCursor" error="IGNORE">
                        <Arg name="CursorName" value="CURSOR_2"/>
                     </Exec>
                     <If condition="~RetCod!=0">
                        <If condition="~RetCod=100">
                           <Break/>
                        </If>
                        <Else>
                           <Exec func="PUB:CloseCursor">
                              <Arg name="CursorName" value="CURSOR_2"/>
                           </Exec>
                           <Return/>
                        </Else>
                     </If>
            
                     <Set>TaxTNm=ADDCHAR($TaxTNm,25, ,0)</Set>
                     <Set>TTpAmt=AMTSIMPLEFMT($TTpAmt)</Set>
                     <Exec func="PUB:WriteFile">
                        <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                        <Arg name="OpenMode" value="a+"/>
                        <Arg name="PRNFMT" value="WriteTTP"/>
                     </Exec>
                  </While>
                  <Exec func="PUB:CloseCursor">
                     <Arg name="CursorName" value="CURSOR_2"/>
                  </Exec>
                  <!--end写税种信息-->
            
                  <!--写空行-->
                  <Exec func="PUB:ReadRecord">
                     <Arg name="SqlCmd" value="count5"/>
                  </Exec>
                  <Set>TurNum=SUB(14,$NUMBE)</Set>
                  <Set>i=1</Set>
                  <While condition="INTCMP($TurNum,5,$i)">
                     <Exec func="PUB:WriteFile">
                        <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                        <Arg name="OpenMode" value="a+"/>
                        <Arg name="PRNFMT" value="WriteTurn"/>
                     </Exec>
                     <Set>i=ADD($i,1)</Set>
                  </While>
                  <!--end写空行-->
            
                  <!--写末尾-->
                  <Set>PrtNmb=STRCAT(第,$PrtNum,次打印)</Set>
                  <If condition="$PagNo!=SUB($PagNum,1)">
                     <Set>ChnPag=转下页</Set>
                  </If>
                  <Else>
                     <Set>ChnPag=      </Set>
                  </Else>
                  <Set>ChgPag= </Set>
                  <!--If condition="IS_EQUAL_INT(MOD($PrtCnt,3),0)">
                  <Set>ChgPag=\\f</Set>
                  </If-->
                  <Set>PrtTim=GETDATETIME(YYYY年MM月DD日HH时MI分)</Set>
                  <Exec func="PUB:WriteFile">
                     <Arg name="FileName" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
                     <Arg name="OpenMode" value="a+"/>
                     <Arg name="PRNFMT" value="WriteTail"/>
                  </Exec>
                  <!--end写末尾-->
                  <Set>PagNo=ADD($PagNo,1)</Set>
                  <Set>PrtCnt=ADD($PrtCnt,1)</Set>
                  <!--一页结束 换下页-->
               </While>
               <!--Set>NextPg=ADD($NextPg,1)</Set-->
               <!--一条登记簿记录结束 打下条记录-->
            </While>
            <Exec func="PUB:CloseCursor" error="IGNORE">
               <Arg name="CursorName" value="CURSOR_1"/>
            </Exec>
            
            <!--将税票文件下传网点-->
            <Set>MsgSmr=STRCAT($NodNo,税票文件)</Set>
            <Exec func="PUB:SendFileToOther">
               <Arg name="MsgTyp" value="4"/>
               <Arg name="ObjNod" value="$BrkNo"/>
               <Arg name="BusTyp" value="CM"/>
               <Arg name="AplCod" value="999999"/>
               <Arg name="FilNam" value="$FilNam"/>
               <Arg name="Summary" value="$MsgSmr"/>
               <Arg name="ObjTlr" value="$TlrId"/>
            </Exec>
            <!--
            <Exec func="PUB:SendFileToOther">
            <Arg name="MsgTyp" value="3"/>
            <Arg name="ObjNod" value="$BrkNo"/>
            <Arg name="BusTyp" value="EB"/>
            <Arg name="AplCod" value="910000"/>
            <Arg name="FilNam" value="$FilNam"/>
            <Arg name="Summary" value="$MsgSmr"/>
            <Arg name="ObjTlr" value="$TlrId"/>
            </Exec>
            
            <Exec func="PUB:CodeSwitching">
            <Arg name="DatSrc" value="TIPCSW"/>
            <Arg name="SourNam" value="BrkNo"/>
            <Arg name="DestNam" value="SRN"/>
            <Arg name="TblNam" value="Cod2SRN"/>
            </Exec>
            <Set>@MSG.SRN=$SRN</Set>
            <Exec func="PUB:CallLocal">
            <Arg name="TxnCod" value="910290" />
            <Arg name="ObjSvr" value="OFRTTIP5"/>
            </Exec>
            <If condition="~RetCod!=0">
            <Return/>
            </If>
            <Delete>@MSG.SRN</Delete>
            -->
            <!--更新税票打印次数-->
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="$UpdSql"/>
            </Exec>
            <Set>APrtNm=$NUMB</Set>
         </If>
         <Else>  <!--前台打印-->
            <!--开始/截至前置流水号要么都输入，要么都不输入，只输入一个的时候返回输入错误-->
            <If condition="AND(ISNULL($BLogNo),ISNULL($ELogNo))">
               <Set>SqlNam=QryTxnBokQ</Set>               
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="countq1"/>
               </Exec>
            </If>            
            <ElseIf condition="OR(ISNULL($BLogNo),ISNULL($ELogNo))">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=前置流水号输入错误</Set>
               <Return/>
            </ElseIf>
            <Else>
               <Set>SqlNam=QryTxnBokQL</Set>               
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="countq2"/>
               </Exec>
            </Else>
            <If condition="$NUMB=0">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=没有要打印的税票</Set>
               <Return/>
            </If>
            <Exec func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="$SqlNam"/>
            </Exec>
            <Exec func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="GetOrgNam"/>
            </Exec>
            <Set>RBnkNm=$RAccNm</Set>
            <Exec func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="GetPOBkNm"/>
            </Exec>
            <Exec func="PUB:ReadRecord">
               <Arg name="SqlCmd" value="GetBrkNm"/>
            </Exec>
            <Exec func="PUB:QueryInGroup"> <!--税种信息-->
               <Arg name="SqlCmd" value="QryTtpRec2"/>
               <Arg name="RecordName" value="TaxTypLst1008"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdPrtNumq"/>
            </Exec>
            <Set>PrtNum=ADD($PrtNum,1)</Set>
            <Set>BLogNo=$LogNo</Set>
         </Else>
      </FlowCtrl>
   </Transaction>
   
   <!--Added by sundx at 20090105 for cq46255，43458-->
   <Transaction code="915199" desc="对私打印/补打税票查询列表">
      <DynSentence name="MultiQuery">
         <Sentence>
            SELECT PayTyp,ActNo,ActSeq,TCusId,ActDat ChkDat,TraNo,TxnAmt
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND BilSts='1'
            AND ChkSts='1'
            AND PayTyp='%s'
            AND ActNo='%s'
            AND (ActDat='%s' OR '%s'='')
            AND (TCusId='%s' OR '%s'='')
            AND (ActSeq='%s' OR '%s'='')
            AND (TraNo='%s'  OR '%s'='')
            FOR READ ONLY
         </Sentence>
         <Fields>PayTyp|ActNo|ChkDat|ChkDat|TCusId|TCusId|ActSeq|ActSeq|TraNo|TraNo|</Fields>
      </DynSentence>      
      <FlowCtrl>
         <Quote name="Init"/>         
         <Exec func="PUB:MultiQuery">
            <Arg name="SqlCmd" value="MultiQuery"/>
         </Exec>
      </FlowCtrl>
   </Transaction>
   <!--Ended by sundx at 20090105 for cq46255，43458-->
   
   <!--Modified by zhq_BoCom00035572_20080402-->
   <!--Modified By zhq_BoCom00043458_20080804-->
   <Transaction code="915195" desc="对私打印/补打税票">
      <DynSentence name="count1">      <!--统计笔数  首次打印-->
         <!--Sentence>
         SELECT  COUNT(*) NUMB
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND BilSts='1'
         AND ChkSts='1'
         AND CAST(PrtNum AS SMALLINT)=0
         AND PayTyp='%s'
         AND ActNo='%s'
         AND (ActSeq='%s' OR '%s'='')
         AND trano='%s'
         FOR READ ONLY
         </Sentence>
         <Fields>PayTyp|ActNo|ActSeq|ActSeq|TraNo|</Fields-->
         
         <!--Modified By zhq_BoCom00043458_20080804_由于首打和补打合并交易，因此不再判断打印次数-->
         <!--Sentence>
         SELECT  COUNT(*) NUMB
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND BilSts='1'
         AND ChkSts='1'
         AND PayTyp='%s'
         AND ActNo='%s'
         AND ActDat='%s'
         AND (TCusId='%s' OR '%s'='')
         AND (ActSeq='%s' OR '%s'='')
         AND TraNo='%s'
         AND CAST(PrtNum AS SMALLINT) = 0
         FOR READ ONLY
         </Sentence-->

         <Sentence>
            SELECT  COUNT(*) NUMB
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND BilSts='1'
            AND ChkSts='1'
            AND PayTyp='%s'
            AND ActNo='%s'
            AND ActDat='%s'
            AND (TCusId='%s' OR '%s'='')
            AND (ActSeq='%s' OR '%s'='')
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>

         <Fields>PayTyp|ActNo|ChkDat|TCusId|TCusId|ActSeq|ActSeq|TraNo|</Fields>

      </DynSentence>
      <DynSentence name="UpdPrtNum1">  <!--更新打印次数 首次打印-->
         <!--Sentence>
         UPDATE tiptxnbok
         SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
         WHERE PayMod IN ('0','1')
         AND BilSts='1'
         AND ChkSts='1'
         AND CAST(PrtNum AS SMALLINT)=0
         AND PayTyp='%s'
         AND ActNo='%s'
         AND (ActSeq='%s' OR '%s'='')
         AND trano='%s'
         </Sentence>
         <Fields>PayTyp|ActNo|ActSeq|ActSeq|TraNo|</Fields-->
         
         <!--Modified By zhq_BoCom00043458_20080804_由于首打和补打合并交易，因此不再判断打印次数-->
         <!--Sentence>
         UPDATE tiptxnbok
         SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
         WHERE PayMod IN ('0','1')
         AND BilSts='1'
         AND ChkSts='1'
         AND PayTyp='%s'
         AND ActNo='%s'
         AND ActDat='%s'
         AND (TCusId='%s' OR '%s'='')
         AND (ActSeq='%s' OR '%s'='')
         AND TraNo='%s'
         AND CAST(PrtNum AS SMALLINT) = 0
         </Sentence-->
         <Sentence>
            UPDATE tiptxnbok
            SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
            WHERE PayMod IN ('0','1')
            AND BilSts='1'
            AND ChkSts='1'
            AND PayTyp='%s'
            AND ActNo='%s'
            AND ActDat='%s'
            AND (TCusId='%s' OR '%s'='')
            AND (ActSeq='%s' OR '%s'='')
            AND TraNo='%s'
         </Sentence>
         <Fields>PayTyp|ActNo|ChkDat|TCusId|TCusId|ActSeq|ActSeq|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="count2">      <!-- 统计笔数  重打税票-->
         <Sentence>
            SELECT  COUNT(*) NUMB
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND BilSts='1'
            AND ChkSts='1'
            AND PayTyp='%s'
            AND ActNo='%s'
            AND ActDat='%s'
            AND (TCusId='%s' OR '%s'='')
            AND (ActSeq='%s' OR '%s'='')
            AND TraNo='%s'
            AND CAST(PrtNum AS SMALLINT) &gt; 0
            FOR READ ONLY
         </Sentence>
         <Fields>PayTyp|ActNo|ChkDat|TCusId|TCusId|ActSeq|ActSeq|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdPrtNum2">  <!--更新打印次数 重打税票-->
         <Sentence>
            UPDATE tiptxnbok
            SET PrtNum=CAST(CAST(PrtNum AS SMALLINT)+1 AS CHAR(2))
            WHERE PayMod IN ('0','1')
            AND BilSts='1'
            AND ChkSts='1'
            AND PayTyp='%s'
            AND ActNo='%s'
            AND ActDat='%s'
            AND (TCusId='%s' OR '%s'='')
            AND (ActSeq='%s' OR '%s'='')
            AND TraNo='%s'
            AND CAST(PrtNum AS SMALLINT) &gt; 0
         </Sentence>
         <Fields>PayTyp|ActNo|ChkDat|TCusId|TCusId|ActSeq|ActSeq|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnBok">   <!--查询交易登记薄 首次打印-->
         <!--Sentence>
         SELECT ActDat,ActNo,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo OTckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID,TCusID,TCusNm
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND BilSts='1'
         AND ChkSts='1'
         AND CAST(PrtNum AS SMALLINT)=0
         AND PayTyp='%s'
         AND ActNo='%s'
         AND (ActSeq='%s' OR '%s'='')
         FOR READ ONLY
         </Sentence>
         <Fields>PayTyp|ActNo|ActSeq|ActSeq|</Fields-->
         <!--Modified By zhq_BoCom00043458_20080804_由于首打和补打合并交易，因此不再判断打印次数-->
         <!--Sentence>
         SELECT ActDat,ActNo,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo OTckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID,TCusID,TCusNm
         FROM tiptxnbok
         WHERE PayMod IN ('0','1')
         AND BilSts='1'
         AND ChkSts='1'
         AND CAST(PrtNum AS SMALLINT) = 0
         AND PayTyp='%s'
         AND ActNo='%s'
         AND (ActSeq='%s' OR '%s'='')
         AND TraNo='%s'
         FOR READ ONLY
         </Sentence-->

         <Sentence>
            SELECT ActDat,ActNo,TCusNm,ActNam,POBkNo,OrgCod,EntDat,RAccNm,TxnAmt,TraNo,TckNo OTckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID,TCusID,TCusNm
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND BilSts='1'
            AND ChkSts='1'
            AND PayTyp='%s'
            AND ActNo='%s'
            AND (ActSeq='%s' OR '%s'='')
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>PayTyp|ActNo|ActSeq|ActSeq|TraNo|</Fields>
      </DynSentence>

      <DynSentence name="QryTxnBok2">  <!--查询交易登记薄 重打税票-->
         <Sentence>
            SELECT ActDat,ActNo,TCusNm,ActNam,POBkNo,OrgCod,EntDat,TreCod,TxnAmt,TraNo,TckNo OTckNo,TlrId OTlrId,TTpNm,PrtNum,RBnkNo,ONodNo,OBrkNo,TaxVID,TCusID,TCusNm
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND BilSts='1'
            AND ChkSts='1'
            AND CAST(PrtNum AS SMALLINT) &gt; 0
            AND PayTyp='%s'
            AND ActNo='%s'
            AND (ActSeq='%s' OR '%s'='')
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>PayTyp|ActNo|ActSeq|ActSeq|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="count3">      <!--统计税种条数-->
         <Sentence>
            SELECT COUNT(*) NUMBE
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="count5">      <!--统计税种条数-->
         <Sentence>
            SELECT COUNT(*) NUMBE
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            AND (CAST(ProjId AS SMALLINT) BETWEEN CAST('%s' AS SMALLINT) AND CAST('%s' AS SMALLINT))
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|BePjId|EdPjId|</Fields>
      </DynSentence>
      <DynSentence name="QryTtpRec">   <!--查询税种信息-->
         <!--Sentence>
         SELECT TaxTNm,TaxBDt,TaxEDt,TTpAmt
         FROM tipttprec
         WHERE OrgCod='%s'
         AND EntDat='%s'
         AND TraNo='%s'
         FETCH FIRST 14 ROWS ONLY
         FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields-->
         <Sentence>
            SELECT TaxTNm,TaxBDt,TaxEDt,TTpAmt
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="QryTtpRec2">  <!--查询税种信息-->
         <Sentence>
            SELECT TaxTNm,TaxBDt,TaxEDt,TTpAmt
            FROM tipttprec
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="GetOrgNam">   <!--查询征收机关名称-->
         <Sentence>
            SELECT OrgNam
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>
      <!--由于实时扣税中没有国库代码，所以不再使用tiptreinf中的trenam，而使用RaccNm-->
      <DynSentence name="GetRBnkNm">   <!--查询收款国库（银行）名称-->
         <!--Sentence>
         SELECT RBnkNm
         FROM tiptrerkn
         WHERE RBnkNo='%s'
         FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|</Fields-->
         <Sentence>
            SELECT TreNam RBnkNm
            FROM tiptreinf
            WHERE TreCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TreCod|</Fields>
      </DynSentence>
      <DynSentence name="GetPOBkNm">   <!--查询付款人开户银行名称-->
         <Sentence>
            SELECT OrgNam BrkNam FROM cimorgtbl WHERE OrgNo='%s' FOR READ ONLY
         </Sentence>
         <Fields>ONodNo|</Fields>
      </DynSentence>
      <DynSentence name="GetBrkNm">    <!--查询分行名称-->
         <Sentence>
            SELECT BrkNam BrkNm FROM tipbrkinf WHERE BrkNo='%s' FOR READ ONLY
         </Sentence>
         <Fields>OBrkNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>        <!--根据网点号取分行号-->


      <FlowCtrl>
         <Quote name="Init"/>
         <Quote name="GetBrkCTL"/>     <!--根据网点号取分行号-->
         <!--Modified By zhq_BoCom00043458_20080804_前端交易画面的首打(915195)和补打(915196)合并-->
         <!--If condition="$RptFlg=0"-->    <!--首次打印-->
         <!--Marked By zhq_20080402_BoCom00035572-->
         <!--Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="count1"/>
         </Exec>
         <If condition="$NUMB=0">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910699</Set>
         <Set>RspMsg=没有要打印的税票</Set>
         <Return/>
         </If>
         <Exec func="PUB:QueryInGroup">
         <Arg name="SqlCmd" value="QryTxnBok"/>
         <Arg name="RecordName" value="TaxVCH"/>
         </Exec>
         <Set>Cnt=1</Set>
         <While condition="INTCMP($Cnt,2,$NUMB)"-->
         <!--GetValue将group内的节点复制到ROOT下-->
         <!--SetValue将ROOT下的节点复制到group内-->

         <!--取征收机关名称-->
         <!--Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxVCH_,$Cnt,.OrgCod)"/>
         <Arg name="DestName"  value="OrgCod"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="GetOrgNam"/>
         </Exec>
         <Exec func="PUB:SetValue">
         <Arg name="FieldName"  value="STRCAT(ROOT.TaxVCH_,$Cnt,.OrgNam)"/>
         <Arg name="FieldValue" value="$OrgNam"/>
         </Exec-->
         <!--取清算行名称-->
         <!--Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxVCH_,$Cnt,.RBnkNo)"/>
         <Arg name="DestName"  value="RBnkNo"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="GetRBnkNm"/>
         </Exec>
         <Exec func="PUB:SetValue">
         <Arg name="FieldName"  value="STRCAT(ROOT.TaxVCH_,$Cnt,.RBnkNm)"/>
         <Arg name="FieldValue" value="$RBnkNm"/>
         </Exec-->
         <!--取付款人开户银行名称-->
         <!--Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxVCH_,$Cnt,.ONodNo)"/>
         <Arg name="DestName"  value="ONodNo"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="GetPOBkNm"/>
         </Exec>
         <Exec func="PUB:SetValue">
         <Arg name="FieldName"  value="STRCAT(ROOT.TaxVCH_,$Cnt,.BrkNam)"/>
         <Arg name="FieldValue" value="$BrkNam"/>
         </Exec-->
         <!--取分行名称-->
         <!--Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxVCH_,$Cnt,.OBrkNo)"/>
         <Arg name="DestName"  value="OBrkNo"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="GetBrkNm"/>
         </Exec>
         <Exec func="PUB:SetValue">
         <Arg name="FieldName"  value="STRCAT(ROOT.TaxVCH_,$Cnt,.BrkNm)"/>
         <Arg name="FieldValue" value="$BrkNm"/>
         </Exec-->
         <!--取税种数据-->
         <!--先将group内的节点OrgCod EntDat TraNo复制到ROOT下-->
         <!--Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxVCH_,$Cnt,.OrgCod)"/>
         <Arg name="DestName"  value="OrgCod"/>
         </Exec>
         <Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxVCH_,$Cnt,.EntDat)"/>
         <Arg name="DestName"  value="EntDat"/>
         </Exec>
         <Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxVCH_,$Cnt,.TraNo)"/>
         <Arg name="DestName"  value="TraNo"/>
         </Exec>
         <Exec func="TIPQRY:QueryInToGroup">
         <Arg name="SqlCmd" value="QryTtpRec"/>
         <Arg name="RecordName" value="STRCAT(ROOT.TaxVCH_,$Cnt,.TaxTypLst1008)"/>
         </Exec-->

         <!--在修改单子BoCom00035572以前被注释_(Start)-->
         <!--Exec func="PUB:QueryInGroup">
         <Arg name="SqlCmd" value="QryTtpRec"/>
         <Arg name="RecordName" value="TaxTypLst1008"/>
         </Exec>
         <生成TaxVCH内的TaxTypLst1008循环节点>
         <Set>i=1</Set>
         <Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxVCH_,$Cnt,.TTpNm)"/>
         <Arg name="DestName"  value="TtpNm"/>
         </Exec>
         <While condition="INTCMP($i,2,$TtpNm)">
         <Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxTypLst1008_,$i,.TaxTNm)"/>
         <Arg name="DestName"  value="TaxTNm"/>
         </Exec>
         <Exec func="PUB:SetValue">
         <Arg name="FieldName"  value="STRCAT(ROOT.TaxVCH_,$Cnt,.TaxTypLst1008_,$i,.TaxTNm)"/>
         <Arg name="FieldValue" value="$TaxTNm"/>
         </Exec>
         <Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxTypLst1008_,$i,.TaxBDt)"/>
         <Arg name="DestName"  value="TaxBDt"/>
         </Exec>
         <Exec func="PUB:SetValue">
         <Arg name="FieldName"  value="STRCAT(ROOT.TaxVCH_,$Cnt,.TaxTypLst1008_,$i,.TaxBDt)"/>
         <Arg name="FieldValue" value="$TaxBDt"/>
         </Exec>
         <Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxTypLst1008_,$i,.TaxEDt)"/>
         <Arg name="DestName"  value="TaxEDt"/>
         </Exec>
         <Exec func="PUB:SetValue">
         <Arg name="FieldName"  value="STRCAT(ROOT.TaxVCH_,$Cnt,.TaxTypLst1008_,$i,.TaxEDt)"/>
         <Arg name="FieldValue" value="$TaxEDt"/>
         </Exec>
         <Exec func="PUB:GetValue">
         <Arg name="SourName"  value="STRCAT(TaxTypLst1008_,$i,.TTpAmt)"/>
         <Arg name="DestName"  value="TTpAmt"/>
         </Exec>
         <Exec func="PUB:SetValue">
         <Arg name="FieldName"  value="STRCAT(ROOT.TaxVCH_,$Cnt,.TaxTypLst1008_,$i,.TTpAmt)"/>
         <Arg name="FieldValue" value="$TTpAmt"/>
         </Exec>
         <Set>i=ADD($i,1)</Set>
         </While-->
         <!--在修改单子BoCom00035572以前被注释_(End)-->

         <!--Set>Cnt=ADD($Cnt,1)</Set>
         </While>
         <Exec func="PUB:ExecSql">
         <Arg name="SqlCmd" value="UpdPrtNum1"/>
         </Exec-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="count1"/>
         </Exec>
         <If condition="$NUMB=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=没有要打印的税票</Set>
            <Return/>
         </If>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryTxnBok"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetOrgNam"/>
         </Exec>
         <!--Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetRBnkNm"/>
         </Exec-->
         <Set>RBnkNm=$RAccNm</Set>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetPOBkNm"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkNm"/>
         </Exec>
         <Exec func="PUB:QueryInGroup">
            <Arg name="SqlCmd" value="QryTtpRec"/>
            <Arg name="RecordName" value="TaxTypLst1008"/>
         </Exec>
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdPrtNum1"/>
         </Exec>
         <Set>PrtNum=ADD($PrtNum,1)</Set>
         <!--/If-->
         <!--重打-->
         <!--ElseIf condition="$RptFlg=1">
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="count2"/>
         </Exec>
         <If condition="$NUMB=0">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910699</Set>
         <Set>RspMsg=没有要打印的税票</Set>
         <Return/>
         </If>
         <Exec func="PUB:AddAuthReason">
         <Arg name="AthCod" value="30"/>
         <Arg name="AthMsg" value="915825"/>
         </Exec>
         <Exec  func="PUB:CheckLocalAuth">
         <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="QryTxnBok2"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="GetOrgNam"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="GetRBnkNm"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="GetPOBkNm"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
         <Arg name="SqlCmd" value="GetBrkNm"/>
         </Exec>
         <Exec func="PUB:QueryInGroup">
         <Arg name="SqlCmd" value="QryTtpRec"/>
         <Arg name="RecordName" value="TaxTypLst1008"/>
         </Exec>
         <Exec func="PUB:ExecSql">
         <Arg name="SqlCmd" value="UpdPrtNum2"/>
         </Exec>
         <Set>PrtNum=ADD($PrtNum,1)</Set>
         </ElseIf>
         <Else>
         <Set>MsgTyp=E</Set>
         <Set>RspMsg=错误的打印类型</Set>
         <Return/>
         </Else-->
      </FlowCtrl>
   </Transaction>

   <Transaction code="915180" desc="查询税票打印信息">
      <DynSentence name="QryBrkNo">   <!--取目标分行号-->
         <Sentence>
            SELECT BrkNo QryBrkNo
            FROM tiprgnbrk
            WHERE Rgn='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>Rgn|</Fields>
      </DynSentence>
      <DynSentence name="GetTolNum">   <!--统计税票总数-->
         <Sentence>
            SELECT COUNT(*) TolNum
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND PrtNod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|QryNod|</Fields>
      </DynSentence>
      <DynSentence name="GetAPrtNm">   <!--统计已打印税票总数-->
         <Sentence>
            SELECT COUNT(*) APrtNm
            FROM tiptxnbok
            WHERE PayMod IN ('0','1')
            AND BilSts='1'
            AND ChkSts='1'
            AND (ChkDat BETWEEN '%s' AND '%s')
            AND PrtNod='%s'
            AND cast(PrtNum as bigint)&gt;0
            FOR READ ONLY
         </Sentence>
         <Fields>BChkDt|EChkDt|QryNod|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->

         <Set>Rgn=SUBSTR($QryNod,1,3)</Set>
         <Exec func="PUB:ReadRecord">  <!--取目标分行号-->
            <Arg name="SqlCmd" value="QryBrkNo"/>
         </Exec>

         <!--发起网点和被查询网点是否属于同一分行-->
         <If condition="IS_NOEQUAL_STRING($BrkNo,$QryBrkNo)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=只能查询本分行信息</Set>
         </If>

         <!--非帐务中心网点仅能查询本网点-->
         <If condition="IS_NOEQUAL_STRING(STRCAT(SUBSTR($BrkNo,1,3),800),$NodNo)">
            <If condition="IS_NOEQUAL_STRING($NodNo,$QryNod)">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=非账务中心，只能查询本网点信息</Set>
               <Return/>
            </If>
         </If>

         <!--统计税票总数-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTolNum"/>
         </Exec>

         <!--统计已打印税票总数-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetAPrtNm"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <Transaction code="915197" desc="银行端缴税凭证补打查询">
      <DynSentence name="MultiQuery">
         <Sentence>
            SELECT PayTyp,ActDat ActDt,OrgCod,EntDat,TraNo,TlrId OTlrId,ActNo,ActNam,RAccNm,ONodNo,TaxVID,LevyNo,TCusId,TCusNm,TBlDt,CrpCod,BdgTyp,TrmSgn,CrpTyp,PVSign,TxnAmt,TTpNm,PrtNum,RBnkNo,TckNo OTckNo
            FROM tiptxnbok
            WHERE PayTyp='%s'
            AND (ActNo='%s' or '%s'='')
            AND (ActSeq='%s' or '%s'='')
            AND (TCusId='%s' or '%s'='')
            AND BilSts='1'
            AND (ActDat='%s' or '%s'='')
            AND (TraNo='%s' or '%s'='')
            AND (PayMod='2' or (PayMod!='2' AND CAST(PrtNum AS SMALLINT)=0))
         </Sentence>
         <Fields>PayTyp|ActNo|ActNo|ActSeq|ActSeq|TCusId|TCusId|ActDt|ActDt|TraNo|TraNo|</Fields>


      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:MultiQuery" error="IGNORE">
            <Arg name="SqlCmd" value="MultiQuery"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--Modified By zhq_BoCom00043458_20080807-->
   <Transaction code="915187" desc="银行端缴税凭证补打">
      <DynSentence name="QryTxnBok">   <!--取交易登记簿数据-->
         <!--Modified By zhq_BoCom00043458_20080807_查询出国库代码以备查询国库名称-->
         <!--Sentence>
         SELECT OrgCod,EntDat,TraNo,TlrID as OTlrID,ActNo,ActNam,RAccNm,ONodNo,TaxVID,LevyNo,TCusId,TCusNm,TBlDt,CrpCod,BdgTyp,TrmSgn,CrpTyp,PVSign,TxnAmt,TTpNm,PrtNum,RBnkNo,TckNo OTckNo
         FROM tiptxnbok
         WHERE TraNo='%s'
         AND PayMod='2'
         AND BilSts='1'
         AND ActDat='%s'
         FOR READ ONLY
         </Sentence-->
         <!-- cast(PrtNum as smallint) >0  AND PrtNod='%s'-->
         <!--Fields>TraNo|ActDt|</Fields-->

         <Sentence>
            SELECT OrgCod,EntDat,TraNo,TlrID as OTlrID,ActNo,ActNam,RAccNm RBnkNm,ONodNo,TaxVID,LevyNo,TCusId,TCusNm,TBlDt,CrpCod,BdgTyp,TrmSgn,CrpTyp,PVSign,TxnAmt,TTpNm,PrtNum,RBnkNo,TckNo OTckNo
            FROM tiptxnbok
            WHERE TraNo='%s'
            AND PayMod='2'
            AND BilSts='1'
            AND ActDat='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TraNo|ActDt|</Fields>
      </DynSentence>

      <DynSentence name="QryTtpRec">   <!--取税种信息-->
         <Sentence>
            SELECT  TaxTNm,TaxBDt,TaxEDt,TTpAmt
            FROM tipttprec
            WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>

      <DynSentence name="GetOrgNam">   <!--查询征收机关名称-->
         <Sentence>
            SELECT OrgNam
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="GetBrkNam">   <!--查询付款人开户行名称-->
         <Sentence>
            SELECT OrgNam BrkNam
            FROM cimorgtbl
            WHERE OrgNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>ONodNo|</Fields>
      </DynSentence>

      <DynSentence name="GetRBnkNm">   <!--查询国库名称-->
         <!--Modified By zhq_BoCom00043458_20080807_将原来查询清算行名称改为查询具体的国库名称-->
         <!--Sentence>
         SELECT RBnkNm
         FROM tiptrerkn
         WHERE RBnkNo='%s'
         FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|</Fields-->
         <Sentence>
            SELECT TreNam RBnkNm
            FROM  tiptreinf
            WHERE TreCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TreCod|</Fields>
      </DynSentence>

      <DynSentence name="GetBrkNm"><!--查询分行名称-->
         <Sentence>
            SELECT BrkNam BrkNm FROM tipbrkinf WHERE BrkNo='%s'
         </Sentence>
         <Fields>OBrkNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdPrtNum">   <!--更新打印次数-->
         <Sentence>
            UPDATE tiptxnbok
            SET PrtNum=cast(cast(PrtNum as smallint)+1 as char(2)),PrtNod='%s'
            WHERE OrgCod='%s' AND EntDat='%s' AND TraNo='%s'
         </Sentence>
         <Fields>NodNo|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>

      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="QryTxnBok"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=没有要打印的税票</Set>
            <Return/>
         </If>

         <Exec func="PUB:QueryInGroup">
            <Arg name="SqlCmd" value="QryTtpRec"/>
            <Arg name="RecordName" value="TaxTypLst1008"/>
         </Exec>

         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetOrgNam"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=查询不到征收机关名称</Set>
            <Return/>
         </If>

         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetBrkNam"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=查询不到付款人开户机构名称</Set>
            <Return/>
         </If>

         <!--Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetRBnkNm"/>
         </Exec-->

         <Exec func="PUB:AddAuthReason" >
            <Arg name="AthCod" value="30" />
            <Arg name="AthMsg" value="915825" />
         </Exec>

         <Exec  func="PUB:CheckLocalAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1" />
         </Exec>

         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdPrtNum"/>
         </Exec>
         <Set>PrtNum=ADD($PrtNum,1)</Set>
      </FlowCtrl>
   </Transaction>

   <Transaction code="915198" desc="财政挂账通知书打印">
      <DynSentence name="QryTxnBok">
         <Sentence>
            SELECT CclDat,CBrkNo,CTckNo,CclNo,CActNo,TxnAmt,DActNo,TxnCID,PrtNm,LogNo
            FROM tiptxnbok
            WHERE ActNo='%s'
            AND CclNo='%s'
            AND CclDat='%s'
         </Sentence>
         <Fields>ActNo|CclNo|CclDat|</Fields>
      </DynSentence>
      <DynSentence name="QryTxnJnl">
         <Sentence>
            SELECT CcyCod,Smr,TlrId as ETlrId
            FROM tiptxnjnl
            WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="GetBrkNam">   <!--根据分行号取分行名称-->
         <Sentence>
            SELECT BrkNam
            FROM tipbrkinf
            WHERE BrkNo='%s'
         </Sentence>
         <Fields>CBrkNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdPrtNum">   <!--打印次数加一-->
         <Sentence>
            UPDATE tiptxnbok
            SET PrtNum=cast(cast(PrtNum as smallint)+1 as char(2))
            WHERE ActNo='%s'
            AND CclNo='%s'
            AND CclDat='%s'
         </Sentence>
         <Fields>ActNo|CclNo|CclDat|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryTxnBok"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryTxnJnl"/>
         </Exec>

         <!--根据分行号取分行名称-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkNam"/>
         </Exec>

         <Set>RNodNo=STRCAT(SUBSTR($CBrkNo,1,3),800)</Set><!--挂账机构为关联行的帐务中心-->
         <Set>PrtNm=ADD($PrtNm,1)</Set>

         <!--打印次数加一-->
         <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdPrtNum"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <Transaction code="918717" desc="查询机构名称">
      <DynSentence name="GetBrkNo">   <!--根据地区号取分行号-->
         <Sentence>
            SELECT BrkNo
            FROM tiprgnbrk
            WHERE Rgn='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>Rgn|</Fields>
      </DynSentence>
      <DynSentence name="GetBrkNam">   <!--根据分行号取分行名称-->
         <Sentence>
            SELECT BrkNam
            FROM tipbrkinf
            WHERE BrkNo='%s'
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
      <DynSentence name="GetOrgNam">
         <Sentence>
            SELECT OrgNam
            FROM cimorgtbl
            WHERE OrgNo='%s'
         </Sentence>
         <Fields>OrgNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>Rgn=SUBSTR($OrgNo,1,3)</Set>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkNo"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetBrkNam"/>
         </Exec>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetOrgNam"/>
         </Exec>
         <Set>OrgNam=STRCAT($BrkNam,$OrgNam)</Set>
      </FlowCtrl>
   </Transaction>

   <Transaction code="918718" desc="财政零余额账户查询">
      <DynSentence name="QryFapAct">
         <Sentence>
            SELECT *
            FROM tipfapact
            WHERE ActNo='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryFapAct"/>
         </Exec>
      </FlowCtrl>
   </Transaction>

   <!--Modified By zhq_BoCom00043458_20080807-->
   <!--Modified by sundx at 20090414 for cq64047,使单位卡也能完成缴税功能-->
   <Transaction code="915910" desc="对私银行申报">
      <DynSentence name="ChkStatus">  <!--检查系统状态-->
         <Sentence>
            SELECT Status,WorkDt WrkDat
            FROM tipsyssts
            FOR READ ONLY
         </Sentence>
         <Fields></Fields>
      </DynSentence>

      <DynSentence name="GetPBnkNo">   <!--查询清算行支付系统行号-->
         <Sentence>
            SELECT PBnkNo,BrkNam BrkNm
            FROM tipbrkinf
            WHERE BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetOrgNam">   <!--查询征收机关名称-->
         <Sentence>
            SELECT OrgNam
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="GetBrkNam">   <!--查询付款人开户行名称-->
         <Sentence>
            SELECT OrgNam BrkNam
            FROM cimorgtbl
            WHERE OrgNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>ONodNo|</Fields>
      </DynSentence>

      <DynSentence name="ChkTaxVID">   <!--检查税票号是否已缴纳过-->
         <Sentence>
            SELECT OrgCod
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND TaxVID='%s'
            AND BilSts IN ('1','9')
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|TaxVID|</Fields>
      </DynSentence>

      <DynSentence name="GetCBrkNo">   <!--查询关联分行号-->
         <Sentence>
            SELECT BrkNo CBrkNo
            FROM tiptrerkn
            WHERE RBnkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetRBrkNo">   <!--查询清算行行号和暂收科目顺序号-->
         <Sentence>
            SELECT BrkNo RBrkNo,ActSqn
            FROM tipbrkinf
            WHERE PBnkNo='%s'
            AND RknFlg='1'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdTxnBok">   <!--根据前置流水号更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='%s',BilSts='%s',TckNo='%s',AddWord='%s',HRspCd='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|BilSts|TckNo|AddWord|HRspCd|LogNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdTxnBok2">   <!--根据前置流水号更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='%s',BilSts='%s',TckNo='%s',AddWord='%s',ONodNo='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|BilSts|TckNo|AddWord|ONodNo|LogNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdRspSts">   <!--根据前置流水号更新人行账务登记薄中的回执状态-->
         <Sentence>
            UPDATE tiptxnbok
            SET RspSts='%s',RspDat='%s',RspNum='1'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>RspSts|WrkDat|LogNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdPrtNum">
         <Sentence>
            UPDATE tiptxnbok SET PrtNum='1' WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>

      <!--Quote name="GetTreNamSql"/-->   <!--获取国库名称-->
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <Quote name="ChkOrgNodSQL"/>  <!--根据征收机关代码检查征收机关和对应节点状态的SQL语句-->
      <FlowCtrl>
         <Quote name="Init"/>
         <If condition="ISNULL($TaxNum)=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=课税数量不能为空</Set>
            <Return/>
         </If>

         <!--检查系统状态-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStatus"/>
         </Exec>
         <If condition="AND(IS_NOEQUAL_STRING($Status,0),IS_NOEQUAL_STRING($Status,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910601</Set>
            <Return/>
         </If>

         <Quote name="ChkOrgNodCTL"/>  <!--根据征收机关代码检查征收机关和对应节点状态的流程-->
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->
         <Set>BrNo=$SBrNo</Set>
         <!--查询清算行支付系统行号-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>

         <!--检查帐户状态和余额-->
         <Set>TTxnCd=476520</Set>
         <If condition="$PayTyp=2">
            <Set>ActTyp=4</Set>
         </If>
         <ElseIf condition="$PayTyp=3">
            <Set>ActTyp=2</Set>
         </ElseIf>
         <!--PayTyp=4-->
         <Else>
            <Set>ActTyp=1</Set>
            <Set>ActSqn=$ActSeq</Set>
         </Else>

         <Set>CcyCod=CNY</Set>
         <Exec func="PUB:CallHostOther" error="IGNORE">
            <Arg name="HTxnCd" value="476520"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="$MsgTyp=E">
            <Return/>
         </If>
         <Else>
            <If condition="$ActSts=1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=帐户为销户状态</Set>
               <Return/>
            </If>
            <ElseIf condition="$ActSts=2">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=帐户为抹帐状态</Set>
               <Return/>
            </ElseIf>
            <Else>
               <If condition="INTCMP($Bal,1,$TxnAmt)">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910616</Set>
                  <Set>RspMsg=帐户可用余额不足</Set>
                  <Return/>
               </If>
               <If condition="$ManFlg=1">
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=该卡为附属卡</Set>
                  <Return/>
               </If>
               <!--Modified by sundx at 20090414 for cq64047,使单位卡也能完成缴税功能-->
               <!--Modified by sundx at 20090510 for cq64047,使单位准贷记卡不能完成缴税功能-->
               <If condition="$CpFlg=1">  <!--商务卡-->
                  <If condition="$CrdTyp!=0">
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=该商务卡非单位借记卡</Set>
                     <Return/>
                  </If>
               </If>
               <!--Ended by sundx at 20090414 for cq64047,使单位卡也能完成缴税功能-->
            </Else>
         </Else>

         <Set>HTxnCd=915910</Set>

         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetOrgNam"/>
         </Exec>
         <!--银行申报请求-->
         <Set>OTxnAmt=$TxnAmt</Set>
         <Quote name="GetSeq"/>

         <Set>MsgRef=$MsgId</Set>
         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="TIPLvyNo"/>
            <Arg name="Len" value="8"/>
         </Exec>

         <Set>LevyNo=$SelVal</Set>
         <Exec func="PUB:CallThirdOther">
            <Arg name="HTxnCd" value="2090"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="$TRspCd=999999">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>
         <If condition="$Result!=90000">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910612</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>

         <!--根据国库代码查询国库名称-->
         <!--Quote name="FetchTreNam"/-->

         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkTaxVID"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </If>
         <ElseIf condition="~RetCod=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=STRCAT(税票号,$TaxVID,已缴纳成功)</Set>
            <Return/>
         </ElseIf>
         <Else>
            <Return/>
         </Else>

         <If condition="IS_NOEQUAL_STRING($OTxnAmt,$TxnAmt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=申报金额与人行确认金额不符，交易拒绝</Set>
            <Return/>
         </If>
         <Set>BokNum=STRCAT($EntDat,$TraNo)</Set>
         <!--银行缴款-->
         <Set>PayMod=2</Set>
         <Set>FTxnTm=GETDATETIME()</Set>
         <Set>ReqDat=$WrkDat</Set>
         <Set>OBrkNo=$BrkNo</Set>

         <Exec func="PUB:ReadRecord">   <!--查询关联分行号-->
            <Arg name="SqlCmd" value="GetCBrkNo"/>
         </Exec>

         <Exec func="PUB:ReadRecord">   <!--查询清算行行号和暂收科目顺序号-->
            <Arg name="SqlCmd" value="GetRBrkNo"/>
         </Exec>

         <Exec func="PUB:GetLogNo"/>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tiptxnbok"/>
         </Exec>

         <Set>HTxnCd=915910</Set>
         <Set>TTxnCd=915910</Set>
         <Set>CcyCod=CNY</Set>
         <Set>ItgTyp=1</Set>
         <Set>TxnAtr= </Set>
         <Set>MstChk=1</Set>
         <Set>RecTyp=2</Set>
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->
         <Exec func="PUB:InsertJournal"/> <!--预计流水-->

         <Set>i=1</Set>
         <While condition="INTCMP($TTpNm,5,$i)">
            <Exec func="PUB:InsertRecordByGroup">
               <Arg name="TableName" value="tipttprec"/>
               <Arg name="GroupName" value="TaxTypLst1008"/>
               <Arg name="RecordNo"  value="$i"/>
            </Exec>
            <Exec func="PUB:InsertRecordByGroup">
               <Arg name="TableName" value="tiptaxrec"/>
               <Arg name="RootName"  value="STRCAT(ROOT.TaxTypLst1008_,$i)"/>
               <Arg name="GroupName" value="TaxSbjLst1008"/>
               <Arg name="FldLst" value="OrgCod|EntDat|TraNo|"/>
            </Exec>
            <Set>i=ADD($i,1)</Set>
         </While>

         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE">   <!--主机单笔缴费-->
            <Arg name="HTxnCd" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <Switch expression="~RetCod">
            <Case value="-10">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>

               <Set>BilSts=2</Set>
               <Set>AddWord=向主机发送交易失败</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99004</Set>
               <Set>RspMsg=系统交易失败</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>

               <Set>BilSts=2</Set>
               <Set>AddWord=主机交易系统错误</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99004</Set>
               <Set>RspMsg=系统交易失败</Set>

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="T"/>
               </Exec>
               <Set>BilSts=T</Set>
               <Set>AddWord=系统运行超时</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99002</Set>
               <Set>RspMsg=系统通讯异常</Set>

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请抹账</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=STRCAT(主机交易拒绝错误码,$HRspCd)</Set>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=$HRspCd</Set>

               <Exec func="PUB:CodeSwitching">
                  <Arg name="DatSrc" value="TIPCSW"></Arg>
                  <Arg name="SourNam" value="RspCod"></Arg>
                  <Arg name="DestNam" value="Result"></Arg>
                  <Arg name="TblNam" value="Cod2Res"></Arg>
               </Exec>
               <Exec func="PUB:CodeSwitching">
                  <Arg name="DatSrc" value="TIPCSW"></Arg>
                  <Arg name="SourNam" value="Result"></Arg>
                  <Arg name="DestNam" value="AddWord"></Arg>
                  <Arg name="TblNam" value="Res2Wrd"></Arg>
               </Exec>
               <Set>RspMsg=$AddWord</Set>
               <Exec func="PUB:PutResponse"/> <!--for uat test -->

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="GetBrkNam"/>
               </Exec>
               <If condition="~RetCod=-2">
                  <Set>MsgTyp=N</Set>
                  <Set>RspCod=000000</Set>
               </If>

               <Set>BrkNam=STRCAT($BrkNm,$BrkNam)</Set>
               <Set>BrkNam=ADDCHAR($BrkNam,60, ,0)</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="S"/>
               </Exec>
               <Set>BilSts=1</Set>
               <Set>AddWord=交易成功</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok2"/>
               </Exec>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdPrtNum"/>
               </Exec>
               <!--银行申报扣税回执-->
               <Set>RspMsg=交易成功</Set>
               <Exec func="PUB:PutResponse"/>
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>
               <Return/>
            </Case>
            <Default>
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=主机交易错误</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99090</Set>
               <Set>RspMsg=系统交易失败</Set>

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知主机错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>

   <!--Modified By zhq_BoCom00043458_20080807-->
   <!--Modified by sundx at 20090414 for cq64047,使单位卡也能完成缴税功能-->
   <Transaction code="915920" desc="对私未申报银行端缴款记帐">
      <DynSentence name="ChkStatus">
         <Sentence>
            SELECT Status,WorkDt WrkDat
            FROM tipsyssts
            FOR READ ONLY
         </Sentence>
         <Fields></Fields>
      </DynSentence>

      <DynSentence name="GetPBnkNo">
         <Sentence>
            SELECT PBnkNo,BrkNam BrkNm
            FROM tipbrkinf
            WHERE BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetBrkNam">
         <Sentence>
            SELECT OrgNam BrkNam
            FROM cimorgtbl
            WHERE OrgNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>ONodNo</Fields>
      </DynSentence>

      <DynSentence name="ChkTaxVID">
         <Sentence>
            SELECT OrgCod
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND TaxVID='%s'
            AND BilSts IN('1','9')
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|TaxVID|</Fields>
      </DynSentence>

      <DynSentence name="GetCBrkNo">
         <Sentence>
            SELECT BrkNo CBrkNo
            FROM tiptrerkn
            WHERE RBnkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>RBnkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetRBrkNo">
         <Sentence>
            SELECT BrkNo RBrkNo,ActSqn
            FROM tipbrkinf
            WHERE PBnkNo='%s'
            AND RknFlg='1'
            FOR READ ONLY
         </Sentence>
         <Fields>PBnkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetOrgNam">   <!--查询征收机关名称-->
         <Sentence>
            SELECT OrgNam
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="UpdTxnBok">
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='%s',BilSts='%s',TckNo='%s',AddWord='%s',HRspCd='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|BilSts|TckNo|AddWord|HRspCd|LogNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdTxnBok2">
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='%s',BilSts='%s',TckNo='%s',AddWord='%s',ONodNo='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>HTxnSt|BilSts|TckNo|AddWord|ONodNo|LogNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdRspSts">
         <Sentence>
            UPDATE tiptxnbok
            SET RspSts='%s',RspDat='%s',RspNum='1'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>RspSts|WrkDat|LogNo|</Fields>
      </DynSentence>

      <DynSentence name="UpdPrtNum">
         <Sentence>
            UPDATE tiptxnbok SET PrtNum='1' WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>

      <!--Quote name="GetTreNamSql"/-->   <!--获取国库名称-->
      <Quote name="GetBrkSQL"/>
      <Quote name="ChkOrgNodSQL"/>
      <FlowCtrl>
         <Quote name="Init"/>

         <If condition="ISNULL($TaxNum)=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=课税数量不能为空</Set>
            <Return/>
         </If>

         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="ChkStatus"/>
         </Exec>
         <If condition="AND(IS_NOEQUAL_STRING($Status,0),IS_NOEQUAL_STRING($Status,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910601</Set>
            <Return/>
         </If>

         <Quote name="ChkOrgNodCTL"/>  <!--根据征收机关代码检查征收机关和对应节点状态的流程-->
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->
         <Set>BrNo=$SBrNo</Set>

         <!--查询清算行支付系统行号-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetPBnkNo"/>
         </Exec>

         <Set>TTxnCd=476520</Set>
         <If condition="$PayTyp=2">
            <Set>ActTyp=4</Set>
         </If>
         <ElseIf condition="$PayTyp=3">
            <Set>ActTyp=2</Set>
         </ElseIf>
         <!--PayTyp=4-->
         <Else>
            <Set>ActTyp=1</Set>
            <Set>ActSqn=$ActSeq</Set>
         </Else>

         <Set>CcyCod=CNY</Set>
         <Exec func="PUB:CallHostOther" error="IGNORE"> <!--上主机账户信息查询-->
            <Arg name="HTxnCd" value="476520"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="$MsgTyp=E">
            <Set>RspMsg=帐号验证失败</Set>
            <Return/>
         </If>
         <Else>
            <!--Modified by ly at 20090715 for cq73476,对非正常状态下的单位借记卡进行缴税时，交易应拒绝-->
            <If condition="$ActSts!=0">
               <Set>MsgTyp=910699</Set>
               <Set>RspMsg=账户状态不正常</Set>
               <Return/>
            </If>
            <!--Ended by ly at 20090715 for cq73476,对非正常状态下的单位借记卡进行缴税时，交易应拒绝-->
            <Else>
               <If condition="INTCMP($Bal,1,$TxnAmt)">
                  <Set>MsgTyp=E</Set>
                  <Set>RspMsg=帐户可用余额不足</Set>
                  <Return/>
               </If>
               <If condition="$ManFlg=1">
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=该卡为附属卡</Set>
                  <Return/>
               </If>
               <!--Modified by sundx at 20090414 for cq64047,使单位卡也能完成缴税功能-->
               <!--Modified by sundx at 20090510 for cq64047,使单位准贷记卡不能完成缴税功能-->
               <If condition="$CpFlg=1">  <!--商务卡-->
                  <If condition="$CrdTyp!=0">
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=该商务卡非单位借记卡</Set>
                     <Return/>
                  </If>
               </If>
               <!--Ended by sundx at 20090414 for cq64047,使单位卡也能完成缴税功能-->
            </Else>
         </Else>

         <!--检查申报状态-->
         <If condition="$LvySts!=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910617</Set>
            <Set>RspMsg=申报状态不是未申报，交易拒绝</Set>
            <Return/>
         </If>

         <!--银行申报请求-->
         <Set>OTxnAmt=$TxnAmt</Set>

         <Quote name="GetSeq"/>
         <!--need to add-->
         <Set>MsgRef=$MsgId</Set>

         <Exec func="PUB:GetPubSeqNoCircle">
            <Arg name="SeqNam" value="TIPLvyNo"/>
            <Arg name="Len" value="8"/>
         </Exec>
         <Set>LevyNo=$SelVal</Set>

         <Exec func="PUB:CallThirdOther">
            <Arg name="HTxnCd" value="2090"/>
            <Arg name="ObjSvr" value="MMQMTIP1"/>
         </Exec>
         <If condition="$TRspCd=999999">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>
         <If condition="$Result!=90000">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910612</Set>
            <Set>RspMsg=STRCAT($Result,$AddWord)</Set>
            <Return/>
         </If>

         <!--根据国库代码查询国库名称-->
         <!--Quote name="FetchTreNam"/-->

         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="ChkTaxVID"/>
         </Exec>
         <If condition="~RetCod=-2">
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
         </If>
         <ElseIf condition="~RetCod=0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=STRCAT(税票号,$TaxVID,已缴纳成功)</Set>
            <Return/>
         </ElseIf>
         <Else>
            <Return/>
         </Else>

         <If condition="IS_NOEQUAL_STRING($OTxnAmt,$TxnAmt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=申报金额与人行确认金额不符，交易拒绝</Set>
            <Return/>
         </If>

         <!--银行缴款-->
         <Set>HTxnCd=915910</Set>
         <Set>PayMod=2</Set>
         <Set>FTxnTm=GETDATETIME()</Set>
         <Set>ReqDat=$WrkDat</Set>
         <Set>OBrkNo=$BrkNo</Set>
         <Exec func="PUB:ReadRecord">   <!--查询关联分行号-->
            <Arg name="SqlCmd" value="GetCBrkNo"/>
         </Exec>

         <Exec func="PUB:ReadRecord">   <!--查询清算行行号和暂收科目顺序号-->
            <Arg name="SqlCmd" value="GetRBrkNo"/>
         </Exec>

         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetOrgNam"/>
         </Exec>

         <Exec func="PUB:GetLogNo"/>
         <Exec func="PUB:InsertRecord">
            <Arg name="TblNam" value="tiptxnbok"/>
         </Exec>

         <Set>TTxnCd=$FeCod</Set>
         <Set>CcyCod=CNY</Set>
         <Set>ItgTyp=1</Set>
         <Set>TxnAtr= </Set>
         <Set>MstChk=1</Set>
         <Set>RecTyp=2</Set>
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>
         <Exec func="PUB:InsertJournal"/> <!--预计流水-->

         <Set>i=1</Set>
         <While condition="INTCMP($TTpNm,5,$i)">
            <Exec func="PUB:InsertRecordByGroup">
               <Arg name="TableName" value="tipttprec"/>
               <Arg name="GroupName" value="TaxTypLst1008"/>
               <Arg name="RecordNo"  value="$i"/>
            </Exec>
            <Exec func="PUB:InsertRecordByGroup">
               <Arg name="TableName" value="tiptaxrec"/>
               <Arg name="RootName"  value="STRCAT(ROOT.TaxTypLst1008_,$i)"/>
               <Arg name="GroupName" value="TaxSbjLst1008"/>
               <Arg name="FldLst" value="OrgCod|EntDat|TraNo|"/>
            </Exec>
            <Set>i=ADD($i,1)</Set>
         </While>

         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE">   <!--主机单笔缴费-->
            <Arg name="HTxnCd" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <Switch expression="~RetCod">
            <Case value="-10">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=向主机发送交易失败</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99004</Set>
               <Set>RspMsg=系统交易失败</Set>

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=主机交易系统错误</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99004</Set>
               <Set>RspMsg=系统交易失败</Set>

               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="T"/>
               </Exec>
               <Set>BilSts=T</Set>
               <Set>AddWord=系统运行超时</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99002</Set>
               <Set>RspMsg=系统通信异常</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请抹账</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>BilSts=2</Set>
               <Set>AddWord=STRCAT(主机交易拒绝错误码,$HRspCd)</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=$HRspCd</Set>

               <Exec func="PUB:CodeSwitching">
                  <Arg name="DatSrc" value="TIPCSW"></Arg>
                  <Arg name="SourNam" value="RspCod"></Arg>
                  <Arg name="DestNam" value="Result"></Arg>
                  <Arg name="TblNam" value="Cod2Res"></Arg>
               </Exec>

               <Exec func="PUB:CodeSwitching">
                  <Arg name="DatSrc" value="TIPCSW"></Arg>
                  <Arg name="SourNam" value="Result"></Arg>
                  <Arg name="DestNam" value="AddWord"></Arg>
                  <Arg name="TblNam" value="Res2Wrd"></Arg>
               </Exec>

               <Set>RspMsg=$AddWord</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="GetBrkNam"/>
               </Exec>
               <If condition="~RetCod=-2">
                  <Set>MsgTyp=N</Set>
                  <Set>RspCod=000000</Set>
               </If>

               <Set>BrkNam=STRCAT($BrkNm,$BrkNam)</Set>
               <Set>BrkNam=ADDCHAR($BrkNam,60, ,0)</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="S"/>
               </Exec>

               <Set>BilSts=1</Set>
               <Set>AddWord=未申报记帐成功</Set>
               <Set>WrkDat= </Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok2"/>
               </Exec>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdPrtNum"/>
               </Exec>
               <!--银行未申报扣税回执-->
               <Set>RspMsg=交易成功</Set>
               <Exec func="PUB:PutResponse"/>
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Return/>
            </Case>
            <Default>
               <Set>BrNo=$SBrNo</Set>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>

               <Set>BilSts=2</Set>
               <Set>AddWord=主机交易错误</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>

               <!--银行申报扣税回执-->
               <Quote name="GetSeq"/>
               <!--need to add-->
               <Set>MsgRef=$MsgId</Set>
               <Set>SrcNod=601100000010</Set>
               <Set>DstNod=100000000000</Set>
               <Set>RspCod=99090</Set>
               <Set>RspMsg=系统交易失败</Set>
               <Exec func="PUB:CallThirdOther">
                  <Arg name="TxnCod"  value="2108"/>
                  <Arg name="ObjSvr"  value="MMQMTIP1"/>
               </Exec>
               <If condition="AND(IS_EQUAL_STRING(~RetCod,0),IS_EQUAL_STRING($Result,90000))">
                  <Set>RspSts=1</Set>
               </If>
               <Else>
                  <Set>RspSts=2</Set>
               </Else>

               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdRspSts"/>
               </Exec>

               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知主机错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>

   <Transaction code="915950" desc="差错处理人工冲账">
      <DynSentence name="GetTxnInf">   <!--查询登记薄记录信息-->
         <Sentence>
            SELECT BilSts,ChkSts,ActDat OActDt,ActNo OActNo,TxnAmt OTxnAt,PayTyp,ActSqn,PayMod,CBrkNo BrkNo
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">   <!--更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET BilSts='%s',LogNo='%s'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>BilSts|LogNo|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查流水是否存在-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>
         <!--Modified by sundx at 20090710 for cq76186-->
         <Set>BrNo=$BrkNo</Set>          <!--取国库关联行为记账分行号-->
         <!--Quote name="GetBrkCTL"/-->  <!--根据网点号取分行号-->

         <!--Quote name="ChkNodNo"/-->  <!--检查网点是否国库关联行的账务中心-->
         
         <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心，拒绝交易</Set>
            <Return/>
         </If>
         <!--Ended by sundx at 20090710 for cq76186-->
         <!--检查交易状态-->
         <If condition="$BilSts!=1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原交易不成功，不能冲账</Set>
            <Return/>
         </If>

         <!--检查核对标志-->
         <If condition="OR(IS_EQUAL_STRING($ChkSts,0),IS_EQUAL_STRING($ChkSts,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=该交易未核对或已核对成功，不能冲账</Set>
            <Return/>
         </If>

         <!--检查原交易会计日期-->
         <If condition="IS_EQUAL_STRING($ActDat,$OActDt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910609</Set>
            <Set>RspMsg=原交易为当天账务，不能冲账</Set>
            <Return/>
         </If>

         <!--检查缴款模式和缴款类型-->
         <!--If condition="$PayTyp=0">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=910699</Set>
         <Set>RspMsg=原交易为柜台现金交易，不能冲账</Set>
         <Return/>
         </If-->

         <!--检查账号是否一致-->
         <If condition="IS_NOEQUAL_STRING($ActNo,$OActNo)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=账号与原交易账号不一致</Set>
            <Return/>
         </If>

         <!--检查金额是否一致-->
         <If condition="IS_NOEQUAL_STRING($TxnAmt,$OTxnAt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=金额与原交易金额不一致</Set>
            <Return/>
         </If>

         <!--登记主机流水表-->
         <Exec func="PUB:GetLogNo"/>
         <Set>HTxnCd=915950</Set>
         <Set>FTxnTm=GETDATETIME()</Set>
         <Set>FRspCd=000000</Set>
         <Set>CcyCod=CNY</Set>
         <Set>DrwTyp=3</Set>
         <Set>ItgTyp=1</Set>
         <Set>TxnAtr= </Set>
         <Set>MstChk=1</Set>
         <Set>RecTyp=4</Set>
         <If condition="$PayMod=2">
            <Set>CnlTyp=0</Set>
         </If>
         <Else>
            <Set>CnlTyp=1</Set>
         </Else>
         <Exec func="PUB:InsertJournal"/>

         <!--向主机提交冲账交易-->
         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <Set>Smr=财税关库行核对错账</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE">   <!--主机冲账-->
            <Arg name="HTxnCd" value="915950"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

         <Switch expression="~RetCod">    <!--交易未发送-->
            <Case value="-10">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">             <!--交易出错-->
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="X"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="T"/>
               </Exec>
               <Set>BilSts=T</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请抹账</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="S"/>
               </Exec>
               <Set>BilSts=5</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Exec func="PUB:UpdateJournalHost">
                  <Arg name="TxnSts" value="F"/>
               </Exec>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知主机错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>

   <Transaction code="915957" desc="差错处理人工冲账复核">
      <DynSentence name="GetTxnInf">   <!--查询登记薄记录信息-->
         <Sentence>
            SELECT BilSts,ActNo OActNo,TxnAmt OTxnAt,LogNo OLogNo,ActSqn,ActNam,PayTyp,PayMod,DrwTyp,CBrkNo BrkNo
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf2">   <!--查询主机流水表信息-->
         <Sentence>
            SELECT HLogNo OHLogNo,TTxnCd OTTxnCd,TckNo OTckNo
            FROM tiptxnjnl
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnJnl">   <!--更新主机交易流水-->
         <Sentence>
            UPDATE tiptxnjnl
            SET Status='%s'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>Status|OLogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdTxnBok">   <!--更新人行账务登记薄-->
         <Sentence>
            UPDATE tiptxnbok
            SET BilSts='%s'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>BilSts|OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <!--检查流水是否存在-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>

        <!--Modified by sundx at 20090710 for cq76186-->
         <Set>BrNo=$BrkNo</Set>          <!--取国库关联行为记账分行号-->
         <!--Quote name="GetBrkCTL"/-->  <!--根据网点号取分行号-->

         <!--Quote name="ChkNodNo"/-->  <!--检查网点是否国库关联行的账务中心-->
         
         <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非账务中心，拒绝交易</Set>
            <Return/>
         </If>
         <!--Ended by sundx at 20090710 for cq76186-->

         <!--检查账号是否一致-->
         <If condition="IS_NOEQUAL_STRING($ActNo,$OActNo)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=账号与原交易账号不一致</Set>
            <Return/>
         </If>

         <!--检查金额是否一致-->
         <If condition="IS_NOEQUAL_STRING($TxnAmt,$OTxnAt)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=金额与原交易金额不一致</Set>
            <Return/>
         </If>

         <!--检查交易状态-->
         <If condition="$BilSts!=5">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=原交易非冲账待复核状态，不能进行复核</Set>
            <Return/>
         </If>

         <!--向主机提交冲账复核交易-->
         <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="GetTxnInf2"/>
         </Exec>
         <Set>ActNod=STRCAT(SUBSTR($BrkNo,1,3),800)</Set>
         <Set>Smr=财税关库行核对错账</Set>
         <Exec func="PUB:GetLogNo"/>
         <If condition="$PayMod=2">
            <Set>CnlTyp=0</Set>
         </If>
         <Else>
            <Set>CnlTyp=1</Set>
         </Else>
         <Exec func="PUB:CallHostOther" error="IGNORE">   <!--主机冲账复核-->
            <Arg name="HTxnCd" value="915957"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

         <Switch expression="~RetCod">
            <Case value="-10">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=向主机发送交易失败</Set>
               <Return/>
            </Case>
            <Case value="-2">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统错误</Set>
               <Return/>
            </Case>
            <Case value="-1">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=系统运行超时,请查询</Set>
               <Return/>
            </Case>
            <Case value="-9">
               <Return/>
            </Case>
            <Case value="3">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=$HRspCd</Set>
               <Return/>
            </Case>
            <Case value="0">
               <Set>Status=1</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnJnl"/>
               </Exec>
               <Set>BilSts=6</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdTxnBok"/>
               </Exec>
               <Break/>
            </Case>
            <Default>
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910699</Set>
               <Set>RspMsg=未知错误,请联系电脑运行中心</Set>
               <Return/>
            </Default>
         </Switch>
      </FlowCtrl>
   </Transaction>


   <!--Modified By zhq_BoCom00044952_20080731-->
   <!--Modified By zhq_BoCom00047053_20080902-->
   <Transaction code="915190">  <!--对私三方协议维护-->
      <DynSentence name="ChkOrgCod">   <!--检查征收机关是否已存在-->
         <Sentence>
            SELECT EffDat
            FROM tiporginf
            WHERE OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="ChkAgrNo">   <!--检查协议编号是否已存在且有效-->
         <Sentence>
            SELECT Status,VrySts
            FROM tipcusagr
            WHERE AgrNo='%s' and ActNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
      </DynSentence>

      <DynSentence name="ChkTCusId">   <!--检查纳税人代码是否已签约-->
         <Sentence>
            SELECT TCusId,Status OStatus
            FROM tipcusagr
            WHERE TCusId='%s' and OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TCusId|OrgCod|</Fields>
      </DynSentence>
 
      <DynSentence name="DelAgrRec">   <!--删除协议记录-->
         <Sentence>
            DELETE
            FROM tipcusagr
            WHERE AgrNo='%s' and ActNo='%s'
            AND Status='1'
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
      </DynSentence>
 
      <DynSentence name="UpdAgrInf">   <!--更新协议信息-->
         <Sentence>
            TCusId='%s' and OrgCod='%s'
         </Sentence>
         <Fields>TCusId|OrgCod|</Fields>
      </DynSentence>
 
      <DynSentence name="UpdCusAgr">   <!--按照协议编号更新协议信息-->
         <Sentence>
            AgrNo='%s' and ActNo='%s'
         </Sentence>
         <Fields>AgrNo|ActNo|</Fields>
      </DynSentence>

      <DynSentence name="ChkAgrInf">   <!--根据征收机关号和纳税人代码检查协议是否存在-->
         <Sentence>
            SELECT *
            FROM tipcusagr
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND BrkNo='%s'
            AND Status='0'
            FOR READ ONLY
         </Sentence>
         <Fields>TCusId|OrgCod|BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="DelAgrInf">   <!--将协议置为无效-->
         <!--Modified By zhq_BoCom00047053_20080904-->
         <!--Sentence>
            UPDATE tipcusagr
            SET Status='1',VrySts='2'
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND BrkNo='%s'
         </Sentence>
         <Fields>TCusId|OrgCod|BrkNo|</Fields-->
         
         <Sentence>
            UPDATE tipcusagr
            SET Status='1',VrySts='2',CnlDat='%s'
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND BrkNo='%s'
         </Sentence>
         <Fields>CnlDat|TCusId|OrgCod|BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetAgrInf">   <!--查询协议信息-->
         <Sentence>
            SELECT *
            FROM tipcusagr
            WHERE TCusId='%s'
            AND OrgCod='%s'
            AND BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TCusId|OrgCod|BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetAgrInf2">   <!--三方协议模糊查询-->
         <Sentence>
            SELECT *
            FROM tipcusagr
            WHERE (OrgCod='%s' OR '%s'='A')
            AND (TCusId='%s' OR '%s'='B')
            AND (AgrNo='%s' OR '%s'='C')
            AND (ActNo='%s' OR '%s'='D')
            AND (ONodNo='%s' OR '%s'='E')
            AND (VrySts='%s' OR '%s'='F')
            AND BrkNo='%s'
            ORDER BY AgrNo
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|OrgCod|TCusId|TCusId|AgrNo|AgrNo|ActNo|ActNo|ONodNo|ONodNo|VrySts|VrySts|BrkNo|</Fields>
      </DynSentence>

      <DynSentence name="GetAgrInf3">   <!--查询协议信息-->
         <Sentence>
            SELECT AgrNo,TCusNm,ActNo,ActNam,RecTm,ONodNo,PrtNod,NodNo as RegNo,TlrId,Status,VrySts
            FROM tipcusagr
            WHERE TCusId='%s'
            AND OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>TCusId|OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="GetWorkDt">
         <Sentence>
            SELECT WorkDt FROM  tipsyssts
         </Sentence>
      </DynSentence>

      <DynSentence name="GetPBnkNo">   <!--查询付款行号-->
         <Sentence>
            SELECT PBnkNo
            FROM tipbrkinf
            WHERE BrkNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>BrkNo|</Fields>
      </DynSentence>
 
      <DynSentence name="ChkAgrNo2">   <!--检查协议编号是否已存在且有效-->
         <Sentence>
            SELECT Status
            FROM tipcusagr
            WHERE AgrNo='%s' and OrgCod='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>AgrNo|OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="DelThdPro"><!--删除协议-->
         <Sentence>
            DELETE FROM tipcusagr WHERE AgrNo='%s' AND OrgCod='%s' AND (VrySts='0' OR VrySts='2')
         </Sentence>
         <Fields>AgrNo|OrgCod|</Fields>
      </DynSentence>

      <DynSentence name="ChkVrySts"><!--检查协议状态-->
         <Sentence>
            SELECT  * FROM tipcusagr WHERE AgrNo='%s' AND OrgCod='%s' AND (VrySts='0' OR VrySts='2')
         </Sentence>
         <Fields>AgrNo|OrgCod|</Fields>
      </DynSentence>


      <Quote name="GetBrkSQL"/>  <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>PrtNod= </Set>
         <Set>ONodNo= </Set>
         
         <If condition="$OprTyp!=5">
            <Exec func="PUB:ReadRecord" error="IGNORE">  <!--检查征收机关是否存在-->
               <Arg name="SqlCmd" value="ChkOrgCod"/>
            </Exec>
            <If condition="~RetCod=-2">
               <Set>RspCod=910212</Set>
               <Set>RspMsg=征收机关不存在，交易拒绝</Set>
               <Return/>
            </If>
            <ElseIf condition="~RetCod=0">
               <If condition="INTCMP($ActDat,1,$EffDat)">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910611</Set>
                  <Return/>
               </If>
            </ElseIf>
            <Else>
               <Return/>
            </Else>
            <!--Set>RecTm=GETDATETIME()</Set-->
         </If>
         
         <!--签约 解约时须校验密码-->
         <If condition="OR(IS_EQUAL_STRING($OprTyp,1),IS_EQUAL_STRING($OprTyp,3),IS_EQUAL_STRING($OprTyp,2))">
            <Set>TxnCnl=0</Set>
            <Set>PayTyp=1</Set>
            <Set>PinTyp=2</Set>
            <Set>Pin=$PinBlk</Set>
            <Set>CcyCod=CNY</Set>
            <If condition="$ActFlg=2">    <!--卡-->
               <Set>ActTyp=4</Set>
            </If>
            <ElseIf condition="$ActFlg=3"><!--折-->
               <Set>ActTyp=2</Set>
            </ElseIf>
            <Else>                        <!-- 一本通($ActFlg=4) -->
               <Set>ActTyp=1</Set>
               <Set>ActSqn=$ActSeq</Set>              
            </Else>

            <Set>TTxnCd=476510</Set>
            <Exec func="PUB:CallHostAcc" error="IGNORE">  <!--上主机校检密码-->
               <Arg name="HTxnCd" value="476510"/>
               <Arg name="ObjSvr" value="SHSTPUB1"/>
            </Exec>
            <If condition="~RetCod=3">
               <Return/>
            </If>
         </If>
         
         <Set>SBrNo=$BrNo</Set>
         <Quote name="GetBrkCTL"/>  <!--根据网点号取分行号-->
         <Set>TTxnCd=915190</Set><!--重新设置前置交易码-->
         <Switch expression="$OprTyp">
            <Case value="1">  <!--增加协议-->
               <!--授权检查-->
               <!--Exec func="PUB:AddAuthReason" >
               <Arg name="AthCod" value="30" />
               <Arg name="AthMsg" value="915190" />
               </Exec>
               <Exec  func="PUB:CheckLocalAuth" >
               <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec-->
             <!--Modified by ly at 20090715 for cq73476,不允许单位准贷记卡以及非第一单位借记卡签约-->
              <Set>TTxnCd=476520</Set>   
               <!--上主机账户信息查询--> 
              <Exec func="PUB:CallHostOther" error="IGNORE"> 
                 <Arg name="HTxnCd" value="476520"/>
                 <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>    
              <If condition="$CpFlg=1">  <!--商务卡-->
                 <If condition="$CrdTyp!=0">
                   <Set>RspCod=910699</Set>
                   <Set>RspMsg=该商务卡非单位借记卡</Set>
                   <Return/>
                 </If>
                
                 <If condition="$ManFlg=1">
                   <Set>RspCod=910699</Set>
                   <Set>RspMsg=该卡为附属卡</Set>
                  <Return/>
                 </If>
              </If>
              <!--Ended by ly at 20090715 for cq73476,不允许单位准贷记卡以及非第一单位借记卡签约-->
               <Exec func="PUB:ReadRecord" error="IGNORE">  <!--检查协议编号是否已存在-->
                  <Arg name="SqlCmd" value="ChkAgrNo"/>
               </Exec>
               <If condition="~RetCod=-1">
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$Status=1">
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="DelAgrRec"/>
                     </Exec>
                  </If>
                  <Else>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910204</Set>
                     <Set>RspMsg=该协议已经存在，交易拒绝</Set>
                     <Return/>
                  </Else>
               </ElseIf>
               <Else>
                  <Set>RspCod=000000</Set>
               </Else>
               
               <Exec func="PUB:ReadRecord" error="IGNORE">  <!--检查协议编号是否已存在-->
                  <Arg name="SqlCmd" value="ChkAgrNo2"/>
               </Exec>
               <If condition="~RetCod=-1">
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$Status=1">
                     <Exec func="PUB:ExecSql">
                        <Arg name="SqlCmd" value="DelThdPro"/>
                     </Exec>
                  </If>
                  <Else>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910204</Set>
                     <Set>RspMsg=该协议已经存在，交易拒绝</Set>
                     <Return/>
                  </Else>
               </ElseIf>
               <Else>
                  <Set>RspCod=000000</Set>
               </Else>
               
               <Exec func="PUB:ReadRecord" error="IGNORE">  <!--检查纳税人代码是否已签约-->
                  <Arg name="SqlCmd" value="ChkTCusId"/>
               </Exec>
               <If condition="~RetCod=-1">
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$OStatus=1">
                     <Set>Status=0</Set>
                     <!--重新签约的时候,记录签约日期,并置验证日期为空-->
                     <Set>SgnDat=STRCAT($ActDat,GETDATETIME(HHMISS))</Set>
                     <Set>RecTm= </Set>  
                     <Exec func="PUB:UpdateRecord">
                        <Arg name="TblNam" value="tipcusagr"/>
                        <Arg name="CndSts" value="UpdAgrInf"/>
                     </Exec>
                     <Set>VrySts=0</Set>
                     <Return/>
                  </If>
                  <Else>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910205</Set>
                     <Set>RspMsg=纳税人编码已签约</Set>
                     <Return/>
                  </Else>
               </ElseIf>
               <Else>
                  <Set>RspCod=000000</Set>
               </Else>
               
               <Set>Status=0</Set>
               <Set>VrySts=0</Set>
               <Set>SgnDat=STRCAT($ActDat,GETDATETIME(HHMISS))</Set> 
               <Set>RecTm= </Set>              
               <!--modify ActFlg as  2,3,4 20071024-->
               <!--If condition="$ActFlg=2">
               <Set>ActFlg=1</Set>
               </If>
               <ElseIf condition="$ActFlg=3">
               <Set>ActFlg=2</Set>
               </ElseIf>
               <ElseIf condition="$ActFlg=4">
               <Set>ActFlg=3</Set>
               </ElseIf-->
               <Exec func="PUB:InsertRecord">
                  <Arg name="TblNam" value="tipcusagr"/>
               </Exec>
               <Goto>Call915880</Goto>
               <Break/>
            </Case>
            <Case value="2">  <!--修改协议-->
               <!--授权检查  BoCom00030174-->
               <Exec func="PUB:AddAuthReason" >
                  <Arg name="AthCod" value="40" />
                  <Arg name="AthMsg" value="915120" />
               </Exec>
               
               <Exec  func="PUB:CheckLocalAuth" >
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               
               <Exec func="PUB:UpdateRecord">  <!--修改协议-->
                  <Arg name="TblNam" value="tipcusagr"/>
                  <Arg name="CndSts" value="UpdAgrInf"/>
               </Exec>
               
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetAgrInf3"/>
               </Exec>
               <Goto>Call915880</Goto>
               <Break/>
            </Case>
            <Case value="3">  <!--协议解约-->
               <!--授权检查-->
               <!--Exec func="PUB:AddAuthReason" >
               <Arg name="AthCod" value="30" />
               <Arg name="AthMsg" value="915120" />
               </Exec>
               <Exec  func="PUB:CheckLocalAuth" >
               <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec-->

               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="ChkAgrInf"/>
               </Exec>
               <If condition="~RetCod=-2">
                  <Set>RspCod=910213</Set>
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$ActFlg=0">
                     <Set>RspMsg=非对私账户不得解约</Set>
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910226</Set>
                     <Return/>
                  </If>
               </ElseIf>
               <Else>
                  <Return/>
               </Else>

               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetPBnkNo"/>
               </Exec>
               
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetWorkDt"/>
               </Exec>
               
               <Set>BrNo=$SBrNo</Set>
               <!--向人行发送协议撤销请求-->
               <Exec func="PUB:GetPubSeqNoCircle">
                  <Arg name="SeqNam" value="TIP:VCSeq"/>
                  <Arg name="SeqCnd" value="VCSeq"/>
                  <Arg name="Len" value="8"/>
               </Exec>

               <Set>VCSeq=$SelVal</Set>
               <Set>SOrgCd=$PBnkNo</Set>
               <Set>EntDat=$WorkDt</Set>
               <Set>VCFlag=1</Set>
               <Quote name="GetSeq"/>
               <Set>MsgRef=$MsgId</Set>
               <!--zy for test-->
               <!--Exec func="PUB:CallThirdOther">
               <Arg name="HTxnCd" value="918830"/>
               <Arg name="ObjSvr" value="MMQMTIP1"/>
               </Exec>
               <If condition="~RetCod=3">
               <Set>RspCod=910699</Set>
               <Set>RspMsg=$AddWord</Set>
               <Return/>
               </If-->

               <Exec func="PUB:ExecSql">  <!--将协议状态置为无效-->
                  <Arg name="SqlCmd" value="DelAgrInf"/>
               </Exec>
               <Set>Status=1</Set>
               <Goto>Call915880</Goto>
               <Break/>
            </Case>
            <Case value="4">  <!--查询协议-->
               <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="GetAgrInf"/>
               </Exec>
               <Return/>
            </Case>
            <Case value="5">  <!--三方协议模糊查询-->
               <If condition="ISNULL($OrgCod)">
                  <Set>OrgCod=A</Set>
               </If>
               <If condition="ISNULL($TCusId)">
                  <Set>TCusId=B</Set>
               </If>
               <If condition="ISNULL($AgrNo)">
                  <Set>AgrNo=C</Set>
               </If>
               <If condition="ISNULL($ActNo)">
                  <Set>ActNo=D</Set>
               </If>
               <If condition="ISNULL($ONodNo)">
                  <Set>ONodNo=E</Set>
               </If>
               <If condition="ISNULL($VrySts)">
                  <Set>VrySts=F</Set>
               </If>
               <Exec func="PUB:MultiQuery">
                  <Arg name="SqlCmd" value="GetAgrInf2"/>
               </Exec>
               <Return/>
            </Case>
            <Case value="6">  <!--删除三方协议-->
               <!--授权检查-->
               <Exec func="PUB:AddAuthReason">
                  <Arg name="AthCod" value="50" />
                  <Arg name="AthMsg" value="915120" />
               </Exec>
 
               <Exec  func="PUB:CheckLocalAuth" >
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
 
               <!--状态为未验证、验证失败才能删除-->
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="ChkStaSts"/>
               </Exec>
               <If condition="~RetCod=-2">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910213</Set>
                  <Set>RspMsg=该协议不存在</Set>
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=0">
                  <If condition="$VrySts=1">
                     <Set>MsgTyp=E</Set>
                     <Set>RspCod=910699</Set>
                     <Set>RspMsg=该协议已验证通过，不允许删除</Set>
                     <Return/>
                  </If>
                  <Else>
                     <If condition="$Status=1">
                        <Set>MsgTyp=E</Set>
                        <Set>RspCod=910699</Set>
                        <Set>RspMsg=该协议已经无效，无须删除</Set>
                        <Return/>
                     </If>
                  </Else>
               </ElseIf>
               <Else>
                  <Return/>
               </Else>
               <!--Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="ChkVrySts"/>
               </Exec>
               <If condition="~RetCod=-2">
               <Set>MsgTyp=E</Set>
               <Set>RspCod=910213</Set>
               <Set>RspMsg=协议不存在</Set>
               <Return/>
               </If-->
               <Exec func="PUB:ExecSql" error="IGNORE"><!--删除第三方协议-->
                  <Arg name="SqlCmd" value="DelThdPro"/>
               </Exec>
               <Goto>Call915880</Goto>
            </Case>
            <Default>
               <Set>MsgTyp=E</Set>
               <Return/>
            </Default>
         </Switch>
         
         <Label>Call915880</Label>
         <!--重新设置请求类型和授权级别-->
         <Set>TIATyp=T</Set>
         <Set>AthLvl=00</Set>         
         <!--产生非会计流水-->
         <Exec  func="PUB:GetLogNo"/>
         <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,交易柜员:,$TlrId)</Set>
         <Exec func="PUB:CallHostOther">
            <Arg name="TxnCod" value="915880" />
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>
         <Set>RspCod=000000</Set>
      </FlowCtrl>
   </Transaction>

   <!--Modified by sundx at 20090414 for cq64047,使单位卡也能完成缴税功能-->
   <Transaction code="918716" desc="嵌套查询账户信息">
      <FlowCtrl>
         <Quote name="Init"/>
         <Set>TTxnCd=476520</Set>
         <If condition="$ActFlg=2">
            <Set>ActTyp=4</Set>
         </If>
         <ElseIf condition="$ActFlg=3">
            <Set>ActTyp=2</Set>
         </ElseIf>
         <ElseIf condition="$ActFlg=4">
            <Set>ActTyp=1</Set>
            <Set>ActSqn=$ActSeq</Set>
         </ElseIf>
         <Set>CcyCod=CNY</Set>
         <Exec func="PUB:CallHostOther">  <!--上主机查询帐户信息-->
            <Arg name="HTxnCd" value="476520"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="$ManFlg=1">
            <Set>RspCod=910699</Set>
            <Set>RspMsg=该卡为附属卡</Set>
            <Return/>
         </If>
         <!--Modified by sundx at 20090414 for cq64047,使单位卡也能完成缴税功能-->
         <ElseIf condition="$CpFlg=1"> <!--商务卡-->
            <!--Modified by sundx at 20090510 for cq64047,使单位准贷记卡不能完成缴税功能-->              
            <If condition="$CrdTyp!=0">
               <Set>RspCod=910699</Set>
               <Set>RspMsg=该商务卡非单位借记卡</Set>
               <Return/>
            </If>               
         </ElseIf>
         <!--Ended by sundx at 20090414 for cq64047,使单位卡也能完成缴税功能-->
      </FlowCtrl>
   </Transaction>

   <Transaction code="915230">  <!--财政零余额帐户维护-->
      <DynSentence name="UpdCnd">
         <Sentence>
            ActNo='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <DynSentence name="DelRec">
         <Sentence>
            Delete from tipfapact where ActNo='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <DynSentence name="QryFapAct">
         <Sentence>
            Select ActNo from tipfapact where ActNo='%s'
         </Sentence>
         <Fields>ActNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>


         <Switch expression="$OprTyp">
            <Case value="1"><!--新增-->
               <Exec func="PUB:ReadRecord" error="IGNORE">
                  <Arg name="SqlCmd" value="QryFapAct"/>
               </Exec>
               <If condition="~RetCod=0">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=910699</Set>
                  <Set>RspMsg=该账户已经签约</Set>
                  <Return/>
               </If>
               <ElseIf condition="~RetCod=-2">
                  <Set>MsgTyp=N</Set>
                  <Set>RspCod=000000</Set>
                  <Exec func="PUB:InsertRecord" errror="IGNORE">
                     <Arg name="TblNam" value="tipfapact"/>
                  </Exec>
                  <If condition="~RetCod!=0">
                     <Return/>
                  </If>
                  <Goto>Call915880</Goto>
                  <Break/>
               </ElseIf>
            </Case>
            <Case value="2"><!--修改-->
               <!--授权检查-->
               <Exec func="PUB:AddAuthReason" >
                  <Arg name="AthCod" value="40" />
                  <Arg name="AthMsg" value="915825" />
               </Exec>
               <Exec  func="PUB:CheckLocalAuth" >
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               <Exec func="PUB:UpdateRecord">
                  <Arg name="TblNam" value="tipfapact"/>
                  <Arg name="CndSts" value="UpdCnd"/>
               </Exec>
               <Goto>Call915880</Goto>
               <Break/>
            </Case>
            <Case value="3"><!--删除-->
               <!--授权检查-->
               <Exec func="PUB:AddAuthReason" >
                  <Arg name="AthCod" value="40" />
                  <Arg name="AthMsg" value="915825" />
               </Exec>
               <Exec  func="PUB:CheckLocalAuth" >
                  <Arg name="ObjSvr" value="SHSTPUB1" />
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="DelRec"/>
               </Exec>
               <Goto>Call915880</Goto>
               <Break/>
            </Case>
            <Default>
               <Return/>
            </Default>
         </Switch>
         <Label>Call915880</Label>
         <!--产生非会计流水-->
         <Exec  func="PUB:GetLogNo"/>
         <Set>NoteInfo=STRCAT(交易码:,$TTxnCd,机构:,$NodNo,终端:,$TrmNo,交易柜员:,$TlrId)</Set>
         <Exec func="PUB:CallHostOther">
            <Arg name="TxnCod" value="915880" />
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Return/>
         </If>
      </FlowCtrl>
   </Transaction>
   <!--Modified by zhq_BoCom00031148_20080128-->
   <Transaction code="915132" desc="查询协议验证流水信息">
      <!--检查征收机关代码-->
      <!--DynSentence name="ChkOrgCod">
      <Sentence>
      SELECT 'Y' YN FROM TABLE(VALUES(1)) AS anony WHERE EXISTS
      (SELECT 'Y' FROM tipvryjnl WHERE BrkNo ='%s' AND WrkDat='%s' AND OrgCod='%s')
      </Sentence>
      <Fields>BrNo|WrkDat|OrgCod|</Fields>
      </DynSentence-->
      <!--检查付款行支付行号-->
      <!--DynSentence name="ChkPBnkNo">
      <Sentence>
      SELECT 'Y' YN FROM TABLE(VALUES(1)) AS anony WHERE EXISTS
      (SELECT 'Y' FROM tipvryjnl WHERE BrkNo ='%s' AND WrkDat='%s' AND PBnkNo='%s')
      </Sentence>
      <Fields>BrNo|WrkDat|PBnkNo|</Fields>
      </DynSentence-->
      <!--检查帐号-->
      <!--DynSentence name="ChkActNo">
      <Sentence>
      SELECT 'Y' YN FROM TABLE(VALUES(1)) AS anony WHERE EXISTS
      (SELECT 'Y' FROM tipvryjnl WHERE BrkNo ='%s' AND WrkDat='%s' AND ActNo='%s')
      </Sentence>
      <Fields>BrNo|WrkDat|ActNo|</Fields>
      </DynSentence-->
      <!--根据输入信息查询相关信息-->
      <DynSentence name="ChkDetail">
         <Sentence>
            SELECT * FROM tipvryjnl
            WHERE WrkDat='%s'
            AND (OrgCod='%s'  OR '%s'=' ')
            AND ((PBnkNo='%s' OR '%s'=' ') AND (PBnKNo IN (SELECT PBnkNo FROM tipbrkinf WHERE  BrkNo ='%s') ) )
            AND (ActNo='%s'   OR '%s'=' ')
            AND LEFT(VryInfo,1) ='2' FOR READ ONLY
         </Sentence>
         <Fields>WrkDat|OrgCod|OrgCod|PBnkNo|PBnkNo|BrNo|ActNo|ActNo|</Fields>
      </DynSentence>

      <Quote name="GetBrkSQL" /> <!--根据地区号取分行号-->
      <FlowCtrl>
         <Quote name="GetBrkCTL" /> <!--根据网点号取分行号-->
         <!--If condition="IS_NOEQUAL_STRING(STRLEN(DELBOTHSPACE($OrgCod)),0)">
         <Set>Sentence=ChkOrgCod</Set>
         <Set>RCode=910212</Set>
         <Set>RetMsg=征收机关不存在</Set>
         <Quote name="ChkTipSts"/>
         </If>
         <Else>
         <Set>OrgCod= </Set>
         </Else>

         <If condition="IS_NOEQUAL_STRING(STRLEN(DELBOTHSPACE($PBnkNo)),0)">
         <Set>Sentence=ChkPBnkNo</Set>
         <Set>RetMsg=付款行支付行号不存在</Set>
         <Set>RCode=910620</Set>
         <Quote name="ChkTipSts"/>
         </If>
         <Else>
         <Set>PBnkNo= </Set>
         </Else>
         <If condition="IS_NOEQUAL_STRING(STRLEN(DELBOTHSPACE($ActNo)),0)">
         <Set>Sentence=ChkActNo</Set>
         <Set>RetMsg=账号不存在</Set>
         <Set>RCode=910621</Set>
         <Quote name="ChkTipSts"/>
         </If>
         <Else>
         <Set>ActNo= </Set>
         </Else-->
         <Exec func="PUB:MultiQuery" error="IGNORE">
            <Arg name="SqlCmd" value="ChkDetail"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=478053</Set>
            <Set>RspMsg=查询条件不符数据库无对应记录</Set>
         </If>
      </FlowCtrl>
   </Transaction>

   <!--Added By zhq_BoCom00045601_20080820--> 
   <Transaction code="915899" desc="自动冲帐抹帐">
      <DynSentence name="GetTxnInf">    <!--查询登记薄记录信息-->
         <Sentence>
            SELECT BilSts,ChkSts,HTxnSt,ActDat OActDt,TlrId OTlrId,LogNo,PayMod
            FROM tiptxnbok
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|ActDat|</Fields>
      </DynSentence>
      <DynSentence name="GetTxnInf2">   <!--根据前置流水号在主机流水表查询原主机交易码和原前置交易码-->
         <Sentence>
            SELECT HTxnCd,TTxnCd
            FROM tiptxnjnl
            WHERE LogNo='%s'
            FOR READ ONLY
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdHTxnSt1">   <!--根据前置流水号更新人行账务登记薄中的主机交易状态和交易状态为已冲正-->
         <Sentence>
            UPDATE tiptxnbok
            SET HTxnSt='C',BilSts='C'
            WHERE OrgCod='%s'
            AND EntDat='%s'
            AND TraNo='%s'
         </Sentence>
         <Fields>OrgCod|EntDat|TraNo|</Fields>
      </DynSentence>
      <DynSentence name="UpdHTxnSt2">   <!--根据前置流水号更新主机流水表中的主机交易状态为已冲正-->
         <Sentence>
            UPDATE tiptxnjnl
            SET HTxnSt='C',TxnSts='C'
            WHERE LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
      </DynSentence>
      <Quote name="GetBrkSQL"/>         <!--根据网点号取分行号-->
      <FlowCtrl>
         <Quote name="Init"/>
         
         <Exec func="PUB:ReadRecord">   <!--检查流水是否存在-->
            <Arg name="SqlCmd" value="GetTxnInf"/>
         </Exec>

         <Quote name="GetBrkCTL"/>      <!--根据网点号取分行号-->

         <Quote name="ChkNodNo"/>       <!--检查网点是否是国库关联行的账务中心-->

         <!--检查原交易缴款模式-->
         <If condition="AND(IS_NOEQUAL_STRING($PayMod,0),IS_NOEQUAL_STRING($PayMod,1))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非人行发起的交易，不能用该交易抹账</Set>
            <Return/>
         </If>

         <!--检查核对状态-->
         <If condition="AND(IS_EQUAL_STRING($BilSts,1),INTCMP($ChkSts,1,2))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=该交易未核对或已核对成功，不能抹账</Set>
            <Return/>
         </If>

         <!--检查主机交易状态-->
         <If condition="AND(IS_NOEQUAL_STRING($HTxnSt,S),IS_NOEQUAL_STRING($HTxnSt,U),IS_NOEQUAL_STRING($HTxnSt,T))">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=主机交易失败或原交易已抹账，无须抹账</Set>
            <Return/>
         </If>
         
         <!--检查交易柜员-->
         <If condition="IS_NOEQUAL_STRING($TlrId,$OTlrId)">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=910699</Set>
            <Set>RspMsg=非原交易柜员，不能抹账</Set>
            <Return/>
         </If>

         <!--根据前置流水号在主机流水表中查询原主机交易码和原前置交易码-->
         <Exec func="PUB:ReadRecord" error="IGNORE">
            <Arg name="SqlCmd" value="GetTxnInf2"/>
         </Exec>
         
         
         <Set>HTxnCd=STRCAT(SUBSTR($HTxnCd,1,5),9)</Set>
         <Set>TTxnCd=STRCAT(SUBSTR($TTxnCd,1,5),9)</Set>
         <Set>TIATyp=C</Set>
         <Exec func="PUB:CallHostAcc" error="IGNORE">
            <Arg name="HTxnCd" value="959999"/>
            <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>
         <!--主机超时-->
         <If condition="~RetCod=-1">
            <Set>RspCod=910605</Set>
            <Set>RspMsg=主机抹账超时,请继续抹账</Set>
            <Return/>
         </If>
         <!--未发送或系统错误-->
         <ElseIf condition="OR(IS_EQUAL_STRING(~RetCod,-10),IS_EQUAL_STRING(~RetCod,-2))">
            <Set>RspCod=910606</Set>
            <Set>RspMsg=主机抹账失败,请继续抹账</Set>
            <Return/>
         </ElseIf>
         <!--抹账失败-->
         <ElseIf condition="~RetCod=3"> 
            <If condition="OR(IS_EQUAL_STRING($HRspCd,AG8001),IS_EQUAL_STRING($HRspCd,AG8981),IS_EQUAL_STRING($HRspCd,SC6129),IS_EQUAL_STRING($HRspCd,SC6034))"> <!--认为抹账成功-->
               <Set>HTxnSt=C</Set>
               <Set>TxnSts=C</Set>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdHTxnSt1"/>
               </Exec>
               <Exec func="PUB:ExecSql">
                  <Arg name="SqlCmd" value="UpdHTxnSt2"/>
               </Exec>
               <Set>MsgTyp=N</Set>
               <Set>RspCod=000000</Set>
            </If>
            <Else>
               <Return/>
            </Else>
         </ElseIf>
         <!--交易成功-->
         <ElseIf condition="~RetCod=0"> 
            <Set>HTxnSt=C</Set>
            <Set>TxnSts=C</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdHTxnSt1"/>
            </Exec>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="UpdHTxnSt2"/>
            </Exec>
         </ElseIf>
         <!--其他返回类型-->
         <Else>
            <Return/>
         </Else>
      </FlowCtrl>
   </Transaction>
   
   <!--Added by sundx for cq67956 at 20090504 -->
   <Transaction code="915161" desc="转发分行到国库的xml报文">
      <DynSentence name="SelWrkDt">              <!--查询人行工作日期-->
         <Sentence>
            SELECT WorkDt WorkDate FROM tipsyssts FOR READ ONLY
         </Sentence>
         <Fields></Fields>
      </DynSentence>
      <FlowCtrl>
         <Exec func="PUB:InitTransaction"/>
         <Exec func="PUB:ReadRecord">             <!--查询人行工作日期-->
            <Arg name="SqlCmd" value="SelWrkDt"/>
         </Exec>
         <Set>HTxnCd=$MsgNo</Set>
         <Exec func="PUB:CallThirdOther" error="IGNORE">
            <Arg name="HTxnCd" value="$HTxnCd"/>
            <Arg name="ObjSvr" value="SMQMTIP2"/>
         </Exec>
         <!--If condition="~RetCod!=0">
            <Set>TRspCd=999999</Set>
            <Set>RspMsg=国库报文响应超时</Set>
            <Exec func="PUB:SetNoResponse"/>
         </If-->
         <Exec func="PUB:SetNoResponse"/>
      </FlowCtrl>
   </Transaction>
   
   <Transaction code="915162" desc="转发国库到分行的xml报文">
      <DynSentence name="SelBrInf1">              <!--查询分行号以及IP-->
         <Sentence>
            SELECT s1.NodNo,s1.IpAdr HstIp FROM puborginf s1,tipbrkinf s2 WHERE s1.NodNo=s2.BrkNo AND s2.PBnkNo='%s' FOR READ ONLY
         </Sentence>
         <Fields>AgtBnk|</Fields>
      </DynSentence>
      <DynSentence name="SelBrInf2">              <!--查询分行IP-->
         <Sentence>
            SELECT IpAdr HstIp FROM puborginf WHERE NodNo='%s' FOR READ ONLY
         </Sentence>
         <Fields>NodNo|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Exec func="PUB:InitTransaction"/>
         <Set>NodNo=SUBSTR($MsgRef,5,6)</Set>
         <If condition="OR(IS_EQUAL_STRING($MsgNo,9120),IS_EQUAL_STRING($MsgNo,9121))">
            <Exec func="PUB:ReadRecord">             <!--查询分行号以及IP-->
               <Arg name="SqlCmd" value="SelBrInf2"/>
            </Exec>
         </If>
         <Else>
            <Exec func="PUB:ReadRecord">             <!--查询分行号以及IP-->
               <Arg name="SqlCmd" value="SelBrInf1"/>
            </Exec>
         </Else>
         <!--往分行转发对应的报文-->          
         <Set>@MSG.SIP=$HstIp</Set>
         <Set>@MSG.OPT=30506</Set>
         <Set>@MSG.SDT=MTHDTIP1</Set>
         <Set>@MSG.STP=PLTOUT</Set>
         <Set>@MSG.STC=$MsgNo</Set>                  
         <Exec func="PUB:SendMessage" error="IGNORE"/>
      </FlowCtrl>
   </Transaction>
   <!--Added by sundx for cq67956 at 20090504 -->

   <!-- BoCom00067554 add by zhb 2009-7-24 start -->
   <Transaction code="915813" desc="缴税历史查询（列表）">
      <DynSentence name="QryTax">  
         <Sentence>
            SELECT OrgCod, TraNo, EntDat, ActNo,
                   TCusId, TaxVID, TTpNm, TxnAmt,
                   LvySts, OLvyNo
            FROM tiptxnbok 
            WHERE (ActDat &gt;= '%s' AND ActDat &lt;='%s') 
              AND OrgCod='%s'
              AND BilSts='1'
              AND (ActNo='%s' or '%s'='')
              AND TCusId='%s'
         </Sentence>
         <Fields>BActDt|EActDt|OrgCod|ActNo|ActNo|TCusId|</Fields>
      </DynSentence>
      <FlowCtrl>
         <Quote name="Init"/>

         <Exec func="PUB:QueryInGroup">
            <Arg name="SqlCmd" value="QryTax"/>
            <Arg name="RecordName" value="TaxRec"/>
         </Exec>
         <Set>QryCnt=$RecNum</Set>
      </FlowCtrl>
   </Transaction>

   <Transaction code="915814" desc="缴税历史查询（明细）">
      <DynSentence name="QryTTpDtl"> <!-- 税种历史明细查询 -->
         <Sentence>
            SELECT ProjId, TaxTNm, TaxBDt, TaxEDt, TaxTyp, TTpAmt, DtlNum 
            FROM tipttprec
            WHERE OrgCod='%s' AND TraNo='%s' AND  EntDat='%s'
         </Sentence>
         <Fields>OrgCod|TraNo|EntDat|</Fields>
      </DynSentence>
      <DynSentence name="QryTaxDtl">  <!-- 税目历史明细查询 -->
         <Sentence>
            SELECT DtlNo, TaxSbCd, TaxSbNm, TaxNum, TaxAmt, FTxAmt
            FROM tiptaxrec
            WHERE OrgCod='%s' AND TraNo='%s' AND  EntDat='%s' AND ProjId='%s'
         </Sentence>
         <Fields>OrgCod|TraNo|EntDat|ProjId1|</Fields>
      </DynSentence>
      <DynSentence name="QryTaxTCd">  <!-- 税种代码查询 -->
         <Sentence>
            SELECT TaxTCd FROM tiptaxtyp WHERE TaxTNm='%s'
         </Sentence>
         <Fields>TaxTNm|</Fields>
      </DynSentence>

      <FlowCtrl>
         <Quote name="Init"/>

         <Exec func="PUB:QueryInGroup">
            <Arg name="SqlCmd" value="QryTTpDtl"/>
            <Arg name="RecordName" value="TaxRec"/>
         </Exec>
         <Set>TTpNm=$RecNum</Set>

         <Set>TTpCnt=1</Set>
         <While condition="INTCMP($TTpCnt,2,$TTpNm)">
            <Exec func="PUB:GetValue">
               <Arg name="SourName" value="STRCAT(ROOT.TaxRec_,$TTpCnt,.ProjId)"/>
               <Arg name="DestName" value="ROOT.ProjId1"/>
            </Exec>
            <Exec func="PUB:GetValue">
               <Arg name="SourName" value="STRCAT(ROOT.TaxRec_,$TTpCnt,.DtlNum)"/>
               <Arg name="DestName" value="ROOT.DtlNum1"/>
            </Exec>

            <Exec func="PUB:GetValue">
               <Arg name="SourName" value="STRCAT(ROOT.TaxRec_,$TTpCnt,.TaxTNm)"/>
               <Arg name="DestName" value="ROOT.TaxTNm"/>
            </Exec>
            <Exec func="PUB:ReadRecord" error="IGNORE">
               <Arg name="SqlCmd" value="QryTaxTCd"/>
            </Exec>
            <If condition="~RetCod!=0">
               <Set>TaxTcd= </Set>
               <Set>RspCod=000000</Set>
            </If>
            <Exec func="PUB:SetValue">
               <Arg name="FieldName"  value="STRCAT(ROOT.TaxRec_,$TTpCnt,.TaxTCd)"/>
               <Arg name="FieldValue" value="$TaxTcd"/>
            </Exec>

            <Exec func="PUB:QueryInGroup">
               <Arg name="SqlCmd" value="QryTaxDtl"/>
               <Arg name="RecordName" value="TTpNmLst"/>
            </Exec>
            <Set>jCnt=1</Set>
            <While condition="INTCMP($jCnt,2,$DtlNum1)">
               <Exec func="PUB:GetValue">
                  <Arg name="SourName" value="STRCAT(ROOT.TTpNmLst_,$jCnt,.DtlNo)"/>
                  <Arg name="DestName" value="ROOT.DtlNo1"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxRec_,$TTpCnt,.DtlRec_,$jCnt,.DtlNo)"/>
                  <Arg name="FieldValue" value="$DtlNo1"/>
               </Exec>
               <Delete>DtlNo1</Delete>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName" value="STRCAT(ROOT.TTpNmLst_,$jCnt,.TaxSbCd)"/>
                  <Arg name="DestName" value="ROOT.TaxSbCd1"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxRec_,$TTpCnt,.DtlRec_,$jCnt,.TaxSbCd)"/>
                  <Arg name="FieldValue" value="$TaxSbCd1"/>
               </Exec>
               <Delete>TaxSbCd1</Delete>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName" value="STRCAT(ROOT.TTpNmLst_,$jCnt,.TaxSbNm)"/>
                  <Arg name="DestName" value="ROOT.TaxSbNm1"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxRec_,$TTpCnt,.DtlRec_,$jCnt,.TaxSbNm)"/>
                  <Arg name="FieldValue" value="$TaxSbNm1"/>
               </Exec>
               <Delete>TaxSbNm1</Delete>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName" value="STRCAT(ROOT.TTpNmLst_,$jCnt,.TaxNum)"/>
                  <Arg name="DestName" value="ROOT.TaxNum1"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxRec_,$TTpCnt,.DtlRec_,$jCnt,.TaxNum)"/>
                  <Arg name="FieldValue" value="$TaxNum1"/>
               </Exec>
               <Delete>TaxNum1</Delete>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName" value="STRCAT(ROOT.TTpNmLst_,$jCnt,.TaxAmt)"/>
                  <Arg name="DestName" value="ROOT.TaxAmt1"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxRec_,$TTpCnt,.DtlRec_,$jCnt,.TaxAmt)"/>
                  <Arg name="FieldValue" value="$TaxAmt1"/>
               </Exec>
               <Delete>TaxAmt1</Delete>

               <Exec func="PUB:GetValue">
                  <Arg name="SourName" value="STRCAT(ROOT.TTpNmLst_,$jCnt,.FTxAmt)"/>
                  <Arg name="DestName" value="ROOT.FTxAmt1"/>
               </Exec>
               <Exec func="PUB:SetValue">
                  <Arg name="FieldName"  value="STRCAT(ROOT.TaxRec_,$TTpCnt,.DtlRec_,$jCnt,.FTxAmt)"/>
                  <Arg name="FieldValue" value="$FTxAmt1"/>
               </Exec>
               <Delete>FTxAmt1</Delete>
               <Set>jCnt=ADD($jCnt,1)</Set>	
            </While>
            <Exec func="PUB:DeleteGroup">
               <Arg name="GroupName" value="TTpNmLst"/>
            </Exec>
            <Set>TTpCnt=ADD($TTpCnt,1)</Set>
         </While>
      </FlowCtrl>
   </Transaction>

   <Transaction code="915815" desc="导出基础数据">
      <FlowCtrl>
         <Quote name="Init"/>

         <!-- 生成数据文件 -->
         <Set>FilNam1=STRCAT(TIP_TIPORGINF_,$ActDat,.txt)</Set>
         <Set>FilNam2=STRCAT(TIP_TIPTAXTYP_,$ActDat,.txt)</Set>
         <Set>FilNam3=STRCAT(TIP_TIPTAXSBJ_,$ActDat,.txt)</Set>
         <!-- 生成list文件 -->
         <Set>FilLst=TIP_BASE_DATA_FILE.list</Set>

         <System command="ExportTipBaseData.sh">
            <Arg name="ActDat" value="$Actdat"/>
         </System>
         <!-- 用CD传输文件给ADE -->
         <Set>ObjDir=STRCAT(/app/ade/data/S1/TIP/,$ActDat)</Set>
         <Set>LclDir=dat/filesvr</Set>

         <Set>ObjFil=$FilNam1</Set>
         <Set>SrcFil=$ObjFil</Set>
         <Exec func="PUB:CDTransFile" error="IGNORE">
            <Arg name="FtpId" value="sigleput"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=文件传输错</Set>
            <Return/>
         </If>

         <Set>ObjFil=$FilNam2</Set>
         <Set>SrcFil=$ObjFil</Set>
         <Exec func="PUB:CDTransFile" error="IGNORE">
            <Arg name="FtpId" value="sigleput"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=文件传输错</Set>
            <Return/>
         </If>

         <Set>ObjFil=$FilNam3</Set>
         <Set>SrcFil=$ObjFil</Set>
         <Exec func="PUB:CDTransFile" error="IGNORE">
            <Arg name="FtpId" value="sigleput"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=文件传输错</Set>
            <Return/>
         </If>

         <Set>ObjFil=$FilLst</Set>
         <Set>SrcFil=$ObjFil</Set>
         <Exec func="PUB:CDTransFile" error="IGNORE">
            <Arg name="FtpId" value="sigleput"/>
         </Exec>
         <If condition="~RetCod!=0">
            <Set>RspCod=478399</Set>
            <Set>RspMsg=文件传输错</Set>
            <Return/>
         </If>
      </FlowCtrl>
   </Transaction>
   <!-- BoCom00067554 end -->
</Application>
