<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="EFEA" code="202">
  <!--电力电费业务本地主控-->
  <ConfigDeclare>

    <Config name="BatFormat"   value="etc/EFE_FMT_441999.XML"/>
    <Config name="ParaFile"    value="etc/CFG_EFE_441999.XML"/>
    <Config name="OPFCSW"      value="etc/EFE_CSW_441999.XML"/>

  </ConfigDeclare>
  <PackageDeclare>
    <Package name="AFE"        value="etc/DAFE_PKG.XML"/>
  </PackageDeclare>
  <TableDeclare>
    <Table name="afetxnjnl"    value="afetxnjnl"/>  <!--业务流水表-->
    <Table name="afebatrec"    value="afebatrec"/>  <!--批量扩展表-->
    <Table name="efeinfctl"    value="efeinfctl"/>  <!--银电开工控制表-->
    <Table name="efechkinf"    value="efechkinf"/>  <!--银电对账信息表-->
    <Table name="efechkdtl"    value="efechkdtl"/>  <!--银电对账明细表-->
    <Table name="efecusagt"    value="efecusagt"/>  <!--银电客户签约表-->
    <Table name="efebatinf"    value="efebatinf"/>  <!--银电批量代扣表-->
    <Table name="efechkrec"    value="efechkrec"/>  <!--银电对账记录表-->
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="AplCls"    value="202"/> <!--add by xuan_20101108-->
  </BusDefDeclare>
  <GlobalFunction>
    <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
    <!--add by xuan_20101108-->
    <Function name="_after">
        <Process>
           <If condition="ISNULL($MsgTyp)">
              <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                 <Set>MsgTyp=N</Set>
                 <Set>RspCod=000000</Set>
              </If>
              <Else>
                 <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                    <Set>MsgTyp=E</Set>
                 </If>
                 <Else>
                    <Set>MsgTyp=N</Set>
                 </Else>
              </Else>
           </If>
        </Process>
    </Function>
    <!--end by xuan_20101108-->
  </GlobalFunction>
  <Define>
    <Macro name="Chk_TxnSrc">  <!--检查交易来源-->
      <If condition="INTCMP(STRLEN(DELBOTHSPACE($TxnSrc)),3,0)">
        <Set>TxnCnl=TRM</Set>
        <Set>CnlTyp=0</Set>
      </If>
      <Else>
        <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TxnSrc"/>
          <Arg name="DestNam" value="CnlTyp"/>
          <Arg name="TblNam"  value="TxnSrc2CnlTyp"/>
        </Exec>
      </Else>
    </Macro>

    <Macro name="TxnSrc_TxnCnl">
      <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="TxnSrc"/>
        <Arg name="DestNam" value="TxnCnl"/>
        <Arg name="TblNam"  value="TxnSrc2TxnCnl"/>
      </Exec>
    </Macro>

  </Define>

<Transaction code="460200" desc="大小通道交易处理"> <!--RecSts 0:初始化 1:成功 2:失败-->
    <DynSentence name="UpdRecSts">
      <Sentence>
        UPDATE afebatrec SET RecSts='%s',HTxnSt='%s',HRspCd='%s' WHERE DskNo='%s' AND SeqNo='%s'
      </Sentence>
      <Fields>RecSts|HTxnSt|HRspCd|DskNo|SeqNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdRecSts1">
      <Sentence>
        UPDATE afebatrec SET HRspCd='%s', RecSts='2' WHERE DskNo='%s' AND SeqNo='%s'
      </Sentence>
      <Fields>RspCod|DskNo|SeqNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdThdJnl"><!--更新流水表-->
         <Sentence>
            LogNo='%s'
         </Sentence>
         <Fields>LogNo|</Fields>
    </DynSentence>
    <FlowCtrl>

      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>

      <Switch expression="$ActCls">
        <Case value="0" /> <!-- 对公 -->
        <Case value="4" >
          <If condition="INTCMP($TxnDir,3,0)"> <!--代收-->
            <Set>HTxnCd=451610</Set>
            <Set>HTxnCd=451610</Set>
            <Set>ActFlg=2</Set>  <!--Add by Lucky,20070614,扣款模式,2正常扣款-->
            <Set>ActSqn=SUBSTR($CActNo,14,5)</Set>
            <Set>ActNod=LEFTSTR($CActNo,6)</Set>
            <Set>BusTyp=CRP51</Set>
          </If>
          <ElseIf condition="INTCMP($TxnDir,3,1)">  <!--代付-->

          </ElseIf>
          <Break/>
        </Case>
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
          <If condition="INTCMP($TxnDir,3,0)"> <!--代收-->
            <Set>HTxnCd=471140</Set>
            <Set>VchCod=00000000</Set>
            <Set>TActNo=$CActNo</Set>
          </If>
          <ElseIf condition="INTCMP($TxnDir,3,1)"> <!--代付-->
            <Set>HTxnCd=471340</Set>
            <Set>PActNo=$CActNo</Set>
          </ElseIf>
          <Set>CcyTyp=1</Set>
          <Set>VchChk=1</Set>
          <Set>CnlTyp=0</Set>
          <Set>Mask=$BSmr</Set>
          <If condition="INTCMP($ActCls,3,3)">
            <Set>ActFlg=4</Set>
          </If>
          <Else>
            <Set>ActFlg=2</Set>
          </Else>
          <Break/>
        </Case>
        <Default>
          <Set>HRspCd=481210</Set>    <!--帐号检查错-->
          <Set>MsgTyp=N</Set>
          <Set>RecSts=2</Set>
          <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="UpdRecSts"/>
          </Exec>
          <Exec func="PUB:PutResponse"/>
          <Return/>
        </Default>
      </Switch>
      <!-- 上主机 -->
      <Set>TActNo=$CActNo</Set>

      <!--add by chen-->
      <Set>TxnTyp=N</Set>
      <Set>ItgTyp=0</Set>
      <Set>FRspCd=000000</Set>
      <Set>MstChk=1</Set>
      <Exec func="PUB:InsertRecordExt" error="IGNORE">
            <Arg name="TblNam" value="afetxnjnl"/>
      </Exec>
      <If condition="INTCMP(~RetCod,4,0)">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=插入流水表失败</Set>
            <Return/>
      </If>

      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="$HTxnCd"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>
      <If condition="~RetCod=0">  <!--recsts 0:初始化 1:成功 2:失败 -->
        <Set>HTxnSt=S</Set>
        <Set>HRspCd=SC0000</Set>
        <Exec func="PUB:UpdateRecordExt" error="IGNORE"> <!--更新记账信息-->
           <Arg name="TblNam" value="afetxnjnl"/>
           <Arg name="CndSts" value="UpdThdJnl"/>
        </Exec>
       
        <Set>RecSts=1</Set>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="UpdRecSts"/>
        </Exec>
        <Set>MsgTyp=N</Set>
        <Exec func="PUB:PutResponse"/>
        <Return/>
      </If>
      <ElseIf condition="~RetCod=3">  <!--recsts 0:初始化 1:成功 2:失败 -->
        <Set>HTxnSt=F</Set>
        <Exec func="PUB:UpdateRecordExt" error="IGNORE"> <!--更新记账信息-->
           <Arg name="TblNam" value="afetxnjnl"/>
           <Arg name="CndSts" value="UpdThdJnl"/>
        </Exec>

        <Set>RecSts=2</Set>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="UpdRecSts"/>
        </Exec>
        <Set>MsgTyp=N</Set>
        <Exec func="PUB:PutResponse"/>
        <Return/>
      </ElseIf>
    </FlowCtrl>

</Transaction>


  <Transaction code="460201" desc="银电业务开工交易">
  <!--自动冲正
    <Attributes>
      <Attribute name="integrity" value="2" code="482107" interval="5" timeout="30" maxtimes="15"/>
    </Attributes>
  -->
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryCrpAgr">             <!--查询单位信息 -->
      <Sentence>
        SELECT TActNo, BBusTyp FROM savcrpagr WHERE CAgtNo='%s' AND SvrSts='1'
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UdpInfCtl">             <!--修改开工信息表 -->
      <Sentence>
       UPDATE efeinfctl Set Status='%s',DlTxt='%s' WHERE BrNo='%s'
      </Sentence>
      <Fields>Status|DlTxt|BrNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

       <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
      <If condition="$Status=1">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=银电系统已在开工状态</Set>
        <Return/>
      </If>

      <Exec func="PUB:GetCommInf" error="IGNORE">
        <Arg name="CndId"  value="STRCAT(efe_,$BrNo)"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行IP设置</Set>
        <Return/>
      </If>

      <Set>@MSG.OIP=$HstIp</Set>  <!--第三方IP-->
      <Set>@MSG.OPT=$HstPrt</Set> <!--第三方PORT-->
      <Set>WTC=301</Set>          <!--委托节点代码-->

       <!--发送第三方-->
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="460201"/>
        <Arg name="ObjSvr" value="STHDEFEA"/>
      </Exec>
      <If condition="$RspCod=000000">
        <Set>MsgTyp=N</Set>
      </If>
      <Else>
        <Set>MsgTyp=E</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TRspCd"/>
          <Arg name="DestNam" value="RspMsg"/>
          <Arg name="TblNam"  value="EFE_TRspCd2RspMsg"/>
        </Exec>
        <Return/>
     </Else>

     <!--修改为开工状态-->
     <Set>Status=1</Set>
     <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd"   value="UdpInfCtl"/>
     </Exec>
     <If condition="~RetCod=-1">
      <Exec func="PUB:RollbackWork" error="IGNORE" />
      <Set>MsgTyp=E</Set>
      <Set>RspCod=EFE999</Set>
      <Set>RspMsg=数据库处理失败!</Set>
      <Return/>
     </If>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460202" desc="银电业务停工交易">
  <!--自动冲正
    <Attributes>
      <Attribute name="integrity" value="2" code="482107" interval="5" timeout="30" maxtimes="15"/>
    </Attributes>
  -->
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryCrpAgr">             <!--查询单位信息 -->
      <Sentence>
        SELECT TActNo, BBusTyp FROM savcrpagr WHERE CAgtNo='%s' AND SvrSts='1'
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UdpInfCtl">             <!--修改开工信息表 -->
      <Sentence>
       UPDATE efeinfctl Set Status='%s',DlTxt='%s' WHERE BrNo='%s'
      </Sentence>
      <Fields>Status|DlTxt|BrNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
      <If condition="$Status=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=银电系统已在停工状态</Set>
        <Return/>
      </If>

      <Exec func="PUB:GetCommInf" error="IGNORE">
        <Arg name="CndId"  value="STRCAT(efe_,$BrNo)"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行IP设置</Set>
        <Return/>
      </If>

      <Set>@MSG.OIP=$HstIp</Set>  <!--第三方IP-->
      <Set>@MSG.OPT=$HstPrt</Set> <!--第三方PORT-->
      <Set>WTC=301</Set>          <!--委托节点代码-->

       <!--发送第三方-->
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="460202"/>
        <Arg name="ObjSvr" value="STHDEFEA"/>
      </Exec>
      <If condition="$RspCod=000000">
        <Set>MsgTyp=N</Set>
      </If>
      <Else>
        <Set>MsgTyp=E</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TRspCd"/>
          <Arg name="DestNam" value="RspMsg"/>
          <Arg name="TblNam"  value="EFE_TRspCd2RspMsg"/>
        </Exec>
        <Return/>
     </Else>

     <!--修改为开工状态-->
     <Set>Status=0</Set>
     <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd"   value="UdpInfCtl"/>
     </Exec>
     <If condition="~RetCod=-1">
      <Exec func="PUB:RollbackWork" error="IGNORE" />
      <Set>MsgTyp=E</Set>
      <Set>RspCod=EFE999</Set>
      <Set>RspMsg=数据库处理失败!</Set>
      <Return/>
     </If>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460203" desc="银电代扣协议变更">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="QryCusCnt">             <!--查询协议存在 -->
      <Sentence>
        SELECT count(*) cnt1 from efecusagt WHERE JFH='%s' AND Status='0'
      </Sentence>
      <Fields>JFH|</Fields>
    </DynSentence>
    <DynSentence name="QryCusAgt">             <!--查询协议信息 -->
      <Sentence>
        SELECT * from efecusagt WHERE JFH='%s' AND Status='0'
      </Sentence>
      <Fields>JFH|</Fields>
    </DynSentence>
    <DynSentence name="InsCusAgt">             <!--新增签约记录 -->
      <Sentence>
        INSERT INTO efecusagt(BrNo,PAgtNo,CAgtNo,SBN,ECD,WDO,EDD,JFH,UsrNam,KKB,ActNo,
           KAT,ActNam,GPF,IdTyp,IdNo,ZPF,FPF,
           JLD,FPM,FPC,FPA,ZPM,ZPC,ZPA,YBZ,EML,MOB,TEL,TXT,Status)
        VALUES('%s','%s','%s','%s','%s','%s','%s',
               '%s','%s','%s','%s','%s','%s',
               '%s','%s','%s','%s','%s','%s',
               '%s','%s','%s','%s','%s','%s',
               '%s','%s','%s','%s','%s','%s')
      </Sentence>
      <Fields>
        BrNo|PAgtNo|CAgtNo|SBN|ECD|WDO|EDD|JFH|UsrNam|KKB|ActNo|KAT|ActNam|GPF|IdTyp|TIdNo|ZPF|FPF|JLD|FPM|FPC|FPA|ZPM|ZPC|ZPA|YBZ|EML|MOB|TEL|TXT|Status|
      </Fields>
    </DynSentence>
     <DynSentence name="UdpCusAgt">             <!--修改签约记录 -->
      <Sentence>
        UPDATE efecusagt set SBN='%s',ECD='%s',WDO  ='%s',EDD='%s',
           JFH='%s',UsrNam='%s',KKB='%s',ActNo='%s',KAT='%s',ActNam='%s',GPF='%s',IdTyp='%s',
           IdNo='%s',ZPF='%s',FPF='%s',JLD='%s',FPM='%s',FPC='%s',FPA='%s',ZPM='%s',
           ZPC='%s',ZPA='%s',YBZ='%s',EML='%s',MOB='%s',TEL='%s',TXT='%s',Status= '%s'
          WHERE BrNo='%s' and JFH='%s' and Status='0'
      </Sentence>
      <Fields>
        SBN|ECD|WDO|EDD|JFH|UsrNam|KKB|ActNo|KAT|ActNm|GPF|IdTyp|TIdNo|ZPF|FPF|JLD|FPM|FPC|FPA|ZPM|ZPC|ZPA|YBZ|EML|MOB|TEL|TXT|Status|BrNo|JFH|
      </Fields>
    </DynSentence>
    <DynSentence name="DelCusAgt">             <!--删除签约记录 -->
      <Sentence>
        DELETE FROM efecusagt where brno='%s' and JFH='%s'
      </Sentence>
      <Fields>BrNo|JFH|</Fields>
    </DynSentence>
    <DynSentence name="CclCusAgt">             <!--注销签约记录 -->
      <Sentence>
        UPDATE efecusagt SET Status='1' WHERE BrNo='%s' AND JFH='%s' and Status='0'
      </Sentence>
      <Fields>BrNo|JFH|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
      <If condition="$Status=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=银电系统已在停工状态</Set>
        <Return/>
      </If>

      <Exec func="PUB:GetCommInf" error="IGNORE">
        <Arg name="CndId"  value="STRCAT(efe_,$BrNo)"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行IP设置</Set>
        <Return/>
      </If>

      <Set>@MSG.OIP=$HstIp</Set>  <!--第三方IP-->
      <Set>@MSG.OPT=$HstPrt</Set> <!--第三方PORT-->
      <Set>SBN=301</Set>          <!--委托节点代码-->

      <Switch expression="$CHT">
        <!--新增-->
        <Case value="0">
          <!--根据缴费号检查是否签约-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryCusCnt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=缴费号查询失败</Set>
            <Return/>
          </If>
          <If condition="STRCMP($cnt1,1)=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=该缴费号已经签约</Set>
            <Return/>
          </If>
          <!--校验各分行账号-->
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
          <!--只有广州、珠海、佛山和中山有Acjud_行号函数，其他分行要加-->
          <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
          <Call function="$AcJudFunc">
            <Input name="ActNo|NewFlg|"/>
            <Output name="OActNo|ActCls|"/>
          </Call>
          <!--向主机查询账户信息-->
          <Switch expression="$ActCls">
            <Case value="2" /> <!-- 对私 -->
            <Case value="3" />
            <Case value="5" >
              <If condition="INTCMP($ActCls,3,3)">
                 <Set>ActFlg=4</Set>  <!--对私卡号-->
                 <Set>ActTyp=4</Set>
              </If>
              <Else>
                 <Set>ActFlg=2</Set>  <!--对私帐号-->
                 <Set>ActTyp=2</Set>
              </Else>
              <Set>CcyCod=CNY</Set>
              <!--上主机查询客户资料-->
              <Exec func="PUB:CallHostOther" error="IGNORE">
                <Arg name="HTxnCd" value="476520"/>
                <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>
              <If condition="$MsgTyp!=N">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户不存在</Set>
                <Return/>
              </If>
              <!--校验账户名称、开户证件类型和开户证件号码-->
              <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
              <Set>IDNo=DELBOTHSPACE($IDNo)</Set>
              <If condition="IS_NOEQUAL_STRING($ActNm,$ActNam)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=账户名称不符</Set>
                <Return/>
              </If>
              <If condition="IS_NOEQUAL_STRING($TIdNo,$IDNo)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=证件号码不符</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Case value="0" /> <!-- 对公 -->
            <Case value="4" >
              <Set>ActTyp=1</Set>
              <!--上主机查询客户资料-->
              <Exec func="PUB:CallHostOther" error="IGNORE">
                <Arg name="HTxnCd" value="109000"/>
                <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>
              <If condition="$MsgTyp!=N">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户不存在</Set>
                <Return/>
              </If>
              <!--校验账户名称、开户证件类型和开户证件号码-->
              <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
              <Set>ActQ04=DELBOTHSPACE($ActQ04)</Set>
              <If condition="IS_NOEQUAL_STRING($ActNm,$ActNam)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=账户名称不符</Set>
                <Return/>
              </If>
              <If condition="IS_NOEQUAL_STRING($TIdNo,$ActQ04)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=证件号码不符</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Default>
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户类型不存在</Set>
                <Return/>
            </Default>
          </Switch>
          <!--取单位协议编号-->
          <Set>CAgtNo= </Set>
          <!--取协议序列号-->
          <Set>SeqCnd=SUBSTR($BrNo,1,3)</Set><!--取个人协议编号-->
          <Exec func="PUB:GetPubSeqNo">
            <Arg name="SeqNam" value="efecusagt:PAgtNo"></Arg>   <!--业务码待定后再将其作为生成依据-->
            <Arg name="SeqCnd" value="$SeqCnd"></Arg>
            <Arg name="Len" value="10"></Arg>
          </Exec>
          <Set>PAgtNo=STRCAT($SeqCnd,$SelVal)</Set>

          <Set>WDO=$ActDat</Set>
          <Set>KAT=$Act</Set>
          <Set>Status=0</Set>
          <Set>oldJFH=$JFH</Set>
          <!--插入库表-->
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd"   value="InsCusAgt"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据库处理失败!</Set>
            <Return/>
          </If>
          <!--发送第三方签约-->
          <Exec func="PUB:CallThirdOther">
            <Arg name="HTxnCd" value="460203"/>
            <Arg name="ObjSvr" value="STHDEFEA"/>
          </Exec>
          <If condition="$RspCod=000000">
            <Set>MsgTyp=N</Set>
          </If>
          <Else>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Exec func="PUB:CodeSwitching">
              <Arg name="DatSrc"  value="OPFCSW"/>
              <Arg name="SourNam" value="TRspCd"/>
              <Arg name="DestNam" value="RspMsg"/>
              <Arg name="TblNam"  value="EFE_TRspCd2RspMsg"/>
            </Exec>
            <Set>JFH=$oldJFH</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Arg name="SqlCmd"   value="DelCusAgt"/>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE" />
              <Set>MsgTyp=E</Set>
              <Set>RspCod=EFE999</Set>
              <Set>RspMsg=数据库处理失败!</Set>
              <Return/>
            </If>
            <Return/>
          </Else>
          <Break/>
        </Case>
        <!--修改-->
        <Case value="3">
          <!--根据缴费号检查是否签约-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryCusCnt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=缴费号查询失败</Set>
            <Return/>
          </If>
          <If condition="STRCMP($cnt1,0)=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=该缴费号没签约</Set>
            <Return/>
          </If>
          <!--校验各分行账号-->
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
          <!--只有广州、珠海、佛山和中山有Acjud_行号函数，其他分行要加-->
          <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
          <Call function="$AcJudFunc">
            <Input name="ActNo|NewFlg|"/>
            <Output name="OActNo|ActCls|"/>
          </Call>
          <!--向主机查询账户信息-->
          <Switch expression="$ActCls">
            <Case value="2" /> <!-- 对私 -->
            <Case value="3" />
            <Case value="5" >
              <If condition="INTCMP($ActCls,3,3)">
                 <Set>ActFlg=4</Set>  <!--对私卡号-->
                 <Set>ActTyp=4</Set>
              </If>
              <Else>
                 <Set>ActFlg=2</Set>  <!--对私帐号-->
                 <Set>ActTyp=2</Set>
              </Else>
              <Set>CcyCod=CNY</Set>
              <!--上主机查询客户资料-->
              <Exec func="PUB:CallHostOther" error="IGNORE">
                <Arg name="HTxnCd" value="476520"/>
                <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>
              <If condition="$MsgTyp!=N">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户不存在</Set>
                <Return/>
              </If>
              <!--校验账户名称、开户证件类型和开户证件号码-->
              <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
              <Set>IDNo=DELBOTHSPACE($IDNo)</Set>
              <If condition="IS_NOEQUAL_STRING($ActNm,$ActNam)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=账户名称不符</Set>
                <Return/>
              </If>
              <If condition="IS_NOEQUAL_STRING($TIdNo,$IDNo)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=证件号码不符</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Case value="0" /> <!-- 对公 -->
            <Case value="4" >
              <Set>ActTyp=1</Set>
              <!--上主机查询客户资料-->
              <Exec func="PUB:CallHostOther" error="IGNORE">
                <Arg name="HTxnCd" value="109000"/>
                <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>
              <If condition="$MsgTyp!=N">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户不存在</Set>
                <Return/>
              </If>
              <!--校验账户名称、开户证件类型和开户证件号码-->
              <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
              <Set>ActQ04=DELBOTHSPACE($ActQ04)</Set>
              <If condition="IS_NOEQUAL_STRING($ActNm,$ActNam)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=账户名称不符</Set>
                <Return/>
              </If>
              <If condition="IS_NOEQUAL_STRING($TIdNo,$ActQ04)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=证件号码不符</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Default>
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户类型不存在</Set>
                <Return/>
            </Default>
          </Switch>  
          <Set>WDO=$ActDat</Set>
          <Set>KAT=$Act</Set>
          <Set>Status=0</Set>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd"   value="UdpCusAgt"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据库处理失败!</Set>
            <Return/>
          </If>
          <Exec func="PUB:CallThirdOther">
            <Arg name="HTxnCd" value="460203"/>
            <Arg name="ObjSvr" value="STHDEFEA"/>
          </Exec>
          <If condition="$RspCod=000000">
            <Set>MsgTyp=N</Set>
          </If>
          <Else>
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Exec func="PUB:CodeSwitching">
              <Arg name="DatSrc"  value="OPFCSW"/>
              <Arg name="SourNam" value="TRspCd"/>
              <Arg name="DestNam" value="RspMsg"/>
              <Arg name="TblNam"  value="EFE_TRspCd2RspMsg"/>
            </Exec>
            <Return/>
          </Else>
          <Break/>
        </Case>
        <!--查询-->
        <Case value="5">
          <!--根据缴费号检查是否签约-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryCusAgt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=缴费号查询失败</Set>
            <Return/>
          </If>
          <Set>CLM=$UsrNam</Set>
          <Set>ACN=$ActNo</Set>
          <Set>ActNm=$ActNam</Set>
          <Set>KKH=$KKB</Set>
          <Set>Act=$KAT</Set>
          <Set>TIdNo=$IdNo</Set>
          <Break/>
        </Case>
        <!--注销-->
        <Case value="9">
          <!--根据缴费号检查是否签约-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryCusCnt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=缴费号查询失败</Set>
            <Return/>
          </If>
          <If condition="STRCMP($cnt1,0)=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=该缴费号没签约</Set>
            <Return/>
          </If>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd"   value="CclCusAgt"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据库处理失败!</Set>
            <Return/>
          </If>
          <Exec func="PUB:CallThirdOther">
            <Arg name="HTxnCd" value="460203"/>
            <Arg name="ObjSvr" value="STHDEFEA"/>
          </Exec>
          <If condition="$RspCod=000000">
            <Set>MsgTyp=N</Set>
          </If>
          <Else>
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Exec func="PUB:CodeSwitching">
              <Arg name="DatSrc"  value="OPFCSW"/>
              <Arg name="SourNam" value="TRspCd"/>
              <Arg name="DestNam" value="RspMsg"/>
              <Arg name="TblNam"  value="EFE_TRspCd2RspMsg"/>
            </Exec>
            <Return/>
          </Else>
          <Break/>
        </Case>
        <Default>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=没该种选择</Set>
          <Return/>
        </Default>
      </Switch>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>
    </FlowCtrl>
  </Transaction>

  <Transaction code="460204" desc="银行柜台电费代收查询交易">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <FlowCtrl>



      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>

       <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
      <If condition="$Status=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=银电系统已在停工状态</Set>
        <Return/>
      </If>

      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <Exec func="PUB:GetCommInf" error="IGNORE">
        <Arg name="CndId"  value="STRCAT(efe_,$BrNo)"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行IP设置</Set>
        <Return/>
      </If>

      <Set>@MSG.OIP=$HstIp</Set>  <!--第三方IP-->
      <Set>@MSG.OPT=$HstPrt</Set> <!--第三方PORT-->
      <Set>WTC=301</Set>          <!--委托节点代码-->
      <Set>TMN= </Set>            <!--经办网点-->
      <Set>ECD= </Set>            <!--收付费企业代码  -->
      <Set>EDD= </Set>            <!--费项代码        -->
      <Set>OprCod=$TlrId </Set>   <!--操作员代码-->

      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="460204"/>
        <Arg name="ObjSvr" value="STHDEFEA"/>
      </Exec>
      <If condition="$RspCod=000000">
        <Set>MsgTyp=N</Set>
      </If>
      <Else>
        <Exec func="PUB:RollbackWork" error="IGNORE" />        
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TRspCd"/>
          <Arg name="DestNam" value="RspMsg"/>
          <Arg name="TblNam"  value="EFE_TRspCd2RspMsg"/>
        </Exec>
        <If condition="IS_EQUAL_STRING($TRspCd,06)">
        	<Set>RspCod=000000</Set>
        	<Set>MsgTyp=N</Set>
        </If>
        <Else>
          <Set>RspCod=EFE999</Set>
          <Set>MsgTyp=E</Set>
        </Else>
        <Return/>
      </Else>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460205" desc="银行柜台电费代收缴费交易">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryCrpAgr">             <!--查询单位信息 -->
      <Sentence>
        SELECT TActNo, BBusTyp FROM savcrpagr WHERE BrNo='%s' AND CAgtNo='%s' AND SvrSts='1'
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="Insefechkinf">          <!--银电对账信息表 -->
      <Sentence>
        INSERT INTO efechkinf(BrNo,CAgtNo,LogNo,ECD,WDO,EDD,JFH,KKB,ActNo,KAT,CUN,TxnAmt,KFG,ActNam,PCF,MNT,WYSB,SFF,TxnCod)
        VALUES('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')
      </Sentence>
      <Fields>
         BrNo|CAgtNo|LogNo|ECD|WDO|EDD|JFH|KKB|ActNo|KAT|CUN|TxnAmt|KFG|ActNam|PCF|MNT|WYSB|SFF|TxnCod|
      </Fields>
    </DynSentence>
    <DynSentence name="Insefechkdtl">             <!--银电对账明细表 -->
      <Sentence>
        INSERT INTO efechkdtl(BrNo,LogNo,JFXH,JFJE,MON,JLD,YSH,CPS,MNS,PCC)
        VALUES('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')
      </Sentence>
      <Fields>
         BrNo|LogNo|JFXH|JFJE|MON|JLD|YSH|CPS|MNS|PCC|
      </Fields>
    </DynSentence>
    <DynSentence name="UdpEfea_0"> <!--更新购彩流水辅表 -->
       <Sentence>
         update efechkinf set TLogNo='%s',TckNo='%s',Status='%s' where BrNo='%s' and WDO='%s' and ActNo='%s' and LogNo='%s'
       </Sentence>
       <Fields>TLogNo|TckNo|Status|BrNo|WDO|ActNo|LogNo|</Fields>
    </DynSentence>

    <DynSentence name="UdpEfeadtl"> <!--更新购彩流水辅表 -->
       <Sentence>
         update efechkdtl set TLogNo='%s' where BrNo='%s' and LogNo='%s'
       </Sentence>
       <Fields>TLogNo|BrNo|LogNo|</Fields>
    </DynSentence>


    <DynSentence name="UdpEfeaSts"> <!--更新电力电费流水辅表 -->
       <Sentence>
         update efechkinf set Status='%s' where BrNo='%s' and LogNo='%s'
       </Sentence>
       <Fields>Status|BrNo|LogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>

       <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
      <If condition="$Status=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=银电系统已在停工状态</Set>
        <Return/>
      </If>



      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <Exec func="PUB:GetCommInf" error="IGNORE">
        <Arg name="CndId"  value="STRCAT(efe_,$BrNo)"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行IP设置</Set>
        <Return/>
      </If>

      <!--读取协议数据-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryCrpAgr"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无该单位协议或数据库错</Set>
        <Return/>
      </If>

      <!--根据分行号取地区号-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="BrNo"/>
        <Arg name="DestNam" value="DstCod"/>
        <Arg name="TblNam"  value="DL_BrNo2DstCod"/>
      </Exec>
      <!--设置唯一识别码-->
      <Exec func="PUB:GetPubSeqNoCircle">
        <Arg name="SeqNam" value="EFE:WYSB"/>
        <Arg name="Len"    value="10"/>
      </Exec>
      <Set>WYSB=STRCAT(301,$DstCod,$ActDat,$SelVal)</Set>

      <Set>@MSG.OIP=$HstIp</Set>  <!--第三方IP-->
      <Set>@MSG.OPT=$HstPrt</Set> <!--第三方PORT-->
      <Set>TMN= </Set>            <!--经办网点-->
      <Set>OprCod=$TlrId</Set>    <!--操作员代码-->

     <Switch expression="$VchTyp">
      <Case value="000"><!--现金缴费-->
        <Set>ActFlg=0</Set>  <!--现金-->
        <Set>ActTyp=0</Set>
        <Set>PayMod=0</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>KAT=1</Set>
        <Set>SFF=01</Set>
        <Set>PayTyp=10</Set><!--收费类型:10现金;11支票预交;12支票实交-->
        <Break/>
      </Case>
      <Case value="007"><!--银行卡-->
        <Set>ActFlg=4</Set>  <!--对私卡号-->
        <Set>ActTyp=4</Set>
        <Set>PayMod=1</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>KAT=3</Set>
        <Set>SFF=01</Set>
        <Break/>
      </Case>
      <Case value="601"><!--活期存折-->
        <Set>ActFlg=2</Set>  <!--对私帐号-->
        <Set>ActTyp=2</Set>
        <Set>PayMod=1</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>KAT=1</Set>
        <Set>SFF=01</Set>
        <Break/>
      </Case>
      <Case value="603"><!--本外活本-->
        <Set>ActFlg=1</Set>  <!--一本通-->
        <Set>ActTyp=1</Set>
        <Set>PayMod=1</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>KAT=1</Set>
        <Set>SFF=01</Set>
        <Break/>
      </Case>
      <Case value="021"><!--个人支票-->
        <Set>ActFlg=5</Set>  <!--支票-->
        <Set>ActTyp=5</Set>
        <Set>PayMod=0</Set><!--支取方式 1 凭密支取 0 不验密-->
        <Set>KAT=1</Set>
        <Set>SFF=06</Set>
        <Break/>
      </Case>
      <Case value="117"><!--本票-->
        <Set>KAT=0</Set>
        <Set>SFF=01</Set>
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="127"><!--银承汇票-->
        <Set>KAT=0</Set>
        <Set>SFF=07</Set>
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="129"><!--商承汇票-->
        <Set>KAT=0</Set>
        <Set>SFF=07</Set>
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="105"><!--现金支票-->
        <Set>KAT=0</Set>
        <Set>SFF=06</Set>
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="113"><!--转账支票-->
        <Set>KAT=0</Set>
        <Set>SFF=06</Set>
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
      <Case value="115"><!--划线支票-->
        <Set>KAT=0</Set>
        <Set>SFF=06</Set>
        <Set>VckFlg=1</Set><!--凭证检查标志 选项：0－不检查；1－检查。-->
        <Break/>
      </Case>
     </Switch>

     <If condition="OR(INTCMP($VchTyp,3,000),INTCMP($VchTyp,3,007),INTCMP($VchTyp,3,601),INTCMP($VchTyp,3,603),INTCMP($VchTyp,3,021))"><!--对私-->
        <Set>HTxnCd=471140</Set>
        <Set>VchChk=0</Set>
        <!--在前边对私凭证内添加<Set>PayMod=0</Set>支取方式 1 凭密支取 0 不验密-->
        <Set>ActFlg=$ActTyp</Set>
        <Set>VchCod=00000000</Set>
        <Set>VchChk=1</Set><!--监督标志由业务上确定-->
        <!--
        <Set>BusTyp=EFEA1</Set>
        -->
     </If>
     <ElseIf condition="OR(INTCMP($VchTyp,3,117),INTCMP($VchTyp,3,127),INTCMP($VchTyp,3,129),INTCMP($VchTyp,3,105),INTCMP($VchTyp,3,113),INTCMP($VchTyp,3,115))"><!--对公-->
        <Set>HTxnCd=451240</Set>
        <Set>ActNod=SUBSTR($TActNo,1,6)</Set>
        <Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
        <Delete>TActNo</Delete>
        <Set>BusTyp=CRP51</Set>
        <Set>BusSub=01</Set>                   <!--应用子码，对应业务类型CRP51-->
     </ElseIf>
     <Else>
        <Return/>
     </Else>

      <Set>FTxnTm=GETDATETIME()</Set>
      <Quote name="Chk_TxnSrc"/>
      <Quote name="TxnSrc_TxnCnl"/>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GD_DLDF"/>
        <Arg name="Transaction" value="460205"/>   <!--CFG_EFE_441999.XML -->
      </Exec>

      <Set>WTC=301</Set>
      <Set>WDO=$ActDat</Set>
      <Set>KKB=301</Set>
      <Set>CUN=RMB</Set>
      <Set>JYF=0</Set>
      <Set>MNT=01</Set>
      <Set>KFG=0</Set>
      <Set>ActNam=$ActNm</Set>
      <Set>TCusNm=$ActNm</Set>

      <!--插入银电对账信息表-->
      <Exec func="PUB:ExecSql" error="IGNORE">
         <Arg name="SqlCmd"   value="Insefechkinf"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=数据库处理失败!</Set>
        <Return/>
      </If>
      
      <!--插入银电对账明细表-->
      <Set>Cnt=1</Set>
      <While condition="INTCMP($Cnt,2,$JFNUM)">
      	<Delete>ROOT.JFXH</Delete>
      	<Delete>ROOT.JFJE</Delete>
      	<Delete>ROOT.MON</Delete>
      	<Delete>ROOT.JLD</Delete>
      	<Delete>ROOT.YSH</Delete>
      	<Delete>ROOT.CPS</Delete>
      	<Delete>ROOT.MNS</Delete>
      	<Delete>ROOT.PCC</Delete>
      	<Set>JFXH_Nam=STRCAT(ROOT.Rec_,$Cnt,.JFXH)</Set>
      	<Set>JFJE_Nam=STRCAT(ROOT.Rec_,$Cnt,.JFJE)</Set>
      	<Set>MON_Nam=STRCAT(ROOT.Rec_,$Cnt,.MON)</Set>
      	<Set>JLD_Nam=STRCAT(ROOT.Rec_,$Cnt,.JLD)</Set>
      	<Set>YSH_Nam=STRCAT(ROOT.Rec_,$Cnt,.YSH)</Set>
      	<Set>CPS_Nam=STRCAT(ROOT.Rec_,$Cnt,.CPS)</Set>
      	<Set>MNS_Nam=STRCAT(ROOT.Rec_,$Cnt,.MNS)</Set>
      	<Set>PCC_Nam=STRCAT(ROOT.Rec_,$Cnt,.PCC)</Set>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JFXH_Nam"/>
          <Arg name="DestName" value="ROOT.JFXH"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JFJE_Nam"/>
          <Arg name="DestName" value="ROOT.JFJE"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$MON_Nam"/>
          <Arg name="DestName" value="ROOT.MON"/>
        </Exec>
         <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JLD_Nam"/>
          <Arg name="DestName" value="ROOT.JLD"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$YSH_Nam"/>
          <Arg name="DestName" value="ROOT.YSH"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$CPS_Nam"/>
          <Arg name="DestName" value="ROOT.CPS"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$JFXH_Nam"/>
          <Arg name="DestName" value="ROOT.JFXH"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$MNS_Nam"/>
          <Arg name="DestName" value="ROOT.MNS"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName" value="$PCC_Nam"/>
          <Arg name="DestName" value="ROOT.PCC"/>
        </Exec>              	
        <Exec func="PUB:ExecSql" error="IGNORE">
           <Arg name="SqlCmd"   value="Insefechkdtl"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE" />
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=数据库处理失败!</Set>
          <Return/>
        </If>
        <Set>Cnt=ADD($Cnt,1)</Set>
      </While>
      
      <!--发送主机记账和第三方-->
      <Call package="AFE" function="AFE_SglBkPay"/>
      <If condition="$RspCod=000000">
        <Set>MsgTyp=N</Set>
        <Set>Status=S</Set>
        <!--更新购彩流水副表为交易成功-->
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UdpEfea_0"/>
        </Exec>
        <If condition="~RetCod=-1">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=EFE999</Set>
           <Set>RspMsg=数据库处理失败!</Set>
        </If>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UdpEfeadtl"/>
        </Exec>
        <If condition="~RetCod=-1">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=EFE999</Set>
           <Set>RspMsg=数据库处理失败!</Set>
        </If>
        <Return/>
      </If>
      <!--主机记账错误-->
      <ElseIf condition="AND(IS_EQUAL_STRING($HTxnSt,X),IS_EQUAL_STRING($TxnSts,X))">
        <Set>MsgTyp=E</Set>
        <Set>Status=F</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UdpEfeaSts"/>
        </Exec>
        <If condition="~RetCod=-1">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=EFE999</Set>
           <Set>RspMsg=数据库处理失败!</Set>
        </If>
        <Return/>
      </ElseIf>
      <!--主机记账超时-->
      <ElseIf condition="IS_EQUAL_STRING($HTxnSt,T)">
        <Set>MsgTyp=E</Set>
        <Set>Status=F</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UdpEfeaSts"/>
        </Exec>
        <If condition="~RetCod=-1">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=EFE999</Set>
           <Set>RspMsg=数据库处理失败!</Set>
        </If>
        <Set>RspCod=EFE999</Set>
        <Exec func="PUB:PutResponse"/><!--返回查询结果信息-->
        <Goto>CRCHOST</Goto>
        <Return/>
      </ElseIf>
      <!--主机记账失败-->
      <ElseIf condition="AND(IS_EQUAL_STRING($HTxnSt,F),IS_EQUAL_STRING($TxnSts,F))">
        <Set>MsgTyp=E</Set>
        <Set>Status=F</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UdpEfeaSts"/>
        </Exec>
        <If condition="~RetCod=-1">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=EFE999</Set>
           <Set>RspMsg=数据库处理失败!</Set>
        </If>
        <Return/>
      </ElseIf>
      <!--第三方发送错误-->
      <ElseIf condition="AND(IS_EQUAL_STRING($TTxnSt,X),IS_EQUAL_STRING($TxnSts,X))">
        <Set>MsgTyp=E</Set>
        <Set>Status=T</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UdpEfeaSts"/>
        </Exec>
        <If condition="~RetCod=-1">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=EFE999</Set>
           <Set>RspMsg=数据库处理失败!</Set>
        </If>
        <Return/>
      </ElseIf>
      <!--第三方发送或返回超时-->
      <ElseIf condition="IS_EQUAL_STRING($TTxnSt,T)">
        <Set>MsgTyp=E</Set>
        <Set>Status=T</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UdpEfeaSts"/>
        </Exec>
        <If condition="~RetCod=-1">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=EFE999</Set>
           <Set>RspMsg=数据库处理失败!</Set>
        </If>
        <Return/>
      </ElseIf>
      <!--第三方返回失败-->
      <Else condition="AND(IS_EQUAL_STRING($TTxnSt,F),IS_EQUAL_STRING($TxnSts,F))">
        <Set>MsgTyp=E</Set>
        <Set>Status=F</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UdpEfeaSts"/>
        </Exec>
        <If condition="~RetCod=-1">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=EFE999</Set>
           <Set>RspMsg=数据库处理失败!</Set>
        </If>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TRspCd"/>
          <Arg name="DestNam" value="RspMsg"/>
          <Arg name="TblNam"  value="EFE_TRspCd2RspMsg"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Exec func="PUB:PutResponse"/><!--返回查询结果信息-->
        <Goto>CRCHOST</Goto>
        <Return/>
      </Else>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>
      <Return/>

      <Label>CRCHOST</Label> <!--只上主机冲正-->
         <Set>OLogNo=$LogNo</Set>
         <If condition="OR(INTCMP($VchTyp,3,000),INTCMP($VchTyp,3,007),INTCMP($VchTyp,3,601),INTCMP($VchTyp,3,603),INTCMP($VchTyp,3,021))"><!--对私-->
           <Set>HTxnCd=471149</Set>
         </If>
         <ElseIf condition="OR(INTCMP($VchTyp,3,117),INTCMP($VchTyp,3,127),INTCMP($VchTyp,3,129),INTCMP($VchTyp,3,105),INTCMP($VchTyp,3,113),INTCMP($VchTyp,3,115))"> <!--对公-->
           <!--
           <Set>HTxnCd=451619</Set>
           -->
           <Set>HTxnCd=451249</Set>
         </ElseIf>
         <Else>                                   <!--第三方-->
           <Return/>
         </Else>


         <Set>OHLogNo=$HLogNo</Set>
         <Set>OTckNo=$TckNo</Set>
         <Set>OTTxnCd=460205</Set>
         
         <Set>TTxnCd=$TxnCod</Set>
         <Set>OTxnSts=$TxnSts</Set>
         <Set>OHTxnSt=$HTxnSt</Set>
         <Set>HLogNo= </Set>
         <Set>HLogNo=DELSPACE($HLogNo,all)</Set>
      
         <Set>TIATyp=C</Set>
         <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
         <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
           <Arg name="HTxnCd" value="959999"/>
           <Arg name="ObjSvr" value="SHSTPUB1"/>
         </Exec>

        <If condition="IS_EQUAL_STRING(~RetCod,0)">    <!--上主机冲正成功-->
          <Set>HTxnSt=C</Set>
          <Set>TxnSts=C</Set>
          <Exec func="PUB:UpdateJournal">
          </Exec>
          <Set>Status=C</Set>
          <!--更新银电对账信息表-->
          <Exec func="PUB:ExecSql" error="IGNORE">
             <Arg name="SqlCmd"   value="UdpEfeaSts"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据库处理失败!</Set>
            <Return/>
          </If>
          <Return/>
        </If>
        <Else>    <!--不成功登记自动冲正-->
          <Exec func="PUB:DefaultErrorProc"/>
        </Else>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460206" desc="银行柜台当日代收冲销交易">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="QryChkInf">             <!--查询银电对账信息表 -->
      <Sentence>
        SELECT LogNo OLogNo,ECD,WDO,EDD,JFH,KKB,ActNo,KAT,CUN,TxnAmt,KFG,ActNam,PCF,MNT,WYSB,SFF,Status FROM efechkinf
            WHERE BrNo='%s' AND WDO='%s' AND TckNo='%s'
      </Sentence>
      <Fields>BrNo|ActDat|TckNo</Fields>
    </DynSentence>
    <DynSentence name="Chk_TLogNo"><!--检查凭单号是否重复 -->
      <Sentence>
        select HTxnSt,TlrId, HLogNo OHLogNo, TckNo OTckNo,TXNAMT TTXNAMT
        from afetxnjnl
        where BrNo='%s' and LogNo='%s' AND HTxnSt IN ('T','S','U','C')
        order by LogNo desc
      </Sentence>
      <Fields>BrNo|OLogNo|</Fields>
    </DynSentence>
    <DynSentence name="UdpEfeaSts"> <!--更新购彩流水辅表 -->
       <Sentence>
         update efechkinf set Status='%s' where BrNo='%s' and LogNo='%s'
       </Sentence>
       <Fields>Status|BrNo|OLogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
       <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
      <If condition="$Status=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=银电系统已在停工状态</Set>
        <Return/>
      </If>

      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>


      <Exec func="PUB:GetCommInf" error="IGNORE">
        <Arg name="CndId"  value="STRCAT(efe_,$BrNo)"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行IP设置</Set>
        <Return/>
      </If>


      <Set>@MSG.OIP=$HstIp</Set>  <!--第三方IP-->
      <Set>@MSG.OPT=$HstPrt</Set> <!--第三方PORT-->
      <Set>WTC=301</Set>          <!--委托节点代码-->
      <Set>TMN= </Set>            <!--经办网点-->
      <Set>OprCod=$TlrId </Set>    <!--操作员代码-->

      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryChkInf"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无该笔缴费业务</Set>
        <Return/>
      </If>
      <If condition="STRCMP($Status,T)=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=该笔缴费不能进行冲销</Set>
        <Return/>
      </If>
      
      <Set>OJN=301</Set>        <!--原缴费业务委托节点代码 -->
      <Set>OJD=$ActDat</Set>    <!--原缴费业务委托日期     -->
      <Set>OLZ=$OLogNo</Set>    <!--原业务流水             -->
      <Set>OWK=$ActDat</Set>    <!--原业务工作日期         -->
      <Set>OED=301</Set>        <!--原费项代码             -->
      <Set>OJF=$JFH</Set>       <!--原业务缴费号           -->
      <Set>OJB=301</Set>        <!--原缴费业务扣款行行号   -->
      <Set>OJC=$ActNo</Set>     <!--原缴费业务扣款账号/卡号-->
      <Set>OCU=RMB</Set>        <!--原业务货币符号         -->
      <Set>OJA=$TxnAmt</Set>    <!--原缴费业务缴纳金额     -->
      <Set>CXA=$TxnAmt</Set>    <!--冲销金额               -->
      <Set>OCN=$ECD</Set>       <!--供电公司编号           -->
      <Set>AUN= </Set>          <!--帐号名称               -->


      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="460206"/>
        <Arg name="ObjSvr" value="STHDEFEA"/>
      </Exec>

      <If condition="$RspCod=000000">
        <Set>MsgTyp=N</Set>
      </If>
      <Else>
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TRspCd"/>
          <Arg name="DestNam" value="RspMsg"/>
          <Arg name="TblNam"  value="EFE_TRspCd2RspMsg"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Return/>
      </Else>

      <If condition="OR(INTCMP($KAT,3,1),INTCMP($KAT,3,3))"><!--对私-->
        <Set>HTxnCd=471149</Set>
      </If>
      <ElseIf condition="INTCMP($KAT,3,0)"> <!--对公-->
        <!--
        <Set>HTxnCd=451619</Set>
        -->
        <Set>HTxnCd=451249</Set>
      </ElseIf>
      <Else>                                   <!--第三方-->
        <Return/>
      </Else>

      <Exec func="PUB:ReadRecord">  <!--检查凭单号是否记帐-->
        <Arg name="SqlCmd" value="Chk_TLogNo"/>
      </Exec>

      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无冲正记录</Set>
        <Return/>
      </If>

      <If condition="$HTxnSt=C">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=已冲正</Set>
        <Return/>
      </If>

      <Set>LogNo=$OLogNo</Set>
      <Set>OTTxnCd=460205</Set>
      <Set>TTxnCd=$TxnCod</Set>
      <Set>HLogNo= </Set>
      <Set>HLogNo=DELSPACE($HLogNo,all)</Set>

      <Set>TIATyp=C</Set>
      <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
      <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
        <Arg name="HTxnCd" value="959999"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>

      <If condition="IS_EQUAL_STRING(~RetCod,0)">    <!--上主机冲正成功-->
        <Set>HTxnSt=C</Set>
        <Set>TxnSts=C</Set>
        <Exec func="PUB:UpdateJournal">
        </Exec>
        <Set>Status=X</Set>
        <!--更新银电对账信息表-->
        <Exec func="PUB:ExecSql" error="IGNORE">
           <Arg name="SqlCmd"   value="UdpEfeaSts"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=数据库处理失败!</Set>
          <Return/>
        </If>
			  <Set>MsgTyp=N</Set>
			  <Set>RspCod=000000</Set>
			  <Set>RspMsg=交易成功!</Set>
      </If>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460220" desc="单笔代扣业务">


    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>

    <DynSentence name="QryCrpAgr">    <!--检查单位协议 -->
      <Sentence>
         select BBusTyp,TActNo  from savcrpagr where BrNo='%s' and CAgtNo='%s' and SvrSts='1'
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInfCtl">             <!--查询对应分行号-->
      <Sentence>
        SELECT BrNo FROM efeinfctl WHERE DLIP='%s'
      </Sentence>
      <Fields>DLIP|</Fields>
    </DynSentence>
    <DynSentence name="Insefechkinf">          <!--银电对账信息表 -->
      <Sentence>
        INSERT INTO efechkinf(BrNo,CAgtNo,LogNo,TLogNo,TckNo,ECD,WDO,EDD,JFH,KKB,ActNo,KAT,CUN,TxnAmt,KFG,ActNam,PCF,MNT,JBR,GDO,WYSB,SFF,TxnCod,Status)
        VALUES('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')
      </Sentence>
      <Fields>
         BrNo|CAgtNo|LogNo|TLogNo|TckNo|ECD|WDO|EDD|JFH|KKB|ActNo|KAT|CUN|TxnAmt|KFG|ActNam|PCF|MNT|JBR|GDO|WYSB|SFF|TxnCod|Status|
      </Fields>
    </DynSentence>
    <DynSentence name="Insefechkdtl">             <!--银电对账明细表 -->
      <Sentence>
        INSERT INTO efechkdtl(BrNo,LogNo,TLogNo,JFXH,JFJE,MON,JLD,YSH,CPS,MNS,PCC)
        VALUES('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')
      </Sentence>
      <Fields>
         BrNo|LogNo|TLogNo|JFXH|JFJE|MON|JLD|YSH|CPS|MNS|PCC|
      </Fields>
    </DynSentence>

    <FlowCtrl>

      <Set>DLIP=@MSG.SIP</Set>
      <Exec func="PUB:ReadRecord">    <!--查询对应分行号 -->
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行号</Set>
        <Return/>
      </If>

      <Exec func="PUB:InitTransaction"/>    <!--交易初始化,预留-->

      <Exec func="PUB:GetAppInfo"/>


      <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
        <Arg name="SqlCmd" value="QryCrpAgr"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=单位协议不存在</Set>
        <Return/>
      </If>

      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>

      
      <Set>TTxnCd=460220</Set>
      <Set>MsgTyp_tmp=$MsgTyp</Set>
      <Set>HRspCd_tmp=$HRspCd</Set>

      <!--校验各分行账号-->
      <!--441999广东省分行-->
      <!--444999珠海分行-->
      <!--446999佛山分行-->
      <!--445999汕头分行-->
      <!--483999东莞分行-->
      <!--484999中山分行-->
      <!--485999揭阳支行-->
      <!--491999惠州分行-->
      <!--761999江门分行-->
      <!--只有广州、珠海、佛山和中山有Acjud_行号函数，其他分行要加-->
      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>
      <If condition="$MsgTyp=E">
         <Set>TTxnCd=$TTxnCd_tmp</Set>
         <Set>RspCod=$HRspCd</Set>
         <Set>RspMsg=账号查询错误</Set>
         <Return/>
       </If>

      <Switch expression="$ActCls">
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
         <If condition="INTCMP($ActCls,3,3)">
             <Set>ActFlg=4</Set>  <!--对私卡号-->
             <Set>ActTyp=4</Set>
          </If>
          <Else>
             <Set>ActFlg=2</Set>  <!--对私帐号-->
             <Set>ActTyp=2</Set>
          </Else>
          <Break/>
        </Case>
        <Case value="0" /> <!-- 对公 -->
        <Case value="4" >
          <Set>ActTyp=1</Set>
          <Break/>
        </Case>
        <Default>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=帐户类型不存在</Set>
            <Return/>
        </Default>
      </Switch>



      <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
        <Set>HTxnCd=471140</Set>
        <Set>PayMod=1</Set>
        <Set>ActFlg=$ActTyp</Set>
        <Set>VchChk=1</Set><!--监督标志由业务上确定-->
        <!--
        <Set>BusTyp=EFEA1</Set>
        -->
      </If>
      <ElseIf condition="INTCMP($ActTyp,3,1)"><!--对公-->
        <Set>HTxnCd=451610</Set>
        <Set>ActNod=SUBSTR($TActNo,1,6)</Set>
        <Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
        <Delete>TActNo</Delete>
        <Set>BusTyp=CRP51</Set>
        <Set>BusSub=01</Set>   <!--应用子码，对应业务类型CRP51-->
        <Set>ActFlg=2</Set>
      </ElseIf>
      <Else>    <!--第三方-->
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=账号类型输入有误</Set>
        <Return/>
      </Else>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GD_DLDF"/><!--可以使用单位编号-->
        <Arg name="Transaction" value="$TxnCod"/><!--可以用交易码或者模块名-->
      </Exec>

      <Set>TCusNm=$ActNam</Set>

      <Set>PayMod=0</Set>
      <Set>CnlTyp=L</Set><!--交易渠道类型：L第三方系统-->
      <Set>VchChk=1</Set><!--监督标志由业务上确定-->
      <Set>VchCod=00000000</Set>
      <Set>AplCls=202</Set>
      <Set>MstChk=1</Set>  <!--20100511-->
      <Set>FRspCd= </Set>  <!--20100511-->
      <Set>ItgTyp=0</Set>  <!--20100511-->
      <Set>TXNTYP=N</Set>  <!--20100511-->

      <Call package="AFE" function="AFE_SglThdPay"/>
      <If condition="$RspCod=000000">
        <Set>SFF=04</Set> <!--收费方式:04实时代扣-->
        <!--设置唯一识别码-->
        <Exec func="PUB:GetPubSeqNoCircle">
          <Arg name="SeqNam" value="EFE:WYSB"/>
          <Arg name="Len"    value="10"/>
        </Exec>
        <Set>WYSB=STRCAT(301,$DstCod,$ActDat,$SelVal)</Set>

        <Set>MNT=01</Set> <!--资金种别,默认现金01-->
        <Set>SFF=04</Set> <!--收费方式实时代扣,04-->
        <Set>Status=S</Set>
        <Set>TTxnCd=$TTxnCd_tmp</Set>

        <!--记录交易的请求报文里详细信息，用于对帐时返回这些信息-->
        <!--插入银电对账信息表-->
        <Exec func="PUB:ExecSql" error="IGNORE">
           <Arg name="SqlCmd"   value="Insefechkinf"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE" />
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=数据库处理失败!</Set>
          <Return/>
        </If>

        <Set>JFXH=01</Set>      <!--缴费项序号-->
        <Set>JFJE=$TxnAmt</Set> <!--缴费项金额-->
        <!--插入银电对账明细表-->
        <Exec func="PUB:ExecSql" error="IGNORE">
           <Arg name="SqlCmd"   value="Insefechkdtl"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE" />
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=数据库处理失败!</Set>
          <Return/>
        </If>
      </If>

      

    </FlowCtrl>

  </Transaction>


  <Transaction code="460221" desc="单笔代扣业务冲正">
    <DynSentence name="QryInfCtl">             <!--查询对应分行号-->
      <Sentence>
        SELECT BrNo FROM efeinfctl WHERE DLIP='%s'
      </Sentence>
      <Fields>DLIP|</Fields>
    </DynSentence>
    <DynSentence name="Chk_TLogNo"><!--检查凭单号是否重复 -->
      <Sentence>
        select HTxnSt,LogNo,TlrId, HLogNo OHLogNo, TckNo OTckNo,TXNAMT TTXNAMT
        from afetxnjnl
        where CAgtNo='%s' and LogNo='%s' AND HTxnSt IN ('T','S','U','C')
        order by LogNo desc
      </Sentence>
      <Fields>CAgtNo|LogNo|</Fields>
    </DynSentence>
    <DynSentence name="UdpEfeaSts"> <!--更新购彩流水辅表 -->
       <Sentence>
         update efechkinf set Status='%s' where BrNo='%s' and LogNo='%s'
       </Sentence>
       <Fields>Status|BrNo|LogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>DLIP=@MSG.SIP</Set>
      <!--查询对应分行号 -->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行号</Set>
        <Return/>
      </If>
      
      <Exec func="PUB:InitTransaction"/>
      <Exec func="PUB:ReadRecord">  <!--检查凭单号是否记帐-->
        <Arg name="SqlCmd" value="Chk_TLogNo"/>
      </Exec>

      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无冲正记录</Set>
        <Return/>
      </If>

      <If condition="$HTxnSt=C">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=已冲正</Set>
        <Return/>
      </If>

      <Set>RspMsg=$TTxnAmt</Set>
      <Set>RspMsg=$TxnAmt</Set>
      <If condition="IS_EQUAL_INT($TTxnAmt,$TxnAmt)">
      </If>
      <Else>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=金额不符</Set>
        <Return/>
      </Else>

      <Set>Rsfld1=$AAC</Set>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GD_DLDF"/>
        <Arg name="Transaction" value="460221"/>
      </Exec>

      <Set>ActNo=$KAC</Set>

      <!--校验各分行账号-->
      <!--441999广东省分行-->
      <!--444999珠海分行-->
      <!--446999佛山分行-->
      <!--445999汕头分行-->
      <!--483999东莞分行-->
      <!--484999中山分行-->
      <!--485999揭阳支行-->
      <!--491999惠州分行-->
      <!--761999江门分行-->
      <!--只有广州、珠海、佛山和中山有Acjud_行号函数，其他分行要加-->
      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>
      <If condition="$MsgTyp=E">
         <Set>TTxnCd=$TTxnCd_tmp</Set>
         <Set>RspCod=$HRspCd</Set>
         <Set>RspMsg=账号查询错误</Set>
         <Return/>
       </If>

      <Switch expression="$ActCls">
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
         <If condition="INTCMP($ActCls,3,3)">
             <Set>ActFlg=4</Set>  <!--对私卡号-->
             <Set>ActTyp=4</Set>
          </If>
          <Else>
             <Set>ActFlg=2</Set>  <!--对私帐号-->
             <Set>ActTyp=2</Set>
          </Else>
          <Break/>
        </Case>
        <Case value="0" /> <!-- 对公 -->
        <Case value="4" >
          <Set>ActTyp=1</Set>
          <Break/>
        </Case>
        <Default>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=帐户类型不存在</Set>
            <Return/>
        </Default>
      </Switch>

     
      <Set>OLogNo=$LogNo</Set>
      <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
        <Set>HTxnCd=471149</Set>
      </If>
      <ElseIf condition="INTCMP($ActTyp,3,1)"> <!--对公-->
        <Set>HTxnCd=451619</Set>
      </ElseIf>
      <Else>                                   <!--第三方-->
        <Return/>
      </Else>
      <Set>OTTxnCd=460220</Set>
      <Set>TTxnCd=$TxnCod</Set>

      <Set>TIATyp=C</Set>
      <Exec func="PUB:BeginWork"/>    <!--启动完整性控制-->
      <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
        <Arg name="HTxnCd" value="959999"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>

      <If condition="IS_EQUAL_STRING(~RetCod,0)">    <!--上主机冲正成功-->
        <Set>HTxnSt=C</Set>
        <Set>TxnSts=C</Set>
        <Exec func="PUB:UpdateJournal">
        </Exec>
        <Set>Status=X</Set>
        <!--更新银电对账信息表-->
        <Exec func="PUB:ExecSql" error="IGNORE">
           <Arg name="SqlCmd"   value="UdpEfeaSts"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=数据库处理失败!</Set>
          <Return/>
        </If>
      </If>    	
      <Else>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=$HRspCd</Set>
        <Set>RspMsg=冲正不成功</Set>      	
      </Else>

    </FlowCtrl>
  </Transaction>



  <Transaction code="460222" desc="供电发起批量代扣交易">

    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>

    <DynSentence name="QryInfCtl">             <!--查询对应分行号-->
      <Sentence>
        SELECT BrNo FROM efeinfctl WHERE DLIP='%s'
      </Sentence>
      <Fields>DLIP|</Fields>
    </DynSentence>
    <!--
     <DynSentence name="QueDskNam">
      <Sentence>
        SELECT DskNo
        FROM efebfilctl444
        WHERE ActDat='%s' AND DskNam='%s' AND DskSts!='2'
      </Sentence>
      <Fields>ActDat|DskNam|</Fields>
    </DynSentence>
    -->
    <DynSentence name="QueDskNam">
      <Sentence>
        SELECT DskNo FROM pubbatinf WHERE BrNo='%s' AND ActDat='%s' AND DskNam='%s' AND Status='P'
      </Sentence>
      <Fields>BrNo|ActDat|DskNam|</Fields>
    </DynSentence>
    <DynSentence name="GetCAgtNo">
      <Sentence>
        SELECT DISTINCT CAgtNo FROM efebatinf  WHERE BrNo='%s' AND DskNo='%s'
      </Sentence>
      <Fields>BrNo|DskNo|</Fields>
    </DynSentence>
    <DynSentence name="GetCrpInf">
      <Sentence>
        SELECT b.CrpNam
        FROM savcrpagr a,savcrpinf b
        WHERE a.Brno='%s' AND a.CAgtNo='%s' AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Chk_CrpAgr"><!--检查单位协议 -->
      <Sentence>
        select a.BrNo,a.BBusTyp,a.TActNo,a.CrpCod,a.TxnDir,b.StlAct
        from savcrpagr a, savcrpinf b
        where a.BrNo='%s' and a.CAgtNo='%s' and SvrSts='1' and b.CrpCod=a.CrpCod and a.brno=b.brno
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Chk_CrpSignIn"><!--检查单位签到状态 -->
      <Sentence>
        SELECT 'Y' YN
        from table(values(1)) as anony
        where Exists(select * from savthdinf where BrNo='%s' and CAgtNo='%s' and status='1')
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryBatRec"><!--检查批次明细信息 -->
      <Sentence>
        select DskNo,SeqNo,OldAct from afebatrec where DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdBatRec1"><!--非一本通 -->
      <Sentence>
        UPDATE afebatrec Set ActNo='%s',ActNam='%s',ActTyp='%s' where DskNo='%s' AND SeqNo='%s'
      </Sentence>
      <Fields>ActNo|ActNam|ActTyp|DskNo|SeqNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdBatRec2"><!--一本通 -->
      <Sentence>
        UPDATE afebatrec Set ActNo='%s',ActNam='%s',ActTyp='%s',ActSqn='%s' where DskNo='%s' AND SeqNo='%s'
      </Sentence>
      <Fields>ActNo|ActNam|ActTyp|ActSqn|DskNo|SeqNo|</Fields>
    </DynSentence>
    <DynSentence name="DeleteInf444">
      <Sentence>
        Delete from fbpbatinf444 where DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="DeleteInf">
      <Sentence>
        Delete from pubbatinf where BrNo='%s' AND DskNo='%s'
      </Sentence>
      <Fields>BrNo|DskNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdCtlSuc1"> <!--更新控制表,0解析批扣文件成功，1正在处理，2处理失败，3批扣和上传ftp完成-->
       <Sentence>
        UPDATE efebfilctl444 a
        SET DskSts='0',DskNo='%s'
        WHERE DskNam='%s' and ActDAT='%s'
       </Sentence>
       <Fields>DskNo|DskNam|ActDat|</Fields>
     </DynSentence>
    <DynSentence name="UpdCtlSuc2"> <!--更新控制表,0解析批扣文件成功，1正在处理，2处理失败，3批扣和上传ftp完成-->
       <Sentence>
        UPDATE efebfilctl444 a
        SET DskSts='0',DskNo='%s'
        WHERE DskNam='%s' and ActDAT='%s'
       </Sentence>
       <Fields>DskNo|DskNam|ActDat|</Fields>
     </DynSentence>
     <DynSentence name="SelCusAgtInf2">  <!--查询有效的对私客户协议 -->
      <Sentence>
        SELECT count(*) cnt2 FROM afebatrec
        WHERE CAgtNo='%s' and DskNo='%s' and 
        　　　SeqNo in (select SUBSTR(b.PNO,6,5) from efecusagt a,efebatinf b 
              where a.BrNo='%s' and  b.DskNo='%s' and a.JFH=b.JFH and a.ActNo=b.ActNo and a.ActNam=b.ActNam and a.Status='0')
      </Sentence>
      <Fields>CAgtNo|DskNo|BrNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="UpdCusAgtInf2">  <!--检查有效的对私客户协议 -->
      <Sentence>
        UPDATE afebatrec a
        SET RecSts='Y'
        WHERE CAgtNo='%s' and DskNo='%s' and 
        　　　SeqNo in (select SUBSTR(b.PNO,6,5) from efecusagt a,efebatinf b 
              where a.BrNo='%s' and  b.DskNo='%s' and a.JFH=b.JFH and a.ActNo=b.ActNo and a.ActNam=b.ActNam and a.Status='0')
      </Sentence>
      <Fields>CAgtNo|DskNo|BrNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="SelNoAgr">  <!-- 查询没通过协议检查的记录 -->
      <Sentence>
        SELECT count(*) cnt1 FROM afebatrec 
        WHERE RecSts!='Y' AND CAgtNo='%s' AND DskNo='%s'
      </Sentence>
      <Fields>CAgtNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="UpdNoAgr">  <!-- 更新没通过协议检查的记录 -->
      <Sentence>
        UPDATE afebatrec 
        SET RecSts='X',HTxnST='S',HRspCd='400004'
        WHERE RecSts!='Y' AND CAgtNo='%s' AND DskNo='%s'
      </Sentence>
      <Fields>CAgtNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="UpRsvFld">  <!-- 更新pubbatinf的rsvfld -->
      <Sentence>
        UPDATE pubbatinf SET RsvFld='%s'
        WHERE BrNo='%s' AND DskNo='%s' 
      </Sentence>
      <Fields>CAgtNo|BrNo|DskNo|</Fields>
     </DynSentence>
     <DynSentence name="UpEfeLogNo">  <!-- 更新efebatinf的logno -->
      <Sentence>
        UPDATE efebatinf a
        SET a.LogNo=(select b.LogNo from afebatrec b
        WHERE a.DskNo='%s' AND b.DskNo=a.DskNo AND b.SeqNo=SUBSTR(a.PNO,6,5))
      </Sentence>
      <Fields>DskNo|</Fields>
     </DynSentence>
     <DynSentence name="UpEfeInf">  <!-- 更新efebatinf的PID、CUN、EDD和TLogNo -->
      <Sentence>
        UPDATE efebatinf SET PID='%s',CUN='%s',EDD='%s',TLogNo='%s' 
        WHERE DskNo='%s' 
      </Sentence>
      <Fields>ROOT.SUM.PID|ROOT.SUM.CUN|ROOT.SUM.EDD|ROOT.SUM.TLogNo|DskNo|</Fields>
     </DynSentence>
    <FlowCtrl>

      <Set>DLIP=@MSG.SIP</Set>
      <Exec func="PUB:ReadRecord">    <!--查询对应分行号 -->
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行号</Set>
        <Return/>
      </If>

      <Exec func="PUB:InitTransaction"/>    <!--交易初始化,预留-->

      <Exec func="PUB:GetAppInfo"/>

      <Set>DskNam=$FilNam</Set>
      <Set>TTxnCd=460222</Set>

      <!--取电子柜员号-->
      <Set>TxnCnl=EFE</Set>       <!--取电子柜员号用-->
      <Set>TxnObj=OFRTEFEA</Set>
      <Exec func="PUB:GetVirtualTeller">
        <Arg name="TxnCnl" value="EFE"/>
      </Exec>
      <Set>TlrId=$TlrId</Set>

      <!--判断文件是否重复录入-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QueDskNam"></Arg>
      </Exec>
      <If condition="~RetCod!=-2">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=STRCAT(改批次已录入，批次号为,$DskNo)</Set>
        <Return/>
      </If>
      <!--插入控制信息
      <Exec func="PUB:ExecSql">
        <Arg name="SqlCmd" value="Insctl"/>
      </Exec>
      -->
      <!--读取配置信息-->
      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GD_DLDFPL"/>
        <Arg name="Transaction" value="$TxnCod"/>
      </Exec>

      <!--设置个人协议检查标志-->
      <Switch  expression="$BrNo">
        <Case value="441999">
          <Break/>
        </Case>
        <Case value="444999">
          <Break/>
        </Case>
        <Case value="446999">
          <Break/>
        </Case>
        <Case value="445999">
          <Set>@PARA.ChkPsn=1</Set> 
          <Break/>
        </Case>
        <Case value="483999">
          <Break/>
        </Case>
        <Case value="484999">
          <Break/>
        </Case>
        <Case value="485999">
          <Set>@PARA.ChkPsn=1</Set> 
          <Break/>
        </Case>
        <Case value="491999">
          <Break/>
        </Case>
        <Case value="4761999">
          <Break/>
        </Case>
      </Switch>





      <!--准备大小通道需要的相关参数-->
      <Set>TxnMod=1</Set>
      <Set>CmtFlg=0</Set>
      <Set>AplCls=$AplCls</Set>
      <Set>BusTyp=$BusTyp</Set>
      <Set>BusSub=$BusSub</Set>
      <Set>ObjSvr=@PARA.ObjSvr</Set>
      <Set>FTxnCd=@PARA.FTxnCd</Set>  <!--后续交易(用于后续操作并通知前端批次完成的)-->
      <Set>BrNo=$BrNo</Set>   <!--入账分行号-->
      <Set>ActNod=$NodNo</Set>  <!--账务网点号-->
      <Set>TrdTbl=@PARA.TrdTbl</Set>
      <Set>NamChk=0</Set>   <!--需要检查户名-->
      <Set>TxnSqn=600</Set>
      <Set>TxnMod=1</Set>   <!-- 需要单笔上送 -->
      <Set>CmtFlg=0</Set>   <!-- 大小通道发送状态 -->
      <Set>UpdFlg=N</Set>   <!-- 更新标志 -->
      <Set>PayMod=0</Set>
      <Set>HPrChk=0</Set>
      <Set>HLsChk=0</Set>
      <Set>CActNo=$TActNo</Set>
      <Set>IsTxn=Y</Set>
      <Set>HTxnSt=U</Set>
      <Set>RsvFld=$CAgtNo</Set>
      <Set>HTxnCd=@PARA.HTxnCd</Set>
      <Set>Reckey=STRCAT($AplCls,:,$TxnCod,:,$FilNam)</Set>
      <Set>RcvFil=$FilNam</Set>
      <Set>LclFil=$FilNam</Set>
      <Set>LclDir=dat/efe</Set>
      <If condition="@PARA.RcvMod=1">
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
        <Switch  expression="$BrNo">
          <Case value="441999">
            <Set>EFERcv=EFE_RCV_441</Set>
            <Break/>
          </Case>
          <Case value="444999">
            <Break/>
          </Case>
          <Case value="446999">
            <Break/>
          </Case>
          <Case value="445999">
            <Set>EFERcv=EFE_RCV_445</Set>
            <Break/>
          </Case>
          <Case value="483999">
            <Break/>
          </Case>
          <Case value="484999">
            <Break/>
          </Case>
          <Case value="485999">
            <Set>EFERcv=EFE_RCV_485</Set>
            <Break/>
          </Case>
          <Case value="491999">
            <Break/>
          </Case>
          <Case value="4761999">
            <Break/>
          </Case>
          <Default>
            <Return/>
          </Default>
        </Switch>
        <Exec func="PUB:FtpGet">
          <Arg name="FtpId" value="$EFERcv"/>
        </Exec>
      </If>
      <Else>
      </Else>

      <Exec func="PUB:CollateRepeatRecord"> <!--判断是否是重复接收的报文-->
        <Arg name="CheckFileName" value="$DskNam"/>
      </Exec>

      <Exec func="PUB:Lock">      <!--按文件名加锁-->
        <Arg name="RecKey"   value="STRCAT($BusTyp,$CrpCod,$DskNam)"/>
        <Arg name="TimOut"   value="10"/>
      </Exec>

      <Exec func="PUB:RegisterBatchDiskNo"/>  <!--申请磁盘编号，登记批量信息到pubbatinf-->
      <!--
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="DeleteInf444"/>
      </Exec>
      -->
      <Exec func="PUB:Unlock">    <!--按文件名解锁-->
        <Arg name="RecKey"   value="STRCAT($BusTyp,$CrpCod,$DskNam)"/>
      </Exec>

      <!--导入文件-->
      <Set>FileName=STRCAT(GETENV(WORKDIR),/dat/efe/,$LclFil)</Set>
      <Exec func="PUB:IsExistFile"  error="IGNORE">
        <Arg name="FileName" value="$FileName"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=STRCAT(文件,$FilNam,不存在)</Set>
        <Return/>
      </If>

      <Exec func="PUB:PasteBatchFile" >   <!--拷贝文件 -->
        <Arg name="PathIn" value="dat/efe"/>
        <Arg name="FileNameIn" value="$LclFil"/>
        <Arg name="FileNameCurr" value="01"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=拷贝文件失败</Set>
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Return/>
      </If>

      <!--根据分行号取地区号-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="BrNo"/>
        <Arg name="DestNam" value="DstCod"/>
        <Arg name="TblNam"  value="DL_BrNo2DstCod"/>
      </Exec>
      <!--设置唯一识别码-->
      <Exec func="PUB:GetPubSeqNoCircle">
        <Arg name="SeqNam" value="EFE:WYSB"/>
        <Arg name="Len"    value="10"/>
      </Exec>
      <Set>WYSB=STRCAT(301,$DstCod,$ActDat,$SelVal)</Set>

      <!--因CAgtNo需要从efebatinf取,先倒入efebatinf,设置必要的大小通道信息,再倒入afebatrec-->
      <Exec func="PUB:ParseBatchFile">   <!--文件拆分入库-->
        <Arg name="FormatName"     value="@PARA.RcvFmt"/>   <!--文件格式-->
        <Arg name="TableName"      value="efebatinf"/>
        <Arg name="FileNameCurr"   value="01"/>
        <Arg name="ApplyLogNoFlag" value="0"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Return/>
      </If>


      <!--更新efebatinf的PID、CUN、EDD和TLogNo-->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="UpEfeInf"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Return/>
      </If>


      <Exec func="PUB:ReadRecord">  <!--获取单位协议-->
        <Arg name="SqlCmd" value="GetCAgtNo"></Arg>
      </Exec>

      <Exec func="PUB:ReadRecord">  <!--获取单位名称-->
        <Arg name="SqlCmd" value="GetCrpInf"></Arg>
      </Exec>

      <If condition="@PARA.ChkCrp=1">
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="Chk_CrpAgr"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=查询单位协议时系统错误</Set>
          <Return/>
        </If>
        <If condition="~RetCod=-2">
          <Set>RspCod=EFE999</Set><!--返回无有效单位协议-->
          <Set>RspMsg=查询单位协议时无有效单位协议</Set>
          <Return/>
        </If>
      </If>
      <If condition="@PARA.IsSignIn=1">
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="Chk_CrpSignIn"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=检查单位签到状态时系统错误</Set>
          <Return/>
        </If>
        <If condition="~RetCod=-2">
          <Set>RspCod=EFE999</Set><!--返回该单位未签到-->
          <Set>RspMsg=检查单位签到状态时该单位未签到</Set>
          <Return/>
        </If>
      </If>
      
      <Set>CActNo=$TActNo</Set>
      <Set>RsvFld=$CAgtNo</Set><!--补充大小通道参数-->

      <Set>BSmr=$BBusTyp</Set>

      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="UpRsvFld"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Return/>
      </If>

      <Set>SeqNo=1</Set>
      <Set>RecSts=0</Set> <!--RecSts 0:初始化 1:成功 2:失败-->
      <Exec func="PUB:ParseBatchFile">   <!--文件拆分入库-->
        <Arg name="FormatName"     value="@PARA.RcvFmt"/>   <!--文件格式-->
        <Arg name="TableName"      value="afebatrec"/>
        <Arg name="FileNameCurr"   value="01"/>
        <Arg name="ApplyLogNoFlag" value="1"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Return/>
      </If>

      <!--更新efebatinf的logno和afebatrec一致-->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="UpEfeLogNo"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Exec func="PUB:DeleteDiskNo"/>
        <Exec func="PUB:ExecSql">
          <Arg name="SqlCmd" value="DeleteInf"/>
        </Exec>
        <Set>RspCod=EFE999</Set>
        <Return/>
      </If>
    
      
      <!--入库成功和单位协议检查成功返回22报文-->
      <Set>RspCod=000000</Set>
      <Exec func="PUB:PutResponse"/>

      
       <!--检查个人签约协议-->
      <If condition="@PARA.ChkPsn=1">
        <Exec func="PUB:ReadRecord">  
          <Arg name="SqlCmd" value="SelCusAgtInf2"></Arg>
        </Exec>
        <If condition="STRCMP($cnt2,0)!=0">
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd" value="UpdCusAgtInf2"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:DeleteDiskNo" />
            <Return />
          </If>
          <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
          </ElseIf>
        </If>
        <!-- 更新没通过协议检查的记录 -->
        <Exec func="PUB:ReadRecord">  
          <Arg name="SqlCmd" value="SelNoAgr"></Arg>
        </Exec>
        <If condition="STRCMP($cnt1,0)!=0">
          <Exec func="PUB:ExecSql" error="PUB:DeleteDiskNo">
            <Arg name="SqlCmd" value="UpdNoAgr"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:DeleteDiskNo" />
            <Return />
          </If>
          <ElseIf condition="~RetCod=-2">
            <Set>RspCod=000000</Set>
          </ElseIf>
        </If>
      </If>


      <!--修改本批次为预备确认状态，等待启动大小通道 -->
      <Exec func="PUB:UpdateBatchStatus" error="PUB:DeleteDiskNo">
        <Arg name="ChkFlg" value="P"/>
      </Exec>
      <Exec func="PUB:DeleteDiskNo"/>
      <!--执行成功，修改批扣控制表标志为批扣文件解析处理成功
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="UpdCtlSuc2"/>
      </Exec>
       -->
      <Exec func="PUB:ConfirmBatch"/>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Return/>
      </If>



      <Set>RspCod=000000</Set>
      <Set>RspMsg=操作成功</Set>

    </FlowCtrl>

  </Transaction>

  <Transaction code="460224" desc="供电发起批量代扣取消">

    <DynSentence name="ChkDskSts">
      <Sentence>
        select * from efebfilctl444 WHERE DskNam='%s'
      </Sentence>
      <Fields>FilNm|</Fields>
    </DynSentence>

    <DynSentence name="QryInfCtl">             <!--查询对应分行号-->
      <Sentence>
        SELECT BrNo FROM efeinfctl WHERE DstAddr='%s'
      </Sentence>
      <Fields>StartAddr|</Fields>
    </DynSentence>


    <DynSentence name="QueBatInf">
      <Sentence>
        SELECT DskNo,Status,CmtFlg FROM pubbatinf WHERE BrNo='%s' AND ActDat='%s' AND DskNam='%s'
      </Sentence>
      <Fields>BrNo|ActDat|DskNam|</Fields>
    </DynSentence>


    <FlowCtrl>

      <Exec func="PUB:InitTransaction"/>

      <Exec func="PUB:ReadRecord">    <!--查询对应分行号 -->
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行号</Set>
        <Return/>
      </If>

      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QueBatInf"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>QSFlg=4</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=检查批次状态时系统错误</Set>
        <Return/>
      </If>
      <If condition="~RetCod=-2">
        <Set>QSFlg=3</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=检查批次状态时未发现该批次</Set>
        <Return/>
      </If>

      <Set>BankLs=STRCAT($DskNo,GETDATETIME(HHMI))</Set>

      <!-- QSFlg  1文件未扣款，取消成功；2 文件已扣款，取消失败；3 文件名错误，取消失败；4 其他原因，取消失败 -->
      <Switch expression="$CmtFlg">
        <Case value="A"/>
        <Case value="B"/>
        <Case value="C">
          <Set>QSFlg=2</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=扣费完成并已返回结果无法撤销</Set>
          <Return/>
        </Case>
        <Default>
          <Set>QSFlg=2</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=已开始扣费无法撤销</Set>
          <Return/>
        </Default>
      </Switch>

    </FlowCtrl>

  </Transaction>



  <Transaction code="460225" desc="文件批量完成通知第三方">
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="GetCrpInf">
      <Sentence>
        SELECT a.OrnCnt,a.OrnAmt,b.CAgtNo,b.BBusTyp,c.CrpNam
        FROM pubbatinf a,savcrpagr b,savcrpinf c
        WHERE a.DskNo='%s' AND a.RsvFld=b.CAgtNo AND b.CrpCod=c.CrpCod AND b.BrNo=c.BrNo
      </Sentence>
      <Fields>DskNo</Fields>
    </DynSentence>
    <DynSentence name="QryBatInf"><!--查询本交易所需信息-->
      <Sentence>
        SELECT BrNo,DskNo,SndTlr TlrId,NodNo,DskNam From pubbatinf WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <!--
    <DynSentence name="UpdBatInf">
      <Sentence>
        update pubbatinf
        set Status='N'
        WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    -->
    <DynSentence name="QryTxnInf">  <!--查询交易记录-->
      <Sentence>
        SELECT a.*,c.*
        FROM afebatrec a,efebatinf c
        WHERE  a.DskNo='%s' AND a.DskNo=c.DskNo AND a.LogNo=c.LogNo
        ORDER BY c.PNO
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="QryTxnHed">  <!--查询文件头信息-->
      <Sentence>
        SELECT distinct BrNo,PID,CUN,EDD,WYSB,ActDat  FROM efebatinf  WHERE  DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="TotSql">
      <Sentence>
        select count(*) TotCnt, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotAmt
        from afebatrec
        where DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="TotSucSql">
      <Sentence>
        select count(*) STotCnt, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) STotAmt
        from afebatrec
        where  DskNo='%s' and HTxnSt='S' and RecSts='1'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="TotFalSql">
      <Sentence>
        select count(*) FTotCnt, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) FTotAmt
        from afebatrec
        where  DskNo='%s' and HTxnSt in ('S','F') and RecSts!='1'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
     <DynSentence name="UpEfeStatus">  <!-- 更新efebatinf的Status -->
      <Sentence>
        UPDATE efebatinf a
        SET a.Status=(select b.HTXNST from afebatrec b
        WHERE a.DskNo='%s' AND b.DskNo=a.DskNo AND b.LogNo=a.LogNo)
      </Sentence>
      <Fields>DskNo|</Fields>
     </DynSentence>
    <FlowCtrl>

      <Set>DskNo=$LogNo</Set>

      <!--更新efebatrec的Status-->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="UpEfeStatus"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryTxnHed"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="GetCrpInf"/>
      </Exec>
      <Exec func="PUB:ReadRecord"><!--查询必需信息-->
        <Arg name="SqlCmd" value="QryBatInf"/>
      </Exec>

      <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>

      <Exec func="PUB:GetCommInf" error="IGNORE">
        <Arg name="CndId"  value="STRCAT(efe_,$BrNo)"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行IP设置</Set>
        <Return/>
      </If>

      <Set>@MSG.OIP=$HstIp</Set>  <!--第三方IP-->
      <Set>@MSG.OPT=$HstPrt</Set> <!--第三方PORT-->


      <Exec func="PUB:CancelBatchRedo"/><!--以下两句用于更新pubbatinf中的状态值-->

      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="TotSucSql"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="TotFalSql"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="TotSql"/>
      </Exec>
      <!--
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="GetFileName"/>
      </Exec>
      -->
      <Set>LclDir=dat/efe</Set>
      <Set>LclFil=STRCAT(SUBSTR($DskNam,1,12),h,SUBSTR($DskNam,14,10),.txt)</Set><!--替换发送文件名里的“fs”为“fh”-->
      <Set>SndFil=$LclFil</Set>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="GD_DLDFPL"/>
        <Arg name="Transaction" value="460222"/>
      </Exec>

      <!--产生已扣文件给电力-->
      <Exec func="PUB:ExportFromDB">
        <Arg name="FormatName" value="@PARA.SndFmt"/>
        <Arg name="SqlName"    value="QryTxnInf"/>
        <Arg name="FileName"   value="STRCAT($LclDir,/,$LclFil)"/>
        <Arg name="TableName"  value="afebatrec"/>
      </Exec>
      <!--FTP -->
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
        <Switch  expression="$BrNo">
          <Case value="441999">
            <Set>EFESnd=EFE_SND_441</Set>
            <Break/>
          </Case>
          <Case value="444999">
            <Break/>
          </Case>
          <Case value="446999">
            <Break/>
          </Case>
          <Case value="445999">
          	<Set>EFESnd=EFE_SND_445</Set>
            <Break/>
          </Case>
          <Case value="483999">
            <Break/>
          </Case>
          <Case value="484999">
            <Break/>
          </Case>
          <Case value="485999">
          	<Set>EFESnd=EFE_SND_485</Set>
            <Break/>
          </Case>
          <Case value="491999">
            <Break/>
          </Case>
          <Case value="4761999">
            <Break/>
          </Case>
          <Case value="441999">
            <Break/>
          </Case>
          <Default>
            <Set>EFESnd=EFE_SND_441</Set>
          </Default>
        </Switch>       
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="$EFESnd"/>
      </Exec>
      
      <!--发23报文给电力-->
      <Set>FileName=$LclFil</Set><!--返回文件名-->
      <Set>recordNum=$TotCnt</Set><!--给请求报文设置数据明细项数-->
      <Set>HAN=$STotCnt</Set><!--已扣笔数-->
      <Set>HAM=$STotAmt</Set><!--已扣金额-->
      <Set>LSN=$FTotCnt</Set><!--失败笔数-->
      <Set>LSM=$FTotAmt</Set> <!--失败金额-->



      <Exec func="PUB:CallThirdOther">   <!--第三方发送报文-->
        <Arg name="HTxnCd" value="460223"/>
        <Arg name="ObjSvr" value="STHDEFEA"/>
      </Exec>

      <Exec func="PUB:CancelBatchRedo"/>

    </FlowCtrl>

  </Transaction>

  <Transaction code="460290" desc="银电业务开工交易">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryInfCtl">             <!--查询对应分行号-->
      <Sentence>
        SELECT BrNo FROM efeinfctl WHERE DLIP='%s'
      </Sentence>
      <Fields>DLIP|</Fields>
    </DynSentence>
    <DynSentence name="QryCrpAgr">             <!--查询单位信息 -->
      <Sentence>
        SELECT TActNo, BBusTyp FROM savcrpagr WHERE CAgtNo='%s' AND SvrSts='1'
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UdpInfCtl">             <!--修改开工信息表 -->
      <Sentence>
       UPDATE efeinfctl Set Status='%s',WdoDat='%s',OprCod='%s',DlTxt='%s' WHERE BrNo='%s'
      </Sentence>
      <Fields>Status|WdoDat|OprCod|DlTxt|BrNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Set>DLIP=@MSG.SIP</Set>
      <!--查询对应分行号 -->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行号</Set>
        <Return/>
      </If>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

       <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
      <If condition="$Status=1">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=银电系统已在开工状态</Set>
        <Return/>
      </If>


     <!--修改为开工状态-->
     <Set>Status=1</Set>
     <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd"   value="UdpInfCtl"/>
     </Exec>
     <If condition="~RetCod=-1">
      <Exec func="PUB:RollbackWork" error="IGNORE" />
      <Set>MsgTyp=E</Set>
      <Set>RspCod=EFE999</Set>
      <Set>RspMsg=数据库处理失败!</Set>
      <Return/>
     </If>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460291" desc="银电业务停工交易">
    <DynSentence name="QryInfCtl">             <!--查询对应分行号-->
      <Sentence>
        SELECT BrNo FROM efeinfctl WHERE DLIP='%s'
      </Sentence>
      <Fields>DLIP|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryCrpAgr">             <!--查询单位信息 -->
      <Sentence>
        SELECT TActNo, BBusTyp FROM savcrpagr WHERE CAgtNo='%s' AND SvrSts='1'
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <DynSentence name="UdpInfCtl">             <!--修改开工信息表 -->
      <Sentence>
       UPDATE efeinfctl Set Status='%s',WdoDat='%s',OprCod='%s',DlTxt='%s' WHERE BrNo='%s'
      </Sentence>
      <Fields>Status|WdoDat|OprCod|DlTxt|BrNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <Set>DLIP=@MSG.SIP</Set>
      <!--查询对应分行号 -->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行号</Set>
        <Return/>
      </If>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

       <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
      <If condition="$Status=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=银电系统已在停工状态</Set>
        <Return/>
      </If>


     <!--修改为停工状态-->
     <Set>Status=0</Set>
     <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd"   value="UdpInfCtl"/>
     </Exec>
     <If condition="~RetCod=-1">
      <Exec func="PUB:RollbackWork" error="IGNORE" />
      <Set>MsgTyp=E</Set>
      <Set>RspCod=EFE999</Set>
      <Set>RspMsg=数据库处理失败!</Set>
      <Return/>
     </If>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460231" desc="供电发起代扣协议变更交易">
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <DynSentence name="QryInfCtl">             <!--查询对应分行号-->
      <Sentence>
        SELECT BrNo FROM efeinfctl WHERE DLIP='%s'
      </Sentence>
      <Fields>DLIP|</Fields>
    </DynSentence>
    <DynSentence name="QryCusCnt">             <!--查询协议存在 -->
      <Sentence>
        SELECT count(*) cnt1 from efecusagt WHERE JFH='%s' AND Status='0'
      </Sentence>
      <Fields>JFH|</Fields>
    </DynSentence>
    <DynSentence name="QryCusAgt">             <!--查询协议信息 -->
      <Sentence>
        SELECT * from efecusagt WHERE JFH='%s' AND Status='0'
      </Sentence>
      <Fields>JFH|</Fields>
    </DynSentence>
    <DynSentence name="InsCusAgt">             <!--新增签约记录 -->
      <Sentence>
        INSERT INTO efecusagt(BrNo,PAgtNo,CAgtNo,SBN,ECD,WDO,EDD,JFH,UsrNam,KKB,ActNo,
           ActNam,GPF,IdTyp,IdNo,
           JLD,TXT,Status)
        VALUES('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s',
               '%s','%s','%s','%s',
               '%s','%s','0')
      </Sentence>
      <Fields>
        BrNo|PAgtNo|CAgtNo|SBN|ECD|WDO|EDD|JFH|UsrNam|KKB|TActNo|TActNm|GPF|TIdTyp|TIdNo|JLD|TXT|
      </Fields>
    </DynSentence>
     <DynSentence name="UdpCusAgt">             <!--修改签约记录 -->
      <Sentence>
        UPDATE efecusagt set BrNo ='%s',SBN='%s',ECD='%s',WDO  ='%s',EDD='%s',
           JFH='%s',KKB='%s',ActNo='%s',KAT='%s',ActNam='%s',IdTyp='%s',
          IdNo='%s',JLD='%s',TXT='%s',UsrNam='%s'
          WHERE JFH='%s' and Status='0'
      </Sentence>
      <Fields>
        BrNo|SBN|ECD|WDO|EDD|JFH|KKB|TActNo|ACT|TActNm|TIdTyp|TIdNo|JLD|TXT|UsrNam|JFH|
      </Fields>
    </DynSentence>
    <DynSentence name="DelCusAgr">             <!--删除签约记录 -->
      <Sentence>
        DELETE FROM efecusagt where brno='%s' and JFH='%s'
      </Sentence>
      <Fields>BrNo|JFH|</Fields>
    </DynSentence>
    <DynSentence name="CclCusAgt">             <!--注销签约记录 -->
      <Sentence>
        UPDATE efecusagt SET Status='1' WHERE brno='%s' AND JFH='%s' and Status='0'
      </Sentence>
      <Fields>BrNo|JFH|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>DLIP=@MSG.SIP</Set>
      <!--查询对应分行号 -->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行号</Set>
        <Return/>
      </If>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <Set>TTxnCd=460231</Set>    <!--第三方交易码-->
      <Set>WTC=301</Set>          <!--委托节点代码-->

      <Switch  expression="$BrNo">
        <Case value="441999">
          <Set>NodNo=441800</Set>
          <Break/>
        </Case>
        <Case value="444999">
          <Set>NodNo=444800</Set>
          <Break/>
        </Case>
        <Case value="446999">
          <Set>NodNo=446800</Set>
          <Break/>
        </Case>
        <Case value="445999">
          <Set>NodNo=445800</Set>
          <Break/>
        </Case>
        <Case value="483999">
          <Set>NodNo=483800</Set>
          <Break/>
        </Case>
        <Case value="484999">
          <Set>NodNo=484800</Set>
          <Break/>
        </Case>
        <Case value="485999">
          <Set>NodNo=485800</Set>
          <Break/>
        </Case>
        <Case value="491999">
          <Set>NodNo=491800</Set>
          <Break/>
        </Case>
        <Case value="476999">
          <Set>NodNo=476800</Set>
          <Break/>
        </Case>
      </Switch>
      <!--取电子柜员号-->
      <Set>TxnCnl=EFE</Set>       <!--取电子柜员号用-->
      <Set>TxnObj=OFRTEFEA</Set>
      <Exec func="PUB:GetVirtualTeller">
        <Arg name="TxnCnl" value="EFE"/>
      </Exec>
      <Set>TlrId=$TlrId</Set>

      <Switch expression="$CHT">
        <!--新增-->
        <Case value="0">
          <!--根据缴费号检查是否签约-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryCusCnt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=缴费号查询失败</Set>
            <Return/>
          </If>
          <If condition="STRCMP($cnt1,1)=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=该缴费号已经签约</Set>
            <Return/>
          </If>
          <!--校验各分行账号-->
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
          <!--只有广州、珠海、佛山和中山有Acjud_行号函数，其他分行要加-->
          <Set>ActNo=$TActNo</Set>
          <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
          <Call function="$AcJudFunc">
            <Input name="ActNo|NewFlg|"/>
            <Output name="OActNo|ActCls|"/>
          </Call>
          <!--向主机查询账户信息-->
          <Switch expression="$ActCls">
            <Case value="2" /> <!-- 对私 -->
            <Case value="3" />
            <Case value="5" >
              <If condition="INTCMP($ActCls,3,3)">
                 <Set>ActFlg=4</Set>  <!--对私卡号-->
                 <Set>ActTyp=4</Set>
              </If>
              <Else>
                 <Set>ActFlg=2</Set>  <!--对私帐号-->
                 <Set>ActTyp=2</Set>
              </Else>
              <Set>GPF=P</Set>
              <Set>CcyCod=CNY</Set>

              <!--上主机查询客户资料-->
              <Exec func="PUB:CallHostOther" error="IGNORE">
                <Arg name="HTxnCd" value="476520"/>
                <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>
              <If condition="$MsgTyp!=N">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户不存在</Set>
                <Return/>
              </If>
              <!--校验账户名称、开户证件类型和开户证件号码-->
              <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
              <Set>IDNo=DELBOTHSPACE($IDNo)</Set>
              <If condition="OR(IS_NOEQUAL_STRING($TActNm,$ActNam),IS_NOEQUAL_STRING($TIdNo,$IDNo))">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=账户名称或者证件号码不符</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Case value="0" /> <!-- 对公 -->
            <Case value="4" >
              <Set>GPF=G</Set>
              <Set>ActTyp=1</Set>
              <!--上主机查询客户资料-->
              <Exec func="PUB:CallHostOther" error="IGNORE">
                <Arg name="HTxnCd" value="109000"/>
                <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>
              <If condition="$MsgTyp!=N">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户不存在</Set>
                <Return/>
              </If>
              <!--校验账户名称、开户证件类型和开户证件号码-->
              <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
              <Set>ActQ04=DELBOTHSPACE($ActQ04)</Set>
              <If condition="IS_NOEQUAL_STRING($TActNm,$ActNam)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=账户名称不符</Set>
                <Return/>
              </If>
              <If condition="IS_NOEQUAL_STRING($TIdNo,$ActQ04)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=证件号码不符</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Default>
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户类型不存在</Set>
                <Return/>
            </Default>
          </Switch>

          <!--取单位协议编号-->
          <Set>CAgtNo= </Set>
          <!--取协议序列号-->
          <Set>SeqCnd=SUBSTR($BrNo,1,3)</Set><!--取个人协议编号-->
          <Exec func="PUB:GetPubSeqNo">
            <Arg name="SeqNam" value="efecusagt:PAgtNo"></Arg>   <!--业务码待定后再将其作为生成依据-->
            <Arg name="SeqCnd" value="$SeqCnd"></Arg>
            <Arg name="Len" value="10"></Arg>
          </Exec>
          <Set>PAgtNo=STRCAT($SeqCnd,$SelVal)</Set>
          <Set>BrNo   =$BrNo</Set>
          <Set>PAgtNo =$PAgtNo</Set>
          <Set>CAgtNo =$CAgtNo</Set>
          <Set>SBN    =$SBN</Set>
          <Set>ECD    =$ECD</Set>
          <Set>WDO    =$WDO</Set>
          <Set>EDD    =$EDD</Set>
          <Set>JFH    =$JFH</Set>
          <Set>UsrNam =$UsrNam</Set>
          <Set>KKB    =$KKB</Set>
          <Set>TActNo =$TActNo</Set>
          <Set>KAT    =$KAT</Set>
          <Set>TActNm =$TActNm</Set>
          <Set>GPF    =$GPF   </Set>
          <Set>TIdTyp =$TIdTyp</Set>
          <Set>TIdNo  =$TIdNo </Set>
          <Set>ZPF    =$ZPF   </Set>
          <Set>FPF    =$FPF   </Set>
          <Set>JLD    =$JLD   </Set>
          <Set>FPM    =$FPM   </Set>
          <Set>FPC    =$FPC   </Set>
          <Set>FPA    =$FPA   </Set>
          <Set>ZPM    =$ZPM   </Set>
          <Set>ZPC    =$ZPC   </Set>
          <Set>ZPA    =$ZPA   </Set>
          <Set>YBZ    =$YBZ   </Set>
          <Set>EML    =$EML   </Set>
          <Set>MOB    =$MOB   </Set>
          <Set>TEL    =$TEL   </Set>
          <Set>TXT    =$TXT   </Set>
          <!--插入库表-->
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd"   value="InsCusAgt"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据库处理失败!</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <!--修改-->
        <Case value="3">
          <!--根据缴费号检查是否签约-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryCusCnt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=缴费号查询失败</Set>
            <Return/>
          </If>
          <If condition="STRCMP($cnt1,0)=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=该缴费号没签约</Set>
            <Return/>
          </If>
          <!--校验各分行账号-->
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
          <!--只有广州、珠海、佛山和中山有Acjud_行号函数，其他分行要加-->
          <Set>ActNo=$TActNo</Set>
          <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
          <Call function="$AcJudFunc">
            <Input name="ActNo|NewFlg|"/>
            <Output name="OActNo|ActCls|"/>
          </Call>
          <!--向主机查询账户信息-->
          <Switch expression="$ActCls">
            <Case value="2" /> <!-- 对私 -->
            <Case value="3" />
            <Case value="5" >
              <If condition="INTCMP($ActCls,3,3)">
                 <Set>ActFlg=4</Set>  <!--对私卡号-->
                 <Set>ActTyp=4</Set>
              </If>
              <Else>
                 <Set>ActFlg=2</Set>  <!--对私帐号-->
                 <Set>ActTyp=2</Set>
              </Else>
              <Set>GPF=P</Set>
              <Set>CcyCod=CNY</Set>

              <!--上主机查询客户资料-->
              <Exec func="PUB:CallHostOther" error="IGNORE">
                <Arg name="HTxnCd" value="476520"/>
                <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>
              <If condition="$MsgTyp!=N">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户不存在</Set>
                <Return/>
              </If>
              <!--校验账户名称、开户证件类型和开户证件号码-->
              <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
              <Set>IDNo=DELBOTHSPACE($IDNo)</Set>
              <If condition="OR(IS_NOEQUAL_STRING($TActNm,$ActNam),IS_NOEQUAL_STRING($TIdNo,$IDNo))">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=账户名称或者证件号码不符</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Case value="0" /> <!-- 对公 -->
            <Case value="4" >
              <Set>GPF=G</Set>
              <Set>ActTyp=1</Set>
              <!--上主机查询客户资料-->
              <Exec func="PUB:CallHostOther" error="IGNORE">
                <Arg name="HTxnCd" value="109000"/>
                <Arg name="ObjSvr" value="SHSTPUB1"/>
              </Exec>
              <If condition="$MsgTyp!=N">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户不存在</Set>
                <Return/>
              </If>
              <!--校验账户名称、开户证件类型和开户证件号码-->
              <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
              <Set>ActQ04=DELBOTHSPACE($ActQ04)</Set>
              <If condition="IS_NOEQUAL_STRING($TActNm,$ActNam)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=账户名称不符</Set>
                <Return/>
              </If>
              <If condition="IS_NOEQUAL_STRING($TIdNo,$ActQ04)">
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=证件号码不符</Set>
                <Return/>
              </If>
              <Break/>
            </Case>
            <Default>
                <Set>RspCod=EFE999</Set>
                <Set>RspMsg=帐户类型不存在</Set>
                <Return/>
            </Default>
          </Switch>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd"   value="UdpCusAgt"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据库处理失败!</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <!--查询-->
        <Case value="5">
          <!--根据缴费号检查是否签约-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryCusAgt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=缴费号查询失败</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <!--注销-->
        <Case value="9">
          <!--根据缴费号检查是否签约-->
          <Exec func="PUB:ReadRecord">
            <Arg name="SqlCmd" value="QryCusCnt"/>
          </Exec>
          <If condition="~RetCod!=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=缴费号查询失败</Set>
            <Return/>
          </If>
          <If condition="STRCMP($cnt1,0)=0">
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=该缴费号没签约</Set>
            <Return/>
          </If>
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Arg name="SqlCmd"   value="CclCusAgt"/>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据库处理失败!</Set>
            <Return/>
          </If>
          <Break/>
        </Case>
        <Default>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=没该种选择</Set>
          <Return/>
        </Default>
      </Switch>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460250" desc="银行发起银行代扣代收电费对帐交易">
    <!--生成文件-->
    <!--
    <DynSentence name="GetTxnJnl">
      <Sentence>
        SELECT  a.*,b.*
        FROM afetxnjnl a,efebchkinf444 b
        WHERE CAgtNo in ('4440000893')
        AND a.ActDat='%s' AND (HTxnSt='S' OR HTxnSt='C') AND a.TLOGNO = b.TLOGNO
      </Sentence>
      <Fields>TxnDat|</Fields>
    </DynSentence>
    -->
    <!--生成文件 总笔数-->
    <!--DynSentence name="TotalDeal">
      <Sentence>
        SELECT Count(*) TotalDeal, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotalFee
        FROM afetxnjnl
        WHERE CAgtNo in ('4440000893')
        AND ActDat='%s' AND (HTxnSt='S' OR HTxnSt='C') AND TTxnCd='20 '
      </Sentence>
      <Fields>TxnDat|</Fields>
    </DynSentence-->

    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT StrAddr,DstAddr,WdoDat,CreOrg,OprCod,Status FROM efeinfctl WHERE BrNo='%s'
      </Sentence>
      <Fields>BrNo|</Fields>
    </DynSentence>
    <!--生成文件  只统计主机成功状态的-->
    <DynSentence name="GetTxnJnl">
      <Sentence>
        SELECT  a.*,b.*,c.*
        FROM afetxnjnl a,efechkinf b,efechkdtl c
        WHERE a.CAgtNo = '%s'
        AND a.ActDat='%s' AND HTxnSt='S' AND a.TLOGNO = b.TLOGNO AND a.BrNo=b.Brno AND a.LOGNO=b.LOGNO
        AND b.TLOGNO = c.TLOGNO AND b.BrNo=c.Brno AND b.LOGNO=c.LOGNO
      </Sentence>
      <Fields>CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <!--生成文件 总笔数 只统计主机成功状态的-->
    <DynSentence name="TotalDeal">
      <Sentence>
        SELECT Count(*) TotalDeal, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) TotalFee
        FROM afetxnjnl
        WHERE CAgtNo  = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND TxnCod in ('460205','460220')
      </Sentence>
      <Fields>CAgtNo|TxnDat|</Fields>
    </DynSentence>

     <!--生成文件 当日日抹帐-->
    <!--DynSentence name="PayCancDeal">
      <Sentence>
        SELECT Count(*) PayCancDeal, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) PayCancBill
        FROM afetxnjnl
        WHERE CAgtNo in ('4440000893')
        AND ActDat='%s' AND HTxnSt='C' AND TTxnCd='20 '
      </Sentence>
      <Fields>TxnDat|</Fields>
    </DynSentence-->

    <!--生成文件 单日单笔代扣成功-->
    <DynSentence name="PaySuccDeal">
      <Sentence>
        SELECT Count(*) PaySuccDeal, COALESCE(sum(CAST(TxnAmt AS BIGINT)),0) PaySuccBill
        FROM afetxnjnl
        WHERE CAgtNo = '%s'
        AND ActDat='%s' AND HTxnSt='S' AND TxnCod in ('460205','460220')
      </Sentence>
      <Fields>CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <!--插入对账记录-->
    <DynSentence name="InsChkRec">
      <Sentence>
         INSERT INTO efechkrec values('%s','%s','%s','%s','%s',' ',' ')
      </Sentence>
      <Fields>BrNo|ActDat|SndTim|LogNo|LclFil|</Fields>
    </DynSentence>
    <!--修改对账记录-->
    <DynSentence name="UpdChkRec">
      <Sentence>
         UPDATE efechkrec SET TRspCd='%s',RtnMsg='%s' WHERE BrNo='%s' AND LogNo='%s'
      </Sentence>
      <Fields>TRspCd|RtnMsg|BrNo|LogNo|</Fields>
    </DynSentence>
    
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <Exec func="PUB:InitTransaction"/>
      <!--Set>TxnDat=CALCDATE($ActDat,-,d,1)</Set-->
      <!--
      <Set>TxnDat=CALCDATE($WDO,-,d,1)</Set>
      -->

       <!--读取开工信息记录-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInfCtl"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=无$BrNo分行开工信息记录</Set>
        <Return/>
      </If>
      <If condition="$Status=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=银电系统已在关闭状态</Set>
        <Return/>
      </If>


      <Exec func="PUB:GetCommInf" error="IGNORE">
        <Arg name="CndId"  value="STRCAT(efe_,$BrNo)"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没对应分行IP设置</Set>
        <Return/>
      </If>

      <Set>@MSG.OIP=$HstIp</Set>  <!--第三方IP-->
      <Set>@MSG.OPT=$HstPrt</Set> <!--第三方PORT-->

      <Set>TxnDat=$WDO</Set>
      <!--
      <Switch  expression="$BrNo">
        <Case value="441999">
          <Set>AppNm=GZ_EFE1</Set>
          <Break/>
        </Case>
        <Case value="444999">
          <Set>AppNm=ZH_EFE1</Set>
          <Break/>
        </Case>
        <Case value="446999">
          <Set>AppNm=FS_EFE1</Set>
          <Break/>
        </Case>
        <Case value="445999">
          <Set>AppNm=ST_EFE1</Set>
          <Break/>
        </Case>
        <Case value="483999">
          <Set>AppNm=DG_EFE1</Set>
          <Break/>
        </Case>
        <Case value="484999">
          <Set>AppNm=ZS_EFE1</Set>
          <Break/>
        </Case>
        <Case value="485999">
          <Set>AppNm=JY_EFE1</Set>
          <Break/>
        </Case>
        <Case value="491999">
          <Set>AppNm=HZ_EFE1</Set>
          <Break/>
        </Case>
        <Case value="4761999">
          <Set>AppNm="JM_EFE1</Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="AppNm"/>
        <Arg name="DestNam" value="CAgtNo"/>
        <Arg name="TblNam"  value="DL_AppNm"/>
      </Exec>
      -->
      <Set>LclDir=dat/efe</Set>
        <!--441999广东省分行-->
        <!--444999珠海分行-->
        <!--446999佛山分行-->
        <!--445999汕头分行-->
        <!--483999东莞分行-->
        <!--484999中山分行-->
        <!--485999揭阳支行-->
        <!--491999惠州分行-->
        <!--761999江门分行-->
      <Switch  expression="$BrNo">
        <Case value="441999">
          <Set>LclFil=STRCAT(301581003dz,$TxnDat,.txt)</Set>
          <Break/>
        </Case>
        <Case value="444999">
          <Set>LclFil=STRCAT(301585003dz,$TxnDat,.txt)</Set>  <!--设置文件名 301交通银行代号(3位) 5850珠海地区代码（4位）03对帐文件类型(2 位 )-->
          <Break/>
        </Case>
        <Case value="446999">
          <Set>LclFil=STRCAT(301588003dz,$TxnDat,.txt)</Set>
          <Break/>
        </Case>
        <Case value="445999">
          <Set>LclFil=STRCAT(301586003dz,$TxnDat,.txt)</Set>
          <Break/>
        </Case>
        <Case value="483999">
          <Set>LclFil=STRCAT(301602003dz,$TxnDat,.txt)</Set>
          <Break/>
        </Case>
        <Case value="484999">
          <Set>LclFil=STRCAT(301603003dz,$TxnDat,.txt)</Set>
          <Break/>
        </Case>
        <Case value="485999">
          <Set>LclFil=STRCAT(301520003dz,$TxnDat,.txt)</Set>
          <Break/>
        </Case>
        <Case value="491999">
          <Set>LclFil=STRCAT(301595003dz,$TxnDat,.txt)</Set>
          <Break/>
        </Case>
        <Case value="761999">
          <Set>LclFil=STRCAT(301589003dz,$TxnDat,.txt)</Set>
          <Break/>
        </Case>
        <Default>
          <Set>LclFil=STRCAT(301581003dz,$TxnDat,.txt)</Set>
        </Default>
      </Switch>

      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="TotalDeal"/>
      </Exec>

      <!--Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="PayCancDeal"/>
      </Exec-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="PaySuccDeal"/>
      </Exec>
      <Set>FSC=DELBOTHSPACE($TotalDeal)</Set>
      <Set>FSM=DELBOTHSPACE($TotalFee)</Set>
      <!--
      <Set>FMC=DELBOTHSPACE($PayCancDeal)</Set>
      <Set>FMM=DELBOTHSPACE($PayCancBill)</Set>
      -->
      <Set>FMC=  </Set>
      <Set>FMM=  </Set>

      <Set>FDC=DELBOTHSPACE($PaySuccDeal)</Set>
      <Set>FDM=DELBOTHSPACE($PaySuccBill)</Set>
      <Set>CCD=GETDATE()</Set>
      <Set>WDO=GETDATE()</Set>
      <Set>DTN=DELBOTHSPACE($TotalDeal)</Set>
      <Exec func="PUB:ExportFromDB">    <!--产生上送供电方的文件-->
        <Arg name="SqlName" value="GetTxnJnl"/>
        <Arg name="FormatName" value="EFE_DZ"/>
        <Arg name="FileName" value="STRCAT($LclDir,/,$LclFil)"/>
        <Arg name="TableName" value="afetxnjnl"/>
      </Exec>
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
        <Switch  expression="$BrNo">
          <Case value="441999">
            <Set>EFESnd=EFE_SND_441</Set>
            <Break/>
          </Case>
          <Case value="444999">
          	<Set>EFESnd=EFE_SND_444</Set>
            <Break/>
          </Case>
          <Case value="446999">
          	<Set>EFESnd=EFE_SND_446</Set>
            <Break/>
          </Case>
          <Case value="445999">
          	<Set>EFESnd=EFE_SND_445</Set>
            <Break/>
          </Case>
          <Case value="483999">
          	<Set>EFESnd=EFE_SND_483</Set>
            <Break/>
          </Case>
          <Case value="484999">
          	<Set>EFESnd=EFE_SND_484</Set>
            <Break/>
          </Case>
          <Case value="485999">
          	<Set>EFESnd=EFE_SND_485</Set>
            <Break/>
          </Case>
          <Case value="491999">
          	<Set>EFESnd=EFE_SND_491</Set>
            <Break/>
          </Case>
          <Case value="761999">
          	<Set>EFESnd=EFE_SND_761</Set>
            <Break/>
          </Case>
          <Default>
            <Set>EFESnd=EFE_SND_441</Set>
          </Default>
        </Switch>
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="$EFESnd"/>
      </Exec>
      <Set>MsgInf1=STRCAT(向供电方发送对账文件成功)</Set>
			<Set>MsgTyp=N</Set>
			<Set>RspCod=000000</Set>
			<Set>RspMsg=交易成功!</Set>      
      
      
      <Exec func="PUB:GetLogNo"/>
      
      <Exec func="PUB:PutResponse"/> <!--返回前端-->
      
      <Set>SndTim=GETDATETIME()</Set>
      <!--发送对账交易前记录对账信息-->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd"   value="InsChkRec"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=数据库处理失败!</Set>
        <Return/>
      </If>

      <Set>FileName=$LclFil</Set>
      <Set>recordNum=$DTN</Set>

      <Exec func="PUB:CallThirdOther">  <!--通知供电方-->
        <Arg name="HTxnCd" value="460250"/>
        <Arg name="ObjSvr" value="STHDEFEA"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>MsgTyp=E</Set>
        <Set>TRspCd=99</Set>
        <Set>RtnMsg=对账交易超时</Set> 
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=$RtnMsg</Set>
        <Exec func="PUB:ExecSql" error="IGNORE">
          <Arg name="SqlCmd"   value="UpdChkRec"/>
        </Exec>
        <If condition="~RetCod=-1">
          <Exec func="PUB:RollbackWork" error="IGNORE" />
          <Set>MsgTyp=E</Set>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=数据库处理失败!</Set>
        </If>
        <Return/>
      </If>
      <If condition="$RspCod=000000">
        <Set>MsgTyp=N</Set>
      </If>
      <Else>
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=$RtnMsg</Set>
      </Else>    
      <!--供电局返回对账信息修改对账记录表-->
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd"   value="UpdChkRec"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork" error="IGNORE" />
        <Set>MsgTyp=E</Set>
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=数据库处理失败!</Set>
      </If>

    </FlowCtrl>

  </Transaction>

  <Transaction code="460251" desc="电力对公缴费记账回执打印">

		<FlowCtrl>      
      <!--If condition="INTCMP($EndDat,5,$ActDat)"> 
        <Set>RspCod=481599</Set>
        <Set>RspMsg=结束日期大于或者等于会计日期</Set>
        <Return/>
      </If-->

      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--
      <Switch  expression="$BrNo">
        <Case value="441999">
          <Set>AppNm=GZ_EFE1</Set>
          <Break/>
        </Case>
        <Case value="444999">
          <Set>AppNm=ZH_EFE1</Set>
          <Break/>
        </Case>
        <Case value="446999">
          <Set>AppNm=FS_EFE1</Set>
          <Break/>
        </Case>
        <Case value="445999">
          <Set>AppNm=ST_EFE1</Set>
          <Break/>
        </Case>
        <Case value="483999">
          <Set>AppNm=DG_EFE1</Set>
          <Break/>
        </Case>
        <Case value="484999">
          <Set>AppNm=ZS_EFE1</Set>
          <Break/>
        </Case>
        <Case value="485999">
          <Set>AppNm=JY_EFE1</Set>
          <Break/>
        </Case>
        <Case value="491999">
          <Set>AppNm=HZ_EFE1</Set>
          <Break/>
        </Case>
        <Case value="4761999">
          <Set>AppNm="JM_EFE1</Set>
          <Break/>
        </Case>
      </Switch>
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="AppNm"/>
        <Arg name="DestNam" value="CAgtNo"/>
        <Arg name="TblNam"  value="DL_AppNm"/>
      </Exec>
      -->
      <!--转换为转入账号-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="AppNm"/>
        <Arg name="DestNam" value="IActNo"/>
        <Arg name="TblNam"  value="DL_IActNo"/>
      </Exec> 
       <!--转换为转入账号名称-->
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="AppNm"/>
        <Arg name="DestNam" value="IActNm"/>
        <Arg name="TblNam"  value="DL_IActNm"/>
      </Exec>      
      
                          
      <Set>PrtId=$TlrId</Set>
      <Set>PrtDat=$ActDat</Set>
      
      <If condition="ISNULL(DELSPACE($TckNo,all))">
			  <Set>FilNam=STRCAT(电力对公缴费记账回执,$BgnDat,-,$EndDat,.rpt)</Set>
			  <Set>FmtFil=etc/EFE02_RPT.XML</Set><!--根据单位编号取得相应的清单格式名称-->
			  <Exec func="PUB:GenerateReport">
			  	<Arg name="ObjFil" value="STRCAT(dat/term/send/,$FilNam)"/>
			  	<Arg name="FmtFil" value="$FmtFil"/>
			  	<Arg name="Para1"  value="$CAgtNo"/>
			  	<Arg name="Para2"  value="$BgnDat"/>
			  	<Arg name="Para3"  value="$EndDat"/>
          <Arg name="Para4"  value="$NodNo"/>
          <Arg name="Para5"  value="$PrtId"/>
          <Arg name="Para6"  value="$PrtDat"/>
          <Arg name="Para7"  value="$IActNo"/>
          <Arg name="Para8"  value="$IActNm"/>
			  </Exec>
			  <Exec func="PUB:SendFileMessage2"><!--发出文件打印指令-->
			  	<Arg name="MsgTyp" value="4"/><!-- 消息类型，1通知2广播3文件4打印，一般传文件时用3，需要在前置打印时用4-->
			  	<Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
			  	<Arg name="BusTyp" value="46"/><!-- 业务类型-->
			  	<Arg name="AplCod" value="0251"/><!-- 应用码-->
			  	<Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
			  	<Arg name="Summary" value="电力对公缴费记账回执"/><!-- 消息内容-->
			  	<Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
			  	<Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
			  	<Arg name="SrcTlr" value="Billlp2"/><!-- 消息来源柜员-->
			  </Exec>
      </If>
      <Else>
			  <Set>FilNam=STRCAT(电力对公缴费记账回执,$BgnDat,-,$EndDat,.rpt)</Set>
			  <Set>FmtFil=etc/EFE03_RPT.XML</Set><!--根据单位编号取得相应的清单格式名称-->
			  <Exec func="PUB:GenerateReport">
			  	<Arg name="ObjFil" value="STRCAT(dat/term/send/,$FilNam)"/>
			  	<Arg name="FmtFil" value="$FmtFil"/>
			  	<Arg name="Para1"  value="$CAgtNo"/>
			  	<Arg name="Para2"  value="$BgnDat"/>
			  	<Arg name="Para3"  value="$EndDat"/>
          <Arg name="Para4"  value="$NodNo"/>
          <Arg name="Para5"  value="$PrtId"/>
          <Arg name="Para6"  value="$PrtDat"/>
          <Arg name="Para7"  value="$TckNo"/>
          <Arg name="Para8"  value="$IActNo"/>
          <Arg name="Para9"  value="$IActNm"/>
			  </Exec>
			  <Exec func="PUB:SendFileMessage2"><!--发出文件打印指令-->
			  	<Arg name="MsgTyp" value="4"/><!-- 消息类型，1通知2广播3文件4打印，一般传文件时用3，需要在前置打印时用4-->
			  	<Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
			  	<Arg name="BusTyp" value="46"/><!-- 业务类型-->
			  	<Arg name="AplCod" value="0251"/><!-- 应用码-->
			  	<Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
			  	<Arg name="Summary" value="电力对公缴费记账回执"/><!-- 消息内容-->
			  	<Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
			  	<Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
			  	<Arg name="SrcTlr" value="Billlp2"/><!-- 消息来源柜员-->
			  </Exec>
      </Else>

		</FlowCtrl>
	</Transaction>

  <Transaction code="4602XX" desc="电力财务接口文件">
    <DynSentence name="QryCrpAgr">    <!--检查单位协议 -->
      <Sentence>
         select BBusTyp,TActNo  from savcrpagr where BrNo='%s' and CAgtNo='%s' and SvrSts='1'
      </Sentence>
      <Fields>BrNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInfCtl">             <!--查询开工信息表 -->
      <Sentence>
        SELECT BrNo FROM efeinfctl
      </Sentence>
      <Fields></Fields>
    </DynSentence>
    <DynSentence name="QryBatInf">             <!--查询批扣表 -->
      <Sentence>
        SELECT  FROM efebatinf  WHERE Brno='%s' AND ActDat='%s' AND Status='0'
      </Sentence>
      <Fields>BrNo|QryDat|</Fields>
    </DynSentence>
    <!--打印格式-->
    <DynSentence name="PrtFmtHed">  <!--头记录-->
      <Sentence>
         &lt;?xml version=&apos;1.0&apos; encoding=&apos;GBK&apos;?&gt;
         &lt;BANKDATASET&gt;
      </Sentence>
      <Fields></Fields>
    </DynSentence>

    <DynSentence name="PrtFmtRec">  <!--记录内容-->
      <Sentence>
        <RECORD id='1'><YHZH>445012012620194002399</YHZH><YHDM>301</YHDM><JZSJ>2010-06-24</JZSJ><JZJE>         117.80</JZJE><WYSB>301050010062400000000000000138</WYSB><HZBZ>0</HZBZ><DFZH>445900146424000021202</DFZH><DFZHM>谢大妹</DFZHM><FZSM>电力批量代缴</FZSM><YDHH>0080012313</YDHH><YDHM></YDHM><SKRDM>012</SKRDM><SKRMC></SKRMC></RECORD>
        <RECORD id='%s'><YHZH>%s</YHZH><YHDM>301</YHDM><JZSJ>%s</JZSJ><JZJE>%s</JZJE><WYSB>%s</WYSB><HZBZ>0</HZBZ><DFZH>%s</DFZH><DFZHM>%s</DFZHM><FZSM>%s</FZSM><YDHH>%s</YDHH><YDHM>%s</YDHM><SKRDM>%s</SKRDM><SKRMC>%s</SKRMC></RECORD>
      </Sentence>
      <Fields>RecId|TActNo|ActDat|TxnAmt|WYSB|ActNo|ActNam|JFH|SKRDM|</Fields>
    </DynSentence>

    <DynSentence name="PrtFmtEnd">  <!--尾记录-->
      <Sentence>
          &lt;/BANKDATASET&gt;
      </Sentence>
      <Fields></Fields>
    </DynSentence>

    <FlowCtrl>
      <Set>RecId=1</Set>
      <Exec func="PUB:InitTransaction"/>      <!--交易初始化-->
      <Exec func="PUB:OpenCursor">
        <Arg name="SqlCmd"     value="QryInfCtl"/>
        <Arg name="CursorName" value="CurBrno"/>
      </Exec>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE">
          <Arg name="CursorName" value="CurBrno"/>
        </Exec>
        <If condition="~RetCod=100">
          <Exec func="PUB:CloseCursor">
            <Arg name="CursorName" value="CurBrno"/>
          </Exec>
          <Break/>
        </If>
        <ElseIf condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor">
            <Arg name="CursorName" value="CurBrno"/>
          </Exec>
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=数据库操作错误</Set>
          <Return/>
        </ElseIf>
         <!--取单位协议编号-->
         <!--441999广东省分行-->
         <!--444999珠海分行-->
         <!--446999佛山分行-->
         <!--445999汕头分行-->
         <!--483999东莞分行-->
         <!--484999中山分行-->
         <!--485999揭阳支行-->
         <!--491999惠州分行-->
         <!--761999江门分行-->
        <Switch  expression="$BrNo">
          <Case value="441999">
            <Set>AppNm=GZ_EFE1</Set>
            <Break/>
          </Case>
          <Case value="444999">
            <Set>AppNm=ZH_EFE1</Set>
            <Break/>
          </Case>
          <Case value="446999">
            <Set>AppNm=FS_EFE1</Set>
            <Break/>
          </Case>
          <Case value="445999">
            <Set>AppNm=ST_EFE1</Set>
            <Break/>
          </Case>
          <Case value="483999">
            <Set>AppNm=DG_EFE1</Set>
            <Break/>
          </Case>
          <Case value="484999">
            <Set>AppNm=ZS_EFE1</Set>
            <Break/>
          </Case>
          <Case value="485999">
            <Set>AppNm=JY_EFE1</Set>
            <Break/>
          </Case>
          <Case value="491999">
            <Set>AppNm=HZ_EFE1</Set>
            <Break/>
          </Case>
          <Case value="4761999">
            <Set>AppNm="JM_EFE1</Set>
            <Break/>
          </Case>
        </Switch>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="AppNm"/>
          <Arg name="DestNam" value="CAgtNo"/>
          <Arg name="TblNam"  value="DL_AppNm"/>
        </Exec>
        <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
          <Arg name="SqlCmd" value="QryCrpAgr"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=EFE999</Set>
          <Set>RspMsg=单位协议不存在</Set>
          <Return/>
        </If>
        <Set>QryDat=CALCDATE($ActDat,-,d,1)</Set>
          <!--441999广东省分行-->
          <!--444999珠海分行-->
          <!--446999佛山分行-->
          <!--445999汕头分行-->
          <!--483999东莞分行-->
          <!--484999中山分行-->
          <!--485999揭阳支行-->
          <!--491999惠州分行-->
          <!--761999江门分行-->
        <Switch  expression="$BrNo">
          <Case value="441999">
            <Set>FilNam=STRCAT(033015810,$QryDat,.xml)</Set>
            <Set>SKRDM=</Set>
            <Break/>
          </Case>
          <Case value="444999">
            <Set>FilNam=STRCAT(033015850,$QryDat,.xml)</Set>  <!--设置文件名 301交通银行代号(3位) 5850珠海地区代码（4位）03对帐文件类型(2 位 )-->
            <Set>SKRDM=</Set>
            <Break/>
          </Case>
          <Case value="446999">
            <Set>FilNam=STRCAT(033015880,$QryDat,.xml)</Set>
            <Set>SKRDM=</Set>
            <Break/>
          </Case>
          <Case value="445999">
            <Set>FilNam=STRCAT(033015860,$QryDat,.xml)</Set>
            <Set>SKRDM=</Set>
            <Break/>
          </Case>
          <Case value="483999">
            <Set>FilNam=STRCAT(033016020,$QryDat,.xml)</Set>
            <Set>SKRDM=</Set>
            <Break/>
          </Case>
          <Case value="484999">
            <Set>FilNam=STRCAT(033016030,$QryDat,.xml)</Set>
            <Set>SKRDM=</Set>
            <Break/>
          </Case>
          <Case value="485999">
            <Set>FilNam=STRCAT(03301,$QryDat,.xml)</Set>
            <Set>SKRDM=</Set>
            <Break/>
          </Case>
          <Case value="491999">
            <Set>FilNam=STRCAT(033015950,$QryDat,.xml)</Set>
            <Set>SKRDM=</Set>
            <Break/>
          </Case>
          <Case value="761999">
            <Set>FilNam=STRCAT(033015890,$QryDat,.xml)</Set>
            <Set>SKRDM=</Set>
            <Break/>
          </Case>
          <Default>
            <Set>FilNam=STRCAT(033015810,$QryDat,.xml)</Set>
            <Set>SKRDM=</Set>
          </Default>
        </Switch>
        <Exec func="PUB:WriteFile">  <!--头记录-->
          <Arg name="FileName"   value="STRCAT(dat/efe/,$FilNam)"/>
          <Arg name="OpenMode"   value="a+"/>
          <Arg name="PRNFMT"     value="PrtFmtHed"/>
        </Exec>
        <!--提取明细记录-->
        <Exec func="PUB:OpenCursor">
          <Arg name="SqlCmd"     value="QryBatInf"/>
          <Arg name="CursorName" value="CurBatInf"/>
        </Exec>
        <While>
          <Exec func="PUB:FetchCursor" error="IGNORE">
            <Arg name="CursorName" value="CurBatInf"/>
          </Exec>
          <If condition="~RetCod=100">
            <Exec func="PUB:CloseCursor">
              <Arg name="CursorName" value="CurBatInf"/>
            </Exec>
            <Break/>
          </If>
          <ElseIf condition="~RetCod=-1">
            <Exec func="PUB:CloseCursor">
              <Arg name="CursorName" value="CurBatInf"/>
            </Exec>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Return/>
          </ElseIf>
          <Switch expression="$TxnCod">
            <Case value="460222">
              <Set>FZSM="电费批量代扣"</Set>
              <Break/>
            </Case>
            <Case value="460220">
              <Set>FZSM="电费单笔代扣"</Set>
              <Break/>
            </Case>
            <Case value="460205">
              <Set>FZSM="电费单笔代收"</Set>
              <Break/>
            </Case>
          </Switch>
          <Exec func="PUB:WriteFile">  <!--明细记录-->
            <Arg name="FileName"   value="STRCAT(dat/efe/,$FilNam)"/>
            <Arg name="OpenMode"   value="a+"/>
            <Arg name="PRNFMT"     value="PrtFmtRec"/>
          </Exec>
          <Set>RecId=ADD(RecId,1)</Set>
        </While>
        <Exec func="PUB:WriteFile">  <!--尾记录-->
          <Arg name="FileName"   value="STRCAT(dat/efe/,$FilNam)"/>
          <Arg name="OpenMode"   value="a+"/>
          <Arg name="PRNFMT"     value="PrtFmtEnd"/>
        </Exec>
      </While>
        <!--441999广东省分行-->
        <!--444999珠海分行-->
        <!--446999佛山分行-->
        <!--445999汕头分行-->
        <!--483999东莞分行-->
        <!--484999中山分行-->
        <!--485999揭阳支行-->
        <!--491999惠州分行-->
        <!--761999江门分行-->
      <Switch  expression="$BrNo">
        <Case value="441999">
          <Set>EFESnd=EFE_SND_441</Set>
          <Break/>
        </Case>
        <Case value="444999">
          <Break/>
        </Case>
        <Case value="446999">
          <Break/>
        </Case>
        <Case value="445999">
          <Break/>
        </Case>
        <Case value="483999">
          <Break/>
        </Case>
        <Case value="484999">
          <Break/>
        </Case>
        <Case value="485999">
          <Break/>
        </Case>
        <Case value="491999">
          <Break/>
        </Case>
        <Case value="4761999">
          <Break/>
        </Case>
        <Case value="441999">
          <Break/>
        </Case>
        <Default>
          <Set>EFESnd=EFE_SND_441</Set>
        </Default>
      </Switch>
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="$EFESnd"/>
      </Exec>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460260" desc="广东电力电费清算报表打印">
    <DynSentence name="QryJnlInfo">            <!--查询天讯、彩票、保险成功流水信息 -->
      <Sentence>
        SELECT LogNo FROM afetxnjnl WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and HTxnSt IN ('S','T','U') order by LogNo asc
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="QryJnlInfo2">           <!--查询天讯、彩票、保险可疑流水信息 -->
      <Sentence>
        SELECT LogNo FROM afetxnjnl WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and HTxnSt='T' order by LogNo asc
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="QryJnlInfo1">            <!--查询车船税未对帐流水信息 -->
      <Sentence>
        SELECT Count(*) cnt FROM afetxnjnl WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and HTxnSt IN ('S','T','U') and HRspcd='SC0000' and TTxnst  IN ('S','T') and ChkFlg='0'
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="CCSupdatesucess">            <!--更新车船税第三方交易成功状态 -->
      <Sentence>
        UPDATE afetxnjnl SET TTxnst='S' WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and ThdChk='1'
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="CCSupdatefail">            <!--更新车船税第三方交易失败状态 -->
      <Sentence>
        UPDATE afetxnjnl SET TTxnst='F',ThdChk='1' WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and ThdChk='0'
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="CCSsum">            <!--车船税交易失败记录数 -->
      <Sentence>
        select count(*) as sumcnt from afetxnjnl WHERE BrNo='%s' AND CAgtNo='%s' AND ActDat='%s' and ThdChk='0'
      </Sentence>
      <Fields>BrNo|CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="YCTtk">
      <Sentence>
        select logno from afetxnjnl where CAgtNo='%s' AND ActDat='%s' and ChkFlg='0' and TTXNCD='482155'
      </Sentence>
      <Fields>CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="YCTtkquery">
      <Sentence>
        select ActNo,TxnAmt,TCusNm,NodTrc,THDKEY,RsFld3,ActDat,TCUSID from afetxnjnl where CAgtNo='%s' AND ActDat='%s' and logno='%s'
      </Sentence>
      <Fields>CAgtNo|TxnDat|logno|</Fields>
    </DynSentence>
    <DynSentence name="Updatquery">
      <Sentence>
        update afetxnjnl set ChkFlg='1' where CAgtNo='%s' AND ActDat='%s' and logno='%s'
      </Sentence>
      <Fields>CAgtNo|TxnDat|logno|</Fields>
    </DynSentence>
    <DynSentence name="YTKinsert"><!--粤通卡报表-->
      <Sentence>
      insert into ytk_yct (select FTxnTm,ActDat,CAgtNo,ActNo,TCUSID,LogNo,TckNo,RsFld1,RSFLD2,TxnAmt,RsFld3,ThdChk,
      case when ThdChk='S' then 'A' else 'B' end from afetxnjnl where ActDat ='%s' and CAgtNo='%s' and HTxnSt='S' and
      ThdChk IN ('G','F','D','E','Y','S') and HRspcd='SC0000')
      </Sentence>
      <Fields>TxnDat|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="YCTinsert"><!--羊城通月卡报表-->
      <Sentence>
      insert into ytk_yct (select FTxnTm,ActDat,CAgtNo,ActNo,TCUSID,LogNo,TckNo,' ',' ',TxnAmt,' ',ThdChk,
      case when ThdChk='Y' then 'A' else 'B' end from afetxnjnl where ActDat ='%s' and CAgtNo='%s' and HTxnSt='S' and
      ThdChk IN ('Y','B') and HRspcd='SC0000')
      </Sentence>
      <Fields>TxnDat|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="YTK_YCTdelete"><!--粤通卡羊城通月卡报表-->
      <Sentence>
       delete from ytk_yct where CAgtNo='%s'
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>


    <If condition="AND(IS_NOEQUAL_STRING($CAgtNo,4410000577),IS_NOEQUAL_STRING($CAgtNo,4410000960),IS_NOEQUAL_STRING($CAgtNo,4410000971))">            <!--彩票/车船税业务除外-->
      <Exec func="PUB:ReadRecord">  <!--查询 -->
        <Arg name="SqlCmd" value="QryJnlInfo"/>
      </Exec>
    </If>
     <Switch expression="~RetCod">
         <Case value="-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=STRCAT(数据库错误!,$SqlCod)</Set>
            <Return/>
         </Case>
         <Case value="0">
            <Break/>
         </Case>
       <Default>
            <Set>MsgTyp=E</Set>
            <Set>RspCod=EFE999</Set>
            <Set>RspMsg=数据不存在</Set>
            <Return/>
         </Default>
    </Switch>

      <!--
      <If condition="IS_NOEQUAL_STRING(SUBSTR($NodNo,4,3),800)">
           <Set>MsgTyp=E</Set>
           <Set>RspCod=360001</Set>
           <Set>RspMsg=本网点无权打印该报表！</Set>
           <Return/>
      </If>
      -->
    <If condition="$PrtFlg=1">

    <!--Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QryJnlInfo2"/>
    </Exec>
     <Switch expression="~RetCod">
        <Case value="0">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=360002</Set>
            <Set>RspMsg=有可疑数据,请先打印可疑报表</Set>
            <Return/>
          </Case>
          <Case value="-2">
            <Break/>
          </Case>
       <Default>
            <Break/>
         </Default>
    </Switch-->
      <!--成功报表-->
      <Set>FmtFil=etc/EFE_RPT_CFG.XML</Set>
      <Set>FilNam=STRCAT(EFE,$BrNo,$TxnDat,GETDATETIME(HHMISS))</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="BrNo"   value="$BrNo"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat" value="$TxnDat"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
    </If>
    <ElseIf condition="$PrtFlg=2">
      <!--车船税和银旅通无可疑报表-->
      <If condition="OR(IS_EQUAL_STRING($CAgtNo,4410000755),IS_EQUAL_STRING($CAgtNo,4410000960))">
          <Set>MsgTyp=E</Set>
           <Set>RspCod=EFE999</Set>
           <Set>RspMsg=无此交易</Set>
           <Return/>
      </If>
      <!--天讯可疑报表-->
      <Set>FmtFil=etc/LSHA5_RPT_441999.XML</Set>
      <Set>FilNam=STRCAT(LSHA05,$TxnDat,GETDATETIME(HHMISS))</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat" value="$TxnDat"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
    </ElseIf>
    <!--车船税失败报表-->
    <ElseIf condition="$PrtFlg=3">
      <Set>FmtFil=etc/LSHA10_RPT_441999.XML</Set>
      <Set>FilNam=STRCAT(LSHA10_,$TxnDat,GETDATETIME(HHMISS))</Set>
      <Exec func="EXT:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="CAgtNo" value="$CAgtNo"/>
        <Arg name="TxnDat" value="$TxnDat"/>
        <Arg name="PNodNo"  value="$NodNo"/>
        <Arg name="PTlrId"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:SendFileMessage">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="48"/>
        <Arg name="AplCod"  value="482150"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="$Summary"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
    </ElseIf>
    <!--退款报表-->
    <ElseIf condition="$PrtFlg=4">
      <If condition="IS_EQUAL_STRING($CAgtNo,4410001101)">       <!--粤通卡退款报表-->
        <Set>FmtFil=etc/LSHJ02_RPT_441999.XML</Set>
        <Set>FilNam=STRCAT(LSHJ02_,$TxnDat,GETDATETIME(HHMISS))</Set>
        <Exec func="EXT:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="CAgtNo" value="$CAgtNo"/>
          <Arg name="TxnDat" value="$TxnDat"/>
          <Arg name="PNodNo"  value="$NodNo"/>
          <Arg name="PTlrId"  value="$TlrId"/>
        </Exec>
        <Exec func="PUB:SendFileMessage">
          <Arg name="MsgTyp"  value="4"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="48"/>
          <Arg name="AplCod"  value="482150"/>
          <Arg name="FilNam"  value="$FilNam"/>
          <Arg name="Summary" value="$Summary"/>
          <Arg name="ObjTlr"  value="$TlrId"/>
        </Exec>
      </If>
      <ElseIf condition="IS_EQUAL_STRING($CAgtNo,4410001105)">       <!--月票卡退款报表-->
        <Set>FmtFil=etc/SPC102_RPT_441999.XML</Set>
        <Set>FilNam=STRCAT(SPC102_,$TxnDat,GETDATETIME(HHMISS))</Set>
        <Exec func="EXT:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(GETENV(WORKDIR),/dat/term/send/,$FilNam)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="CAgtNo" value="$CAgtNo"/>
          <Arg name="TxnDat" value="$TxnDat"/>
          <Arg name="PNodNo"  value="$NodNo"/>
          <Arg name="PTlrId"  value="$TlrId"/>
        </Exec>
        <Exec func="PUB:SendFileMessage">
          <Arg name="MsgTyp"  value="4"/>
          <Arg name="ObjNod"  value="$NodNo"/>
          <Arg name="BusTyp"  value="48"/>
          <Arg name="AplCod"  value="482150"/>
          <Arg name="FilNam"  value="$FilNam"/>
          <Arg name="Summary" value="$Summary"/>
          <Arg name="ObjTlr"  value="$TlrId"/>
       </Exec>
      </ElseIf>
    </ElseIf>
    <Else>
    </Else>
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
    </FlowCtrl>
  </Transaction>

  <Transaction code="460261" desc="广东电力电费清算">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="Updafetxnjnl"><!--修改信息-->
      <Sentence>
        update afetxnjnl set ChkFlg='1' WHERE ActDat ='%s' and CAgtNo='%s' and HTxnSt IN ('S','T','U') and HRspcd='SC0000' and TTxnst IN ('S','U')
      </Sentence>
      <Fields>ClrDat|CAgtNo|</Fields>
    </DynSentence>

    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=EFE999</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>

     <Exec func="PUB:AddAuthReason" >
         <Arg name="AthCod" value="40" />
         <Arg name="AthMsg" value="EFE000" />
     </Exec>
     <Exec  func="PUB:CheckLocalAuth" >
         <Arg name="ObjSvr" value="SHSTPUB1" />
     </Exec>

      <Set>HTxnCd=451900</Set>
      <Set>BusTyp=PCL76</Set>
      <Set>RgCFlg=1</Set>   <!--贷方回单，不登记0，登记 1 -->
        <!--441999广东省分行-->
        <!--444999珠海分行-->
        <!--446999佛山分行-->
        <!--445999汕头分行-->
        <!--483999东莞分行-->
        <!--484999中山分行-->
        <!--485999揭阳支行-->
        <!--491999惠州分行-->
        <!--761999江门分行-->
      <Switch  expression="$BrNo">
        <Case value="441999">
          <Set>ActBk1=441999</Set>
          <Set>ActBr1=441800</Set>
          <Break/>
        </Case>
        <Case value="444999">
        	<Set>ActBk1=444999</Set>
          <Set>ActBr1=444800</Set>
          <Break/>
        </Case>
        <Case value="446999">
          <Set>ActBk1=446999</Set>
          <Set>ActBr1=446800</Set>
          <Break/>
        </Case>
        <Case value="445999">
          <Set>ActBk1=445999</Set>
          <Set>ActBr1=445800</Set>
          <Break/>
        </Case>
        <Case value="483999">
          <Set>ActBk1=483999</Set>
          <Set>ActBr1=483800</Set>
          <Break/>
        </Case>
        <Case value="484999">
          <Set>ActBk1=484999</Set>
          <Set>ActBr1=484800</Set>          
          <Break/>
        </Case>
        <Case value="485999">
           <Set>ActBk1=485999</Set>
           <Set>ActBr1=485730</Set>  
          <Break/>
        </Case>
        <Case value="491999">
          <Set>ActBk1=491999</Set>
          <Set>ActBr1=491800</Set>  
          <Break/>
        </Case>
        <Case value="476999">
          <Set>ActBk1=476999</Set>
          <Set>ActBr1=476800</Set>  
          <Break/>
        </Case>
        <Default>
          <Set>ActBk1=441999</Set>
          <Set>ActBr1=441800</Set>
        </Default>
      </Switch>

      <Set>ActSq1=SUBSTR($TActNo,14,5)</Set>
      <Set>CdFlg1=D</Set>
      <Set>OuAmt1=$TxnAmt</Set>
      <Set>PayAt5=$STLACT</Set>
      <Set>CdFlg5=C</Set>
      <Set>InAmt5=$TxnAmt</Set>

      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>

      <Exec func="PUB:CallHostOther">
        <Arg name="HTxnCd" value="$HTxnCd"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
      </Exec>

    <!--
        <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>
      -->

      <If condition="~RetCod=0">  <!--recsts 0:初始化 1:成功 2:失败 -->
        <Exec func="PUB:ExecSql">
           <Arg name="SqlCmd" value="Updafetxnjnl"/>
        </Exec>
      </If>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460262" desc="广东电力电费对可疑交易进行状态修改">
    <DynSentence name="Updafetxnjnl"><!--修改信息-->
      <Sentence>
        update afetxnjnl set HTxnSt='%s' WHERE ActDat ='%s' and CAgtNo='%s' and HTxnSt IN ('T','U') and TckNo='%s'
      </Sentence>
      <Fields>HTxnSt|TxnDat|CAgtNo|TckNo|</Fields>
    </DynSentence>
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <!--取单位协议编号-->
      <!--441999广东省分行-->
      <!--444999珠海分行-->
      <!--446999佛山分行-->
      <!--445999汕头分行-->
      <!--483999东莞分行-->
      <!--484999中山分行-->
      <!--485999揭阳支行-->
      <!--491999惠州分行-->
      <!--761999江门分行-->
     <Switch  expression="$BrNo">
       <Case value="441999">
         <Set>AppNm=GZ_EFE1</Set>
         <Break/>
       </Case>
       <Case value="444999">
         <Set>AppNm=ZH_EFE1</Set>
         <Break/>
       </Case>
       <Case value="446999">
         <Set>AppNm=FS_EFE1</Set>
         <Break/>
       </Case>
       <Case value="445999">
         <Set>AppNm=ST_EFE1</Set>
         <Break/>
       </Case>
       <Case value="483999">
         <Set>AppNm=DG_EFE1</Set>
         <Break/>
       </Case>
       <Case value="484999">
         <Set>AppNm=ZS_EFE1</Set>
         <Break/>
       </Case>
       <Case value="485999">
         <Set>AppNm=JY_EFE1</Set>
         <Break/>
       </Case>
       <Case value="491999">
         <Set>AppNm=HZ_EFE1</Set>
         <Break/>
       </Case>
       <Case value="4761999">
         <Set>AppNm="JM_EFE1</Set>
         <Break/>
       </Case>
     </Switch>
     <Exec func="PUB:CodeSwitching">
       <Arg name="DatSrc"  value="OPFCSW"/>
       <Arg name="SourNam" value="AppNm"/>
       <Arg name="DestNam" value="CAgtNo"/>
       <Arg name="TblNam"  value="DL_AppNm"/>
     </Exec>
     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=EFE999</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>
    <!--
    <Exec func="PUB:AddAuthReason" >
            <Arg name="AthCod" value="50" />
            <Arg name="AthMsg" value="482152" />
    </Exec>
    <Exec  func="PUB:CheckLocalAuth" >
            <Arg name="ObjSvr" value="SHSTPUB1" />
    </Exec>
    -->
    <If condition="$HTxnSt=S">
        <Set>HtNam=成功</Set>
    </If>
    <Else>
       <Set>HtNam=失败</Set>
    </Else>

    <Exec func="PUB:ExecSql">
            <Arg name="SqlCmd" value="Updafetxnjnl"/>
    </Exec>


    </FlowCtrl>
  </Transaction>

  <Transaction code="460263" desc="广东电力电费对可疑交易进行状态查询">
    <DynSentence name="QryCrpAgr"><!--查询信息-->
      <Sentence>
        select ActNo,TCUSNM,TCUSID,TxnAmt from afetxnjnl WHERE ActDat ='%s' and CAgtNo='%s'  and TckNo='%s' and HTxnSt IN ('T','U') and ChkFlg='0'
      </Sentence>
      <Fields>TxnDat|CAgtNo|TckNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

      <!--取单位协议编号-->
      <!--441999广东省分行-->
      <!--444999珠海分行-->
      <!--446999佛山分行-->
      <!--445999汕头分行-->
      <!--483999东莞分行-->
      <!--484999中山分行-->
      <!--485999揭阳支行-->
      <!--491999惠州分行-->
      <!--761999江门分行-->
     <Switch  expression="$BrNo">
       <Case value="441999">
         <Set>AppNm=GZ_EFE1</Set>
         <Break/>
       </Case>
       <Case value="444999">
         <Set>AppNm=ZH_EFE1</Set>
         <Break/>
       </Case>
       <Case value="446999">
         <Set>AppNm=FS_EFE1</Set>
         <Break/>
       </Case>
       <Case value="445999">
         <Set>AppNm=ST_EFE1</Set>
         <Break/>
       </Case>
       <Case value="483999">
         <Set>AppNm=DG_EFE1</Set>
         <Break/>
       </Case>
       <Case value="484999">
         <Set>AppNm=ZS_EFE1</Set>
         <Break/>
       </Case>
       <Case value="485999">
         <Set>AppNm=JY_EFE1</Set>
         <Break/>
       </Case>
       <Case value="491999">
         <Set>AppNm=HZ_EFE1</Set>
         <Break/>
       </Case>
       <Case value="4761999">
         <Set>AppNm="JM_EFE1</Set>
         <Break/>
       </Case>
     </Switch>
     <Exec func="PUB:CodeSwitching">
       <Arg name="DatSrc"  value="OPFCSW"/>
       <Arg name="SourNam" value="AppNm"/>
       <Arg name="DestNam" value="CAgtNo"/>
       <Arg name="TblNam"  value="DL_AppNm"/>
     </Exec>
     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=EFE999</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>
    <Exec func="PUB:InitTransaction"/>            <!--交易初始化,预留-->
    <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryCrpAgr"/>
    </Exec>

    </FlowCtrl>
  </Transaction>

  <Transaction code="460264" desc="广东省电力电费查询清算金额">
    <DynSentence name="QryCrpAgr"><!--查询单位信息 -->
      <Sentence>
        SELECT a.TActNo,b.CrpNam,b.STLACT FROM savcrpagr a,savcrpinf b WHERE a.CAgtNo='%s'
        AND a.CrpCod=b.CrpCod AND a.BrNo=b.BrNo
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryEfeTot">
      <Sentence>
        select sum(cast(TxnAmt as bigint)) as SumAmt,coalesce(COUNT(*),0) TotCnt from afetxnjnl where ActDat = '%s' and CAgtNo= '%s' and HTxnSt IN ('S','T','U') and HRspcd='SC0000' and  TTxnst IN ('S','U') and ChkFlg='0'
      </Sentence>
      <Fields>TxnDat|CAgtNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>
      <!--取前置流水号-->
      <Exec func="PUB:GetLogNo"/>
      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>

     <Exec func="PUB:ReadRecord">    <!--检查单位协议 -->
       <Arg name="SqlCmd" value="QryCrpAgr"/>
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=EFE999</Set>
       <Set>RspMsg=单位协议不存在</Set>
       <Return/>
     </If>

     <Exec func="PUB:ReadRecord">     <!--广东电力电费业务清算-->
       <Arg name="SqlCmd" value="QryEfeTot"/>
     </Exec>
     <If condition="$TotCnt=0">
         <Set>MsgTyp=E</Set>
         <Set>RspCod=EFE999</Set>
         <Set>RspMsg=没有清算数据</Set>
         <Return/>
     </If>
    </FlowCtrl>
  </Transaction>


  <Transaction code="460265" desc="对账信息查询">
    <DynSentence name="QryChkRec">
      <Sentence>
        select SndTim,LogNo,ChkFil,TRspCd,RtnMsg from efechkrec where BrNo='%s' and ActDat &gt;='%s' and ActDat &lt;='%s'
      </Sentence>
      <Fields>BrNo|BgnDat|EndDat|</Fields>
    </DynSentence>
    <FlowCtrl>
      <!--根据柜员号取BrNo-->
      <Exec func="PUB:GetBranchNoByTeller"/>
      <!--交易初始化,预留-->
      <Exec func="PUB:InitTransaction"/>

      <!--默认交易返回成功-->
      <Set>RspCod=000000</Set>
      <Set>RspMsg=交易成功</Set>

			<Exec func="PUB:MultiQuery" >
				<Arg name="SqlCmd" value="QryChkRec" />
			</Exec>
      <If condition="~RetCod=-1">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=查询失败</Set>
        <Return/>
      </If>
       <If condition="~RetCod=-2">
        <Set>RspCod=EFE999</Set>
        <Set>RspMsg=没有该查询流水号</Set>
        <Return/>
      </If>      
    </FlowCtrl>
  </Transaction>

</Application>


