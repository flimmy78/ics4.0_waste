<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="TRF" code="415">
  <ConfigDeclare>
    <Config name="ParaFile"    value="etc/CFG_TRF_441999.XML"/>
    <Config name="BatFormat"   value="etc/TRF_FMT_441999.XML"/>
    <Config name="TRFCSW"       value="etc/TRF_CSW_441999.XML"/>
  </ConfigDeclare>
  <PackageDeclare>
    <Package name="AFE"      value="etc/DAFE_PKG.XML"/>
  </PackageDeclare>
  <TableDeclare>
    <Table name="afetxnjnl"   value="afetxnjnl"/>  <!--代收费公共流水表-->
    <Table name="trfinvrec441"   value="trfinvrec441"/>  <!--电信发票信息表-->
    <Table name="trfinvtmp441"   value="trfinvtmp441"/>  <!--电信发票信息临时表-->
    <Table name="TrfInvCtl441"   value="TrfInvCtl441"/>  <!--电信发票信息表-->
    <Table name="ActNoInf441"    value="ActNoInf441"/>  
    <Table name="trftxnjnl441"   value="trftxnjnl441"/>  <!--流水扩展表-->
    <Table name="trfagrtbl441"   value="trfagrtbl441"/>  <!--电信签约表-->
  </TableDeclare>
  <BusDefDeclare>
    <Busdef name="CAgtNo"   value="4410001421"/>  <!--联机电信单位编号-->
    <Busdef name="CAgtNoA"  value="441000XXXX"/> <!--批量电信单位编号-->
    <Busdef name="BrNo"     value="441999"/> <!--批量电信单位编号-->
    <Busdef name="AplCls"   value="415"/>    <!--Added by xuan_20100202-->
  </BusDefDeclare>

  <GlobalFunction>
    <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
    <!--Added by xuan_20100202-->
    <Function name="_after">
        <Process>
           <If condition="ISNULL($MsgTyp)">
              <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
                 <Set>MsgTyp=N</Set>
                 <Set>RspCod=000000</Set>
              </If>
              <Else>
                 <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
                    <Set>MsgTyp=E</Set>
                 </If>
                 <Else>
                    <Set>MsgTyp=N</Set>
                 </Else>
              </Else>
           </If>
        </Process>
    </Function>
  </GlobalFunction>

  <Define>
    <Macro name="SetRetMsg"><!--第三方返回码信息转换宏-->
      <If condition="ISNULL($TRspCd)">
        <Return/>
      </If>
      <Else>
        <If condition="$TRspCd=00">
          <Set>MsgTyp=N</Set>
        </If>
        <Else>
          <Exec func="PUB:CodeSwitching" error="IGNORE">
            <Arg name="DatSrc"  value="TRFCSW"/>
            <Arg name="SourNam" value="TRspCd"/>
            <Arg name="DestNam" value="RspMsg"/>
            <Arg name="TblNam"  value="TRspCd2RspMsg"/>
          </Exec>
          <Set>RspMsg=STRCAT($TRspCd,:,$RspMsg)</Set>
          <Set>TRspCd=481599</Set>
          <Set>RspCod=481599</Set>
        </Else>
      </Else>
    </Macro>
    <Macro name="SetBkMsg"><!--银行返回码信息转换宏-->
      <If condition="ISNULL($RspCod)">
        <Return/>
      </If>
      <Else>
        <If condition="$RspCod=000000">
          <Set>SucFlg=Y</Set>
        </If>
        <Else>
          <Set>SucFlg=N</Set>
          <Exec func="PUB:CodeSwitching" error="IGNORE">
            <Arg name="DatSrc"  value="TRFCSW"/>
            <Arg name="SourNam" value="RspCod"/>
            <Arg name="DestNam" value="TRspCd"/>
            <Arg name="TblNam"  value="HRspCd2TRspCd"/>
          </Exec>
        </Else>
      </Else>
    </Macro>
  </Define>
  <GlobalFunction>
    <Include file="etc/ActJudge_IIT.XML"/>  <!--区别对公对私帐号-->
  </GlobalFunction>

  <Transaction code="481500" desc="电信代收费查询">
    <FlowCtrl>

<!--限定测试的电话号码-->
<!--
      <Set>test_TCusId=2322338</Set> 
      <If condition="INTCMP($TCusId,4,$test_TCusId)">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=系统正在升级中</Set>
        <Return/>
      </If>
-->

      <Set>SeqCnd=SUBSTR($BrNo,1,3)</Set>
      <Exec func="PUB:GetPubSeqNo" error="IGNORE">
        <Arg name="SeqNam" value="OFTATRFA:afetxnjnl"></Arg>
        <Arg name="SeqCnd" value="$SeqCnd"></Arg>
        <Arg name="Len" value="8"></Arg>
      </Exec>
      <Set>TLogNo=STRCAT(07,$SelVal,RIGHTSTR($ActDat,6))</Set>
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="00001"/>
        <Arg name="ObjSvr" value="STDATRFA"/>
      </Exec>
      <Quote name="SetRetMsg"/>

    </FlowCtrl>
  </Transaction>

  <Transaction code="481501" desc="电信代收费">
    <Attributes>
      <Attribute name="integrity" value="2" code="481502" interval="5" timeout="30" maxtimes="15"/> <!--自动冲正-->
    </Attributes>
    <DynSentence name="QryCrpAgr"><!--查询单位协议 -->
      <Sentence>
        SELECT TActNo, BBusTyp FROM savcrpagr WHERE CAgtNo='%s' AND SvrSts='1'
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <!--以下add for 总行版自助通 扣款成功处理发票-->
    <DynSentence name="InsFp">
      <Sentence>
          insert into  trfinvrec441
          values('%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s','%s')
      </Sentence>
      <Fields>TrType|RecCnt|ThdKey|ActNo|TCusId|FCusId|TrDate|TCusNm|IPrnCnt|BillDate|TxnAmt|LastBal|ThisBal|IPayAmt|ITotAmt|EInvNo|StaMon|EndMon|tmp01|tmp02|MxCount|FpInf|</Fields>
    </DynSentence>
    <DynSentence name="DelDtlfp">
      <Sentence>
          DELETE
          FROM tyfinvrec441
          WHERE TCusId='%s'
      </Sentence>
      <Fields>TCusId|</Fields>
    </DynSentence>
    <DynSentence name="QueJnlInf">
      <Sentence>
          select count(*) jls
          FROM tyfinvrec441
          WHERE TCusId='%s'
      </Sentence>
      <Fields>TCusId|</Fields>
    </DynSentence>
    <!--以上 add for 总行版自助通 扣款成功处理发票-->

    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <Set>TxnAmt=FDIV($TxnAmt,100,2))</Set>      <!--add for 总行版自助通-->

<!--限定测试的电话号码-->
<!--
      <Set>test_TCusId=2322338</Set> 
      <If condition="INTCMP($TCusId,4,$test_TCusId)">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=系统正在升级中</Set>
        <Return/>
      </If>
-->

      <!--查询协议-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QryCrpAgr"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=478399</Set>
        <Set>RspMsg=无该单位协议或数据库错</Set>
        <Return/>
      </If>

      <!--查询-->
      <Set>OTxnAmt=$TxnAmt</Set>
      <Set>SeqCnd=SUBSTR($BrNo,1,3)</Set>
      <Exec func="PUB:GetPubSeqNo" error="IGNORE">
        <Arg name="SeqNam" value="OFTATRFA:afetxnjnl"></Arg>
        <Arg name="SeqCnd" value="$SeqCnd"></Arg>
        <Arg name="Len" value="8"></Arg>
      </Exec>
      <Set>TLogNo=STRCAT(07,$SelVal,RIGHTSTR($ActDat,6))</Set>
      <Set>PhoneNo=$TCusId</Set>   <!--add for 总行版自助通 解决电信缴网费返回上网账号的问题-->
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="00001"/>
        <Arg name="ObjSvr" value="STDATRFA"/>
      </Exec>
      <Set>TCusId =$PhoneNo</Set>   <!--解决电信返回上网账号覆盖电话号码的问题-->
      <!--Set>ThdKey=0000</Set-->  <!--测试用-->
      <If condition="INTCMP($TRspCd,4,0)">
        <Set>RspCod=481599</Set>
        <Quote name="SetRetMsg"/>
        <Return/>
      </If>
      <If condition="INTCMP($TxnAmt,4,$OTxnAmt)">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=缴费金额和欠费金额不符</Set>
        <Return/>
      </If>
      <Delete>TRspCd</Delete>
      
      <!--以下add for 总行版自助通 扣款成功处理发票-->
      <If condition="$RspCod=000000">
          <Set>MsgTyp=N</Set>
          <Set>RspCod=000000</Set>
          <Set>FpCount=$FpCount</Set>
          <!--发票数为零不处理发票-->
          <If condition="$FpCount=0">
          </If>
          <!--发票数大于零进行处理-->
          <ElseIf>
              <Exec func="PUB:ReadRecord">
                  <Arg name="SqlCmd" value="QueJnlInf"/>
              </Exec>
              <If condition="$jls=0">  <!--没有记录-->
              </If>
              <!--清空ICS上以前的发票记录-->
              <ElseIf> 
                  <Exec func="PUB:ExecSql" error="IGNORE">
                      <Arg name="SqlCmd" value="DelDtlfp"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                      <Set>RspCod=481599</Set>
                      <Set>RspMsg=数据库错误</Set>
                      <Return/>
                  </If>
              </ElseIf>
              
              <!--取ETF ROOT上的值-->
              <Set>TrType   =$TrType  </Set>
              <Set>ThdKey   =$ThdKey  </Set>
              <Set>ActNo    =$ActNo   </Set>
              <Set>TCusId   =$TCusId  </Set>
              <Set>FCusId   =$FCusId  </Set>
              <Set>TrDate   =$ActDat  </Set>
              <Set>TCusNm   =$TCusNm  </Set>
              <Set>IPrnCnt  =$IPrnCnt </Set>
              <Set>TxnAmt   =$TxnAmt  </Set>
              <Set>FpRecCnt=1</Set>
              <!--循环取出每张发票-->
              <While condition="INTCMP($FpRecCnt,2,$FpCount)">
                  <Exec func="PUB:GetValue">
                      <Arg name="SourName"  value="STRCAT(ROOT.FpRec_,$FpRecCnt,.nBillDate)"/>
                      <Arg name="DestName"  value="ROOT.RBillDate"/>
                  </Exec>
                  <Exec func="PUB:GetValue">
                      <Arg name="SourName"  value="STRCAT(ROOT.FpRec_,$FpRecCnt,.nLastBal)"/>
                      <Arg name="DestName"  value="ROOT.RLastBal"/>
                  </Exec>
                  <Exec func="PUB:GetValue">
                      <Arg name="SourName"  value="STRCAT(ROOT.FpRec_,$FpRecCnt,.nThisBal)"/>
                      <Arg name="DestName"  value="ROOT.RThisBal"/>
                  </Exec>
                  <Exec func="PUB:GetValue">
                      <Arg name="SourName"  value="STRCAT(ROOT.FpRec_,$FpRecCnt,.nIPayAmt)"/>
                      <Arg name="DestName"  value="ROOT.RIPayAmt"/>
                  </Exec>
                  <Exec func="PUB:GetValue">
                      <Arg name="SourName"  value="STRCAT(ROOT.FpRec_,$FpRecCnt,.nStaMon)"/>
                      <Arg name="DestName"  value="ROOT.RStaMon"/>
                  </Exec>
                  <Exec func="PUB:GetValue">
                      <Arg name="SourName"  value="STRCAT(ROOT.FpRec_,$FpRecCnt,.nEndMon)"/>
                      <Arg name="DestName"  value="ROOT.REndMon"/>
                  </Exec>
                  <Exec func="PUB:GetValue">
                      <Arg name="SourName"  value="STRCAT(ROOT.FpRec_,$FpRecCnt,.nMxCount)"/>
                      <Arg name="DestName"  value="ROOT.RMxCount"/>
                  </Exec>
                  <Exec func="PUB:GetValue">
                      <Arg name="SourName"  value="STRCAT(ROOT.FpRec_,$FpRecCnt,.nFpInf)"/>
                      <Arg name="DestName"  value="ROOT.RFpInf"/>
                  </Exec>
                  <Set>RecCnt   =$FpRecCnt  </Set>
                  <Set>BillDate =$RBillDate </Set>
                  <Set>LastBal  =$RLastBal  </Set>
                  <Set>ThisBal  =$RThisBal  </Set>
                  <Set>IPayAmt  =$RIPayAmt  </Set>
                  <Set>ITotAmt  =$RITotAmt  </Set>
                  <Set>EInvNo   =0          </Set>
                  <Set>StaMon   =$RStaMon   </Set>
                  <Set>EndMon   =$REndMon   </Set>
                  <Set>tmp01    =0          </Set>
                  <Set>tmp02    =0          </Set>
                  <Set>MxCount  =$RMxCount  </Set>
                  <Set>FpInf    =$RFpInf    </Set>

                  <!--将该张发票信息插入ICS发票信息表-->
                  <Exec func="PUB:ExecSql" error="IGNORE">
                      <Arg name="SqlCmd" value="InsFp"/>
                  </Exec>
                  <If condition="~RetCod=-1">
                      <Set>RspCod=481599</Set>
                      <Set>RspMsg=数据库错误</Set>
                      <Return/>
                  </If>
                  <Set>FpRecCnt=ADD($FpRecCnt,1)</Set>
              </While>
 
          </ElseIf>
      </If>
      <!--以上add for 总行版自助通 扣款成功处理发票-->

      <!--获取销帐信息及保存-->
      <Set>RecCnt=1</Set>
      <Set>CclInf=STR2HEX($PayNum)</Set>
      <While condition="INTCMP($RecCnt,2,$PayNum)">
        <!--屏蔽 for 总行版自助通 start-->
        <!--Exec func="PUB:GetValue">
          <Arg name="SourName"  value="STRCAT(ROOT.REC,$RecCnt,.PaySqn)"/>
          <Arg name="DestName"  value="ROOT.PaySqn"/>
        </Exec>
        <Exec func="PUB:GetValue">
          <Arg name="SourName"  value="STRCAT(ROOT.REC,$RecCnt,.PMsgHead)"/>
          <Arg name="DestName"  value="ROOT.PMsgHead"/>
        </Exec-->
        <!--屏蔽 for 总行版自助通 end-->
        <Set>PaySqn=$PaySqn</Set>
        <Set>PMsgHead=$PMsgHead</Set>
        <Set>CclInf=STRCAT($CclInf,7C,$PaySqn,7c,$PMsgHead)</Set>
        <Set>RecCnt=ADD($RecCnt,1)</Set>
      </While>
      <Set>AA=$CclInf</Set>  <!--将销帐信息保存在AA里-->
      <Delete>TTxnSt</Delete>

      <Set>SeqCnd=SUBSTR($BrNo,1,3)</Set>
      <Exec func="PUB:GetPubSeqNo" error="IGNORE">
        <Arg name="SeqNam" value="OFTATRFA:afetxnjnl"/>
        <Arg name="SeqCnd" value="$SeqCnd"/>
        <Arg name="Len" value="8"/>
      </Exec>
      <Set>TLogNo=STRCAT(07,$SelVal,RIGHTSTR($ActDat,6))</Set>
      <Set>MsgTim=GETDATETIME()</Set>

      <Set>TxnAmt=FMUL($TxnAmt,100,0))</Set>      <!--add for 总行版自助通-->

      <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
        <Set>HTxnCd=471140</Set>
        <Set>PayMod=1</Set>
        <Set>ActFlg=$ActTyp</Set>
        <Set>TxnTyp=N</Set>
        <Set>VchChk=1</Set><!--监督标志由业务上确定-->
      </If>
      <ElseIf condition="INTCMP($ActTyp,3,1)"><!--对公-->
        <Set>HTxnCd=451610</Set>
        <Set>ActNod=SUBSTR($TActNo,1,6)</Set>
        <Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
        <Delete>TActNo</Delete>
        <Set>BusTyp=CRP51</Set>
        <Set>BusSub=01</Set>   <!--应用子码，对应业务类型CRP51-->
        <Set>ActFlg=2</Set>
      </ElseIf>
      <Else>    <!--第三方-->
        <Set>RspCod=478399</Set>
        <Set>RspMsg=账号类型输入有误</Set>
        <Return/>
      </Else>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="TRF"/><!--可以使用单位编号-->
        <Arg name="Transaction" value="$TxnCod"/><!--可以用交易码或者模块名-->
      </Exec>
      <Call package="AFE" function="AFE_SglBkPay"/>
      <Quote name="SetRetMsg"/>

      <Set>TxnAmt=FDIV($TxnAmt,100,2))</Set>      <!--add for 总行版自助通-->

    </FlowCtrl>
  </Transaction>

  <Transaction code="481502" desc="电信代收费抹账（冲正）">
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
        <Set>HTxnCd=471149</Set>
      </If>
      <ElseIf condition="INTCMP($ActTyp,3,1)"><!--对公-->
        <Set>HTxnCd=451619</Set>
      </ElseIf>

      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="TRF"/><!--可以使用单位编号-->
        <Arg name="Transaction" value="$TxnCod"/><!--可以用交易码或者模块名-->
      </Exec>
      <Call package="AFE" function="AFE_BkCancel"/>
      <Set>RspCod=$RspCod</Set>
      <!--Quote name="SetRetMsg"/-->
    </FlowCtrl>
  </Transaction>

  <Transaction code="481503" desc="电信划款">
    <DynSentence name="QryCrpAgr"><!--查询单位协议 -->
      <Sentence>
        SELECT TActNo, BBusTyp, CrpCod FROM savcrpagr WHERE CAgtNo='%s' AND SvrSts='1'
      </Sentence>
      <Fields>CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryCrpInf"><!--查询单位信息 -->
      <Sentence>
        SELECT CrpNam, StlAct FROM savcrpinf WHERE BrNo='%s' AND CrpCod='%s'
      </Sentence>
      <Fields>BrNo|CrpCod|</Fields>
    </DynSentence>
    <DynSentence name="QryAgrNum"><!-- 检查零余额账户-->
       <Sentence>
          SELECT COUNT(*) ZeroNum FROM pfacusagr WHERE　ActNo='%s' AND BusCnl='CBS' AND SUBSTR(AgrNo,7,9)='748017099'
       </Sentence>
       <Fields>ActNo</Fields>
    </DynSentence>
    <DynSentence name="QryPfaAgr"><!-- 查询零余额对应协议号-->
       <Sentence>
          SELECT distinct BCusId,AgrNo,PfaSub,SubCod FROM pfacusagr WHERE　ActNo='%s' AND BusCnl='CBS' AND SUBSTR(AgrNo,7,9)='748017099'
       </Sentence>
       <Fields>ActNo</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="integrity" value="2" code="481508" interval="5" timeout="30" maxtimes="15"/> <!--自动冲正-->
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>      <!--交易初始化-->

      <Set>RspCod=000000</Set>  <!-- 默认交易返回成功 -->
      
      <!--查询协议-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QryCrpAgr"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=478399</Set>
        <Set>RspMsg=无该单位协议或数据库错</Set>
        <Return/>
      </If>

      <!-- add by xuan 保存对账用信息 -->
      <Set>CclInf=STR2HEX($ParaTyp)</Set>                        <!--电信参数类型-->
      <Set>CclInf=STRCAT($CclInf,7C,STR2HEX($Rmk))</Set>         <!--备注-->
      <Set>CclInf=STRCAT($CclInf,7C,STR2HEX($HKmsg))</Set>       <!--划款信息头-->
      <Set>CclInf=STRCAT($CclInf,7C,STR2HEX($FulChk))</Set>      <!--部分扣款标志-->
      <Set>CclInf=STRCAT($CclInf,7C,STR2HEX($PLAmt))</Set>       <!--部分扣费最低限额-->
      <Set>CclInf=STRCAT($CclInf,7C,STR2HEX($BEAmt))</Set>       <!--余额充足最低限额-->
      
      <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
      <Call function="$AcJudFunc">
        <Input name="ActNo|NewFlg|"/>
        <Output name="OActNo|ActCls|"/>
      </Call>
      
      <Switch expression="$ActCls">
        <Case value="2" /> <!-- 对私 -->
        <Case value="3" />
        <Case value="5" >
         <If condition="INTCMP($ActCls,3,3)">
             <Set>ActFlg=4</Set>  <!--对私卡号-->
             <Set>ActTyp=4</Set>
          </If>
          <Else>
             <Set>ActFlg=2</Set>  <!--对私帐号-->
             <Set>ActTyp=2</Set>
          </Else>
          <Break/>
        </Case>   
        <Case value="0" /> <!-- 对公 -->
        <Case value="4" >
          <Set>ActTyp=1</Set>
          <Break/>
        </Case>
        <Default>
            <Set>RspCod=TRF001</Set>
            <Set>RspMsg=帐户类型不存在</Set>
            <Quote name="SetBkMsg"/>
            <Set>MsgBodyFlg=0</Set>
            <Return/>
        </Default>
      </Switch>
      
      <If condition="OR(INTCMP($ActTyp,3,0),INTCMP($ActTyp,3,2),INTCMP($ActTyp,3,4))"><!--对私-->
        <Set>HTxnCd=471140</Set>
        <Set>PayMod=1</Set>
        <Set>ActFlg=$ActTyp</Set>
        <!--第三方接口使用该字段，所以不给值
        <Set>TxnTyp=N</Set>
        -->
        <Set>VchChk=1</Set><!--监督标志由业务上确定-->
        <!--20100423-->
        <Set>BusTyp=TRFA3</Set>    
        <!--2010423-->
      </If>
      <ElseIf condition="INTCMP($ActTyp,3,1)"><!--对公-->
        <Set>HTxnCd=451610</Set>
        <Set>ActNod=SUBSTR($TActNo,1,6)</Set>
        <Set>ActSqn=SUBSTR($TActNo,14,5)</Set>
        <Delete>TActNo</Delete>
        <!--
        <Set>BusTyp=CRP51</Set>
        -->
        <Set>BusTyp=CRP53</Set>
        <Set>BusSub=01</Set>   <!--应用子码，对应业务类型CRP51-->
        <Set>ActFlg=2</Set>
      </ElseIf>
      <Else>    <!--第三方-->
        <Set>RspCod=TRF001</Set>
        <Set>RspMsg=账号类型输入有误</Set>
        <Quote name="SetBkMsg"/>
        <Set>MsgBodyFlg=0</Set>
        <Return/>
      </Else> 
      
      <Exec func="PUB:ReadModuleCfg">
        <Arg name="Application" value="TRF"/><!--可以使用单位编号-->
        <Arg name="Transaction" value="$TxnCod"/><!--可以用交易码或者模块名-->
      </Exec>
            
      <!--Set>ActFlg=$TxnMod</Set-->
      <!--
      <If condition="IS_EQUAL_INT($ActFlg,0)">
        <Set>PayMod=0</Set>
      </If>
      <Else>
        <Set>PayMod=1</Set>
      </Else>
      -->
      <Set>PayMod=0</Set>
      <Set>CnlTyp=L</Set><!--交易渠道类型：L第三方系统-->
      <Set>VchChk=1</Set><!--监督标志由业务上确定-->
      <Set>VchCod=00000000</Set> 
      <Set>AplCls=415</Set>
      <Set>MstChk=1</Set>  <!--20100511-->
      <Set>FRspCd= </Set>  <!--20100511-->
      <Set>ItgTyp=0</Set>  <!--20100511-->
      <Set>TXNTYP=N</Set>  <!--20100511-->
      <!--20100423
      <Set>BusTyp=TRFA3</Set>
      -->    

      <!--检查零余额账户-->
      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QryAgrNum"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=478399</Set>
        <Set>RspMsg=查询零余额账号数据库错</Set>
        <Return/>
      </If>
      <If condition="INTCMP($ZeroNum,6,0)">   <!--记录条数大于零-->
        <!--零余额账户处理开始-->
        <Exec func="PUB:ReadRecord" error="IGNORE">
          <Arg name="SqlCmd" value="QryCrpInf"/>
        </Exec>
        <If condition="~RetCod!=0">
          <Set>RspCod=478399</Set>
          <Set>RspMsg=查询入帐单位信息数据库错</Set>
          <Return/>
        </If>
			  <Exec func="PUB:OpenCursor"><!--打开游标-->
			  	<Arg name="SqlCurFmp" value="QryPfaAgr"></Arg>
			  	<Arg name="CursorName" value="CUR_TRFA"/>
			  </Exec>					
			  <If condition="~RetCod!=0">
			  	<Set>MsgTyp=E</Set>
			  	<Set>RspCod=TRF999</Set>
			  	<Set>RspMsg=打开游标错QryPfaAgr!</Set>
			  	<Return/>
			  </If>
				<While>
					<Exec func="PUB:FetchCursor" error="IGNORE">	<!--取下一笔记录-->
					  <Arg name="CursorName" value="CUR_TRFA"/>
					</Exec>
					<If condition="~RetCod=100">
						<Exec func="PUB:CloseCursor">	<!--关闭游标-->
						  <Arg name="CursorName" value="CUR_TRFA"/>
						</Exec>
            <Quote name="SetBkMsg"/>
            <Set>MsgBodyFlg=0</Set>
						<Return/>
					</If>
					<If condition="~RetCod!=0">
						<Exec func="PUB:CloseCursor">	<!--关闭游标-->
						  <Arg name="CursorName" value="CUR_TRFA"/>
						</Exec>
            <Quote name="SetBkMsg"/>
            <Set>MsgBodyFlg=0</Set>
						<Return/>
					</If>
          <Switch expression="$PfaSub">
            <Case value="001" > <!--省财政支付-->
            	<Set>PfaSub=$PfaSub</Set>       <!--财政应用编码-->
            	<Set>BCusId=$BCusId</Set>       <!--基层预算单位编码-->
            	<Set>PayAct=$ActNo</Set>        <!--付款人帐号-->
            	<Set>PayNam=$TCusNm</Set>       <!--付款名称单位-->
            	<Set>PayBNm=交通银行</Set>      <!--开户银行-->
            	<Set>PyeAct=$StlAct</Set>       <!--收款人帐号-->
              <Set>PyeNam=$CrpNam</Set>       <!--收款人名称-->
              <Set>PyeBNm=交通银行</Set>      <!--收款银行-->
              <Set>VchDat=$ActDat</Set>       <!--签发日期-->
              <Set>TOIFlg=O</Set>             <!--交易方向-->
              <Set>AgrNo=$AgrNo</Set>         <!--协议编码-->
              <Set>VchSmr=电信扣费</Set>      <!--摘要-->
              <Set>ActSqn=$ActSqn</Set>       <!--入帐帐号顺序号-->
              <Set>ActNod=$ActNod</Set>       <!--入帐网点-->
              <Set>TxnAmt=$TxnAmt</Set>       <!--金额-->
              <Set>NodNo=$ActNod</Set>        <!--凭证登记部门-->
              <Set>HSubCd=001</Set>           <!--借零余额户贷26201-->
              <Set>TTXnCd=461181</Set>
              <Set>THD_TRNCOD=461181</Set>
              <Set>THD_SVROBJ=STHDPFA3</Set>
      	      <!--省零余额记账-->
      	      <Call package="AFE" function="AFE_SglPrvZeroPay"/>      
              <Break/>
            </Case>
            <Case value="102" > <!--海珠区财政0余额-->
            	<Set>PfaSub=$PfaSub</Set>       <!--财政应用编码-->
            	<Set>BCusId=$BCusId</Set>       <!--基层预算单位编码-->
            	<Set>PayAct=$ActNo</Set>        <!--付款人帐号-->
            	<Set>PayNam=$TCusNm</Set>       <!--付款名称单位-->
            	<Set>PayBNm=交通银行</Set>      <!--开户银行-->
            	<Set>PyeAct=$StlAct</Set>       <!--收款人帐号-->
              <Set>PyeNam=$CrpNam</Set>       <!--收款人名称-->
              <Set>PyeBNm=交通银行</Set>      <!--收款银行-->
              <Set>VchDat=$ActDat</Set>       <!--签发日期-->
              <Set>TOIFlg=O</Set>             <!--交易方向-->
              <Set>AgrNo=$AgrNo</Set>         <!--协议编码-->
              <Set>VchSmr=电信扣费</Set>      <!--摘要-->
              <Set>ActSqn=$ActSqn</Set>       <!--入帐帐号顺序号-->
              <Set>ActNod=$ActNod</Set>       <!--入帐网点-->
              <Set>TxnAmt=$TxnAmt</Set>       <!--金额-->
              <Set>NodNo=$ActNod</Set>        <!--凭证登记部门-->
              <Set>HSubCd=001</Set>           <!--借零余额户贷26201-->
              <Set>TTXnCd=461181</Set>
              <Set>THD_TRNCOD=461181</Set>
              <Set>THD_SVROBJ=STHDPFA3</Set>
      	      <!--省零余额记账-->
      	      <Call package="AFE" function="AFE_SglPrvZeroPay"/>      
              <Break/>
            </Case>
            <Case value="999" > <!--中央财政支付-->
              <Set>BrNam=广东省分行</Set>     <!--分行名称-->
              <Set>EleBk=63407</Set>          <!--电子联行号-->
              <!--Set>APVchN=$LogNo</Set-->   <!--授权支付凭证号码,该变量在AFE_SglCntZeroPay中赋值-->
              <Set>PayCod=$SubCod</Set>
              <Set>FinAre=999</Set>
              <Set>ActNo=$ActNo</Set>         <!--付款人帐号-->                                  
              <Set>ActNam=$TCusNm</Set>       <!--付款单位名称-->
              <Set>ANodNm=交通银行</Set>      <!--付款单位开户银行-->
              <Set>PyeAct=$StlAct</Set>       <!--收款人帐号-->
              <Set>PyeNam=$CrpNam</Set>       <!--收款单位名称-->
              <Set>PyeBk =交通银行</Set>      <!--收款单位开户银行-->
              <Set>UdwDat=$ActDat</Set>       <!--签发日期-->
              <Set>ActSqn=$ActSqn</Set>       <!--入帐帐号顺序号-->
              <Set>ActNod=$ActNod</Set>       <!--入帐网点-->
              <Set>StlMod=07</Set>            <!--结算方式-->
              <Set>CcyCod=CNY</Set>           <!--币种-->                      
              <Set>AthAmt=FABSAMT($TxnAmt,15)</Set>       <!--金额-->
              <!--Set>VInTlr=$TlrId</Set-->   <!--凭证登记录入员 该变量在AFE_SglCntZeroPay中赋值-->
              <Set>VRgNod=$ActNod</Set>       <!--凭证登记部门-->
              <Set>Smr=电信扣费</Set>         <!--摘要-->
              <Set>HSubCd=001</Set>           <!--主机交易子码 001记26201分户-->
              <Set>TTXnCd=363412</Set>
              <Set>THD_TRNCOD=363412</Set>
              <Set>THD_SVROBJ=STHDFAP2</Set>
      	      <!--中央零余额记账-->
      	      <Call package="AFE" function="AFE_SglCntZeroPay"/>                
              <Break/>
            </Case>
            <Default>
              <Set>RspCod=TRF001</Set>
              <Set>RspMsg=没该财政支付类型</Set>
              <Quote name="SetBkMsg"/>
              <Set>MsgBodyFlg=0</Set>
              <Return/>
            </Default>
          </Switch>

          <Quote name="SetBkMsg"/>

          <Set>FulRtn=0</Set><!--返回扣款标识,1:部分扣款;0:全部扣款-->
          <If condition="OR( IS_EQUAL_STRING($RspCod,CD5200), IS_EQUAL_STRING($RspCod,SD5200) )">
            <Set>BEChk=0</Set>
          </If>
          <Else>
            <Set>BEChk=1</Set>
          </Else>
          
          <If condition="IS_EQUAL_STRING($RspCod,000000)">
          	<!--记账成功返回-->
          	<Exec func="PUB:CloseCursor">	<!--关闭游标-->
          	  <Arg name="CursorName" value="CUR_TRFA"/>
          	</Exec>
          	<Return/>
          </If>
          <ElseIf condition="OR( IS_EQUAL_STRING($RspCod,CD5200), IS_EQUAL_STRING($RspCod,SD5200) )">
          	<!--余额不足取下一条协议-->
          	<Continue/>
          </ElseIf>
          <Else>
          	<!--其他错误返回-->
          	<Exec func="PUB:CloseCursor">	<!--关闭游标-->
          	  <Arg name="CursorName" value="CUR_TRFA"/>
          	</Exec>
          	<Set>MsgBodyFlg=0</Set>
          	<Return/>
          </Else>
          
        </While>
        <!--零余额账户处理结束-->
      </If>


      <!--普通账户记账-->
      <Call package="AFE" function="AFE_SglThdPay"/>

      <Quote name="SetBkMsg"/>
      
      <Set>FulRtn=0</Set><!--返回扣款标识,1:部分扣款;0:全部扣款-->
      <If condition="INTCMP($HRspCd,3,PD5100)">
        <Set>BEChk=0</Set>
      </If>
      <Else>
        <Set>BEChk=1</Set>
      </Else>

    </FlowCtrl>
  </Transaction>

  <Transaction code="481504" desc="电信划款冲正">
    <DynSentence name="ThdQryJnl"><!--按第三方键值查询流水信息 -->
       <Sentence>
          SELECT HTxnCd,TTxnCd,HTxnSt,LogNo,TckNo,HLogNo,TlrId,NodNo FROM afetxnjnl  WHERE CAgtNo='%s' AND TLogNo='%s' AND HTxnSt in ('S','T','U')
       </Sentence>
       <Fields>CAgtNo|TLogNo|</Fields>
    </DynSentence>
    <DynSentence name="SetSts">
       <Sentence>
          UPDATE afetxnjnl SET (TxnSts,HTxnSt)=('%s','%s') WHERE CAgtNo='%s' AND LogNo='%s'
       </Sentence>
       <Fields>TxnSts|HTxnSt|CAgtNo|LogNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>RspCod=000000</Set>  <!-- 默认交易返回成功 -->
      

      <!--Call package="AFE" function="AFE_ThdCancel"/-->
      <Exec func="PUB:InitTransaction"/>      <!--交易初始化-->
      
      <Exec func="PUB:ReadRecord" error="IGNORE">
         <Arg name="SqlCmd" value="ThdQryJnl"/>
      </Exec>
      <If condition="~RetCod!=0">
         <Set>RspCod=478611</Set><!--查询无此流水-->
         <Quote name="SetBkMsg"/>
         <Return/>
      </If>      

      <If condition="IS_EQUAL_STRING($TTxnCd,461181)">
        <!--省财政零预额账户抹账-->
        <Set>NodNo=$NodNo</Set>
        <Set>TlrId=$TlrId</Set>
        <Set>PfaSub=001</Set>
        <Set>OLogNo=$LogNo</Set>
        <Set>THD_TRNCOD=461189</Set>
        <Set>THD_SVROBJ=STHDPFA3</Set>        
        <Exec func="PUB:CallThirdOther" error="IGNORE">   <!--发向零余额接口-->
          <Arg name="HTxnCd" value="$THD_TRNCOD"/>
          <Arg name="ObjSvr" value="$THD_SVROBJ"/>
        </Exec>
        <Switch expression="~RetCod">
          <Case value="0"><!--抹帐成功时 -->
            <Set>HTxnSt=C</Set>
            <Set>TxnSts=C</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="SetSts"/>
            </Exec>
            <Break/>
          </Case>
          <Default>
          	<Set>RspCod=$TRspCd</Set>
          </Default>
        </Switch>
      </If>
      <ElseIf condition="IS_EQUAL_STRING($TTxnCd,363412)">
      	<!--中央财政零余额账户抹账-->
      	<Set>EleBk=63407</Set>     <!--电子联行号-->
      	<Set>APVchN=$LogNo</Set>   <!--授权支付凭证号码-->
        <Set>THD_TRNCOD=363419</Set>
        <Set>THD_SVROBJ=STHDFAP2</Set>       
        <Exec func="PUB:CallThirdOther" error="IGNORE">   <!--发向零余额接口-->
          <Arg name="HTxnCd" value="$THD_TRNCOD"/>
          <Arg name="ObjSvr" value="$THD_SVROBJ"/>
        </Exec>
        <Switch expression="~RetCod">
          <Case value="0"><!--抹帐成功时 -->
            <Set>HTxnSt=C</Set>
            <Set>TxnSts=C</Set>
            <Exec func="PUB:ExecSql">
               <Arg name="SqlCmd" value="SetSts"/>
            </Exec>
            <Break/>
          </Case>
          <Default>
          	<Set>RspCod=$TRspCd</Set>
          </Default>
        </Switch>
      </ElseIf>
      <Else>
        <!--普通账户记抹账-->
        <Exec func="PUB:ReadModuleCfg">
          <Arg name="Application" value="TRF"/><!--可以使用单位编号-->
          <Arg name="Transaction" value="$TxnCod"/><!--可以用交易码或者模块名-->
        </Exec>
        
        <Set>OHLogNo=$HLogNo</Set>
        <Set>OTckNo=$TckNo</Set>
        <Set>OTTxnCd=481503</Set>
        
        <Set>TTxnCd=$TxnCod</Set>
        <Set>HTxnCd=STRCAT(SUBSTR(@PARA.HTxnCd_DSCal,1,5),9)</Set>
        <Set>TIATyp=C</Set>
        <Set>OTxnSts=$TxnSts</Set>
        <Set>OHTxnSt=$HTxnSt</Set>
        <Set>HLogNo= </Set>
        <Set>HLogNo=DELSPACE($HLogNo,all)</Set>
        
        <!--Exec func="PUB:GetBranchInf"/-->
        <Exec func="PUB:CallHostAcc" error="IGNORE"><!--上送主机进行冲正交易-->
           <Arg name="HTxnCd" value="@PARA.HTxnCd_Cancel"/>
           <Arg name="ObjSvr" value="@PARA.CBHost"/>
        </Exec>
        <Switch expression="~RetCod">
           <Case value="0"><!--抹帐成功时 -->
              <Set>HTxnSt=C</Set>
              <Set>TxnSts=C</Set>
              <Exec func="PUB:ExecSql">
                 <Arg name="SqlCmd" value="SetSts"/>
              </Exec>
              <Break/>
           </Case>
           <Case value="3">
              <Set>inHRspCd=STRCAT(|,$HRspCd,|)</Set>
              <If condition="INTCMP(GETSTRPOS(@PARA.HstNoJnl,$inHRspCd),5,0)">
                 <Set>HTxnSt=C</Set>
                 <Set>TxnSts=C</Set>
              </If>
              <Else>
                 <Set>TxnSts=$OTxnSts</Set>
                 <Set>HTxnSt=$OHTxnSt</Set>
              </Else>
              <Exec func="PUB:ExecSql">
                 <Arg name="SqlCmd" value="SetSts"/>
              </Exec>
              <Break/>
           </Case>
           <Default>
              <Set>TxnSts=$OTxnSts</Set>
              <Set>HTxnSt=$OHTxnSt</Set>
              <Exec func="PUB:ExecSql">
                 <Arg name="SqlCmd" value="SetSts"/>
              </Exec>
              <Exec func="PUB:SetNoResponse"/>
              <Break/>
           </Default>
        </Switch>
      </Else>
      <Quote name="SetBkMsg"/>
    </FlowCtrl>
  </Transaction>

  <Transaction code="481505" desc="电信对账" error="PUB:SetNoResponse">
    <DynSentence name="GetTxnJnl">  <!--生成文件-->
      <Sentence>
        SELECT a.*,b.* FROM afetxnjnl a, trftxnjnl441 b 
        WHERE CAgtNo='%s' AND ActDat='%s' AND HTxnSt = 'S' AND b.extkey=a.extkey
      </Sentence>
      <Fields>CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <DynSentence name="Cnt">  <!--生成文件-->
      <Sentence>
        SELECT Count(*) OrnCnt, SUM(CAST(TxnAmt As BIGINT)) OrnAmt FROM afetxnjnl
        WHERE CAgtNo='%s' AND ActDat='%s' AND HTxnSt= 'S' 
      </Sentence>
      <Fields>CAgtNo|TxnDat|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      
      <Set>tmpChkTim=$ChkTim</Set><!--保留原消息时间-->

      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="Cnt"/>
      </Exec>
      <Set>SendFil=STRCAT(GETENV(WORKDIR),/dat/trf/,$FilNam)</Set>
      <Exec func="PUB:ExportFromDB"><!--产生上送主机的文件-->
        <Arg name="SqlName" value="GetTxnJnl"/>
        <Arg name="FormatName" value="ChkFormat"/>
        <Arg name="FileName" value="$SendFil"/>
        <Arg name="TableName" value="afetxnjnl"/>
      </Exec>

      <Set>LclFil=$FilNam</Set>
      <Set>LclDir=dat/trf</Set>
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="GD_TRF_CHK"/>
      </Exec>

      <Set>ChkTim=$tmpChkTim</Set><!--恢复原消息时间-->
      <Set>RspCod=000000</Set>

    </FlowCtrl>
  </Transaction>

  <Transaction code="481506" desc="对帐清单打印">
    <DynSentence name="Cnt">  <!--生成文件-->
      <Sentence>
        SELECT Count(*) OrnCnt, SUM(CAST(TxnAmt As BIGINT)) OrnAmt FROM afetxnjnl
        WHERE CAgtNo='%s' AND ActDat &gt;='%s' AND ActDat &lt;='%s' AND HTxnSt= 'S' 
      </Sentence>
      <Fields>CAgtNo|BgnDat|EndDat|</Fields>
    </DynSentence>
    <FlowCtrl>      
      <!--If condition="INTCMP($EndDat,5,$ActDat)"> 
        <Set>RspCod=481599</Set>
        <Set>RspMsg=结束日期大于或者等于会计日期</Set>
        <Return/>
      </If-->
      
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="Cnt"/>
      </Exec>
     
      <If condition="INTCMP($OrnCnt,3,0)"> <!--入库未完成-->
        <Return/>
      </If>
      
      <Set>FilNam=STRCAT(电信对帐清单,$BgnDat,-,$EndDat,.rpt)</Set>
      <Set>FmtFil=etc/TRF01_RPT_441999.XML</Set><!--根据单位编号取得相应的清单格式名称-->
      <Exec func="PUB:GenerateReport">
        <Arg name="ObjFil" value="STRCAT(dat/term/send/,$FilNam)"/>
        <Arg name="FmtFil" value="$FmtFil"/>
        <Arg name="Para1"  value="$CAgtNo"/>
        <Arg name="Para2"  value="$BgnDat"/>
        <Arg name="Para3"  value="$EndDat"/>
        <Arg name="Para4"  value="$OrnCnt"/>
        <Arg name="Para5"  value="$OrnAmt"/>
      </Exec>
      <Exec func="PUB:SendFileMessage2"><!--发出文件打印指令-->
        <Arg name="MsgTyp" value="4"/><!-- 消息类型，1通知2广播3文件4打印，一般传文件时用3，需要在前置打印时用4-->
        <Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
        <Arg name="BusTyp" value="48"/><!-- 业务类型-->
        <Arg name="AplCod" value="1506"/><!-- 应用码-->
        <Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
        <Arg name="Summary" value="电信对帐清单"/><!-- 消息内容-->
        <Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
        <Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
        <Arg name="SrcTlr" value="$TlrId"/><!-- 消息来源柜员-->
      </Exec>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="$Reckey"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <Transaction code="481518" desc="电信对公缴费记账回执打印">

    <FlowCtrl>      
      <!--If condition="INTCMP($EndDat,5,$ActDat)"> 
        <Set>RspCod=481599</Set>
        <Set>RspMsg=结束日期大于或者等于会计日期</Set>
        <Return/>
      </If-->
   
      <Set>PrtId=$TlrId</Set>
      <Set>PrtDat=$ActDat</Set>
      
      <If condition="ISNULL(DELSPACE($TckNo,all))">
        <Set>FilNam=STRCAT(电信对公缴费记账回执,$BgnDat,-,$EndDat,.rpt)</Set>
        <Set>FmtFil=etc/TRF02_RPT_441999.XML</Set><!--根据单位编号取得相应的清单格式名称-->
        <Exec func="PUB:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(dat/term/send/,$FilNam)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="Para1"  value="$CAgtNo"/>
          <Arg name="Para2"  value="$BgnDat"/>
          <Arg name="Para3"  value="$EndDat"/>
          <Arg name="Para4"  value="$NodNo"/>
          <Arg name="Para5"  value="$PrtId"/>
          <Arg name="Para6"  value="$PrtDat"/>
        </Exec>
        <Exec func="PUB:SendFileMessage2"><!--发出文件打印指令-->
          <Arg name="MsgTyp" value="4"/><!-- 消息类型，1通知2广播3文件4打印，一般传文件时用3，需要在前置打印时用4-->
          <Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
          <Arg name="BusTyp" value="48"/><!-- 业务类型-->
          <Arg name="AplCod" value="1518"/><!-- 应用码-->
          <Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
          <Arg name="Summary" value="电信对公缴费记账回执"/><!-- 消息内容-->
          <Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
          <Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
          <Arg name="SrcTlr" value="Billlp2"/><!-- 消息来源柜员-->
        </Exec>
      </If>
      <Else>
        <Set>FilNam=STRCAT(电信对公缴费记账回执,$BgnDat,-,$EndDat,.rpt)</Set>
        <Set>FmtFil=etc/TRF03_RPT_441999.XML</Set><!--根据单位编号取得相应的清单格式名称-->
        <Exec func="PUB:GenerateReport">
          <Arg name="ObjFil" value="STRCAT(dat/term/send/,$FilNam)"/>
          <Arg name="FmtFil" value="$FmtFil"/>
          <Arg name="Para1"  value="$CAgtNo"/>
          <Arg name="Para2"  value="$BgnDat"/>
          <Arg name="Para3"  value="$EndDat"/>
          <Arg name="Para4"  value="$NodNo"/>
          <Arg name="Para5"  value="$PrtId"/>
          <Arg name="Para6"  value="$PrtDat"/>
          <Arg name="Para7"  value="$TckNo"/>
        </Exec>
        <Exec func="PUB:SendFileMessage2"><!--发出文件打印指令-->
          <Arg name="MsgTyp" value="4"/><!-- 消息类型，1通知2广播3文件4打印，一般传文件时用3，需要在前置打印时用4-->
          <Arg name="ObjNod" value="$NodNo"/><!-- 目标网点-->
          <Arg name="BusTyp" value="48"/><!-- 业务类型-->
          <Arg name="AplCod" value="1518"/><!-- 应用码-->
          <Arg name="FilNam" value="$FilNam"/><!-- 文件名-->
          <Arg name="Summary" value="电信对公缴费记账回执"/><!-- 消息内容-->
          <Arg name="ObjTlr" value="$TlrId"/><!-- 目标柜员-->
          <Arg name="SrcNod" value="$NodNo"/><!-- 消息来源网点-->
          <Arg name="SrcTlr" value="Billlp2"/><!-- 消息来源柜员-->
        </Exec>
      </Else>

    </FlowCtrl>
  </Transaction>
  
  <Transaction code="481510" desc="批量发票文件入库"> <!--RsFld3 发票标识 ActTyp 1 一本通 2账号 4卡号 6 对公-->
    <DynSentence name="QryDskNo">  <!--查询批次是否完成-->
      <Sentence>
        SELECT a.DskNo,a.Status,b.aa OFilNo FROM PUBBATINF a, fbpbatinf441 b WHERE a.DskNo='%s' AND b.DskNo=a.DskNo AND RsvFld='%s'
      </Sentence>
      <Fields>DskNo|CAgtNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInvBat">  <!--查询是否导入-->
      <Sentence>
        SELECT BATSTS,InpTim FROM trfinvctl441 WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdInvBat">  <!--查询是否导入-->
      <Sentence>
        UPDATE trfinvctl441 SET BatSts='%s', SUMCNT='%s' WHERE DskNo='%s'
      </Sentence>
      <Fields>BatSts|SumCnt|DskNo|</Fields>
    </DynSentence>
    <DynSentence name="DelInvRec">  <!--删除原记录 -->
      <Sentence>
        DELETE FROM trfinvrec441 WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="DelInvBat">  <!--删除原记录 -->
      <Sentence>
        DELETE FROM trfinvctl441 WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="DelInvTmp">  <!--删除临时记录 -->
      <Sentence>
        DELETE FROM trfinvTmp441 WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInvTmp">  <!--查询是否导入-->
      <Sentence>
        SELECT InvRec,InvIdx FROM trfinvtmp441 WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="QryBatRec">  <!--查找对公记帐成功记录 TCusId 发票标识-->
      <Sentence>
        SELECT ActNo,ActTyp FROM afebatrec WHERE DskNo='%s' AND TCusId='%s' AND RecSts='1'
      </Sentence>
      <Fields>DskNo|InvId|</Fields>
    </DynSentence>
    <DynSentence name="QryInvRec">  <!--查找记帐成功记录-->
      <Sentence>
        SELECT InvIdx FROM TrfInvRec441 WHERE DskNo='%s' AND InvSts='1' ORDER BY OpnNod, ActNo
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdInvSqn">  <!--更新发票序号 -->
      <Sentence>
        Update trfinvrec441 SET SeqNo='%s', InvSts='2' WHERE DskNo='%s' AND InvIdx='%s'
      </Sentence>
      <Fields>SeqNo|DskNo|InvIdx|</Fields>
    </DynSentence>
    <DynSentence name="UpdInvTmp2">  <!--更新发票临时表，打印成功标志 -->
      <Sentence>
        Update trfinvtmp441 SET InvSts='2' 
        WHERE DskNo='%s' AND InvIdx='%s'  
      </Sentence>
      <Fields>DskNo|InvIdx|</Fields>
    </DynSentence>
    <DynSentence name="UpdInvTmp1">  <!--更新发票临时表，打印成功标志 -->
      <Sentence>
        Update trfinvtmp441 SET InvSts='1' 
        WHERE DskNo='%s' AND InvIdx='%s'
      </Sentence>
      <Fields>DskNo|InvIdx|</Fields>
    </DynSentence>
    <DynSentence name="QryInvCnt">  <!--取发票总笔数，总金额 -->
      <Sentence>
        SELECT Count(*) as SumCnt FROM trfinvrec441 WHERE DskNo='%s' AND InvSts='2'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="QryOpnNod">  <!--取发网点号-->
      <Sentence>
        SELECT OpnNod FROM actnoinf441 WHERE (ActNo='%s' OR OldAct='%s') AND ActTyp='6'
      </Sentence>
      <Fields>ActNo|ActNo|</Fields>
    </DynSentence>
    <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>      <!--交易初始化-->
      <Set>CAgtNo=$CAgtNoA</Set>  <!--取批量电信单位编号-->
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryDskNo"/>
      </Exec>
      <If condition="$Status!=N">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=STRCAT(批次:,$DskNo,未处理完毕)</Set>
        <Return/>
      </If>
      <!--加锁-->
      <Set>RecKey=STRCAT($AplCls,:,$BusTyp,:,INV)</Set>
      <Exec func="PUB:Lock"  error="IGNORE">
        <Arg name="RecKey" value="$RecKey"/>
        <Arg name="TimOut" value="2000"/>
        <Arg name="AutoUnlock" value="yes"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=发票正在入库，请稍候再试</Set>
        <Return/>
      </If>

      <Exec func="PUB:ReadRecord" error="IGNORE">
        <Arg name="SqlCmd" value="QryInvBat"/>
      </Exec>
      <If condition="~RetCod=0">
        <If condition="INTCMP($BatSts,4,1)"> <!--入库未完成-->
          <Set>Time=GETDATETIME()</Set>
          <Set>SubTim=SUB($Time,$IntTim)</Set>
          <If condition="INTCMP($SubTim,1,3000)"> <!--超时超过30分钟-->
            <Set>RspCod=481599</Set>
            <Set>RspMsg=发票正在入库，请稍候再试</Set>
            <Return/>
          </If>
          <Else>
            <Exec func="PUB:AddAuthReason" >
              <Arg name="AthCod" value="30"/>
              <Arg name="AthMsg" value="481210"/>
            </Exec>
            <Exec func="PUB:CheckLocalAuth">
              <Arg name="ObjSvr" value="SHSTPUB1"/>
            </Exec>
            <Exec func="PUB:ExecSql">   <!--入库失败,超时-->
              <Arg name="SqlCmd" value="DelInvBat"/>
            </Exec>
          </Else>
        </If>
        <Else>
          <Set>RspCod=481599</Set>
          <Set>RspMsg=该批次已入库</Set>
          <Return/>
        </Else>
      </If>
      <ElseIf condition="~RetCod!=-2">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=数据库错误</Set>
        <Return/>
      </ElseIf>

      <!--开始取文件-->
      <Set>LclFil=STRCAT($FilNam,.,$BrNo)</Set>
      <Set>LclDir=dat/trf</Set>
      <Exec func="PUB:FtpGet" error="IGNORE">
        <Arg name="FtpId" value="GD_TRF"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=481299</Set>
        <Set>RspMsg=取文件失败</Set>
        <Return/>
      </If>

      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="DelInvRec"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=数据库错误</Set>
        <Return/>
      </If>
      <Exec func="PUB:ExecSql" error="IGNORE">
        <Arg name="SqlCmd" value="DelInvTmp"/>
      </Exec>
      <If condition="~RetCod=-1">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=数据库错误</Set>
        <Return/>
      </If>

      <!--导入文件-->
      <Set>FileName=STRCAT(GETENV(WORKDIR),/dat/trf/,$LclFil)</Set>
      <Exec func="PUB:IsExistFile"  error="IGNORE">
        <Arg name="FileName" value="$FileName"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=STRCAT(文件,$FilNam,不存在)</Set>
        <Return/>
      </If>

      <Exec func="PUB:OpenFile">
        <Arg name="FileName" value="$FileName"/>
        <Arg name="Mode"     value="r"/>
      </Exec>
      <Exec func="PUB:GetFileLineAndParse">
        <Arg name="ConfigName" value="BatFormat"/>
        <Arg name="RootName"   value="BATCH"/>
        <Arg name="NodeName"   value="Process"/>
        <Arg name="AttrName"   value="name"/>
        <Arg name="AttrValue"  value="InvHead"/>
      </Exec>
      <If condition="IS_NOEQUAL_STRING(DELBOTHSPACE($InFilNo),DELBOTHSPACE($OFilNo))">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=发票文件和代扣批次不对应</Set>
        <Return/>
      </If>

      <Set>FileName=$FileName</Set>
      <Exec func="PUB:ImportToDB" error="IGNORE">
        <Arg name="FormatName" value="trfinvtmp"/>
        <Arg name="FileName"   value="$FileName"/>
        <Arg name="TableName"  value="trfinvtmp441"/>
      </Exec>
      <If condition="~RetCod!=0">
        <If condition="$SQLCOD=-803">
          <Set>SQLCOD=数据重复</Set>
        </If>
        <Set>RspMsg=STRCAT($RspMsg,输入导入错误:,$SQLCOD)</Set>
        <Goto>Notify</Goto>
      </If>

      <Set>BatSts=0</Set>   <!--初始状态-->
      <Set>InpTim=GETDATETIME()</Set>
      <Exec func="PUB:InsertRecord">
        <Arg name="TblNam" value="TrfInvCtl441"/>
      </Exec>
      <!--Exec func="PUB:CommitWork" /-->
      <Set>MsgTyp=N</Set>
      <Set>RspCod=000000</Set>
      <Exec func="PUB:PutResponse"/>
        
      <Set>OTlrId=$TlrId</Set>
      <Set>TxnCnl=FBP</Set>
      <Exec func="PUB:GetVirtualTeller"/>
      <Exec func="PUB:OpenCursor">
        <Arg name="SqlCmd" value="QryInvTmp"/>
      </Exec>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <ElseIf condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor"/>
          <Set>RspCod=481599</Set>
          <Set>RspMsg=数据库操作错误</Set>
          <Goto>Notify</Goto>
        </ElseIf>

        <!--插入明细表-->
        <Set>InvId =SUBSTR($InvRec,1, 10)</Set>        <!--发票标识号-->
        <Set>TCusId=SUBSTR($InvRec,21,14)</Set>        <!--代表号码-->
        <Set>InvAmt=SUBSTR($InvRec,35,12)</Set>        <!--报销费用-->
        <Set>PayAmt=SUBSTR($InvRec,47,12)</Set>        <!--实扣费用-->
        <Set>PreAmt=SUBSTR($InvRec,59,12)</Set>        <!--预缴费-->
        <Set>PayNo =SUBSTR($InvRec,71,20)</Set>        <!--缴费编号-->
        <Set>StaPayTim=SUBSTR($InvRec,91,8)</Set>      <!--话费开始时间-->
        <Set>EndPayTim=SUBSTR($InvRec,99,8)</Set>      <!--话费截止时间-->
        <Set>ActNo =SUBSTR($InvRec,107,40) </Set>      <!--金融帐号-->
        <Set>UsrNm =SUBSTR($InvRec,147,60) </Set>      <!--用户名称-->
        <Set>UsrAdr=SUBSTR($InvRec,207,80) </Set>      <!--用户地址-->
        <Set>InvItemNum=SUBSTR($InvRec,287,5)</Set>    <!--账单项数-->
        <Set>InvInfLen =MUL($InvItemNum,50)</Set>      <!--帐单信息长度-->
        <Set>InvInf=SUBSTR($InvRec,292,$InvInfLen)</Set>   <!--帐单信息-->

        <!--取网点号-->
        <Exec func="PUB:ReadRecord"  error="IGNORE">
          <Arg name="SqlCmd" value="QryBatRec"/>
        </Exec>
        <If condition="~RetCod=-2">
           <Continue/>
        </If>
        <If condition="~RetCod!=0">
           <Exec func="PUB:CloseCursor"/>
           <Set>RspCod=481599</Set>
           <Set>RspMsg=查询开户网点错误</Set>
           <Goto>Notify</Goto>
        </If>
        <If condition="INTCMP($ActTyp,4,6)">   
          <Exec func="PUB:ExecSql">  <!--更新临时表打印成功标志-->
            <Arg name="SqlCmd" value="UpdInvTmp2"/>
          </Exec>
        </If> 
        <Else>
          <Exec func="PUB:ExecSql">  <!--更新临时表打印成功标志-->
            <Arg name="SqlCmd" value="UpdInvTmp1"/>
          </Exec>
          <Exec func="PUB:ReadRecord"  error="IGNORE">
            <Arg name="SqlCmd" value="QryOpnNod"/>
          </Exec>
          <If condition="~RetCod=-2">
            <Exec func="PUB:CallHostOther" error="IGNORE">
              <Arg name="HTxnCd" value="109000"/>
              <Arg name="ObjSvr" value="SHSTPUB1"/>
            </Exec>
            <If condition="~RetCod!=0">    <!--帐号不存在-->
              <If condition="~RetCod=3">
                <If condition="IS_NOEQUAL_STRING(SUBSTR($HRspCd,1,2),SC)">  <!--非系统错误-->
                  <Set>OpnNod=AAAAAA</Set> <!--帐号状态不对-->
                  <Set>RspCod=000000</Set>
                  <Set>MsgTyp=N</Set>
                </If>
                <Else>
                  <Exec func="PUB:CloseCursor"/>
                  <Set>RspCod=$HRspCd</Set>
                  <Set>RspMsg=查询开户网点错误</Set>
                  <Goto>Notify</Goto>
                </Else>
              </If>
              <Else>
                <Exec func="PUB:CloseCursor"/>
                <Set>RspCod=481599</Set>
                <Set>RspMsg=查询开户网点错误</Set>
                <Goto>Notify</Goto>
              </Else>
            </If>
            <Else>
              <Set>ActTyp=6</Set>
              <Exec func="PUB:InsertRecord">
                <Arg name="TblNam" value="actnoinf441"/>
              </Exec>
              <Exec func="PUB:CommitWork" />
            </Else>
          </If>
          <ElseIf condition="~RetCod!=0">
            <Set>RspCod=481599</Set>
            <Set>RspMsg=数据库操作错误</Set>
            <Goto>Notify</Goto>
          </ElseIf>
          
          <Set>InvSts=1</Set>
          <Set>OpnNod=$OpnNod</Set>
          <Exec func="PUB:InsertRecord" error="IGNORE">
            <Arg name="TblNam" value="trfinvrec441"/>
          </Exec>
        </Else>
      </While>
      <Exec func="PUB:CloseCursor"/>
      <Exec func="PUB:CommitWork" />

      <!--增加序号-->
      <Set>SeqNo=0</Set>
      <Exec func="PUB:OpenCursor">
        <Arg name="SqlCmd" value="QryInvRec"/>
      </Exec>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Exec func="PUB:CloseCursor"/>
          <Break/>
        </If>
        <ElseIf condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor"/>
          <Set>RspCod=481599</Set>
          <Set>RspMsg=数据库操作错误</Set>
          <Goto>Notify</Goto>
        </ElseIf>

        <Set>SeqNo=ADD($SeqNo,1)</Set>
        <Exec func="PUB:ExecSql">  <!--更新序号-->
          <Arg name="SqlCmd" value="UpdInvSqn"/>
        </Exec>
      </While>
      <Exec func="PUB:CommitWork" />

      <Set>RspCod=000000</Set>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInvCnt"/>
      </Exec>
      <Set>BatStS=1</Set>
      <Exec func="PUB:ExecSql">  <!--更新发票批次状态-->
        <Arg name="SqlCmd" value="UpdInvBat"/>
      </Exec>
      <Exec func="PUB:CommitWork" />
      <Set>RspCod=000000</Set>
      <Set>RspMsg=批量发票入库成功</Set>
      <Label>Notify</Label>
      <Set>TlrId=$OTlrId</Set>
      <Exec func="PUB:Notify">
        <Arg name="BusTyp"  value="AG"/>
        <Arg name="AplCod"  value="481510"/>
        <Arg name="Summary" value="STRCAT(电信批量发票入库)"/>
        <Arg name="MsgData" value="STRCAT(批次号:,$DskNo,:,$RspCod,:,$RspMsg)"/>
        <Arg name="ObjNod"  value="$NodNo"/><!-- 目的机构-->
        <Arg name="ObjTlr"  value="$TlrId"/><!-- 目的柜员-->
        <Arg name="SrcOrg"  value="$NodNo"/><!-- 操作机构号-->
        <Arg name="SrcTlr"  value="$TlrId"/><!-- 操作柜员号-->
      </Exec>
      <!--解锁-->
      <Exec func="PUB:Unlock">
        <Arg name="RecKey" value="$RecKey"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <Transaction code="481511" desc="发票打印">
    <DynSentence name="QryInvBat">  <!--查询是否导入-->
      <Sentence>
        SELECT BatSts FROM trfinvctl441 WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInvRec">  <!--查找发票记录-->
      <Sentence>
        SELECT * FROM TrfInvRec441 WHERE DskNo='%s' AND (OpnNod = '%s' OR '%s'='' )
        AND (SeqNo &gt;= '%s' OR '%s'='' ) AND (SeqNo &lt;= '%s' OR '%s'='' ) AND InvSts='2' ORDER BY CAST(SeqNo as INT)
      </Sentence>
      <Fields>DskNo|OpnNod|OpnNod|BgnSqn|BgnSqn|EndSqn|EndSqn|</Fields>
    </DynSentence>
    <!--打印格式-->
    <DynSentence name="PrtFmtHed">  <!--头记录-->
      <Sentence>
        %s                                                              %-10s\n
        \n
        \n
        \n
        \n
        \n
          %-40s       %s-%s-%s\n
          %s                                        %-8s--%-8s\n
          珠海交通银行                                   %s\n
          %s                                                   %s   %s   %s\n
        \n
        \n
      </Sentence>
      <Fields>@BAS.space|seqno|UsrNm|DskNo|InvId|InvIdx|TCusId|StaPayTim|EndPayTim|ActNo|TxnDate|yy|mm|dd|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtRec1">  <!--帐单项 单项-->
      <Sentence>
        %s%-18s %8s
      </Sentence>
      <Fields>@BAS.space|nam|Amt|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtRec2">  <!--帐单项 单项-->
      <Sentence>
        %s%-18s %8s
      </Sentence>
      <Fields>@BAS.space|nam|Amt|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtRec0">  <!--帐单项 单项-->
      <Sentence>
        %s%-18s %8s \n
      </Sentence>
      <Fields>@BAS.space|nam|Amt|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtEnd">  <!--尾记录-->
      <Sentence>
        %s           合计（大写): %-30s    （小写）:￥ %-20s\n
        %s  本月应收: %-15s 预收金支付: %-15s 本月实收: %-15s\n
        \n
        %s网点%s\n
        \n\n\n\n\n\n\n
      </Sentence>
      <Fields>@BAS.space|CapAmt|PayAmt|@BAS.space|invamt|preamt|payamt|@BAS.space|opnnod|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>      <!--交易初始化-->

      <Set>RecKey=STRCAT($AplCls,:,$BusTyp,:,INV)</Set>
      <Exec func="PUB:Lock"  error="IGNORE">
        <Arg name="RecKey" value="$RecKey"/>
        <Arg name="TimOut" value="600"/>
        <Arg name="AutoUnlock" value="yes"/>
      </Exec>
      <If condition="~RetCod!=0">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=发票入库未完成，请稍候</Set>
        <Return/>
      </If>

      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInvBat"/>
      </Exec>
      <If condition="$BatSts=0">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=发票入库未完成，请稍候</Set>
        <Return/>
      </If>

      <!--查找发票记录-->
      <Set>@BAS.space= </Set>              <!--空格-->
      <Set>FilNam=STRCAT(trf_inv_,$DskNo,_,GETDATETIME(HHMISS),.txt)</Set>

      <Exec func="PUB:OpenCursor">
        <Arg name="SqlCmd" value="QryInvRec"/>
      </Exec>
      
      <Set>LineCnt=13</Set>
      <Set>ItemCnt=39</Set>
      <Set>EnterStr=STRCAT(\\n,\\n,\\n,\\n,\\n,\\n,\\n,\\n,\\n,\\n,\\n,\\n,\\n)</Set>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <ElseIf condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor"/>
          <Set>RspCod=481599</Set>
          <Set>RspMsg=数据库操作错误</Set>
          <Return/>
        </ElseIf>

        <Set>TxnDate=STRCAT(SUBSTR($ActDat,1,2),SUBSTR($DskNo,1,6))</Set> <!-- 以当前会计日期及批次号拼出扣帐日期 -->
        <Set>yy=SUBSTR($ActDat,3,2)</Set>
        <Set>mm=SUBSTR($ActDat,5,2)</Set>
        <Set>dd=SUBSTR($ActDat,7,2)</Set>
        <Exec func="PUB:WriteFile">  <!--头记录-->
          <Arg name="FileName"   value="STRCAT(dat/term/send/,$FilNam)"/>
          <Arg name="OpenMode"   value="a+"/>
          <Arg name="PRNFMT"     value="PrtFmtHed"/>
        </Exec>

        <!--明细帐单项-->
        
        <Set>LineSeq=0</Set>
        <Set>ItemSeq=0</Set>
        <While>
          <Set>ItemSeq=ADD($ItemSeq,1)</Set>
          <If condition="INTCMP($ItemSeq,6,$ItemCnt)">     <!--明细打印完毕,跳出循环 6 大于-->
            <Break/>
          </If>
          <If condition="INTCMP($ItemSeq,2,$InvItemNum)">  <!--打印明细帐单项-->
            <Set>Seq=MOD($ItemSeq,3)</Set>
            <If condition="INTCMP($Seq,3,0)">
              <Set>LineSeq=ADD($LineSeq,1)</Set>
            </If>
            <Set>NamNum=ADD(MUL(SUB($ItemSeq,1),50),1)</Set>
            <Set>Nam=DELBOTHSPACE(SUBSTR($InvInf,$NamNum,40))</Set>  <!--项目 -->
            <Set>AmtNum=ADD($NamNum,40)</Set>
            <Set>Amt=SUBSTR($InvInf,$AmtNum,10)</Set>
            <Set>Amt=AMTSIMPLEFMT($Amt)</Set>         <!--金额-->
            <Set>PrtFmt=STRCAT(PrtFmtRec,$Seq)</Set>
            <Exec func="PUB:WriteFile">
              <Arg name="FileName"   value="STRCAT(dat/term/send/,$FilNam)"/>
              <Arg name="OpenMode"   value="a+"/>
              <Arg name="PRNFMT"     value="$PrtFmt"/>
            </Exec>
          </If>
          
          <Else>
            <Set>EnterStr=$EnterStr</Set>
            <Set>LineSeq=$LineSeq</Set>
            <Set>EnterStrNum=STRNCAT(@BAS.space,$EnterStr,MUL(SUB($LineCnt,$LineSeq),2))</Set>
            <Exec func="PUB:WriteFile">
              <Arg name="FileName"   value="STRCAT(dat/term/send/,$FilNam)"/>
              <Arg name="OpenMode"   value="a+"/>
              <Arg name="ESCFMT"     value="$EnterStrNum"/>
            </Exec>
            <Break/>
          </Else>
          
        </While>

        <Set>CAPAMT=AMTTOCAP($payamt)</Set>
        <Set>payamt=AMTSIMPLEFMT($payamt)</Set>
        <Set>invamt=AMTSIMPLEFMT($invamt)</Set>
        <Set>preamt=AMTSIMPLEFMT($preamt)</Set>
        <Exec func="PUB:WriteFile">  <!--尾记录-->
          <Arg name="FileName"   value="STRCAT(dat/term/send/,$FilNam)"/>
          <Arg name="OpenMode"   value="a+"/>
          <Arg name="PRNFMT"     value="PrtFmtEnd"/>
        </Exec>
      </While>

      <Exec func="EXT:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="0803"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="发票打印"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="$RecKey"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <Transaction code="481512" desc="固定帐号清单打印">
    <DynSentence name="QryActInf">  <!--查找发票记录-->
      <Sentence>
        SELECT actnam FROM actnoinf441 WHERE ActNo='%s'
      </Sentence>
      <Fields>ActNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInvRec">  <!--查找发票记录-->
      <Sentence>
        SELECT InvId,TCusId,InvAmt FROM TrfInvRec441 WHERE DskNo='%s' AND ActNo='%s' AND InvSts='2' ORDER BY SeqNo
      </Sentence>
      <Fields>DskNo|ActNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInvCnt">  <!--汇总发票记录-->
      <Sentence>
        SELECT COUNT(*) AS OrnCnt,SUM(CAST(InvAmt as BIGINT)) OrnAmt FROM TrfInvRec441 WHERE DskNo='%s' AND ActNo='%s' AND InvSts='2'
      </Sentence>
      <Fields>DskNo|ActNo|</Fields>
    </DynSentence>
    <!--打印格式-->
    <DynSentence name="PrtFmtHed">  <!--头记录-->
      <Sentence>
        %s                            %s ( 帐号 %s ) 电信发票金额汇总清单
        \n%s______________________________________________________________________________________________________________________________________________________________________
        \n%s发票号       电话     金额  发票号       电话     金额  发票号       电话     金额  发票号       电话     金额  发票号       电话     金额  发票号       电话     金额
      </Sentence>
      <Fields>@BAS.space|ActNam|ActNo|@BAS.space|@BAS.space|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtRec1">  <!--帐单项 -->
      <Sentence>
        \n%s%6s%11s%9s
      </Sentence>
      <Fields>@BAS.space|InvId|TCusId|InvAmt|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtRec2">  <!--帐单项 -->
      <Sentence>
        %s %6s%11s%9s
      </Sentence>
      <Fields>@BAS.space|InvId|TCusId|InvAmt|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtRec3">  <!--帐单项 -->
      <Sentence>
        %s %6s%11s%9s
      </Sentence>
      <Fields>@BAS.space|InvId|TCusId|InvAmt|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtRec4">  <!--帐单项 -->
      <Sentence>
        %s %6s%11s%9s
      </Sentence>
      <Fields>@BAS.space|InvId|TCusId|InvAmt|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtRec5">  <!--帐单项 -->
      <Sentence>
        %s %6s%11s%9s
      </Sentence>
      <Fields>@BAS.space|InvId|TCusId|InvAmt|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtRec0">  <!--帐单项 -->
      <Sentence>
        %s %6s%11s%9s
      </Sentence>
      <Fields>@BAS.space|InvId|TCusId|InvAmt|</Fields>
    </DynSentence>
    <DynSentence name="PrtFmtEnd">  <!--尾记录-->
      <Sentence>
        \n______________________________________________________________________________________________________________________________________________________________________
        \n操作柜员: %s   操作日期: %s             批次号: %s    汇总笔数:%s    汇总金额: ￥%s
      </Sentence>
      <Fields>TlrId|ActDat|DskNo|OrnCnt|OrnAmt|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>      <!--交易初始化-->
      <Set>RecKey=STRCAT($AplCls,:,$BusTyp,:,INV)</Set>
      <Exec func="PUB:Lock">
        <Arg name="RecKey" value="$RecKey"/>
        <Arg name="TimOut" value="600"/>
        <Arg name="AutoUnlock" value="yes"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryActInf"/>
      </Exec>
      <If condition="~RetCod!=0">
         <Exec func="PUB:CloseCursor"/>
         <Set>RspCod=481599</Set>
         <Set>RspMsg=查询该帐号户名错误</Set>
        <Return/>
      </If>

      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInvCnt"/>
      </Exec>
      <If condition="INTCMP($OrnCnt,3,0)">
        <Set>RspCod=481599</Set>
        <Set>RspMsg=无相关记录</Set>
        <Return/>
      </If>
      <Set>OrnAmt=DELBOTHSPACE($OrnAmt)</Set>
      <Set>OrnAmt=FDIV($OrnAmt,100,2))</Set>

      <!--查找发票记录-->
      <Set>@BAS.space= </Set>              <!--空格-->
      <Set>FilNam=STRCAT(trf_qingdan_,$DskNo,_,GETDATETIME(HHMISS),.txt)</Set>

      <Exec func="PUB:WriteFile">  <!--头记录-->
        <Arg name="FileName"   value="STRCAT(dat/term/send/,$FilNam)"/>
        <Arg name="OpenMode"   value="a+"/>
        <Arg name="PRNFMT"     value="PrtFmtHed"/>
      </Exec>

      <!--写明细-->
      <Set>ItemSeq=0</Set>
      <Set>ItemSeq=0</Set>
      <Exec func="PUB:OpenCursor">
        <Arg name="SqlCmd" value="QryInvRec"/>
      </Exec>
      <While>
        <Exec func="PUB:FetchCursor" error="IGNORE"/>
        <If condition="~RetCod=100">
          <Break/>
        </If>
        <ElseIf condition="~RetCod=-1">
          <Exec func="PUB:CloseCursor"/>
          <Set>RspCod=481599</Set>
          <Set>RspMsg=数据库操作错误</Set>
          <Return/>
        </ElseIf>

        <Set>ItemSeq=ADD($ItemSeq,1)</Set>
        <Set>Seq=MOD($ItemSeq,6)</Set>
        <Set>PrtFmt=STRCAT(PrtFmtRec,$Seq)</Set>
        <Set>InvAmt=DELBOTHSPACE($InvAmt)</Set>
        <Set>InvAmt=FDIV($InvAmt,100,2))</Set>
        <Set>InvIdt=DELBOTHSPACE($InvId)</Set>
        <Exec func="PUB:WriteFile">
          <Arg name="FileName"   value="STRCAT(dat/term/send/,$FilNam)"/>
          <Arg name="OpenMode"   value="a+"/>
          <Arg name="PRNFMT"     value="$PrtFmt"/>
        </Exec>
      </While>

      <Exec func="PUB:WriteFile">  <!--尾记录-->
        <Arg name="FileName"   value="STRCAT(dat/term/send/,$FilNam)"/>
        <Arg name="OpenMode"   value="a+"/>
        <Arg name="PRNFMT"     value="PrtFmtEnd"/>
      </Exec>

      <Exec func="EXT:SendFileMessage2">
        <Arg name="MsgTyp"  value="4"/>
        <Arg name="ObjNod"  value="$NodNo"/>
        <Arg name="BusTyp"  value="46"/>
        <Arg name="AplCod"  value="0803"/>
        <Arg name="FilNam"  value="$FilNam"/>
        <Arg name="Summary" value="固定帐号清单打印"/>
        <Arg name="ObjTlr"  value="$TlrId"/>
      </Exec>
      <Exec func="PUB:Unlock">
        <Arg name="RecKey"   value="$RecKey"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <Transaction code="481513" desc="电信发票结果文件回传">
    <DynSentence name="GetTxnJnl">  <!--生成文件-->
      <Sentence>
        SELECT * FROM trfinvtmp441 WHERE DskNo='%s' AND InvSts='2'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="Cnt">  <!--生成文件-->
      <Sentence>
        SELECT Count(*) InvRecNum FROM trfinvtmp441 WHERE DskNo='%s' AND InvSts='2'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="QryInvCtl">  <!--发票文件信息-->
      <Sentence>
        SELECT INFILNO, BnkCod FROM trfinvctl441 WHERE DskNo='%s'
      </Sentence>
      <Fields>DskNo|</Fields>
    </DynSentence>
    <DynSentence name="UpdInvCtl">  <!--发票文件信息-->
      <Sentence>
        UPDATE trfinvctl441 SET FalCnt='%s' WHERE DskNo='%s'
      </Sentence>
      <Fields>InvRecNum|DskNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>RecKey=STRCAT($AplCls,:,$BusTyp,:,INV)</Set>
      <Exec func="PUB:Lock">
        <Arg name="RecKey" value="$RecKey"/>
        <Arg name="TimOut" value="600"/>
        <Arg name="AutoUnlock" value="yes"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="QryInvCtl"/>
      </Exec>
      <Exec func="PUB:ReadRecord">
        <Arg name="SqlCmd" value="Cnt"/>
      </Exec>
      <Set>LclFil=STRCAT($FilNam,.441999)</Set>
      <Set>SendFil=STRCAT(GETENV(WORKDIR),/dat/trf/,$LclFil)</Set>
      <Exec func="PUB:ExportFromDB"><!--产生上送主机的文件-->
        <Arg name="SqlName"    value="GetTxnJnl"/>
        <Arg name="FormatName" value="trfinvret"/>
        <Arg name="FileName"  value="$SendFil"/>
        <Arg name="TableName" value="trfinvtmp441"/>
      </Exec>
      <Exec func="PUB:FtpPut">
        <Arg name="FtpId" value="GD_TRF"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <Transaction code="481514" desc="电信批扣文件发送">
    <FlowCtrl>
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="00001"/>
        <Arg name="ObjSvr" value="STDATRFA"/>
      </Exec>
    </FlowCtrl>
  </Transaction>

  <Transaction code="481517" desc="资料核对与办理">
    <DynSentence name="GetTrfAgr">  <!--取电信签约资料-->
      <Sentence>
        SELECT ActNo dbActNo,ActTyp dbActTyp,TCusNm dbTCusNm,TCusId dbTCusId,Rmk dbRmk FROM trfagrtbl441 WHERE ActNo='%s' AND Status='0'
      </Sentence>
      <Fields>ActNo|</Fields>
    </DynSentence>
    <DynSentence name="UdpTrfAgr">  <!--修改电信签约资料-->
      <Sentence>
        UPDATE trfagrtbl441 set TCusId = '%s',TCusNm = '%s' where ActNo='%s' AND Status='0'
      </Sentence>
      <Fields>TCusId|TCusNm|ActNo|</Fields>
    </DynSentence>
    <DynSentence name="InsTrfAgr">  <!--增加信签约资料-->
      <Sentence>
        INSERT INTO trfagrtbl441 values('%s','%s','%s','%s','0','%s')
      </Sentence>
      <Fields>ActNo|ActTyp|TCusNm|TCusId|Rmk|</Fields>
    </DynSentence>
    <DynSentence name="DelTrfAgr">  <!--取消电信签约资料-->
      <Sentence>
        UPDATE trfagrtbl441 set Status = '1' where ActNo='%s' AND Status='0'
      </Sentence>
      <Fields>ActNo|</Fields>
    </DynSentence>
    <FlowCtrl>
      <Set>RspCod=000000</Set>
      <Set>MsgTyp=N</Set>
  
      <Switch expression="$ParaTyp">
        <Case value="1" > <!-- 查询 -->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetTrfAgr" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=RTY999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Set>RslDes=数据库查询失败</Set>
            <Break/>
          </If> 
          <If condition="~RetCod=-2">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=RTY999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Set>RslDes=没有签约记录</Set>
            <Break/>
          </If>
          <Set>TCusNm=DELBOTHSPACE($TCusNm)</Set>
          <Set>dbTCusNm=DELBOTHSPACE($dbTCusNm)</Set>
          <If condition="IS_NOEQUAL_STRING($TCusNm,$dbTCusNm)">
            <Set>RslDes=帐户姓名不符</Set>
            <Break/>
          </If>
          <Set>TCusId=$dbTCusId</Set>
          <Break/>
        </Case>
  
      
        <Case value="2" > <!-- 查询并绑定 -->
          <Exec func="PUB:ReadRecord" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="GetTrfAgr" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Set>MsgTyp=E</Set>
            <Set>RspCod=RTY999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Set>RslDes=数据库查询失败</Set>
            <Break/>
          </If> 
          <If condition="~RetCod=-2"> <!--没有签约记录-->
            <!--上主机取客户资料，校验姓名-->
            
            <!--Exec func="PUB:InitTransaction"/-->      <!--交易初始化,预留-->
            <Set>TTxnCd=481517</Set>
            <Set>TlrId=EPCLBI1</Set>
            <Set>CcyCod=CNY</Set>
            <Set>AcJudFunc=STRCAT(AcJud_,$BrNo)</Set>
            <Call function="$AcJudFunc">
              <Input name="ActNo|NewFlg|"/>
              <Output name="OActNo|ActCls|"/>
            </Call>
            <!--向主机查询账户信息-->
            <Switch expression="$ActCls">
              <Case value="2" /> <!-- 对私 -->
              <Case value="3" />
              <Case value="5" >             
                <If condition="INTCMP($ActCls,3,3)">
                   <Set>ActTyp=4</Set>
                </If>
                <Else>
                   <Set>ActTyp=2</Set>
                </Else>
                <Exec func="PUB:CallHostOther" error="IGNORE">
                  <Arg name="HTxnCd" value="476520"/>
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
                </Exec>
                <If condition="$MsgTyp!=N">
                  <Set>RspCod=TRF004</Set>
                  <Set>RspMsg=帐户不存在</Set>
                  <Set>RslDes=帐户不存在</Set>
                  <Break/>  
                </If>
                 
                <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
                <Set>TCusNm=DELBOTHSPACE($TCusNm)</Set>
                <Set>RspMsg=$TCusNm</Set>
                <If condition="IS_NOEQUAL_STRING($TCusNm,$ActNam)">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=TRF003</Set>
                  <Set>RspMsg=帐户姓名不符</Set>
                  <Set>RslDes=帐户姓名不符</Set>
                  <Break/>
                </If>
                <Exec func="PUB:ExecSql" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="InsTrfAgr" />
                  </Args>
                </Exec>
                <If condition="~RetCod=-1">
                  <Exec func="PUB:RollbackWork" error="IGNORE" />     
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=RTY999</Set>
                  <Set>RspMsg=数据库处理失败</Set>
                  <Set>RslDes=增加数据记录失败</Set>
                  <Return/>
                </If>
                <Break/>
              </Case>
              <Case value="0" /> <!-- 对公 -->
              <Case value="4" >
                <Set>ActTyp=1</Set>
                <!--上主机查询客户资料-->
                <Exec func="PUB:CallHostOther" error="IGNORE">
                  <Arg name="HTxnCd" value="109000"/>
                  <Arg name="ObjSvr" value="SHSTPUB1"/>
                </Exec>
                <If condition="$MsgTyp!=N">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=TRF004</Set>
                  <Set>RspMsg=帐户不存在</Set>
                  <Set>RslDes=帐户不存在</Set>
                  <Break/>
                </If>
                <!--校验账户名称、开户证件类型和开户证件号码-->
                <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
                <Set>TCusNm=DELBOTHSPACE($TCusNm)</Set>
                <If condition="IS_NOEQUAL_STRING($TCusNm,$ActNam)">
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=TRF003</Set>
                  <Set>RspMsg=账户名称不符</Set>
                  <Set>RslDes=账户名称不符</Set>
                  <Break/>
                </If>
                <Exec func="PUB:ExecSql" error="IGNORE">
                  <Args>
                    <Arg name="SqlCmd" value="InsTrfAgr" />
                  </Args>
                </Exec>
                <If condition="~RetCod=-1">
                  <Exec func="PUB:RollbackWork" error="IGNORE" />     
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=RTY999</Set>
                  <Set>RspMsg=数据库处理失败</Set>
                  <Set>RslDes=增加数据记录失败</Set>
                  <Return/>
                </If>
                <Break/>
              </Case>            
              <Default>
                  <Set>MsgTyp=E</Set>
                  <Set>RspCod=RTY999</Set>
                  <Set>RspMsg=帐户类型不存在</Set>
                  <Set>RslDes=帐户类型不存在</Set>
                  <Break/>
              </Default>
            </Switch>
          </If>
          <Else>
            <!--已经存在签约记录-->
            <Set>TCusNm=DELBOTHSPACE($TCusNm)</Set>
            <Set>dbTCusNm=DELBOTHSPACE($dbTCusNm)</Set>
            <If condition="IS_NOEQUAL_STRING($TCusNm,$dbTCusNm)">
              <Set>MsgTyp=E</Set>
              <Set>RspCod=TRF003</Set>
              <Set>RslDes=帐户姓名不符</Set>
              <Break/>
            </If>
            
            <Set>TCusId=STRCAT($dbTCusId,:,$TCusId)</Set>
            <Exec func="PUB:ExecSql" error="IGNORE">
              <Args>
                <Arg name="SqlCmd" value="UdpTrfAgr" />
              </Args>
            </Exec>
            <If condition="~RetCod=-1">
              <Exec func="PUB:RollbackWork" error="IGNORE" />     
              <Set>MsgTyp=E</Set>
              <Set>RspCod=RTY999</Set>
              <Set>RspMsg=数据库处理失败</Set>
              <Set>RslDes=更新数据库失败</Set>
              <Break/>
            </If>           
          </Else>
          <Break/>
        </Case>
        
        <Case value="3" > <!-- 修改签约资料 -->
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="UdpTrfAgr" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />     
            <Set>MsgTyp=E</Set>
            <Set>RspCod=RTY999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Set>RslDes=更新数据库失败</Set>
            <Break/>
          </If>
          <If condition="~RetCod=-2">
            <Exec func="PUB:RollbackWork" error="IGNORE" />     
            <Set>MsgTyp=E</Set>
            <Set>RspCod=RTY999</Set>
            <Set>RspMsg=没有对应签约记录</Set>
            <Set>RslDes=没有对应签约记录</Set>
            <Break/>
          </If>  
          <Break/>
        </Case>
      
        <Case value="4" > <!-- 取消签约关系 -->
          <Exec func="PUB:ExecSql" error="IGNORE">
            <Args>
              <Arg name="SqlCmd" value="DelTrfAgr" />
            </Args>
          </Exec>
          <If condition="~RetCod=-1">
            <Exec func="PUB:RollbackWork" error="IGNORE" />     
            <Set>MsgTyp=E</Set>
            <Set>RspCod=RTY999</Set>
            <Set>RspMsg=数据库处理失败</Set>
            <Set>RslDes=更新数据库失败</Set>
            <Break/>
          </If>
          <If condition="~RetCod=-2">
            <Exec func="PUB:RollbackWork" error="IGNORE" />     
            <Set>MsgTyp=E</Set>
            <Set>RspCod=RTY999</Set>
            <Set>RspMsg=没有对应签约记录</Set>
            <Set>RslDes=没有对应签约记录</Set>
            <Break/>
          </If>  
          <Break/>
        </Case>   
        <Default>
            <Set>RspCod=481903</Set>
            <Set>RspMsg=没此业务参数</Set>
            <Set>RslDes=没此业务参数</Set>
            <Break/>
        </Default>
      </Switch>   
     
      <Quote name="SetBkMsg"/>

    </FlowCtrl>
  </Transaction>

</Application>
