<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="CBS" code="257" trace="yes" >
<!--核心二期版 created by wishman-->
 <LibDeclare>
    <Library name="CBS" value="app/cbs/dll/cbs.so" />
 </LibDeclare>

 <TableDeclare>
    <Table name="CbsTxnJnl"   value="CbsTxnJnl" />
    <Table name="CbsCenTot"   value="CbsCenTot" />
    <Table name="CbsRunCtl"   value="CbsRunCtl" />
    <Table name="CbsQryJnl"   value="CbsQryJnl" />
    <Table name="CbsCenAgr"   value="CbsCenAgr" />    
 </TableDeclare>

 <BusDefDeclare>
  <Busdef name="AplCls"    value="257"/>
  <Busdef name="BusTyp_52" value="CBS52" />
  <Busdef name="BusTyp_51" value="CBS51" />
  <Busdef name="TxnCnl"    value="CBS" />
  <Busdef name="RT_SUCC"   value="I1000" /> <!--返码交易成功-->
  <Busdef name="RT_CENSTP" value="O3" /> <!--中心暂停-->
  <Busdef name="BrNo"      value="441999"/>
  <Busdef name="AAA_ZDJF"  value="94904"/> <!--3A主动缴费业务类型-->  
  <Busdef name="AAA_QYZZ"  value="94905"/> <!--3A签约转帐业务类型-->
  <Busdef name="CLRBANKNO"    value="301581000019" />
 </BusDefDeclare>

 <Define>
  <Macro name="DealDbErr"> <!-- 数据库操作出错处理 -->
      <If condition="~RetCod=-1">
        <Exec func="PUB:RollbackWork"/>
        <Set>MsgTyp=E</Set>
        <Set>RspCod=CBS999</Set>
        <Set>RspMsg=数据库处理失败</Set>
        <Return/>
      </If>
  </Macro>
  <Macro name="SendMsg_S01245"> <!-- 发送返回交易信息 -->
     <Set>RcvDpt=$OSndDpt</Set>
     <Set>@MSG.SDT=LTHDCBS1</Set>
     <Set>@MSG.STC=S01245</Set>
     <Exec func="PUB:SendMessage" error="IGNORE"/>
     <If condition="~RetCod !=0">
       <Set>RspCod=468888</Set>
     </If> 
  </Macro>
  <Macro name="SendThird_S01245"> <!-- 往第三方发送交易信息 -->
   <!--Set>RcvDpt=$OSndDpt</Set-->
   <Set>@MSG.FLG=1</Set>
   <Exec func="PUB:CallThirdOther" error="IGNORE">
     <Arg name="HTxnCd"  value="S01245"/>
     <Arg name="ObjSvr"  value="LTHDCBS1"/>
   </Exec>
   <If condition="~RetCod=-1">
      <Set>RspMsg=SendThird_S01245通讯超时</Set>
   </If>
   <ElseIf condition="~RetCod&lt;0">
      <Set>RspMsg=SendThird_S01245通讯出错</Set>
   </ElseIf>
  </Macro>

  <Macro name="SendThird_S00145"> <!-- 往第三方发送查询信息 -->
   <Set>@MSG.FLG=1</Set>
   <Exec func="PUB:CallThirdOther" error="IGNORE">
     <Arg name="HTxnCd"  value="S00145"/>
     <Arg name="ObjSvr"  value="LTHDCBS1"/>
   </Exec>
   <If condition="~RetCod=-1">
      <Set>RspMsg=SendThird_S00145通讯超时</Set>
   </If>
   <ElseIf condition="~RetCod&lt;0">
      <Set>RspMsg=SendThird_S00145通讯出错</Set>
   </ElseIf>
  </Macro>

  <Macro name="GetBusLog"> <!--取信息流水号-->
   <Exec  func="PUB:GetSeqNoCircle" error="IGNORE">
    <Args>
     <Arg name ='TblNam' value='CbsBasInf' />
     <Arg name ='SeqCol' value='BusLog' />
     <Arg name ='Len'    value='12'/>
     <Arg name ='ColNam'  value='BusLog' />
    </Args>
   </Exec>
   <If condition="~RetCod != 0">
    <Set>RspCod=CBS999</Set>
    <Set>RspMsg=取信息流水号BusLog失败,交易故障</Set>
    <Return />
   </If>
  </Macro>

  <Macro name="DealFapAcc"> <!--处理中央零余额扣帐流程-->
       <Set>HTxnCd=363412</Set>
       <Set>BilSts=P</Set>   
       <Set>SndAdr=$CrpOrgCd</Set>   
       <Set>NBilSts=Z</Set> <!--来帐处理成功后设成Z-->
       <Exec  func="PUB:InsertRecord"  error="IGNORE">
         <Args>
           <Arg name ='TblNam' value='CbsTxnJnl' />
         </Args>
       </Exec>
       <If condition='$SqlCod = -803'> 
       <Set>RspCod=CBS011</Set> 
         <Set>RspMsg=重复交易</Set>
         <Quote name="SendThird_S01245" />
         <Return />
       </If>
       <ElseIf condition='~RetCod != 0'>
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=数据库操作失败cbstxnjnl,返回出错</Set>
         <Quote name="SendThird_S01245" />
         <Return />
       </ElseIf>
       <Exec  func="PUB:CommitWork"  /> <!--提交数据库事务-->
       <Set>SqlUpdSts=UpdSucFap</Set>
       <Set>BilSts=$NBilSts</Set>
       <Set>RspCod=000000</Set>
       <Set>HRspCd= </Set>
       <Set>HLogNo= </Set>
       <Set>CnlFlg=0</Set> 
       
       <Set>ObjSvr=STHDFAP2</Set>
       <Set>BrNam=@BCFG.BrNam</Set>
       <Set>EleBk=@BCFG.EleBk</Set>
       <Set>APVchN=$LogNo</Set>
       <Set>BLogNo=$LogNo</Set>  <!--保留原流水号-->
       <Set>PayCod=$SubCod</Set>
       <Set>FinAre=999</Set>          
       <Set>ActNam=$RcvAct</Set>  <!--付款人帐号-->
       <Set>ANodNm=@BCFG.BrNam</Set>   <!--付款单位开户银行-->
       <Set>PyeAct=$SndAct</Set> <!--收款人帐号-->
       <Set>PyeNam=$SndNm</Set> <!--收款单位名称-->
       <Set>PyeBk=$SOpnBk</Set> <!--收款单位开户银行-->
       <Set>UdwDat=$ActDat</Set>  <!--签发日期-->          
       <Set>ActSqn=$AccSq11</Set> <!--入帐帐号顺序号-->
       <Set>ActNod=$CtlNod</Set>  <!--入帐网点-->
       <Set>StlMod=07</Set>   <!--结算方式-->          
       <Set>AthAmt=$TxnAmt</Set> <!--金额-->
       <Set>VInTlr=$TlrId</Set> <!--凭证登记录入员-->
       <Set>VRgNod=$CtlNod</Set> <!--凭证登记部门-->
       <Set>HSubCd=003</Set>    <!--主机交易子码 贷52101-->
       <Exec func="PUB:CallThirdOther" error="IGNORE">
         <Arg name="HTxnCd" value="$HTxnCd"/>
         <Arg name="ObjSvr" value="$ObjSvr"/>
       </Exec>       
       <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,-10),INTCMP(~RetCod,3,-2))"> <!--主机超时-->
         <Set>RspCod=CBS999</Set> 
         <Set>BilSts=F</Set> <!--来帐处理超时失败后设成F-->
         <Set>CnlFlg=1</Set> 
         <Set>SqlUpdSts=UpdComJnl</Set> 
       </If>
       <ElseIf condition="~RetCod!=0">
         <Set>RspCod=$TRspCd</Set>
         <Set>BilSts=F</Set> <!--来帐处理失败后设成F-->
         <Set>SqlUpdSts=UpdComJnl</Set> 
       </ElseIf> 
       <Else>
         <Set>OrgId=$LogNo</Set>
         <Set>LogNo=$BLogNo</Set>       
       </Else>              
       <Set>RspBak=$RspCod</Set>
       <Quote name="SendThird_S01245" />
       <Set>RspCod=$RspBak</Set>
       <Set>ActNo=SUBSTR($RcvAct,1,21)</Set>
       <Set>ActNm=$RcvNm</Set>
       <Set>NodNo=$CtlNod</Set>
       <Exec func="PUB:ExecSql" error="IGNORE">
         <Arg name="sql" value="$SqlUpdSts"/>
       </Exec>
       <If condition="~RetCod != 0">
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=数据库操作出错SqlUpdSts,交易异常</Set>
       </If>  
       <If condition="$CnlFlg= 1">
         <Exec func="PUB:CallThirdOther" error="IGNORE">
           <Arg name="HTxnCd" value="363419"/>
           <Arg name="ObjSvr" value="$ObjSvr"/>
         </Exec>       
       </If>                    
    <Return/>
  </Macro>

  <Macro name="DealPfaAcc"> <!--处理省零余额扣帐流程-->
       <Set>BilSts=P</Set>   
       <Set>SndAdr=$CrpOrgCd</Set>   
       <Set>NBilSts=Z</Set> <!--来帐处理成功后设成Z-->       
       <Set>PyeAct=$SndAct </Set> <!--收款人帐号-->
       <Set>PyeNam=$SndNm  </Set> <!--收款人名称-->
       <Set>PyeBNm=$SOpnBk </Set> <!--收款银行名-->
       <Set>PayAct=$RcvAct </Set> <!--付款人帐号-->
       <Set>PayNam=$RcvNm  </Set>  <!--付款人名称-->
       <Set>PayBNm=$ROpnBk </Set> <!--付款银行名-->
       <Set>VchDat=$ActDat </Set> <!--签发日期-->
       <Set>TOIFlg=O </Set> <!--交易方向-->
       <Set>VchSmr=机构实时扣款 </Set> <!--备注-->
       <Set>ActSqn=$AccSq11 </Set> <!--入帐帐号顺序号-->
       <Set>ActNod=$CtlNod </Set> <!--入帐网点-->
       <Set>NodNo=$CtlNod </Set> <!--凭证登记部门-->
       <Set>HSubCd=003 </Set> <!--借零余额户贷52101-->
       <Exec  func="PUB:InsertRecord"  error="IGNORE">
         <Args>
           <Arg name ='TblNam' value='CbsTxnJnl' />
         </Args>
       </Exec>
       <If condition='$SqlCod = -803'> 
       <Set>RspCod=CBS011</Set> 
         <Set>RspMsg=重复交易</Set>
         <Quote name="SendThird_S01245" />
         <Return />
       </If>
       <ElseIf condition='~RetCod != 0'>
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=数据库操作失败cbstxnjnl,返回出错</Set>
         <Quote name="SendThird_S01245" />
         <Return />
       </ElseIf>
       <Exec  func="PUB:CommitWork"  /> <!--提交数据库事务-->
       <Set>SqlUpdSts=UpdSucJnl</Set>
       <Set>BilSts=$NBilSts</Set>
       <Set>RspCod=000000</Set>
       <Set>HTxnCd=461181</Set> <!--主机交易码机构代收-->
       <Set>HRspCd= </Set>
       <Set>HLogNo= </Set>
       <Set>CnlFlg=0</Set> 
       <Exec func="PUB:CallThirdOther" error="IGNORE">
         <Arg name="HTxnCd" value="$HTxnCd"/>
         <Arg name="ObjSvr" value="STHDCBS1"/>
       </Exec>       
       <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,-10),INTCMP(~RetCod,3,-2))"> <!--主机超时-->
         <Set>RspCod=CBS999</Set> 
         <Set>BilSts=F</Set> <!--来帐处理超时失败后设成F-->
         <Set>CnlFlg=1</Set> 
         <Set>SqlUpdSts=UpdComJnl</Set> 
       </If>
       <ElseIf condition="~RetCod!=0">
         <Set>RspCod=$TRspCd</Set>
         <Set>BilSts=F</Set> <!--来帐处理失败后设成F-->
       </ElseIf>       
       <Set>RspBak=$RspCod</Set>
       <Quote name="SendThird_S01245" />
       <Set>RspCod=$RspBak</Set>
       <Set>ActNo=SUBSTR($RcvAct,1,21)</Set>
       <Set>ActNm=$RcvNm</Set>
       <Set>NodNo=$CtlNod</Set>
       <Exec func="PUB:ExecSql" error="IGNORE">
         <Arg name="sql" value="$SqlUpdSts"/>
       </Exec>
       <If condition="~RetCod != 0">
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=数据库操作出错SqlUpdSts,交易异常</Set>
       </If>  
       <If condition="$CnlFlg= 1">
          <Set>$OLogNo=LogNO</Set>
         <Exec func="PUB:CallThirdOther" error="IGNORE">
           <Arg name="HTxnCd" value="461189"/>
           <Arg name="ObjSvr" value="STHDCBS1"/>
         </Exec>       
       </If>                    
       <Return/>
  </Macro>  
  </Define>

 <Transaction code="465751" desc="接收EFT汇兑,汇兑退票请求处理">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>  
  <DynSentence name="QryReJnl">
   <Sentence>
    select RspCod from cbstxnjnl where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>TraKnd|SndBNo|SndDat|VchId|</Fields>
  </DynSentence>
  <DynSentence name="UpdSucJnl">
   <Sentence>
     update cbstxnjnl Set TRspCd='%s',PstNod='%s',NodNo='%s',BokAct='%s',BusTyp='%s',HTxnCd='%s',BilSts= '%s',RspCod='%s',HRspCd='%s',TckNo='%s',HLogNo='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>RspCod|PstNod|NodNo|ActNo|BusTyp|HTxnCd|BilSts|RspCod|HRspCd|TckNo|HLogNo|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
<!--
  <DynSentence name="UpdSucJnl">
   <Sentence>
     update cbstxnjnl Set TRspCd='%s',PstNod='%s',NodNo='%s',ActNo='%s',ActNm='%s',BusTyp='%s',HTxnCd='%s',BilSts= '%s',RspCod='%s',HRspCd='%s',TckNo='%s',HLogNo='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>RspCod|PstNod|NodNo|ActNo|ActNm|BusTyp|HTxnCd|BilSts|RspCod|HRspCd|TckNo|HLogNo|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
-->
  <DynSentence name="UpdComJnl">
   <Sentence>
     update cbstxnjnl Set TRspCd='%s',BilSts= '%s',RspCod='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>RspCod|BilSts|RspCod|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
  <DynSentence name="QryOrgJnl">
   <Sentence>
    select BilSts OBilsts from cbstxnjnl where TraKnd='%s'and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='0'
   </Sentence>
   <Fields>OTraKnd|OSndBNo|OSndDat|OVchId|</Fields>
  </DynSentence>
  <DynSentence name="QryAccSqn">
   <Sentence>
    select AccSq01,AccIn01 from CbsBnkInf where BrNo='%s'
   </Sentence>
   <Fields>BrNo|</Fields>
  </DynSentence>

  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <If condition="IS_EQUAL_STRING($MsgId,2202)">
      <!--汇兑业务-->
      <Set>MsgId=2222</Set>  
   </If>
   <ElseIf condition="IS_EQUAL_STRING($MsgId,2402)">
    <!--汇兑退票业务-->
    <Set>MsgId=2422</Set>  
    <!--查是否有原始流水-->   
    <Exec func="PUB:ReadRecord"  error="IGNORE">
     <Args>
      <Arg name="SqlCmd" value="QryOrgJnl" />
     </Args>
    </Exec>
    <If condition="~RetCod!=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取原始流水失败QryOrgJnl,但继续处理 </Set>
     <Set>MatFlg=0</Set>
    </If>
    <Else>
     <Set>MatFlg=1</Set>
    </Else>
   </ElseIf>   
   <Exec  func="CBS:CbsGetNodInfo"  error="IGNORE">
    <Args>
     <Arg name ='PBnkNo' value='$RcvBNo' />
    </Args>
   </Exec>
   <If condition="~RetCod !=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取行网点信息失败CbsGetNodInfo</Set>
     <Set>BrNo=441999</Set>
     <Set>CtlNod=441800</Set>
     <Set>CnlSub=441999</Set>
     <Set>BusNod=000000</Set>
   </If>
   <Set>NodNo=$CtlNod</Set>
   <Exec func="PUB:ReadRecord"  error="IGNORE">
     <Args>
      <Arg name="SqlCmd" value="QryAccSqn" />
     </Args>
   </Exec>

   <If condition="~RetCod!=0">
     <Set>AccSq01=00000</Set>
     <Set>AccIn01=00000</Set>
   </If>
   <Exec func="PUB:GetAppInfo" />
   <!--生成信息流水号-->
   <Quote name="GetBusLog"/>
   <!--取流水判断是否重复接收处理-->   
   <Exec func="PUB:ReadRecord"  error="IGNORE">
    <Args>
     <Arg name="SqlCmd" value="QryReJnl" />
    </Args>
   </Exec>
   <If condition="~RetCod=0">
     <!--已经接收处理则返回收妥回应-->
     <Set>RspCod=000000</Set>
     <Quote name="SendThird_S01245" />
     <Return/>
   </If>
   <ElseIf condition="~RetCod=-1"> 
     <!--数据库操作失败,则报错不作回应-->
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=数据库操作失败QryReJnl,不作回应</Set>
     <Return/>
   </ElseIf>   
   <Exec  func="PUB:GetLogNo" error="IGNORE"/> <!--取前置流水号-->
   <If condition="~RetCod != 0">
     <!--数据库操作失败,则报错不作回应-->
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取前置流水号失败,不作回应</Set>
     <Return />
   </If>
   <Exec func="PUB:GetVirtualTeller" error="IGNORE"/>
   <If condition="~RetCod != 0">
     <!--数据库操作失败,则报错-->
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取电子柜员失败</Set>
     <Set>TlrId=0000000</Set>
   </If>
   <Set>LAccFlg=0</Set>
   <!--Set>BokAct=$RcvAct</Set-->
   <Set>BokAct=SUBSTR($RcvAct,1,21)</Set>
   <Exec  func="CBS:CbsGetAccFlg"  error="IGNORE">
    <Args>
     <Arg name ='ActNo' value='$RcvAct'/>
    </Args>
   </Exec>   
   <Set>AccFlg=$LAccFlg</Set>
   <Set>BilSts=P</Set>
   
   <!--向交易记录表中插入流水BilSts=P-->
   <Exec  func="PUB:InsertRecord"  error="IGNORE">
    <Args>
     <Arg name ='TblNam' value='CbsTxnJnl'/>
    </Args>
   </Exec>
   <If condition='$SqlCod = -803'> <!--for db2 -->
     <Exec func="PUB:RollbackWork" error="IGNORE" />
     <Set>RspCod=000000</Set> <!--设置返回码成功 -->
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   <ElseIf condition='~RetCod != 0'>
     <Exec func="PUB:RollbackWork" error="IGNORE" />
     <Set>RspCod=CBS999</Set><!--引发人行重发 -->
     <Set>RspMsg=数据库操作失败cbstxnjnl,不作回应</Set>
     <Return />
   </ElseIf>
   <Exec  func="PUB:CommitWork"  /> <!--提交数据库事务-->
   <Set>RspCod=000000</Set> <!--设置返回码成功 -->
   <Quote name="SendThird_S01245" />
   <!--取电子柜员号错，不做自动入帐处理 -->
   <If condition="STRCMP($TlrId,0000000)=0">
     <Set>RspCod=CBS999</Set>
     <Set>BilSts=U</Set>
     <Set>SqlUpdSts=UpdComJnl</Set> 
     <Goto>LabDone</Goto>
   </If>
   <!--外币直接更新bilsts，不做自动入帐处理 -->
   <If condition="STRCMP($CCYCOD,CNY)!=0">
     <Set>RspCod=000000</Set>
     <Set>BilSts=U</Set>
     <Set>SqlUpdSts=UpdComJnl</Set> 
     <Goto>LabDone</Goto>
   </If>
   <!--20090422add,跨境人民币来帐不自动入帐-->
   <If condition="OR(IS_EQUAL_STRING($UsgCod,100),IS_EQUAL_STRING($UsgCod,101),IS_EQUAL_STRING($UsgCod,102),IS_EQUAL_STRING($UsgCod,103))">
     <Set>RspCod=000000</Set>
     <Set>BilSts=U</Set>
     <Set>SqlUpdSts=UpdComJnl</Set> 
     <Goto>LabDone</Goto>
   </If>      
   <!--退汇业务，不做自动入帐处理 -->
   <If condition="STRCMP($MsgId,2422) =0">
     <Set>RspCod=000000</Set>
     <Set>BilSts=U</Set>
     <Set>SqlUpdSts=UpdComJnl</Set> 
     <Goto>LabDone</Goto>
   </If>
   <If condition="INTCMP(STRLEN(DELBOTHSPACE($BokAct)),6,21)">
     <Set>RspCod=000000</Set>
     <Set>BilSts=U</Set>
     <Set>SqlUpdSts=UpdComJnl</Set> 
     <Goto>LabDone</Goto>
   </If>   
   <If condition='$LAccFlg != 0'> <!--对私处理-->
     <If condition='$LAccFlg = 1'> <!--对私处理卡-->
      <Set>ActFlg=2</Set><!--普通存折-->
      <Set>ActTyp=2</Set>
     </If>
     <If condition='$LAccFlg = 2'> <!--对私处理卡-->
       <Set>ActFlg=4</Set><!--卡-->
       <Set>ActTyp=4</Set>
     </If>
     <Set>ActNo=$BokAct</Set> <!--查询帐户-->
     <Set>OCcyCod=$CcyCod</Set> 
     <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="HTxnCd" value="476520"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
     </Exec>
     <Set>CcyCod=$OCcyCod</Set> 
     <If condition="$MsgTyp!=N">
      <Set>RspMsg=对私帐户不存在</Set>
      <Set>RspCod=000000</Set>
      <Set>BilSts=U</Set>
      <Set>SqlUpdSts=UpdComJnl</Set> 
      <Goto>LabDone</Goto>
     </If>
     <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
     <Set>RspMsg=$RcvNm</Set>
     <If condition="IS_NOEQUAL_STRING($RcvNm,$ActNam)">
      <Set>RspMsg=对私帐户名不符</Set>
      <Set>RspCod=000000</Set>
      <Set>BilSts=U</Set>
      <Set>SqlUpdSts=UpdComJnl</Set> 
      <Goto>LabDone</Goto>
     </If>
     <Set>BusTyp=$BusTyp_52</Set> <!--业务类型-->
     <Set>HTxnCd=471400</Set> <!--主机交易码-->
     <Set>BilSts=V</Set> <!--对私来帐自动入帐成功V-->
     <Set>CnlTyp=L</Set> <!--L－其他-->
     <Set>Mask=0000</Set> <!--预留-->
     <Set>TxnSub=002</Set> <!--交易子码-->
     <Set>IActNo1=$BokAct</Set> <!--对私客户帐号-->
     <Set>TxnAmt1=$TxnAmt</Set> 
     <Set>CcyCod1=$CCyCod</Set>
     <Set>VchCod=00000000</Set>
     <Set>PrtFlg=1</Set>  <!-- ‘0’不打印  ‘1’打印-->
     <Set>IActNo2=$AccIn01</Set><!--对私入帐所用52101内部帐号-->
     <Set>TxnAmt2=$TxnAmt</Set>
     <Set>CcyCod2=$CCyCod</Set>
     <Set>CcyTyp=1</Set><!--0-钞 1-汇-->
     <Set>VchChk=0</Set> <!--不监督-->
     <Set>PayMod=0</Set>
     <Set>PstNod=$BusNod</Set> <!--设批注部门-->
   </If>
   <Else> <!--对公处理-->
     <Set>PstNod=$CtlNod</Set> <!--设批注部门-->
     <If condition="STRLEN(DELBOTHSPACE($RcvAct))=18">
      <Set>ActNo=STRCAT(SUBSTR($BrNo,1,3),$RcvAct)</Set>
     </If>
     <Else>
      <Set>ActNo=$RcvAct</Set>
     </Else>
     <!--判断户名-->
     <Exec func="PUB:CallHostOther" error="IGNORE">
      <Arg name="HTxCd"  value="109000" />
      <Arg name="ObjSvr" value="SHSTPUB1" />
     </Exec>
     <If condition="~RetCod!=0">
      <Set>BilSts=U</Set>
      <Set>SqlUpdSts=UpdComJnl</Set> 
      <Goto>LabDone</Goto>
     </If>
     <If condition="STRCMP(DELBOTHSPACE($RcvNm),DELBOTHSPACE($ActNam))!=0">
      <Set>BilSts=U</Set>
      <Set>SqlUpdSts=UpdComJnl</Set> 
      <Set>RspCod=CBS001</Set>
      <Goto>LabDone</Goto>
     </If> <!--判断户名over-->     
     <Set>BusTyp=$BusTyp_52</Set> <!--业务类型-->
     <Set>HTxnCd=451820</Set> <!--主机交易码-->
     <Set>BilSts=Z</Set> <!--对公来帐处理成功后设成Z-->
     <Set>OActBk=$BrNo</Set> <!--出帐网点分行号-->
     <Set>OActBr=$CtlNod</Set> <!--出帐网点机构号-->
     <Set>OActSq=$AccSq01</Set><!--出帐账号的5210顺序号 -->

     <!--If condition="IS_EQUAL_STRING($TxnKnd,100201)">
       <Set>OActSq=$AccSq6</Set>
     </If-->

     <Set>CDFlg1=D</Set>       <!--借贷标志 D-借，C-贷     -->
     <Set>CcyCd1=$CCyCod</Set>       <!--货币代码-->
     <Set>AccMod=2</Set>       <!--入帐方式 2-AI户转CD户   -->
     <If condition="STRLEN(DELBOTHSPACE($RcvAct))=18">
      <Set>ActNo=STRCAT(SUBSTR($BrNo,1,3),$RcvAct)</Set>
     </If>
     <Else>
      <Set>ActNo=$RcvAct</Set>
     </Else>
     <Set>CDFlg2=C</Set>       <!--借贷标志 D-借，C-贷-->
     <Set>CcyCd2=$CCyCod</Set> <!--货币代码-->
     <Set>PyeAmt=$TxnAmt</Set> <!--入账金额-->
     <Set>RgCFlg=0</Set>       <!--登记贷方回单-->
   </Else>
   <Set>SqlUpdSts=UpdSucJnl</Set>
   <Exec func="PUB:CallHostOther" error="IGNORE"><!--上主机系统 -->
     <Arg name="HTxnCd" value="$HTxnCd" /><!--主机交易码 -->
     <Arg name="ObjSvr" value="SHSTPUB1" />
   </Exec>
   <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,-10),INTCMP(~RetCod,3,-2))"> <!--主机超时-->
    <Set>RspCod=CBS999</Set> 
    <Set>BilSts=U</Set> <!--来帐处理失败后设成U-->
    <Set>SqlUpdSts=UpdComJnl</Set> 
   </If>
   <ElseIf condition="~RetCod!=0">
    <Set>BilSts=U</Set> <!--来帐处理失败后设成U-->
   </ElseIf>
<Label>LabDone</Label>
   <Set>ActNo=SUBSTR($RcvAct,1,21)</Set>
   <Set>ActNm=$RcvNm</Set>
   <Exec func="PUB:ExecSql" error="IGNORE">
     <Arg name="sql" value="$SqlUpdSts"/>
   </Exec>
   <If condition="~RetCod != 0">
      <Exec func="PUB:RollbackWork" error="IGNORE" />
      <Set>RspCod=CBS999</Set>
     <Set>RspMsg=数据库操作出错SqlUpdSts,交易异常</Set>
   </If>      
  </FlowCtrl>                           
 </Transaction>

 <Transaction code="465757" desc="接收在线支付业务">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>  
  <DynSentence name="QryReJnl">
   <Sentence>
    select RspCod from cbstxnjnl where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>TraKnd|SndBNo|SndDat|VchId|</Fields>
  </DynSentence>
  <DynSentence name="UpdSucJnl">
   <Sentence>
     update cbstxnjnl Set PstNod='%s',NodNo='%s',BusTyp='%s',HTxnCd='%s',BilSts= '%s',RspCod='%s',HRspCd='%s',TckNo='%s',HLogNo='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>PstNod|NodNo|BusTyp|HTxnCd|BilSts|RspCod|HRspCd|TckNo|HLogNo|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
  <DynSentence name="UpdComJnl">
   <Sentence>
     update cbstxnjnl Set BilSts= '%s',RspCod='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>BilSts|RspCod|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
  <DynSentence name="QryAccSqn">
   <Sentence>
    select AccSq06 AccSq01,AccIn02 AccIn01 from CbsBnkInf where BrNo='%s'
   </Sentence>
   <Fields>BrNo|</Fields>
  </DynSentence>

  <FlowCtrl>  
   <Exec func="PUB:InitTransaction"/>
   <Set>MsgId=2212</Set>
   <Set>OCcyCod=$CcyCod</Set>
   <Exec func="PUB:GetAppInfo" />
   <!--生成信息流水号-->
   <Quote name="GetBusLog"/>
   <Exec  func="CBS:CbsGetNodInfo"  error="IGNORE">
    <Args>
     <Arg name ='PBnkNo' value='$RcvBNo' />
    </Args>
   </Exec>
   <If condition="~RetCod !=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取银行网点信息失败CbsGetNodInfo,即时返回错误</Set>
     <Quote name="SendThird_S01245" />     
     <Return/>
   </If>
   <Set>NodNo=$CtlNod</Set>
   <Exec func="PUB:ReadRecord"  error="IGNORE">
     <Args>
      <Arg name="SqlCmd" value="QryAccSqn" />
     </Args>
   </Exec>
   <If condition="~RetCod!=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取帐号顺序号失败,即时返回错误</Set>
     <Quote name="SendThird_S01245" />     
     <Return/>
   </If>

   <!--取流水判断是否重复接收处理-->   
   <Exec func="PUB:ReadRecord"  error="IGNORE">
    <Args>
     <Arg name="SqlCmd" value="QryReJnl" />
    </Args>
   </Exec>
   <If condition="~RetCod=0">
     <!--已经接收处理则返回处理结果-->
     <Quote name="SendThird_S01245" />
     <Return/>
   </If>
   <ElseIf condition="~RetCod=-1"> 
     <!--数据库操作失败-->
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=数据库操作失败QryReJnl,返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return/>
   </ElseIf>   
   <Exec  func="PUB:GetLogNo" error="IGNORE"/> <!--取前置流水号-->
   <If condition="~RetCod != 0">
     <!--数据库操作失败-->
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取前置流水号失败,返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   <!--外币不处理 -->
   <If condition="STRCMP($CCYCOD,CNY)!=0">
     <Set>RspCod=CBS004</Set>
     <Set>RspMsg=该业务不受理，返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   <Exec func="PUB:GetVirtualTeller" error="IGNORE"/>
   <If condition="~RetCod != 0">
     <!--数据库操作失败-->
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取电子柜员失败,返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   <Set>LAccFlg=0</Set>
   <Set>BokAct=$RcvAct</Set>
   <Exec  func="CBS:CbsGetAccFlg"  error="IGNORE">
    <Args>
     <Arg name ='ActNo' value='$RcvAct' />
    </Args>
   </Exec>
   <Set>AccFlg=$LAccFlg</Set>
   <!--对公对私处理判断begin-->
   <If condition='$LAccFlg != 0'> <!--对私处理-->
     <If condition='$LAccFlg = 1'> <!--对私处理卡-->
      <Set>ActFlg=2</Set><!--普通存折-->
      <Set>ActTyp=2</Set>
     </If>
     <If condition='$LAccFlg = 2'> <!--对私处理卡-->
       <Set>ActFlg=4</Set><!--卡-->
       <Set>ActTyp=4</Set>
     </If>
     <Set>ActNo=$BokAct</Set> <!--查询帐户-->
     <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="HTxnCd" value="476520"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
     </Exec>
     <Set>CcyCod=$OCcyCod</Set>
     <If condition="$MsgTyp!=N">
       <Set>RspCod=CBS005</Set>
       <Set>RspMsg=对私帐户不存在</Set>
       <Quote name="SendThird_S01245" />
       <Return/>
     </If>
     <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
     <Set>RspMsg=$RcvNm</Set>
     <If condition="IS_NOEQUAL_STRING($RcvNm,$ActNam)">
       <Set>RspCod=CBS001</Set>
       <Set>RspMsg=对私帐户名不符</Set>
       <Quote name="SendThird_S01245" />
       <Return/>
     </If>
     <If condition="INTCMP(STRLEN(DELBOTHSPACE($BokAct)),6,21)">
       <Set>RspCod=CBS005</Set>
       <Set>RspMsg=对私帐户不存在</Set>
       <Quote name="SendThird_S01245" />
       <Return/>
     </If>        

     <Set>BusTyp=$BusTyp_52</Set> <!--业务类型-->
     <Set>HTxnCd=471400</Set> <!--主机交易码-->
     <Set>NBilSts=V</Set> <!--对私来帐入对帐成功V-->
     <Set>CnlTyp=L</Set> <!--L－其他-->
     <Set>Mask=0000</Set> <!--预留-->
     <Set>TxnSub=002</Set> <!--交易子码-->
     <Set>IActNo1=$BokAct</Set> <!--对私客户帐号-->
     <Set>TxnAmt1=$TxnAmt</Set> 
     <Set>CcyCod1=$CCyCod</Set>
     <Set>VchCod=00000000</Set>
     <Set>PrtFlg=1</Set>  <!-- ‘0’不打印  ‘1’打印-->
     <Set>IActNo2=$AccIn01</Set><!--对私入帐所用52101内部帐号-->
     <Set>TxnAmt2=$TxnAmt</Set>
     <Set>CcyCod2=$CCyCod</Set>
     <Set>CcyTyp=1</Set><!--0-钞 1-汇-->
     <Set>VchChk=0</Set> <!--不监督-->
     <Set>PayMod=0</Set>
     <Set>PstNod=$BusNod</Set> <!--设批注部门-->
   </If>
   <Else> <!--对公处理-->
     <Set>PstNod=$CtlNod</Set> <!--设批注部门-->
     <If condition="STRLEN(DELBOTHSPACE($RcvAct))=18">
      <Set>ActNo=STRCAT(SUBSTR($BrNo,1,3),$RcvAct)</Set>
     </If>
     <Else>
      <Set>ActNo=$RcvAct</Set>
     </Else>
     <!--判断户名-->
     <Exec func="PUB:CallHostOther" error="IGNORE">
      <Arg name="HTxCd"  value="109000" />
      <Arg name="ObjSvr" value="SHSTPUB1" />
     </Exec>
     <Set>CcyCod=$OCcyCod</Set>
     <If condition="~RetCod!=0">
       <Set>RspCod=CBS005</Set>
       <Set>RspMsg=对公账号不存在</Set>
       <Quote name="SendThird_S01245" />
       <Return />
     </If>
     <If condition="STRCMP(DELBOTHSPACE($RcvNm),DELBOTHSPACE($ActNam))!=0">
       <Set>RspCod=CBS001</Set>
       <Set>RspMsg=对公账号户名不符</Set>
       <Quote name="SendThird_S01245" />
       <Return />
     </If> <!--判断户名over-->     
     <Set>BusTyp=$BusTyp_52</Set> <!--业务类型-->
     <Set>HTxnCd=451820</Set> <!--主机交易码-->
     <Set>NBilSts=Z</Set> <!--来帐处理成功后设成Z-->
     <Set>OActBk=$BrNo</Set> <!--出帐网点分行号-->
     <Set>OActBr=$CtlNod</Set> <!--出帐网点机构号-->
     <Set>OActSq=$AccSq01</Set><!--出帐账号的5210顺序号 -->
     <!--If condition="IS_EQUAL_STRING($TxnKnd,100201)">
       <Set>OActSq=$AccSq6</Set>
     </If-->
     <Set>CDFlg1=D</Set>       <!--借贷标志 D-借，C-贷     -->
     <Set>CcyCd1=$CCyCod</Set>       <!--货币代码-->
     <Set>AccMod=2</Set>       <!--入帐方式 2-AI户转CD户   -->
     <If condition="STRLEN(DELBOTHSPACE($RcvAct))=18">
      <Set>ActNo=STRCAT(SUBSTR($BrNo,1,3),$RcvAct)</Set>
     </If>
     <Else>
      <Set>ActNo=$RcvAct</Set>
     </Else>
     <Set>CDFlg2=C</Set>       <!--借贷标志 D-借，C-贷-->
     <Set>CcyCd2=$CCyCod</Set> <!--货币代码-->
     <Set>PyeAmt=$TxnAmt</Set> <!--入账金额-->
     <Set>RgCFlg=0</Set>       <!--登记贷方回单-->
   </Else>
   <!--对公对私处理判断end-->

   <!--向交易记录表中插入流水BilSts=P-->
   <Set>BilSts=P</Set>   
   <Exec  func="PUB:InsertRecord"  error="IGNORE">
    <Args>
     <Arg name ='TblNam' value='CbsTxnJnl' />
    </Args>
   </Exec>
   <If condition='$SqlCod = -803'> 
     <Set>RspCod=CBS011</Set> 
     <Set>RspMsg=重复交易</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   <ElseIf condition='~RetCod != 0'>
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=数据库操作失败cbstxnjnl,返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </ElseIf>
   <Exec  func="PUB:CommitWork"  /> <!--提交数据库事务-->

   <Set>SqlUpdSts=UpdSucJnl</Set>
   <Set>BilSts=$NBilSts</Set>
   <Exec func="PUB:CallHostOther" error="IGNORE"><!--上主机系统 -->
     <Arg name="HTxnCd" value="$HTxnCd" /><!--主机交易码 -->
     <Arg name="ObjSvr" value="SHSTPUB1" />
   </Exec>
   <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,-10),INTCMP(~RetCod,3,-2))"> <!--主机超时-->
    <Set>RspCod=CBS999</Set> 
    <Set>BilSts=F</Set> <!--来帐处理失败后设成F-->
    <Set>SqlUpdSts=UpdComJnl</Set> 
   </If>
   <ElseIf condition="~RetCod!=0">
    <Set>RspCod=$HRspCd</Set>    
    <Set>BilSts=F</Set> <!--来帐处理失败后设成F-->
   </ElseIf>
<Label>LabDone</Label>
   <Set>RspBak=$RspCod</Set>
   <Quote name="SendThird_S01245" />
   <Set>RspCod=$RspBak</Set>
   <Set>ActNo=SUBSTR($RcvAct,1,21)</Set>
   <Set>ActNm=$RcvNm</Set>
   <Exec func="PUB:ExecSql" error="IGNORE">
     <Arg name="sql" value="$SqlUpdSts"/>
   </Exec>
   <If condition="~RetCod != 0">
    <Set>RspCod=CBS999</Set>
    <Set>RspMsg=数据库操作出错SqlUpdSts,交易异常</Set>
   </If>
         
  </FlowCtrl>                           
 </Transaction>


 <Transaction code="465752" desc="接收EFT同城人民币往帐清算通知">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>  
  <DynSentence name="Qry001">
   <Sentence>
    select BilSts OBilSts from cbstxnjnl where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='0'
   </Sentence>
   <Fields>TraKnd|SndBNo|SndDat|VchId|</Fields>
  </DynSentence>
  <DynSentence name="Upd001">
   <Sentence>
     update cbstxnjnl Set BilSts= '%s',ClrDat='%s',CenTm='%s',CenLog='%s',TRspCd='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='0'  and Bilsts='D'
   </Sentence>
   <Fields>BilSts|ClrDat|CenTm|CenLog|TRspCd|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <If condition="IS_EQUAL_STRING($MsgId,2210)">
      <!--汇兑支付业务-->
      <Set>MsgId=2212</Set>  
   </If>
   <ElseIf condition="IS_EQUAL_STRING($MsgId,2410)">
      <!--在线支付业务-->
     <Set>MsgId=2412</Set>   
   </ElseIf>
   <Quote name="GetBusLog"/> <!--生成信息流水号-->
   <Exec func="PUB:ReadRecord"  error="IGNORE">
    <Args>
     <Arg name="SqlCmd" value="Qry001" />
    </Args>
   </Exec>
   <If condition="~RetCod!=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=数据库操作出错Qry001,不作回应</Set>
     <Return/>
   </If>
   <!--If condition="IS_EQUAL_STRING(SUBSTR($TRntCd,1,2),$RT_CENSTP)">
     <Set>RspMsg=中心暂停处理业务</Set>
     <Return/>
   </If-->

   <If condition="IS_NOEQUAL_STRING($TRntCd,$RT_SUCC)">
     <Set>BilSts=b</Set>
   </If>
   <Else>
     <Set>BilSts=G</Set>
   </Else>
   <Exec func="PUB:ExecSql" error="IGNORE">
     <Arg name="sql" value="Upd001"/>
   </Exec>
   <If condition="~RetCod = -2">
    <If condition="IS_EQUAL_STRING($OBilSts,G)">
      <Set>RspMsg=原记录已清算</Set>
    </If>
   </If>      
   <ElseIf condition="~RetCod != 0">
      <Set>RspCod=CBS999</Set>
      <Set>RspMsg=数据库操作出错Upd001,不作回应</Set>
      <Return/>
   </ElseIf>      
   <If condition="IS_EQUAL_STRING($TRntCd,$RT_SUCC)">
     <Set>RspCod=000000</Set>
     <Quote name="SendThird_S01245" />
   </If>
  </FlowCtrl>
 </Transaction>

 <Transaction code="465761" desc="接收机构代收来帐扣帐业务">
   <!--贷52101科目 对私手续费26201科目 对公手续费26202科目-->
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>  
  <DynSentence name="QryReJnl">
   <Sentence>
    select RspCod from cbstxnjnl where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>TraKnd|SndBNo|SndDat|VchId|</Fields>
  </DynSentence>
  <DynSentence name="UpdSucJnl">
   <Sentence>
     update cbstxnjnl Set PstNod='%s',NodNo='%s',BokAct='%s',BusTyp='%s',HTxnCd='%s',BilSts= '%s',RspCod='%s',HRspCd='%s',TckNo='%s',HLogNo='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>PstNod|NodNo|ActNo|BusTyp|HTxnCd|BilSts|RspCod|HRspCd|TckNo|HLogNo|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
  <DynSentence name="UpdComJnl">
   <Sentence>
     update cbstxnjnl Set BilSts= '%s',RspCod='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>BilSts|RspCod|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
  <DynSentence name="UpdSucFap">
   <Sentence>
     update cbstxnjnl Set OrgId='%s',PstNod='%s',NodNo='%s',BokAct='%s',BusTyp='%s',HTxnCd='%s',BilSts= '%s',RspCod='%s',HRspCd='%s',TckNo='%s',HLogNo='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>OrgId|PstNod|NodNo|ActNo|BusTyp|HTxnCd|BilSts|RspCod|HRspCd|TckNo|HLogNo|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
  <DynSentence name="QryAccSqn">
   <Sentence>
    select AccSq11,AccSq02 FeeSeq  from CbsBnkInf where BrNo='%s'
   </Sentence>
   <Fields>BrNo|</Fields>
  </DynSentence>
  <DynSentence name="ChkCusAgr"><!--查询签约关系-->
    <Sentence>
               SELECT 'Y' YN from table(values(1)) as anony
               where exists(select * from CbsCenAgr
               where  AgrNo='%s' and  PayAct='%s' and status='1' )
    </Sentence>
    <Fields>ContNo|RcvAct|</Fields>
  </DynSentence>
  <DynSentence name="QryZZCusAgr">
   <Sentence>
    select LmtAmt,LmtAct,TlrId TlrMrk  from CbsCenAgr where AgrNo='%s' and SBusTy='%s' and status='1'  fetch first rows only
   </Sentence>
   <Fields>ContNo|AAA_QYZZ|</Fields>
  </DynSentence>  
  <DynSentence name="QryPfaCusAgr">
   <Sentence>
    select PfaSub,BCusId,SubCod,EConTp,PrjCod,DptCod  from PfaCusAgr where AgrNo='%s'
   </Sentence>
   <Fields>ContNo|</Fields>
  </DynSentence>
  <DynSentence name="QrySumAmt">   <!--检查每日金额限额-->
    <Sentence>
      SELECT coalesce(SUM(cast(TxnAmt as bigint)),0) SUMAMT
      FROM cbsTxnJnl
      WHERE  ActDat='%s' and  TBusTp='%s' and RcvAct='%s'
    </Sentence>
    <Fields>ActDat|AAA_QYZZ|RcvAct|</Fields>
  </DynSentence>
  
  
  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <Set>MsgId=2212</Set>
    <Set>OTxnAmt=$TxnAmt</Set>
   <Exec func="PUB:GetAppInfo" />
   <!--生成信息流水号-->
   <Quote name="GetBusLog"/>
   <Exec  func="CBS:CbsGetNodInfo"  error="IGNORE">
    <Args>
     <Arg name ='PBnkNo' value='$RcvBNo' />
    </Args>
   </Exec>
   <If condition="~RetCod !=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取银行网点信息失败CbsGetNodInfo,即时返回错误</Set>
     <Quote name="SendThird_S01245" />     
     <Return/>
   </If>
   <Exec func="PUB:ReadRecord"  error="IGNORE">
     <Args>
      <Arg name="SqlCmd" value="QryAccSqn" />
     </Args>
   </Exec>
   <If condition="~RetCod!=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取帐号顺序号失败,即时返回错误</Set>
     <Quote name="SendThird_S01245" />     
     <Return/>
   </If>
   <Exec func="PUB:ReadRecord" error="IGNORE" >
      <Arg name="SqlCmd" value="ChkCusAgr" />
   </Exec>
   <If condition="~RetCod !=0">
      <Set>RspCod=CBS017</Set>
      <Set>RspMsg=未签约</Set>
      <Quote name="SendThird_S01245" />     
      <Return/>
   </If>                      
   
   <!--取流水判断是否重复接收处理-->   
   <Exec func="PUB:ReadRecord"  error="IGNORE">
    <Args>
     <Arg name="SqlCmd" value="QryReJnl" />
    </Args>
   </Exec>
   <If condition="~RetCod=0">
     <!--已经接收处理则返回处理结果-->
     <Quote name="SendThird_S01245" />
     <Return/>
   </If>
   <ElseIf condition="~RetCod=-1"> 
     <!--数据库操作失败-->
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=数据库操作失败QryReJnl,返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return/>
   </ElseIf>   
   <Exec  func="PUB:GetLogNo" error="IGNORE"/> <!--取前置流水号-->
   <If condition="~RetCod != 0">
     <!--数据库操作失败-->
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取前置流水号失败,返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   <!--外币不处理 -->
   <If condition="STRCMP($CCYCOD,CNY)!=0">
     <Set>RspCod=CBS004</Set>
     <Set>RspMsg=该业务不受理，返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   <Exec func="PUB:GetVirtualTeller" error="IGNORE"/>
   <If condition="~RetCod != 0">
     <!--数据库操作失败-->
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取电子柜员失败,返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
    <If condition="IS_EQUAL_STRING($TBusTp,$AAA_QYZZ)"> <!--转帐业务判断,限额判断,算手续费-->
     <Exec func="PUB:ReadRecord"  error="IGNORE">
      <Args>
       <Arg name="SqlCmd" value="QryZZCusAgr" />
      </Args>
     </Exec>   
     <If condition="~RetCod != 0">
       <!--数据库操作失败-->
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=协议表操作失败,返回出错</Set>
         <Quote name="SendThird_S01245" />
         <Return />
     </If>       
     <If condition="INTCMP($TxnAmt,6,$LmtAmt)">
         <Set>RspCod=CBS018</Set>
         <Set>RspMsg=金额超限,返回不成功</Set>
         <Quote name="SendThird_S01245" />
         <Return />       
     </If>
     <If condition="NOT(ISNULL(DELBOTHSPACE($LmtAct)))">    
       <If condition="INTCMP(GETSTRPOS($LmtAct,$SndAct),1,0)">
         <Set>RspCod=CBS019</Set>
         <Set>RspMsg=收款帐号未登记,返回不成功</Set>
         <Quote name="SendThird_S01245" />
        <Return/>
       </If>  
     </If>
      <Exec func="PUB:ReadRecord"  error="IGNORE">
       <Args>
        <Arg name="SqlCmd" value="QrySumAmt" />
       </Args>
      </Exec>
      <If condition="~RetCod != 0">
       <!--数据库操作失败-->
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=协议表操作失败,返回出错</Set>
         <Quote name="SendThird_S01245" />
         <Return />
      </If>                  
      <!--每日累计交易额不能超过签约转帐的最高额度-->
      <Set>TotAmt=ADD(AMTDELZERO($TxnAmt),$SUMAMT)</Set>
      <If condition="INTCMP($TotAmt,6,$LmtAmt)">
         <Set>RspCod=CBS018</Set>
         <Set>RspMsg=金额超限,返回不成功</Set>
         <Quote name="SendThird_S01245" />
         <Return />       
      </If>             

       <Exec func="CBS:CbsGetFee" error="IGNORE">
        <Args>
          <Arg name="TxnKnd" value="$TxnKnd"/>
          <Arg name="UsgCod" value="014"/>
          <Arg name="LclFlg" value="0"/>
          <Arg name="BrNo"   value="$BrNo"/>
          <Arg name="CcyCod" value="$CcyCod"/>
          <Arg name="TxnAmt" value="$TxnAmt"/>
        </Args>
       </Exec>
       <If condition="~RetCod != 0">
       <!--数据库操作失败-->
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=转帐算手续费失败,返回出错</Set>
         <Quote name="SendThird_S01245" />
         <Return />
       </If>
       <If condition="IS_EQUAL_STRING(SUBSTR($TlrMrk,1,1),0)">
         <Set>FeeAmt=ADDCHAR(0,15,0,1)</Set>
       </If>
   </If>
   
   <Set>LAccFlg=0</Set>
   <Set>BokAct=$RcvAct</Set>
   <Exec  func="CBS:CbsGetAccFlg"  error="IGNORE">
    <Args>
     <Arg name ='ActNo' value='$RcvAct' />
    </Args>
   </Exec>
   <Set>AccFlg=$LAccFlg</Set>      
   <!--对公对私处理判断begin-->
   <If condition='$LAccFlg != 0'> <!--对私处理-->     
     <If condition='$LAccFlg = 1'> <!--对私处理普通存折-->
      <Set>ActFlg=2</Set><!--普通存折-->
      <Set>ActTyp=2</Set>
     </If>
     <If condition='$LAccFlg = 2'> <!--对私处理卡-->
       <Set>ActFlg=4</Set><!--卡-->
       <Set>ActTyp=4</Set>
     </If>
     <Set>PstNod=$BusNod</Set> <!--设批注部门-->
     <Set>ActNo=$BokAct</Set> <!--查询帐户-->
     <Set>OCcyCod=$CcyCod</Set> 
     <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="HTxnCd" value="476520"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
     </Exec>
     <Set>CcyCod=$OCcyCod</Set> 
     <If condition="$MsgTyp!=N">
       <Set>RspCod=CBS005</Set>
       <Set>RspMsg=对私帐户不存在</Set>
       <Quote name="SendThird_S01245" />
       <Return/>
     </If>
     <Set>ActNam=DELBOTHSPACE($ActNam)</Set>
     <Set>RspMsg=$RcvNm</Set>
     <If condition="IS_NOEQUAL_STRING($RcvNm,$ActNam)">
       <Set>RspCod=CBS001</Set>
       <Set>RspMsg=对私帐户名不符</Set>
       <Quote name="SendThird_S01245" />
       <Return/>
     </If>

     <Set>BusTyp=$BusTyp_51</Set> <!--业务类型-->
     <Set>HTxnCd=472280</Set> <!--主机交易码机构代收-->
     <Set>NBilSts=V</Set> <!--对私来帐入对帐成功V-->
     <Set>CnlTyp=L</Set> <!--L－其他-->
     
     <If condition='$LAccFlg = 1'> <!--对私处理普通存折-->
      <Set>VchTyp=$VchCod</Set> <!--凭证种类 -->
      <Set>VchCod=00000000</Set> <!--凭证号码 -->
     </If>
     <ElseIf condition='$LAccFlg = 2'> <!--对私处理卡-->
      <Set>VchTyp=007</Set> <!--凭证种类 -->
      <Set>VchCod=00000000</Set> <!--凭证号码 -->
     </ElseIf>

     <Set>CcyCod=$CcyCod0</Set> <!--货币-->     
     <Set>ActNo=$BokAct</Set>
     <Set>PayMod=0</Set> <!--0不验密-->
     <Set>TrkMod=0</Set> <!--0不校验磁道信息-->     
     <Set>TxnSub=001</Set> <!--交易子码-->
     <Set>Mask=0805</Set>  <!--摘要码-->
     <Set>VchChk=0</Set>   <!--0不监督-->
     <Set>CAgtNo=CBS9999999</Set>
     <Set>IBrNo=$BrNo</Set>  <!--入账分行号-->
     <Set>IActNo=$CtlNod</Set> <!--入账机构号-->
     <Set>ActSeq=$AccSq11</Set> <!--帐序号-->
      <If condition="IS_EQUAL_STRING($TBusTp,$AAA_QYZZ)"> <!--转帐计手续费-->
        <Set>Fee=ADDCHAR(ADD(0,$FeeAmt),15,0,1)</Set>
        <Set>FeeCod=0000</Set>
        <Set>FeeBr=$BrNo</Set>
        <Set>FeeNo=$CtlNod</Set>        
     </If>
   </If><!--对私预处理结束-->
   
   <Else> <!--对公预处理-->
     <Set>ActFlg=0</Set><!--对公-->
     <Set>PstNod=$CtlNod</Set> <!--设批注部门-->
     <If condition="STRLEN(DELBOTHSPACE($RcvAct))=18">
      <Set>ActNo=STRCAT(SUBSTR($BrNo,1,3),$RcvAct)</Set>
     </If>
     <Else>
      <Set>ActNo=$RcvAct</Set>
     </Else>
     <!--判断户名-->
     <Exec func="PUB:CallHostOther" error="IGNORE">
      <Arg name="HTxCd"  value="109000" />
      <Arg name="ObjSvr" value="SHSTPUB1" />
     </Exec>
     <If condition="~RetCod!=0">
       <Set>RspCod=CBS005</Set>
       <Set>RspMsg=对公账号不存在</Set>
       <Quote name="SendThird_S01245" />
       <Return />
     </If>
     <If condition="STRCMP(DELBOTHSPACE($RcvNm),DELBOTHSPACE($ActNam))!=0">
       <Set>RspCod=CBS001</Set>
       <Set>RspMsg=对公账号户名不符</Set>
       <Quote name="SendThird_S01245" />
       <Return />
     </If> <!--判断户名over-->          
     <If condition="IS_EQUAL_STRING($ComTyp,04)"> <!--零余额账户处理-->
       <Exec func="PUB:ReadRecord" error="IGNORE" >
         <Arg name="SqlCmd" value="QryPfaCusAgr" />
       </Exec>
       <If condition="~RetCod !=0">
         <Set>RspCod=CBS017</Set>
         <Set>RspMsg=未签约</Set>
         <Quote name="SendThird_S01245" />     
         <Return/>
       </If>  
       <If condition="IS_EQUAL_STRING($PfaSub,999)"> <!--中央零余额账户处理-->
          <Quote name="DealFapAcc"/>     
       </If>
       <Else>
         <Quote name="DealPfaAcc"/> <!--省零余额账户处理-->
       </Else>                   
     </If><!--零余额账户处理over-->
     <Set>NBilSts=Z</Set> <!--来帐处理成功后设成Z-->
     <Set>HTxnCd=451900</Set> <!--主机交易码-->
     <If condition="STRLEN(DELBOTHSPACE($RcvAct))=18">
      <Set>ActNo=STRCAT(SUBSTR($BrNo,1,3),$RcvAct)</Set>
     </If>
     <Else>
      <Set>ActNo=$RcvAct</Set>
     </Else>     
     <Set>BusTyp=LBE56</Set> <!--业务类型-->          
     <Set>RgDFlg=0</Set> <!--登记借方回单-->
     <Set>PayAt1=$ActNo</Set> <!--扣款帐户-->
     <Set>RGFlg1=0</Set>
     <Set>CDFlg1=D</Set>
     <Set>CcyCd1=$CcyCod</Set>
     <Set>OuAmt1=$TxnAmt</Set>               
     <Set>VchTyp=000</Set> 
     <Set>VchFlg=0</Set>   <!--凭证控制标志 0-否 1-是 默认0 -->     
     <Set>VchNo=0000000</Set> <!---->
     <Set>ActBk5=$BrNo</Set>   <!--以下为贷方数据-->
     <Set>ActBr5=$CtlNod</Set>
     <Set>ActSq5=$AccSq11</Set>
     <Set>OvrSe5=0</Set>
     <Set>RGFlg5=0</Set>
     <Set>CDFlg5=C</Set>
     <Set>CcyCd5=$CcyCod</Set>
     <Set>InAmt5=$TxnAmt</Set>     
      <If condition="IS_EQUAL_STRING($TBusTp,$AAA_QYZZ)"> <!--转帐计手续费-->
       <Set>PayAt2=$ActNo</Set> <!--扣款帐户-->
       <Set>RGFlg2=0</Set>
       <Set>CDFlg2=D</Set>
       <Set>CcyCd2=$CcyCod</Set>
       <Set>OuAmt2=ADDCHAR(ADD(0,$FeeAmt),15,0,1)</Set>

       <Set>ActBk6=$BrNo</Set>   <!--以下为贷方数据-->
       <Set>ActBr6=$CtlNod</Set>
       <Set>ActSq6=$FeeSeq</Set>
       <Set>OvrSe6=0</Set>
       <Set>RGFlg6=0</Set>
       <Set>CDFlg6=C</Set>
       <Set>CcyCd6=$CcyCod</Set>
       <Set>InAmt6=ADDCHAR(ADD(0,$FeeAmt),15,0,1)</Set>       
     </If>
   </Else><!--对公预处理结束-->
 
   <!--向交易记录表中插入流水BilSts=P-->
   <Set>BilSts=P</Set>   
   <Set>SndAdr=$CrpOrgCd</Set>   
   <Exec  func="PUB:InsertRecord"  error="IGNORE">
    <Args>
     <Arg name ='TblNam' value='CbsTxnJnl' />
    </Args>
   </Exec>
   <If condition='$SqlCod = -803'> 
     <Set>RspCod=CBS011</Set> 
     <Set>RspMsg=重复交易</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   <ElseIf condition='~RetCod != 0'>
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=数据库操作失败cbstxnjnl,返回出错</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </ElseIf>
   <Exec  func="PUB:CommitWork"  /> <!--提交数据库事务-->

   <Set>SqlUpdSts=UpdSucJnl</Set>
   <Set>BilSts=$NBilSts</Set>
   <Exec func="PUB:CallHostOther" error="IGNORE"><!--上主机系统 -->
     <Arg name="HTxnCd" value="$HTxnCd" /><!--主机交易码 -->
     <Arg name="ObjSvr" value="SHSTPUB1" />
   </Exec>
   <If condition="OR(INTCMP(~RetCod,3,-1),INTCMP(~RetCod,3,-10),INTCMP(~RetCod,3,-2))"> <!--主机超时-->
    <Set>RspCod=CBS999</Set> 
    <Set>BilSts=F</Set> <!--来帐处理超时失败后设成F-->
    <Set>SqlUpdSts=UpdComJnl</Set> 
   </If>
   <ElseIf condition="~RetCod!=0">
    <Set>RspCod=$HRspCd</Set>
    <Set>BilSts=F</Set> <!--来帐处理失败后设成F-->
   </ElseIf>
   <Set>RspBak=$RspCod</Set>
   <Quote name="SendThird_S01245" />
   <Set>RspCod=$RspBak</Set>
   <Set>ActNo=SUBSTR($RcvAct,1,21)</Set>
   <Set>ActNm=$RcvNm</Set>
   <Set>NodNo=$CtlNod</Set>
   <Exec func="PUB:ExecSql" error="IGNORE">
     <Arg name="sql" value="$SqlUpdSts"/>
   </Exec>
   <If condition="~RetCod != 0">
    <Set>RspCod=CBS999</Set>
    <Set>RspMsg=数据库操作出错SqlUpdSts,交易异常</Set>
   </If>      
  </FlowCtrl>                           
 </Transaction>


 <Transaction code="465752" desc="接收EFT同城人民币往帐清算通知">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>  
  <DynSentence name="Qry001">
   <Sentence>
    select BilSts OBilSts from cbstxnjnl where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='0'
   </Sentence>
   <Fields>TraKnd|SndBNo|SndDat|VchId|</Fields>
  </DynSentence>
  <DynSentence name="Upd001">
   <Sentence>
     update cbstxnjnl Set BilSts= '%s',ClrDat='%s',CenTm='%s',CenLog='%s',TRspCd='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='0'  and Bilsts='D'
   </Sentence>
   <Fields>BilSts|ClrDat|CenTm|CenLog|TRspCd|TraKnd|SndBNo|SndDat|VchId|</Fields>  
  </DynSentence>
  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <If condition="IS_EQUAL_STRING($MsgId,2210)">
      <!--汇兑支付业务-->
      <Set>MsgId=2212</Set>  
   </If>
   <ElseIf condition="IS_EQUAL_STRING($MsgId,2410)">
      <!--在线支付业务-->
     <Set>MsgId=2412</Set>   
   </ElseIf>
   <Quote name="GetBusLog"/> <!--生成信息流水号-->
   <Exec func="PUB:ReadRecord"  error="IGNORE">
    <Args>
     <Arg name="SqlCmd" value="Qry001" />
    </Args>
   </Exec>
   <If condition="~RetCod!=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=数据库操作出错Qry001,不作回应</Set>
     <Return/>
   </If>
   <!--If condition="IS_EQUAL_STRING(SUBSTR($TRntCd,1,2),$RT_CENSTP)">
     <Set>RspMsg=中心暂停处理业务</Set>
     <Return/>
   </If-->

   <If condition="IS_NOEQUAL_STRING($TRntCd,$RT_SUCC)">
     <Set>BilSts=b</Set>
   </If>
   <Else>
     <Set>BilSts=G</Set>
   </Else>
   <Exec func="PUB:ExecSql" error="IGNORE">
     <Arg name="sql" value="Upd001"/>
   </Exec>
   <If condition="~RetCod = -2">
    <If condition="IS_EQUAL_STRING($OBilSts,G)">
      <Set>RspMsg=原记录已清算</Set>
    </If>
   </If>      
   <ElseIf condition="~RetCod != 0">
      <Set>RspCod=CBS999</Set>
      <Set>RspMsg=数据库操作出错Upd001,不作回应</Set>
      <Return/>
   </ElseIf>      
   <If condition="IS_EQUAL_STRING($TRntCd,$RT_SUCC)">
     <Set>RspCod=000000</Set>
     <Quote name="SendThird_S01245" />
   </If>
  </FlowCtrl>
 </Transaction>


<Transaction code="465753" desc="接收中心对帐合计信息">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>  
  <DynSentence name="Qry001">
   <Sentence>
    select TraTm from cbscentot where CTraKnd='%s' and DBrCd='%s' and ClrDat='%s' and AreaNo='%s' and CcyCod='%s'
   </Sentence>
   <Fields>CTraKnd|DBrCd|ClrDat|AreaNo|CcyCod|</Fields>
  </DynSentence>
  <DynSentence name="Del001">
   <Sentence>
    delete from cbscentot where CTraKnd='%s' and DBrCd='%s' and ClrDat='%s' and AreaNo='%s' and CcyCod='%s'
   </Sentence>
   <Fields>CTraKnd|DBrCd|ClrDat|AreaNo|CcyCod|</Fields>
  </DynSentence>

  <FlowCtrl>
    <Exec func="PUB:InitTransaction"/>
    <Exec func="PUB:ReadRecord"  error="IGNORE">
     <Args>
      <Arg name="SqlCmd" value="Qry001" />
     </Args>
    </Exec>
    <If condition="~RetCod=0">
      <Exec func="PUB:ExecSql" >
        <Arg name="sql" value="Del001"/>
      </Exec>     
    </If>
   <ElseIf condition="~RetCod!=-2">
      <Set>RspCod=CBS999</Set>
      <Set>RspMsg=数据库操作出错Sql001,不能接收中心对帐合计信息</Set>
      <Return/>
   </ElseIf>
   <Exec  func="PUB:InsertRecord" >
    <Args>
     <Arg name ='TblNam' value='CbsCenTot' />
    </Args>
   </Exec>
  </FlowCtrl>
 </Transaction>

<Transaction code="465754" desc="接收登陆中心返回信息">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>  
  <DynSentence name="UpdSuc">
   <Sentence>
    update CbsRunCtl set LogFlg='1',Smr='%s' where substr(txnKnd,1,4)='%s'  or '0000'='%s'
   </Sentence>
   <Fields>Smr|CTraKnd|CTraKnd|</Fields>
  </DynSentence>
  <DynSentence name="UpdFai">
   <Sentence>
    update CbsRunCtl set Smr='%s' where substr(txnKnd,1,4)='%s' or '0000'='%s'
   </Sentence>
   <Fields>Smr|CTraKnd|CTraKnd|</Fields>
  </DynSentence>

  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <Set>Smr=*</Set>
   <If condition="STRCMP($TRntCd,I1000)=0">
      <Set>Smr=STRCAT(登陆工作日,$CenTm,受理号,$CenLog,返回码,$TRspCd,$Smr)</Set>
      <Exec func="PUB:ExecSql" >
        <Arg name="sql" value="UpdSuc"/>
      </Exec>        
    </If>
   <ElseIf condition="STRCMP($TRntCd,W1001)=0">
      <Set>Smr=STRCAT(重复登陆返回码,$TRspCd,$Smr)</Set>
      <Exec func="PUB:ExecSql" >
        <Arg name="sql" value="UpdFai"/>
      </Exec>        
   </ElseIf>
   <Else>
      <Set>Smr=STRCAT(登陆失败返回码,$TRspCd,$Smr)</Set>
      <Exec func="PUB:ExecSql" >
        <Arg name="sql" value="UpdFai"/>
      </Exec>        
   </Else>
  </FlowCtrl>
 </Transaction>


<Transaction code="465755" desc="接收退出中心返回信息">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>  
  <DynSentence name="UpdSuc">
   <Sentence>
    update CbsRunCtl set LogFlg='0',Smr='%s' where substr(txnKnd,1,4)='%s' or '0000'='%s'
   </Sentence>
   <Fields>Smr|CTraKnd|CTraKnd|</Fields>
  </DynSentence>
  <DynSentence name="UpdFai">
   <Sentence>
    update CbsRunCtl set Smr='%s' where substr(txnKnd,1,4)='%s' or '0000'='%s'
   </Sentence>
   <Fields>Smr|CTraKnd|CTraKnd|</Fields>
  </DynSentence>

  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <Set>Smr=*</Set>
   <If condition="STRCMP($TRntCd,I1000)=0">
      <Set>Smr=STRCAT(退出工作日,$CenTm,受理号,$CenLog,返回码,$TRspCd,$Smr)</Set>
      <Exec func="PUB:ExecSql" >
        <Arg name="sql" value="UpdSuc"/>
      </Exec>        
    </If>
   <ElseIf condition="STRCMP($TRntCd,W1002)=0">
      <Set>Smr=STRCAT(重复退出返回码,$TRspCd,$Smr)</Set>
      <Exec func="PUB:ExecSql" >
        <Arg name="sql" value="UpdFai"/>
      </Exec>        
   </ElseIf>
   <Else>
      <Set>Smr=STRCAT(退出失败返回码,$TRspCd,$Smr)</Set>
      <Exec func="PUB:ExecSql" >
        <Arg name="sql" value="UpdFai"/>
      </Exec>        
   </Else>
  </FlowCtrl>
 </Transaction>

<Transaction code="465756" desc="接收系统状态变更信息">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>
  <DynSentence name="Upd01">
   <Sentence>
    update CbsRunCtl set SysSts='%s',TraTm='%s',Smr='%s'
   </Sentence>
   <Fields>SysSts|TraTm|Smr|</Fields>
  </DynSentence>
  <DynSentence name="Upd03">
   <Sentence>
    update CbsRunCtl set WorkDt='%s',TraTm='%s',Smr='%s' where txnknd='%s'
   </Sentence>
   <Fields>CClrDat|TraTm|Smr|SubKnd</Fields>
  </DynSentence>

  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <Set>Smr=*</Set>
   <If condition="IS_NOEQUAL_STRING($SysSts,03)">
    <Exec func="PUB:ExecSql" >
     <Arg name="sql" value="Upd01"/>
    </Exec>        
    <Return/>
   </If>
   <Set>TmpLen=STRLEN($CKndInf)</Set>
   <Set>TmpCnt=DIV($TmpLen,6)</Set>
   <Set>TmpPos=1</Set>
   <Set>TmpNum=1</Set>
   <While>
    <If condition="INTCMP($TmpNum,6,$TmpCnt)">
     <Break/>
    </If>
     <Set>SubKnd=SUBSTR($CKndInf,$TmpPos,6)</Set>
     <Set>TmpPos=ADD($TmpPos,6)</Set>
     <Set>TmpNum=ADD($TmpNum,1)</Set>
    <Exec func="PUB:ExecSql" >
     <Arg name="sql" value="Upd03"/>
    </Exec>       
   </While>   
  </FlowCtrl>
 </Transaction>

<Transaction code="465758" desc="接收银银间发起通用通知信息">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>
  <DynSentence name="Qry001">
   <Sentence>
    select * from cbsQryjnl where TxnKnd='%s' and SndBNo='%s' and SndDat='%s' and MsgSeq='%s' and OIFlag='1'
   </Sentence>
   <Fields>TxnKnd|SndBNo|SndDat|MsgSeq|</Fields>
  </DynSentence>
  <DynSentence name="Qry002">
   <Sentence>
    select nodno  DeaNod from pubnodinf where sbkno='%s'
   </Sentence>
   <Fields>RcvBNo|</Fields>
  </DynSentence>
  <DynSentence name="Qry007">
   <Sentence>
      SELECT 'Y' YN from table(values(1)) as anony where exists(
        select * from CbsQryJnl where SndDat='%s'  and  SndBNo='%s'  and  PVchId='%s'  
      )
   </Sentence>
   <Fields>SndDat|SndBNo|PVchId|</Fields>
  </DynSentence>
  <DynSentence name="ChkCusAgr"><!--查询签约关系-->
    <Sentence>
               SELECT 'Y' YN from table(values(1)) as anony
               where exists(select * from CbsCenAgr
               where  PayAct='%s' and SBusTy in ('%s','%s')  and status='1' )
    </Sentence>
    <Fields>ActNo|AAA_QYZZ|AAA_ZDJF|</Fields>
  </DynSentence>

  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <Exec  func="CBS:CbsGetNodInfo"  error="IGNORE">
    <Args>
     <Arg name ='PBnkNo' value='$RcvBNo' />
    </Args>
   </Exec>
   <If condition="~RetCod !=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取行网点信息失败CbsGetNodInfo</Set>
     <Set>BrNo=441999</Set>
   </If>
    <Exec func="PUB:ReadRecord"  error="IGNORE">
     <Args>
      <Arg name="SqlCmd" value="Qry002" />
     </Args>
    </Exec>
    <If condition="~RetCod !=0">
     <Set>RspMsg=取网点号出错</Set>
     <Set>DeaNod=441800</Set>
     <Return/>
    </If>
   <If condition="IS_EQUAL_STRING($QryTyp,001)"> <!--客户余额查询-->
     <Set>MsgId=2232</Set>
     <Set>CcyCod=CNY</Set>
     <Exec func="PUB:GetVirtualTeller" error="IGNORE"/>
     <Quote name="GetBusLog"/>
     <Set>SevTyp=SUBSTR($SevDat,1,1)</Set>  
    <Set>RefSeq=$MsgSeq</Set>  
     <Set>SevInf=SUBSTR($SevDat,18,SUB(STRLEN($SevDat),17))</Set>  
    <Set>SevInf=STRCAT($RefSeq,$SevInf)</Set>
    <Set>ActNo=SUBSTR($SevDat,18,35)</Set>
    <Exec func="PUB:ReadRecord" error="IGNORE" >
      <Arg name="SqlCmd" value="ChkCusAgr" />
    </Exec>
    <If condition="~RetCod !=0">
      <Set>RspCod=CBS020</Set>
      <Set>RspMsg=银行未开通该业务</Set>
      <Quote name="SendThird_S00145" />
      <Return/>
    </If>
    <Exec  func="CBS:CbsGetAccFlg"  error="IGNORE">
      <Args>
       <Arg name ='ActNo' value='$ActNo' />
      </Args>
    </Exec>
    <Set>AccFlg=$LAccFlg</Set>
    <!--对公对私处理判断begin-->
    <If condition='$LAccFlg = 0'> <!--对公处理-->
      <Set>RspCod=CBS020</Set>
      <Set>RspMsg=银行未开通该业务</Set>
      <Quote name="SendThird_S00145" />
      <Return/>      
    </If>            
    <If condition='$LAccFlg != 0'> <!--对私处理-->
     <If condition='$LAccFlg = 1'> <!--对私处理卡-->
      <Set>ActFlg=2</Set><!--普通存折-->
      <Set>ActTyp=2</Set>
     </If>
     <If condition='$LAccFlg = 2'> <!--对私处理卡-->
       <Set>ActFlg=4</Set><!--卡-->
       <Set>ActTyp=4</Set>
     </If>
     <Set>OCcyCod=$CcyCod</Set> 
     <Exec func="PUB:CallHostOther" error="IGNORE">
        <Arg name="HTxnCd" value="476520"/>
        <Arg name="ObjSvr" value="SHSTPUB1"/>
     </Exec>
     <Set>CcyCod=$OCcyCod</Set> 
     <If condition="$MsgTyp!=N">
       <Set>RspCod=CBS005</Set>
       <Set>RspMsg=无此帐号</Set>
       <Quote name="SendThird_S00145" />
       <Return/>
     </If>
     <Set>ActNo=ADDCHAR($ActNo,35, ,0)</Set>
     <Set>Bal=ADDCHAR($Bal,20, ,0)</Set>
     <Set>SevInf=STRCAT($RefSeq,$ActNo,000000000000000000000000,00000,11,CNY,00000000,00,$Bal,ADDCHAR(0,40,0,0))</Set>
     <Quote name="SendThird_S00145" />
    </If>    
    <Return/>
   </If> <!--客户余额查询over-->
   <If condition="AND(IS_NOEQUAL_STRING($QryTyp,003),IS_NOEQUAL_STRING($QryTyp,004),IS_NOEQUAL_STRING($QryTyp,005),IS_NOEQUAL_STRING($QryTyp,006),IS_NOEQUAL_STRING($QryTyp,999),IS_NOEQUAL_STRING($QryTyp,007))">
     <Set>RspCod=CBS004</Set>
     <Set>RspMsg=不合法查询报文</Set>
     <Set>ReqSmr=$SevDat</Set>
     <Set>OIFlag=2</Set>
     <Exec  func="PUB:InsertRecord">
      <Args>
       <Arg name ='TblNam' value='CbsQryJnl'/>
      </Args>
     </Exec> 
     <Return/>
   </If>
    <Exec func="PUB:ReadRecord"  error="IGNORE">
     <Args>
      <Arg name="SqlCmd" value="Qry001" />
     </Args>
    </Exec>
    <If condition="~RetCod =0">
     <Set>RspMsg=交易重复,不做处理</Set>
     <Return/>
    </If>
    <ElseIf condition='~RetCod!=-2'>
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=数据库出错</Set>
     <Return/>
    </ElseIf>
   <If condition="IS_EQUAL_STRING($QryTyp,003)"> <!--确认查询查复-->
    <Set>TmpDat=SUBSTR($SevDat,2,16)</Set>  
    <Set>PTraKnd=SUBSTR($SevDat,18,4)</Set>
    <Set>PriCls=SUBSTR($SevDat,22,1)</Set>
    <Set>ReqSeq=SUBSTR($SevDat,23,8)</Set>
    <Set>TmpSeq=SUBSTR($SevDat,31,8)</Set>
    <Set>PSndBNo=SUBSTR($SevDat,39,12)</Set>
    <Set>PRcvBNo=SUBSTR($SevDat,51,12)</Set>
    <Set>PSndDat=SUBSTR($SevDat,63,8)</Set>
    <Set>TmpDat=SUBSTR($SevDat,71,6)</Set>
    <Set>PClrDat=SUBSTR($SevDat,77,8)</Set>
    <Set>PTxnAmt=SUBSTR($SevDat,85,15)</Set>
    <Set>PCcyCod=SUBSTR($SevDat,100,3)</Set>
    <Set>TmpDat=SUBSTR($SevDat,103,29)</Set>
    <Set>PVchId=SUBSTR($SevDat,132,8)</Set>
    <Set>ReqSmr=SUBSTR($SevDat,140,300)</Set>
   </If>
   <If condition="IS_EQUAL_STRING($QryTyp,004)"> <!--止付申请和处理通知-->
    <Set>TmpDat=SUBSTR($SevDat,2,16)</Set>  
    <Set>PTraKnd=SUBSTR($SevDat,18,4)</Set>
    <Set>PriCls=SUBSTR($SevDat,22,1)</Set>
    <Set>ReqSeq=SUBSTR($SevDat,23,8)</Set>
    <Set>TmpSeq=SUBSTR($SevDat,31,8)</Set>
    <Set>PSndBNo=SUBSTR($SevDat,39,12)</Set>
    <Set>PRcvBNo=SUBSTR($SevDat,51,12)</Set>
    <Set>PSndDat=SUBSTR($SevDat,63,8)</Set>
    <Set>TmpDat=SUBSTR($SevDat,71,6)</Set>
    <Set>PClrDat=SUBSTR($SevDat,77,8)</Set>
    <Set>PTxnAmt=SUBSTR($SevDat,85,15)</Set>
    <Set>PCcyCod=SUBSTR($SevDat,100,3)</Set>
    <Set>TmpDat=SUBSTR($SevDat,103,29)</Set>
    <Set>PVchId=SUBSTR($SevDat,132,8)</Set>
    <Set>PPayAct=SUBSTR($SevDat,140,35)</Set>
    <Set>PPayNam=SUBSTR($SevDat,175,60)</Set>
    <Set>PGatAct=SUBSTR($SevDat,235,8)</Set>
    <Set>PGatNam=SUBSTR($SevDat,243,8)</Set>
    <Set>ReqSmr=SUBSTR($SevDat,251,300)</Set>
   </If>
   <If condition="IS_EQUAL_STRING($QryTyp,005)"> <!--退回申请和处理通知-->
    <Set>TmpDat=SUBSTR($SevDat,2,16)</Set>  
    <Set>PTraKnd=SUBSTR($SevDat,18,4)</Set>
    <Set>PriCls=SUBSTR($SevDat,22,1)</Set>
    <Set>ReqSeq=SUBSTR($SevDat,23,8)</Set>
    <Set>TmpSeq=SUBSTR($SevDat,31,8)</Set>
    <Set>PSndBNo=SUBSTR($SevDat,39,12)</Set>
    <Set>PRcvBNo=SUBSTR($SevDat,51,12)</Set>
    <Set>PSndDat=SUBSTR($SevDat,63,8)</Set>
    <Set>TmpDat=SUBSTR($SevDat,71,6)</Set>
    <Set>PClrDat=SUBSTR($SevDat,77,8)</Set>
    <Set>PTxnAmt=SUBSTR($SevDat,85,15)</Set>
    <Set>PCcyCod=SUBSTR($SevDat,100,3)</Set>
    <Set>TmpDat=SUBSTR($SevDat,103,29)</Set>
    <Set>PVchId=SUBSTR($SevDat,132,8)</Set>
    <Set>PPayAct=SUBSTR($SevDat,140,35)</Set>
    <Set>PPayNam=SUBSTR($SevDat,175,60)</Set>
    <Set>PGatAct=SUBSTR($SevDat,235,8)</Set>
    <Set>PGatNam=SUBSTR($SevDat,243,8)</Set>
    <Set>ReqSmr=SUBSTR($SevDat,251,300)</Set>
   </If>
   <If condition="IS_EQUAL_STRING($QryTyp,999)"> <!--通用通知-->
    <Set>ReqSmr=SUBSTR($SevDat,1,300)</Set>
   </If>
   <If condition="IS_EQUAL_STRING($QryTyp,007)"> <!--ETS汇总资金信息通知-->    
    <Set>SevTyp=SUBSTR($SevDat,1,1)</Set>
    <Set>OMsgSeq=$MsgSeq </Set>
    <Set>PSndBNo=SUBSTR($SevDat,18,12)</Set> <!--付款行行号-->
    <Set>PRcvBNo=SUBSTR($SevDat,30,12)</Set> <!--收款行行号-->        
    <Set>PTxnAmt =SUBSTR($SevDat,54,15)</Set> <!--金额-->    
    <Set>PBgtFlg =SUBSTR($SevDat,42,1)</Set> <!--预算类型-->
    <Set>PTaxTyp =SUBSTR($SevDat,43,11)</Set> <!--税费种类-->    
    <Set>PPayAct =SUBSTR($SevDat,69,8)</Set> <!--ETS资金清算日期-->
    <Set>PPayNam =SUBSTR($SevDat,77,2)</Set> <!--ETS资金清算场次-->    
    <Set>PGatAct =$SndAct</Set> <!--国库收款帐户-->
    <Set>PGatNam =$SndNm</Set> <!--国库收款名称-->     
    <!--Set>ReqSmr=SUBSTR($SevDat,2,300) </Set-->  
    <Set>ReqSmr=STRCAT(付款行行号:,$PSndBNo, 收款行行号:,$PRcvBNo) </Set>  
    <Set>PVchId=$VchId </Set>
    <Set>MatFlg=1</Set>
    <Exec func="PUB:ReadRecord" error="IGNORE" >
      <Arg name="SqlCmd" value="Qry007" />
    </Exec>
    <If condition="~RetCod =0">
      <Quote name="GetBusLog"/>
      <Set>MsgId=2232</Set>
      <Set>RspCod=000000</Set>
      <Set>SevInf=STRCAT($OMsgSeq,$PSndBNo,$PRcvBNo,$PBgtFlg,$PTaxTyp,$PTxnAmt,$PPayAct,$PPayNam,***,$PBgtFlg, $PTaxTyp)</Set>
      <Quote name="SendThird_S00145" />
      <Return/>
    </If>                          
   </If>   
   <Set>OIFlag=1</Set>   
   <Exec  func="PUB:InsertRecord">
      <Args>
       <Arg name ='TblNam' value='CbsQryJnl'/>
      </Args>
   </Exec> 
   
   <If condition="IS_EQUAL_STRING($QryTyp,007)"> <!--ETS汇总资金信息通知返回-->
     <Quote name="GetBusLog"/>
     <Set>MsgId=2232</Set>
     <Set>RspCod=000000</Set>
     <Set>SevInf=STRCAT($OMsgSeq,$PSndBNo,$PRcvBNo,$PVchId,$PPayAct,$PTxnAmt,$PClrDat,$PSndDat)</Set>
     <Quote name="SendThird_S00145" />
   </If>      
  </FlowCtrl>
 </Transaction>

<Transaction code="465759" desc="接收银银间通用通知信息查复">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>
  <DynSentence name="QryOrgRec">
   <Sentence>
    select MsgSeq OMsgSeq from cbsQryjnl where TxnKnd='%s' and SndBNo='%s' and SndDat='%s' and MsgSeq='%s' and OIFlag='0'
   </Sentence>
   <Fields>TxnKnd|SndBNo|SndDat|RefSeq|</Fields>
  </DynSentence>
  <DynSentence name="UpdRspRec">
   <Sentence>
    update cbsqryjnl set MatFlg='%s',RspSeq='%s',TRspCd='%s',RspSmr='%s' where TxnKnd='%s' and SndBNo='%s' and SndDat='%s' and MsgSeq='%s' and OIFlag='0'
   </Sentence>
   <Fields>MatFlg|RspSeq|TRspCd|RspSmr|TxnKnd|SndBNo|SndDat|RefSeq|</Fields>
  </DynSentence>

  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <Exec  func="CBS:CbsGetNodInfo"  error="IGNORE">
    <Args>
     <Arg name ='PBnkNo' value='$RcvBNo' />
    </Args>
   </Exec>
   <If condition="~RetCod !=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取行网点信息失败CbsGetNodInfo</Set>
     <Set>BrNo=441999</Set>
   </If>
   <If condition="AND(IS_NOEQUAL_STRING($QryTyp,003),IS_NOEQUAL_STRING($QryTyp,004),IS_NOEQUAL_STRING($QryTyp,005),IS_NOEQUAL_STRING($QryTyp,006),IS_NOEQUAL_STRING($QryTyp,999))">
     <Set>RspCod=CBS004</Set>
     <Set>RspMsg=不合法查复报文</Set>
     <Set>ReqSmr=$SevDat</Set>
     <Set>OIFlag=3</Set>
     <Exec  func="PUB:InsertRecord">
      <Args>
       <Arg name ='TblNam' value='CbsQryJnl'/>
      </Args>
     </Exec> 
     <Return/>
   </If>
   <!--分解查复数据-->
   <If condition="IS_EQUAL_STRING($QryTyp,003)"> <!--确认查询查复-->
    <Set>RefSeq=SUBSTR($SevDat,2,16)</Set>  
    <Set>PTraKnd=SUBSTR($SevDat,18,4)</Set>
    <Set>PriCls=SUBSTR($SevDat,22,1)</Set>
    <Set>ReqSeq=SUBSTR($SevDat,23,8)</Set>
    <Set>RspSeq=SUBSTR($SevDat,31,8)</Set>
    <Set>PSndBNo=SUBSTR($SevDat,39,12)</Set>
    <Set>PRcvBNo=SUBSTR($SevDat,51,12)</Set>
    <Set>PSndDat=SUBSTR($SevDat,63,8)</Set>
    <Set>TmpDat=SUBSTR($SevDat,71,6)</Set>
    <Set>PClrDat=SUBSTR($SevDat,77,8)</Set>
    <Set>PTxnAmt=SUBSTR($SevDat,85,15)</Set>
    <Set>PCcyCod=SUBSTR($SevDat,100,3)</Set>
    <Set>TmpDat=SUBSTR($SevDat,103,29)</Set>
    <Set>PVchId=SUBSTR($SevDat,132,8)</Set>
    <Set>RspSmr=SUBSTR($SevDat,140,300)</Set>
   </If>
   <If condition="IS_EQUAL_STRING($QryTyp,004)"> <!--止付申请和处理通知-->
    <Set>RefSeq=SUBSTR($SevDat,2,16)</Set>  
    <Set>PTraKnd=SUBSTR($SevDat,18,4)</Set>
    <Set>PriCls=SUBSTR($SevDat,22,1)</Set>
    <Set>ReqSeq=SUBSTR($SevDat,23,8)</Set>
    <Set>RspSeq=SUBSTR($SevDat,31,8)</Set>
    <Set>PSndBNo=SUBSTR($SevDat,39,12)</Set>
    <Set>PRcvBNo=SUBSTR($SevDat,51,12)</Set>
    <Set>PSndDat=SUBSTR($SevDat,63,8)</Set>
    <Set>TmpDat=SUBSTR($SevDat,71,6)</Set>
    <Set>PClrDat=SUBSTR($SevDat,77,8)</Set>
    <Set>PTxnAmt=SUBSTR($SevDat,85,15)</Set>
    <Set>PCcyCod=SUBSTR($SevDat,100,3)</Set>
    <Set>TmpDat=SUBSTR($SevDat,103,29)</Set>
    <Set>PVchId=SUBSTR($SevDat,132,8)</Set>
    <Set>PPayAct=SUBSTR($SevDat,140,35)</Set>
    <Set>PPayNam=SUBSTR($SevDat,175,60)</Set>
    <Set>PGatAct=SUBSTR($SevDat,235,8)</Set>
    <Set>PGatNam=SUBSTR($SevDat,243,8)</Set>
    <Set>RspSmr=SUBSTR($SevDat,251,300)</Set>
   </If>
   <If condition="IS_EQUAL_STRING($QryTyp,005)"> <!--退回申请和处理通知-->
    <Set>RefSeq=SUBSTR($SevDat,2,16)</Set>  
    <Set>PTraKnd=SUBSTR($SevDat,18,4)</Set>
    <Set>PriCls=SUBSTR($SevDat,22,1)</Set>
    <Set>ReqSeq=SUBSTR($SevDat,23,8)</Set>
    <Set>RspSeq=SUBSTR($SevDat,31,8)</Set>
    <Set>PSndBNo=SUBSTR($SevDat,39,12)</Set>
    <Set>PRcvBNo=SUBSTR($SevDat,51,12)</Set>
    <Set>PSndDat=SUBSTR($SevDat,63,8)</Set>
    <Set>TmpDat=SUBSTR($SevDat,71,6)</Set>
    <Set>PClrDat=SUBSTR($SevDat,77,8)</Set>
    <Set>PTxnAmt=SUBSTR($SevDat,85,15)</Set>
    <Set>PCcyCod=SUBSTR($SevDat,100,3)</Set>
    <Set>TmpDat=SUBSTR($SevDat,103,29)</Set>
    <Set>PVchId=SUBSTR($SevDat,132,8)</Set>
    <Set>PPayAct=SUBSTR($SevDat,140,35)</Set>
    <Set>PPayNam=SUBSTR($SevDat,175,60)</Set>
    <Set>PGatAct=SUBSTR($SevDat,235,8)</Set>
    <Set>PGatNam=SUBSTR($SevDat,243,8)</Set>
    <Set>RspSmr=SUBSTR($SevDat,251,300)</Set>
   </If>
   <If condition="IS_EQUAL_STRING($QryTyp,999)"> <!--通用查询-->
    <Set>RefSeq=0</Set>
    <Set>RspSmr=SUBSTR($SevDat,1,300)</Set>
    <Set>RspSeq=00000000</Set>
   </If>
   <Exec func="PUB:ReadRecord"  error="IGNORE">
     <Args>
      <Arg name="SqlCmd" value="QryOrgRec" />
     </Args>
   </Exec>
   <If condition="~RetCod =0">
     <Set>MatFlg=1</Set>
     <Exec func="PUB:ExecSql">
       <Arg name="sql" value="$UpdRspRec"/>
     </Exec>
   </If>
   <ElseIf condition='~RetCod=-2'>
     <Set>OIFlag=3</Set> 
     <Set>RspMsg=不匹配查复</Set>
     <Exec  func="PUB:InsertRecord">
      <Args>
       <Arg name ='TblNam' value='CbsQryJnl'/>
      </Args>
     </Exec> 
   </ElseIf>
  </FlowCtrl>
 </Transaction>

<Transaction code="465760" desc="接收银结间通用通知信息查复">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>
  <DynSentence name="Qry001">
   <Sentence>
    select * from cbsQryjnl where TxnKnd='%s' and SndBNo='%s' and SndDat='%s' and MsgSeq='%s'
   </Sentence>
   <Fields>TxnKnd|SndBNo|SndDat|VchId|</Fields>
  </DynSentence>

  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <If condition="OR(IS_NOEQUAL_STRING($QryTyp,000),IS_NOEQUAL_STRING($QryTyp,006))">
     <Set>RspMsg=接收的数据不合法</Set>
     <Return/>
   </If>
   <If condition="IS_EQUAL_STRING($QryTyp,000)"> <!--银行帐户情况查复-->
    <Set>RefSeq=SUBSTR($SevDat,2,16)</Set>  
    <Set>BalAmt=SUBSTR($SevDat,18,20)</Set>  
    <Set>Amt001=SUBSTR($SevDat,38,20)</Set>  
    <Set>Amt002=SUBSTR($SevDat,58,20)</Set>  
    <Set>ActSts=SUBSTR($SevDat,78,1)</Set>  
   </If>
   <If condition="IS_EQUAL_STRING($QryTyp,006)"> <!--同城调账申请查复-->
    <Set>RefSeq=SUBSTR($SevDat,2,16)</Set>  
    <Set>PTraKnd=SUBSTR($SevDat,18,4)</Set>
    <Set>PriCls=SUBSTR($SevDat,22,1)</Set>
    <Set>ReqSeq=SUBSTR($SevDat,23,8)</Set>
    <Set>RspSeq=SUBSTR($SevDat,31,8)</Set>
    <Set>PSndBNo=SUBSTR($SevDat,39,12)</Set>
    <Set>PRcvBNo=SUBSTR($SevDat,51,12)</Set>
    <Set>PSndDat=SUBSTR($SevDat,63,8)</Set>
    <Set>TmpDat=SUBSTR($SevDat,71,6)</Set>
    <Set>PClrDat=SUBSTR($SevDat,77,8)</Set>
    <Set>PTxnAmt=SUBSTR($SevDat,85,15)</Set>
    <Set>PCcyCod=SUBSTR($SevDat,100,3)</Set>
    <Set>TmpDat=SUBSTR($SevDat,103,29)</Set>
    <Set>PVchId=SUBSTR($SevDat,132,8)</Set>
    <Set>ReqSmr=SUBSTR($SevDat,140,300)</Set>
   </If>
  </FlowCtrl>
 </Transaction>

<Transaction code="465762" desc="接收机构发起实时扣款冲正请求处理">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>  

  <DynSentence name="QryOrgJnl">
   <Sentence>
    select BrNo,TTxnCd OTTxnCd,HTxnCd OHTxnCd,BilSts OBilsts, LogNo OLogNo,TlrId from cbstxnjnl where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>OTraKnd|OSndBNo|OSndDat|OVchId|</Fields>
  </DynSentence>
  <DynSentence name="UpdOrgJnl">
   <Sentence>
     update cbstxnjnl Set BilSts= '%s'  where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>BilSts|OTraKnd|OSndBNo|OSndDat|OVchId|</Fields>  
  </DynSentence>
  <!--DynSentence name="QryReJnl">
   <Sentence>
    select RspCod from cbstxnjnl where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and OIFlag='1'
   </Sentence>
   <Fields>TraKnd|SndBNo|SndDat|VchId|</Fields>
  </DynSentence-->

  <FlowCtrl>
    <Exec func="PUB:InitTransaction"/>
    <Set>MsgId=2432</Set>         
    <!--查是否有原始流水-->   
    <Exec func="PUB:ReadRecord"  error="IGNORE">
     <Args>
      <Arg name="SqlCmd" value="QryOrgJnl" />
     </Args>
    </Exec>
    <If condition="~RetCod!=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取机构实时扣款原始流水失败,交易中止不回应 </Set>
     <Set>MatFlg=0</Set>
     <Return/>     
    </If>
    <Else>
     <Set>MatFlg=1</Set>
    </Else>
   <Exec  func="CBS:CbsGetNodInfo"  error="IGNORE">
    <Args>
     <Arg name ='PBnkNo' value='$RcvBNo' />
    </Args>
   </Exec>
   <If condition="~RetCod !=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=取行网点信息失败CbsGetNodInfo</Set>
     <Set>BrNo=441999</Set>
     <Set>CtlNod=441800</Set>
     <Set>CnlSub=441999</Set>
     <Set>BusNod=000000</Set>
   </If>
   <Set>NodNo=$CtlNod</Set>

   <Exec func="PUB:GetAppInfo" />
   <!--生成信息流水号-->
   <Quote name="GetBusLog"/>
   
   <!--取流水判断是否重复接收处理>   
   <Exec func="PUB:ReadRecord"  error="IGNORE">
    <Args>
     <Arg name="SqlCmd" value="QryReJnl" />
    </Args>
   </Exec>
   <If condition="~RetCod=0">
     <Set>RspMsg=已经接收处理则返回原处理结果</Set>
     <Quote name="SendThird_S01245" />
     <Return/>
   </If>
   <ElseIf condition="~RetCod=-1"> 
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=查交易记录数据库操作失败不回应</Set>
     <Return/>
   </ElseIf-->
   <If condition="STRCMP($OBilsts,R)=0">
     <Set>RspCod=000000</Set>
     <Set>RspMsg=原交易已冲正 </Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   
   <Set>LAccFlg=0</Set>
   <Set>BokAct=$RcvAct</Set>
   <Exec  func="CBS:CbsGetAccFlg"  error="IGNORE">
    <Args>
     <Arg name ='ActNo' value='$RcvAct'/>
    </Args>
   </Exec>   
   <Set>AccFlg=$LAccFlg</Set>
      
   <!--向交易记录表中插入冲正流水BilSts=P>
   <Set>BilSts=P</Set>
   <Exec  func="PUB:InsertRecord"  error="IGNORE">
    <Args>
     <Arg name ='TblNam' value='CbsTxnJnl'/>
    </Args>
   </Exec>
   <If condition='$SqlCod = -803'> 
     <Exec func="PUB:RollbackWork" error="IGNORE" />
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=纪录重复设置失败返回</Set>
     <Quote name="SendThird_S01245" />
     <Return />
   </If>
   <ElseIf condition='~RetCod != 0'>
     <Exec func="PUB:RollbackWork" error="IGNORE" />
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=插表数据库操作失败不回应</Set>
     <Return />
   </ElseIf>   
   <Exec  func="PUB:CommitWork"  /--> 
   <!--提交数据库事务-->
   
   <Set>RspCod=000000</Set> <!--设置返回码成功 -->   
   <If condition="STRCMP($CCYCOD,CNY)!=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=不支持外币交易,不回应</Set>
     <Return />
   </If>
   <If condition="STRCMP($OHTxnCd,461181)=0">
     <Set>RspMsg=省零余额业务冲正</Set>     
     <Set>BilSts=R</Set>
     <Set>NodNo=$CtlNod</Set>
     <Set>PfaSub=001</Set>
     <Exec func="PUB:CallThirdOther" error="IGNORE">
         <Arg name="HTxnCd" value="461189"/>
         <Arg name="ObjSvr" value="STHDCBS1"/>
     </Exec>       
     <If condition="~RetCod!=0">
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=冲正交易失败 </Set>
         <Quote name="SendThird_S01245" />
         <Return />         
     </If>            
     <Exec func="PUB:ExecSql">
       <Arg name="sql" value="UpdOrgJnl"/>
     </Exec>
     <Quote name="SendThird_S01245" />     
     <Return />
   </If><!--省零余额业务冲正over-->
   <ElseIf condition="STRCMP($OHTxnCd,363412)=0">
     <Set>RspMsg=中央零余额业务冲正</Set>     
     <Set>BilSts=R</Set>
     <Set>NodNo=$CtlNod</Set>
     <Set>EleBk=@BCFG.EleBk</Set>
     <Set>APVchN=$OLogNo</Set>     
     <Exec func="PUB:CallThirdOther" error="IGNORE">
         <Arg name="HTxnCd" value="363419"/>
         <Arg name="ObjSvr" value="STHDFAP2"/>
     </Exec>       
     <If condition="~RetCod!=0">
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=冲正交易失败 </Set>
         <Quote name="SendThird_S01245" />
         <Return />         
     </If>            
     <Exec func="PUB:ExecSql">
       <Arg name="sql" value="UpdOrgJnl"/>
     </Exec>
     <Quote name="SendThird_S01245" />     
     <Return />     
   </ElseIf><!--中央零余额业务冲正over-->   
   <Set>TIATyp=C</Set>
   <Set>HTxnCd=STRCAT(SUBSTR($OHTxnCd,1,5),9)</Set>
   <Set>TTxnCd=$OTTxnCd</Set>   
   <Set>LogNo=$OLogNo</Set>
   <Exec func="PUB:CallHostOther"><!--上主机系统抹账 -->
     <Arg name="HTxnCd" value="959999" /><!--主机交易码 -->
     <Arg name="ObjSvr" value="SHSTPUB1" />
   </Exec>
   <If condition="~RetCod=0">    <!--抹账成功-->
    <Set>BilSts=R</Set>
    <Set>HTxnSt=C</Set>
   </If>
   <Else>
     <Switch expression="$HRspCd">
       <Case value="AG8001"/>     <!--该前置流水号不存在-->
       <Case value="AG8981"/>     <!--该前置流水号不存在-->
       <Case value="SC6129"/>     <!--原交易不存在-->
       <Case value="SC6034">      <!--原交易已经被抹-->
         <Set>BilSts=R</Set>
         <Break/>
       </Case>
       <Default><!--不能判定原交易成功,不回应-->
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=不能判定原交易成功,不回应</Set>
         <Return/>
       </Default>
     </Switch>
   </Else>   
   <Set>RspCod=000000</Set>
   
   <!--Exec func="PUB:ExecSql">
     <Arg name="sql" value="UpdSucSql"/>
   </Exec-->
   
   <Exec func="PUB:ExecSql">
     <Arg name="sql" value="UpdOrgJnl"/>
   </Exec>
   <Quote name="SendThird_S01245" />
  </FlowCtrl>                           
 </Transaction>

<Transaction code="465790" desc="汇兑来帐对私入帐处理">
  <Attributes>
    <Attribute name="nodatabase" value="2"/>
  </Attributes>
  <DynSentence name="Qry001">
   <Sentence>
    select * from cbstxnjnl where Traknd='1001' and  OIFlag='1' and AccXXXFlg='1' and BilSts='W' and matflg='0'
   </Sentence>
  </DynSentence>
  <DynSentence name="UpdSuc">
   <Sentence>
    update cbstxnjnl set TRspCd='%s',Bilsts='%s',matflg='1' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and  OIFlag='1'
   </Sentence>
   <Fields>TRspCd|Bilsts|TraKnd|SndBNo|SndDat|VchId|</Fields>
  </DynSentence>
  <DynSentence name="UpdFai">
   <Sentence>
    update cbstxnjnl set TRspCd='%s' where TraKnd='%s' and SndBNo='%s' and SndDat='%s' and VchId='%s' and  OIFlag='1'
   </Sentence>
   <Fields>TRspCd|TraKnd|SndBNo|SndDat|VchId|</Fields>
  </DynSentence>
  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <Exec func="PUB:OpenCursor">
    <Arg name="sql" value="Qry001"/>
   </Exec>
   <While>
    <Exec func="PUB:FetchCursor" error="IGNORE"/>
    <If condition="~RetCod=100">
       <Break/>
    </If>
    <If condition="~RetCod!=0">
     <Set>RspCod=CBS999</Set>
     <Set>RspMsg=打开游标失败，数据库错误，请联系技术人员</Set>
     <Exec func="PUB:CloseCursor" error="IGNORE"/>
     <Return />
    </If>
    <Set>ObjSvr=STRCAT(SBSSG,SUBSTR($BrNo,1,3))</Set>
    <Set>PTxnCd=9985</Set>
    <Exec func="PUB:CallThirdOther" error="IGNORE">
     <Arg name="HTxnCd"  value="465220"/>
     <Arg name="ObjSvr"  value="$ObjSvr"/>
    </Exec>
    <If condition="~RetCod=0">
     <If condition="IS_EQUAL_STRING($SetTyp,1)">
       <!--对私挂帐-->
       <Set>Bilsts=Q</Set>
     </If>
     <Else>
       <!--对私入对私帐-->
       <Set>Bilsts=V</Set>
     </Else>
     <Exec func="PUB:ExecSql" error="IGNORE">
       <Arg name="sql" value="UpdSuc"/>
     </Exec>
     <If condition="~RetCod!=0">
      <Set>RspMsg=数据库操作错 </Set>
      <Break/>
     </If>
    </If>
    <ElseIf condition="~RetCod!=0">
     <Exec func="PUB:ExecSql" error="IGNORE">
       <Arg name="sql" value="UpdFai"/>
     </Exec>
    </ElseIf>
    <Exec  func="PUB:CommitWork" /> <!--提交数据库事务-->
    <If condition="IS_EQUAL_STRING($TRspCd,111111)">
       <Break/>
    </If>
   </While>
   <Exec func="PUB:CloseCursor"/><!--关闭游标-->
  </FlowCtrl>
 </Transaction>
 
<Transaction code="465763" desc="接收机构发起通用通知信息">
  <Attributes>
   <Attribute name="noresponse" value="1"/>
  </Attributes>

  <DynSentence name="QryRec">
      <Sentence>
        select Status OStatus,PayAct OPayAct,PayNam OPayNam,OrgCod OOrgCod,SBusTy OSBusTy,AgrWay OAgrWay from CbsCenAgr where AgrNo='%s' and UsrCod='%s'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
  </DynSentence>
  <DynSentence name="DelRec">
      <Sentence>
        delete from CbsCenAgr where AgrNo='%s' and UsrCod='%s'
      </Sentence>
      <Fields>AgrNo|UsrCod|</Fields>
  </DynSentence>
   <DynSentence name="UpdIvdRec">
    <Sentence>
        update CbsCenAgr Set IvdDat='%s',TxnDat='%s',Smr='%s',FilTyp='99',ChgMod='0',ChkFlg='1',Status='0'  where AgrNo='%s' and UsrCod='%s'
    </Sentence>
    <Fields>SndDat|SndDat|Smr|AgrNo|UsrCod|</Fields>
    </DynSentence>
   <DynSentence name="UpdComRec">
    <Sentence>
        update CbsCenAgr Set FilTyp='99',ChgMod='2',ChkFlg='1',TxnDat='%s',Smr='%s',LnkNam='%s',LnkAdr='%s',LnkPst='%s',LnkTel='%s',PayMob='%s',PayEml='%s'  where AgrNo='%s' and UsrCod='%s'
    </Sentence>
    <Fields>SndDat|Smr|LnkNam|LnkAdr|LnkPst|LnkTel|PayMob|PayEml|AgrNo|UsrCod|</Fields>
    </DynSentence>

  <FlowCtrl>
   <Exec func="PUB:InitTransaction"/>
   <Exec  func="CBS:CbsGetNodInfo"  error="IGNORE">
    <Args>
     <Arg name ='PBnkNo' value='$RcvBNo' />
    </Args>
   </Exec>
   <If condition="~RetCod !=0">
     <Set>RspMsg=取行网点信息失败 </Set>
     <Set>BrNo=441999</Set>
     <Set>CtlNod=441800</Set>
   </If>   
   <Set>PayCBnk=$CLRBANKNO</Set>
   <Set>NodNo=$CtlNod</Set>
   <Set>CnlSub=$BrNo</Set>
    <Exec func="PUB:GetVirtualTeller" error="IGNORE"/>     
    <Set>MsgId=2232</Set>
   <Switch expression="$QryTyp">
     <Case value="999"> <!--通用查询-->       
       <Set>OIFlag=1</Set>
       <Set>DeaNod=$CtlNod</Set>
       <Set>ReqSmr=TOSBC(CGBCLEAR($SevDat))</Set>
       <Exec  func="PUB:InsertRecord">
        <Args>
         <Arg name ='TblNam' value='CbsQryJnl'/>
        </Args>
       </Exec>          
       <Return/>
       <Break/>
     </Case>
     <Case value="100"> <!--新赠协议-->
        <Set>ChgMod=1</Set> 
        <Set>SevTyp=SUBSTR($SevDat,1,1)</Set>  
       <Set>RefSeq=$MsgSeq</Set> 
       <Set>Keep1=$MsgSeq</Set> 
        <Set>SevInf=SUBSTR($SevDat,18,SUB(STRLEN($SevDat),17))</Set>  
       <Set>SevInf=STRCAT($RefSeq,$SevInf)</Set>
        <Quote name="GetBusLog"/>
       <Set>AgrNo =SUBSTR($SevDat,18,60)</Set> <!--合同（协议）号-->
       <Set>UsrCod=SUBSTR($SevDat,78,18)</Set> <!--用户编号-->
       <Set>UsrNam=SUBSTR($SevDat,96,60)</Set> <!--用户名称-->
       <Set>LnkNam=SUBSTR($SevDat,156,60)</Set> <!--联系人名称-->
       <Set>LnkAdr=SUBSTR($SevDat,216,60)</Set> <!--联系人地址-->
       <Set>LnkPst=SUBSTR($SevDat,276,6 )</Set> <!--联系人地址邮编-->
       <Set>LnkTel=SUBSTR($SevDat,282,25)</Set> <!--联系人电话-->
       <Set>SBusTy=SUBSTR($SevDat,307,5 )</Set> <!--业务种类-->
       <Set>PayOBnk=SUBSTR($SevDat,312,12)</Set> <!--付款行行号-->
       <Set>PayAct=SUBSTR($SevDat,324,32)</Set> <!--付款人账号-->
       <Set>PayNam=SUBSTR($SevDat,356,60)</Set> <!--付款人名称-->
       <Set>PayIdTy=SUBSTR($SevDat,416,1 )</Set> <!--付款人证件类型-->
       <Set>PayIdNo=SUBSTR($SevDat,417,18)</Set> <!--付款人证件号码-->
       <Set>PayMob=SUBSTR($SevDat,435,16)</Set> <!--付款人手机号码-->
       <Set>PayEml=SUBSTR($SevDat,451,30)</Set> <!--付款人电子邮箱-->
       <Set>Smr=SUBSTR($SevDat,481,60)</Set> <!--附言-->
       <If condition="OR(IS_EQUAL_STRING($SBusTy,$AAA_ZDJF),IS_EQUAL_STRING($BilSts,$AAA_QYZZ))">
           <Set>RspCod=CBS004</Set>
           <Set>RspMsg=不支持机构发起3A业务签约 </Set>
           <Quote name="SendThird_S00145" />
           <Return/>
       </If>
       <If condition="IS_NOEQUAL_STRING(DELBOTHSPACE($PayAct),SUBSTR($AgrNo,24,STRLEN(DELBOTHSPACE($PayAct))))">
           <Set>RspCod=CBS021</Set>
           <Set>RspMsg=协议号的付款账号错 </Set>
           <Quote name="SendThird_S00145" />
            <Return/>           
       </If>
       <If condition="IS_NOEQUAL_STRING(DELBOTHSPACE($CrpOrgCd),SUBSTR($AgrNo,7,STRLEN(DELBOTHSPACE($CrpOrgCd))))">
           <Set>RspCod=CBS099</Set>
           <Set>RspMsg=协议号的机构代号错 </Set>
           <Quote name="SendThird_S00145" />
          <Return/>           
       </If>              
       <Exec func="PUB:ReadRecord" error="IGNORE" >
                <Arg name="SqlCmd" value="QryRec" />
       </Exec>
       <If condition="~RetCod = 0 ">
         <If condition="IS_EQUAL_STRING($OStatus,0)">
            <Exec func="PUB:ExecSql" error="IGNORE">
             <Arg name="sql" value="DelRec"/>
           </Exec>                 
         </If>
         <Else><!--协议已存在并生效-->
           <Set>RspCod=000000</Set>
           <Set>RspMsg=协议已存在,成功返回 </Set>
           <Quote name="SendThird_S00145" />
           <Return/>           
         </Else>
       </If>              
       <ElseIf condition="~RetCod!=-2"> 
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=数据库操作错报错返回 </Set>
         <Quote name="SendThird_S00145" />
         <Return/>           
       </ElseIf>
       <!--下面是新协议的处理--> 
       <Set>LAccFlg=0</Set>
       <Exec  func="CBS:CbsGetAccFlg"  error="IGNORE">
         <Args>
              <Arg name ='ActNo' value='$PayAct'/>
         </Args>
       </Exec>
       <Set>ActCls=$LAccFlg</Set><!--表字段-->
       <Set>Accflg=$LAccFlg</Set>
       <Set>ActNo=$PayAct</Set>
       <Set>CcyCod=CNY</Set>
       <Set>HTxnSt=F</Set>              
       <Exec func="PUB:CallLocal"  error="IGNORE">
          <Arg name="TxnCod"  value="488001"/>
          <Arg name="ObjSvr"  value="OFRTGZH1"/>
       </Exec>
       <If condition="IS_EQUAL_STRING($HTxnSt,S)">
         <If condition="IS_EQUAL_STRING(DELBOTHSPACE($ActNam),DELBOTHSPACE($PayNam))">
           <!--账户名相同，核验成功-->
           <Set>ChkFlg=1</Set>
           <Set>Status=1</Set>
         </If>
         <Else>           
           <!--账户名不同，核验失败-->
           <Set>ChkFlg=2</Set>
           <Set>Status=0</Set>
           <Set>RspCod=CBS022</Set>
           <Set>RspMsg=账户名不同报错返回 </Set>
           <Quote name="SendThird_S00145" />
           <Return/>                             
         </Else>
       </If>
       <Else>
           <!--查不到户名，核验失败-->
           <Set>ChkFlg=2</Set> 
           <Set>Status=0</Set>
           <Set>RspCod=CBS021</Set>
           <Set>RspMsg=帐号错误报错返回 </Set>
           <Quote name="SendThird_S00145" />
           <Return/>                                        
       </Else>
       <Set>AgrTyp=SUBSTR($AgrNo,2,1)</Set>
       <Set>CtyCod=SUBSTR($AgrNo,3,4)</Set>
       <Set>OrgCod=SUBSTR($AgrNo,7,9)</Set> 
       <Set>AgrWay=1 </Set>
       <Set>TxnDat=$SndDat</Set>
       <Set>OpnDat=$SndDat</Set>  
       <Set>FilTyp=99</Set> <!--即时生效-->
       <Exec func="PUB:InsertRecord" error="IGNORE">
          <Arg name="TblNam" value="CbsCenAgr"/>
       </Exec>
       <If condition="~RetCod!=0">
           <Set>RspCod=CBS999</Set>
           <Set>RspMsg=数据库操作错报错返回 </Set>
           <Quote name="SendThird_S00145" />
           <Return/>
       </If>
       <Set>RspCod=000000</Set>
       <Set>RspMsg=签约成功 </Set>
       <Quote name="SendThird_S00145" />       
       <Return/>
       <Break/>
     </Case>
     <Case value="101"> <!--变更协议-->
        <Set>ChgMod=2</Set> 
        <Set>SevTyp=SUBSTR($SevDat,1,1)</Set>  
       <Set>RefSeq=$MsgSeq</Set>  
       <Set>Keep1=$MsgSeq</Set> 
        <Set>SevInf=SUBSTR($SevDat,18,SUB(STRLEN($SevDat),17))</Set>  
       <Set>SevInf=STRCAT($RefSeq,$SevInf)</Set>
        <Quote name="GetBusLog"/>
       <Set>AgrNo =SUBSTR($SevDat,18,60)</Set> <!--合同（协议）号-->
       <Set>UsrCod=SUBSTR($SevDat,78,18)</Set> <!--用户编号-->
       <Set>UsrNam=SUBSTR($SevDat,96,60)</Set> <!--用户名称-->
       <Set>LnkNam=SUBSTR($SevDat,156,60)</Set> <!--联系人名称-->
       <Set>LnkAdr=SUBSTR($SevDat,216,60)</Set> <!--联系人地址-->
       <Set>LnkPst=SUBSTR($SevDat,276,6 )</Set> <!--联系人地址邮编-->
       <Set>LnkTel=SUBSTR($SevDat,282,25)</Set> <!--联系人电话-->
       <Set>SBusTy=SUBSTR($SevDat,307,5 )</Set> <!--业务种类-->
       <Set>PayOBnk=SUBSTR($SevDat,312,12)</Set> <!--付款行行号-->
       <Set>PayAct=SUBSTR($SevDat,324,32)</Set> <!--付款人账号-->
       <Set>PayNam=SUBSTR($SevDat,356,60)</Set> <!--付款人名称-->
       <Set>PayIdTy=SUBSTR($SevDat,416,1 )</Set> <!--付款人证件类型-->
       <Set>PayIdNo=SUBSTR($SevDat,417,18)</Set> <!--付款人证件号码-->
       <Set>PayMob=SUBSTR($SevDat,435,16)</Set> <!--付款人手机号码-->
       <Set>PayEml=SUBSTR($SevDat,451,30)</Set> <!--付款人电子邮箱-->
       <Set>Smr=SUBSTR($SevDat,481,60)</Set> <!--附言-->

       <Exec func="PUB:ReadRecord" error="IGNORE" >
                <Arg name="SqlCmd" value="QryRec" />
       </Exec>
       <If condition="~RetCod = 0 ">
         <If condition="IS_EQUAL_STRING($OStatus,0)">
            <Set>RspCod=CBS017 </Set>
           <Set>RspMsg=协议不存在 </Set>
           <Quote name="SendThird_S00145" />
           <Return/>           
         </If>
          <If condition="IS_NOEQUAL_STRING($OAgrWay,1)">
             <Set>RspCod=CBS004 </Set>
           <Set>RspMsg=机构不能维护在银行签约的记录 </Set>
           <Quote name="SendThird_S00145" />
           <Return/>                       
          </If>                  
       </If>
       <ElseIf condition="~RetCod =-2"> 
            <Set>RspCod=CBS017 </Set>
           <Set>RspMsg=协议不存在 </Set>
           <Quote name="SendThird_S00145" />
           <Return/>           
       </ElseIf>
       <Else>
         <Set>RspCod=CBS999</Set>
         <Set>RspMsg=数据库操作错报错返回 </Set>
         <Quote name="SendThird_S00145" />
         <Return/>                    
       </Else>
       <Exec func="PUB:ExecSql" error="IGNORE">
                    <Arg name="sql" value="UpdComRec"/>
       </Exec>
       <If condition="~RetCod != 0 ">
              <Set>RspCod=CBS999</Set>
              <Set>RspMsg=数据库操作错报错返回 </Set>
              <Quote name="SendThird_S00145" />
              <Return/>
       </If>
       <Set>RspCod=000000</Set>
       <Set>RspMsg=修改协议成功 </Set>
       <Quote name="SendThird_S00145" />                     
        <Return/>
       <Break/>
     </Case>
     <Case value="102"> <!--撤消协议-->
       <Set>ChgMod=0</Set> 
        <Set>SevTyp=SUBSTR($SevDat,1,1)</Set>  
       <Set>RefSeq=$MsgSeq</Set>  
       <Set>Keep1=$MsgSeq</Set> 
        <Set>SevInf=SUBSTR($SevDat,18,SUB(STRLEN($SevDat),17))</Set>  
       <Set>SevInf=STRCAT($RefSeq,$SevInf)</Set>
        <Quote name="GetBusLog"/>
       <Set>AgrNo =SUBSTR($SevDat,18,60)</Set> <!--合同（协议）号-->
       <Set>UsrCod=SUBSTR($SevDat,78,18)</Set> <!--用户编号-->
       <Set>UsrNam=SUBSTR($SevDat,96,60)</Set> <!--用户名称-->
       <Set>LnkNam=SUBSTR($SevDat,156,60)</Set> <!--联系人名称-->
       <Set>LnkAdr=SUBSTR($SevDat,216,60)</Set> <!--联系人地址-->
       <Set>LnkPst=SUBSTR($SevDat,276,6 )</Set> <!--联系人地址邮编-->
       <Set>LnkTel=SUBSTR($SevDat,282,25)</Set> <!--联系人电话-->
       <Set>SBusTy=SUBSTR($SevDat,307,5 )</Set> <!--业务种类-->
       <Set>PayOBnk=SUBSTR($SevDat,312,12)</Set> <!--付款行行号-->
       <Set>PayAct=SUBSTR($SevDat,324,32)</Set> <!--付款人账号-->
       <Set>PayNam=SUBSTR($SevDat,356,60)</Set> <!--付款人名称-->
       <Set>PayIdTy=SUBSTR($SevDat,416,1 )</Set> <!--付款人证件类型-->
       <Set>PayIdNo=SUBSTR($SevDat,417,18)</Set> <!--付款人证件号码-->
       <Set>PayMob=SUBSTR($SevDat,435,16)</Set> <!--付款人手机号码-->
       <Set>PayEml=SUBSTR($SevDat,451,30)</Set> <!--付款人电子邮箱-->
       <Set>Smr=SUBSTR($SevDat,481,60)</Set> <!--附言-->
       <Exec func="PUB:ReadRecord" error="IGNORE" >
         <Arg name="SqlCmd" value="QryRec" />
       </Exec>
       <If condition="~RetCod = 0 ">
         <If condition="IS_EQUAL_STRING($OStatus,0)">
           <Set>RspCod=000000</Set>
           <Set>RspMsg=原已撤约成功 </Set>
           <Quote name="SendThird_S00145" />       
           <Return/>
         </If>
         <Else><!--协议已存在并生效,置成撤消-->  
            <If condition="IS_NOEQUAL_STRING($OAgrWay,1)">
               <Set>RspCod=CBS004 </Set>
             <Set>RspMsg=机构不能维护在银行签约的记录 </Set>
             <Quote name="SendThird_S00145" />
             <Return/>                       
            </If>                                           
           <Exec func="PUB:ExecSql" error="IGNORE">
              <Arg name="sql" value="UpdIvdRec"/>
           </Exec>
           <If condition="~RetCod != 0 ">
              <Set>RspCod=CBS999</Set>
              <Set>RspMsg=数据库操作错报错返回 </Set>
              <Quote name="SendThird_S00145" />
              <Return/>
           </If>
           <Set>RspCod=000000</Set>
           <Set>RspMsg=撤约成功 </Set>
           <Quote name="SendThird_S00145" />
           <Return/>            
         </Else>
       </If>              
       <ElseIf condition="~RetCod!=-2"> 
            <Set>RspCod=CBS999</Set>
            <Set>RspMsg=据库操作错报错返回 </Set>
            <Quote name="SendThird_S00145" />
            <Return/>
       </ElseIf>
       <Set>RspCod=000000</Set>
       <Quote name="SendThird_S00145" />
       <Return/>       
       <Break/>
     </Case>
     <Default>
        <Set>RspMsg=非法请求不回应 </Set>
        <!--非法请求不回应-->
       <Return/>
     </Default>
   </Switch>        
  </FlowCtrl>
 </Transaction>
  
</Application>                                                                                                            
