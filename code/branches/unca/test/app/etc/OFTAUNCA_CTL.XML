<?xml version='1.0' encoding='ISO-8859-1'?>
<Application name="UNC" code="206">
  <!--电力电费业务本地主控-->
  <ConfigDeclare>
    <!--Config name="BatFormat"   value="etc/UNCA_FMT_441999.XML"/-->
    <Config name="ParaFile"    value="etc/CFG_UNCA_441999.XML"/>
    <Config name="OPFCSW"      value="etc/CSW_UNCA_441999.XML"/>
  </ConfigDeclare>

  <!--BusDefDeclare>
    <Busdef name="BrNo"      value="441999"/>
    <Busdef name="AplCls"    value="445"/>
  </BusDefDeclare-->

  <PackageDeclare>
    <Package name="AFE"        value="etc/DAFE_PKG.XML"/>
  </PackageDeclare>

  <TableDeclare>
    <Table name="afetxnjnl"    value="afetxnjnl"/>  <!--业务流水表-->
    <Table name="afebatrec"    value="afebatrec"/>  <!--批量扩展表-->
  </TableDeclare>

  <GlobalFunction>
    <Include file="etc/ActJudge_IIT.XML"/>     <!--区别对公对私帐号-->
    <!--add by xuan_20101108-->
    <Function name="_after">
      <Process>
        <If condition="ISNULL($MsgTyp)">
          <If condition="ISNULL(DELBOTHSPACE($RspCod))"> <!--若RspCod为空，则认为成功-->
            <Set>MsgTyp=N</Set>
            <Set>RspCod=000000</Set>
          </If>
          <Else>
            <If condition="IS_NOEQUAL_STRING($RspCod,000000)"> <!--返回码不为000000-->
              <Set>MsgTyp=E</Set>
            </If>
            <Else>
              <Set>MsgTyp=N</Set>
            </Else>
          </Else>
        </If>
      </Process>
    </Function>
  <!--end by xuan_20101108-->
  </GlobalFunction>

  <Define>
    <!--检查交易来源,并增加交易受理渠道(471140接口)字段-->
    <Macro name="Chk_TxnSrc">
      <If condition="INTCMP(STRLEN(DELBOTHSPACE($TxnSrc)),3,0)">
        <Set>TxnCnl=TRM</Set>
        <Set>CnlTyp=0</Set>
      </If>
      <Else>
        <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
        <Exec func="PUB:CodeSwitching">
          <Arg name="DatSrc"  value="OPFCSW"/>
          <Arg name="SourNam" value="TxnSrc"/>
          <Arg name="DestNam" value="CnlTyp"/>
          <Arg name="TblNam"  value="TxnSrc2CnlTyp"/>
        </Exec>
      </Else>
    </Macro>
  
    <!-- 通过交易来源,增加交易渠道字段,用于交易流水表字段 -->
    <Macro name="TxnSrc_TxnCnl">
      <Set>TxnSrc=DELBOTHSPACE($TxnSrc)</Set>
      <Exec func="PUB:CodeSwitching">
        <Arg name="DatSrc"  value="OPFCSW"/>
        <Arg name="SourNam" value="TxnSrc"/>
        <Arg name="DestNam" value="TxnCnl"/>
        <Arg name="TblNam"  value="TxnSrc2TxnCnl"/>
      </Exec>
    </Macro>
  
  </Define>

<!--TODO-->
  <Transaction code="460601" desc="被充值号码验证(010201)">
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>


      
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="484502"/>
        <Arg name="ObjSvr" value="STDAYCT2"/>
      </Exec>
      <If condition="$RspCod!=000000">
        <Set>RspCod=YCT999</Set>
        <Set>MsgTyp=E</Set>
        <Set>RspMsg=签到失败!</Set>
        <Return/>
      </If>
      <Set>RspCod=000000</Set>
      <Set>MsgTyp=N</Set>

    </FlowCtrl>
  </Transaction>

<!--TODO-->
  <Transaction code="460602" desc="给被充值号码充值(010202)">
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      <Exec func="PUB:GetLogNo"/><!--获取流水号-->

      <Set>TTxnCd=010201</Set><!-- 设置第三方交易码 -->
      <Set>TelTyp=1</Set><!-- 设置业务号码类型 -->
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="460601"/>
        <Arg name="ObjSvr" value="STDAUNCA"/>
      </Exec>
      <If condition="$RspCod!=000000">
        <Set>RspCod=UNC999</Set>
        <Set>MsgTyp=E</Set>
        <Set>RspMsg=连接联通服务器失败!</Set>
        <Return/>
      </If>
      <If condition="OR($AccFlg!=1,$ErrCod!=00000)">
        <Exec func="PUB:CodeSwitching" error="IGNORE">
          <Arg name="DatSrc" value="OPFCSW"></Arg>
          <Arg name="SourNam" value="ErrCod"></Arg>
          <Arg name="DestNam" value="ErrMsg"></Arg>
          <Arg name="TblNam" value="ErrCod2ErrMsg"></Arg>
        </Exec>
        <Set>RspCod=UNC999</Set>
        <Set>MsgTyp=E</Set>
        <Set>RspMsg=$ErrMsg</Set>
        <Return/>
      </If>

      <Set>RspCod=000000</Set>
      <Set>MsgTyp=N</Set>

    </FlowCtrl>
  </Transaction>

<!--TODO-->
  <Transaction code="460606" desc="通过卡号查询缴费会计流水号">
	  <Attributes>
      <Attribute name="nodatabase" value="2"/>
    </Attributes>
		<DynSentence name="Cnt">  <!--笔数-->
			<Sentence>
        SELECT COUNT(*) FROM afetxnjnl
        WHERE ActNo='%s' AND BrNo='%s' AND CAgtNo='%s'
          AND HtxnSt in ('S','T')
			</Sentence>
			<Fields>CrdNo|BrNo|CAgtNo|</Fields>
		</DynSentence>
    <DynSentence name="MultiQuery">
			<Sentence>
        SELECT ActDat, TxnAmt, TckNo FROM afetxnjnl
        WHERE ActNo='%s' AND BrNo='%s' AND CAgtNo='%s'
          AND HtxnSt in ('S','T')
			</Sentence>
			<Fields>CrdNo|BrNo|CAgtNo|</Fields>
		</DynSentence>
	  <FlowCtrl>
      
      <Exec func="PUB:GetBranchNoByTeller"/><!--根据柜员号取BrNo-->
	    <Exec func="PUB:InitTransaction"/><!--交易初始化,预留-->
	    
	    <Exec func="PUB:ReadRecord">
			 	<Arg name="SqlCmd" value="Cnt"/>
			 </Exec>
      
      <Exec func="PUB:MultiQuery">
         <Args>
           <Arg name="SqlCmd"  value="MultiQuery"/>
         </Args>
       </Exec>
		</FlowCtrl>
  </Transaction>

<!--TODO-->
  <Transaction code="460604" desc="缴费记录查询(010204)">
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="484502"/>
        <Arg name="ObjSvr" value="STDAYCT2"/>
      </Exec>
      <If condition="$RspCod!=000000">
        <Set>RspCod=YCT999</Set>
        <Set>MsgTyp=E</Set>
        <Set>RspMsg=签到失败!</Set>
        <Return/>
      </If>
      <Set>RspCod=000000</Set>
      <Set>MsgTyp=N</Set>

    </FlowCtrl>
  </Transaction>

<!--TODO-->
  <Transaction code="460605" desc="充值结果冲正(010205)">
    <FlowCtrl>
      <Exec func="PUB:InitTransaction"/>
      
      <Exec func="PUB:CallThirdOther">
        <Arg name="HTxnCd" value="484502"/>
        <Arg name="ObjSvr" value="STDAYCT2"/>
      </Exec>
      <If condition="$RspCod!=000000">
        <Set>RspCod=YCT999</Set>
        <Set>MsgTyp=E</Set>
        <Set>RspMsg=签到失败!</Set>
        <Return/>
      </If>
      <Set>RspCod=000000</Set>
      <Set>MsgTyp=N</Set>

    </FlowCtrl>
  </Transaction>


</Application>